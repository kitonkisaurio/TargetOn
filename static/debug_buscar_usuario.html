<!doctype html>
<html lang="es">
  <head>
    <title>Debug B√∫squeda Usuario</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .debug-box {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .warning {
        color: orange;
      }
      input,
      button {
        padding: 8px 12px;
        margin: 5px;
      }
      #resultado {
        border: 1px solid #ddd;
        padding: 15px;
        margin-top: 20px;
        background: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Debug - B√∫squeda de Usuario</h1>

      <div class="debug-box">
        <label>RUN a buscar:</label>
        <input
          type="text"
          id="runInput"
          value="3.885.027-K"
          placeholder="Ingrese RUN"
        />
        <button onclick="buscarUsuarioDebug()">Buscar Usuario</button>
        <button onclick="limpiarResultado()">Limpiar</button>
      </div>

      <div id="resultado">
        <p>
          Ingrese un RUN y presione "Buscar Usuario" para ver el resultado
          detallado...
        </p>
      </div>
    </div>

    <script>
      let debugLogs = [];

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        debugLogs.push({ timestamp, message, type });
        console.log(`[${timestamp}] ${message}`);
        updateResultado();
      }

      function updateResultado() {
        const div = document.getElementById("resultado");
        let html = "<h3>üîç Log de Debug:</h3>";

        debugLogs.forEach((entry) => {
          const className =
            entry.type === "error"
              ? "error"
              : entry.type === "warning"
                ? "warning"
                : "success";
          html += `<div class="${className}">[${entry.timestamp}] ${entry.message}</div>`;
        });

        div.innerHTML = html;
        div.scrollTop = div.scrollHeight;
      }

      function limpiarResultado() {
        debugLogs = [];
        document.getElementById("resultado").innerHTML =
          "<p>Log limpiado. Listo para nueva b√∫squeda...</p>";
      }

      async function buscarUsuarioDebug() {
        const run = document.getElementById("runInput").value.trim();

        if (!run) {
          log("‚ùå Error: RUN vac√≠o", "error");
          return;
        }

        if (run.length < 8) {
          log("‚ö†Ô∏è Warning: RUN muy corto (< 8 caracteres)", "warning");
        }

        log(`üöÄ Iniciando b√∫squeda para RUN: "${run}"`);

        try {
          log("üì° Enviando petici√≥n POST a /usuario/buscar...");

          const response = await fetch("/usuario/buscar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ run: run }),
          });

          log(`üìä Respuesta HTTP: ${response.status} ${response.statusText}`);

          if (!response.ok) {
            log(`‚ùå Error HTTP: ${response.status}`, "error");
            return;
          }

          const data = await response.json();
          log("üì¶ Datos recibidos del servidor");

          // Analizar la respuesta
          if (data.encontrado) {
            log("‚úÖ Usuario encontrado en base de datos", "success");
            log(`üë§ Nombre: "${data.nombre || "N/A"}"`);
            log(`üìÖ Fecha nacimiento: "${data.fecha_nacimiento || "N/A"}"`);
            log(`üë• Sexo: "${data.sexo || "N/A"}"`);
            log(`üè• Categor√≠a ID: "${data.categoria_id || "N/A"}"`);
            log(`üìç Sector ID: "${data.sector_id || "N/A"}"`);
            log(
              `üß¨ Patolog√≠as: ${data.patologias ? data.patologias.length : 0} registros`,
            );
            log(
              `üî¨ Ex√°menes: ${data.examenes ? data.examenes.length : 0} registros`,
            );
            log(
              `üìä Controles: ${data.controles ? data.controles.length : 0} registros`,
            );
            log(
              `üìã Acuerdos: ${data.acuerdos ? data.acuerdos.length : 0} registros`,
            );

            // Simular llenado de campos como lo hace usuario_form.html
            log("üñ±Ô∏è Simulando llenado de campos del formulario...");

            const campos = [
              { id: "nombre", valor: data.nombre },
              { id: "fecha_nacimiento", valor: data.fecha_nacimiento },
              { id: "sexo", valor: data.sexo },
              { id: "categoria_id", valor: data.categoria_id },
              { id: "sector_id", valor: data.sector_id },
            ];

            campos.forEach((campo) => {
              const elemento = document.getElementById(campo.id);
              if (elemento) {
                elemento.value = campo.valor || "";
                log(`‚úÖ Campo "${campo.id}" rellenado: "${campo.valor}"`);
              } else {
                log(`‚ö†Ô∏è Campo "${campo.id}" no encontrado en DOM`, "warning");
              }
            });

            // Verificar estructura de datos detalladamente
            log("üîç An√°lisis detallado de la respuesta:");
            log(`üóÇÔ∏è Claves principales: ${Object.keys(data).join(", ")}`);

            if (data.patologias && Array.isArray(data.patologias)) {
              log(
                `üß¨ Patolog√≠as: [${data.patologias.map((p) => p.nombre || p.id || p).join(", ")}]`,
              );
            }
          } else {
            log("‚ùå Usuario NO encontrado en base de datos", "error");
            if (data.debug) {
              log(`üêõ Debug info: ${JSON.stringify(data.debug)}`);
            }
          }

          // Mostrar respuesta completa para an√°lisis
          log("üìã Respuesta JSON completa:");
          log(JSON.stringify(data, null, 2));
        } catch (error) {
          log(`‚ùå Error de red o JavaScript: ${error.message}`, "error");
          console.error("Error completo:", error);
        }
      }

      // Crear campos simulados para testing
      document.addEventListener("DOMContentLoaded", function () {
        const container = document.querySelector(".container");
        const fieldsHtml = `
                <div class="debug-box">
                    <h4>üß™ Campos de prueba (simulan usuario_form.html):</h4>
                    <input type="text" id="nombre" placeholder="Nombre" readonly>
                    <input type="text" id="fecha_nacimiento" placeholder="Fecha nacimiento" readonly>
                    <input type="text" id="sexo" placeholder="Sexo" readonly>
                    <input type="text" id="categoria_id" placeholder="Categor√≠a ID" readonly>
                    <input type="text" id="sector_id" placeholder="Sector ID" readonly>
                </div>
            `;
        container.insertAdjacentHTML("beforeend", fieldsHtml);

        log("üéØ Debug tool iniciado. Listo para pruebas.");
      });
    </script>
  </body>
</html>
