<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug JavaScript Ex√°menes</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .debug {
        background: #f8f9fa;
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin: 10px 0;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      .console {
        background: #000;
        color: #0f0;
        padding: 10px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>üêõ Debug JavaScript Ex√°menes</h1>

    <div class="debug">
      <h3>Test 1: Buscar Usuario Real</h3>
      <button onclick="testBuscarUsuarioReal()">Buscar 10.000.141-1</button>
      <div id="status1"></div>
    </div>

    <div class="debug">
      <h3>Test 2: Funci√≥n actualizarTablaExamenes Directa</h3>
      <button onclick="testActualizarTabla()">Test con Datos Hardcoded</button>
      <div id="status2"></div>
    </div>

    <div class="debug">
      <h3>Tabla de Ex√°menes</h3>
      <table id="tabla-examenes">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>SO2 %</th>
            <th>Flujometr√≠a</th>
            <th>Tos</th>
            <th>Baciloscopia</th>
            <th>Creatininemia</th>
            <th>Col</th>
            <th>HDL</th>
            <th>LDL</th>
            <th>TAG</th>
            <th>Microalb.</th>
            <th>Microalb. valor</th>
            <th>VFG</th>
            <th>RAC</th>
            <th>RPR</th>
            <th>TSH</th>
            <th>HbA1c</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="18" style="text-align: center; color: #888">
              Esperando datos...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="debug">
      <h3>Console Debug</h3>
      <div class="console" id="console"></div>
      <button onclick="document.getElementById('console').innerHTML = ''">
        Limpiar Console
      </button>
    </div>

    <script>
      // Capturar console.log para mostrar en pantalla
      const originalLog = console.log;
      const originalError = console.error;
      const consoleDiv = document.getElementById("console");

      function addToConsole(type, args) {
        const entry = document.createElement("div");
        entry.style.color = type === "error" ? "#ff4444" : "#00ff00";
        entry.textContent = `[${type}] ${args.join(" ")}`;
        consoleDiv.appendChild(entry);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }

      console.log = function (...args) {
        originalLog.apply(console, args);
        addToConsole("LOG", args);
      };

      console.error = function (...args) {
        originalError.apply(console, args);
        addToConsole("ERROR", args);
      };

      function testBuscarUsuarioReal() {
        console.log("üîç Iniciando b√∫squeda real del usuario...");
        document.getElementById("status1").innerHTML = "‚è≥ Buscando...";

        fetch("/usuario/buscar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ run: "10.000.141-1" }),
        })
          .then((response) => {
            console.log("üì° Response status:", response.status);
            return response.json();
          })
          .then((data) => {
            console.log("üì¶ Data completa recibida:", data);
            console.log("üè• Campo examenes:", data.examenes);
            console.log("üè• Tipo de examenes:", typeof data.examenes);
            console.log("üè• Es array:", Array.isArray(data.examenes));
            console.log(
              "üè• Longitud:",
              data.examenes ? data.examenes.length : "undefined",
            );

            if (data.examenes && data.examenes.length > 0) {
              console.log("‚úÖ Primer examen:", data.examenes[0]);
              document.getElementById("status1").innerHTML = `
                        <div style="color: green;">
                            ‚úÖ Encontrado: ${data.encontrado}<br>
                            üë§ Nombre: ${data.nombre}<br>
                            üè• Ex√°menes: ${data.examenes.length}
                        </div>
                    `;
              // Llamar a la funci√≥n de actualizaci√≥n
              console.log("üîÑ Llamando a actualizarTablaExamenes...");
              actualizarTablaExamenes(data.examenes);
            } else {
              document.getElementById("status1").innerHTML = `
                        <div style="color: orange;">
                            ‚ö†Ô∏è Usuario encontrado pero sin ex√°menes
                        </div>
                    `;
            }
          })
          .catch((error) => {
            console.error("‚ùå Error:", error);
            document.getElementById("status1").innerHTML = `
                    <div style="color: red;">‚ùå Error: ${error.message}</div>
                `;
          });
      }

      function testActualizarTabla() {
        console.log("üß™ Test directo de actualizarTablaExamenes...");

        const datosTest = [
          {
            examen_fecha: "2023-12-12",
            so2_percent: null,
            flujometria: null,
            tos: null,
            baciloscopia: null,
            creatinemia: null,
            col: null,
            hdl: null,
            ldl: null,
            tag: null,
            microalbuminuria: null,
            microalbuminuria_val: null,
            vfg: null,
            rac: null,
            rpr: null,
            tsh: null,
            hba1c: "8.20",
            notas: "importada desde usuariocontrol",
          },
          {
            examen_fecha: "2022-12-07",
            so2_percent: null,
            flujometria: null,
            tos: null,
            baciloscopia: null,
            creatinemia: null,
            col: null,
            hdl: null,
            ldl: null,
            tag: null,
            microalbuminuria: null,
            microalbuminuria_val: null,
            vfg: null,
            rac: null,
            rpr: null,
            tsh: null,
            hba1c: "7.90",
            notas: "importada desde usuariocontrol",
          },
        ];

        console.log("üìä Datos de test preparados:", datosTest);
        document.getElementById("status2").innerHTML =
          "‚è≥ Actualizando tabla...";

        try {
          actualizarTablaExamenes(datosTest);
          document.getElementById("status2").innerHTML = "‚úÖ Funci√≥n ejecutada";
        } catch (error) {
          console.error("‚ùå Error en actualizarTablaExamenes:", error);
          document.getElementById("status2").innerHTML =
            `‚ùå Error: ${error.message}`;
        }
      }

      function actualizarTablaExamenes(examenes) {
        console.log("üîÑ actualizarTablaExamenes llamada con:", examenes);
        console.log(
          "üìä N√∫mero de ex√°menes:",
          examenes ? examenes.length : "examenes es null/undefined",
        );
        console.log("üìä Tipo de examenes:", typeof examenes);
        console.log("üìä Es array:", Array.isArray(examenes));

        const tablaBody = document.querySelector("#tabla-examenes tbody");
        if (!tablaBody) {
          console.error("‚ùå No se encontr√≥ el tbody de la tabla ex√°menes");
          return;
        }

        console.log("‚úÖ Tbody encontrado:", tablaBody);
        console.log("üßπ Limpiando contenido actual del tbody");

        // Limpiar contenido actual completamente
        tablaBody.innerHTML = "";
        console.log("üßπ Tbody limpiado, innerHTML ahora:", tablaBody.innerHTML);

        if (examenes && Array.isArray(examenes) && examenes.length > 0) {
          console.log("‚úÖ Agregando", examenes.length, "ex√°menes a la tabla");

          examenes.forEach((ex, index) => {
            console.log(`üè• Procesando examen ${index + 1}:`, ex);

            const row = document.createElement("tr");
            const rowHTML = `
                        <td>${ex.examen_fecha || ""}</td>
                        <td>${ex.so2_percent || ""}</td>
                        <td>${ex.flujometria || ""}</td>
                        <td>${ex.tos === true ? "S√≠" : ex.tos === false ? "No" : ""}</td>
                        <td>${ex.baciloscopia === true ? "S√≠" : ex.baciloscopia === false ? "No" : ""}</td>
                        <td>${ex.creatinemia || ""}</td>
                        <td>${ex.col || ""}</td>
                        <td>${ex.hdl || ""}</td>
                        <td>${ex.ldl || ""}</td>
                        <td>${ex.tag || ""}</td>
                        <td>${ex.microalbuminuria === true ? "S√≠" : ex.microalbuminuria === false ? "No" : ""}</td>
                        <td>${ex.microalbuminuria_val || ""}</td>
                        <td>${ex.vfg || ""}</td>
                        <td>${ex.rac || ""}</td>
                        <td>${ex.rpr === true ? "S√≠" : ex.rpr === false ? "No" : ""}</td>
                        <td>${ex.tsh || ""}</td>
                        <td>${ex.hba1c || ""}</td>
                        <td>${(ex.notas || "").substring(0, 100)}${(ex.notas || "").length > 100 ? "..." : ""}</td>
                    `;

            row.innerHTML = rowHTML;
            console.log(`üè• Fila ${index + 1} creada, agregando al tbody...`);
            tablaBody.appendChild(row);
          });

          console.log("‚úÖ Tabla actualizada con", examenes.length, "filas");
          console.log(
            "üìã Estado final del tbody:",
            tablaBody.innerHTML.substring(0, 200) + "...",
          );
        } else {
          console.log(
            "‚ö†Ô∏è No hay ex√°menes v√°lidos, mostrando mensaje de no hay datos",
          );
          const row = document.createElement("tr");
          row.innerHTML =
            '<td colspan="18" style="text-align:center; color:#888; padding:20px;">No hay ex√°menes registrados para este usuario.</td>';
          tablaBody.appendChild(row);
          console.log('‚ö†Ô∏è Mensaje de "no hay datos" agregado');
        }
      }

      console.log("üöÄ P√°gina de debug cargada");
    </script>
  </body>
</html>
