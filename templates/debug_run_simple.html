<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug RUN Simple</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
      }
      input {
        padding: 12px;
        font-size: 16px;
        width: 250px;
        border: 2px solid #ddd;
        border-radius: 4px;
      }
      .resultado {
        margin: 20px 0;
        padding: 15px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîç Debug RUN - ECICEP</h1>
      <p>Probar autocompletado paso a paso</p>

      <input
        type="text"
        id="runInput"
        placeholder="Ingrese RUN (ej: 8.352.262-3)"
        maxlength="13"
      />

      <div id="resultado" class="resultado info">
        üîÑ Ingrese un RUN para comenzar el test...
      </div>

      <div
        id="debug"
        style="
          margin-top: 20px;
          font-family: monospace;
          font-size: 12px;
          background: #f8f9fa;
          padding: 10px;
          border-radius: 4px;
          max-height: 200px;
          overflow-y: auto;
        "
      >
        <strong>Debug Log:</strong><br />
      </div>
    </div>

    <script>
      const runInput = document.getElementById("runInput");
      const resultado = document.getElementById("resultado");
      const debug = document.getElementById("debug");
      let timeoutId;

      function log(message) {
        const time = new Date().toLocaleTimeString();
        debug.innerHTML += `[${time}] ${message}<br>`;
        debug.scrollTop = debug.scrollHeight;
        console.log(message);
      }

      // Funci√≥n de formateo de RUN
      function formatearRUN(value) {
        let v = value.replace(/[^0-9kK]/g, "").toUpperCase();

        if (v.length >= 2) {
          const cuerpo = v.slice(0, -1);
          const dv = v.slice(-1);
          const cuerpoFormateado = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
          return cuerpoFormateado + "-" + dv;
        }
        return v;
      }

      // Funci√≥n de validaci√≥n DV
      function validarDV(run) {
        const runLimpio = run.replace(/[^0-9kK]/g, "").toUpperCase();
        if (runLimpio.length < 8) return false;

        const cuerpo = runLimpio.slice(0, -1);
        const dv = runLimpio.slice(-1);

        let suma = 0;
        let multiplicador = 2;

        for (let i = cuerpo.length - 1; i >= 0; i--) {
          suma += parseInt(cuerpo[i]) * multiplicador;
          multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }

        const resto = suma % 11;
        const dvCalculado =
          resto === 0 ? "0" : resto === 1 ? "K" : (11 - resto).toString();

        return dv === dvCalculado;
      }

      // Funci√≥n de b√∫squeda
      async function buscarUsuario(run) {
        log(`üîç Buscando usuario: ${run}`);
        resultado.className = "resultado info";
        resultado.innerHTML = "üîÑ Buscando...";

        try {
          const response = await fetch("/usuario/buscar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ run: run }),
          });

          log(`üì° Response status: ${response.status}`);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          log(`üì¶ Response data: ${JSON.stringify(data)}`);

          if (data.encontrado) {
            resultado.className = "resultado success";
            resultado.innerHTML = `
                        ‚úÖ <strong>Usuario encontrado</strong><br>
                        ‚Ä¢ RUN: ${data.run || "N/A"}<br>
                        ‚Ä¢ Nombre: ${data.nombre || "N/A"}<br>
                        ‚Ä¢ Sexo: ${data.sexo || "N/A"}<br>
                        ‚Ä¢ F. Nacimiento: ${data.fecha_nacimiento || "N/A"}
                    `;
            log(`‚úÖ Usuario encontrado: ${data.nombre}`);
          } else {
            resultado.className = "resultado error";
            resultado.innerHTML =
              "‚ùå Usuario no encontrado en la base de datos";
            log(`‚ùå Usuario no encontrado`);
          }
        } catch (error) {
          log(`üí• Error: ${error.message}`);
          resultado.className = "resultado error";
          resultado.innerHTML = `‚ùå Error: ${error.message}`;
        }
      }

      // Event listener principal
      runInput.addEventListener("input", function (e) {
        // Formatear RUN
        const original = e.target.value;
        const formateado = formatearRUN(original);
        e.target.value = formateado;

        if (original !== formateado) {
          log(`üîß Formateado: "${original}" ‚Üí "${formateado}"`);
        }

        // Validar
        const runLimpio = formateado.replace(/[^0-9kK]/g, "");

        if (runLimpio.length >= 8) {
          const esValido = validarDV(formateado);
          log(`üßÆ DV v√°lido: ${esValido} (${runLimpio})`);

          if (esValido) {
            // Limpiar timeout anterior
            clearTimeout(timeoutId);

            // Buscar despu√©s de 500ms
            timeoutId = setTimeout(() => {
              buscarUsuario(formateado);
            }, 500);

            resultado.className = "resultado info";
            resultado.innerHTML = "‚è≥ RUN v√°lido - buscando en 0.5s...";
          } else {
            resultado.className = "resultado error";
            resultado.innerHTML =
              "‚ùå RUN inv√°lido (d√≠gito verificador incorrecto)";
          }
        } else {
          clearTimeout(timeoutId);
          resultado.className = "resultado info";
          resultado.innerHTML = "üîÑ Ingrese un RUN completo (8+ d√≠gitos)...";
        }
      });

      // Agregar algunos RUNs de prueba
      runInput.addEventListener("focus", function () {
        if (!this.value) {
          log("üí° RUNs de prueba: 8.352.262-3, 10.000.141-1");
        }
      });

      log("üöÄ Debug RUN iniciado");
    </script>
  </body>
</html>
