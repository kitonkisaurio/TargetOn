<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Estad√≠sticas - ECICEP</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <!-- SCRIPT LIMPIO SECCI√ìN A (reemplaza versiones anteriores corruptas) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const STATUS_ID = 'seccion-a-status';
      const delayMs = 800; // peque√±o delay para asegurar DOM
      const bandas = ['15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74','75-79','80+'];

      const removeAccents = s => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      const norm = s => removeAccents(s).toLowerCase().replace(/\s+/g,' ').trim();

      const mapaConceptos = [
        { claves:['numero de personas en pscv'], prefijo:'pscv', tipo:'full', poMigIds:{po:'pscv-po', mig:'pscv-mig'} },
        { claves:['bajo'], prefijo:'riesgo-bajo', tipo:'full' },
        { claves:['moderado'], prefijo:'riesgo-mod', tipo:'full' },
        { claves:['alto'], prefijo:'riesgo-alto', tipo:'full' },
        { claves:['tabaquismo ‚â• 55 a√±os','tabaquismo >= 55 a√±os','tabaquismo'], prefijo:'tabaq', tipo:'parcial55' },
        { claves:['hipertension arterial','hipertensi√≥n arterial','hta'], prefijo:'hta', tipo:'full' },
        { claves:['diabetes mellitus tipo 2','diabetes mellitus','diabetes tipo 2','dm2'], prefijo:'dm2', tipo:'full' },
        { claves:['dislipidemia'], prefijo:'dislip', tipo:'full' },
        { claves:['antecedentes de infarto agudo al miocardio','infarto agudo al miocardio','infarto'], prefijo:'iam-ant', tipo:'full' },
        { claves:['antecedentes de ataque cerebro vascular','accidente cerebro vascular','ataque cerebro vascular','acv'], prefijo:'acv-ant', tipo:'full' },
        { claves:['antecedentes de otras enfermedades cardiovasculares','otras enfermedades cardiovasculares','otras ecv'], prefijo:'ecv-ant', tipo:'full' },
        { claves:['enfermedad renal cronica (etapas 1 a 5)','enfermedad renal cr√≥nica (etapas 1 a 5)','enfermedad renal cronica','enfermedad renal cr√≥nica','erc'], prefijo:'erc', tipo:'full' }
      ];

      function setText(id, value) {
        const el = document.getElementById(id);
        if (!el) return false;
        el.textContent = (value ?? 0);
        return true;
      }
      function sumar(obj) { return obj ? (obj.hombres||0)+(obj.mujeres||0) : 0; }

      function actualizarFull(prefijo, fila) {
        setText(`${prefijo}-total`, fila.total_ambos);
        setText(`${prefijo}-total-h`, fila.total_hombres);
        setText(`${prefijo}-total-m`, fila.total_mujeres);
        bandas.forEach(b => {
          // Usar sufijo "-mas" para 80+
          const bId = b.replace('+','-mas');
          setText(`${prefijo}-${bId}-h`, fila[`${b}_h`]);
          setText(`${prefijo}-${bId}-m`, fila[`${b}_m`]);
        });
        setText(`${prefijo}-po`, sumar(fila.po));
        setText(`${prefijo}-mig`, sumar(fila.mig));
        // Protecci√≥n: solo tocar IDs de HbA1c7 si el prefijo es exactamente 'hba1c7'
        if (prefijo === 'hba1c7') {
          if (fila.po) {
            setText('hba1c7-po-h', fila.po.hombres || 0);
            setText('hba1c7-po-m', fila.po.mujeres || 0);
          }
          if (fila.mig) {
            setText('hba1c7-mig-h', fila.mig.hombres || 0);
            setText('hba1c7-mig-m', fila.mig.mujeres || 0);
          }
        }
      }
      function actualizarParcial55(prefijo, fila) {
        bandas.filter(b => /^(55|6|7|8)/.test(b)).forEach(b => {
          const bId = b.replace('+','-mas');
          setText(`${prefijo}-${bId}-h`, fila[`${b}_h`]);
          setText(`${prefijo}-${bId}-m`, fila[`${b}_m`]);
        });
        setText(`${prefijo}-po`, sumar(fila.po));
        setText(`${prefijo}-mig`, sumar(fila.mig));
      }
      function buscarFila(dataFilas, claves) {
        const clavesNorm = claves.map(norm);
        return dataFilas.find(f => {
          const c = norm(f.concepto||'');
          return clavesNorm.some(k => c.includes(k));
        });
      }

      async function cargarSeccionA() {
        const statusEl = document.getElementById(STATUS_ID);
        // FUNCI√ìN OBSOLETA - Los datos ahora se cargan desde REM P 2025
        if (statusEl) statusEl.textContent = '‚úÖ Usando REM P 2025';
        console.log('‚ö†Ô∏è cargarSeccionA() obsoleta - datos desde REM P 2025');
        return; // Salir temprano
        
        /* C√ìDIGO ANTIGUO COMENTADO
        if (statusEl) statusEl.textContent = '‚è≥ Cargando Secci√≥n A...';
        try {
          // Construir query con filtros de fecha y sector
          const params = new URLSearchParams();
          params.set('debug', '1');
          
          const sEl = document.getElementById('sectores_select'); 
          const s = sEl && sEl.value; 
          if(s) params.set('sectores', s);
          
          const sxEl = document.getElementById('sexo_select'); 
          const sx = sxEl && sxEl.value; 
          if(sx) params.set('sexo', sx);
          
          const desdeEl = document.getElementById('fecha_desde'); 
          const desde = desdeEl && desdeEl.value; 
          if(desde) params.set('fecha_desde', desde);
          
          const hastaEl = document.getElementById('fecha_hasta'); 
          const hasta = hastaEl && hastaEl.value; 
          if(hasta) params.set('fecha_hasta', hasta);
          
          // Usar nuestro endpoint simplificado que funciona
          const url = '/api/pscv_simple?fecha_desde=' + (desde || '2024-01-01') + '&fecha_hasta=' + (hasta || '2025-12-31');
          console.log('üì° [Secci√≥n A] Cargando desde:', url);
          
          const resp = await fetch(url, {credentials:'same-origin', headers:{'Accept':'application/json'}});
          const ct = resp.headers.get('content-type')||'';
          if (!ct.includes('application/json')) {
            const t = await resp.text();
            console.error('‚ùå Respuesta no JSON (quiz√° login):', t.slice(0,300));
            if (statusEl) statusEl.textContent = '‚ùå Sesi√≥n expirada o sin acceso';
            return;
          }
            const data = await resp.json();
            if (!resp.ok || !data.success) {
              console.error('Backend error', data);
              if (statusEl) statusEl.textContent = '‚ùå Error backend Secci√≥n A';
              return;
            }
            console.log('üìä Secci√≥n A datos:', data);
            let updates = 0;
            const faltantes = [];
            mapaConceptos.forEach(cfg => {
              const fila = buscarFila(data.filas, cfg.claves);
              if (!fila) { console.warn('‚ö†Ô∏è Sin fila para', cfg.claves[0]); faltantes.push(cfg.prefijo); return; }
              if (cfg.tipo==='full') actualizarFull(cfg.prefijo, fila); else if (cfg.tipo==='parcial55') actualizarParcial55(cfg.prefijo, fila);
              if (cfg.poMigIds) { setText(cfg.poMigIds.po, sumar(fila.po)); setText(cfg.poMigIds.mig, sumar(fila.mig)); }
              updates++;
            });
            console.group('üìã Conceptos devueltos');
            data.filas.forEach(f=>console.log('-', f.concepto));
            console.groupEnd();
            if (faltantes.length) {
              console.group('‚ö†Ô∏è Resumen faltantes Secci√≥n A');
              console.log('Prefijos sin datos (verificar backend o claves):', faltantes.join(', '));
              console.groupEnd();
            }
            if (statusEl) {
              const totalConceptos = (data && Array.isArray(data.filas)) ? data.filas.length : 0;
              statusEl.textContent = updates
                ? `‚úÖ Secci√≥n A actualizada (${updates} grupos de ${totalConceptos} conceptos)`
                : `‚ö†Ô∏è Sin coincidencias (0/ ${totalConceptos})`;
            }
        } catch(err) {
          console.error('‚ùå Error JS Secci√≥n A', err);
          const statusEl = document.getElementById(STATUS_ID);
          if (statusEl) statusEl.textContent = '‚ùå Error JS';
        }
      }
  */
  }
  // setTimeout(cargarSeccionA, delayMs); // DESHABILITADO - usando REM P 2025
    });
  </script>

  <!-- SCRIPT REM P 2025 - NUEVAS FUNCIONES SEG√öN MANUAL OFICIAL -->
  <script>
    // Funciones para REM P 2025 seg√∫n Manual Version 1.2
    async function cargarREMP2025SeccionA() {
      const statusId = 'remp-2025-seccion-a-status';
      const statusEl = document.getElementById(statusId);
      
      if (statusEl) statusEl.textContent = '‚è≥ Cargando REM P 2025 Secci√≥n A...';
      
      try {
        // Construir par√°metros
        const params = new URLSearchParams();
        
        const sectorSelect = document.getElementById('sectores_select');
        if (sectorSelect && sectorSelect.value) {
          params.set('sectores', sectorSelect.value);
        }
        const sexoSelect = document.getElementById('sexo_select');
        if (sexoSelect && sexoSelect.value) {
          params.set('sexo', sexoSelect.value);
        }
        const fechaDesde = document.getElementById('fecha_desde');
        if (fechaDesde && fechaDesde.value) {
          params.set('fecha_desde', fechaDesde.value);
        }
        const fechaHasta = document.getElementById('fecha_hasta');
        if (fechaHasta && fechaHasta.value) {
          params.set('fecha_hasta', fechaHasta.value);
        }
        const fechaCorte = document.getElementById('fecha_corte');
        if (fechaCorte && fechaCorte.value) {
          params.set('fecha_corte', fechaCorte.value);
        }
        const query = params.toString();
        const url = query ? `/api/rem-p-2025/seccion-a?${query}` : '/api/rem-p-2025/seccion-a';
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
  const data = await response.json();
  window.__rempSeccionAResponse = data;
        
        if (!data.success) {
          throw new Error(data.error || 'Error desconocido en REM P 2025 Secci√≥n A');
        }
        
        // Actualizar elementos en la p√°gina con datos REM P 2025
        actualizarElementosREMP2025SeccionA(data);
        
        if (statusEl) {
          const totalPSCV = data.datos?.total_pscv?.totales?.total || 0;
          statusEl.textContent = `‚úÖ REM P 2025 Secci√≥n A cargada (${totalPSCV} personas en PSCV)`;
        }
        
        console.log('‚úÖ REM P 2025 Secci√≥n A cargada correctamente', data);
        
      } catch (error) {
        console.error('‚ùå Error cargando REM P 2025 Secci√≥n A:', error);
        if (statusEl) {
          statusEl.textContent = `‚ùå Error: ${error.message}`;
        }
      }
    }
    
    async function cargarREMP2025SeccionB() {
      const statusId = 'remp-2025-seccion-b-status';
      const statusEl = document.getElementById(statusId);
      
      if (statusEl) statusEl.textContent = '‚è≥ Cargando REM P 2025 Secci√≥n B...';
      
      try {
        // Construir par√°metros
        const params = new URLSearchParams();
        
        const sectorSelect = document.getElementById('sectores_select');
        if (sectorSelect && sectorSelect.value) {
          params.set('sectores', sectorSelect.value);
        }
        const sexoSelect = document.getElementById('sexo_select');
        if (sexoSelect && sexoSelect.value) {
          params.set('sexo', sexoSelect.value);
        }
        const fechaDesde = document.getElementById('fecha_desde');
        if (fechaDesde && fechaDesde.value) {
          params.set('fecha_desde', fechaDesde.value);
        }
        const fechaHasta = document.getElementById('fecha_hasta');
        if (fechaHasta && fechaHasta.value) {
          params.set('fecha_hasta', fechaHasta.value);
        }
        const fechaCorte = document.getElementById('fecha_corte');
        if (fechaCorte && fechaCorte.value) {
          params.set('fecha_corte', fechaCorte.value);
        }
        try { appendRemParams(params); } catch(_) { /* noop */ }
        const query = params.toString();
        const url = query ? `/api/rem-p-2025/seccion-b?${query}` : '/api/rem-p-2025/seccion-b';
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Error desconocido en REM P 2025 Secci√≥n B');
        }
        
        // Actualizar elementos de metas de control
        actualizarElementosREMP2025SeccionB(data);
        window.__rempSeccionBResponse = data;
        // Alimentar la nueva tabla completa reutilizando los mismos datos
        await cargarPscvMetas(null, data);
        
        if (statusEl) {
          const metasInfo = calcularResumenMetas(data);
          statusEl.textContent = `‚úÖ REM P 2025 Secci√≥n B cargada (${metasInfo})`;
        }
        
        console.log('‚úÖ REM P 2025 Secci√≥n B cargada correctamente', data);
        
      } catch (error) {
        console.error('‚ùå Error cargando REM P 2025 Secci√≥n B:', error);
        if (statusEl) {
          statusEl.textContent = `‚ùå Error: ${error.message}`;
        }
      }
    }
    
    function actualizarElementosREMP2025SeccionA(data) {
      const bandas = ['15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74','75-79','80+'];

      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (!el) return false;
        el.textContent = value ?? 0;
        return true;
      };

      const actualizarBandas = (prefijo, dataset) => {
        if (!dataset) return;
        bandas.forEach((banda) => {
          const bandaData = dataset.por_banda?.[banda];
          if (!bandaData) return;
          const bandaId = banda.replace('+', '-mas');
          setText(`${prefijo}-${bandaId}-h`, bandaData.masculino || 0);
          setText(`${prefijo}-${bandaId}-m`, bandaData.femenino || 0);
        });
      };

      const actualizarTablaDetallada = (baseId, dataset, options = {}) => {
        if (!dataset) return;
        const { includeTotales = true } = options;
        if (includeTotales) {
          setText(`${baseId}-total`, dataset.totales?.total || 0);
          setText(`${baseId}-total-h`, dataset.totales?.masculino || 0);
          setText(`${baseId}-total-m`, dataset.totales?.femenino || 0);
        }
        if (typeof dataset.pueblos_originarios === 'number') {
          setText(`${baseId}-po`, dataset.pueblos_originarios || 0);
        }
        if (typeof dataset.migrantes === 'number') {
          setText(`${baseId}-mig`, dataset.migrantes || 0);
        }
        actualizarBandas(baseId, dataset);
      };

      const actualizarResumen = (prefijo, dataset) => {
        if (!dataset) return;
        setText(`${prefijo}-total`, dataset.totales?.total || 0);
        setText(`${prefijo}-total-dup`, dataset.totales?.total || 0);
        setText(`${prefijo}-hombres`, dataset.totales?.masculino || 0);
        setText(`${prefijo}-mujeres`, dataset.totales?.femenino || 0);
      };

      if (!data?.datos) {
        return;
      }

      const { datos } = data;

      if (datos.total_pscv) {
        const pscv = datos.total_pscv;
        actualizarResumen('remp-pscv', pscv);
        actualizarBandas('remp-pscv', pscv);
        actualizarTablaDetallada('pscv', pscv);
      }

      if (datos.hipertension) {
        const hta = datos.hipertension;
        actualizarResumen('remp-hta', hta);
        actualizarBandas('remp-hta', hta);
        actualizarTablaDetallada('hta', hta);
      }

      if (datos.diabetes_tipo2) {
        const dm2 = datos.diabetes_tipo2;
        actualizarResumen('remp-dm2', dm2);
        actualizarBandas('remp-dm2', dm2);
        actualizarTablaDetallada('dm2', dm2);
      }

      if (datos.dislipidemia) {
        actualizarTablaDetallada('dislip', datos.dislipidemia);
      }

      if (datos.enfermedad_renal_cronica) {
        actualizarTablaDetallada('erc', datos.enfermedad_renal_cronica);
      }

      if (datos.tabaquismo_ge_55) {
        actualizarTablaDetallada('tabaq', datos.tabaquismo_ge_55);
      }

      if (datos.antecedentes_iam) {
        actualizarTablaDetallada('iam-ant', datos.antecedentes_iam);
      }

      if (datos.antecedentes_acv) {
        actualizarTablaDetallada('acv-ant', datos.antecedentes_acv);
      }

      if (datos.antecedentes_ecv) {
        actualizarTablaDetallada('ecv-ant', datos.antecedentes_ecv);
      }

      if (datos.riesgo_cardiovascular) {
        const rcv = datos.riesgo_cardiovascular;
        const mapping = {
          Bajo: 'riesgo-bajo',
          Moderado: 'riesgo-mod',
          Alto: 'riesgo-alto'
        };

        Object.entries(mapping).forEach(([nivel, prefijo]) => {
          const dataset = rcv?.[nivel];
          if (!dataset) return;
          actualizarTablaDetallada(prefijo, dataset);
        });

        const rcvAlto = rcv?.Alto;
        if (rcvAlto) {
          setText('remp-rcv-alto-total', rcvAlto.totales?.total || 0);
        }
      }

      // Actualizar estado visual
      const statusChip = document.getElementById('remp-2025-seccion-a-status');
      if (statusChip) {
        const corte = data.fecha_corte ? new Date(data.fecha_corte).toLocaleDateString('es-CL') : 'hoy';
        statusChip.textContent = `‚úÖ Datos actualizados (corte ${corte})`;
        statusChip.classList.remove('bg-secondary');
        statusChip.classList.add('bg-success');

        const legacyStatus = document.getElementById('seccion-a-status');
        if (legacyStatus) {
          legacyStatus.classList.remove('chip-yapo');
          legacyStatus.classList.add('chip-existo');
          legacyStatus.textContent = '‚úÖ Datos obtenidos desde servicio REM P 2025 oficial';
        }
      }
    }
    
    function actualizarElementosREMP2025SeccionB(data) {
      const bandas = ['15-19','20-24','25-29','30-34','35-39','40-44','45-49','50-54','55-59','60-64','65-69','70-74','75-79','80+'];
      
      function setText(id, value) {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = value || 0;
          return true;
        }
        return false;
      }
      
      function setPercentage(id, cumple, total) {
        const el = document.getElementById(id);
        if (el && total > 0) {
          const pct = ((cumple / total) * 100).toFixed(1);
          el.textContent = `${pct}%`;
          return true;
        } else if (el) {
          el.textContent = '0%';
        }
        return false;
      }
      
      // Actualizar metas HTA
      if (data.datos?.hipertension) {
        const hta = data.datos.hipertension;
        setText('remp-hta-meta-total', hta.cumplen_meta?.total || 0);
        setText('remp-hta-meta-poblacion', hta.total_poblacion?.total || 0);
        setPercentage('remp-hta-meta-pct', hta.cumplen_meta?.total || 0, hta.total_poblacion?.total || 0);
        
        bandas.forEach(banda => {
          const bandaId = banda.replace('+', '-mas');
          const cumpleBanda = hta.por_banda?.[banda]?.cumplen_meta?.total || 0;
          const totalBanda = hta.por_banda?.[banda]?.total_poblacion?.total || 0;
          
          setText(`remp-hta-meta-${bandaId}`, cumpleBanda);
          setText(`remp-hta-meta-${bandaId}-total`, totalBanda);
          setPercentage(`remp-hta-meta-${bandaId}-pct`, cumpleBanda, totalBanda);
        });
      }
      
      // Actualizar metas DM2
      if (data.datos?.diabetes) {
        const dm2 = data.datos.diabetes;
        setText('remp-dm2-meta-total', dm2.cumplen_meta?.total || 0);
        setText('remp-dm2-meta-poblacion', dm2.total_poblacion?.total || 0);
        setPercentage('remp-dm2-meta-pct', dm2.cumplen_meta?.total || 0, dm2.total_poblacion?.total || 0);
        
        bandas.forEach(banda => {
          const bandaId = banda.replace('+', '-mas');
          const cumpleBanda = dm2.por_banda?.[banda]?.cumplen_meta?.total || 0;
          const totalBanda = dm2.por_banda?.[banda]?.total_poblacion?.total || 0;
          
          setText(`remp-dm2-meta-${bandaId}`, cumpleBanda);
          setText(`remp-dm2-meta-${bandaId}-total`, totalBanda);
          setPercentage(`remp-dm2-meta-${bandaId}-pct`, cumpleBanda, totalBanda);
        });
      }
      
      // Actualizar metas RCV Alto
      if (data.datos?.riesgo_cardiovascular_alto) {
        const rcv = data.datos.riesgo_cardiovascular_alto;
        setText('remp-rcv-meta-total', rcv.cumplen_meta?.total || 0);
        setText('remp-rcv-meta-poblacion', rcv.total_poblacion?.total || 0);
        setPercentage('remp-rcv-meta-pct', rcv.cumplen_meta?.total || 0, rcv.total_poblacion?.total || 0);
      }
    }
    
    function calcularResumenMetas(data) {
      let resumen = [];
      
      if (data.datos?.hipertension) {
        const hta = data.datos.hipertension;
        const total = hta.total_poblacion?.total || 0;
        const cumple = hta.cumplen_meta?.total || 0;
        resumen.push(`HTA: ${cumple}/${total}`);
      }
      
      if (data.datos?.diabetes) {
        const dm2 = data.datos.diabetes;
        const total = dm2.total_poblacion?.total || 0;
        const cumple = dm2.cumplen_meta?.total || 0;
        resumen.push(`DM2: ${cumple}/${total}`);
      }
      
      if (data.datos?.riesgo_cardiovascular_alto) {
        const rcv = data.datos.riesgo_cardiovascular_alto;
        const total = rcv.total_poblacion?.total || 0;
        const cumple = rcv.cumplen_meta?.total || 0;
        resumen.push(`RCV: ${cumple}/${total}`);
      }
      
      return resumen.join(', ') || 'Sin datos';
    }
    
    // Funci√≥n para cargar ambas secciones REM P 2025
    function cargarREMP2025Completo() {
      cargarREMP2025SeccionA();
      setTimeout(() => cargarREMP2025SeccionB(), 500); // Peque√±o delay para evitar sobrecarga
    }
    
    // Auto-cargar REM P 2025 cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        if (typeof cargarREMP2025Completo === 'function') {
          cargarREMP2025Completo();
        }
      }, 1200); // Delay para permitir que otras funciones carguen primero
    });
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/estadisticas.css') }}">
  <style id="estilos-principales-seccion-a">
    .card-title {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0;
    }

    /* Encabezados de p√°ginas mejorados */
    h2 {
      color: var(--text-primary);
      font-weight: 700;
      font-size: 1.75rem;
    }

    /* Botones mejorados */
    .btn {
      font-weight: 500;
      border-radius: 8px;
    }

    /* Tablas modernas y elegantes */
    .table {
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 8px;
      overflow: hidden;
      background: var(--card-bg);
      box-shadow: var(--shadow-sm);
    }

    /* Encabezados de tabla con gradientes (reglas principales en hoja externa) */
    /* Nota: se elimin√≥ c√≥digo HTML que estaba incrustado por error dentro de este bloque <style>. */

    /* Tooltips de diagn√≥sticos cardiovasculares */
    .diagnosticos-tooltip {
      cursor: help;
      text-decoration: underline dotted;
      text-decoration-color: var(--text-secondary);
      text-underline-offset: 3px;
      transition: color 0.2s ease, text-decoration-color 0.2s ease;
    }

    .diagnosticos-tooltip:hover {
      color: var(--primary, #0d6efd);
      text-decoration-color: currentColor;
    }

    .diagnosticos-tooltip[title] {
      white-space: pre-line;
    }
  </style>
  
  </head>
  <body>
  <!-- Barra superior: navegaci√≥n y t√≠tulo -->
  <div class="d-flex justify-content-between align-items-center px-3 pt-3 pb-2">
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index') }}">‚Üê Inicio</a>
      <h2 class="mb-0" style="font-size:1.25rem;">Estad√≠sticas</h2>
    </div>
  </div>

  <!-- Panel de filtros principales + Par√°metros REM‚ÄëP -->
  <div class="card mb-3 mx-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold small" for="fecha_desde">Fecha inicio</label>
          <input id="fecha_desde" type="date" class="form-control form-control-sm" value="2024-01-01" />
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold small" for="fecha_hasta">Fecha t√©rmino</label>
          <input id="fecha_hasta" type="date" class="form-control form-control-sm" value="2025-12-31" />
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold small" for="fecha_corte">Fecha corte REM P</label>
          <input id="fecha_corte" type="date" class="form-control form-control-sm" />
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold small" for="sectores_select">Sector</label>
          <select id="sectores_select" class="form-select form-select-sm">
            <option value="">Todos los sectores</option>
            {% for s in sectores %}
              <option value="{{ s.id }}">{{ s.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-2">
          <label class="form-label fw-semibold small" for="sexo_select">Sexo</label>
          <select id="sexo_select" class="form-select form-select-sm">
            <option value="">Ambos sexos</option>
            <option value="M">Masculino</option>
            <option value="F">Femenino</option>
          </select>
        </div>
        <div class="col-12 col-md-4 d-flex gap-2 flex-wrap">
          <button id="btn-aplicar-filtros" type="button" class="btn btn-primary btn-sm">Aplicar filtros</button>
          <button id="btn-limpiar" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btn-exportar-excel" type="button" class="btn btn-outline-primary btn-sm">Exportar Excel</button>
        </div>
      </div>
      <div class="mt-2 small" id="filtros-activos-badge" style="display:none;">
        <!-- Se rellena din√°micamente -->
      </div>
      <hr class="my-3"/>
      <div id="params-panel-host"></div>
    </div>
  </div>

  <!-- REM P 2025 - SECCI√ìN NUEVA SEG√öN MANUAL OFICIAL -->
  <div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
          <i class="bi bi-clipboard-data me-2"></i>
          REM P 2025 - Datos seg√∫n Manual Oficial Version 1.2
        </h5>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light btn-sm" onclick="cargarREMP2025Completo()">
            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
          </button>
          <span class="badge bg-light text-primary">Oficial MINSAL</span>
        </div>
      </div>
    </div>
    <div class="card-body">
      
      <!-- Estado de carga -->
      <div class="row mb-3">
        <div class="col-md-6">
          <small class="text-muted">Estado Secci√≥n A:</small>
          <span id="remp-2025-seccion-a-status" class="badge bg-secondary">Esperando...</span>
        </div>
        <div class="col-md-6">
          <small class="text-muted">Estado Secci√≥n B:</small>
          <span id="remp-2025-seccion-b-status" class="badge bg-secondary">Esperando...</span>
        </div>
      </div>

      <!-- Tabs para organizar secciones -->
      <ul class="nav nav-pills mb-3" id="remp-2025-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="remp-seccion-a-tab" data-bs-toggle="pill" data-bs-target="#remp-seccion-a" type="button" role="tab">
            Secci√≥n A: PSCV
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="remp-seccion-b-tab" data-bs-toggle="pill" data-bs-target="#remp-seccion-b" type="button" role="tab">
            Secci√≥n B: Metas de Control
          </button>
        </li>
      </ul>

      <div class="tab-content" id="remp-2025-tab-content">
        
        <!-- SECCI√ìN A: PROGRAMA SALUD CARDIOVASCULAR -->
        <div class="tab-pane fade show active" id="remp-seccion-a" role="tabpanel">
          <h6 class="text-primary mb-3">Secci√≥n A: Programa Salud Cardiovascular (PSCV)</h6>
          
          <!-- Resumen r√°pido -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h3 class="text-primary mb-1" id="remp-pscv-total">0</h3>
                  <small class="text-muted">Total en PSCV</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h3 class="text-danger mb-1" id="remp-hta-total">0</h3>
                  <small class="text-muted">Con HTA</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h3 class="text-warning mb-1" id="remp-dm2-total">0</h3>
                  <small class="text-muted">Con DM2</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h3 class="text-info mb-1" id="remp-rcv-alto-total">0</h3>
                  <small class="text-muted">RCV Alto</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Tabla detallada por bandas etarias (simplificada) -->
          <div class="table-responsive">
            <table class="table table-sm table-striped table-bordered">
              <thead class="table-dark">
                <tr>
                  <th>Concepto</th>
                  <th>Total</th>
                  <th>Hombres</th>
                  <th>Mujeres</th>
                  <th>15-19</th>
                  <th>20-24</th>
                  <th>25-29</th>
                  <th>30-34</th>
                  <th>35-39</th>
                  <th>40-44</th>
                  <th>45-49</th>
                  <th>50-54</th>
                  <th>55-59</th>
                  <th>60-64</th>
                  <th>65-69</th>
                  <th>70-74</th>
                  <th>75-79</th>
                  <th>80+</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Total PSCV</strong></td>
                  <td id="remp-pscv-total-dup">0</td>
                  <td id="remp-pscv-hombres">0</td>
                  <td id="remp-pscv-mujeres">0</td>
                  <td id="remp-pscv-15-19-h">0</td>
                  <td id="remp-pscv-20-24-h">0</td>
                  <td id="remp-pscv-25-29-h">0</td>
                  <td id="remp-pscv-30-34-h">0</td>
                  <td id="remp-pscv-35-39-h">0</td>
                  <td id="remp-pscv-40-44-h">0</td>
                  <td id="remp-pscv-45-49-h">0</td>
                  <td id="remp-pscv-50-54-h">0</td>
                  <td id="remp-pscv-55-59-h">0</td>
                  <td id="remp-pscv-60-64-h">0</td>
                  <td id="remp-pscv-65-69-h">0</td>
                  <td id="remp-pscv-70-74-h">0</td>
                  <td id="remp-pscv-75-79-h">0</td>
                  <td id="remp-pscv-80-mas-h">0</td>
                </tr>
                <tr>
                  <td><strong>Hipertensi√≥n Arterial</strong></td>
                  <td id="remp-hta-total-dup">0</td>
                  <td id="remp-hta-hombres">0</td>
                  <td id="remp-hta-mujeres">0</td>
                  <td id="remp-hta-15-19-h">0</td>
                  <td id="remp-hta-20-24-h">0</td>
                  <td id="remp-hta-25-29-h">0</td>
                  <td id="remp-hta-30-34-h">0</td>
                  <td id="remp-hta-35-39-h">0</td>
                  <td id="remp-hta-40-44-h">0</td>
                  <td id="remp-hta-45-49-h">0</td>
                  <td id="remp-hta-50-54-h">0</td>
                  <td id="remp-hta-55-59-h">0</td>
                  <td id="remp-hta-60-64-h">0</td>
                  <td id="remp-hta-65-69-h">0</td>
                  <td id="remp-hta-70-74-h">0</td>
                  <td id="remp-hta-75-79-h">0</td>
                  <td id="remp-hta-80-mas-h">0</td>
                </tr>
                <tr>
                  <td><strong>Diabetes Mellitus Tipo 2</strong></td>
                  <td id="remp-dm2-total-dup">0</td>
                  <td id="remp-dm2-hombres">0</td>
                  <td id="remp-dm2-mujeres">0</td>
                  <td id="remp-dm2-15-19-h">0</td>
                  <td id="remp-dm2-20-24-h">0</td>
                  <td id="remp-dm2-25-29-h">0</td>
                  <td id="remp-dm2-30-34-h">0</td>
                  <td id="remp-dm2-35-39-h">0</td>
                  <td id="remp-dm2-40-44-h">0</td>
                  <td id="remp-dm2-45-49-h">0</td>
                  <td id="remp-dm2-50-54-h">0</td>
                  <td id="remp-dm2-55-59-h">0</td>
                  <td id="remp-dm2-60-64-h">0</td>
                  <td id="remp-dm2-65-69-h">0</td>
                  <td id="remp-dm2-70-74-h">0</td>
                  <td id="remp-dm2-75-79-h">0</td>
                  <td id="remp-dm2-80-mas-h">0</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- SECCI√ìN B: METAS DE CONTROL -->
        <div class="tab-pane fade" id="remp-seccion-b" role="tabpanel">
          <h6 class="text-primary mb-3">Secci√≥n B: Metas de Control seg√∫n Manual REM P 2025</h6>
          
          <!-- Resumen de metas -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card border-danger">
                <div class="card-body text-center">
                  <h6 class="text-danger">HTA - Presi√≥n Arterial</h6>
                  <p class="mb-1"><span id="remp-hta-meta-total">0</span> / <span id="remp-hta-meta-poblacion">0</span></p>
                  <h4 class="text-danger mb-0" id="remp-hta-meta-pct">0%</h4>
                  <small class="text-muted">Cumplen meta PA</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-warning">
                <div class="card-body text-center">
                  <h6 class="text-warning">DM2 - HbA1c</h6>
                  <p class="mb-1"><span id="remp-dm2-meta-total">0</span> / <span id="remp-dm2-meta-poblacion">0</span></p>
                  <h4 class="text-warning mb-0" id="remp-dm2-meta-pct">0%</h4>
                  <small class="text-muted">Cumplen meta HbA1c</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-info">
                <div class="card-body text-center">
                  <h6 class="text-info">RCV Alto - LDL</h6>
                  <p class="mb-1"><span id="remp-rcv-meta-total">0</span> / <span id="remp-rcv-meta-poblacion">0</span></p>
                  <h4 class="text-info mb-0" id="remp-rcv-meta-pct">0%</h4>
                  <small class="text-muted">Cumplen meta LDL</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Informaci√≥n de metas configuradas -->
          <div class="alert alert-info">
            <h6><i class="bi bi-info-circle me-2"></i>Metas REM P 2025</h6>
            <ul class="mb-0">
              <li><strong>HTA (15-79 a√±os):</strong> PA &lt;140/90 mmHg</li>
              <li><strong>HTA (‚â•80 a√±os):</strong> PA &lt;150/90 mmHg</li>
              <li><strong>DM2 (15-79 a√±os):</strong> HbA1c &lt;7%</li>
              <li><strong>DM2 (‚â•80 a√±os):</strong> HbA1c &lt;8%</li>
              <li><strong>RCV Alto:</strong> LDL &lt;70 mg/dL</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SECCI√ìN A: PROGRAMA SALUD CARDIOVASCULAR (PSCV) -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCI√ìN A: PROGRAMA SALUD CARDIOVASCULAR (PSCV)</h5>
        <small class="badge bg-success">REM-P 2025</small>
      </div>
      
      <!-- Tabla REM-P Secci√≥n A: Programa PSCV -->
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-seccion-a-pscv" data-export-name="Secci√≥n A - PSCV">
          
          <!-- ENCABEZADOS -->
          <thead class="table-dark sticky-top" id="seccion-a-pscv-head">
            <!-- Fila 1: Grupos principales -->
            <tr>
              <th scope="col" rowspan="3" class="concepto-col text-center align-middle">CONCEPTO</th>
              <th scope="colgroup" colspan="3" class="text-center align-middle">TOTAL</th>
              <th scope="colgroup" colspan="28" class="text-center">RANGO ETARIO Y SEXO</th>
              <th scope="col" rowspan="3" class="text-center align-middle">Pueblos<br>Originarios</th>
              <th scope="col" rowspan="3" class="text-center align-middle">Migrantes</th>
            </tr>
            <!-- Fila 2: Bandas etarias -->
            <tr>
              <th scope="col" class="text-center">Ambos Sexos</th>
              <th scope="col" class="text-center">Hombres</th>
              <th scope="col" class="text-center">Mujeres</th>
              <th scope="colgroup" colspan="2" class="text-center">15 A 19 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">20 A 24 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">25 A 29 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">30 A 34 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">35 A 39 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">40 A 44 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">45 A 49 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">50 A 54 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">55 A 59 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">60 A 64 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">65 A 69 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">70 A 74 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">75 A 79 A√ëOS</th>
              <th scope="colgroup" colspan="2" class="text-center">80 Y M√ÅS A√ëOS</th>
            </tr>
            <!-- Fila 3: Sub-encabezados H/M por cada banda -->
            <tr>
              <th class="text-center"></th>
              <th class="text-center"></th>
              <th class="text-center"></th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
              <th class="text-center">HOMBRES</th><th class="text-center">MUJERES</th>
            </tr>
          </thead>
          <tbody id="seccion-a-pscv-body">
            <!-- Fila principal: N√∫mero de personas en PSCV -->
            <tr>
              <td class="concepto-subcol">N√∫mero de personas en PSCV</td>
              <td class="celda-activa" id="pscv-total">0</td>
              <td class="celda-activa" id="pscv-total-h">0</td>
              <td class="celda-activa" id="pscv-total-m">0</td>
              <td class="celda-activa" id="pscv-15-19-h">0</td><td class="celda-activa" id="pscv-15-19-m">0</td>
              <td class="celda-activa" id="pscv-20-24-h">0</td><td class="celda-activa" id="pscv-20-24-m">0</td>
              <td class="celda-activa" id="pscv-25-29-h">0</td><td class="celda-activa" id="pscv-25-29-m">0</td>
              <td class="celda-activa" id="pscv-30-34-h">0</td><td class="celda-activa" id="pscv-30-34-m">0</td>
              <td class="celda-activa" id="pscv-35-39-h">0</td><td class="celda-activa" id="pscv-35-39-m">0</td>
              <td class="celda-activa" id="pscv-40-44-h">0</td><td class="celda-activa" id="pscv-40-44-m">0</td>
              <td class="celda-activa" id="pscv-45-49-h">0</td><td class="celda-activa" id="pscv-45-49-m">0</td>
              <td class="celda-activa" id="pscv-50-54-h">0</td><td class="celda-activa" id="pscv-50-54-m">0</td>
              <td class="celda-activa" id="pscv-55-59-h">0</td><td class="celda-activa" id="pscv-55-59-m">0</td>
              <td class="celda-activa" id="pscv-60-64-h">0</td><td class="celda-activa" id="pscv-60-64-m">0</td>
              <td class="celda-activa" id="pscv-65-69-h">0</td><td class="celda-activa" id="pscv-65-69-m">0</td>
              <td class="celda-activa" id="pscv-70-74-h">0</td><td class="celda-activa" id="pscv-70-74-m">0</td>
              <td class="celda-activa" id="pscv-75-79-h">0</td><td class="celda-activa" id="pscv-75-79-m">0</td>
              <td class="celda-activa" id="pscv-80-mas-h">0</td><td class="celda-activa" id="pscv-80-mas-m">0</td>
              <td class="celda-activa" id="pscv-po">0</td>
              <td class="celda-activa" id="pscv-mig">0</td>
            </tr>
            <!-- Clasificaci√≥n del Riesgo Cardiovascular: Bajo -->
            <tr>
              <td class="concepto-subcol">Bajo</td>
              <td class="celda-activa" id="riesgo-bajo-total">0</td>
              <td class="celda-activa" id="riesgo-bajo-total-h">0</td>
              <td class="celda-activa" id="riesgo-bajo-total-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-15-19-h">0</td><td class="celda-activa" id="riesgo-bajo-15-19-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-20-24-h">0</td><td class="celda-activa" id="riesgo-bajo-20-24-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-25-29-h">0</td><td class="celda-activa" id="riesgo-bajo-25-29-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-30-34-h">0</td><td class="celda-activa" id="riesgo-bajo-30-34-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-35-39-h">0</td><td class="celda-activa" id="riesgo-bajo-35-39-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-40-44-h">0</td><td class="celda-activa" id="riesgo-bajo-40-44-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-45-49-h">0</td><td class="celda-activa" id="riesgo-bajo-45-49-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-50-54-h">0</td><td class="celda-activa" id="riesgo-bajo-50-54-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-55-59-h">0</td><td class="celda-activa" id="riesgo-bajo-55-59-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-60-64-h">0</td><td class="celda-activa" id="riesgo-bajo-60-64-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-65-69-h">0</td><td class="celda-activa" id="riesgo-bajo-65-69-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-70-74-h">0</td><td class="celda-activa" id="riesgo-bajo-70-74-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-75-79-h">0</td><td class="celda-activa" id="riesgo-bajo-75-79-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-80-mas-h">0</td><td class="celda-activa" id="riesgo-bajo-80-mas-m">0</td>
              <td class="celda-activa" id="riesgo-bajo-po">0</td>
              <td class="celda-activa" id="riesgo-bajo-mig">0</td>
            </tr>
            <!-- Clasificaci√≥n del Riesgo Cardiovascular: Moderado -->
            <tr>
              <td class="concepto-subcol">Moderado</td>
              <td class="celda-activa" id="riesgo-mod-total">0</td>
              <td class="celda-activa" id="riesgo-mod-total-h">0</td>
              <td class="celda-activa" id="riesgo-mod-total-m">0</td>
              <td class="celda-activa" id="riesgo-mod-15-19-h">0</td><td class="celda-activa" id="riesgo-mod-15-19-m">0</td>
              <td class="celda-activa" id="riesgo-mod-20-24-h">0</td><td class="celda-activa" id="riesgo-mod-20-24-m">0</td>
              <td class="celda-activa" id="riesgo-mod-25-29-h">0</td><td class="celda-activa" id="riesgo-mod-25-29-m">0</td>
              <td class="celda-activa" id="riesgo-mod-30-34-h">0</td><td class="celda-activa" id="riesgo-mod-30-34-m">0</td>
              <td class="celda-activa" id="riesgo-mod-35-39-h">0</td><td class="celda-activa" id="riesgo-mod-35-39-m">0</td>
              <td class="celda-activa" id="riesgo-mod-40-44-h">0</td><td class="celda-activa" id="riesgo-mod-40-44-m">0</td>
              <td class="celda-activa" id="riesgo-mod-45-49-h">0</td><td class="celda-activa" id="riesgo-mod-45-49-m">0</td>
              <td class="celda-activa" id="riesgo-mod-50-54-h">0</td><td class="celda-activa" id="riesgo-mod-50-54-m">0</td>
              <td class="celda-activa" id="riesgo-mod-55-59-h">0</td><td class="celda-activa" id="riesgo-mod-55-59-m">0</td>
              <td class="celda-activa" id="riesgo-mod-60-64-h">0</td><td class="celda-activa" id="riesgo-mod-60-64-m">0</td>
              <td class="celda-activa" id="riesgo-mod-65-69-h">0</td><td class="celda-activa" id="riesgo-mod-65-69-m">0</td>
              <td class="celda-activa" id="riesgo-mod-70-74-h">0</td><td class="celda-activa" id="riesgo-mod-70-74-m">0</td>
              <td class="celda-activa" id="riesgo-mod-75-79-h">0</td><td class="celda-activa" id="riesgo-mod-75-79-m">0</td>
              <td class="celda-activa" id="riesgo-mod-80-mas-h">0</td><td class="celda-activa" id="riesgo-mod-80-mas-m">0</td>
              <td class="celda-activa" id="riesgo-mod-po">0</td>
              <td class="celda-activa" id="riesgo-mod-mig">0</td>
            </tr>
            <!-- Clasificaci√≥n del Riesgo Cardiovascular: Alto -->
            <tr>
              <td class="concepto-subcol">Alto</td>
              <td class="celda-activa" id="riesgo-alto-total">0</td>
              <td class="celda-activa" id="riesgo-alto-total-h">0</td>
              <td class="celda-activa" id="riesgo-alto-total-m">0</td>
              <td class="celda-activa" id="riesgo-alto-15-19-h">0</td><td class="celda-activa" id="riesgo-alto-15-19-m">0</td>
              <td class="celda-activa" id="riesgo-alto-20-24-h">0</td><td class="celda-activa" id="riesgo-alto-20-24-m">0</td>
              <td class="celda-activa" id="riesgo-alto-25-29-h">0</td><td class="celda-activa" id="riesgo-alto-25-29-m">0</td>
              <td class="celda-activa" id="riesgo-alto-30-34-h">0</td><td class="celda-activa" id="riesgo-alto-30-34-m">0</td>
              <td class="celda-activa" id="riesgo-alto-35-39-h">0</td><td class="celda-activa" id="riesgo-alto-35-39-m">0</td>
              <td class="celda-activa" id="riesgo-alto-40-44-h">0</td><td class="celda-activa" id="riesgo-alto-40-44-m">0</td>
              <td class="celda-activa" id="riesgo-alto-45-49-h">0</td><td class="celda-activa" id="riesgo-alto-45-49-m">0</td>
              <td class="celda-activa" id="riesgo-alto-50-54-h">0</td><td class="celda-activa" id="riesgo-alto-50-54-m">0</td>
              <td class="celda-activa" id="riesgo-alto-55-59-h">0</td><td class="celda-activa" id="riesgo-alto-55-59-m">0</td>
              <td class="celda-activa" id="riesgo-alto-60-64-h">0</td><td class="celda-activa" id="riesgo-alto-60-64-m">0</td>
              <td class="celda-activa" id="riesgo-alto-65-69-h">0</td><td class="celda-activa" id="riesgo-alto-65-69-m">0</td>
              <td class="celda-activa" id="riesgo-alto-70-74-h">0</td><td class="celda-activa" id="riesgo-alto-70-74-m">0</td>
              <td class="celda-activa" id="riesgo-alto-75-79-h">0</td><td class="celda-activa" id="riesgo-alto-75-79-m">0</td>
              <td class="celda-activa" id="riesgo-alto-80-mas-h">0</td><td class="celda-activa" id="riesgo-alto-80-mas-m">0</td>
              <td class="celda-activa" id="riesgo-alto-po">0</td>
              <td class="celda-activa" id="riesgo-alto-mig">0</td>
            </tr>
            <!-- Hipertensi√≥n Arterial -->
            <tr>
              <td class="concepto-subcol">Hipertensi√≥n Arterial</td>
              <td class="celda-activa" id="hta-total">0</td>
              <td class="celda-activa" id="hta-total-h">0</td>
              <td class="celda-activa" id="hta-total-m">0</td>
              <td class="celda-activa" id="hta-15-19-h">0</td><td class="celda-activa" id="hta-15-19-m">0</td>
              <td class="celda-activa" id="hta-20-24-h">0</td><td class="celda-activa" id="hta-20-24-m">0</td>
              <td class="celda-activa" id="hta-25-29-h">0</td><td class="celda-activa" id="hta-25-29-m">0</td>
              <td class="celda-activa" id="hta-30-34-h">0</td><td class="celda-activa" id="hta-30-34-m">0</td>
              <td class="celda-activa" id="hta-35-39-h">0</td><td class="celda-activa" id="hta-35-39-m">0</td>
              <td class="celda-activa" id="hta-40-44-h">0</td><td class="celda-activa" id="hta-40-44-m">0</td>
              <td class="celda-activa" id="hta-45-49-h">0</td><td class="celda-activa" id="hta-45-49-m">0</td>
              <td class="celda-activa" id="hta-50-54-h">0</td><td class="celda-activa" id="hta-50-54-m">0</td>
              <td class="celda-activa" id="hta-55-59-h">0</td><td class="celda-activa" id="hta-55-59-m">0</td>
              <td class="celda-activa" id="hta-60-64-h">0</td><td class="celda-activa" id="hta-60-64-m">0</td>
              <td class="celda-activa" id="hta-65-69-h">0</td><td class="celda-activa" id="hta-65-69-m">0</td>
              <td class="celda-activa" id="hta-70-74-h">0</td><td class="celda-activa" id="hta-70-74-m">0</td>
              <td class="celda-activa" id="hta-75-79-h">0</td><td class="celda-activa" id="hta-75-79-m">0</td>
              <td class="celda-activa" id="hta-80-mas-h">0</td><td class="celda-activa" id="hta-80-mas-m">0</td>
              <td class="celda-activa" id="hta-po">0</td>
              <td class="celda-activa" id="hta-mig">0</td>
            </tr>
            <tr>
              <td class="concepto-subcol">Diabetes Mellitus tipo 2</td>
              <td class="celda-activa" id="dm2-total">0</td>
              <td class="celda-activa" id="dm2-total-h">0</td>
              <td class="celda-activa" id="dm2-total-m">0</td>
              <!-- Todas las celdas de DM2 por banda etaria -->
              <td class="celda-activa" id="dm2-15-19-h">0</td><td class="celda-activa" id="dm2-15-19-m">0</td>
              <td class="celda-activa" id="dm2-20-24-h">0</td><td class="celda-activa" id="dm2-20-24-m">0</td>
              <td class="celda-activa" id="dm2-25-29-h">0</td><td class="celda-activa" id="dm2-25-29-m">0</td>
              <td class="celda-activa" id="dm2-30-34-h">0</td><td class="celda-activa" id="dm2-30-34-m">0</td>
              <td class="celda-activa" id="dm2-35-39-h">0</td><td class="celda-activa" id="dm2-35-39-m">0</td>
              <td class="celda-activa" id="dm2-40-44-h">0</td><td class="celda-activa" id="dm2-40-44-m">0</td>
              <td class="celda-activa" id="dm2-45-49-h">0</td><td class="celda-activa" id="dm2-45-49-m">0</td>
              <td class="celda-activa" id="dm2-50-54-h">0</td><td class="celda-activa" id="dm2-50-54-m">0</td>
              <td class="celda-activa" id="dm2-55-59-h">0</td><td class="celda-activa" id="dm2-55-59-m">0</td>
              <td class="celda-activa" id="dm2-60-64-h">0</td><td class="celda-activa" id="dm2-60-64-m">0</td>
              <td class="celda-activa" id="dm2-65-69-h">0</td><td class="celda-activa" id="dm2-65-69-m">0</td>
              <td class="celda-activa" id="dm2-70-74-h">0</td><td class="celda-activa" id="dm2-70-74-m">0</td>
              <td class="celda-activa" id="dm2-75-79-h">0</td><td class="celda-activa" id="dm2-75-79-m">0</td>
              <td class="celda-activa" id="dm2-80-mas-h">0</td><td class="celda-activa" id="dm2-80-mas-m">0</td>
              <td class="celda-activa" id="dm2-po">0</td>
              <td class="celda-activa" id="dm2-mig">0</td>
            </tr>
            <tr>
              <td class="concepto-subcol">Dislipidemia</td>
              <td class="celda-activa" id="dislip-total">0</td>
              <td class="celda-activa" id="dislip-total-h">0</td>
              <td class="celda-activa" id="dislip-total-m">0</td>
              <!-- Todas las celdas de dislipidemia por banda etaria -->
              <td class="celda-activa" id="dislip-15-19-h">0</td><td class="celda-activa" id="dislip-15-19-m">0</td>
              <td class="celda-activa" id="dislip-20-24-h">0</td><td class="celda-activa" id="dislip-20-24-m">0</td>
              <td class="celda-activa" id="dislip-25-29-h">0</td><td class="celda-activa" id="dislip-25-29-m">0</td>
              <td class="celda-activa" id="dislip-30-34-h">0</td><td class="celda-activa" id="dislip-30-34-m">0</td>
              <td class="celda-activa" id="dislip-35-39-h">0</td><td class="celda-activa" id="dislip-35-39-m">0</td>
              <td class="celda-activa" id="dislip-40-44-h">0</td><td class="celda-activa" id="dislip-40-44-m">0</td>
              <td class="celda-activa" id="dislip-45-49-h">0</td><td class="celda-activa" id="dislip-45-49-m">0</td>
              <td class="celda-activa" id="dislip-50-54-h">0</td><td class="celda-activa" id="dislip-50-54-m">0</td>
              <td class="celda-activa" id="dislip-55-59-h">0</td><td class="celda-activa" id="dislip-55-59-m">0</td>
              <td class="celda-activa" id="dislip-60-64-h">0</td><td class="celda-activa" id="dislip-60-64-m">0</td>
              <td class="celda-activa" id="dislip-65-69-h">0</td><td class="celda-activa" id="dislip-65-69-m">0</td>
              <td class="celda-activa" id="dislip-70-74-h">0</td><td class="celda-activa" id="dislip-70-74-m">0</td>
              <td class="celda-activa" id="dislip-75-79-h">0</td><td class="celda-activa" id="dislip-75-79-m">0</td>
              <td class="celda-activa" id="dislip-80-mas-h">0</td><td class="celda-activa" id="dislip-80-mas-m">0</td>
              <td class="celda-activa" id="dislip-po">0</td>
              <td class="celda-activa" id="dislip-mig">0</td>
            </tr>
            <tr>
              <td class="concepto-subcol">Tabaquismo ‚â• 55 a√±os</td>
              <!-- Tabaquismo solo para ‚â•55 a√±os -->
              <td class="celda-activa" id="tabaq-total">0</td>
              <td class="celda-activa" id="tabaq-total-h">0</td>
              <td class="celda-activa" id="tabaq-total-m">0</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-activa" id="tabaq-55-59-h">0</td><td class="celda-activa" id="tabaq-55-59-m">0</td>
              <td class="celda-activa" id="tabaq-60-64-h">0</td><td class="celda-activa" id="tabaq-60-64-m">0</td>
              <td class="celda-activa" id="tabaq-65-69-h">0</td><td class="celda-activa" id="tabaq-65-69-m">0</td>
              <td class="celda-activa" id="tabaq-70-74-h">0</td><td class="celda-activa" id="tabaq-70-74-m">0</td>
              <td class="celda-activa" id="tabaq-75-79-h">0</td><td class="celda-activa" id="tabaq-75-79-m">0</td>
              <td class="celda-activa" id="tabaq-80-mas-h">0</td><td class="celda-activa" id="tabaq-80-mas-m">0</td>
              <td class="celda-activa" id="tabaq-po">0</td>
              <td class="celda-activa" id="tabaq-mig">0</td>
            </tr>
            <tr>
              <td class="concepto-subcol">
                <span class="diagnosticos-tooltip" data-diagnostico="Antecedentes de Infarto Agudo al Miocardio (IAM)">
                  Antecedentes de Infarto Agudo al Miocardio (IAM)
                </span>
              </td>
              <td class="celda-activa" id="iam-ant-total">0</td>
              <td class="celda-activa" id="iam-ant-total-h">0</td>
              <td class="celda-activa" id="iam-ant-total-m">0</td>
              <!-- Todas las celdas de IAM por banda etaria -->
              <td class="celda-activa" id="iam-ant-15-19-h">0</td><td class="celda-activa" id="iam-ant-15-19-m">0</td>
              <td class="celda-activa" id="iam-ant-20-24-h">0</td><td class="celda-activa" id="iam-ant-20-24-m">0</td>
              <td class="celda-activa" id="iam-ant-25-29-h">0</td><td class="celda-activa" id="iam-ant-25-29-m">0</td>
              <td class="celda-activa" id="iam-ant-30-34-h">0</td><td class="celda-activa" id="iam-ant-30-34-m">0</td>
              <td class="celda-activa" id="iam-ant-35-39-h">0</td><td class="celda-activa" id="iam-ant-35-39-m">0</td>
              <td class="celda-activa" id="iam-ant-40-44-h">0</td><td class="celda-activa" id="iam-ant-40-44-m">0</td>
              <td class="celda-activa" id="iam-ant-45-49-h">0</td><td class="celda-activa" id="iam-ant-45-49-m">0</td>
              <td class="celda-activa" id="iam-ant-50-54-h">0</td><td class="celda-activa" id="iam-ant-50-54-m">0</td>
              <td class="celda-activa" id="iam-ant-55-59-h">0</td><td class="celda-activa" id="iam-ant-55-59-m">0</td>
              <td class="celda-activa" id="iam-ant-60-64-h">0</td><td class="celda-activa" id="iam-ant-60-64-m">0</td>
              <td class="celda-activa" id="iam-ant-65-69-h">0</td><td class="celda-activa" id="iam-ant-65-69-m">0</td>
              <td class="celda-activa" id="iam-ant-70-74-h">0</td><td class="celda-activa" id="iam-ant-70-74-m">0</td>
              <td class="celda-activa" id="iam-ant-75-79-h">0</td><td class="celda-activa" id="iam-ant-75-79-m">0</td>
              <td class="celda-activa" id="iam-ant-80-mas-h">0</td><td class="celda-activa" id="iam-ant-80-mas-m">0</td>
              <td class="celda-activa" id="iam-ant-po">0</td>
              <td class="celda-activa" id="iam-ant-mig">0</td>
            </tr>
            <tr>
              <td class="concepto-subcol">
                <span class="diagnosticos-tooltip" data-diagnostico="Antecedentes de Ataque Cerebro Vascular (ACV)">
                  Antecedentes de Ataque Cerebro Vascular (ACV)
                </span>
              </td>
              <td class="celda-activa" id="acv-ant-total">0</td>
              <td class="celda-activa" id="acv-ant-total-h">0</td>
              <td class="celda-activa" id="acv-ant-total-m">0</td>
              <!-- Todas las celdas de ACV por banda etaria -->
              <td class="celda-activa" id="acv-ant-15-19-h">0</td><td class="celda-activa" id="acv-ant-15-19-m">0</td>
              <td class="celda-activa" id="acv-ant-20-24-h">0</td><td class="celda-activa" id="acv-ant-20-24-m">0</td>
              <td class="celda-activa" id="acv-ant-25-29-h">0</td><td class="celda-activa" id="acv-ant-25-29-m">0</td>
              <td class="celda-activa" id="acv-ant-30-34-h">0</td><td class="celda-activa" id="acv-ant-30-34-m">0</td>
              <td class="celda-activa" id="acv-ant-35-39-h">0</td><td class="celda-activa" id="acv-ant-35-39-m">0</td>
              <td class="celda-activa" id="acv-ant-40-44-h">0</td><td class="celda-activa" id="acv-ant-40-44-m">0</td>
              <td class="celda-activa" id="acv-ant-45-49-h">0</td><td class="celda-activa" id="acv-ant-45-49-m">0</td>
              <td class="celda-activa" id="acv-ant-50-54-h">0</td><td class="celda-activa" id="acv-ant-50-54-m">0</td>
              <td class="celda-activa" id="acv-ant-55-59-h">0</td><td class="celda-activa" id="acv-ant-55-59-m">0</td>
              <td class="celda-activa" id="acv-ant-60-64-h">0</td><td class="celda-activa" id="acv-ant-60-64-m">0</td>
              <td class="celda-activa" id="acv-ant-65-69-h">0</td><td class="celda-activa" id="acv-ant-65-69-m">0</td>
              <td class="celda-activa" id="acv-ant-70-74-h">0</td><td class="celda-activa" id="acv-ant-70-74-m">0</td>
              <td class="celda-activa" id="acv-ant-75-79-h">0</td><td class="celda-activa" id="acv-ant-75-79-m">0</td>
              <td class="celda-activa" id="acv-ant-80-mas-h">0</td><td class="celda-activa" id="acv-ant-80-mas-m">0</td>
              <td class="celda-activa" id="acv-ant-po">0</td>
              <td class="celda-activa" id="acv-ant-mig">0</td>
            </tr>
            <tr>
              <td class="concepto-subcol">
                <span class="diagnosticos-tooltip" data-diagnostico="Antecedentes de otras Enfermedades Cardiovasculares ECV (excepto IAM y ACV)">
                  Antecedentes de otras Enfermedades Cardiovasculares ECV (excepto IAM y ACV)
                </span>
              </td>
              <td class="celda-activa" id="ecv-ant-total">0</td>
              <td class="celda-activa" id="ecv-ant-total-h">0</td>
              <td class="celda-activa" id="ecv-ant-total-m">0</td>
              <!-- Todas las celdas de ECV por banda etaria -->
              <td class="celda-activa" id="ecv-ant-15-19-h">0</td><td class="celda-activa" id="ecv-ant-15-19-m">0</td>
              <td class="celda-activa" id="ecv-ant-20-24-h">0</td><td class="celda-activa" id="ecv-ant-20-24-m">0</td>
              <td class="celda-activa" id="ecv-ant-25-29-h">0</td><td class="celda-activa" id="ecv-ant-25-29-m">0</td>
              <td class="celda-activa" id="ecv-ant-30-34-h">0</td><td class="celda-activa" id="ecv-ant-30-34-m">0</td>
              <td class="celda-activa" id="ecv-ant-35-39-h">0</td><td class="celda-activa" id="ecv-ant-35-39-m">0</td>
              <td class="celda-activa" id="ecv-ant-40-44-h">0</td><td class="celda-activa" id="ecv-ant-40-44-m">0</td>
              <td class="celda-activa" id="ecv-ant-45-49-h">0</td><td class="celda-activa" id="ecv-ant-45-49-m">0</td>
              <td class="celda-activa" id="ecv-ant-50-54-h">0</td><td class="celda-activa" id="ecv-ant-50-54-m">0</td>
              <td class="celda-activa" id="ecv-ant-55-59-h">0</td><td class="celda-activa" id="ecv-ant-55-59-m">0</td>
              <td class="celda-activa" id="ecv-ant-60-64-h">0</td><td class="celda-activa" id="ecv-ant-60-64-m">0</td>
              <td class="celda-activa" id="ecv-ant-65-69-h">0</td><td class="celda-activa" id="ecv-ant-65-69-m">0</td>
              <td class="celda-activa" id="ecv-ant-70-74-h">0</td><td class="celda-activa" id="ecv-ant-70-74-m">0</td>
              <td class="celda-activa" id="ecv-ant-75-79-h">0</td><td class="celda-activa" id="ecv-ant-75-79-m">0</td>
              <td class="celda-activa" id="ecv-ant-80-mas-h">0</td><td class="celda-activa" id="ecv-ant-80-mas-m">0</td>
              <td class="celda-activa" id="ecv-ant-po">0</td>
              <td class="celda-activa" id="ecv-ant-mig">0</td>
            </tr>
            <tr>
              <td class="concepto-subcol">Enfermedad renal cr√≥nica (etapas 1 a 5)</td>
              <td class="celda-activa" id="erc-total">0</td>
              <td class="celda-activa" id="erc-total-h">0</td>
              <td class="celda-activa" id="erc-total-m">0</td>
              <!-- Todas las celdas de ERC por banda etaria -->
              <td class="celda-activa" id="erc-15-19-h">0</td><td class="celda-activa" id="erc-15-19-m">0</td>
              <td class="celda-activa" id="erc-20-24-h">0</td><td class="celda-activa" id="erc-20-24-m">0</td>
              <td class="celda-activa" id="erc-25-29-h">0</td><td class="celda-activa" id="erc-25-29-m">0</td>
              <td class="celda-activa" id="erc-30-34-h">0</td><td class="celda-activa" id="erc-30-34-m">0</td>
              <td class="celda-activa" id="erc-35-39-h">0</td><td class="celda-activa" id="erc-35-39-m">0</td>
              <td class="celda-activa" id="erc-40-44-h">0</td><td class="celda-activa" id="erc-40-44-m">0</td>
              <td class="celda-activa" id="erc-45-49-h">0</td><td class="celda-activa" id="erc-45-49-m">0</td>
              <td class="celda-activa" id="erc-50-54-h">0</td><td class="celda-activa" id="erc-50-54-m">0</td>
              <td class="celda-activa" id="erc-55-59-h">0</td><td class="celda-activa" id="erc-55-59-m">0</td>
              <td class="celda-activa" id="erc-60-64-h">0</td><td class="celda-activa" id="erc-60-64-m">0</td>
              <td class="celda-activa" id="erc-65-69-h">0</td><td class="celda-activa" id="erc-65-69-m">0</td>
              <td class="celda-activa" id="erc-70-74-h">0</td><td class="celda-activa" id="erc-70-74-m">0</td>
              <td class="celda-activa" id="erc-75-79-h">0</td><td class="celda-activa" id="erc-75-79-m">0</td>
              <td class="celda-activa" id="erc-80-mas-h">0</td><td class="celda-activa" id="erc-80-mas-m">0</td>
              <td class="celda-activa" id="erc-po">0</td>
              <td class="celda-activa" id="erc-mig">0</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="seccion-a-status" class="small text-muted mt-2">Iniciando carga...</div>
    </div>
  </div>

  <!-- Secci√≥n B: Metas de Compensaci√≥n -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCI√ìN B: METAS DE COMPENSACI√ìN</h5>
        <small class="badge bg-primary">Datos con Bandas Etarias REM-P</small>
      </div>
      
      <!-- Resumen de totales -->
      <div class="row mt-3 mb-3">
        <div class="col-md-3">
          <div class="card bg-light border-0">
            <div class="card-body text-center py-2">
              <h6 class="text-primary mb-1">PA &lt; 140/90</h6>
              <h4 class="text-primary mb-0" id="total-pa-140">0</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light border-0">
            <div class="card-body text-center py-2">
              <h6 class="text-success mb-1">PA &lt; 150/90</h6>
              <h4 class="text-success mb-0" id="total-pa-150">0</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light border-0">
            <div class="card-body text-center py-2">
              <h6 class="text-info mb-1">HbA1c &lt; 7%</h6>
              <h4 class="text-info mb-0" id="total-hba1c-7">0</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-light border-0">
            <div class="card-body text-center py-2">
              <h6 class="text-warning mb-1">HbA1c &lt; 8%</h6>
              <h4 class="text-warning mb-0" id="total-hba1c-8">0</h4>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla REM-P Secci√≥n B: Metas de Compensaci√≥n -->
      <div class="table-responsive mt-3">
        <style>
          .celda-bloqueada {
            background-color: #e9ecef !important;
            color: #6c757d !important;
            text-align: center;
            vertical-align: middle;
          }
          .celda-activa {
            background-color: white !important;
            text-align: center;
            vertical-align: middle;
          }
          #tabla-remp-metas th {
            text-align: center;
            vertical-align: middle;
            font-weight: bold;
            font-size: 0.8rem;
            background-color: #495057;
            color: white;
            border: 1px solid #dee2e6;
          }
          #tabla-remp-metas td {
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
          }
          .concepto-col {
            width: 350px;
            text-align: left;
            font-weight: 500;
            background-color: #f8f9fa;
          }
        </style>
        
        <table class="table table-sm table-bordered" id="tabla-remp-metas">
          <thead>
            <tr>
              <th scope="col" rowspan="3" class="concepto-col">CONCEPTO</th>
              <th scope="colgroup" colspan="3">TOTAL</th>
              <th scope="colgroup" colspan="28">RANGO ETARIO Y SEXO</th>
              <th scope="colgroup" colspan="2">Pueblos Originarios</th>
              <th scope="colgroup" colspan="2">Migrantes</th>
            </tr>
            <tr>
              <th scope="col" rowspan="2">Ambos sexos</th>
              <th scope="col" rowspan="2">Hombres</th>
              <th scope="col" rowspan="2">Mujeres</th>
              <th scope="colgroup" colspan="2">15 a 19 a√±os</th>
              <th scope="colgroup" colspan="2">20 a 24 a√±os</th>
              <th scope="colgroup" colspan="2">25 a 29 a√±os</th>
              <th scope="colgroup" colspan="2">30 a 34 a√±os</th>
              <th scope="colgroup" colspan="2">35 a 39 a√±os</th>
              <th scope="colgroup" colspan="2">40 a 44 a√±os</th>
              <th scope="colgroup" colspan="2">45 a 49 a√±os</th>
              <th scope="colgroup" colspan="2">50 a 54 a√±os</th>
              <th scope="colgroup" colspan="2">55 a 59 a√±os</th>
              <th scope="colgroup" colspan="2">60 a 64 a√±os</th>
              <th scope="colgroup" colspan="2">65 a 69 a√±os</th>
              <th scope="colgroup" colspan="2">70 a 74 a√±os</th>
              <th scope="colgroup" colspan="2">75 a 79 a√±os</th>
              <th scope="colgroup" colspan="2">80 y m√°s a√±os</th>
              <th scope="col" rowspan="2">Hombres</th>
              <th scope="col" rowspan="2">Mujeres</th>
              <th scope="col" rowspan="2">Hombres</th>
              <th scope="col" rowspan="2">Mujeres</th>
            </tr>
            <tr>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
              <th scope="col">Hombres</th><th scope="col">Mujeres</th>
            </tr>
          </thead>
          <tbody id="remp-metas-body">
            <!-- Personas Bajo Control por Hipertensi√≥n -->
            <tr>
              <td class="concepto-col fw-bold bg-info text-white" colspan="35">Personas Bajo Control por Hipertensi√≥n</td>
            </tr>
            <tr>
              <td class="concepto-col">PA &lt; 140/90 mmHg</td>
              <td class="celda-activa" id="pa140-total">0</td>
              <td class="celda-activa" id="pa140-h">0</td>
              <td class="celda-activa" id="pa140-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-15-19-h">0</td><td class="celda-activa" id="pa140-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-20-24-h">0</td><td class="celda-activa" id="pa140-20-24-m">0</td>
              <!-- 25-29 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-25-29-h">0</td><td class="celda-activa" id="pa140-25-29-m">0</td>
              <!-- 30-34 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-30-34-h">0</td><td class="celda-activa" id="pa140-30-34-m">0</td>
              <!-- 35-39 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-35-39-h">0</td><td class="celda-activa" id="pa140-35-39-m">0</td>
              <!-- 40-44 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-40-44-h">0</td><td class="celda-activa" id="pa140-40-44-m">0</td>
              <!-- 45-49 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-45-49-h">0</td><td class="celda-activa" id="pa140-45-49-m">0</td>
              <!-- 50-54 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-50-54-h">0</td><td class="celda-activa" id="pa140-50-54-m">0</td>
              <!-- 55-59 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-55-59-h">0</td><td class="celda-activa" id="pa140-55-59-m">0</td>
              <!-- 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-60-64-h">0</td><td class="celda-activa" id="pa140-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-65-69-h">0</td><td class="celda-activa" id="pa140-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-70-74-h">0</td><td class="celda-activa" id="pa140-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-75-79-h">0</td><td class="celda-activa" id="pa140-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="pa140-80-mas-h">0</td><td class="celda-activa" id="pa140-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            <tr>
              <td class="concepto-col">PA &lt; 150/90 mmHg</td>
              <td class="celda-activa" id="pa150-total">0</td>
              <td class="celda-activa" id="pa150-h">0</td>
              <td class="celda-activa" id="pa150-m">0</td>
              <!-- 15-19 a 79 a√±os: BLOQUEADAS para PA 150/90 (solo ‚â•80 a√±os) -->
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <!-- 80+ a√±os: ACTIVAS para PA 150/90 -->
              <td class="celda-activa" id="pa150-80-mas-h">0</td><td class="celda-activa" id="pa150-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            
            <!-- Personas Bajo Control por Diabetes Mellitus -->
            <tr>
              <td class="concepto-col fw-bold bg-warning text-dark" colspan="35">Personas Bajo Control por Diabetes Mellitus</td>
            </tr>
            <tr>
              <td class="concepto-col">HbA1C&lt;7%</td>
              <td class="celda-activa" id="hba1c7-total">0</td>
              <td class="celda-activa" id="hba1c7-h">0</td>
              <td class="celda-activa" id="hba1c7-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS -->
              <td class="celda-activa" id="hba1c7-15-19-h">0</td><td class="celda-activa" id="hba1c7-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS -->
              <td class="celda-activa" id="hba1c7-20-24-h">0</td><td class="celda-activa" id="hba1c7-20-24-m">0</td>
              <!-- 15-19 a 64 a√±os: ACTIVAS para HbA1c<7% -->
              <td class="celda-activa" id="hba1c7-25-29-h">0</td><td class="celda-activa" id="hba1c7-25-29-m">0</td>
              <td class="celda-activa" id="hba1c7-30-34-h">0</td><td class="celda-activa" id="hba1c7-30-34-m">0</td>
              <td class="celda-activa" id="hba1c7-35-39-h">0</td><td class="celda-activa" id="hba1c7-35-39-m">0</td>
              <td class="celda-activa" id="hba1c7-40-44-h">0</td><td class="celda-activa" id="hba1c7-40-44-m">0</td>
              <td class="celda-activa" id="hba1c7-45-49-h">0</td><td class="celda-activa" id="hba1c7-45-49-m">0</td>
              <td class="celda-activa" id="hba1c7-50-54-h">0</td><td class="celda-activa" id="hba1c7-50-54-m">0</td>
              <td class="celda-activa" id="hba1c7-55-59-h">0</td><td class="celda-activa" id="hba1c7-55-59-m">0</td>
              <td class="celda-activa" id="hba1c7-60-64-h">0</td><td class="celda-activa" id="hba1c7-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="hba1c7-65-69-h">0</td><td class="celda-activa" id="hba1c7-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="hba1c7-70-74-h">0</td><td class="celda-activa" id="hba1c7-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="hba1c7-75-79-h">0</td><td class="celda-activa" id="hba1c7-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="hba1c7-80-mas-h">0</td><td class="celda-activa" id="hba1c7-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-activa" id="hba1c7-po-h">0</td><td class="celda-activa" id="hba1c7-po-m">0</td>
              <!-- Migrantes -->
              <td class="celda-activa" id="hba1c7-mig-h">0</td><td class="celda-activa" id="hba1c7-mig-m">0</td>
            </tr>
            <tr>
              <td class="concepto-col">HbA1C&lt;8%</td>
              <td class="celda-activa" id="hba1c8-total">0</td>
              <td class="celda-activa" id="hba1c8-h">0</td>
              <td class="celda-activa" id="hba1c8-m">0</td>
              <!-- 15-19 a 60-64 a√±os: BLOQUEADAS para HbA1c<8% (solo ‚â•80 a√±os) -->
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <td class="celda-bloqueada">-</td><td class="celda-bloqueada">-</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>

            <!-- Personas con RCV alto -->
            <tr>
              <td class="concepto-col fw-bold bg-danger text-white" colspan="35">Personas con RCV alto</td>
            </tr>
            <tr>
              <td class="concepto-col">Colesterol LDL &lt; 70 mg/dL</td>
              <td class="celda-activa" id="ldl70-total">0</td>
              <td class="celda-activa" id="ldl70-h">0</td>
              <td class="celda-activa" id="ldl70-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste: antes bloqueadas) -->
              <td class="celda-activa" id="ldl70-15-19-h">0</td><td class="celda-activa" id="ldl70-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste: antes bloqueadas) -->
              <td class="celda-activa" id="ldl70-20-24-h">0</td><td class="celda-activa" id="ldl70-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ldl70-25-29-h">0</td><td class="celda-activa" id="ldl70-25-29-m">0</td>
              <td class="celda-activa" id="ldl70-30-34-h">0</td><td class="celda-activa" id="ldl70-30-34-m">0</td>
              <td class="celda-activa" id="ldl70-35-39-h">0</td><td class="celda-activa" id="ldl70-35-39-m">0</td>
              <td class="celda-activa" id="ldl70-40-44-h">0</td><td class="celda-activa" id="ldl70-40-44-m">0</td>
              <td class="celda-activa" id="ldl70-45-49-h">0</td><td class="celda-activa" id="ldl70-45-49-m">0</td>
              <td class="celda-activa" id="ldl70-50-54-h">0</td><td class="celda-activa" id="ldl70-50-54-m">0</td>
              <td class="celda-activa" id="ldl70-55-59-h">0</td><td class="celda-activa" id="ldl70-55-59-m">0</td>
              <td class="celda-activa" id="ldl70-60-64-h">0</td><td class="celda-activa" id="ldl70-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ldl70-65-69-h">0</td><td class="celda-activa" id="ldl70-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ldl70-70-74-h">0</td><td class="celda-activa" id="ldl70-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ldl70-75-79-h">0</td><td class="celda-activa" id="ldl70-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="ldl70-80-mas-h">0</td><td class="celda-activa" id="ldl70-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>

            <!-- Personas bajo control con antecedentes enfermedad cardiovascular (ECV), excepto IAM y ACV -->
            <tr>
              <td class="concepto-col fw-bold bg-secondary text-white" colspan="27">Personas bajo control con antecedentes enfermedad cardiovascular (ECV), excepto IAM y ACV</td>
            </tr>
            <tr>
              <td class="concepto-col">En tratamiento con Antiagregantes plaquetarios</td>
              <td class="celda-activa" id="ecv-antiag-total">0</td>
              <td class="celda-activa" id="ecv-antiag-h">0</td>
              <td class="celda-activa" id="ecv-antiag-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="ecv-antiag-15-19-h">0</td><td class="celda-activa" id="ecv-antiag-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="ecv-antiag-20-24-h">0</td><td class="celda-activa" id="ecv-antiag-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-antiag-25-29-h">0</td><td class="celda-activa" id="ecv-antiag-25-29-m">0</td>
              <td class="celda-activa" id="ecv-antiag-30-34-h">0</td><td class="celda-activa" id="ecv-antiag-30-34-m">0</td>
              <td class="celda-activa" id="ecv-antiag-35-39-h">0</td><td class="celda-activa" id="ecv-antiag-35-39-m">0</td>
              <td class="celda-activa" id="ecv-antiag-40-44-h">0</td><td class="celda-activa" id="ecv-antiag-40-44-m">0</td>
              <td class="celda-activa" id="ecv-antiag-45-49-h">0</td><td class="celda-activa" id="ecv-antiag-45-49-m">0</td>
              <td class="celda-activa" id="ecv-antiag-50-54-h">0</td><td class="celda-activa" id="ecv-antiag-50-54-m">0</td>
              <td class="celda-activa" id="ecv-antiag-55-59-h">0</td><td class="celda-activa" id="ecv-antiag-55-59-m">0</td>
              <td class="celda-activa" id="ecv-antiag-60-64-h">0</td><td class="celda-activa" id="ecv-antiag-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-antiag-65-69-h">0</td><td class="celda-activa" id="ecv-antiag-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-antiag-70-74-h">0</td><td class="celda-activa" id="ecv-antiag-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-antiag-75-79-h">0</td><td class="celda-activa" id="ecv-antiag-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-antiag-80-mas-h">0</td><td class="celda-activa" id="ecv-antiag-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            <tr>
              <td class="concepto-col">En tratamiento con Estatina</td>
              <td class="celda-activa" id="ecv-estatina-total">0</td>
              <td class="celda-activa" id="ecv-estatina-h">0</td>
              <td class="celda-activa" id="ecv-estatina-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="ecv-estatina-15-19-h">0</td><td class="celda-activa" id="ecv-estatina-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="ecv-estatina-20-24-h">0</td><td class="celda-activa" id="ecv-estatina-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-estatina-25-29-h">0</td><td class="celda-activa" id="ecv-estatina-25-29-m">0</td>
              <td class="celda-activa" id="ecv-estatina-30-34-h">0</td><td class="celda-activa" id="ecv-estatina-30-34-m">0</td>
              <td class="celda-activa" id="ecv-estatina-35-39-h">0</td><td class="celda-activa" id="ecv-estatina-35-39-m">0</td>
              <td class="celda-activa" id="ecv-estatina-40-44-h">0</td><td class="celda-activa" id="ecv-estatina-40-44-m">0</td>
              <td class="celda-activa" id="ecv-estatina-45-49-h">0</td><td class="celda-activa" id="ecv-estatina-45-49-m">0</td>
              <td class="celda-activa" id="ecv-estatina-50-54-h">0</td><td class="celda-activa" id="ecv-estatina-50-54-m">0</td>
              <td class="celda-activa" id="ecv-estatina-55-59-h">0</td><td class="celda-activa" id="ecv-estatina-55-59-m">0</td>
              <td class="celda-activa" id="ecv-estatina-60-64-h">0</td><td class="celda-activa" id="ecv-estatina-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-estatina-65-69-h">0</td><td class="celda-activa" id="ecv-estatina-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-estatina-70-74-h">0</td><td class="celda-activa" id="ecv-estatina-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-estatina-75-79-h">0</td><td class="celda-activa" id="ecv-estatina-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-estatina-80-mas-h">0</td><td class="celda-activa" id="ecv-estatina-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            <tr>
              <td class="concepto-col">Fumador actual</td>
              <td class="celda-activa" id="ecv-fumador-total">0</td>
              <td class="celda-activa" id="ecv-fumador-h">0</td>
              <td class="celda-activa" id="ecv-fumador-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="ecv-fumador-15-19-h">0</td><td class="celda-activa" id="ecv-fumador-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="ecv-fumador-20-24-h">0</td><td class="celda-activa" id="ecv-fumador-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-fumador-25-29-h">0</td><td class="celda-activa" id="ecv-fumador-25-29-m">0</td>
              <td class="celda-activa" id="ecv-fumador-30-34-h">0</td><td class="celda-activa" id="ecv-fumador-30-34-m">0</td>
              <td class="celda-activa" id="ecv-fumador-35-39-h">0</td><td class="celda-activa" id="ecv-fumador-35-39-m">0</td>
              <td class="celda-activa" id="ecv-fumador-40-44-h">0</td><td class="celda-activa" id="ecv-fumador-40-44-m">0</td>
              <td class="celda-activa" id="ecv-fumador-45-49-h">0</td><td class="celda-activa" id="ecv-fumador-45-49-m">0</td>
              <td class="celda-activa" id="ecv-fumador-50-54-h">0</td><td class="celda-activa" id="ecv-fumador-50-54-m">0</td>
              <td class="celda-activa" id="ecv-fumador-55-59-h">0</td><td class="celda-activa" id="ecv-fumador-55-59-m">0</td>
              <td class="celda-activa" id="ecv-fumador-60-64-h">0</td><td class="celda-activa" id="ecv-fumador-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-fumador-65-69-h">0</td><td class="celda-activa" id="ecv-fumador-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-fumador-70-74-h">0</td><td class="celda-activa" id="ecv-fumador-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-fumador-75-79-h">0</td><td class="celda-activa" id="ecv-fumador-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="ecv-fumador-80-mas-h">0</td><td class="celda-activa" id="ecv-fumador-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>

            <!-- Personas bajo control con antecedentes de Infarto agudo al miocardio (IAM) -->
            <tr>
              <td class="concepto-col fw-bold bg-dark text-white" colspan="27">Personas bajo control con antecedentes de Infarto agudo al miocardio (IAM)</td>
            </tr>
            <tr>
              <td class="concepto-col">En tratamiento con Antiagregantes plaquetarios</td>
              <td class="celda-activa" id="iam-antiag-total">0</td>
              <td class="celda-activa" id="iam-antiag-h">0</td>
              <td class="celda-activa" id="iam-antiag-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="iam-antiag-15-19-h">0</td><td class="celda-activa" id="iam-antiag-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="iam-antiag-20-24-h">0</td><td class="celda-activa" id="iam-antiag-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-antiag-25-29-h">0</td><td class="celda-activa" id="iam-antiag-25-29-m">0</td>
              <td class="celda-activa" id="iam-antiag-30-34-h">0</td><td class="celda-activa" id="iam-antiag-30-34-m">0</td>
              <td class="celda-activa" id="iam-antiag-35-39-h">0</td><td class="celda-activa" id="iam-antiag-35-39-m">0</td>
              <td class="celda-activa" id="iam-antiag-40-44-h">0</td><td class="celda-activa" id="iam-antiag-40-44-m">0</td>
              <td class="celda-activa" id="iam-antiag-45-49-h">0</td><td class="celda-activa" id="iam-antiag-45-49-m">0</td>
              <td class="celda-activa" id="iam-antiag-50-54-h">0</td><td class="celda-activa" id="iam-antiag-50-54-m">0</td>
              <td class="celda-activa" id="iam-antiag-55-59-h">0</td><td class="celda-activa" id="iam-antiag-55-59-m">0</td>
              <td class="celda-activa" id="iam-antiag-60-64-h">0</td><td class="celda-activa" id="iam-antiag-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-antiag-65-69-h">0</td><td class="celda-activa" id="iam-antiag-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-antiag-70-74-h">0</td><td class="celda-activa" id="iam-antiag-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-antiag-75-79-h">0</td><td class="celda-activa" id="iam-antiag-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-antiag-80-mas-h">0</td><td class="celda-activa" id="iam-antiag-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            <tr>
              <td class="concepto-col">En tratamiento con Estatina</td>
              <td class="celda-activa" id="iam-estatina-total">0</td>
              <td class="celda-activa" id="iam-estatina-h">0</td>
              <td class="celda-activa" id="iam-estatina-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="iam-estatina-15-19-h">0</td><td class="celda-activa" id="iam-estatina-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="iam-estatina-20-24-h">0</td><td class="celda-activa" id="iam-estatina-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-estatina-25-29-h">0</td><td class="celda-activa" id="iam-estatina-25-29-m">0</td>
              <td class="celda-activa" id="iam-estatina-30-34-h">0</td><td class="celda-activa" id="iam-estatina-30-34-m">0</td>
              <td class="celda-activa" id="iam-estatina-35-39-h">0</td><td class="celda-activa" id="iam-estatina-35-39-m">0</td>
              <td class="celda-activa" id="iam-estatina-40-44-h">0</td><td class="celda-activa" id="iam-estatina-40-44-m">0</td>
              <td class="celda-activa" id="iam-estatina-45-49-h">0</td><td class="celda-activa" id="iam-estatina-45-49-m">0</td>
              <td class="celda-activa" id="iam-estatina-50-54-h">0</td><td class="celda-activa" id="iam-estatina-50-54-m">0</td>
              <td class="celda-activa" id="iam-estatina-55-59-h">0</td><td class="celda-activa" id="iam-estatina-55-59-m">0</td>
              <td class="celda-activa" id="iam-estatina-60-64-h">0</td><td class="celda-activa" id="iam-estatina-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-estatina-65-69-h">0</td><td class="celda-activa" id="iam-estatina-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-estatina-70-74-h">0</td><td class="celda-activa" id="iam-estatina-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-estatina-75-79-h">0</td><td class="celda-activa" id="iam-estatina-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-estatina-80-mas-h">0</td><td class="celda-activa" id="iam-estatina-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            <tr>
              <td class="concepto-col">Fumador actual</td>
              <td class="celda-activa" id="iam-fumador-total">0</td>
              <td class="celda-activa" id="iam-fumador-h">0</td>
              <td class="celda-activa" id="iam-fumador-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="iam-fumador-15-19-h">0</td><td class="celda-activa" id="iam-fumador-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="iam-fumador-20-24-h">0</td><td class="celda-activa" id="iam-fumador-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-fumador-25-29-h">0</td><td class="celda-activa" id="iam-fumador-25-29-m">0</td>
              <td class="celda-activa" id="iam-fumador-30-34-h">0</td><td class="celda-activa" id="iam-fumador-30-34-m">0</td>
              <td class="celda-activa" id="iam-fumador-35-39-h">0</td><td class="celda-activa" id="iam-fumador-35-39-m">0</td>
              <td class="celda-activa" id="iam-fumador-40-44-h">0</td><td class="celda-activa" id="iam-fumador-40-44-m">0</td>
              <td class="celda-activa" id="iam-fumador-45-49-h">0</td><td class="celda-activa" id="iam-fumador-45-49-m">0</td>
              <td class="celda-activa" id="iam-fumador-50-54-h">0</td><td class="celda-activa" id="iam-fumador-50-54-m">0</td>
              <td class="celda-activa" id="iam-fumador-55-59-h">0</td><td class="celda-activa" id="iam-fumador-55-59-m">0</td>
              <td class="celda-activa" id="iam-fumador-60-64-h">0</td><td class="celda-activa" id="iam-fumador-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-fumador-65-69-h">0</td><td class="celda-activa" id="iam-fumador-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-fumador-70-74-h">0</td><td class="celda-activa" id="iam-fumador-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-fumador-75-79-h">0</td><td class="celda-activa" id="iam-fumador-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="iam-fumador-80-mas-h">0</td><td class="celda-activa" id="iam-fumador-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>

            <!-- Personas bajo control con Antecedentes de Ataque Cerebrovascular (ACV) -->
            <tr>
              <td class="concepto-col fw-bold bg-success text-white" colspan="27">Personas bajo control con Antecedentes de Ataque Cerebrovascular (ACV)</td>
            </tr>
            <tr>
              <td class="concepto-col">En tratamiento con Antiagregantes plaquetarios</td>
              <td class="celda-activa" id="acv-antiag-total">0</td>
              <td class="celda-activa" id="acv-antiag-h">0</td>
              <td class="celda-activa" id="acv-antiag-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="acv-antiag-15-19-h">0</td><td class="celda-activa" id="acv-antiag-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="acv-antiag-20-24-h">0</td><td class="celda-activa" id="acv-antiag-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-antiag-25-29-h">0</td><td class="celda-activa" id="acv-antiag-25-29-m">0</td>
              <td class="celda-activa" id="acv-antiag-30-34-h">0</td><td class="celda-activa" id="acv-antiag-30-34-m">0</td>
              <td class="celda-activa" id="acv-antiag-35-39-h">0</td><td class="celda-activa" id="acv-antiag-35-39-m">0</td>
              <td class="celda-activa" id="acv-antiag-40-44-h">0</td><td class="celda-activa" id="acv-antiag-40-44-m">0</td>
              <td class="celda-activa" id="acv-antiag-45-49-h">0</td><td class="celda-activa" id="acv-antiag-45-49-m">0</td>
              <td class="celda-activa" id="acv-antiag-50-54-h">0</td><td class="celda-activa" id="acv-antiag-50-54-m">0</td>
              <td class="celda-activa" id="acv-antiag-55-59-h">0</td><td class="celda-activa" id="acv-antiag-55-59-m">0</td>
              <td class="celda-activa" id="acv-antiag-60-64-h">0</td><td class="celda-activa" id="acv-antiag-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-antiag-65-69-h">0</td><td class="celda-activa" id="acv-antiag-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-antiag-70-74-h">0</td><td class="celda-activa" id="acv-antiag-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-antiag-75-79-h">0</td><td class="celda-activa" id="acv-antiag-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-antiag-80-mas-h">0</td><td class="celda-activa" id="acv-antiag-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            <tr>
              <td class="concepto-col">En tratamiento con Estatina</td>
              <td class="celda-activa" id="acv-estatina-total">0</td>
              <td class="celda-activa" id="acv-estatina-h">0</td>
              <td class="celda-activa" id="acv-estatina-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="acv-estatina-15-19-h">0</td><td class="celda-activa" id="acv-estatina-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="acv-estatina-20-24-h">0</td><td class="celda-activa" id="acv-estatina-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-estatina-25-29-h">0</td><td class="celda-activa" id="acv-estatina-25-29-m">0</td>
              <td class="celda-activa" id="acv-estatina-30-34-h">0</td><td class="celda-activa" id="acv-estatina-30-34-m">0</td>
              <td class="celda-activa" id="acv-estatina-35-39-h">0</td><td class="celda-activa" id="acv-estatina-35-39-m">0</td>
              <td class="celda-activa" id="acv-estatina-40-44-h">0</td><td class="celda-activa" id="acv-estatina-40-44-m">0</td>
              <td class="celda-activa" id="acv-estatina-45-49-h">0</td><td class="celda-activa" id="acv-estatina-45-49-m">0</td>
              <td class="celda-activa" id="acv-estatina-50-54-h">0</td><td class="celda-activa" id="acv-estatina-50-54-m">0</td>
              <td class="celda-activa" id="acv-estatina-55-59-h">0</td><td class="celda-activa" id="acv-estatina-55-59-m">0</td>
              <td class="celda-activa" id="acv-estatina-60-64-h">0</td><td class="celda-activa" id="acv-estatina-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-estatina-65-69-h">0</td><td class="celda-activa" id="acv-estatina-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-estatina-70-74-h">0</td><td class="celda-activa" id="acv-estatina-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-estatina-75-79-h">0</td><td class="celda-activa" id="acv-estatina-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-estatina-80-mas-h">0</td><td class="celda-activa" id="acv-estatina-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
            <tr>
              <td class="concepto-col">Fumador actual</td>
              <td class="celda-activa" id="acv-fumador-total">0</td>
              <td class="celda-activa" id="acv-fumador-h">0</td>
              <td class="celda-activa" id="acv-fumador-m">0</td>
              <!-- 15-19 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="acv-fumador-15-19-h">0</td><td class="celda-activa" id="acv-fumador-15-19-m">0</td>
              <!-- 20-24 a√±os: ACTIVAS (ajuste) -->
              <td class="celda-activa" id="acv-fumador-20-24-h">0</td><td class="celda-activa" id="acv-fumador-20-24-m">0</td>
              <!-- 25-29 a 60-64 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-fumador-25-29-h">0</td><td class="celda-activa" id="acv-fumador-25-29-m">0</td>
              <td class="celda-activa" id="acv-fumador-30-34-h">0</td><td class="celda-activa" id="acv-fumador-30-34-m">0</td>
              <td class="celda-activa" id="acv-fumador-35-39-h">0</td><td class="celda-activa" id="acv-fumador-35-39-m">0</td>
              <td class="celda-activa" id="acv-fumador-40-44-h">0</td><td class="celda-activa" id="acv-fumador-40-44-m">0</td>
              <td class="celda-activa" id="acv-fumador-45-49-h">0</td><td class="celda-activa" id="acv-fumador-45-49-m">0</td>
              <td class="celda-activa" id="acv-fumador-50-54-h">0</td><td class="celda-activa" id="acv-fumador-50-54-m">0</td>
              <td class="celda-activa" id="acv-fumador-55-59-h">0</td><td class="celda-activa" id="acv-fumador-55-59-m">0</td>
              <td class="celda-activa" id="acv-fumador-60-64-h">0</td><td class="celda-activa" id="acv-fumador-60-64-m">0</td>
              <!-- 65-69 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-fumador-65-69-h">0</td><td class="celda-activa" id="acv-fumador-65-69-m">0</td>
              <!-- 70-74 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-fumador-70-74-h">0</td><td class="celda-activa" id="acv-fumador-70-74-m">0</td>
              <!-- 75-79 a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-fumador-75-79-h">0</td><td class="celda-activa" id="acv-fumador-75-79-m">0</td>
              <!-- 80+ a√±os: ACTIVAS -->
              <td class="celda-activa" id="acv-fumador-80-mas-h">0</td><td class="celda-activa" id="acv-fumador-80-mas-m">0</td>
              <!-- Pueblos Originarios -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
              <!-- Migrantes -->
              <td class="celda-bloqueada">0</td><td class="celda-bloqueada">0</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div id="metas-status" class="small text-muted mt-2"></div>
    </div>
  </div>

  <!-- VARIABLES DE SEGUIMIENTO PSCV AL CORTE -->
  <div class="card mb-4" id="pscv-variables-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Variables de seguimiento PSCV al corte</h5>
      </div>
      <details class="small bg-light border rounded p-3 mt-3">
        <summary class="fw-semibold" style="cursor:pointer">Ver definiciones operacionales (REM 2025)</summary>
        <p class="mb-1"><strong>Personas con diabetes en PSCV</strong></p>
        <ul class="mb-2 ps-3">
          <li><code>RAC vigente</code>: razon albumina/creatinina tomada en los ultimos 12 meses.</li>
          <li><code>VFG vigente</code>: velocidad de filtracion glomerular estimada registrada en los ultimos 12 meses.</li>
          <li><code>RAC + VFG vigente</code>: ambas mediciones con vigencia de 12 meses.</li>
          <li><code>Fondo de ojo vigente</code>: examen oftalmologico dentro del ultimo ano.</li>
          <li><code>Atencion podologica vigente</code>: control podologico efectuado en el ultimo ano.</li>
          <li><code>ECG vigente</code>: electrocardiograma dentro de los ultimos 12 meses.</li>
          <li><code>En tratamiento con insulina</code>: personas que usan insulina como regimen habitual.</li>
          <li><code>Insulina con meta HbA1c</code>: tratamiento con insulina que logra la meta segun edad.</li>
          <li><code>HbA1c &ge; 9 %</code>: ultimo control con descompensacion severa.</li>
          <li><code>Fumador actual</code>: consumo activo (diario u ocasional) segun OMS.</li>
          <li><code>ERC con IECA/ARA II</code>: enfermedad renal cronica en cualquier etapa con tratamiento IECA o ARA II.</li>
          <li><code>LDL vigente</code>: examen de colesterol LDL realizado en los ultimos 12 meses.</li>
          <li><code>Hipoglicemias recurrentes</code>: dos o mas eventos en tres meses.</li>
          <li><code>Evaluacion de pie</code>: clasificacion vigente de riesgo (bajo, moderado, alto o maximo).</li>
          <li><code>Ulceras activas</code>: tratadas con curacion convencional, avanzada o ayuda de descarga.</li>
          <li><code>Amputacion pie diabetico</code>: antecedente vigente.</li>
          <li><code>Diagnostico asociado de hipertension arterial</code>: registro activo.</li>
          <li><code>Diagnostico de enfermedad renal cronica</code>: registro activo.</li>
          <li><code>Antecedente de ACV</code>: registro clinico validado.</li>
          <li><code>Antecedente de IAM</code>: registro clinico validado.</li>
          <li><code>Retinopatia diabetica</code>: diagnostico oftalmologico confirmado.</li>
        </ul>
        <p class="mb-1"><strong>Personas con hipertension en PSCV</strong></p>
        <ul class="mb-2 ps-3">
          <li><code>RAC vigente</code>, <code>VFG vigente</code> y <code>RAC + VFG</code>: misma definicion de vigencia de 12 meses.</li>
          <li><code>PA &ge; 160/100 mmHg</code>: ultimo control igual o mayor al umbral.</li>
          <li><code>Diagnostico de ERC</code>: enfermedad renal cronica confirmada.</li>
          <li><code>Protocolo Hearts</code>: personas incorporadas en estrategia Hearts.</li>
        </ul>
        <p class="mb-1"><strong>Todas las personas en PSCV</strong></p>
        <ul class="mb-0 ps-3">
          <li><code>Sobrepeso / Obesidad</code>: IMC 25-29.9 y &ge;30 kg/m2 para menores de 65; IMC 28-31.9 y &ge;32 kg/m2 para 65 o mas.</li>
          <li><code>Actividad fisica salud CV</code>: participa en intervenciones certificadas por el equipo de salud.</li>
          <li><code>Fumador actual</code>: consumo activo de tabaco.</li>
          <li><code>ERC por etapas</code>: clasificacion G1-G5, sin ERC o desconoce segun ultima VFG/RAC.</li>
        </ul>
        <p class="mb-0 mt-2">Notas: todos los ex√°menes se consideran vigentes si fueron realizados dentro de los 12 meses previos al corte. Los registros deben estar documentados en ficha cl√≠nica o sistema validado.</p>
      </details>
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-pscv-variables" data-export-name="Variables de seguimiento PSCV al corte">
          <thead id="pscv-variables-head">
            <tr>
              <th>VARIABLES</th>
              <th>Total</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="pscv-variables-body"></tbody>
        </table>
      </div>
      <div id="pscv-variables-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- NUEVA SECCI√ìN: EVALUACI√ìN DE DIABETES EN PSCV (MANUAL REM-P 2025) -->
  <div class="card mb-4" id="diabetes-evaluacion-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">EVALUACI√ìN DE DIABETES EN PSCV (MANUAL REM-P 2025)</h5>
        <small class="text-muted">Evaluaci√≥n integral de personas con diabetes seg√∫n normativa vigente</small>
      </div>
      <div class="row mt-3">
        <!-- Panel de resumen general -->
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6 class="card-title text-primary">Total Diabetes PSCV</h6>
              <h3 class="text-primary mb-0" id="diabetes-total">0</h3>
            </div>
          </div>
        </div>
        <!-- Panel de m√©tricas principales -->
        <div class="col-md-9">
          <div class="row">
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-success">
                <div class="card-body text-center p-2">
                  <small class="text-success">Meta HbA1c por edad</small>
                  <h5 class="text-success mb-0" id="diabetes-meta-hba1c">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-warning">
                <div class="card-body text-center p-2">
                  <small class="text-warning">HbA1c ‚â• 9%</small>
                  <h5 class="text-warning mb-0" id="diabetes-hba1c-alto">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-info">
                <div class="card-body text-center p-2">
                  <small class="text-info">Atenci√≥n Podol√≥gica</small>
                  <h5 class="text-info mb-0" id="diabetes-podologia">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-danger">
                <div class="card-body text-center p-2">
                  <small class="text-danger">Hipoglicemias</small>
                  <h5 class="text-danger mb-0" id="diabetes-hipoglicemias">0</h5>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabla detallada de m√©tricas -->
      <div class="table-responsive mt-4">
        <table class="table table-sm table-striped table-bordered align-middle" id="tabla-diabetes-evaluacion" data-export-name="Diabetes - Evaluaci√≥n REM-P 2025">
          <thead class="table-dark">
            <tr>
              <th style="min-width: 300px;">M√âTRICA DE EVALUACI√ìN</th>
              <th style="min-width: 100px;">TOTAL</th>
              <th style="min-width: 120px;">% DEL TOTAL</th>
              <th style="min-width: 150px;">DESCRIPCI√ìN</th>
            </tr>
          </thead>
          <tbody id="diabetes-evaluacion-body">
            <!-- Ser√° llenado din√°micamente por JavaScript -->
          </tbody>
        </table>
      </div>
      <div id="diabetes-evaluacion-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- NUEVA SECCI√ìN: EVALUACI√ìN DE HIPERTENSI√ìN EN PSCV (MANUAL REM-P 2025) -->
  <div class="card mb-4" id="hipertension-evaluacion-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">EVALUACI√ìN DE HIPERTENSI√ìN EN PSCV (MANUAL REM-P 2025)</h5>
        <small class="text-muted">Evaluaci√≥n integral de personas con hipertensi√≥n seg√∫n normativa vigente</small>
      </div>
      <div class="row mt-3">
        <!-- Panel de resumen general -->
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6 class="card-title text-danger">Total Hipertensi√≥n PSCV</h6>
              <h3 class="text-danger mb-0" id="hipertension-total">0</h3>
            </div>
          </div>
        </div>
        <!-- Panel de m√©tricas principales -->
        <div class="col-md-9">
          <div class="row">
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-warning">
                <div class="card-body text-center p-2">
                  <small class="text-warning">PA ‚â• 160/100</small>
                  <h5 class="text-warning mb-0" id="hipertension-pa-alta">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-info">
                <div class="card-body text-center p-2">
                  <small class="text-info">Protocolo HEARTS</small>
                  <h5 class="text-info mb-0" id="hipertension-hearts">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-success">
                <div class="card-body text-center p-2">
                  <small class="text-success">RAC Vigente</small>
                  <h5 class="text-success mb-0" id="hipertension-rac">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-secondary">
                <div class="card-body text-center p-2">
                  <small class="text-secondary">VFG Vigente</small>
                  <h5 class="text-secondary mb-0" id="hipertension-vfg">0</h5>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabla detallada de m√©tricas -->
      <div class="table-responsive mt-4">
        <table class="table table-sm table-striped table-bordered align-middle" id="tabla-hipertension-evaluacion" data-export-name="Hipertensi√≥n - Evaluaci√≥n REM-P 2025">
          <thead class="table-dark">
            <tr>
              <th style="min-width: 300px;">M√âTRICA DE EVALUACI√ìN</th>
              <th style="min-width: 100px;">TOTAL</th>
              <th style="min-width: 120px;">% DEL TOTAL</th>
              <th style="min-width: 150px;">DESCRIPCI√ìN</th>
            </tr>
          </thead>
          <tbody id="hipertension-evaluacion-body">
            <!-- Ser√° llenado din√°micamente por JavaScript -->
          </tbody>
        </table>
      </div>
      <div id="hipertension-evaluacion-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- NUEVA SECCI√ìN: TODAS LAS PERSONAS EN PSCV (MANUAL REM-P 2025) -->
  <div class="card mb-4" id="todas-personas-pscv-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">TODAS LAS PERSONAS EN PSCV (MANUAL REM-P 2025)</h5>
        <small class="text-muted">Poblaci√≥n completa en programa salud cardiovascular</small>
      </div>
      <div class="row mt-3">
        <!-- Panel de resumen general -->
        <div class="col-md-3">
          <div class="card bg-light">
            <div class="card-body text-center">
              <h6 class="card-title text-primary">Total Personas PSCV</h6>
              <h3 class="text-primary mb-0" id="todas-pscv-total">0</h3>
            </div>
          </div>
        </div>
        <!-- Panel de m√©tricas principales -->
        <div class="col-md-9">
          <div class="row">
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-warning">
                <div class="card-body text-center p-2">
                  <small class="text-warning">Sobrepeso/Obesidad</small>
                  <h5 class="text-warning mb-0" id="todas-pscv-sobrepeso-obesidad">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-success">
                <div class="card-body text-center p-2">
                  <small class="text-success">Actividad F√≠sica</small>
                  <h5 class="text-success mb-0" id="todas-pscv-actividad">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-danger">
                <div class="card-body text-center p-2">
                  <small class="text-danger">Fumador Actual</small>
                  <h5 class="text-danger mb-0" id="todas-pscv-fumador">0</h5>
                </div>
              </div>
            </div>
            <div class="col-sm-6 col-md-3 mb-3">
              <div class="card border-info">
                <div class="card-body text-center p-2">
                  <small class="text-info">Con ERC</small>
                  <h5 class="text-info mb-0" id="todas-pscv-erc">0</h5>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabla detallada de m√©tricas -->
      <div class="table-responsive mt-4">
        <table class="table table-sm table-striped table-bordered align-middle" id="tabla-todas-personas-pscv" data-export-name="Todas Personas PSCV - REM-P 2025">
          <thead class="table-dark">
            <tr>
              <th style="min-width: 300px;">M√âTRICA DE EVALUACI√ìN</th>
              <th style="min-width: 100px;">TOTAL</th>
              <th style="min-width: 120px;">% DEL TOTAL</th>
              <th style="min-width: 150px;">DESCRIPCI√ìN</th>
            </tr>
          </thead>
          <tbody id="todas-personas-pscv-body">
            <!-- Ser√° llenado din√°micamente por JavaScript -->
          </tbody>
        </table>
      </div>
      <div id="todas-personas-pscv-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- SECCI√ìN A: POBLACI√ìN EN CONTROL POR CONDICI√ìN DE FUNCIONALIDAD (>=65 a√±os) -->
  <div class="card mb-4" id="p5-funcionalidad-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCI√ìN A: POBLACI√ìN EN CONTROL POR CONDICI√ìN DE FUNCIONALIDAD</h5>
      </div>
      <style>
        /* Sombreado visual similar a la l√°mina: 60‚Äì64 gris, 65+ amarillo p√°lido */
        #tabla-p5-funcionalidad th.band-60-64,
        #tabla-p5-funcionalidad td.band-60-64 { background-color: #eef1f4; }
        #tabla-p5-funcionalidad th.band-65plus,
        #tabla-p5-funcionalidad td.band-65plus { background-color: #fff9db; }
      </style>
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-p5-funcionalidad" data-export-name="P5 - Funcionalidad">
          <thead id="p5-head">
            <tr>
              <th>Funcionalidad</th>
              <th>Total</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="p5-body"></tbody>
        </table>
      </div>
      <div id="p5-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- SECCI√ìN A.1: EXISTENCIA DE POBLACI√ìN EN CONTROL EN PROGRAMA "M√ÅS ADULTOS MAYORES AUTOVALENTES" POR CONDICI√ìN DE FUNCIONALIDAD -->
  <div class="card mb-4" id="p5-funcionalidad-a1-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCI√ìN A.1: EXISTENCIA DE POBLACI√ìN EN CONTROL EN PROGRAMA "M√ÅS ADULTOS MAYORES AUTOVALENTES" POR CONDICI√ìN DE FUNCIONALIDAD</h5>
      </div>
      <style>
        /* Sombreado A.1: 60‚Äì64 gris, 65+ amarillo */
        #tabla-p5-funcionalidad-a1 th.band-60-64,
        #tabla-p5-funcionalidad-a1 td.band-60-64 { background-color: #eef1f4; }
        #tabla-p5-funcionalidad-a1 th.band-65plus,
        #tabla-p5-funcionalidad-a1 td.band-65plus { background-color: #fff9db; }
      </style>
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-p5-funcionalidad-a1" data-export-name="P5 - Funcionalidad A.1">
          <thead id="p5a1-head">
            <tr>
              <th>Funcionalidad A.1</th>
              <th>Total</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="p5a1-body"></tbody>
        </table>
      </div>
      <div id="p5a1-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- P5 SECCI√ìN B: POBLACI√ìN BAJO CONTROL POR ESTADO NUTRICIONAL -->
  <div class="card mb-4" id="p5-estado-nutricional-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCI√ìN B: POBLACI√ìN BAJO CONTROL POR ESTADO NUTRICIONAL</h5>
      </div>
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-p5-estado-nutricional" data-export-name="P5 - Estado nutricional">
          <thead id="p5b-head">
            <tr>
              <th>Estado Nutricional</th>
              <th>Total</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="p5b-body"></tbody>
        </table>
      </div>
      <div id="p5b-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- SECCION C: PERSONAS MAYORES CON SOSPECHA DE MALTRATO -->
  <div class="card mb-4" id="p5-maltrato-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCION C: PERSONAS MAYORES CON SOSPECHA DE MALTRATO</h5>
      </div>
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-p5-maltrato" data-export-name="P5 - Sospecha de maltrato">
          <thead id="p5c-head">
            <tr>
              <th>Maltrato</th>
              <th>Total</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="p5c-body"></tbody>
        </table>
      </div>
      <div id="p5c-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- SECCION D: PERSONAS MAYORES EN ACTIVIDAD F√çSICA -->
  <div class="card mb-4" id="p5-actividad-fisica-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCION D: PERSONAS MAYORES EN ACTIVIDAD F√çSICA</h5>
      </div>
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-p5-actividad-fisica" data-export-name="P5 - Actividad f√≠sica">
          <thead id="p5d-head">
            <tr>
              <th>Actividad F√≠sica</th>
              <th>Total</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="p5d-body"></tbody>
        </table>
      </div>
      <div id="p5d-status" class="small text-muted"></div>
    </div>
  </div>

  <!-- SECCION E: PERSONAS MAYORES CON RIESGO DE CA√çDAS -->
  <div class="card mb-4" id="p5-caidas-card">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">SECCION E: PERSONAS MAYORES CON RIESGO DE CA√çDAS</h5>
      </div>
      <div class="table-responsive table-sticky-wrap mt-3" style="overflow-x:auto;">
        <table class="table table-sm table-striped table-bordered align-middle table-sticky" id="tabla-p5-caidas" data-export-name="P5 - Riesgo de ca√≠das">
          <thead id="p5e-head">
            <tr>
              <th>Riesgo de Ca√≠das</th>
              <th>Total</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="p5e-body"></tbody>
        </table>
      </div>
      <div id="p5e-status" class="small text-muted"></div>
    </div>
  </div>

  

</div>

<!-- SheetJS para exportar a Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// Bandas etarias por defecto para PSCV (fallback si el backend no entrega)
const BANDAS_PSCV_DEFAULT = [
  '15-19','20-24','25-29','30-34','35-39','40-44','45-49',
  '50-54','55-59','60-64','65-69','70-74','75-79','80+'
];

// Preset de Variables PSCV (para mostrar filas en 0 si el backend no entrega datos)
const PSCV_PRESET = {
  'PERSONAS CON DIABETES EN PSCV': [
    'Con raz√≥n alb√∫mina creatinina (RAC), vigente',
    'Con velocidad de filtraci√≥n glomerular estimada (VFG), vigente',
    'Con velocidad de filtraci√≥n glomerular estimada (VFGE) y con raz√≥n alb√∫mina creatinina (RAC) vigente',
    'Con fondo de ojo, vigente',
    'Con atenci√≥n podol√≥gica vigente',
    'Con ECG vigente',
    'En tratamiento con insulina',
    'En tratamiento con insulina que logra meta con HBA1C seg√∫n edad',
    'Con HBA1C >= 9 %',
    'En tratamiento con Antiagregantes plaquetarios',
    'En tratamiento con Estatina',
    'Fumador actual',
    'Con ERC (todas las etapas) y en tratamiento con IECA o ARA II',
    'Con un examen de colesterol LDL vigente',
    'Con hipoglicemias recurrentes',
    'Riesgo bajo','Riesgo moderado','Riesgo alto','Riesgo m√°ximo',
    'Curaci√≥n Convencional','Curaci√≥n Avanzada','Con ayuda t√©cnica de descarga',
    'Con amputaci√≥n por pie diab√©tico',
    'Con diagn√≥stico asociado de hipertensi√≥n arterial',
    'Con diagn√≥stico de enfermedad renal cr√≥nica',
    'Antecedente de ataque cerebro vascular',
    'Antecedentes de infarto agudo al miocardio',
    'Retinopat√≠a diab√©tica'
  ],
  'PERSONAS CON HIPERTENSION EN PSCV': [
    'Con raz√≥n alb√∫mina creatinina (RAC), vigente',
    'Con velocidad de filtraci√≥n glomerular estimada (VFGE) vigente',
    'Con velocidad de filtraci√≥n glomerular estimada (VFGE) y con raz√≥n alb√∫mina creatinina (RAC) vigente',
    'Con presi√≥n arterial igual o mayor 160/100 MMHG',
    'Con diagn√≥stico de enfermedad renal cr√≥nica',
    'Protocolo Hearts',
    'En tratamiento con Antiagregantes plaquetarios',
    'En tratamiento con Estatina'
  ],
  'TODAS LAS PERSONAS EN PSCV': [
    'Sobrepeso: IMC entre 25 y 29.9 <65 a√±os',
    'Sobrepeso: IMC entre 28 y 31.9 >65 a√±os',
    'Obesidad: IMC igual o Mayor a 30KG/M2 <65 a√±os',
    'Obesidad: IMC igual o Mayor a 32KG/M2 >65 a√±os',
    'Personas en actividad f√≠sica salud cardiovascular',
    'Fumador actual',
    'Sin enfermedad renal (S/ERC)', 'Etapa  G1','Etapa G2','Etapa G3a','Etapa G3b','Etapa G4','Etapa G5',
    'Desconoce si tiene ERC','Enfermedad Renal Cr√≥nica (ERC) - TOTAL'
  ]
};

// Bandas por defecto Adulto Mayor (P5) reutilizables en todas las secciones P5
const P5_BANDAS_DEFAULT = [
  '65 a 69 a√±os','70 a 74 a√±os','75 a 79 a√±os','80 a 84 a√±os',
  '85 a 89 a√±os','90 a 94 a√±os','95 a 99 a√±os','100 y m√°s a√±os'
];

// Helper: muestra etiquetas de bandas en formato oficial sin alterar las claves de datos
function p5DisplayBandLabel(b){
  if(!b) return '';
  // Normalizar variantes conocidas (backend suele entregar '65-69' ... '100+')
  if(b === '100+' || b === '100 y mas' || b === '100 y mas a√±os') return '100 y m√°s a√±os';
  const m = /^\s*(\d{2})\s*-\s*(\d{2})\s*$/.exec(b);
  if(m){ return `${m[1]} a ${m[2]} a√±os`; }
  return b; // ya viene en formato esperado
}

// Configurar eventos de filtros
document.addEventListener('DOMContentLoaded', function() {
  // Inicializar panel de par√°metros REM‚ÄëP (avanzado)
  initRemParamsUI();
  
  // Configurar event listeners para los botones de filtro de poblaci√≥n
  const filtrosPoblacion = document.querySelectorAll('input[name="poblacion-filter"]');
  filtrosPoblacion.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.checked) {
        // Recargar todas las estad√≠sticas con el nuevo filtro
        cargarPscvMetas();
        cargarDiabetesEvaluacion();
        cargarHipertensionEvaluacion();
        cargarTodasPersonasPscv();
      }
    });
  });
  
  // Reaplicar filtros al cambiar sector
  const selSectores = document.getElementById('sectores_select');
  if (selSectores) {
    selSectores.addEventListener('change', () => {
      const btn = document.getElementById('btn-aplicar-filtros');
      if (btn) btn.click();
    });
  }
  
  // Reaplicar filtros al cambiar sexo
  const selSexo = document.getElementById('sexo_select');
  if (selSexo) {
    selSexo.addEventListener('change', () => {
      const btn = document.getElementById('btn-aplicar-filtros');
      if (btn) btn.click();
    });
  }
  
  // Reaplicar filtros al cambiar fecha de inicio
  const fechaDesde = document.getElementById('fecha_desde');
  if (fechaDesde) {
    fechaDesde.addEventListener('change', () => {
      const btn = document.getElementById('btn-aplicar-filtros');
      if (btn) btn.click();
    });
  }
  
  // Reaplicar filtros al cambiar fecha de fin
  const fechaHasta = document.getElementById('fecha_hasta');
  if (fechaHasta) {
    fechaHasta.addEventListener('change', () => {
      const btn = document.getElementById('btn-aplicar-filtros');
      if (btn) btn.click();
    });
  }
  
  // Conectar bot√≥n de aplicar filtros de fecha
  const btnAplicar = document.getElementById('btn-aplicar-filtros');
  if(btnAplicar){
    btnAplicar.addEventListener('click', () => {
      actualizarBadgeFiltros();
      cargarREMP2025SeccionA();
      setTimeout(() => cargarREMP2025SeccionB(), 200);
      cargarPscvMetas();
      cargarDiabetesEvaluacion();
      cargarHipertensionEvaluacion();
      cargarTodasPersonasPscv();
      cargarP5SeccionA();
      cargarP5SeccionA1();
      cargarP5SeccionBEstadoNutricional();
      cargarP5SeccionCMaltrato();
      cargarP5SeccionDActividadFisica();
      cargarP5SeccionERiesgoCaidas();
      cargarSeccionAMatriz();
      cargarSeccionCVariables();
    });
  }
  const btnExtraer = document.getElementById('btn-extraer-datos');
  // (migrado abajo donde se centraliza l√≥gica de botones)
  function actualizarBadgeFiltros(){
    const badge = document.getElementById('filtros-activos-badge');
    if(!badge) return;
    const partes = [];
    const desde = document.getElementById('fecha_desde')?.value || '';
    const hasta = document.getElementById('fecha_hasta')?.value || '';
    const sectorSel = document.getElementById('sectores_select');
    const sexoSel = document.getElementById('sexo_select');

    if(desde) partes.push(`Desde ${desde}`);
    if(hasta) partes.push(`Hasta ${hasta}`);
    if(sectorSel && sectorSel.value){
      const texto = sectorSel.options?.[sectorSel.selectedIndex]?.text || sectorSel.value;
      partes.push(`Sector ${texto}`.trim());
    }
    if(sexoSel && sexoSel.value){
      const texto = sexoSel.options?.[sexoSel.selectedIndex]?.text || sexoSel.value;
      partes.push(`Sexo ${texto}`.trim());
    }

    badge.textContent = partes.length ? partes.join(' ¬∑ ') : 'Sin filtros activos';
  }
  const btnLimpiar = document.getElementById('btn-limpiar');
  if (btnLimpiar){
    btnLimpiar.addEventListener('click', () => {
      const f1 = document.getElementById('fecha_desde');
      const f2 = document.getElementById('fecha_hasta');
      const sectores = document.getElementById('sectores_select');
      const sexo = document.getElementById('sexo_select');
      
      if (f1) f1.value = '';
      if (f2) f2.value = '';
      if (sectores) sectores.value = '';
      if (sexo) sexo.value = '';
      
      // Recarga con filtros vac√≠os
      cargarREMP2025SeccionA();
      setTimeout(() => cargarREMP2025SeccionB(), 200);
      cargarPscvMetas();
      cargarDiabetesEvaluacion();
      cargarHipertensionEvaluacion();
      cargarTodasPersonasPscv();
      cargarP5SeccionA();
      cargarP5SeccionA1();
      cargarP5SeccionBEstadoNutricional();
      cargarP5SeccionCMaltrato();
      cargarP5SeccionDActividadFisica();
      cargarP5SeccionERiesgoCaidas();
      cargarSeccionAMatriz();
      cargarSeccionCVariables();
    });
  }
  const btnExcel = document.getElementById('btn-exportar-excel');
  if (btnExcel){
    btnExcel.addEventListener('click', async () => {
      try{
        const wb = XLSX.utils.book_new();
        // Agregar hoja de metadatos con filtros aplicados y par√°metros REM‚ÄëP
        addHojaFiltrosAplicados(wb);
        // Exportar TODAS las tablas presentes en la p√°gina, cada una como hoja separada
        exportarTodasLasTablasAExcel(wb);
        const hoy = new Date();
        const y = hoy.getFullYear(); const m = String(hoy.getMonth()+1).padStart(2,'0'); const d = String(hoy.getDate()).padStart(2,'0');
        const nombre = `estadisticas_pscv_${y}-${m}-${d}.xlsx`;
        XLSX.writeFile(wb, nombre);
      }catch(e){
        console.error('Exportaci√≥n Excel fall√≥', e);
        alert('No se pudo exportar a Excel');
      }
    });
  }
  // Cargar SECCI√ìN B (Metas)
  // Cargar NUEVA SECCI√ìN: EVALUACI√ìN DE DIABETES
  cargarDiabetesEvaluacion();
  // Cargar NUEVA SECCI√ìN: EVALUACI√ìN DE HIPERTENSI√ìN
  cargarHipertensionEvaluacion();
  // Cargar NUEVA SECCI√ìN: TODAS LAS PERSONAS EN PSCV
  cargarTodasPersonasPscv();
  // P5 SECCI√ìN A (Funcionalidad) - tabla est√°tica inicial (valores 0)
  cargarP5SeccionA();
  // P5 SECCI√ìN A.1 (Funcionalidad MAM) - tabla est√°tica inicial (valores 0)
  cargarP5SeccionA1();
  // P5 SECCI√ìN B (Estado Nutricional) - tabla est√°tica inicial (valores 0)
  cargarP5SeccionBEstadoNutricional();
  // Secci√≥n C (Sospecha de maltrato) - tabla est√°tica inicial (valores 0)
  cargarP5SeccionCMaltrato();
  // Secci√≥n D (Actividad f√≠sica) - tabla est√°tica inicial (valores 0)
  cargarP5SeccionDActividadFisica();
  // Secci√≥n E (Riesgo de ca√≠das) - tabla est√°tica inicial (valores 0)
  cargarP5SeccionERiesgoCaidas();
  cargarPscvMetas();
  
  // Agregar delay para asegurar que todos los elementos est√°n cargados
  console.log('Configurando timeout para Secci√≥n A en 2 segundos...');
  setTimeout(() => {
    console.log('‚è∞ TIMEOUT EJECUTADO - Iniciando carga de Secci√≥n A despu√©s de delay...');
    // Cargar Secci√≥n A (matriz por bandas etarias)
    cargarSeccionAMatriz();
  }, 2000);
  
  // Cargar Secci√≥n C (variables)
  cargarSeccionCVariables();
});


function num(v){ return (v==null||isNaN(v))? 0 : Number(v); }

// Funci√≥n de prueba simple para debuggear
async function testSeccionA(){
  console.log('=== PRUEBA SECCI√ìN A ===');
  
  // Verificar elementos
  const tbody = document.getElementById('seccion-a-pscv-body');
  const thead = document.getElementById('seccion-a-pscv-head');
  console.log('tbody encontrado:', !!tbody);
  console.log('thead encontrado:', !!thead);
  
  // Probar endpoint
  try {
    const response = await fetch('/api/pscv_simple?fecha_desde=2024-01-01&fecha_hasta=2025-12-31', { 
      credentials: 'same-origin' 
    });
    console.log('Respuesta endpoint:', response.status);
    
    if (response.ok) {
      const data = await response.json();
      console.log('Datos recibidos:', data);
      return data;
    }
  } catch (error) {
    console.error('Error al probar endpoint:', error);
  }
}

// Funci√≥n super simplificada para probar la actualizaci√≥n
async function actualizarSeccionASimple(){
  console.log('üîß FUNCI√ìN SIMPLE - Iniciando...');
  
  try {
    // Obtener datos
    const response = await fetch('/api/pscv_simple?fecha_desde=2024-01-01&fecha_hasta=2025-12-31', { 
      credentials: 'same-origin' 
    });
    
    if (!response.ok) {
      console.error('‚ùå Response no OK:', response.status);
      return;
    }
    
    const data = await response.json();
    console.log('üìä Datos obtenidos:', data);
    
    if (!data.success || !data.filas) {
      console.error('‚ùå Datos inv√°lidos');
      return;
    }
    
    // Buscar datos de PSCV
    const pscvData = data.filas.find(f => f.concepto === 'N√∫mero de personas en PSCV');
    if (!pscvData) {
      console.error('‚ùå No se encontraron datos de PSCV');
      return;
    }
    
    console.log('üéØ Datos PSCV:', pscvData);
    
    // Actualizar solo el total principal
    const pscvTotalEl = document.getElementById('pscv-total');
    if (pscvTotalEl) {
      const valorAnterior = pscvTotalEl.textContent;
      pscvTotalEl.textContent = pscvData.total_ambos || '0';
      console.log(`‚úÖ PSCV total actualizado: ${valorAnterior} ‚Üí ${pscvData.total_ambos}`);
    } else {
      console.error('‚ùå Elemento pscv-total no encontrado');
    }
    
    // Actualizar totales por sexo
    const pscvTotalH = document.getElementById('pscv-total-h');
    const pscvTotalM = document.getElementById('pscv-total-m');
    
    if (pscvTotalH) {
      pscvTotalH.textContent = pscvData.total_hombres || '0';
      console.log('‚úÖ PSCV hombres actualizado:', pscvData.total_hombres);
    }
    
    if (pscvTotalM) {
      pscvTotalM.textContent = pscvData.total_mujeres || '0';
      console.log('‚úÖ PSCV mujeres actualizado:', pscvData.total_mujeres);
    }
    
    console.log('üéâ Funci√≥n simple completada');
    
  } catch (error) {
    console.error('‚ùå Error en funci√≥n simple:', error);
  }
}

// Normaliza etiquetas para comparaciones tolerantes (ignora acentos, may√∫sculas y signos)
function keyizeLabel(s){
  try{
    return String(s||'')
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '') // quitar acentos
      .replace(/[^a-z0-9]+/g, '')        // dejar solo a-z0-9
      .trim();
  }catch(_){ return String(s||''); }
}


// ===================== SECCI√ìN B: METAS REM-P CON CELDAS BLOQUEADAS =====================
async function cargarPscvMetas(paramsFromChart, dataOverride){
  console.log('üéØ NUEVA TABLA REM-P - Iniciando carga...');
  
  const status = document.getElementById('metas-status');
  const tbody = document.getElementById('remp-metas-body');
  const set = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = (v||0); else console.warn('‚ö†Ô∏è Falta celda', id); };
  
  try {
    if(status) status.textContent = 'Cargando datos REM-P completos...';
    let data = dataOverride || null;

    if (!data) {
      // Construir query con filtros + par√°metros REM‚ÄëP
      const params = new URLSearchParams();
      const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
      const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
      const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
      const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
      // Par√°metros REM‚ÄëP persistidos
      try{ appendRemParams(params); }catch(_){ }
      const url = '/api/rem-p-2025/seccion-b' + (params.toString()? ('?'+params.toString()):'');
      console.log('üì° Cargando desde:', url);
      
      const response = await fetch(url, { credentials: 'same-origin' });
      const ct = response.headers.get('content-type')||'';
      if (response.status === 302 || response.url.includes('/login') || !ct.includes('application/json')){
        const text = !ct.includes('application/json') ? (await response.text()).slice(0,200) : '';
        console.warn('‚ö†Ô∏è Posible no autenticado o respuesta no JSON. Preview:', text);
        if(status) status.textContent = 'Sesi√≥n expirada o sin acceso';
        return;
      }
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      data = await response.json();
    }
  console.log('‚úÖ Datos REM-P Secci√≥n B recibidos:', data);
  window.__rempTablaMetas = data;
    
    if (data.success === false) {
      throw new Error(data.error || 'Error desconocido en Secci√≥n B');
    }
    
    const secciones = data.secciones || {};
    
    // ============ ACTUALIZAR BADGES DE TOTALES ============
    const badgePA140 = document.getElementById('total-pa-140');
    const badgePA150 = document.getElementById('total-pa-150');
    const badgeHbA1c7 = document.getElementById('total-hba1c-7');
    const badgeHbA1c8 = document.getElementById('total-hba1c-8');
    const hipertension = secciones.hipertension || {};
    const diabetes = secciones.diabetes || {};
    const rcvAlto = secciones.rcv_alto || {};

  if (badgePA140) badgePA140.textContent = hipertension.pa_140_90?.totales?.total || 0;
  if (badgePA150) badgePA150.textContent = hipertension.pa_150_90?.totales?.total || 0;
  if (badgeHbA1c7) badgeHbA1c7.textContent = diabetes.hba1c_7?.totales?.total || 0;
  if (badgeHbA1c8) badgeHbA1c8.textContent = diabetes.hba1c_8?.totales?.total || 0;
    
    // ============ LLENAR TABLA REM-P COMPLETA ============
    console.log('üîÑ Llenando tabla REM-P con datos completos...');
    
    // 1. HIPERTENSI√ìN - PA < 140/90 mmHg
    const pa140Data = hipertension.pa_140_90 || {};
    const pa140Totales = pa140Data.totales || {};
    const pa140Bandas = pa140Data.bandas || {};
    
  set('pa140-total', pa140Totales.total);
  set('pa140-h', pa140Totales.hombres);
  set('pa140-m', pa140Totales.mujeres);
    
    // Mapear TODAS las bandas etarias incluyendo las nuevas (65-69, 70-74, 75-79, 80+)
    const todasLasBandas = ['15-19', '20-24', '25-29', '30-34', '35-39', '40-44', '45-49', '50-54', '55-59', '60-64', '65-69', '70-74', '75-79', '80+'];
    
    todasLasBandas.forEach(banda => {
      const datosBanda = pa140Bandas[banda] || {};
      const bandaNorm = banda.replace('+', '-mas'); // Convertir '80+' a '80-mas'
      
      const elementoH = document.getElementById(`pa140-${bandaNorm}-h`);
      const elementoM = document.getElementById(`pa140-${bandaNorm}-m`);
      
      if (elementoH) elementoH.textContent = datosBanda.hombres || 0;
      if (elementoM) elementoM.textContent = datosBanda.mujeres || 0;
    });
    
    console.log(`‚úÖ PA<140/90 cargado: ${pa140Totales.total || 0} personas total`);
    
    // 2. HIPERTENSI√ìN - PA < 150/90 mmHg (solo para ‚â•80 a√±os)
    const pa150Data = hipertension.pa_150_90 || {};
    const pa150Totales = pa150Data.totales || {};
    
  set('pa150-total', pa150Totales.total);
  set('pa150-h', pa150Totales.hombres);
  set('pa150-m', pa150Totales.mujeres);
    
    // Solo llenar columna 80+ para PA 150/90
    const el150H80 = document.getElementById('pa150-80-mas-h');
    const el150M80 = document.getElementById('pa150-80-mas-m');
    if (el150H80) el150H80.textContent = pa150Totales.hombres || 0;
    if (el150M80) el150M80.textContent = pa150Totales.mujeres || 0;
    
    console.log(`‚úÖ PA<150/90 cargado: ${pa150Totales.total || 0} personas total (‚â•80 a√±os)`);
    
    // 3. DIABETES - HbA1c < 7% (< 80 a√±os)
    const hba1c7Data = diabetes.hba1c_7 || {};
    const hba1c7Totales = hba1c7Data.totales || {};
    const hba1c7Bandas = hba1c7Data.bandas || {};
    
  set('hba1c7-total', hba1c7Totales.total);
  set('hba1c7-h', hba1c7Totales.hombres);
  set('hba1c7-m', hba1c7Totales.mujeres);
    
    // Llenar bandas para HbA1c < 7% (excluir 80+)
    todasLasBandas.filter(b => b !== '80+').forEach(banda => {
      const datosBanda = hba1c7Bandas[banda] || {};
      const bandaNorm = banda.replace('+', '-mas');
      
      const elementoH = document.getElementById(`hba1c7-${bandaNorm}-h`);
      const elementoM = document.getElementById(`hba1c7-${bandaNorm}-m`);
      
      if (elementoH) elementoH.textContent = datosBanda.hombres || 0;
      if (elementoM) elementoM.textContent = datosBanda.mujeres || 0;
    });
    
    console.log(`‚úÖ HbA1c<7% cargado: ${hba1c7Totales.total || 0} personas total (<80 a√±os)`);
    
    // 4. DIABETES - HbA1c < 8% (‚â• 80 a√±os)
    const hba1c8Data = diabetes.hba1c_8 || {};
    const hba1c8Totales = hba1c8Data.totales || {};
    
  set('hba1c8-total', hba1c8Totales.total);
  set('hba1c8-h', hba1c8Totales.hombres);
  set('hba1c8-m', hba1c8Totales.mujeres);
    
    console.log(`‚úÖ HbA1c<8% cargado: ${hba1c8Totales.total || 0} personas total (‚â•80 a√±os)`);
    
    // 5. RCV ALTO - LDL < 70 mg/dL
  const ldl70Data = rcvAlto.ldl_70 || {};
    const ldl70Totales = ldl70Data.totales || {};
    const ldl70Bandas = ldl70Data.bandas || {};
    
  set('ldl70-total', ldl70Totales.total);
  set('ldl70-h', ldl70Totales.hombres);
  set('ldl70-m', ldl70Totales.mujeres);
    
    // Llenar bandas LDL < 70 (desde 25 a√±os seg√∫n normativa)
    todasLasBandas.forEach(banda => {
      const datosBanda = ldl70Bandas[banda] || {};
      const bandaNorm = banda.replace('+', '-mas');
      
      const elementoH = document.getElementById(`ldl70-${bandaNorm}-h`);
      const elementoM = document.getElementById(`ldl70-${bandaNorm}-m`);
      
      if (elementoH) elementoH.textContent = datosBanda.hombres || 0;
      if (elementoM) elementoM.textContent = datosBanda.mujeres || 0;
    });
    
    console.log(`‚úÖ LDL<70 cargado: ${ldl70Totales.total || 0} personas total`);
    
    // 6. ANTECEDENTES CARDIOVASCULARES (ECV, IAM, ACV)
    const tiposAntecedentes = [
      { key: 'ecv', name: 'ECV' },
      { key: 'iam', name: 'IAM' },
      { key: 'acv', name: 'ACV' }
    ];
    const tiposTratamiento = ['antiag', 'estatina', 'fumador'];
    // Mapeo de nombres frontend -> backend
    const mapTratamientoBackend = {
      antiag: 'antiagregantes',
      estatina: 'estatina',
      fumador: 'fumador'
    };
    
    tiposAntecedentes.forEach(tipo => {
      const antecedentesData = secciones[tipo.key] || {};
      
      tiposTratamiento.forEach(tratamiento => {
        const backKey = mapTratamientoBackend[tratamiento] || tratamiento;
        const tratamientoData = antecedentesData[backKey] || antecedentesData[tratamiento] || {};
        const totales = tratamientoData.totales || {};
        const bandas = tratamientoData.bandas || {};
        
        // Totales
        const elTotal = document.getElementById(`${tipo.key}-${tratamiento}-total`);
        const elH = document.getElementById(`${tipo.key}-${tratamiento}-h`);
        const elM = document.getElementById(`${tipo.key}-${tratamiento}-m`);
        
        if (elTotal) elTotal.textContent = totales.total || 0;
        if (elH) elH.textContent = totales.hombres || 0;
        if (elM) elM.textContent = totales.mujeres || 0;
        
        // Bandas etarias para antecedentes
        todasLasBandas.forEach(banda => {
          const datosBanda = bandas[banda] || {};
          const bandaNorm = banda.replace('+', '-mas');
          
          const elementoH = document.getElementById(`${tipo.key}-${tratamiento}-${bandaNorm}-h`);
          const elementoM = document.getElementById(`${tipo.key}-${tratamiento}-${bandaNorm}-m`);
          
          if (elementoH) elementoH.textContent = datosBanda.hombres || 0;
          if (elementoM) elementoM.textContent = datosBanda.mujeres || 0;
        });
      });
      
      console.log(`‚úÖ ${tipo.name} cargado: antiagregantes, estatina, fumador`);
    });
    
    // ============ RESUMEN FINAL ============
    const totalPacientes = (hipertension.pa_140_90?.totales?.total || 0) + 
                          (diabetes.hba1c_7?.totales?.total || 0) + 
                          (rcvAlto.ldl_70?.totales?.total || 0);

    const intervalo = data.intervalo || {};
    let periodoLabel = 'N/D';
    if (data.periodo?.descripcion) {
      periodoLabel = data.periodo.descripcion;
    } else if (intervalo.inicio && intervalo.fin_incluido) {
      try {
        const inicioFmt = new Date(intervalo.inicio).toLocaleDateString('es-CL');
        const finFmt = new Date(intervalo.fin_incluido).toLocaleDateString('es-CL');
        periodoLabel = `${inicioFmt} al ${finFmt}`;
      } catch (_) {
        periodoLabel = `${intervalo.inicio} al ${intervalo.fin_incluido}`;
      }
    }

    if (status && data) {
      status.innerHTML = `<i class="bi bi-check-circle text-success"></i> 
                          <strong>Tabla REM-P COMPLETA cargada</strong><br>
                          ‚Ä¢ PA&lt;140/90: ${hipertension.pa_140_90?.totales?.total || 0} personas<br>
                          ‚Ä¢ HbA1c&lt;7%: ${diabetes.hba1c_7?.totales?.total || 0} personas<br>
                          ‚Ä¢ LDL&lt;70: ${rcvAlto.ldl_70?.totales?.total || 0} personas<br>
                          ‚Ä¢ Per√≠odo: ${periodoLabel}<br>
                          <small>Incluye todas las bandas etarias: 15-19 hasta 80+ a√±os</small>`;
    }
    
    console.log('üéâ ¬°TABLA REM-P COMPLETA cargada exitosamente!');
    console.log(`üìä Total estimado de intervenciones: ${totalPacientes}`);
    
  } catch (error) {
    console.error('‚ùå Error cargando tabla REM-P:', error);
    if(status) status.innerHTML = `<i class="bi bi-x-circle text-danger"></i> Error: ${error.message}`;
  }
}


// ===================== NUEVA SECCI√ìN: EVALUACI√ìN DE DIABETES EN PSCV (MANUAL REM-P 2025) =====================
async function cargarDiabetesEvaluacion() {
  const status = document.getElementById('diabetes-evaluacion-status');
  const tbody = document.getElementById('diabetes-evaluacion-body');
  
  console.log('üöÄ Iniciando cargarDiabetesEvaluacion...');
  
  try {
    // Par√°metros de filtro desde la p√°gina (usar IDs correctos del selector)
    const params = new URLSearchParams();
    const sectores = document.getElementById('sectores_select')?.value || '';
    const sexo = document.getElementById('sexo_select')?.value || '';
    const fechaDesde = document.getElementById('fecha_desde')?.value || '';
    const fechaHasta = document.getElementById('fecha_hasta')?.value || '';
    
    // Obtener filtro de poblaci√≥n seleccionado
    const poblacionFilter = document.querySelector('input[name="poblacion-filter"]:checked')?.value || 'ecicep';
    
    if (sectores) params.append('sectores', sectores);
    if (sexo) params.append('sexo', sexo);
    if (fechaDesde) params.append('fecha_desde', fechaDesde);
    if (fechaHasta) params.append('fecha_hasta', fechaHasta);
    params.append('poblacion', poblacionFilter);

    console.log('üì° Haciendo fetch a:', '/api/estadisticas/diabetes_pscv?' + params.toString());

    const response = await fetch('/api/estadisticas/diabetes_pscv?' + params.toString(), {
      credentials: 'same-origin'
    });
    console.log('Response status:', response.status);
    console.log('Response ok:', response.ok);
    console.log('Response URL:', response.url);
    
    // Verificar si es una redirecci√≥n (no autenticado)
    if (response.status === 302 || response.url.includes('/login')) {
      console.warn('‚ö†Ô∏è Usuario no autenticado - redirigiendo a login');
      window.location.href = '/login';
      return;
    }
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('üìä Datos recibidos:', data);
    
    // Actualizar elementos del dashboard
    const totalElement = document.getElementById('diabetes-total');
    console.log('üéØ Elemento diabetes-total:', totalElement);
    
    if (totalElement) {
      totalElement.textContent = data.total_diabetes_pscv || 0;
      console.log('‚úÖ Actualizado diabetes-total a:', data.total_diabetes_pscv);
    } else {
      console.error('‚ùå No se encontr√≥ elemento diabetes-total');
    }
    
    const metricas = data.metricas || {};
    const control = metricas.control_metabolico || {};
    const complicaciones = metricas.complicaciones || {};
    const evaluacion = metricas.evaluacion_basica || {};
    const tratamiento = metricas.tratamiento_insulina || {};
    
    document.getElementById('diabetes-meta-hba1c').textContent = control.logra_meta_hba1c_edad || 0;
    document.getElementById('diabetes-hba1c-alto').textContent = tratamiento.con_hba1c_mayor_9 || 0;
    document.getElementById('diabetes-podologia').textContent = evaluacion.con_atencion_podologica_vigente || 0;
    document.getElementById('diabetes-hipoglicemias').textContent = complicaciones.con_hipoglicemias_recurrentes || 0;
    
    // Definir las m√©tricas para la tabla con descripciones
    const metricas_tabla = [
      {
        categoria: 'CONTROL METAB√ìLICO',
        items: [
          {
            nombre: 'Con HbA1c vigente (√∫ltimo a√±o)',
            valor: control.con_hba1c_vigente || 0,
            descripcion: 'Pacientes con examen HbA1c realizado en √∫ltimos 12 meses'
          },
          {
            nombre: 'Logra meta HbA1c seg√∫n edad',
            valor: control.logra_meta_hba1c_edad || 0,
            descripcion: '<80 a√±os: HbA1c <7% | ‚â•80 a√±os: HbA1c <8%'
          },
          {
            nombre: 'Con HbA1c ‚â• 9%',
            valor: tratamiento.con_hba1c_mayor_9 || 0,
            descripcion: 'Pacientes con control metab√≥lico deficiente (alto riesgo)'
          }
        ]
      },
      {
        categoria: 'EVALUACI√ìN B√ÅSICA',
        items: [
          {
            nombre: 'Con atenci√≥n podol√≥gica vigente',
            valor: evaluacion.con_atencion_podologica_vigente || 0,
            descripcion: 'Evaluaci√≥n y cuidado podol√≥gico seg√∫n pauta de estimaci√≥n de riesgo'
          }
        ]
      },
      {
        categoria: 'PIE DIAB√âTICO',
        items: [
          {
            nombre: 'Riesgo bajo',
            valor: (metricas.pie_diabetico || {}).riesgo_bajo || 0,
            descripcion: 'Sin p√©rdida de sensibilidad ni deformidades'
          },
          {
            nombre: 'Riesgo moderado', 
            valor: (metricas.pie_diabetico || {}).riesgo_moderado || 0,
            descripcion: 'P√©rdida de sensibilidad o deformidades'
          },
          {
            nombre: 'Riesgo alto',
            valor: (metricas.pie_diabetico || {}).riesgo_alto || 0,
            descripcion: 'P√©rdida de sensibilidad + deformidades'
          },
          {
            nombre: 'Riesgo m√°ximo',
            valor: (metricas.pie_diabetico || {}).riesgo_maximo || 0,
            descripcion: 'Antecedente de √∫lcera o amputaci√≥n'
          },
          {
            nombre: 'Con √∫lcera o amputaci√≥n',
            valor: (metricas.pie_diabetico || {}).con_ulcera_o_amputacion || 0,
            descripcion: 'Complicaci√≥n severa que requiere tratamiento especializado'
          }
        ]
      },
      {
        categoria: 'COMPLICACIONES',
        items: [
          {
            nombre: 'Con hipoglicemias recurrentes',
            valor: complicaciones.con_hipoglicemias_recurrentes || 0,
            descripcion: 'Episodios repetidos de hipoglicemia (ajuste terap√©utico necesario)'
          },
          {
            nombre: 'Fumador actual',
            valor: complicaciones.fumador_actual || 0,
            descripcion: 'Factor de riesgo cardiovascular modificable'
          }
        ]
      },
      {
        categoria: 'MEDICACI√ìN',
        items: [
          {
            nombre: 'ERC con IECA o ARA II',
            valor: (metricas.medicacion || {}).erc_con_ieca_ara || 0,
            descripcion: 'Enfermedad renal cr√≥nica en tratamiento con nefroprotecci√≥n'
          }
        ]
      },
      {
        categoria: 'DIAGN√ìSTICOS ASOCIADOS',
        items: [
          {
            nombre: 'Con diagn√≥stico de hipertensi√≥n arterial',
            valor: (metricas.diagnosticos_asociados || {}).con_diagnostico_hta || 0,
            descripcion: 'Comorbilidad cardiovascular frecuente en diabetes'
          },
          {
            nombre: 'Con diagn√≥stico de enfermedad renal cr√≥nica',
            valor: (metricas.diagnosticos_asociados || {}).con_diagnostico_erc || 0,
            descripcion: 'Complicaci√≥n cr√≥nica de la diabetes'
          },
          {
            nombre: 'Antecedente de ataque cerebrovascular',
            valor: (metricas.diagnosticos_asociados || {}).antecedente_acv || 0,
            descripcion: 'Complicaci√≥n macrovascular mayor'
          },
          {
            nombre: 'Antecedente de infarto agudo al miocardio',
            valor: (metricas.diagnosticos_asociados || {}).antecedente_iam || 0,
            descripcion: 'Complicaci√≥n macrovascular mayor'
          },
          {
            nombre: 'Retinopat√≠a diab√©tica',
            valor: (metricas.diagnosticos_asociados || {}).retinopatia_diabetica || 0,
            descripcion: 'Complicaci√≥n microvascular que afecta la retina'
          }
        ]
      }
    ];
    
    // Limpiar tabla y generar filas
    tbody.innerHTML = '';
    
    for (const categoria of metricas_tabla) {
      // Fila de encabezado de categor√≠a
      const headerRow = document.createElement('tr');
      headerRow.className = 'table-section-header';
      headerRow.innerHTML = `
        <td colspan="4"><strong>${categoria.categoria}</strong></td>
      `;
      tbody.appendChild(headerRow);
      
      // Filas de m√©tricas
      for (const item of categoria.items) {
        const porcentaje = data.total_diabetes_pscv > 0 ? 
          ((item.valor / data.total_diabetes_pscv) * 100).toFixed(1) : '0.0';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding-left: 1.5rem;">${item.nombre}</td>
          <td class="text-center"><strong>${item.valor}</strong></td>
          <td class="text-center">${porcentaje}%</td>
          <td><small class="text-muted">${item.descripcion}</small></td>
        `;
        tbody.appendChild(row);
      }
    }
    
    status.textContent = `Estad√≠sticas actualizadas - Total diabetes: ${data.total_diabetes_pscv || 0}`;
    if (data.nota) {
      status.textContent += ` - ${data.nota}`;
    }
  } catch (error) {
    console.error('Error cargando estad√≠sticas de diabetes:', error);
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar estad√≠sticas de diabetes</td></tr>';
    status.textContent = 'Error al cargar datos de diabetes';
    // Limpiar dashboard m√≠nimo en error
    const ids = ['diabetes-total','diabetes-meta-hba1c','diabetes-hba1c-alto','diabetes-podologia','diabetes-hipoglicemias'];
    ids.forEach(id => { const el = document.getElementById(id); if (el) el.textContent = '0'; });
  }
}

// ===================== NUEVA SECCI√ìN: EVALUACI√ìN DE HIPERTENSI√ìN EN PSCV (MANUAL REM-P 2025) =====================
async function cargarHipertensionEvaluacion() {
  console.log('=== DEBUG: cargarHipertensionEvaluacion iniciada ===');
  const status = document.getElementById('hipertension-evaluacion-status');
  const tbody = document.getElementById('hipertension-evaluacion-body');
  
  console.log('Status element found:', status);
  console.log('Tbody element found:', tbody);
  
  try {
    // Par√°metros de filtro desde la p√°gina (usar IDs correctos del selector)
    const params = new URLSearchParams();
    const sectores = document.getElementById('sectores_select')?.value || '';
    const sexo = document.getElementById('sexo_select')?.value || '';
    const fechaDesde = document.getElementById('fecha_desde')?.value || '';
    const fechaHasta = document.getElementById('fecha_hasta')?.value || '';
    
    // Obtener filtro de poblaci√≥n seleccionado
    const poblacionFilter = document.querySelector('input[name="poblacion-filter"]:checked')?.value || 'ecicep';
    
    console.log('Par√°metros de filtro:', { sectores, sexo, fechaDesde, fechaHasta, poblacionFilter });
    
    if (sectores) params.append('sectores', sectores);
    if (sexo) params.append('sexo', sexo);
    if (fechaDesde) params.append('fecha_desde', fechaDesde);
    if (fechaHasta) params.append('fecha_hasta', fechaHasta);
    params.append('poblacion', poblacionFilter);

    console.log('URL completa:', '/api/estadisticas/hipertension_pscv?' + params.toString());

    const response = await fetch('/api/estadisticas/hipertension_pscv?' + params.toString(), {
      credentials: 'same-origin'
    });
    console.log('Response status:', response.status);
    console.log('Response ok:', response.ok);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Data received from API:', data);
    
    // Verificar elementos espec√≠ficos que vamos a actualizar
    const hipertensionTotalElement = document.getElementById('hipertension-total');
    const hipertensionPaAltaElement = document.getElementById('hipertension-pa-alta');
    const hipertensionHeartsElement = document.getElementById('hipertension-hearts');
    
    console.log('Elementos dashboard hipertensi√≥n:');
    console.log('- hipertension-total:', hipertensionTotalElement);
    console.log('- hipertension-pa-alta:', hipertensionPaAltaElement);
    console.log('- hipertension-hearts:', hipertensionHeartsElement);
    
    // Actualizar elementos del dashboard
    if (hipertensionTotalElement) {
      hipertensionTotalElement.textContent = data.total_hipertension_pscv || 0;
      console.log('Actualizado hipertension-total a:', data.total_hipertension_pscv);
    }
    
    const metricas = data.metricas || {};
    const laboratorio = metricas.evaluacion_laboratorio || {};
    const presion = metricas.control_presion || {};
    const diagnosticos = metricas.diagnosticos_asociados || {};
    const hearts = metricas.protocolo_hearts || {};
    
    console.log('Metricas desglosadas:', { laboratorio, presion, diagnosticos, hearts });
    
    if (hipertensionPaAltaElement) {
      hipertensionPaAltaElement.textContent = presion.pa_mayor_160_100 || 0;
      console.log('Actualizado hipertension-pa-alta a:', presion.pa_mayor_160_100);
    }
    
    if (hipertensionHeartsElement) {
      hipertensionHeartsElement.textContent = hearts.en_protocolo_hearts || 0;
      console.log('Actualizado hipertension-hearts a:', hearts.en_protocolo_hearts);
    }
    document.getElementById('hipertension-rac').textContent = laboratorio.con_rac_vigente || 0;
    document.getElementById('hipertension-vfg').textContent = laboratorio.con_vfg_vigente || 0;
    
    // Definir las m√©tricas para la tabla con descripciones
    const metricas_tabla = [
      {
        categoria: 'EVALUACI√ìN DE LABORATORIO',
        items: [
          {
            nombre: 'Con raz√≥n alb√∫mina creatinina (RAC), vigente',
            valor: laboratorio.con_rac_vigente || 0,
            descripcion: 'Examen para detectar proteinuria y evaluar funci√≥n renal'
          },
          {
            nombre: 'Con velocidad de filtraci√≥n glomerular estimada (VFGE) vigente',
            valor: laboratorio.con_vfg_vigente || 0,
            descripcion: 'Evaluaci√≥n de la funci√≥n renal mediante VFG estimada'
          },
          {
            nombre: 'Con VFGE y RAC vigente',
            valor: laboratorio.con_vfg_y_rac_vigente || 0,
            descripcion: 'Evaluaci√≥n completa de funci√≥n renal (VFG + RAC)'
          }
        ]
      },
      {
        categoria: 'CONTROL DE PRESI√ìN ARTERIAL',
        items: [
          {
            nombre: 'Con presi√≥n arterial igual o mayor 160/100 MMHG',
            valor: presion.pa_mayor_160_100 || 0,
            descripcion: 'Hipertensi√≥n estadio 2 que requiere ajuste terap√©utico inmediato'
          }
        ]
      },
      {
        categoria: 'DIAGN√ìSTICOS ASOCIADOS',
        items: [
          {
            nombre: 'Con diagn√≥stico de enfermedad renal cr√≥nica',
            valor: diagnosticos.con_diagnostico_erc || 0,
            descripcion: 'Complicaci√≥n cr√≥nica de la hipertensi√≥n no controlada'
          }
        ]
      },
      {
        categoria: 'PROTOCOLO HEARTS',
        items: [
          {
            nombre: 'En protocolo Hearts',
            valor: hearts.en_protocolo_hearts || 0,
            descripcion: 'Protocolo HEARTS para manejo integral de enfermedades cardiovasculares'
          }
        ]
      }
    ];
    
    // Limpiar tabla y generar filas
    tbody.innerHTML = '';
    
    for (const categoria of metricas_tabla) {
      // Fila de encabezado de categor√≠a
      const headerRow = document.createElement('tr');
      headerRow.className = 'table-section-header';
      headerRow.innerHTML = `
        <td colspan="4"><strong>${categoria.categoria}</strong></td>
      `;
      tbody.appendChild(headerRow);
      
      // Filas de m√©tricas
      for (const item of categoria.items) {
        const porcentaje = data.total_hipertension_pscv > 0 ? 
          ((item.valor / data.total_hipertension_pscv) * 100).toFixed(1) : '0.0';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding-left: 1.5rem;">${item.nombre}</td>
          <td class="text-center"><strong>${item.valor}</strong></td>
          <td class="text-center">${porcentaje}%</td>
          <td><small class="text-muted">${item.descripcion}</small></td>
        `;
        tbody.appendChild(row);
      }
    }
    
    status.textContent = `Estad√≠sticas actualizadas - Total hipertensi√≥n: ${data.total_hipertension_pscv}`;
    if (data.nota) {
      status.textContent += ` - ${data.nota}`;
    }
    
  } catch (error) {
    console.error('Error cargando estad√≠sticas de hipertensi√≥n:', error);
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar estad√≠sticas de hipertensi√≥n</td></tr>';
    status.textContent = 'Error al cargar datos de hipertensi√≥n';
    
    // Limpiar contadores del dashboard
    document.getElementById('hipertension-total').textContent = '0';
    document.getElementById('hipertension-pa-alta').textContent = '0';
    document.getElementById('hipertension-hearts').textContent = '0';
    document.getElementById('hipertension-rac').textContent = '0';
    document.getElementById('hipertension-vfg').textContent = '0';
  }
}

// ===================== NUEVA SECCI√ìN: TODAS LAS PERSONAS EN PSCV (MANUAL REM-P 2025) =====================
async function cargarTodasPersonasPscv() {
  const status = document.getElementById('todas-personas-pscv-status');
  const tbody = document.getElementById('todas-personas-pscv-body');
  
  try {
    // Par√°metros de filtro desde la p√°gina (usar IDs correctos del selector)
    const params = new URLSearchParams();
    const sectores = document.getElementById('sectores_select')?.value || '';
    const sexo = document.getElementById('sexo_select')?.value || '';
    const fechaDesde = document.getElementById('fecha_desde')?.value || '';
    const fechaHasta = document.getElementById('fecha_hasta')?.value || '';
    
    // Obtener filtro de poblaci√≥n seleccionado
    const poblacionFilter = document.querySelector('input[name="poblacion-filter"]:checked')?.value || 'ecicep';
    
    if (sectores) params.append('sectores', sectores);
    if (sexo) params.append('sexo', sexo);
    if (fechaDesde) params.append('fecha_desde', fechaDesde);
    if (fechaHasta) params.append('fecha_hasta', fechaHasta);
    params.append('poblacion', poblacionFilter);

    const response = await fetch('/api/estadisticas/todas_personas_pscv?' + params.toString(), {
      credentials: 'same-origin'
    });
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    // Actualizar elementos del dashboard
    document.getElementById('todas-pscv-total').textContent = data.total_personas_pscv || 0;
    
    const metricas = data.metricas || {};
    const sobrepeso = metricas.sobrepeso_obesidad || {};
    const estilo = metricas.estilo_vida || {};
    const erc = metricas.enfermedad_renal_cronica || {};
    
    // Calcular totales para dashboard
    const totalSobrepesoObesidad = (sobrepeso.sobrepeso_menor_65 || 0) + 
                                   (sobrepeso.sobrepeso_mayor_65 || 0) + 
                                   (sobrepeso.obesidad_menor_65 || 0) + 
                                   (sobrepeso.obesidad_mayor_65 || 0);
    
    document.getElementById('todas-pscv-sobrepeso-obesidad').textContent = totalSobrepesoObesidad;
    document.getElementById('todas-pscv-actividad').textContent = estilo.en_actividad_fisica || 0;
    document.getElementById('todas-pscv-fumador').textContent = estilo.fumador_actual || 0;
    document.getElementById('todas-pscv-erc').textContent = erc.total_erc || 0;
    
    // Definir las m√©tricas para la tabla con descripciones
    const metricas_tabla = [
      {
        categoria: 'SOBREPESO Y OBESIDAD POR GRUPOS ETARIOS',
        items: [
          {
            nombre: 'Sobrepeso: IMC entre 25 y 29.9 <65 a√±os',
            valor: sobrepeso.sobrepeso_menor_65 || 0,
            descripcion: 'Personas menores de 65 a√±os con IMC entre 25.0-29.9 kg/m¬≤'
          },
          {
            nombre: 'Sobrepeso: IMC entre 28 y 31.9 ‚â•65 a√±os',
            valor: sobrepeso.sobrepeso_mayor_65 || 0,
            descripcion: 'Personas de 65 a√±os o m√°s con IMC entre 28.0-31.9 kg/m¬≤'
          },
          {
            nombre: 'Obesidad: IMC igual o Mayor a 30KG/M¬≤ <65 a√±os',
            valor: sobrepeso.obesidad_menor_65 || 0,
            descripcion: 'Personas menores de 65 a√±os con IMC ‚â•30.0 kg/m¬≤'
          },
          {
            nombre: 'Obesidad: IMC igual o Mayor a 32KG/M¬≤ ‚â•65 a√±os',
            valor: sobrepeso.obesidad_mayor_65 || 0,
            descripcion: 'Personas de 65 a√±os o m√°s con IMC ‚â•32.0 kg/m¬≤'
          }
        ]
      },
      {
        categoria: 'ESTILO DE VIDA',
        items: [
          {
            nombre: 'Personas en actividad f√≠sica salud cardiovascular',
            valor: estilo.en_actividad_fisica || 0,
            descripcion: 'Participantes activos en programa de actividad f√≠sica cardiovascular'
          },
          {
            nombre: 'Fumador actual',
            valor: estilo.fumador_actual || 0,
            descripcion: 'Personas que mantienen h√°bito tab√°quico activo'
          }
        ]
      },
      {
        categoria: 'ENFERMEDAD RENAL CR√ìNICA (ERC)',
        items: [
          {
            nombre: 'Sin enfermedad renal (S/ERC)',
            valor: erc.sin_erc || 0,
            descripcion: 'Personas sin diagn√≥stico de enfermedad renal cr√≥nica'
          },
          {
            nombre: 'Etapa G1',
            valor: erc.erc_g1 || 0,
            descripcion: 'ERC G1: VFG ‚â•90 ml/min/1.73m¬≤ con da√±o renal'
          },
          {
            nombre: 'Etapa G2',
            valor: erc.erc_g2 || 0,
            descripcion: 'ERC G2: VFG 60-89 ml/min/1.73m¬≤ con da√±o renal'
          },
          {
            nombre: 'Etapa G3a',
            valor: erc.erc_g3a || 0,
            descripcion: 'ERC G3a: VFG 45-59 ml/min/1.73m¬≤ (disminuci√≥n leve-moderada)'
          },
          {
            nombre: 'Etapa G3b',
            valor: erc.erc_g3b || 0,
            descripcion: 'ERC G3b: VFG 30-44 ml/min/1.73m¬≤ (disminuci√≥n moderada-severa)'
          },
          {
            nombre: 'Etapa G4',
            valor: erc.erc_g4 || 0,
            descripcion: 'ERC G4: VFG 15-29 ml/min/1.73m¬≤ (disminuci√≥n severa)'
          },
          {
            nombre: 'Etapa G5',
            valor: erc.erc_g5 || 0,
            descripcion: 'ERC G5: VFG <15 ml/min/1.73m¬≤ (falla renal)'
          },
          {
            nombre: 'TOTAL ERC',
            valor: erc.total_erc || 0,
            descripcion: 'Total de personas con diagn√≥stico de enfermedad renal cr√≥nica'
          }
        ]
      }
    ];
    
    // Limpiar tabla y generar filas
    tbody.innerHTML = '';
    
    for (const categoria of metricas_tabla) {
      // Fila de encabezado de categor√≠a
      const headerRow = document.createElement('tr');
      headerRow.className = 'table-section-header';
      headerRow.innerHTML = `
        <td colspan="4"><strong>${categoria.categoria}</strong></td>
      `;
      tbody.appendChild(headerRow);
      
      // Filas de m√©tricas
      for (const item of categoria.items) {
        const porcentaje = data.total_personas_pscv > 0 ? 
          ((item.valor / data.total_personas_pscv) * 100).toFixed(1) : '0.0';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="padding-left: 1.5rem;">${item.nombre}</td>
          <td class="text-center"><strong>${item.valor}</strong></td>
          <td class="text-center">${porcentaje}%</td>
          <td><small class="text-muted">${item.descripcion}</small></td>
        `;
        tbody.appendChild(row);
      }
    }
    
    status.textContent = `Estad√≠sticas actualizadas - Total personas PSCV: ${data.total_personas_pscv}`;
    if (data.nota) {
      status.textContent += ` - ${data.nota}`;
    }
    
  } catch (error) {
    console.error('Error cargando estad√≠sticas de todas las personas PSCV:', error);
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar estad√≠sticas de todas las personas PSCV</td></tr>';
    status.textContent = 'Error al cargar datos de todas las personas PSCV';
    
    // Limpiar contadores del dashboard
    document.getElementById('todas-pscv-total').textContent = '0';
    document.getElementById('todas-pscv-sobrepeso-obesidad').textContent = '0';
    document.getElementById('todas-pscv-actividad').textContent = '0';
    document.getElementById('todas-pscv-fumador').textContent = '0';
    document.getElementById('todas-pscv-erc').textContent = '0';
  }
}

// ===================== SECCI√ìN A: Matriz por bandas etarias =====================
// Funci√≥n de prueba para ejecutar desde consola del navegador
function testPSCVUpdate() {
  console.log('üß™ TEST: Actualizando PSCV directamente...');
  const pscvTotal = document.getElementById('pscv-total');
  const pscvTotalH = document.getElementById('pscv-total-h');
  const pscvTotalM = document.getElementById('pscv-total-m');
  
  if (pscvTotal) {
    pscvTotal.textContent = '285';
    console.log('‚úÖ pscv-total forzado a 285');
  }
  if (pscvTotalH) {
    pscvTotalH.textContent = '78';
    console.log('‚úÖ pscv-total-h forzado a 78');
  }
  if (pscvTotalM) {
    pscvTotalM.textContent = '207';
    console.log('‚úÖ pscv-total-m forzado a 207');
  }
}

async function cargarSeccionAMatriz(paramsFromChart){
  console.log('üöÄ SECCI√ìN A - Iniciando carga...');
  
  try {
    const thead = document.getElementById('seccion-a-pscv-head');
    const status = document.getElementById('seccion-a-status');
    
    // NOTA: Esta funci√≥n est√° obsoleta, los datos ahora se cargan desde REM P 2025
    if (status) status.textContent = '‚úÖ Datos cargados desde REM P 2025';
    console.log('‚ö†Ô∏è cargarSeccionAMatriz() obsoleta - usando REM P 2025');
    return; // Salir temprano, REM P 2025 ya carg√≥ los datos
    
    // C√≥digo antiguo comentado
    /*
    const fechaDesde = document.getElementById('fecha-desde')?.value || '2024-01-01';
    const fechaHasta = document.getElementById('fecha-hasta')?.value || '2025-12-31';
    const timestamp = Date.now();
    const response = await fetch(`/api/pscv_simple?fecha_desde=${fechaDesde}&fecha_hasta=${fechaHasta}&t=${timestamp}`, { 
      credentials: 'same-origin' 
    });
    console.log('üöÄ Llamando a PSCV simple con timestamps para evitar cache');
    
    console.log('üìä Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    console.log('üìä Datos recibidos del backend:', data);
    
    if (!data.success || !data.filas) {
      throw new Error('Datos inv√°lidos del backend');
    }
    
    // Buscar y procesar datos de PSCV
    console.log('üìä Data completa recibida:', data);
    const pscvData = data.filas.find(f => f.concepto === 'N√∫mero de personas en PSCV');
    if (!pscvData) {
      console.error('‚ùå No se encontraron datos de PSCV en:', data.filas);
      throw new Error('No se encontraron datos de PSCV');
    }
    
    console.log('üéØ Datos PSCV encontrados:', pscvData);
    console.log('üéØ Total ambos:', pscvData.total_ambos, 'Hombres:', pscvData.total_hombres, 'Mujeres:', pscvData.total_mujeres);
    
    // Actualizar totales PSCV principales
    const pscvTotal = document.getElementById('pscv-total');
    const pscvTotalH = document.getElementById('pscv-total-h');
    const pscvTotalM = document.getElementById('pscv-total-m');
    
    console.log('üîç Buscando elementos DOM...');
    if (pscvTotal) {
      const valorAnterior = pscvTotal.textContent;
      pscvTotal.textContent = pscvData.total_ambos || '0';
      console.log('‚úÖ pscv-total actualizado:', valorAnterior, '->', pscvData.total_ambos);
    } else {
      console.error('‚ùå Elemento pscv-total no encontrado');
    }
    if (pscvTotalH) {
      const valorAnterior = pscvTotalH.textContent;
      pscvTotalH.textContent = pscvData.total_hombres || '0';
      console.log('‚úÖ pscv-total-h actualizado:', valorAnterior, '->', pscvData.total_hombres);
    } else {
      console.error('‚ùå Elemento pscv-total-h no encontrado');
    }
    if (pscvTotalM) {
      const valorAnterior = pscvTotalM.textContent;
      pscvTotalM.textContent = pscvData.total_mujeres || '0';
      console.log('‚úÖ pscv-total-m actualizado:', valorAnterior, '->', pscvData.total_mujeres);
    } else {
      console.error('‚ùå Elemento pscv-total-m no encontrado');
    }
    
    // Programar verificaci√≥n despu√©s de 3 segundos para detectar sobrescritura
    setTimeout(() => {
      const valorActual = document.getElementById('pscv-total')?.textContent;
      if (valorActual !== String(pscvData.total_ambos)) {
        console.warn('‚ö†Ô∏è ALERTA: pscv-total fue sobrescrito! Era:', pscvData.total_ambos, 'ahora es:', valorActual);
      } else {
        console.log('‚úÖ pscv-total sigue correcto despu√©s de 3s:', valorActual);
      }
    }, 3000);
    
    // Actualizar tambi√©n las bandas etarias de PSCV
    const gruposEdad = ['15-19', '20-24', '25-29', '30-34', '35-39', '40-44', 
                       '45-49', '50-54', '55-59', '60-64', '65-69', '70-74', '75-79', '80+'];
    
    gruposEdad.forEach(grupo => {
      const grupoSinMas = grupo.replace('+', ''); // "80+" -> "80"
      const hombresEl = document.getElementById(`pscv-${grupoSinMas}-h`);
      const mujeresEl = document.getElementById(`pscv-${grupoSinMas}-m`);
      
      if (hombresEl && pscvData[`${grupo}_h`] !== undefined) {
        hombresEl.textContent = pscvData[`${grupo}_h`] || '0';
        console.log(`‚úÖ pscv-${grupoSinMas}-h actualizado:`, pscvData[`${grupo}_h`]);
      }
      
      if (mujeresEl && pscvData[`${grupo}_m`] !== undefined) {
        mujeresEl.textContent = pscvData[`${grupo}_m`] || '0';
        console.log(`‚úÖ pscv-${grupoSinMas}-m actualizado:`, pscvData[`${grupo}_m`]);
      }
    });
    
    // Procesar otros conceptos del backend
    data.filas.forEach(fila => {
      if (fila.concepto.includes('riesgo cardiovascular')) {
        // Actualizar datos de clasificaci√≥n de riesgo
        let prefijo = '';
        if (fila.concepto.includes('bajo')) prefijo = 'riesgo-bajo';
        else if (fila.concepto.includes('moderado')) prefijo = 'riesgo-mod';
        else if (fila.concepto.includes('alto')) prefijo = 'riesgo-alto';
        
        if (prefijo) {
          const totalEl = document.getElementById(`${prefijo}-total`);
          const totalHEl = document.getElementById(`${prefijo}-total-h`);
          const totalMEl = document.getElementById(`${prefijo}-total-m`);
          
          if (totalEl) totalEl.textContent = fila.total_ambos || '0';
          if (totalHEl) totalHEl.textContent = fila.total_hombres || '0';
          if (totalMEl) totalMEl.textContent = fila.total_mujeres || '0';
          
          console.log(`‚úÖ ${prefijo} totales actualizados`);
        }
      }
      
      if (fila.concepto.includes('Tabaquismo')) {
        // Actualizar solo bandas ‚â•55 a√±os para tabaquismo
        const bandasTabaq = ['55-59', '60-64', '65-69', '70-74', '75-79', '80+'];
        bandasTabaq.forEach(banda => {
          const bandaSinMas = banda.replace('+', '');
          const hombresEl = document.getElementById(`tabaq-${bandaSinMas}-h`);
          const mujeresEl = document.getElementById(`tabaq-${bandaSinMas}-m`);
          
          if (hombresEl && fila[`${banda}_h`] !== undefined) {
            hombresEl.textContent = fila[`${banda}_h`] || '0';
          }
          if (mujeresEl && fila[`${banda}_m`] !== undefined) {
            mujeresEl.textContent = fila[`${banda}_m`] || '0';
          }
        });
        console.log('‚úÖ Tabaquismo bandas actualizadas');
      }
    });

    if (status) {
      status.textContent = '‚úÖ Datos de Secci√≥n A cargados correctamente';
    }
    
  */

  if (!thead) {
      console.error('No se encontr√≥ el thead de la Secci√≥n A PSCV');
      return;
    }

    if (status) {
      status.textContent = 'Cargando datos de Secci√≥n A PSCV...';
    }
    let query = '';
    if(paramsFromChart instanceof URLSearchParams){
      query = paramsFromChart.toString();
    } else {
      const params = new URLSearchParams();
      const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
      const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
      const cEl = document.getElementById('categorias_select'); const c = cEl && cEl.value; if(c) params.set('categorias', c);
      const gEl = document.getElementById('grupo_etareo_select'); const g = gEl && gEl.value; if(g) params.set('grupos_etareos', g);
      const pEl = document.getElementById('patologia_filtro'); const p = pEl && pEl.value; if(p) params.set('patologias', p);
      const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
      const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
      query = params.toString();
    }

    // Intentar fuente principal (con bandas + filas por banda)
    let bandas = [];
    let filas = [];
    let principalOk = false;
    let origenBandas = '';
    try{
      // Construir query ANUAL a partir de los filtros actuales
      const qAnual = new URLSearchParams(query);
      const desde = document.getElementById('fecha_desde')?.value || '';
      const hasta = document.getElementById('fecha_hasta')?.value || '';
      const sectorSel = document.getElementById('sectores_select');
      const sectorId = sectorSel && sectorSel.value || '';
      
      console.log('üîç Filtros obtenidos del frontend:', { desde, hasta, sectorId });
      
      if(desde) qAnual.set('inicio', desde);
      if(hasta){
        try{
          const d = new Date(hasta); d.setDate(d.getDate()+1);
          const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0');
          qAnual.set('fin', `${y}-${m}-${dd}`);
        }catch(_){ /* noop */ }
        qAnual.set('fecha_corte', hasta);
      }
      
      // Construir URL con todos los filtros
      let urlParams = `fecha_desde=${desde || '2024-01-01'}&fecha_hasta=${hasta || '2025-12-31'}`;
      if (sectorId) {
        urlParams += `&sectores=${sectorId}`;
      }
      
      console.log('üîç URL construida para PSCV simple:', `/api/pscv_simple?${urlParams}`);
      const r = await fetch(`/api/pscv_simple?${urlParams}`, { credentials: 'same-origin' });
      console.log('Respuesta del endpoint:', r.status);
      if(r.ok){
        const j = await r.json();
        console.log('Datos recibidos:', j);
        if(j && j.success){
          bandas = j.bandas || [];
          filas = j.filas || [];
          principalOk = true;
          console.log('Datos procesados - bandas:', bandas.length, 'filas:', filas.length);
          if(bandas && bandas.length>0) origenBandas = 'pscv_simple';
        }
      }
      
      // Cargar tambi√©n los detalles de patolog√≠as espec√≠ficas
      let filasDetalle = [];
      try {
        const timestamp = Date.now();
        
        // Construir URL con todos los filtros para detalle
        let urlParamsDetalle = `fecha_desde=${desde || '2024-01-01'}&fecha_hasta=${hasta || '2025-12-31'}&t=${timestamp}`;
        if (sectorId) {
          urlParamsDetalle += `&sectores=${sectorId}`;
        }
        
        console.log('üîç URL construida para PSCV detalle:', `/api/pscv_detalle?${urlParamsDetalle}`);
        const rDetalle = await fetch(`/api/pscv_detalle?${urlParamsDetalle}`, { credentials: 'same-origin' });
        console.log('üîç Respuesta endpoint detalle:', rDetalle.status);
        if(rDetalle.ok){
          const jDetalle = await rDetalle.json();
          console.log('üîç Datos detalle recibidos:', jDetalle);
          if(jDetalle && jDetalle.success){
            filasDetalle = jDetalle.filas || [];
            console.log('üîç Filas de detalle:', filasDetalle.length);
            filasDetalle.forEach(fila => {
              console.log(`üìä ${fila.concepto}: ${fila.total_ambos} personas`);
            });
            // Combinar las filas de total PSCV con las de detalle
            filas = filas.concat(filasDetalle);
            console.log('üîç Filas combinadas - total:', filas.length);
          }
        }
      } catch(e) {
        console.error('‚ùå Error cargando detalles:', e);
      }
    }catch(_){ /* noop, probaremos fallback */ }

    // Si falla el endpoint anual, usar el anterior como respaldo
    if(!principalOk){
      try{
        const r = await fetch('/api/estadisticas/pscv_programa_bandas' + (query? ('?'+query):''), { credentials: 'same-origin' });
        if(r.ok){
          const j = await r.json();
          if(j && j.success){
            bandas = j.bandas || [];
            filas = j.filas || [];
            principalOk = true;
            if(bandas && bandas.length>0) origenBandas = 'pscv_programa_bandas';
          }
        }
      }catch(_){ /* noop, probaremos fallback */ }
    }

    // Fallback: derivar bandas desde pscv_matriz y totales desde pscv_resumen
    if(!principalOk){
      try{
        const [rm, rr] = await Promise.all([
          fetch('/api/estadisticas/pscv_matriz' + (query? ('?'+query):''), { credentials: 'same-origin' }),
          fetch('/api/estadisticas/pscv_resumen' + (query? ('?'+query):''), { credentials: 'same-origin' })
        ]);
        if(rm.ok){
          const jm = await rm.json();
          if(jm && jm.success){
            bandas = (jm.matriz||[]).map(x => x.banda);
            if(bandas && bandas.length>0) origenBandas = 'pscv_matriz';
          }
        }
        if(rr.ok){
          const jr = await rr.json();
          if(jr && jr.success){
            const riesgo = jr.riesgo||[];
            const fac = jr.factores||[];
            // Construir "filas" con solo totales y sin por_banda (queda vac√≠o, se muestran celdas vac√≠as)
            const pushFila = (nombre, fuenteArr) => {
              const row = fuenteArr.find(x => x.item === nombre);
              filas.push({
                item: nombre,
                totales: { ambos: num(row?.ambos||0), hombres: num(row?.hombres||0), mujeres: num(row?.mujeres||0) },
                por_banda: {}
              });
            };
            ['Bajo','Moderado','Alto'].forEach(n => pushFila(n, riesgo));
            [
              'Hipertensi√≥n Arterial','Diabetes Mellitus tipo 2','Dislipidemia',
              'Tabaquismo ‚â• 55 a√±os',
              'Antecedentes de Infarto Agudo al Miocardio (IAM)',
              'Antecedentes de Ataque Cerebro Vascular (ACV)',
              'Antecedentes de otras Enfermedades Cardiovasculares ECV (excepto IAM y ACV)',
              'Enfermedad renal cr√≥nica (etapas 1 a 5)'
            ].forEach(n => pushFila(n, fac));
          }
        }
      }catch(_){ /* si falla totalmente, seguiremos con arrays vac√≠os y mostraremos error abajo */ }
    }

    // Fallback extra: si a√∫n no hay bandas, intentar leerlas desde la tabla PSCV ya renderizada en el DOM
    if(!bandas || bandas.length === 0){
      try{
        const filasPscv = Array.from(document.querySelectorAll('#pscv-body tr'));
        const labels = [];
        const seen = new Set();
        filasPscv.forEach(tr => {
          const c0 = tr.querySelector('td');
          if(c0){
            const txt = (c0.textContent||'').trim();
            if(txt && !seen.has(txt)){
              seen.add(txt);
              labels.push(txt);
            }
          }
        });
        if(labels.length>0){ bandas = labels; origenBandas = 'tabla_pscv_dom'; }
      }catch(_){ /* noop */ }
    }

    // Fallback final: utilizar bandas por defecto para que el encabezado siempre sea visible
    if(!bandas || bandas.length === 0){
      bandas = BANDAS_PSCV_DEFAULT.slice();
      origenBandas = 'bandas_default';
    }

    // Encabezado de 3 niveles para alinear con planilla (RANGO ETARIO Y SEXO)
    const headerTop = document.createElement('tr');
    const bandGroupTop = bandas.length > 0 ? `<th scope="colgroup" class="sep-total" colspan="${bandas.length * 2}">RANGO ETARIO Y SEXO</th>` : '';
    headerTop.innerHTML = `
      <th scope="col" rowspan="3" class="sticky-col sticky-col-shadow concept-col">CONCEPTO</th>
      <th scope="colgroup" colspan="3">TOTAL</th>
      ${bandGroupTop}
      <th scope="colgroup" class="sep-po" colspan="2">Pueblos Originarios</th>
      <th scope="colgroup" class="sep-mig" colspan="2">Migrantes</th>
    `;
    const headerMid = document.createElement('tr');
    const bandGroupMid = bandas.length > 0 ? bandas.map((b,i) => `<th scope="colgroup" colspan="2" class="${i===0 ? 'sep-total' : ''}">${b} a√±os</th>`).join('') : '';
    headerMid.innerHTML = `
      <th scope="col">Ambos sexos</th><th scope="col">Hombres</th><th scope="col">Mujeres</th>
      ${bandGroupMid}
      <th scope="col" class="sep-po">Hombres</th><th scope="col">Mujeres</th>
      <th scope="col" class="sep-mig">Hombres</th><th scope="col">Mujeres</th>
    `;
    const headerBot = document.createElement('tr');
    const leftPlaceholders = Array(3).fill('<th scope="col" style="visibility:hidden"></th>').join('');
    const bandGroupBot = bandas.length > 0 ? bandas.map((_,i) => `<th scope="col" class="${i===0 ? 'sep-total' : ''}">Hombres</th><th scope="col">Mujeres</th>`).join('') : '';
    const rightPlaceholders = Array(4).fill('<th scope="col" style="visibility:hidden"></th>').join('');
    headerBot.innerHTML = `
      ${leftPlaceholders}
      ${bandGroupBot}
      ${rightPlaceholders}
    `;
    thead.innerHTML = '';
    thead.appendChild(headerTop);
    thead.appendChild(headerMid);
    thead.appendChild(headerBot);

    // Convertir datos del endpoint a formato compatible
    const filasMap = new Map();
    filas.forEach(f => {
      filasMap.set(f.concepto, f);
    });

    console.log('Datos procesados en mapa:', filasMap);

    // En lugar de reemplazar toda la tabla, actualizar los valores en los IDs existentes
    // 1. Actualizar datos de PSCV usando las filas recibidas previamente (ya existen IDs en DOM)
    const filaPscv = filasMap.get('N√∫mero de personas en PSCV') || {};
    console.log('üîç filaPscv desde filasMap:', filaPscv);
    
    // ‚ö†Ô∏è COMENTADO: Esta parte sobrescribe nuestros valores correctos con 0s
    // const pscvTotalEl = document.getElementById('pscv-total');
    // const pscvTotalHEl = document.getElementById('pscv-total-h');
    // const pscvTotalMEl = document.getElementById('pscv-total-m');
    // if (pscvTotalEl) pscvTotalEl.textContent = num(filaPscv.total_ambos || 0);
    // if (pscvTotalHEl) pscvTotalHEl.textContent = num(filaPscv.total_hombres || 0);
    // if (pscvTotalMEl) pscvTotalMEl.textContent = num(filaPscv.total_mujeres || 0);
    console.log('‚ö†Ô∏è SOBRESCRITURA DE PSCV COMENTADA - manteniendo valores correctos');
    
    // Actualizar bandas de PSCV (si tenemos datos)
    if (filaPscv && filaPscv.por_banda) {
      bandas.forEach(banda => {
        const bandaId = banda.replace('+', '-mas');
        const hEl = document.getElementById(`pscv-${bandaId}-h`);
        const mEl = document.getElementById(`pscv-${bandaId}-m`);
        if (hEl && filaPscv.por_banda[banda]) hEl.textContent = filaPscv.por_banda[banda].hombres || 0;
        if (mEl && filaPscv.por_banda[banda]) mEl.textContent = filaPscv.por_banda[banda].mujeres || 0;
      });
    }
    
    // Actualizar patolog√≠as espec√≠ficas usando nuestros datos del endpoint de detalle
    const patologiasMap = {
      'Hipertensi√≥n Arterial': 'hta',
      'Diabetes Mellitus tipo 2': 'dm2', 
      'Dislipidemia': 'dislip',
      'Antecedentes de Infarto Agudo al Miocardio (IAM)': 'iam-ant',
      'Antecedentes de Ataque Cerebro Vascular (ACV)': 'acv-ant',
      'Antecedentes de otras Enfermedades Cardiovasculares ECV': 'ecv-ant'
    };
    
    console.log('üîÑ Actualizando patolog√≠as espec√≠ficas...');
    console.log('üîç filasMap contiene:', Array.from(filasMap.keys()));
    Object.keys(patologiasMap).forEach(concepto => {
      const prefijo = patologiasMap[concepto];
      const filaPatologia = filasMap.get(concepto);
      
      console.log(`üîç Buscando "${concepto}" -> prefijo: ${prefijo} -> encontrado:`, !!filaPatologia);
      
      if (filaPatologia) {
        console.log(`‚úÖ Actualizando ${concepto}:`, filaPatologia.total_ambos);
        
        // Actualizar totales
        const totalEl = document.getElementById(`${prefijo}-total`);
        const totalHEl = document.getElementById(`${prefijo}-total-h`);
        const totalMEl = document.getElementById(`${prefijo}-total-m`);
        
        console.log(`üîç Elementos DOM encontrados: total=${!!totalEl}, h=${!!totalHEl}, m=${!!totalMEl}`);
        
        if (totalEl) {
          const valorAnterior = totalEl.textContent;
          totalEl.textContent = filaPatologia.total_ambos || 0;
          console.log(`‚úÖ ${prefijo}-total: ${valorAnterior} -> ${filaPatologia.total_ambos}`);
        }
        if (totalHEl) {
          const valorAnterior = totalHEl.textContent;
          totalHEl.textContent = filaPatologia.total_hombres || 0;
          console.log(`‚úÖ ${prefijo}-total-h: ${valorAnterior} -> ${filaPatologia.total_hombres}`);
        }
        if (totalMEl) {
          const valorAnterior = totalMEl.textContent;
          totalMEl.textContent = filaPatologia.total_mujeres || 0;
          console.log(`‚úÖ ${prefijo}-total-m: ${valorAnterior} -> ${filaPatologia.total_mujeres}`);
        }
        
        // Actualizar por bandas
        if (filaPatologia.por_banda) {
          bandas.forEach(banda => {
            const bandaId = banda.replace('+', '-mas');
            const hEl = document.getElementById(`${prefijo}-${bandaId}-h`);
            const mEl = document.getElementById(`${prefijo}-${bandaId}-m`);
            
            if (hEl && filaPatologia.por_banda[banda]) {
              hEl.textContent = filaPatologia.por_banda[banda].hombres || 0;
            }
            if (mEl && filaPatologia.por_banda[banda]) {
              mEl.textContent = filaPatologia.por_banda[banda].mujeres || 0;
            }
          });
        }
      } else {
        console.warn(`‚ö†Ô∏è No se encontraron datos para: ${concepto}`);
      }
    });
    
    // Programar verificaci√≥n despu√©s de 5 segundos para detectar si se sobrescriben
    setTimeout(() => {
      console.log('üïê VERIFICACI√ìN DESPU√âS DE 5 SEGUNDOS:');
      Object.keys(patologiasMap).forEach(concepto => {
        const prefijo = patologiasMap[concepto];
        const totalEl = document.getElementById(`${prefijo}-total`);
        const filaOriginal = filasMap.get(concepto);
        if (totalEl && filaOriginal) {
          const valorActual = totalEl.textContent;
          const valorEsperado = String(filaOriginal.total_ambos || 0);
          if (valorActual !== valorEsperado) {
            console.warn(`‚ö†Ô∏è ${concepto} fue sobrescrito! Esperado: ${valorEsperado}, Actual: ${valorActual}`);
          } else {
            console.log(`‚úÖ ${concepto} mantiene valor correcto: ${valorActual}`);
          }
        }
      });
    }, 5000);

    // 2. Actualizar datos de clasificaci√≥n de riesgo
    ['Bajo', 'Moderado', 'Alto'].forEach(riesgo => {
      const filaRiesgo = filasMap.get(riesgo) || {};
      const riesgoId = riesgo.toLowerCase();
      
      // Actualizar totales
      const totalEl = document.getElementById(`riesgo-${riesgoId === 'bajo' ? 'bajo' : (riesgoId === 'moderado' ? 'mod' : 'alto')}-total`);
      const totalHEl = document.getElementById(`riesgo-${riesgoId === 'bajo' ? 'bajo' : (riesgoId === 'moderado' ? 'mod' : 'alto')}-total-h`);
      const totalMEl = document.getElementById(`riesgo-${riesgoId === 'bajo' ? 'bajo' : (riesgoId === 'moderado' ? 'mod' : 'alto')}-total-m`);
      
      if (totalEl) totalEl.textContent = num(filaRiesgo.total_ambos || 0);
      if (totalHEl) totalHEl.textContent = num(filaRiesgo.total_hombres || 0);
      if (totalMEl) totalMEl.textContent = num(filaRiesgo.total_mujeres || 0);
      
      // Actualizar bandas etarias para riesgo
      bandas.forEach(banda => {
        const bandaId = banda.replace('+', '-mas');
        const prefijo = riesgoId === 'bajo' ? 'bajo' : (riesgoId === 'moderado' ? 'mod' : 'alto');
        const hombresId = `riesgo-${prefijo}-${bandaId}-h`;
        const mujeresId = `riesgo-${prefijo}-${bandaId}-m`;
        
        const hombresEl = document.getElementById(hombresId);
        const mujeresEl = document.getElementById(mujeresId);
        
        if (hombresEl) hombresEl.textContent = num(filaRiesgo[`${banda}_h`] || 0);
        if (mujeresEl) mujeresEl.textContent = num(filaRiesgo[`${banda}_m`] || 0);
      });
    });

    // 3. Actualizar datos de Tabaquismo ‚â• 55 a√±os (si existe)
    const filaTabaquismo = filasMap.get('Tabaquismo ‚â• 55 a√±os') || {};
    
    // Tabaquismo solo tiene datos para bandas ‚â•55 a√±os
    const bandasTabaquismo = ['55-59', '60-64', '65-69', '70-74', '75-79', '80+'];

    
    console.log('üéâ Secci√≥n A actualizada correctamente - FINALIZADA');
    
  } catch (error) {
    console.error('‚ùå Error al cargar Secci√≥n A:', error);
    if (status) {
      status.textContent = '‚ùå Error al cargar Secci√≥n A: ' + error.message;
    }
  }
}

// Ajusta la primera columna (CONCEPTO) al ancho del texto m√°s largo sin exceder un m√°ximo
function ajustarAnchoConceptoStickyCols(){
  try{
    const celdas = document.querySelectorAll('th.sticky-col.concept-col, td.sticky-col.concept-col');
    if(!celdas || celdas.length===0) return;
    let max = 0;
    celdas.forEach(el => {
      // Usar scrollWidth para aproximar el ancho del contenido
      max = Math.max(max, el.scrollWidth);
    });
    // Agregar margen por padding interno y bordes
    const ancho = Math.min(Math.max(max + 24, 280), 520); // entre 280 y 520 px
    celdas.forEach(el => {
      el.style.width = ancho + 'px';
      el.style.minWidth = ancho + 'px';
      el.style.maxWidth = ancho + 'px';
    });
  }catch(_){ /* noop */ }
}

// Exporta una tabla HTML a un worksheet y lo agrega a un workbook
function exportarTablaAExcel(selector, sheetName, wb){
  try{
    const table = document.querySelector(selector);
    if(!table) return;
    const ws = XLSX.utils.table_to_sheet(table, {raw:true});
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  }catch(_){ /* noop */ }
}

// ===================== P5 SECCI√ìN B: Estado Nutricional (din√°mica desde backend) =====================
async function cargarP5SeccionBEstadoNutricional(){
  const thead = document.getElementById('p5b-head');
  const tbody = document.getElementById('p5b-body');
  const status = document.getElementById('p5b-status');
  try{
    if(status) status.textContent = 'Cargando‚Ä¶';
    if(!thead || !tbody) return;

    const params = new URLSearchParams();
    const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
    const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
    const cEl = document.getElementById('categorias_select'); const c = cEl && cEl.value; if(c) params.set('categorias', c);
    const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
    const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
    // Mapear filtros de fecha a ventana anual del backend (inicio, fin excl, fecha_corte)
    if(desde) params.set('inicio', desde);
    if(hasta){
      try{
        const d = new Date(hasta); d.setDate(d.getDate()+1);
        const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
        params.set('fin', `${y}-${m}-${dd}`);
      }catch(_){ /* noop */ }
      params.set('fecha_corte', hasta);
    }
    appendRemParams(params);

    let bandas = [];
    let filas = [];
    let ok = false;
    try{
      const r = await fetch('/api/estadisticas/p5_estado_nutricional_anual' + (params.toString()? ('?'+params.toString()):''), { credentials: 'same-origin' });
      if(r.ok){
        const j = await r.json();
        if(j && j.success){
          bandas = j.bandas || [];
          const raw = j.filas || [];
          // Normalizar como en EFAM: condicion->item, por_tramo->por_banda.
          // Para PO/MIG usar desagregados por sexo si vienen del backend; si no, caer a totales como antes.
          filas = raw.map(f => {
            const por_banda = {};
            const src = f.por_tramo || {};
            for(const [b, v] of Object.entries(src)){
              por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
            }
            const po_h = (f.pueblos_originarios_hombres ?? f.pueblos_originarios) || 0;
            const po_m = (f.pueblos_originarios_mujeres ?? 0);
            const mig_h = (f.migrantes_hombres ?? f.migrantes) || 0;
            const mig_m = (f.migrantes_mujeres ?? 0);
            return {
              item: f.condicion,
              totales: f.totales || {ambos:0,hombres:0,mujeres:0},
              por_banda,
              po: {hombres: po_h, mujeres: po_m},
              mig: {hombres: mig_h, mujeres: mig_m}
            };
          });
          ok = true;
        }
      }
    }catch(_){ ok = false; }

    if(!bandas || bandas.length===0){ bandas = P5_BANDAS_DEFAULT.slice(); }

    // Encabezado multi-nivel
    const h1 = document.createElement('tr');
    h1.innerHTML = `
      <th scope="col" rowspan="3" class="sticky-col sticky-col-shadow concept-col">ESTADO NUTRICIONAL</th>
      <th scope="colgroup" colspan="3">TOTAL</th>
      <th scope="colgroup" class="sep-total" colspan="${bandas.length*2}">RANGO ETARIO Y SEXO</th>
      <th scope="colgroup" class="sep-po" colspan="2">Pueblos Originarios</th>
      <th scope="colgroup" class="sep-mig" colspan="2">Migrantes</th>`;
    const h2 = document.createElement('tr');
    h2.innerHTML = `
      <th scope="col">Ambos sexos</th><th scope="col">Hombres</th><th scope="col">Mujeres</th>
      ${bandas.map((b,i)=>`<th scope=\"colgroup\" colspan=\"2\" class=\"${i===0?'sep-total band-60-64':'band-65plus'}\">${p5DisplayBandLabel(b)}</th>`).join('')}
      <th scope="col" class="sep-po">Hombres</th><th scope="col">Mujeres</th>
      <th scope="col" class="sep-mig">Hombres</th><th scope="col">Mujeres</th>`;
    const h3 = document.createElement('tr');
    h3.innerHTML = `
      ${Array(3).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}
      ${bandas.map((_,i)=>`<th scope="col" class="${i===0?'sep-total':''}">Hombres</th><th scope="col">Mujeres</th>`).join('')}
      ${Array(4).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}`;
    thead.innerHTML=''; thead.appendChild(h1); thead.appendChild(h2); thead.appendChild(h3);

    // Orden esperado
    const mapExact = new Map((filas||[]).map(f => [f.item, f]));
    const mapLoose = new Map((filas||[]).map(f => [keyizeLabel(f.item), f]));
    function getRow(names){
      const list = Array.isArray(names) ? names : [names];
      for(const name of list){
        let r = mapExact.get(name) || mapLoose.get(keyizeLabel(name)) || null;
        if(!r && name==='TOTAL (EFAM)'){
          r = mapExact.get('SUBTOTAL (EFAM)') || mapLoose.get(keyizeLabel('SUBTOTAL (EFAM)')) || null;
        }
        if(r) return r;
      }
      return null;
    }

    const makeEmptyRow = () => ({
      totales: { ambos: 0, hombres: 0, mujeres: 0 },
      por_banda: bandas.reduce((acc, b) => {
        acc[b] = { hombres: 0, mujeres: 0 };
        return acc;
      }, {}),
      po: { hombres: 0, mujeres: 0 },
      mig: { hombres: 0, mujeres: 0 }
    });

    const mergeRowData = (base, row) => {
      if(!row) return;
      const tot = row.totales || {};
      base.totales.hombres += num(tot.hombres ?? tot.total_hombres ?? tot.masculino ?? 0);
      base.totales.mujeres += num(tot.mujeres ?? tot.total_mujeres ?? tot.femenino ?? 0);
      base.totales.ambos += num(tot.ambos ?? tot.total ?? tot.total_ambos ?? 0);
      bandas.forEach(b => {
        const src = (row.por_banda && row.por_banda[b]) || (row.por_tramo && row.por_tramo[b]) || {};
        base.por_banda[b].hombres += num(src.hombres ?? src.h ?? src.masculino ?? 0);
        base.por_banda[b].mujeres += num(src.mujeres ?? src.m ?? src.femenino ?? 0);
      });
      const po = row.po || {};
      base.po.hombres += num(po.hombres ?? po.masculino ?? 0);
      base.po.mujeres += num(po.mujeres ?? po.femenino ?? 0);
      const mig = row.mig || {};
      base.mig.hombres += num(mig.hombres ?? mig.masculino ?? 0);
      base.mig.mujeres += num(mig.mujeres ?? mig.femenino ?? 0);
    };

    const buildAggregateRow = (names) => {
      const agg = makeEmptyRow();
      let found = false;
      names.forEach(n => {
        const row = getRow(n);
        if(row){
          found = true;
          mergeRowData(agg, row);
        }
      });
      return found ? agg : null;
    };

    const orden = [
      { display: 'Bajo peso', keys: ['Bajo peso'] },
      { display: 'Normal', keys: ['Normal'] },
      { display: 'Sobrepeso', keys: ['Sobrepeso'] },
      { display: 'Obeso', keys: ['Obeso'] },
      {
        display: 'TOTAL',
        keys: ['TOTAL'],
        aggregateFrom: ['Bajo peso','Normal','Sobrepeso','Obeso']
      }
    ];

    tbody.innerHTML='';
    for(const entry of orden){
  let r = getRow(entry.keys);
      if(!r && entry.aggregateFrom){
        r = buildAggregateRow(entry.aggregateFrom);
        if(r){
          r.item = entry.display;
        }
      }
      const safeRow = r || makeEmptyRow();
      const isTotal = entry.display === 'TOTAL';
      const tr = document.createElement('tr');
      const celdasBand = bandas.map((b,i)=>{
        const pb = safeRow?.por_banda?.[b] || {hombres:0, mujeres:0};
        return `<td class="${i===0?'sep-total':''}">${num(pb.hombres||0)}</td><td>${num(pb.mujeres||0)}</td>`;
      }).join('');
      tr.innerHTML = `
        <th scope="row" class="sticky-col sticky-col-shadow concept-col ${isTotal?'fw-semibold':''}">${entry.display}</th>
        <td class="sep-total">${num(safeRow.totales?.ambos||0)}</td><td>${num(safeRow.totales?.hombres||0)}</td><td>${num(safeRow.totales?.mujeres||0)}</td>
        ${celdasBand}
        <td class="sep-po">${num(safeRow.po?.hombres||0)}</td><td>${num(safeRow.po?.mujeres||0)}</td>
        <td class="sep-mig">${num(safeRow.mig?.hombres||0)}</td><td>${num(safeRow.mig?.mujeres||0)}</td>`;
      tbody.appendChild(tr);
    }

    if(status) status.textContent = ok ? '' : 'Sin datos (se muestran 0)';
    ajustarAnchoConceptoStickyCols();
  }catch(e){
    console.error('P5 estado nutricional error', e);
    if(status) status.textContent = 'No se pudo cargar P5 Secci√≥n B';
  }
}

// ===================== Secci√≥n C: Personas mayores con sospecha de maltrato (din√°mica) =====================
async function cargarP5SeccionCMaltrato(){
  const thead = document.getElementById('p5c-head');
  const tbody = document.getElementById('p5c-body');
  const status = document.getElementById('p5c-status');
  try{
    if(status) status.textContent = 'Cargando‚Ä¶';
    if(!thead || !tbody) return;

    const params = new URLSearchParams();
    const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
    const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
    const cEl = document.getElementById('categorias_select'); const c = cEl && cEl.value; if(c) params.set('categorias', c);
    const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
    const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
    // Mapear a ventana anual
    if(desde) params.set('inicio', desde);
    if(hasta){
      try{
        const d = new Date(hasta); d.setDate(d.getDate()+1);
        const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
        params.set('fin', `${y}-${m}-${dd}`);
      }catch(_){ /* noop */ }
      params.set('fecha_corte', hasta);
    }
    appendRemParams(params);

    let bandas = [];
    let filas = [];
    let ok = false;
    try{
      const r = await fetch('/api/estadisticas/p5_sospecha_maltrato_anual' + (params.toString()? ('?'+params.toString()):''), { credentials: 'same-origin' });
      if(r.ok){
        const j = await r.json();
        if(j && j.success){
          bandas = j.bandas||[];
          const raw = j.filas||[];
          // Normalizar estructura: por_tramo -> por_banda, extras totales como placeholders H/M
          filas = raw.map(f => {
            const por_banda = {};
            const src = f.por_tramo || {};
            for(const [b, v] of Object.entries(src)){
              por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
            }
            // Preferir desagregados por sexo si existen; si no, usar total como hombres y 0 mujeres (placeholder)
            const po_h = (f.pueblos_originarios_hombres ?? f.pueblos_originarios) || 0;
            const po_m = (f.pueblos_originarios_mujeres ?? 0) || 0;
            const mig_h = (f.migrantes_hombres ?? f.migrantes) || 0;
            const mig_m = (f.migrantes_mujeres ?? 0) || 0;
            const eleam_h = (f.personas_mayores_en_eleam_hombres ?? f.personas_mayores_en_eleam) || 0;
            const eleam_m = (f.personas_mayores_en_eleam_mujeres ?? 0) || 0;
            return {
              item: f.item || 'Personas con sospecha de maltrato',
              totales: f.totales || {ambos:0,hombres:0,mujeres:0},
              por_banda,
              po: {hombres: po_h, mujeres: po_m},
              mig: {hombres: mig_h, mujeres: mig_m},
              eleam: {hombres: eleam_h, mujeres: eleam_m}
            };
          });
          ok = true;
        }
      }
    }catch(_){ ok = false; }

    if(!bandas || bandas.length===0){ bandas = P5_BANDAS_DEFAULT.slice(); }

    const h1 = document.createElement('tr');
    h1.innerHTML = `
      <th scope="col" rowspan="3" class="sticky-col sticky-col-shadow concept-col">CONCEPTO</th>
      <th scope="colgroup" colspan="3">TOTAL</th>
  <th scope="colgroup" class="sep-total" colspan="${bandas.length*2}">RANGO ETARIO Y SEXO</th>
  <th scope="colgroup" class="sep-po" colspan="2">Pueblos Originarios</th>
  <th scope="colgroup" class="sep-mig" colspan="2">Migrantes</th>
  <th scope="colgroup" class="sep-eleam" colspan="2">Personas mayores en ELEAM</th>`;
    const h2 = document.createElement('tr');
    h2.innerHTML = `
      <th scope="col">Ambos sexos</th><th scope="col">Hombres</th><th scope="col">Mujeres</th>
      ${bandas.map((b,i)=>`<th scope=\"colgroup\" colspan=\"2\" class=\"${i===0?'sep-total':''}\">${b}</th>`).join('')}
  <th scope="col" class="sep-po">Hombres</th><th scope="col">Mujeres</th>
  <th scope="col" class="sep-mig">Hombres</th><th scope="col">Mujeres</th>
  <th scope="col" class="sep-eleam">Hombres</th><th scope="col">Mujeres</th>`;
    const h3 = document.createElement('tr');
    h3.innerHTML = `
      ${Array(3).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}
      ${bandas.map((_,i)=>`<th scope="col" class="${i===0?'sep-total':''}">Hombres</th><th scope="col">Mujeres</th>`).join('')}
  ${Array(6).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}`;
    thead.innerHTML=''; thead.appendChild(h1); thead.appendChild(h2); thead.appendChild(h3);

  const r = (filas && filas[0]) || null;
  const tot = r?.totales || {ambos:0,hombres:0,mujeres:0};
  const po = r?.po || {hombres:0, mujeres:0};
  const mig = r?.mig || {hombres:0, mujeres:0};
  const eleam = r?.eleam || {hombres:0, mujeres:0};
    tbody.innerHTML='';
    const celdasBand = bandas.map((b,i)=>{
      const pb = r?.por_banda?.[b] || {hombres:0, mujeres:0};
      return `<td class="${i===0?'sep-total':''}">${num(pb.hombres||0)}</td><td>${num(pb.mujeres||0)}</td>`;
    }).join('');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <th scope="row" class="sticky-col sticky-col-shadow concept-col">Personas con sospecha de maltrato</th>
      <td class="sep-total">${num(tot.ambos||0)}</td><td>${num(tot.hombres||0)}</td><td>${num(tot.mujeres||0)}</td>
      ${celdasBand}
  <td class="sep-po">${num(po.hombres||0)}</td><td>${num(po.mujeres||0)}</td>
  <td class="sep-mig">${num(mig.hombres||0)}</td><td>${num(mig.mujeres||0)}</td>
  <td class="sep-eleam">${num(eleam.hombres||0)}</td><td>${num(eleam.mujeres||0)}</td>`;
    tbody.appendChild(tr);

    if(status) status.textContent = ok ? '' : 'Sin datos (se muestran 0)';
    ajustarAnchoConceptoStickyCols();
  }catch(e){
    console.error('P5 C maltrato error', e);
    if(status) status.textContent = 'No se pudo cargar P5 Secci√≥n C';
  }
}

// ===================== Secci√≥n D: Personas mayores en actividad f√≠sica (din√°mica desde backend) =====================
async function cargarP5SeccionDActividadFisica(){
  const thead = document.getElementById('p5d-head');
  const tbody = document.getElementById('p5d-body');
  const status = document.getElementById('p5d-status');
  try{
    if(status) status.textContent = 'Cargando‚Ä¶';
    if(!thead || !tbody) return;

    // Construir query con filtros + par√°metros REM-P
    const params = new URLSearchParams();
    const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
    const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
    const cEl = document.getElementById('categorias_select'); const c = cEl && cEl.value; if(c) params.set('categorias', c);
    const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
    const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
    // Mapear a ventana anual
    if(desde) params.set('inicio', desde);
    if(hasta){
      try{
        const d = new Date(hasta); d.setDate(d.getDate()+1);
        const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
        params.set('fin', `${y}-${m}-${dd}`);
      }catch(_){ /* noop */ }
      params.set('fecha_corte', hasta);
    }
    appendRemParams(params);

    // Llamada al endpoint
    let bandas = [];
    let filas = [];
    let ok = false;
    try{
      const r = await fetch('/api/estadisticas/p5_actividad_fisica_anual' + (params.toString()? ('?'+params.toString()):''), { credentials: 'same-origin' });
      if(r.ok){
        const j = await r.json();
        if(j && j.success){
          bandas = j.bandas || [];
          const raw = j.filas || [];
          // Normalizar estructura: preferir por_banda si viene; si no, convertir por_tramo.
          // Extras: preferir f.po/f.mig (desagregado H/M). Fallback a totales antiguos si no existen.
          filas = raw.map(f => {
            // por_banda normalizado
            let por_banda = {};
            if (f.por_banda && typeof f.por_banda === 'object') {
              for (const [b, v] of Object.entries(f.por_banda)) {
                por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
              }
            } else if (f.por_tramo && typeof f.por_tramo === 'object') {
              for (const [b, v] of Object.entries(f.por_tramo)) {
                por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
              }
            }
            // Extras normalizados (preferir desagregados por sexo del backend)
            const po_h = (f.pueblos_originarios_hombres ?? f.po?.hombres ?? f.pueblos_originarios) || 0;
            const po_m = (f.pueblos_originarios_mujeres ?? f.po?.mujeres ?? 0) || 0;
            const mig_h = (f.migrantes_hombres ?? f.mig?.hombres ?? f.migrantes) || 0;
            const mig_m = (f.migrantes_mujeres ?? f.mig?.mujeres ?? 0) || 0;
            const eleam_h = (f.personas_mayores_en_eleam_hombres ?? f.eleam?.hombres ?? f.personas_mayores_en_eleam) || 0;
            const eleam_m = (f.personas_mayores_en_eleam_mujeres ?? f.eleam?.mujeres ?? 0) || 0;
            return {
              item: f.item || 'Personas en actividad f√≠sica',
              totales: f.totales || {ambos:0,hombres:0,mujeres:0},
              por_banda,
              po: {hombres: po_h, mujeres: po_m},
              mig: {hombres: mig_h, mujeres: mig_m},
              eleam: {hombres: eleam_h, mujeres: eleam_m}
            };
          });
          ok = true;
        }
      }
    }catch(_){ ok = false; }

    if(!bandas || bandas.length===0){ bandas = P5_BANDAS_DEFAULT.slice(); }

    // Encabezado 3 niveles
    const h1 = document.createElement('tr');
    h1.innerHTML = `
      <th rowspan="3" class="sticky-col sticky-col-shadow concept-col">CONCEPTO</th>
  <th colspan="3">TOTAL</th>
  <th class="sep-total" colspan="${bandas.length*2}">RANGO ETARIO Y SEXO</th>
  <th class="sep-po" colspan="2">Pueblos Originarios</th>
  <th class="sep-mig" colspan="2">Migrantes</th>
  <th class="sep-eleam" colspan="2">Personas mayores en ELEAM</th>`;
    const h2 = document.createElement('tr');
    h2.innerHTML = `
    <th>Ambos sexos</th><th>Hombres</th><th>Mujeres</th>
  ${bandas.map((b,i)=>`<th colspan=\"2\" class=\"${i===0?'sep-total':''}\">${p5DisplayBandLabel(b)}</th>`).join('')}
    <th class="sep-po">Hombres</th><th>Mujeres</th>
    <th class="sep-mig">Hombres</th><th>Mujeres</th>
    <th class="sep-eleam">Hombres</th><th>Mujeres</th>`;
    const h3 = document.createElement('tr');
    h3.innerHTML = `
      ${Array(3).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}
      ${bandas.map((_,i)=>`<th scope="col" class="${i===0?'sep-total':''}">Hombres</th><th scope="col">Mujeres</th>`).join('')}
  ${Array(6).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}`;
    thead.innerHTML=''; thead.appendChild(h1); thead.appendChild(h2); thead.appendChild(h3);

    // Render fila √∫nica
    const r = (filas && filas[0]) || null;
    const tot = r?.totales || {ambos:0,hombres:0,mujeres:0};
  const po = r?.po || {hombres:0, mujeres:0};
  const mig = r?.mig || {hombres:0, mujeres:0};
  const eleam = r?.eleam || {hombres:0, mujeres:0};
    tbody.innerHTML='';
    const celdasBand = bandas.map((b,i)=>{
      const pb = r?.por_banda?.[b] || {hombres:0, mujeres:0};
      return `<td class="${i===0?'sep-total':''}">${num(pb.hombres||0)}</td><td>${num(pb.mujeres||0)}</td>`;
    }).join('');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <th scope="row" class="sticky-col sticky-col-shadow concept-col">Personas en actividad f√≠sica</th>
      <td class="sep-total">${num(tot.ambos||0)}</td><td>${num(tot.hombres||0)}</td><td>${num(tot.mujeres||0)}</td>
      ${celdasBand}
  <td class="sep-po">${num(po.hombres||0)}</td><td>${num(po.mujeres||0)}</td>
  <td class="sep-mig">${num(mig.hombres||0)}</td><td>${num(mig.mujeres||0)}</td>
  <td class="sep-eleam">${num(eleam.hombres||0)}</td><td>${num(eleam.mujeres||0)}</td>`;
    tbody.appendChild(tr);

    if(status) status.textContent = ok ? '' : 'Sin datos (se muestran 0)';
    ajustarAnchoConceptoStickyCols();
  }catch(e){
    console.error('P5 D actividad f√≠sica error', e);
    if(status) status.textContent = 'No se pudo cargar P5 Secci√≥n D';
  }
}

// ===================== Secci√≥n E: Personas mayores con riesgo de ca√≠das (din√°mica desde backend) =====================
async function cargarP5SeccionERiesgoCaidas(){
  const thead = document.getElementById('p5e-head');
  const tbody = document.getElementById('p5e-body');
  const status = document.getElementById('p5e-status');
  try{
    if(status) status.textContent = 'Cargando‚Ä¶';
    if(!thead || !tbody) return;

    // Construir query con filtros + par√°metros REM-P
    const params = new URLSearchParams();
    const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
    const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
    const cEl = document.getElementById('categorias_select'); const c = cEl && cEl.value; if(c) params.set('categorias', c);
    const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
    const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
    // Mapear a ventana anual [inicio, fin_excl) y fecha_corte
    if(desde) params.set('inicio', desde);
    if(hasta){
      try{
        const d = new Date(hasta); d.setDate(d.getDate()+1);
        const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
        params.set('fin', `${y}-${m}-${dd}`);
      }catch(_){ /* noop */ }
      params.set('fecha_corte', hasta);
    }
    appendRemParams(params);

    // Llamar API
    let bandas = [];
    let filas = [];
    let ok = false;
    try{
  const r = await fetch('/api/estadisticas/p5_riesgo_caidas_anual' + (params.toString()? ('?'+params.toString()):''), { credentials: 'same-origin' });
      if(r.ok){
        const j = await r.json();
        if(j && j.success){
          bandas = j.bandas || [];
          const raw = j.filas || [];
          // Normalizar filas: asegurar por_banda y extras desagregados por sexo cuando existan
          filas = raw.map(f => {
            // por_banda normalizado
            let por_banda = {};
            if (f.por_banda && typeof f.por_banda === 'object') {
              for (const [b, v] of Object.entries(f.por_banda)) {
                por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
              }
            } else if (f.por_tramo && typeof f.por_tramo === 'object') {
              for (const [b, v] of Object.entries(f.por_tramo)) {
                por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
              }
            }
            // Extras normalizados
            const po_h = (f.pueblos_originarios_hombres ?? f.po?.hombres ?? f.pueblos_originarios) || 0;
            const po_m = (f.pueblos_originarios_mujeres ?? f.po?.mujeres ?? 0) || 0;
            const mig_h = (f.migrantes_hombres ?? f.mig?.hombres ?? f.migrantes) || 0;
            const mig_m = (f.migrantes_mujeres ?? f.mig?.mujeres ?? 0) || 0;
            const eleam_h = (f.personas_mayores_en_eleam_hombres ?? f.eleam?.hombres ?? f.personas_mayores_en_eleam) || 0;
            const eleam_m = (f.personas_mayores_en_eleam_mujeres ?? f.eleam?.mujeres ?? 0) || 0;
            return {
              instrumento: f.instrumento,
              riesgo: f.riesgo,
              totales: f.totales || {ambos:0, hombres:0, mujeres:0},
              por_banda,
              po: {hombres: po_h, mujeres: po_m},
              mig: {hombres: mig_h, mujeres: mig_m},
              eleam: {hombres: eleam_h, mujeres: eleam_m}
            };
          });
          ok = true;
        }
      }
    }catch(_){ ok = false; }

    if(!bandas || bandas.length===0){ bandas = P5_BANDAS_DEFAULT.slice(); }

    // Encabezado 3 niveles
    const h1 = document.createElement('tr');
    h1.innerHTML = `
      <th scope="col" rowspan="3" class="sticky-col sticky-col-shadow concept-col">INSTRUMENTO DE<br/>EVALUACI√ìN</th>
      <th scope="col" rowspan="3">TIPO DE RIESGO</th>
  <th scope="colgroup" colspan="3">TOTAL</th>
  <th scope="colgroup" class="sep-total" colspan="${bandas.length*2}">RANGO ETARIO Y SEXO</th>
  <th scope="colgroup" class="sep-po" colspan="2">Pueblos Originarios</th>
  <th scope="colgroup" class="sep-mig" colspan="2">Migrantes</th>
  <th scope="colgroup" class="sep-eleam" colspan="2">Personas mayores en ELEAM</th>`;
    const h2 = document.createElement('tr');
    h2.innerHTML = `
    <th scope="col">Ambos sexos</th><th scope="col">Hombres</th><th scope="col">Mujeres</th>
  ${bandas.map((b,i)=>`<th scope=\"colgroup\" colspan=\"2\" class=\"${i===0?'sep-total':''}\">${p5DisplayBandLabel(b)}</th>`).join('')}
  <th scope="col" class="sep-po">Hombres</th><th scope="col">Mujeres</th>
  <th scope="col" class="sep-mig">Hombres</th><th scope="col">Mujeres</th>
  <th scope="col" class="sep-eleam">Hombres</th><th scope="col">Mujeres</th>`;
    const h3 = document.createElement('tr');
    h3.innerHTML = `
      ${Array(3).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}
      ${bandas.map((_,i)=>`<th scope="col" class=\"${i===0?'sep-total':''}\">Hombres</th><th scope="col">Mujeres</th>`).join('')}
  ${Array(6).fill('<td role="presentation" aria-hidden="true" class="placeholder-cell"></td>').join('')}`;
    thead.innerHTML=''; thead.appendChild(h1); thead.appendChild(h2); thead.appendChild(h3);

    // Render filas
    tbody.innerHTML='';
    // Agrupar por instrumento preservando orden de llegada
    const orden = [];
    const porInstr = new Map();
    for(const r of filas){
      const instr = r.instrumento;
      if(!porInstr.has(instr)){ porInstr.set(instr, []); orden.push(instr); }
      porInstr.get(instr).push(r);
    }
    for(const instr of orden){
      const items = porInstr.get(instr) || [];
      const span = items.length || 1;
      let i = 0;
      for(const r of items){
        const tr = document.createElement('tr');
        const tot = r?.totales || {ambos:0,hombres:0,mujeres:0};
  const po = r?.po || {hombres:0, mujeres:0};
  const mig = r?.mig || {hombres:0, mujeres:0};
  const eleam = r?.eleam || {hombres:0, mujeres:0};
        const celdasBand = bandas.map((b,j)=>{
          const pb = r?.por_banda?.[b] || {hombres:0,mujeres:0};
          return `<td class="${j===0?'sep-total':''}">${num(pb.hombres||0)}</td><td>${num(pb.mujeres||0)}</td>`;
        }).join('');
        if(i===0){
          tr.innerHTML = `
            <th scope="row" rowspan="${span}" class="sticky-col sticky-col-shadow concept-col">${instr}</th>
            <th scope="row">${r.riesgo||''}</th>
            <td class="sep-total">${num(tot.ambos||0)}</td><td>${num(tot.hombres||0)}</td><td>${num(tot.mujeres||0)}</td>
            ${celdasBand}
            <td class="sep-po">${num(po.hombres||0)}</td><td>${num(po.mujeres||0)}</td>
            <td class="sep-mig">${num(mig.hombres||0)}</td><td>${num(mig.mujeres||0)}</td>
            <td class="sep-eleam">${num(eleam.hombres||0)}</td><td>${num(eleam.mujeres||0)}</td>`;
        } else {
          tr.innerHTML = `
            <th scope="row">${r.riesgo||''}</th>
            <td class="sep-total">${num(tot.ambos||0)}</td><td>${num(tot.hombres||0)}</td><td>${num(tot.mujeres||0)}</td>
            ${celdasBand}
            <td class="sep-po">${num(po.hombres||0)}</td><td>${num(po.mujeres||0)}</td>
            <td class="sep-mig">${num(mig.hombres||0)}</td><td>${num(mig.mujeres||0)}</td>
            <td class="sep-eleam">${num(eleam.hombres||0)}</td><td>${num(eleam.mujeres||0)}</td>`;
        }
        tbody.appendChild(tr);
        i++;
      }
    }

    if(status) status.textContent = ok ? '' : 'Sin datos (se muestran 0)';
    ajustarAnchoConceptoStickyCols();
  }catch(e){
    console.error('P5 E ca√≠das error', e);
    if(status) status.textContent = 'No se pudo cargar P5 Secci√≥n E';
  }
}

// ===================== P5 SECCI√ìN A: Funcionalidad (din√°mica desde backend) =====================
async function cargarP5SeccionA(){
  const status = document.getElementById('p5-status');
  const thead = document.getElementById('p5-head');
  const tbody = document.getElementById('p5-body');
  try{
    if(status) status.textContent = 'Cargando‚Ä¶';
    if(!thead || !tbody) return;

    // Construir query con filtros + par√°metros REM-P
    const params = new URLSearchParams();
    const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
    const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
    const cEl = document.getElementById('categorias_select'); const c = cEl && cEl.value; if(c) params.set('categorias', c);
    const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
    const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
    // Mapear a par√°metros de ventana anual
    if(desde) params.set('inicio', desde);
    if(hasta){
      try{
        const d = new Date(hasta); d.setDate(d.getDate()+1);
        const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0');
        params.set('fin', `${y}-${m}-${dd}`);
      }catch(_){ /* noop */ }
      params.set('fecha_corte', hasta);
    }
    // REM-P params no son requeridos aqu√≠, pero mantener compatibilidad no afecta
    appendRemParams(params);

    let bandas = [];
    let filas = [];
    let ok = false;
    try{
      // Consumir el endpoint unificado que entrega EFAM + Barthel con desagregaci√≥n por sexo
      const url = '/api/funcionalidad_simple' + (params.toString()? ('?'+params.toString()):'');
      const r = await fetch(url, { credentials: 'same-origin' });
      if(r.ok){
        const j = await r.json();
        if(j && j.success){
          bandas = j.bandas || [];
          // Normalizar filas del backend al formato de render existente
          const raw = j.filas || [];
          filas = raw.map(f => {
            // Determinar etiqueta del √≠tem (soporta ambos formatos)
            const item = f.item || f.condicion || '';
            // Usar por_banda directo si viene; si no, convertir por_tramo
            let por_banda = {};
            if (f.por_banda && typeof f.por_banda === 'object') {
              for (const [b, v] of Object.entries(f.por_banda)) {
                por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
              }
            } else if (f.por_tramo && typeof f.por_tramo === 'object') {
              for (const [b, v] of Object.entries(f.por_tramo)) {
                por_banda[b] = { hombres: v?.hombres||0, mujeres: v?.mujeres||0 };
              }
            }
            // PO/MIG: preferir desagregado por sexo (formato nuevo). Si no existe, mapear totales a H y 0 a M (formato antiguo)
            const po = f.po ? {hombres: f.po?.hombres||0, mujeres: f.po?.mujeres||0}
                             : {hombres: (f.pueblos_originarios||0), mujeres: 0};
            const mig = f.mig ? {hombres: f.mig?.hombres||0, mujeres: f.mig?.mujeres||0}
                               : {hombres: (f.migrantes||0), mujeres: 0};
            return {
              item,
              totales: f.totales || {ambos:0,hombres:0,mujeres:0},
              por_banda,
              po,
              mig
            };
          });
          ok = true;
        }
      }
    }catch(_){ ok = false; }

    if(!bandas || bandas.length===0){
      // Fallback fijo si el backend no define
      bandas = ['65 a 69 a√±os','70 a 74 a√±os','75 a 79 a√±os','80 a 84 a√±os','85 a 89 a√±os','90 a 94 a√±os','95 a 99 a√±os','100 y m√°s a√±os'];
    }

  const bandas65 = bandas.filter(b=>keyizeLabel(b)!==keyizeLabel('60 a 64 a√±os'));
  // Encabezado en 3 niveles (>=65, sin ELEAM)
    const h1 = document.createElement('tr');
    h1.innerHTML = `
      <th scope="col" rowspan="3" class="sticky-col sticky-col-shadow concept-col">CONDICI√ìN DE <br/>FUNCIONALIDAD</th>
      <th scope="colgroup" colspan="3">TOTAL</th>
  <th scope="colgroup" class="sep-total" colspan="${bandas65.length*2}">RANGO ETARIO Y SEXO</th>
  <th scope="colgroup" class="sep-po" colspan="2">Pueblos Originarios</th>
  <th scope="colgroup" class="sep-mig" colspan="2">Migrantes</th>`;
    const h2 = document.createElement('tr');
    h2.innerHTML = `
      <th scope="col">Ambos sexos</th><th scope="col">Hombres</th><th scope="col">Mujeres</th>
      ${bandas65.map((b,i)=>`<th scope=\"colgroup\" colspan=\"2\" class=\"${i===0?'sep-total':''}\">${p5DisplayBandLabel(b)}</th>`).join('')}
  <th scope="col" class="sep-po">Hombres</th><th scope="col">Mujeres</th>
  <th scope="col" class="sep-mig">Hombres</th><th scope="col">Mujeres</th>`;
    const h3 = document.createElement('tr');
    h3.innerHTML = `
      ${Array(3).fill('<th scope=\"col\" style=\"visibility:hidden\"></th>').join('')}
      ${bandas65.map((_,i)=>`<th scope=\"col\" class=\"${i===0?'sep-total':''}\">Hombres</th><th scope=\"col\">Mujeres</th>`).join('')}
  ${Array(4).fill('<th scope=\"col\" style=\"visibility:hidden\"></th>').join('')}`;
    thead.innerHTML=''; thead.appendChild(h1); thead.appendChild(h2); thead.appendChild(h3);

    // Orden esperado
    const orden = [
      'Autovalente sin riesgo',
      'Autovalente con riesgo',
      'Riesgo de dependencia',
      'SUBTOTAL (EFAM)',
      'Dependiente leve',
      'Dependiente moderado',
      'Dependiente grave',
      'Dependiente total',
      'SUBTOTAL (INDICE BARTHEL)',
      'TOTAL PERSONAS MAYORES EN CONTROL'
    ];
    const mapExact = new Map((filas||[]).map(f => [f.item, f]));
    const mapLoose = new Map((filas||[]).map(f => [keyizeLabel(f.item), f]));
    function getRow(name){ return mapExact.get(name) || mapLoose.get(keyizeLabel(name)) || null; }

    tbody.innerHTML='';
    for(const item of orden){
      const r = getRow(item);
      const isSubtotal = item.startsWith('SUBTOTAL') || item.startsWith('TOTAL');
      const tot = r?.totales || {ambos:0,hombres:0,mujeres:0};
      const po = r?.po || {hombres:0, mujeres:0};
      const mig = r?.mig || {hombres:0, mujeres:0};
      const tr = document.createElement('tr');
      const celdasBandas = bandas65.map((b,i)=>{
        const pb = r?.por_banda?.[b] || {hombres:0, mujeres:0};
        return `<td class=\"${i===0?'sep-total':''}\">${num(pb.hombres||0)}</td><td>${num(pb.mujeres||0)}</td>`;
      }).join('');
      tr.innerHTML = `
        <th scope=\"row\" class=\"sticky-col sticky-col-shadow concept-col\">${item}</th>
        <td class=\"sep-total\">${num(tot.ambos||0)}</td><td>${num(tot.hombres||0)}</td><td>${num(tot.mujeres||0)}</td>
        ${celdasBandas}
  <td class=\"sep-po\">${num(po.hombres||0)}</td><td>${num(po.mujeres||0)}</td>
  <td class=\"sep-mig\">${num(mig.hombres||0)}</td><td>${num(mig.mujeres||0)}</td>`;
      tbody.appendChild(tr);
    }
    if(status) status.textContent = ok ? '' : 'Sin datos (se muestran 0)';
    ajustarAnchoConceptoStickyCols();
  }catch(e){
    console.error('P5 funcionalidad error', e);
    if(status) status.textContent = 'No se pudo cargar P5';
  }
}

// ===================== P5 SECCI√ìN A.1: Funcionalidad MAM (incluye 60‚Äì64, sin ELEAM) =====================
async function cargarP5SeccionA1(){
  const status = document.getElementById('p5a1-status');
  const thead = document.getElementById('p5a1-head');
  const tbody = document.getElementById('p5a1-body');
  try{
    if(status) status.textContent = 'Cargando‚Ä¶';
    if(!thead || !tbody) return;

    const params = new URLSearchParams();
    const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
    const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
    const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
    const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
    if(desde) params.set('inicio', desde);
    if(hasta){
      try{ const d=new Date(hasta); d.setDate(d.getDate()+1); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); params.set('fin', `${y}-${m}-${dd}`);}catch(_){ }
      params.set('fecha_corte', hasta);
    }

    let bandas = [];
    let filas = [];
    let ok = false;
    try{
      const url = '/api/funcionalidad_simple' + (params.toString()? ('?'+params.toString()):'');
      const r = await fetch(url, { credentials: 'same-origin' });
      if(r.ok){
        const j = await r.json();
        if(j && j.success){
          bandas = j.bandas || [];
          const raw = j.filas || [];
          filas = raw.map(f => ({
            item: f.item || f.condicion || '',
            totales: f.totales || {ambos:0,hombres:0,mujeres:0},
            por_banda: f.por_banda || f.por_tramo || {},
            po: f.po || {hombres: f.pueblos_originarios||0, mujeres: 0},
            mig: f.mig || {hombres: f.migrantes||0, mujeres: 0}
          }));
          ok = true;
        }
      }
    }catch(_){ ok = false; }

    if(!bandas || bandas.length===0){
      bandas = ['60 a 64 a√±os','65 a 69 a√±os','70 a 74 a√±os','75 a 79 a√±os','80 a 84 a√±os','85 a 89 a√±os','90 a 94 a√±os','95 a 99 a√±os','100 y m√°s a√±os'];
    }

    // Encabezado en 3 niveles (incluye 60‚Äì64 y sin ELEAM)
    const h1 = document.createElement('tr');
    h1.innerHTML = `
      <th scope=\"col\" rowspan=\"3\" class=\"sticky-col sticky-col-shadow concept-col\">CONDICI√ìN DE <br/>FUNCIONALIDAD</th>
      <th scope=\"colgroup\" colspan=\"3\">TOTAL</th>
      <th scope=\"colgroup\" class=\"sep-total\" colspan=\"${bandas.length*2}\">RANGO ETARIO Y SEXO</th>
      <th scope=\"colgroup\" class=\"sep-po\" colspan=\"2\">Pueblos Originarios</th>
      <th scope=\"colgroup\" class=\"sep-mig\" colspan=\"2\">Migrantes</th>`;
    const h2a = document.createElement('tr');
    h2a.innerHTML = `
      <th scope=\"col\">Ambos sexos</th><th scope=\"col\">Hombres</th><th scope=\"col\">Mujeres</th>
      ${bandas.map((b,i)=>`<th scope=\\"colgroup\\" colspan=\\"2\\" class=\\"${i===0?'sep-total band-60-64':'band-65plus'}\\">${p5DisplayBandLabel(b)}</th>`).join('')}
      <th scope=\"col\" class=\"sep-po\">Hombres</th><th scope=\"col\">Mujeres</th>
      <th scope=\"col\" class=\"sep-mig\">Hombres</th><th scope=\"col\">Mujeres</th>`;
    const h3a = document.createElement('tr');
    h3a.innerHTML = `
      ${Array(3).fill('<th scope=\\"col\\" style=\\"visibility:hidden\\"></th>').join('')}
      ${bandas.map((_,i)=>`<th scope=\\"col\\" class=\\"${i===0?'sep-total band-60-64':'band-65plus'}\\">Hombres</th><th scope=\\"col\\" class=\\"${i===0?'band-60-64':'band-65plus'}\\">Mujeres</th>`).join('')}
      ${Array(4).fill('<th scope=\\"col\\" style=\\"visibility:hidden\\"></th>').join('')}`;
    thead.innerHTML=''; thead.appendChild(h1); thead.appendChild(h2a); thead.appendChild(h3a);

    const orden = [
      'Autovalente sin riesgo',
      'Autovalente con riesgo',
      'Riesgo de dependencia',
      'TOTAL (EFAM)'
    ];
    const mapExact = new Map((filas||[]).map(f => [f.item, f]));
    const mapLoose = new Map((filas||[]).map(f => [keyizeLabel(f.item), f]));
    function getRow(name){ return mapExact.get(name) || mapLoose.get(keyizeLabel(name)) || null; }

    tbody.innerHTML='';
    for(const item of orden){
      const r = getRow(item);
      const tot = r?.totales || {ambos:0,hombres:0,mujeres:0};
      const po = r?.po || {hombres:0, mujeres:0};
      const mig = r?.mig || {hombres:0, mujeres:0};
      const tr = document.createElement('tr');
      const celdasBandas = bandas.map((b,i)=>{
        const v = r?.por_banda?.[b] || r?.por_tramo?.[b] || {hombres:0,mujeres:0};
        const cls = i===0 ? 'band-60-64' : 'band-65plus';
        return `<td class=\"${i===0?'sep-total ':''}${cls}\">${num(v.hombres||0)}</td><td class=\"${cls}\">${num(v.mujeres||0)}</td>`;
      }).join('');
      tr.innerHTML = `
        <th scope=\"row\" class=\"sticky-col sticky-col-shadow concept-col\">${item}</th>
        <td class=\"sep-total\">${num(tot.ambos||0)}</td><td>${num(tot.hombres||0)}</td><td>${num(tot.mujeres||0)}</td>
        ${celdasBandas}
        <td class=\"sep-po\">${num(po.hombres||0)}</td><td>${num(po.mujeres||0)}</td>
        <td class=\"sep-mig\">${num(mig.hombres||0)}</td><td>${num(mig.mujeres||0)}</td>`;
      tbody.appendChild(tr);
    }
    if(status) status.textContent = ok ? '' : 'Sin datos (se muestran 0)';
    ajustarAnchoConceptoStickyCols();
  }catch(e){ if(status) status.textContent = 'No se pudo cargar Secci√≥n A.1'; console.error('P5 A.1 error', e); }
}

// Sanea el nombre de la hoja para Excel (m√°x 31 chars y sin caracteres prohibidos)
function sanitizeSheetName(name){
  let n = String(name||'Hoja');
  // Reemplazar caracteres inv√°lidos: : \\ / ? * [ ]
  n = n.replace(/[:\\/?*\[\]]/g, ' ');
  // Recortar espacios extremos y limitar a 31 caracteres
  n = n.trim().slice(0, 31) || 'Hoja';
  return n;
}

// Agrega una hoja inicial con el detalle de filtros aplicados y par√°metros REM‚ÄëP
function addHojaFiltrosAplicados(wb){
  try{
    const desde = document.getElementById('fecha_desde')?.value || '';
    const hasta = document.getElementById('fecha_hasta')?.value || '';
    const sectorSel = document.getElementById('sectores_select');
    const sectorTexto = sectorSel ? (sectorSel.options[sectorSel.selectedIndex]?.text || '') : '';
    const sexoSel = document.getElementById('sexo_select');
    const sexoTexto = sexoSel ? (sexoSel.options[sexoSel.selectedIndex]?.text || sexoSel.value || '') : '';
    const catSel = document.getElementById('categorias_select');
    const categoriasTexto = catSel ? (catSel.options[catSel.selectedIndex]?.text || catSel.value || '') : '';
    const geSel = document.getElementById('grupo_etareo_select');
    const grupoTexto = geSel ? (geSel.options[geSel.selectedIndex]?.text || geSel.value || '') : '';
    const patSel = document.getElementById('patologia_filtro');
    const patologiaTexto = patSel ? (patSel.options?.[patSel.selectedIndex]?.text || patSel.value || '') : '';

    // Par√°metros REM‚ÄëP guardados en localStorage
    let rem = {};
    try{ rem = getStoredRemParams ? getStoredRemParams() : {}; }catch(_){ rem = {}; }

    const data = [
  ['Generado en', new Date().toLocaleDateString()],
      ['Fecha inicio', desde || '(sin filtro)'],
      ['Fecha t√©rmino', hasta || '(sin filtro)'],
      ['Sector', sectorTexto || 'Todos'],
      ['Sexo', sexoTexto || 'Todos'],
      ['Categor√≠as', categoriasTexto || 'Todas'],
      ['Grupo etario', grupoTexto || 'Todos'],
      ['Patolog√≠as', patologiaTexto || 'Todas'],
      ['‚Äî', '‚Äî'],
      ['Par√°metros REM‚ÄëP', 'Valor'],
      ['Vigencia (d√≠as)', rem.vigencia_dias ?? ''],
      ['HbA1c meta 15-79 a√±os (%)', rem.hba1c_meta_lt65 ?? ''],
      ['HbA1c meta ‚â•80 a√±os (%)', rem.hba1c_meta_ge65 ?? ''],
      ['PA sist√≥lica meta (mmHg)', rem.pa_sistolica_meta ?? ''],
      ['PA diast√≥lica meta (mmHg)', rem.pa_diastolica_meta ?? ''],
      ['PA sist√≥lica meta ALT (mmHg)', rem.pa_sistolica_meta_alt ?? ''],
      ['LDL meta RCV alto (mg/dL)', rem.ldl_meta_rcv_alto ?? ''],
      ['LDL meta general (mg/dL)', rem.ldl_meta_general ?? '']
    ];
    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, sanitizeSheetName('Filtros aplicados'));
  }catch(_){ /* noop */ }
}

// Exporta todas las tablas del documento a hojas separadas
function exportarTodasLasTablasAExcel(wb){
  try{
    const tables = Array.from(document.querySelectorAll('table'));
    if(!tables.length) return;
    const used = new Set();
    let fallbackIndex = 1;
    for(const table of tables){
      // Determinar nombre de hoja: data-export-name > id > t√≠tulo cercano > fallback
      let base = table.getAttribute('data-export-name') || table.id || '';
      if(!base){
        // Intentar encontrar t√≠tulo en la tarjeta (card-title)
        const card = table.closest('.card');
        const titleEl = card ? card.querySelector('.card-title') : null;
        if(titleEl){ base = (titleEl.textContent||'').trim(); }
      }
      if(!base){ base = `Tabla_${fallbackIndex++}`; }
      let name = sanitizeSheetName(base);
      // Unicidad: si ya existe, agregar sufijos
      let suffix = 2;
      while(used.has(name)){
        const baseShort = sanitizeSheetName(base).slice(0, Math.max(0, 31 - (` (${suffix})`.length)));
        name = `${baseShort} (${suffix})`;
        suffix++;
      }
      used.add(name);

      const ws = XLSX.utils.table_to_sheet(table, {raw:true});
      XLSX.utils.book_append_sheet(wb, ws, name);
    }
  }catch(_){ /* noop */ }
}

// ===================== SECCI√ìN C: Variables de Seguimiento =====================
async function cargarSeccionCVariables(paramsFromChart){
  const status = document.getElementById('pscv-variables-status');
  const thead = document.getElementById('pscv-variables-head');
  const tbody = document.getElementById('pscv-variables-body');
  try{
    status.textContent = 'Cargando‚Ä¶';
    let params;
    if(paramsFromChart instanceof URLSearchParams){
      params = paramsFromChart;
    } else {
      params = new URLSearchParams();
      const sEl = document.getElementById('sectores_select'); const s = sEl && sEl.value; if(s) params.set('sectores', s);
      const sxEl = document.getElementById('sexo_select'); const sx = sxEl && sxEl.value; if(sx) params.set('sexo', sx);
      const cEl = document.getElementById('categorias_select'); const c = cEl && cEl.value; if(c) params.set('categorias', c);
      const gEl = document.getElementById('grupo_etareo_select'); const g = gEl && gEl.value; if(g) params.set('grupos_etareos', g);
      const pEl = document.getElementById('patologia_filtro'); const p = pEl && pEl.value; if(p) params.set('patologias', p);
      const desdeEl = document.getElementById('fecha_desde'); const desde = desdeEl && desdeEl.value; if(desde) params.set('fecha_desde', desde);
      const hastaEl = document.getElementById('fecha_hasta'); const hasta = hastaEl && hastaEl.value; if(hasta) params.set('fecha_hasta', hasta);
    }
    appendRemParams(params);

    // Intentar obtener variables (nuevo esquema: bandas + filas)
    let filas = [];
    let bandas = [];
    let ok = false;
    try{
      const r = await fetch('/api/estadisticas/pscv_variables' + (params.toString()? ('?'+params.toString()):''));
      if(r.ok){
        const j = await r.json();
        if(j && j.success){
          filas = j.filas || [];
          bandas = j.bandas || [];
          ok = true;
        }
      }
    }catch(_){ ok = false; }

    // Si no vino en el endpoint, caer a las fuentes anteriores
    let origenBandas = '';
    if(!bandas || bandas.length===0){
      try{
        const qs = params.toString();
        const rb = await fetch('/api/estadisticas/pscv_resumen_bandas' + (qs? ('?'+qs):''));
        if(rb.ok){ const jb = await rb.json(); if(jb && jb.success){ bandas = jb.bandas||[]; if(bandas.length>0) origenBandas='pscv_resumen_bandas'; } }
      }catch(_){ }
    }
    if(!bandas || bandas.length===0){
      try{
        const qs = params.toString();
        const rm = await fetch('/api/estadisticas/pscv_matriz' + (qs? ('?'+qs):''));
        if(rm.ok){ const jm = await rm.json(); if(jm && jm.success){ bandas = (jm.matriz||[]).map(x=>x.banda); if(bandas.length>0) origenBandas='pscv_matriz'; } }
      }catch(_){ }
    }
    if(!bandas || bandas.length===0){ bandas = BANDAS_PSCV_DEFAULT.slice(); origenBandas='bandas_default'; }

    // Header de 3 niveles
    const h1 = document.createElement('tr');
    h1.innerHTML = `
      <th rowspan="3" class="sticky-col sticky-col-shadow concept-col">CONCEPTO</th>
      <th colspan="3">TOTAL</th>
      <th class="sep-total" colspan="${bandas.length*2}">RANGO ETARIO Y SEXO</th>
      <th class="sep-po" colspan="2">Pueblos Originarios</th>
      <th class="sep-mig" colspan="2">Migrantes</th>`;
    const h2 = document.createElement('tr');
    h2.innerHTML = `
      <th style="min-width: 360px;">&nbsp;</th>
      <th class="sep-total">Ambos sexos</th><th>Hombres</th><th>Mujeres</th>
      ${bandas.map((b,i)=>`<th colspan="2" class="${i===0?'sep-total':''}">${b} a√±os</th>`).join('')}
      <th class="sep-po">Hombres</th><th>Mujeres</th>
      <th class="sep-mig">Hombres</th><th>Mujeres</th>`;
    const h3 = document.createElement('tr');
    h3.innerHTML = `
      <th style="visibility:hidden"></th>
      ${Array(3).fill('<th style="visibility:hidden"></th>').join('')}
      ${bandas.map((_,i)=>`<th class="${i===0?'sep-total':''}">Hombres</th><th>Mujeres</th>`).join('')}
      ${Array(4).fill('<th style=\"visibility:hidden\"></th>').join('')}`;
    thead.innerHTML=''; thead.appendChild(h1); thead.appendChild(h2); thead.appendChild(h3);

    // √çndice r√°pido y agrupaci√≥n din√°mica por grupo, en el orden provisto por la API
    const idx = new Map(filas.map(r => [`${r.grupo}||${r.item}`, r]));
    const ordenGrupos = [];
    const itemsPorGrupo = new Map();
    for(const r of filas){
      if(!itemsPorGrupo.has(r.grupo)){
        itemsPorGrupo.set(r.grupo, []);
        ordenGrupos.push(r.grupo);
      }
      itemsPorGrupo.get(r.grupo).push(r.item);
    }

    // Render filas
    tbody.innerHTML = '';
    for(const grupoTitulo of ordenGrupos){
      const items = itemsPorGrupo.get(grupoTitulo) || [];
      const rowSpan = items.length || 1;
      let i = 0;
      for(const it of items){
        const key = `${grupoTitulo}||${it}`;
        const r = idx.get(key) || null;
        const tot = r?.totales || {ambos:0,hombres:0,mujeres:0};
        const tr = document.createElement('tr');
        const celdasBandas = bandas.map((b,j)=>{
          const pb = r?.por_banda?.[b] || {hombres:0,mujeres:0};
          return `<td class="${j===0?'sep-total':''}">${num(pb.hombres||0)}</td><td>${num(pb.mujeres||0)}</td>`;
        }).join('');
        if(i===0){
          tr.innerHTML = `
            <td rowspan="${rowSpan}" class="sticky-col sticky-col-shadow concept-col">${grupoTitulo}</td>
            <td>${it}</td>
            <td class="sep-total">${num(tot.ambos||0)}</td>
            <td>${num(tot.hombres||0)}</td>
            <td>${num(tot.mujeres||0)}</td>
            ${celdasBandas}
            <td class="sep-po">${num(r?.po?.hombres||0)}</td><td>${num(r?.po?.mujeres||0)}</td>
            <td class="sep-mig">${num(r?.mig?.hombres||0)}</td><td>${num(r?.mig?.mujeres||0)}</td>`;
        } else {
          tr.innerHTML = `
            <td>${it}</td>
            <td class="sep-total">${num(tot.ambos||0)}</td>
            <td>${num(tot.hombres||0)}</td>
            <td>${num(tot.mujeres||0)}</td>
            ${celdasBandas}
            <td class="sep-po">${num(r?.po?.hombres||0)}</td><td>${num(r?.po?.mujeres||0)}</td>
            <td class="sep-mig">${num(r?.mig?.hombres||0)}</td><td>${num(r?.mig?.mujeres||0)}</td>`;
        }
        tbody.appendChild(tr);
        i++;
      }
    }
    status.textContent = ok ? (origenBandas?`Bandas: ${origenBandas}`:'') : 'Sin datos (se muestran 0)';
    ajustarAnchoConceptoStickyCols();
  }catch(e){
    console.error('PSCV variables error', e);
    status.textContent = 'No se pudo cargar la Secci√≥n C';
  }
}

// ===================== UI Par√°metros REM-P (avanzado) =====================
const REM_DEFAULTS = {
  vigencia_dias: 365,
  hba1c_meta_lt65: 7.0,
  hba1c_meta_ge65: 8.0,
  pa_sistolica_meta: 140,
  pa_diastolica_meta: 90,
  pa_sistolica_meta_alt: 150,
  ldl_meta_rcv_alto: 70,
  ldl_meta_general: 100
};

function getStoredRemParams(){
  try{
    const raw = localStorage.getItem('rem_params');
    if(!raw) return {...REM_DEFAULTS};
    const obj = JSON.parse(raw);
    return {...REM_DEFAULTS, ...obj};
  }catch(_){ return {...REM_DEFAULTS}; }
}
function saveStoredRemParams(obj){
  try{ localStorage.setItem('rem_params', JSON.stringify(obj||{})); }catch(_){ /* noop */ }
}
function appendRemParams(params){
  try{
    const p = getStoredRemParams();
    // Solo agregamos si existen valores (usar string para URLSearchParams)
    if(p.vigencia_dias!=null) params.set('vigencia_dias', String(p.vigencia_dias));
    if(p.hba1c_meta_lt65!=null) params.set('hba1c_meta_lt65', String(p.hba1c_meta_lt65));
    if(p.hba1c_meta_ge65!=null) params.set('hba1c_meta_ge65', String(p.hba1c_meta_ge65));
    if(p.pa_sistolica_meta!=null) params.set('pa_sistolica_meta', String(p.pa_sistolica_meta));
    if(p.pa_diastolica_meta!=null) params.set('pa_diastolica_meta', String(p.pa_diastolica_meta));
    if(p.pa_sistolica_meta_alt!=null) params.set('pa_sistolica_meta_alt', String(p.pa_sistolica_meta_alt));
    if(p.ldl_meta_rcv_alto!=null) params.set('ldl_meta_rcv_alto', String(p.ldl_meta_rcv_alto));
    if(p.ldl_meta_general!=null) params.set('ldl_meta_general', String(p.ldl_meta_general));
  }catch(_){ /* noop */ }
}
function initRemParamsUI(){
  try{
    // Insertar panel de par√°metros en el host de esta p√°gina
    const host = document.getElementById('params-panel-host');
    if(!host) return;
    if(document.getElementById('remp-panel')) return;
    const html = `
      <hr class="my-3"/>
      <details id="remp-panel">
        <summary class="fw-semibold" style="cursor:pointer">Par√°metros REM‚ÄëP (avanzado)</summary>
        <div class="row g-2 mt-2">
          <div class="col-6 col-md-3">
            <label class="form-label small">Vigencia (d√≠as)</label>
            <input id="rem_vigencia" type="number" class="form-control form-control-sm" min="1"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">HbA1c meta 15-79 a√±os (%)</label>
            <input id="rem_hba1c_lt65" type="number" step="0.1" class="form-control form-control-sm"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">HbA1c meta ‚â•80 a√±os (%)</label>
            <input id="rem_hba1c_ge65" type="number" step="0.1" class="form-control form-control-sm"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">PA sist√≥lica meta (mmHg)</label>
            <input id="rem_pa_sys" type="number" class="form-control form-control-sm"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">PA diast√≥lica meta (mmHg)</label>
            <input id="rem_pa_dia" type="number" class="form-control form-control-sm"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">PA sist√≥lica ‚â•80 a√±os (mmHg)</label>
            <input id="rem_pa_sys_alt" type="number" class="form-control form-control-sm"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">LDL meta RCV alto (mg/dL)</label>
            <input id="rem_ldl_rcv" type="number" class="form-control form-control-sm"/>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label small">LDL meta general (mg/dL)</label>
            <input id="rem_ldl_gen" type="number" class="form-control form-control-sm"/>
          </div>
          <div class="col-12 d-flex gap-2 mt-2">
            <button id="rem_guardar" type="button" class="btn btn-sm btn-primary">Guardar y recargar tablas</button>
            <button id="rem_reset" type="button" class="btn btn-sm btn-outline-secondary">Restaurar valores por defecto</button>
          </div>
        </div>
      </details>`;
    host.insertAdjacentHTML('beforeend', html);
    const p = getStoredRemParams();
    document.getElementById('rem_vigencia').value = p.vigencia_dias;
    document.getElementById('rem_hba1c_lt65').value = p.hba1c_meta_lt65;
    document.getElementById('rem_hba1c_ge65').value = p.hba1c_meta_ge65;
    document.getElementById('rem_pa_sys').value = p.pa_sistolica_meta;
    document.getElementById('rem_pa_dia').value = p.pa_diastolica_meta;
    document.getElementById('rem_pa_sys_alt').value = p.pa_sistolica_meta_alt;
    document.getElementById('rem_ldl_rcv').value = p.ldl_meta_rcv_alto;
    document.getElementById('rem_ldl_gen').value = p.ldl_meta_general;

    document.getElementById('rem_guardar').addEventListener('click', () => {
      const obj = {
        vigencia_dias: parseInt(document.getElementById('rem_vigencia').value||REM_DEFAULTS.vigencia_dias, 10),
        hba1c_meta_lt65: parseFloat(document.getElementById('rem_hba1c_lt65').value||REM_DEFAULTS.hba1c_meta_lt65),
        hba1c_meta_ge65: parseFloat(document.getElementById('rem_hba1c_ge65').value||REM_DEFAULTS.hba1c_meta_ge65),
        pa_sistolica_meta: parseInt(document.getElementById('rem_pa_sys').value||REM_DEFAULTS.pa_sistolica_meta, 10),
        pa_diastolica_meta: parseInt(document.getElementById('rem_pa_dia').value||REM_DEFAULTS.pa_diastolica_meta, 10),
        pa_sistolica_meta_alt: parseInt(document.getElementById('rem_pa_sys_alt').value||REM_DEFAULTS.pa_sistolica_meta_alt, 10),
        ldl_meta_rcv_alto: parseFloat(document.getElementById('rem_ldl_rcv').value||REM_DEFAULTS.ldl_meta_rcv_alto),
        ldl_meta_general: parseFloat(document.getElementById('rem_ldl_gen').value||REM_DEFAULTS.ldl_meta_general)
      };
      saveStoredRemParams(obj);
      // Recargar tablas dependientes de par√°metros
      cargarPscvMetas();
      cargarP5SeccionA();
      cargarSeccionAMatriz();
      cargarSeccionCVariables();
    });
    document.getElementById('rem_reset').addEventListener('click', () => {
      saveStoredRemParams({});
      const d = {...REM_DEFAULTS};
      document.getElementById('rem_vigencia').value = d.vigencia_dias;
      document.getElementById('rem_hba1c_lt65').value = d.hba1c_meta_lt65;
      document.getElementById('rem_hba1c_ge65').value = d.hba1c_meta_ge65;
      document.getElementById('rem_pa_sys').value = d.pa_sistolica_meta;
      document.getElementById('rem_pa_dia').value = d.pa_diastolica_meta;
      document.getElementById('rem_pa_sys_alt').value = d.pa_sistolica_meta_alt;
      document.getElementById('rem_ldl_rcv').value = d.ldl_meta_rcv_alto;
      document.getElementById('rem_ldl_gen').value = d.ldl_meta_general;
      cargarPscvMetas();
      cargarP5SeccionA();
      cargarSeccionAMatriz();
      cargarSeccionCVariables();
    });
  }catch(_){ /* noop */ }
}

// (Funci√≥n duplicada de Secci√≥n A eliminada: la versi√≥n oficial est√° en <head>)
</script>

<script>
  function obtenerTooltipDiagnostico(item) {
    if (item === 'Antecedentes de Infarto Agudo al Miocardio (IAM)') {
  return `Personas bajo control con antecedentes de IAM.
Diagnosticos CIE-10:
‚Ä¢ I21 - Infarto agudo del miocardio.
‚Ä¢ I22 - Infarto recurrente del miocardio.
‚Ä¢ I25.2 - Infarto antiguo del miocardio (secuelas).`;
    }
    if (item === 'Antecedentes de Ataque Cerebro Vascular (ACV)') {
  return `Personas bajo control con antecedentes de ACV.
Diagnosticos CIE-10:
‚Ä¢ I63 - Infarto cerebral.
‚Ä¢ I64 - ACV no especificado como hemorragico o isquemico.
‚Ä¢ I69.3 / I69.4 - Secuelas de ACV.
‚Ä¢ I60-I62 - Hemorragias intracraneales no traumaticas.`;
    }
    if (item === 'Antecedentes de otras Enfermedades Cardiovasculares ECV (excepto IAM y ACV)') {
  return `Personas bajo control con antecedentes de enfermedad cardiovascular (ECV), excepto IAM y ACV.
Diagnosticos CIE-10 frecuentes asociados a esta categoria:
‚Ä¢ I20 - Angina de pecho.
‚Ä¢ I21-I25 - Enfermedades isquemicas del corazon (excepto IAM cuando se clasifica aparte).
‚Ä¢ I34-I38 - Enfermedades valvulares cardiacas adquiridas.
‚Ä¢ I48 - Fibrilacion auricular y aleteo auricular.
‚Ä¢ I50 - Insuficiencia cardiaca.
‚Ä¢ I73.9 - Enfermedad vascular periferica no especificada.
‚Ä¢ Z95 - Presencia de injertos o dispositivos cardiovasculares (bypass coronario, valvulas, stents).`;
    }
    return '';
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-diagnostico]').forEach((elemento) => {
      const item = elemento.getAttribute('data-diagnostico') || (elemento.textContent || '').trim();
      const tooltipText = obtenerTooltipDiagnostico(item);
      if (!tooltipText) {
        return;
      }
      elemento.setAttribute('title', tooltipText);
      if (!elemento.classList.contains('diagnosticos-tooltip')) {
        elemento.classList.add('diagnosticos-tooltip');
      }
    });
  });
</script>

 
 </body>
 </html>
