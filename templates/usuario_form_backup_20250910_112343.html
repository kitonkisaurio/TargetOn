<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingresar Nuevo Usuario - ECICEP</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

    <style>
        :root{
            --bg:#f8fafc; --ink:#222; --muted:#6c757d; --line:#e5e7eb;
            --brand:#0d6efd; --brand-600:#0b5ed7; --success:#198754; --card:#fff;
        }
        *{box-sizing:border-box}
        body { 
            margin:0;padding:0;background:var(--bg);color:var(--ink);
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;
            font-size: 14px;
        }
        .container { 
            max-width: 2100px; 
            margin: 0 auto; 
            background: var(--card); 
            padding: 16px; 
            border-radius: 6px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--line);
        }
        .header h2 {
            color: var(--ink);
            margin: 0;
            font-size: clamp(18px, 2.5vw, 24px);
            font-weight: 700;
        }
        fieldset { 
            border: 1px solid var(--line); 
            border-radius: 6px; 
            margin: 16px 0; 
            padding: 16px; 
        }
        legend { 
            font-weight: 600; 
            color: var(--brand); 
            padding: 0 8px; 
            font-size: 16px; 
        }
        label { 
            display: block; 
            margin: 8px 0 4px 0; 
            font-weight: 600; 
            font-size: 14px; 
            color: #374151;
        }
        input, select { 
            width: 100%; 
            padding: .5rem .6rem; 
            border: 1px solid #cbd5e1; 
            border-radius: .5rem; 
            background: #fff;
            font-size: 14px;
        }
        
        /* Anchos específicos para campos optimizados - más compactos */
    input[name="run"] { width: 180px !important; } /* Para 00.000.000-0 */
    /* Estados visuales de validación del RUN */
    #run.run-valid { color: #16a34a; }
    #run.run-invalid { color: #dc2626; }
        input[name="fecha_nacimiento"] { width: 130px !important; } /* Para 20/08/2020 */
        input[name="edad"] { width: 80px !important; text-align: right; } /* Edad en años */
        input[name="telefono"] { width: 140px !important; } /* Más compacto */
        input[name="fecha"] { width: 130px !important; } /* Para 00/00/0000 */
        input[name="presion_sistolica"] { width: 80px !important; } /* Para 123 */
        input[name="presion_diastolica"] { width: 80px !important; } /* Para 120 */
        input[name="hgt"] { width: 80px !important; } /* Para 000 */
        input[name="cc"] { width: 80px !important; } /* Para 123 */
        input[name="hba1c"] { width: 90px !important; } /* Para 10.0 */
        input[name="peso"] { width: 90px !important; } /* Para peso */
        input[name="talla"] { width: 90px !important; } /* Para talla */
        input[name="fecha_ingreso"] { width: 130px !important; } /* Para fecha */
        
        /* Contenedor para campos en línea - más compacto */
        .campos-linea {
            display: flex;
            gap: 12px;
            align-items: end;
            flex-wrap: wrap;
        }
        .campos-linea label {
            margin-bottom: 0;
            flex: none;
        }
        
        /* Anchos específicos para selects - más compactos */
    select[name="sexo"] { width: 160px !important; } /* Para masculino/femenino */
        select[name="categoria_id"] { width: 90px !important; } /* Para G1, G2, G3 */
        select[name="sector_id"] { width: 160px !important; } /* Para sectores */
        select[name="profesional"] { width: 140px !important; } /* Para profesional */
        
        /* Botones compactos como en index.html */
        .btn{
            display:inline-block;border:1px solid var(--line);background:#fff;color:var(--ink);
            padding:.45rem .7rem;border-radius:.5rem;font-size:.9rem;cursor:pointer;text-decoration:none;
        }
        .btn:hover{filter:brightness(0.98)}
        .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
        .btn-primary:hover{background:var(--brand-600);border-color:var(--brand-600)}
        .btn-success{background:var(--success);border-color:var(--success);color:#fff}
        .btn-secondary{background:#6c757d;border-color:#6c757d;color:#fff}
        .btn-secondary:hover{background:#5a6268;border-color:#5a6268}
        
        input:focus, select:focus {
            border-color: var(--brand);
            outline: none;
            box-shadow: 0 0 0 3px rgba(13,110,253,0.1);
        }
        input[type="submit"], button { 
            background: var(--brand); 
            color: white; 
            padding: .5rem .8rem; 
            border: none; 
            border-radius: .5rem; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            margin: 8px 6px 0 0; 
        }
        input[type="submit"]:hover, button:hover { 
            background: var(--brand-600); 
        }
        .mensaje { 
            padding: 12px; 
            border-radius: 6px;
            margin: 12px 0; 
            font-size: 14px; 
            font-weight: 500;
        }
        .mensaje.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .mensaje.exito { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        small { 
            color: var(--muted); 
            font-size: 12px; 
            font-weight: normal;
        }
        .volver { 
            display: inline-block; 
            margin: 16px 0; 
            background: var(--brand); 
            color: white !important; 
            text-decoration: none; 
            font-size: 14px; 
            font-weight: 600;
            padding: .5rem .8rem; 
            border-radius: .5rem; 
            transition: all 0.2s ease;
        }
        .volver:hover { 
            background: var(--brand-600); 
            text-decoration: none;
        }
        .loading { 
            display: none; 
            color: var(--brand); 
            font-style: italic; 
            font-size: 14px; 
            font-weight: 500;
        }
        .encontrado { 
            background: #d1ecf1; 
            color: #0c5460;
            border: 1px solid #bee5eb; 
            padding: 8px; 
            border-radius: 6px; 
            margin: 8px 0; 
            font-size: 14px; 
            font-weight: 500;
        }
        .patologias-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--line);
            border-radius: 6px;
            padding: 12px;
            background: #f8f9fa;
        }
        .patologia-item {
            margin: 6px 0;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .patologia-item input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.1);
            flex-shrink: 0;
            margin-top: 2px;
        }
        .patologia-label,
        .patologia-item label {
            flex: 1;
            cursor: pointer;
            line-height: 1.3;
            display: flex !important;
            flex-direction: column;
        }
        
        /* Estilos para botones de contraer/expandir - MODERNOS Y COMPACTOS */
        .categoria-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px 12px;
            margin: 4px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .categoria-header:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: var(--brand);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(13,110,253,0.15);
        }
        
        .categoria-toggle {
            background: var(--brand);
            border: none;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .categoria-toggle:hover {
            background: var(--brand-600);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 2px 6px rgba(13,110,253,0.3);
        }
        
        /* Estilos para familias - ULTRA COMPACTOS */
        .familia-header {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 3px 6px;
            margin: 1px 0;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            border-left: 2px solid var(--brand);
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            justify-content: space-between;
        }
        
        .familia-header:hover {
            background: rgba(13,110,253,0.08);
            transform: translateX(4px);
            box-shadow: 0 1px 3px rgba(13,110,253,0.15);
        }
        
        .familia-toggle {
            background: #6c757d;
            border: none;
            color: white;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
            padding: 1px 3px;
            border-radius: 50%;
            transition: all 0.2s ease;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .familia-toggle:hover {
            background: var(--brand);
            transform: scale(1.1);
        }
        
        .familia-content {
            transition: all 0.2s ease;
            overflow: hidden;
            margin-left: 12px;
            padding-left: 6px;
            border-left: 1px dashed #dee2e6;
        }
        
        .familia-content.collapsed {
            display: none;
            margin: 0;
            padding: 0;
        }
        
        .categoria-content {
            transition: all 0.3s ease;
            overflow: hidden;
            padding: 6px;
        }
        
        .categoria-content.collapsed {
            display: none;
        }

        /* Estilos para botones de control de categorías - MODERNOS */
        .btn-categoria-control {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-600) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(13,110,253,0.2);
            margin: 0 4px;
        }
        
        .btn-categoria-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13,110,253,0.3);
        }

        .btn-categoria-control:active {
            transform: translateY(0);
        }
        
        .categoria-badge {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-600) 100%);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .badge-puntos {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 8px;
            margin-left: 4px;
            font-weight: 600;
        }
        
        /* Forzar visibilidad de todas las categorías */
        .categoria-seccion {
            display: block !important;
            margin-bottom: 8px;
        }
        
        /* Estilos para banners de categorías específicas con colores distintivos */
        .subcategoria-header {
            padding: 8px 12px;
            margin: 6px 0;
            font-weight: 600;
            font-size: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .subcategoria-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Diabetes - Gradiente Azul/Verde */
        .banner-diabetes {
            background: linear-gradient(135deg, #e3f2fd 0%, #c8e6c9 100%);
            border-left: 4px solid #1976d2;
            color: #1565c0;
        }
        
        /* Trastornos Tiroideos - Gradiente Púrpura */
        .banner-tiroides {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 4px solid #7b1fa2;
            color: #6a1b9a;
        }
        
        /* Problemas Psicosociales (Z) - Gradiente Naranja */
        .banner-psicosocial {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            border-left: 4px solid #f57c00;
            color: #ef6c00;
        }
        
        /* Hepáticas - Gradiente Amarillo/Verde */
        .banner-hepaticas {
            background: linear-gradient(135deg, #fffde7 0%, #f0f4c3 100%);
            border-left: 4px solid #827717;
            color: #689f38;
        }
        
        /* Gastrointestinales - Gradiente Rosa */
        .banner-gastro {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            border-left: 4px solid #c2185b;
            color: #ad1457;
        }
        
        /* Respiratorias - Gradiente Celeste */
        .banner-respiratorias {
            background: linear-gradient(135deg, #e0f2f1 0%, #80cbc4 100%);
            border-left: 4px solid #00695c;
            color: #004d40;
        }
        
        /* Renales - Gradiente Azul Profundo */
        .banner-renales {
            background: linear-gradient(135deg, #e8eaf6 0%, #9fa8da 100%);
            border-left: 4px solid #303f9f;
            color: #283593;
        }
        
        /* Oftalmológicas - Gradiente Verde Esmeralda */
        .banner-oftalmo {
            background: linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%);
            border-left: 4px solid #388e3c;
            color: #2e7d32;
        }
        
        /* Neoplasias/Cáncer - Gradiente Rojo Fuerte */
        .banner-neoplasias {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #d32f2f;
            color: #c62828;
        }
        
        /* Maltrato/Violencia - Gradiente Rojo Oscuro */
        .banner-maltrato {
            background: linear-gradient(135deg, #fce4ec 0%, #e1bee7 100%);
            border-left: 4px solid #8e24aa;
            color: #7b1fa2;
        }
        
        /* Sangre/Coagulación - Gradiente Granate */
        .banner-sangre {
            background: linear-gradient(135deg, #fff3e0 0%, #d7ccc8 100%);
            border-left: 4px solid #5d4037;
            color: #4e342e;
        }
        
        /* Discapacidad Intelectual - Gradiente Índigo */
        .banner-discapacidad {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border-left: 4px solid #3f51b5;
            color: #303f9f;
        }
        
        /* Ansiedad/Personalidad - Gradiente Lime */
        .banner-ansiedad {
            background: linear-gradient(135deg, #f9fbe7 0%, #dcedc8 100%);
            border-left: 4px solid #689f38;
            color: #558b2f;
        }
        
        /* Sueño - Gradiente Violeta Profundo */
        .banner-sueno {
            background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%);
            border-left: 4px solid #673ab7;
            color: #512da8;
        }
        
        /* Anemias - Gradiente Rojo Suave */
        .banner-anemia {
            background: linear-gradient(135deg, #ffeaea 0%, #ffcdd2 100%);
            border-left: 4px solid #d32f2f;
            color: #c62828;
        }
        
        /* Intoxicación Aguda - Gradiente Naranja Fuerte */
        .banner-intoxicacion {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            border-left: 4px solid #ff6f00;
            color: #e65100;
        }
        
        /* VIH/SIDA - Gradiente Rojo Intenso */
        .banner-vih {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #e91e63;
            color: #c2185b;
        }
        
        /* Depresión - Gradiente Azul Grisáceo */
        .banner-depresion {
            background: linear-gradient(135deg, #eceff1 0%, #b0bec5 100%);
            border-left: 4px solid #455a64;
            color: #37474f;
        }

        /* Cerebrovascular - Gradiente Morado */
        .banner-cerebrovascular {
            background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 100%);
            border-left: 4px solid #8e24aa;
            color: #4a148c;
        }

        /* Psicóticos - Gradiente Púrpura */
        .banner-psicoticos {
            background: linear-gradient(135deg, #f8bbd9 0%, #e1bee7 100%);
            border-left: 4px solid #ad1457;
            color: #880e4f;
        }

        /* Lupus - Gradiente Rojo Coral */
        .banner-lupus {
            background: linear-gradient(135deg, #ffcccb 0%, #ffa0a0 100%);
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        /* Parkinson - Gradiente Azul Neurológico */
        .banner-parkinson {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #1976d2;
            color: #0d47a1;
        }

        /* Discapacidad Intelectual - Gradiente Violeta */
        .banner-discapacidad {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 4px solid #7b1fa2;
            color: #4a148c;
        }

        .buttons-container {
            text-align: center;
            margin: 12px 0;
            padding: 8px;
            background: rgba(13,110,253,0.03);
            border-radius: 8px;
        }
        
        /* Estilos para resumen de patologías */
        .patologias-resumen {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            min-height: 35px;
        }
        .patologias-titulo {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .pat-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .pat {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 500;
            border: 1px solid transparent;
            font-size: 11px;
        }
        .pat-diabetes {
            background: #dcfce7;
            color: #16a34a;
            border-color: #86efac;
        }
        .pat-hta {
            background: #fee2e2;
            color: #991b1b;
            border-color: #fca5a5;
        }
        .pat-dislipidemia {
            background: #fef3c7;
            color: #92400e;
            border-color: #fde68a;
        }
        .pat-empty {
            color: #6c757d;
            font-style: italic;
            font-size: 12px;
        }
    </style>
    
</head>
<body>
    <div class="container">
        <a href="/" class="volver">← Volver al inicio</a>
        
        <div class="header">
            <div style="width: 200px; text-align: left;">
                <img src="/static/logo_ecicep.jpg" alt="Logo ECICEP" style="height: 150px; width: auto; max-width: 200px; object-fit: contain;">
            </div>
            <div style="flex: 1; text-align: center;">
                <h2>Ingresar nuevo usuario y control</h2>
            </div>
            <div style="width: 200px; text-align: right;">
                <img src="/static/dbecicep.png" alt="DB ECICEP" style="height: 150px; width: auto; max-width: 200px; object-fit: contain;">
            </div>
        </div>
        <!-- Cuadro de cálculo de riesgo ECICEP flotante -->
        <div id="cuadro-riesgo-flotante" style="position:fixed; top:24px; right:24px; z-index:9999; background:#f1f8ff; border:2px solid #3b82f6; border-radius:12px; padding:18px 28px; box-shadow:0 4px 24px rgba(0,0,0,0.13); min-width:340px; max-width:420px;">
            <span style="font-size: 20px; font-weight: bold; color: #2563eb;"><img src="/static/graficos/03885027K_imc.png" style="height: 1.2em; vertical-align: middle; margin-right: 6px;"> Cálculo de Riesgo ECICEP</span><br>
            <span style="font-size: 18px; font-weight: 600;">Total de puntos: <span id="total-puntos">0</span>  &nbsp; Categoría: <span id="categoria-riesgo" style="background: #f3f4f6; border-radius: 6px; padding: 2px 8px; font-weight: bold;">G0</span></span><br>
            <span style="font-size: 15px;">
                <span style="color: #16a34a;">🟢 1 punto = G1 (Riesgo Leve)</span> |
                <span style="color: #f59e0b;">🟡 2-4 puntos = G2 (Riesgo Moderado)</span> |
                <span style="color: #dc2626;">🔴 ≥5 puntos = G3 (Riesgo Alto)</span>
            </span>
        </div>
        
        {% if mensaje %}
            {% if 'RUN inválido' in mensaje or 'Error' in mensaje or 'violates' in mensaje or 'constraint' in mensaje or 'null value' in mensaje %}
                <div class="mensaje error">
                    {{ mensaje }}
                    <br><small style="color: #666;">ℹ️ <strong>Importante:</strong> Los datos del formulario se han preservado para que puedas corregir el error.</small>
                </div>
            {% else %}
                <div class="mensaje exito">{{ mensaje }}</div>
            {% endif %}
        {% endif %}

        <script>
        // Flag global: no limpiar formulario si hay error del servidor
        window.HAS_ERROR = {% if mensaje and ('Error' in mensaje or 'error' in mensaje or 'violates' in mensaje or 'constraint' in mensaje or 'null value' in mensaje or 'obligatorio' in mensaje or 'válido' in mensaje or 'inválido' in mensaje) %}true{% else %}false{% endif %};
        console.log('🚨 HAS_ERROR establecido a:', window.HAS_ERROR, 'Mensaje:', {{ mensaje|tojson|safe if mensaje else 'null' }});
        
        // Protección adicional: detectar errores durante la carga
        if (window.HAS_ERROR) {
            console.log('🛡️ Protección activada: No se limpiará el formulario debido a errores de validación');
            
            // Mostrar alert con el error para mayor visibilidad
            {% if mensaje %}
            setTimeout(function() {
                var mensajeError = {{ mensaje|tojson|safe }};
                var mensajeAmigable = '⚠️ Se encontró un problema:\n\n' + mensajeError + '\n\n✅ ¡Tranquilo! Los datos del formulario se han preservado.\n💡 Corrige el error y vuelve a intentar.';
                alert(mensajeAmigable);
            }, 500); // Pequeño delay para que la página termine de cargar
            {% endif %}
        }
        </script>

        <form method="post" autocomplete="off">
            <fieldset>
                <legend>Datos del usuario</legend>
                <label>RUN: <input type="text" name="run" id="run" required maxlength="13" style="width:180px;"></label>
                
                <div id="loading" class="loading">Buscando usuario...</div>
                <div id="usuario-encontrado" class="encontrado" style="display: none;">
                    <strong>Usuario encontrado en la base de datos. Los campos se han completado automáticamente.</strong>
                </div>
                <div id="usuario-nuevo" class="nuevo-usuario" style="display: none; background: #e8f5e8; border: 1px solid #28a745; border-radius: 6px; padding: 12px; margin: 8px 0; color: #155724;">
                    <strong>🆕 Usuario nuevo</strong>
                    <p style="margin: 4px 0 0 0; font-size: 13px;">El RUN no fue encontrado en la base de datos. Puedes completar los campos para crear un nuevo usuario.</p>
                </div>
                <label>Nombre: <input type="text" name="nombre" id="nombre" required></label>
                <label>Fecha de nacimiento: <input type="date" name="fecha_nacimiento" id="fecha_nacimiento" required style="min-width:180px;max-width:220px;"></label>
                <label>Edad (años): <input type="text" name="edad" id="edad" readonly placeholder="--"></label>
                <script>
                    // Calcula edad en años (entero) desde una fecha AAAA-MM-DD
                    function calcularEdadDesde(fechaStr) {
                        if (!fechaStr) return '';
                        const parts = fechaStr.split('-');
                        if (parts.length !== 3) return '';
                        const anio = parseInt(parts[0], 10);
                        const mes = parseInt(parts[1], 10) - 1; // 0-11
                        const dia = parseInt(parts[2], 10);
                        const nacimiento = new Date(anio, mes, dia);
                        if (isNaN(nacimiento.getTime())) return '';
                        const hoy = new Date();
                        let edad = hoy.getFullYear() - nacimiento.getFullYear();
                        const m = hoy.getMonth() - nacimiento.getMonth();
                        if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
                            edad--;
                        }
                        return edad >= 0 ? edad : '';
                    }

                    function actualizarEdad() {
                        console.log('🎂 Función actualizarEdad() llamada');
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        const inputEdad = document.getElementById('edad');
                        
                        console.log('📅 Campo fecha_nacimiento encontrado:', !!inputFecha);
                        console.log('🔢 Campo edad encontrado:', !!inputEdad);
                        
                        if (!inputFecha || !inputEdad) {
                            console.log('❌ No se encontraron elementos fecha_nacimiento o edad');
                            return;
                        }
                        
                        const fechaValue = inputFecha.value;
                        console.log('� Valor fecha de nacimiento:', fechaValue);
                        
                        const edad = calcularEdadDesde(fechaValue);
                        console.log('🎂 Edad calculada:', edad);
                        
                        inputEdad.value = edad === '' ? '' : parseInt(edad, 10);
                        console.log('✅ Edad establecida en el campo:', inputEdad.value);
                        
                        validarFechaNacimiento();
                        
                        // Reaplicar estilos de PA según nueva edad
                        try {
                            const psis = document.querySelector('input[name="presion_sistolica"]');
                            if (psis && psis.value) { 
                                console.log('🩺 Actualizando validación de presión arterial');
                                psis.dispatchEvent(new Event('input')); 
                            }
                        } catch (e) {
                            console.log('⚠️ Error actualizando presión arterial:', e);
                        }
                    }

                    // Establece dinámicamente min/max en fecha de nacimiento para edades 15..112
                    function actualizarRangoFechaNacimiento() {
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        if (!inputFecha) return;
                        const hoy = new Date();
                        const pad = (n) => String(n).padStart(2, '0');
                        const fmt = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
                        const minDate = new Date(hoy.getFullYear() - 112, hoy.getMonth(), hoy.getDate()); // edad máxima 112
                        const maxDate = new Date(hoy.getFullYear() - 15, hoy.getMonth(), hoy.getDate());  // edad mínima 15
                        inputFecha.min = fmt(minDate);
                        inputFecha.max = fmt(maxDate);
                    }

                    // Valida rango de edad 15..112 y muestra mensaje nativo
                    function validarFechaNacimiento() {
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        if (!inputFecha || !inputFecha.value) { inputFecha && inputFecha.setCustomValidity(''); return; }
                        const edad = calcularEdadDesde(inputFecha.value);
                        const edadNum = parseInt(edad, 10);
                        if (isNaN(edadNum)) { inputFecha.setCustomValidity('Fecha inválida'); return; }
                        if (edadNum < 15 || edadNum > 112) {
                            if (edadNum < 15) {
                                inputFecha.setCustomValidity('⚠️ ECICEP requiere usuarios de 15 años o más. Edad actual: ' + edadNum + ' años.');
                            } else {
                                inputFecha.setCustomValidity('⚠️ Edad muy alta (' + edadNum + ' años). Verifica que la fecha sea correcta.');
                            }
                        } else {
                            inputFecha.setCustomValidity('');
                        }
                    }

                    document.addEventListener('DOMContentLoaded', function() {
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        // Rango dinámico según la fecha actual
                        actualizarRangoFechaNacimiento();
                        if (inputFecha) {
                            // Variable para evitar alerts repetidos
                            let alertMostrado = false;
                            let ultimaEdadValidada = null;
                            
                            // Calcular al cargar si ya hay valor
                            if (inputFecha.value) { actualizarEdad(); }
                            
                            // Recalcular al modificar
                            ['change','input'].forEach(ev => inputFecha.addEventListener(ev, function(e){
                                actualizarEdad();
                                validarFechaNacimiento(); // Actualizar validación HTML5
                                
                                // Resetear flag de alert cuando el usuario está editando
                                if (e.type === 'input') {
                                    alertMostrado = false;
                                    ultimaEdadValidada = null;
                                    // Quitar resaltado mientras edita
                                    inputFecha.style.border = '';
                                    inputFecha.style.backgroundColor = '';
                                }
                            }));
                            
                            // Validación solo al perder foco y cuando cambia la edad
                            inputFecha.addEventListener('blur', function(e) {
                                const edadStr = document.getElementById('edad') ? document.getElementById('edad').value : '';
                                const edadNum = parseInt(edadStr, 10);
                                
                                // Solo mostrar alert si la edad cambió y no se ha mostrado ya
                                if (!isNaN(edadNum) && !alertMostrado && ultimaEdadValidada !== edadNum) {
                                    ultimaEdadValidada = edadNum;
                                    
                                    if (edadNum < 15) {
                                        alertMostrado = true;
                                        
                                        // Mostrar alert informativo
                                        alert('⚠️ Restricción de edad:\n\nECICEP permite el ingreso de usuarios de 15 o más años.\n\n💡 Puedes corregir la fecha de nacimiento si es necesario.');
                                        
                                        // Resaltar el campo para indicar que necesita corrección
                                        inputFecha.style.border = '2px solid #ffc107';
                                        inputFecha.style.backgroundColor = '#fff8e1';
                                        
                                    } else if (edadNum > 112) {
                                        alertMostrado = true;
                                        
                                        alert('⚠️ Verificación de edad:\n\nLa edad calculada es muy alta (más de 112 años).\n\n💡 Por favor, corrobora que la fecha de nacimiento sea correcta.');
                                        
                                        // También resaltar para edades muy altas
                                        inputFecha.style.border = '2px solid #ff9800';
                                        inputFecha.style.backgroundColor = '#fff3e0';
                                    } else {
                                        // Edad válida - quitar cualquier resaltado
                                        inputFecha.style.border = '';
                                        inputFecha.style.backgroundColor = '';
                                    }
                                }
                                
                                // Mostrar mensaje de validación nativo
                                inputFecha.reportValidity();
                            });
                            
                            // Permitir resetear el estado de validación con Enter
                            inputFecha.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    alertMostrado = false;
                                    ultimaEdadValidada = null;
                                    inputFecha.blur(); // Disparar validación
                                }
                            });
                            
                            // Resetear estado al hacer doble clic (para casos donde el usuario quiere empezar de nuevo)
                            inputFecha.addEventListener('dblclick', function() {
                                alertMostrado = false;
                                ultimaEdadValidada = null;
                                inputFecha.style.border = '';
                                inputFecha.style.backgroundColor = '';
                                inputFecha.value = '';
                                document.getElementById('edad').value = '--';
                            });
                        }
                    });
                </script>
                <label>Dirección: <input type="text" name="direccion" id="direccion" style="min-width:300px;"></label>
                <div class="campos-linea">
                    <label>Teléfono: <input type="text" name="telefono" id="telefono" placeholder="Ej: +56912345678" style="min-width:200px;max-width:250px;"></label>
                    <label>Fecha de ingreso: <input type="date" name="fecha_ingreso" id="fecha_ingreso" style="min-width:200px;max-width:250px;" placeholder="AAAA-MM-DD"></label>
                </div>
                <small>Fecha de ingreso al sistema (se completa automáticamente al guardar si no se especifica)</small>
                <div class="campos-linea">
                    <label>Sexo:
                        <select name="sexo" id="sexo" required style="min-width:180px;max-width:220px;">
                            <option value="">-- Seleccione sexo --</option>
                            <option value="masculino">Masculino</option>
                            <option value="femenino">Femenino</option>
                        </select>
                    </label>
                    <label>Categoría:
                        <select name="categoria_id" id="categoria_id" style="min-width:150px;">
                            <option value="">-- Seleccione categoría --</option>
                            {% for cat in categorias %}
                                <option value="{{ cat.id }}">G{{ cat.id }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label>Sector:
                        <select name="sector_id" id="sector_id" style="min-width:180px;">
                            <option value="">-- Seleccione sector --</option>
                            {% for sec in sectores %}
                                <option value="{{ sec.id }}">{{ sec.nombre|upper }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
                
                <!-- Título de patologías con botón de colapsar -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <label style="margin-bottom: 0; font-weight: 600; color: #374151;">Patologías (Sistema ECICEP 2025):</label>
                    <button type="button" id="btn-toggle-patologias" onclick="togglePatologiasContainer()" 
                            style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                        👁️ Mostrar Patologías
                    </button>
                </div>
                
                <!-- Resumen de patologías guardadas (desde usuario_patologias) -->
                <div class="patologias-resumen" style="margin: 8px 0 12px 0; border-top: 1px solid #e5e7eb; padding-top: 12px; position: relative;">
                    <div class="patologias-titulo" style="color: #059669; font-weight: 600;">Patologías Guardadas en BD:</div>
                    
                    <div id="patologias-guardadas" class="pat-badges" style="border: 1px solid #059669; border-radius: 4px; background: #ecfdf5; margin-right: 0;">
                        <span class="pat-empty" style="color: #6b7280;">Sin patologías guardadas en base de datos</span>
                    </div>
                    
                    <!-- Botones de gestión de patologías -->
                    <div id="botones-gestion-patologias" style="margin-top: 8px; display: block; opacity: 0.5; pointer-events: none; padding: 10px; border: 2px solid #ccc; border-radius: 5px; background: #f9f9f9;">
                        <div style="margin-bottom: 4px;">
                            <small style="color: #6c757d;">💡 Los botones se habilitarán al ingresar un RUN válido</small>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" id="btn-guardar-patologias" onclick="window.guardarPatologiasIndependiente()" 
                                    style="background: #198754; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500;" 
                                    title="Guardar solo las patologías seleccionadas" disabled>
                                💾 Guardar Patologías
                            </button>
                            <button type="button" id="btn-modificar-patologias" onclick="window.modificarPatologias(event)" 
                                    style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500;" 
                                    disabled aria-disabled="true">
                                ✏️ Modificar Patologías
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor de patologías - colapsado por defecto -->
                <div id="patologias-main-container" style="display: none; transition: all 0.3s ease;">
                    <div style="margin: 8px 0 12px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" class="btn-categoria-control" onclick="expandirTodasFamilias()" style="background: #198754; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                            📂 Expandir Todas
                        </button>
                        <button type="button" class="btn-categoria-control" onclick="contraerTodasFamilias()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                            📁 Contraer Todas
                        </button>
                        <button type="button" class="btn-categoria-control" onclick="expandirSoloSeleccionadasFamilias()" style="background: #0d6efd; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                            ✅ Expandir Solo Seleccionadas
                        </button>
                    </div>
<!-- === CONTENEDOR ÚNICO DE PATOLOGÍAS === -->
<div class="patologias-ecicep-container" style="max-height: none; min-height: 600px; overflow-y: visible; border: 1.5px solid var(--line); border-radius: 10px; padding: 24px 18px 18px 18px; background: #f8f9fa; box-shadow: 0 2px 12px rgba(13,110,253,0.07);">
<!-- ===================== CATEGORÍA 01: PATOLOGÍAS MÚSCULO-ESQUELÉTICAS ===================== -->
<div class="categoria-seccion" id="cat-musculoesqueleticas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-musculoesqueleticas')">
    <h4>🦴 PATOLOGÍAS MÚSCULO-ESQUELÉTICAS
      <span class="categoria-badge" id="badge-musculoesqueleticas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-musculoesqueleticas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-musculoesqueleticas">

    <!-- ===== Familia: Artritis reumatoidea (1) ===== -->
    <div class="familia" data-familia-id="fam-artritis-reumatoidea" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-artritis-reumatoidea-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-artritis-reumatoidea-block', this)">+</button>
        Artritis reumatoidea <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-artritis-reumatoidea-block">

        <!-- M05 — AR con factor reumatoide (seropositiva) -->
        <div class="subcategoria-header" style="background:#e7f0ff;padding:8px 12px;margin:6px 0;border-left:3px solid #0d6efd;font-weight:600;font-size:12px;">
          M05 — Artritis reumatoide con factor reumatoide (seropositiva)
        </div>

        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M050" value="M05.0"><label for="M050"><strong>M05.0 — Síndrome de Felty</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M051" value="M05.1"><label for="M051"><strong>M05.1 — Enfermedad pulmonar reumatoide con AR</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M052" value="M05.2"><label for="M052"><strong>M05.2 — Vasculitis reumatoide con AR</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M053" value="M05.3"><label for="M053"><strong>M05.3 — Cardiopatía reumatoide con AR</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M058" value="M05.8"><label for="M058"><strong>M05.8 — Otras AR con factor reumatoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M059" value="M05.9"><label for="M059"><strong>M05.9 — AR con factor reumatoide, no especificada</strong></label></div>

        <!-- M06 — Otras formas de AR (incluye seronegativa) -->
        <div class="subcategoria-header" style="background:#e7f0ff;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #0d6efd;font-weight:600;font-size:12px;">
          M06 — Otras artritis reumatoides (incluye seronegativa)
        </div>

        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M060" value="M06.0"><label for="M060"><strong>M06.0 — AR seronegativa (sin factor reumatoide)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M061" value="M06.1"><label for="M061"><strong>M06.1 — Enfermedad de Still del adulto</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M062" value="M06.2"><label for="M062"><strong>M06.2 — Bursitis reumatoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M063" value="M06.3"><label for="M063"><strong>M06.3 — Nódulo reumatoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M064" value="M06.4"><label for="M064"><strong>M06.4 — Poliartropatía inflamatoria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M068" value="M06.8"><label for="M068"><strong>M06.8 — Otras AR especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M069" value="M06.9"><label for="M069"><strong>M06.9 — Artritis reumatoide, no especificada</strong></label></div>
      </div>
    </div>
    <!-- ===== FIN Familia: Artritis reumatoidea ===== -->

    <!-- ===== Familia: Artrosis de rodilla, cadera u otro tipo (1) ===== -->
    <div class="familia" data-familia-id="fam-artrosis" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-artrosis-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-artrosis-block', this)">+</button>
        Artrosis de rodilla, cadera u otro tipo <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-artrosis-block">

        <!-- M15 — Poliartr(osis)/Poliosteoartritis -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:6px 0;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M15 — Poliartr(osis) / Poliosteoartritis
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M150" value="M15.0"><label for="M150"><strong>M15.0 — Artrosis generalizada primaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M151" value="M15.1"><label for="M151"><strong>M15.1 — Nódulos de Heberden (con artropatía)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M152" value="M15.2"><label for="M152"><strong>M15.2 — Nódulos de Bouchard (con artropatía)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M153" value="M15.3"><label for="M153"><strong>M15.3 — Artritis múltiple secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M154" value="M15.4"><label for="M154"><strong>M15.4 — (Osteo)artritis erosiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M158" value="M15.8"><label for="M158"><strong>M15.8 — Otras poliosteoartritis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M159" value="M15.9"><label for="M159"><strong>M15.9 — Poliosteoartritis, no especificada</strong></label></div>

        <!-- M16 — Coxartrosis (cadera) -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M16 — Artrosis de cadera (coxartrosis)
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M160" value="M16.0"><label for="M160"><strong>M16.0 — Artrosis primaria bilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M161" value="M16.1"><label for="M161"><strong>M16.1 — Artrosis primaria unilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M162" value="M16.2"><label for="M162"><strong>M16.2 — Artrosis bilateral por displasia de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M163" value="M16.3"><label for="M163"><strong>M16.3 — Artrosis unilateral por displasia de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M164" value="M16.4"><label for="M164"><strong>M16.4 — Artrosis postraumática bilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M165" value="M16.5"><label for="M165"><strong>M16.5 — Artrosis postraumática unilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M166" value="M16.6"><label for="M166"><strong>M16.6 — Otras artrosis secundarias de cadera, bilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M167" value="M16.7"><label for="M167"><strong>M16.7 — Otras artrosis secundarias de cadera, unilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M169" value="M16.9"><label for="M169"><strong>M16.9 — Artrosis de cadera, no especificada</strong></label></div>

        <!-- M17 — Gonartrosis (rodilla) -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M17 — Artrosis de rodilla (gonartrosis)
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M170" value="M17.0"><label for="M170"><strong>M17.0 — Artrosis primaria bilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M171" value="M17.1"><label for="M171"><strong>M17.1 — Artrosis primaria unilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M172" value="M17.2"><label for="M172"><strong>M17.2 — Artrosis postraumática bilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M173" value="M17.3"><label for="M173"><strong>M17.3 — Artrosis postraumática unilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M174" value="M17.4"><label for="M174"><strong>M17.4 — Otras artrosis secundarias de rodilla, bilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M175" value="M17.5"><label for="M175"><strong>M17.5 — Otras artrosis secundarias de rodilla, unilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M179" value="M17.9"><label for="M179"><strong>M17.9 — Artrosis de rodilla, no especificada</strong></label></div>

        <!-- M18 — Artrosis primera CMC -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M18 — Artrosis de la primera articulación carpometacarpiana (CMC)
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M180" value="M18.0"><label for="M180"><strong>M18.0 — Artrosis primaria bilateral de las primeras CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M181" value="M18.1"><label for="M181"><strong>M18.1 — Artrosis primaria unilateral de la primera CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M182" value="M18.2"><label for="M182"><strong>M18.2 — Artrosis postraumática bilateral de las primeras CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M183" value="M18.3"><label for="M183"><strong>M18.3 — Artrosis postraumática unilateral de la primera CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M184" value="M18.4"><label for="M184"><strong>M18.4 — Otras artrosis secundarias de las primeras CMC, bilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M185" value="M18.5"><label for="M185"><strong>M18.5 — Otras artrosis secundarias de la primera CMC, unilateral</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M189" value="M18.9"><label for="M189"><strong>M18.9 — Artrosis de la primera CMC, no especificada</strong></label></div>

        <!-- M19 — Otras / no especificadas -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M19 — Otras artrosis y artrosis no especificadas
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M190" value="M19.0"><label for="M190"><strong>M19.0 — Artrosis primaria de otras articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M191" value="M19.1"><label for="M191"><strong>M19.1 — Artrosis postraumática de otras articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M192" value="M19.2"><label for="M192"><strong>M19.2 — Artrosis secundaria de otras articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M199" value="M19.9"><label for="M199"><strong>M19.9 — Artrosis, no especificada</strong></label></div>

      </div>
    </div>
        <!-- ===== FIN Familia: Artrosis ===== -->

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion cat-musculoesqueleticas -->

        <!-- ===================== CATEGORÍA 02: PATOLOGÍAS CARDIOVASCULARES ===================== -->
        <div class="categoria-seccion" id="cat-cardiovascular" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-cardiovascular')">
    <h4>❤️ PATOLOGÍAS CARDIOVASCULARES
      <span class="categoria-badge" id="badge-cardiovascular">0</span>
      </h4>
    <button type="button" class="categoria-toggle" id="toggle-cardiovascular">+</button>
  </div>

    <div class="categoria-content collapsed" id="content-cardiovascular">

        <!-- ===== Familia: Hipertensión (1) ===== -->
        <div class="familia" data-familia-id="fam-hta" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hta-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hta-block', this)">+</button>
        Hipertensión<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-hta-block">
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I10" value="I10"><label for="I10"><strong>I10 — Hipertensión esencial (primaria)</strong></label></div>

  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I110" value="I11.0"><label for="I110"><strong>I11.0 — Cardiopatía hipertensiva con insuficiencia cardiaca</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I119" value="I11.9"><label for="I119"><strong>I11.9 — Cardiopatía hipertensiva, no especificada</strong></label></div>

  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I120" value="I12.0"><label for="I120"><strong>I12.0 — Enfermedad renal hipertensiva con insuficiencia renal</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I129" value="I12.9"><label for="I129"><strong>I12.9 — Enfermedad renal hipertensiva, no especificada</strong></label></div>

  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I130" value="I13.0"><label for="I130"><strong>I13.0 — Cardiopatía y enfermedad renal hipertensivas con insuficiencia cardiaca</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I131" value="I13.1"><label for="I131"><strong>I13.1 — Cardiopatía y enfermedad renal hipertensivas con insuficiencia renal</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I132" value="I13.2"><label for="I132"><strong>I13.2 — Cardiopatía y enfermedad renal hipertensivas con insuficiencia cardiaca y renal</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I139" value="I13.9"><label for="I139"><strong>I13.9 — Cardiopatía y enfermedad renal hipertensivas, no especificadas</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Isquemia cerebral transitoria (TIA) (1) ===== -->
    <div class="familia" data-familia-id="fam-tia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tia-block', this)">+</button>
        Isquemia cerebral transitoria (TIA)<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-tia-block">
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G450" value="G45.0"><label for="G450"><strong>G45.0 — Síndrome de la arteria vertebrobasilar</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G451" value="G45.1"><label for="G451"><strong>G45.1 — Infarto cerebral transitorio</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G452" value="G45.2"><label for="G452"><strong>G45.2 — AIT por arteria carotídea</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G453" value="G45.3"><label for="G453"><strong>G45.3 — Amaurosis fugaz</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G454" value="G45.4"><label for="G454"><strong>G45.4 — AIT de múltiples y bilaterales arterias</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G458" value="G45.8"><label for="G458"><strong>G45.8 — Otros síndromes isquémicos transitorios</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G459" value="G45.9"><label for="G459"><strong>G45.9 — AIT, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedad cerebrovascular / ACV / AVE (2) ===== -->
    <div class="familia" data-familia-id="fam-acv" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-acv-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-acv-block', this)">+</button>
        Enfermedad cerebrovascular / ACV / AVE<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-acv-block">
        <!-- G46.0–G46.8 -->
        <div class="subcategoria-header banner-cerebrovascular">G46.0 — Síndrome vascular cerebral en enfermedades cerebrovasculares, hemiplejia</div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G461" value="G46.1"><label for="G461"><strong>G46.1 — Síndrome de arteria cerebral anterior</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G462" value="G46.2"><label for="G462"><strong>G46.2 — Síndrome de arteria cerebral media</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G463" value="G46.3"><label for="G463"><strong>G46.3 — Síndrome de arteria cerebral posterior</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G464" value="G46.4"><label for="G464"><strong>G46.4 — Síndrome de arteria cerebelosa</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G465" value="G46.5"><label for="G465"><strong>G46.5 — Síndrome de tallo cerebral</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G466" value="G46.6"><label for="G466"><strong>G46.6 — Síndrome de arteria vertebral</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G467" value="G46.7"><label for="G467"><strong>G46.7 — Síndromes lacunares</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G468" value="G46.8"><label for="G468"><strong>G46.8 — Otros síndromes vasculares cerebrales</strong></label></div>

  <!-- I64 -->
  <div class="subcategoria-header banner-cerebrovascular">I64 — Accidente cerebrovascular, no especificado como hemorrágico o isquémico</div>

  <!-- I67.0, I67.1, I67.2, I67.3, I67.4, I67.5, I67.7, I67.8, I67.9 -->
  <div class="subcategoria-header banner-cerebrovascular">I67.0 — Dissección de arterias cerebrales (y otras anomalías vasculares)</div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I671" value="I67.1"><label for="I671"><strong>I67.1 — Aneurisma cerebral, no rotura</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I672" value="I67.2"><label for="I672"><strong>I67.2 — Aterosclerosis cerebral</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I673" value="I67.3"><label for="I673"><strong>I67.3 — Leucoencefalopatía vascular progresiva</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I674" value="I67.4"><label for="I674"><strong>I67.4 — Encefalopatía hipertensiva</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I675" value="I67.5"><label for="I675"><strong>I67.5 — Oclusión y estenosis de arterias precerebrales, no especificadas</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I677" value="I67.7"><label for="I677"><strong>I67.7 — Arteritis cerebral, no clasificada en otra parte</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I678" value="I67.8"><label for="I678"><strong>I67.8 — Otras enfermedades cerebrovasculares especificadas</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I679" value="I67.9"><label for="I679"><strong>I67.9 — Enfermedad cerebrovascular, no especificada</strong></label></div>

  <!-- I68.0, I68.1, I68.2, I68.8 -->
  <div class="subcategoria-header banner-cerebrovascular">I68.0 — Trastornos cerebrovasculares en enfermedades infecciosas y parasitarias</div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I681" value="I68.1"><label for="I681"><strong>I68.1 — Trastornos cerebrovasculares en enfermedades neoplásicas</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I682" value="I68.2"><label for="I682"><strong>I68.2 — Trastornos cerebrovasculares en enfermedades sistémicas del tejido conectivo</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I688" value="I68.8"><label for="I688"><strong>I68.8 — Trastornos cerebrovasculares en otras enfermedades clasificadas en otra parte</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedades cardiovasculares / IAM / cardiopatía isquémica (2) ===== -->
    <div class="familia" data-familia-id="fam-iam-isco" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-iam-isco-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-iam-isco-block', this)">+</button>
        Enfermedades cardiovasculares / IAM / cardiopatía isquémica<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-iam-isco-block">
        <!-- I20.0, I20.1, I20.8, I20.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I200" value="I20.0"><label for="I200"><strong>I20.0 — Angina inestable</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I201" value="I20.1"><label for="I201"><strong>I20.1 — Angina pectoris con espasmo documentado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I208" value="I20.8"><label for="I208"><strong>I20.8 — Otras formas de angina de pecho</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I209" value="I20.9"><label for="I209"><strong>I20.9 — Angina de pecho, no especificada</strong></label></div>

        <!-- I21.0–I21.4, I21.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I210" value="I21.0"><label for="I210"><strong>I21.0 — Infarto agudo de miocardio de pared anterior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I211" value="I21.1"><label for="I211"><strong>I21.1 — IAM de pared inferior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I212" value="I21.2"><label for="I212"><strong>I21.2 — IAM de otras localizaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I213" value="I21.3"><label for="I213"><strong>I21.3 — IAM no especificado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I214" value="I21.4"><label for="I214"><strong>I21.4 — IAM subendocárdico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I219" value="I21.9"><label for="I219"><strong>I21.9 — IAM, no especificado</strong></label></div>

        <!-- I22.0, I22.1, I22.8, I22.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I220" value="I22.0"><label for="I220"><strong>I22.0 — IAM subsecuente de pared anterior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I221" value="I22.1"><label for="I221"><strong>I22.1 — IAM subsecuente de pared inferior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I228" value="I22.8"><label for="I228"><strong>I22.8 — IAM subsecuente de otras localizaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I229" value="I22.9"><label for="I229"><strong>I22.9 — IAM subsecuente, no especificado</strong></label></div>

        <!-- I25.0–I25.6, I25.8, I25.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I250" value="I25.0"><label for="I250"><strong>I25.0 — Enfermedad coronaria aterosclerótica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I251" value="I25.1"><label for="I251"><strong>I25.1 — Enfermedad coronaria aterosclerótica de vasos nativos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I252" value="I25.2"><label for="I252"><strong>I25.2 — Infarto antiguo de miocardio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I253" value="I25.3"><label for="I253"><strong>I25.3 — Aneurisma de corazón</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I254" value="I25.4"><label for="I254"><strong>I25.4 — Complicaciones isquémicas crónicas del corazón</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I255" value="I25.5"><label for="I255"><strong>I25.5 — Miocardiopatía isquémica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I256" value="I25.6"><label for="I256"><strong>I25.6 — Isquemia silente del miocardio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I258" value="I25.8"><label for="I258"><strong>I25.8 — Otras enfermedades isquémicas crónicas del corazón</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I259" value="I25.9"><label for="I259"><strong>I25.9 — Enfermedad isquémica crónica del corazón, no especificada</strong></label></div>

        <!-- I51.0, I51.4–I51.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I510" value="I51.0"><label for="I510"><strong>I51.0 — Defecto de pared cardiaca adquirido</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I514" value="I51.4"><label for="I514"><strong>I51.4 — Miocarditis, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I515" value="I51.5"><label for="I515"><strong>I51.5 — Degeneración miocárdica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I516" value="I51.6"><label for="I516"><strong>I51.6 — Enfermedad cardiaca no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I517" value="I51.7"><label for="I517"><strong>I51.7 — Cardiomegalia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I518" value="I51.8"><label for="I518"><strong>I51.8 — Otras enfermedades del corazón especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I519" value="I51.9"><label for="I519"><strong>I51.9 — Enfermedad del corazón, no especificada</strong></label></div>

        <!-- I52.0, I52.1, I52.8 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I520" value="I52.0"><label for="I520"><strong>I52.0 — Trastornos cardiacos en enfermedades infecciosas y parasitarias clasificadas en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I521" value="I52.1"><label for="I521"><strong>I52.1 — Trastornos cardiacos en otras enfermedades clasificadas en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I528" value="I52.8"><label for="I528"><strong>I52.8 — Otros trastornos cardiacos en enfermedades clasificadas en otra parte</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Arritmia cardíaca / Taquicardia paroxística (1) ===== -->
    <div class="familia" data-familia-id="fam-taquiarritmia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-taquiarritmia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-taquiarritmia-block', this)">+</button>
        Arritmia cardíaca / Taquicardia paroxística<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-taquiarritmia-block">
        <!-- I47.x -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I470" value="I47.0"><label for="I470"><strong>I47.0 — Taquicardia supraventricular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I471" value="I47.1"><label for="I471"><strong>I47.1 — Taquicardia ventricular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I472" value="I47.2"><label for="I472"><strong>I47.2 — Taquicardia paroxística</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I479" value="I47.9"><label for="I479"><strong>I47.9 — Taquicardia paroxística, no especificada</strong></label></div>

        <!-- I49.0, I49.8, I49.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I490" value="I49.0"><label for="I490"><strong>I49.0 — Fibrilación y aleteo ventricular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I498" value="I49.8"><label for="I498"><strong>I49.8 — Otras arritmias cardiacas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I499" value="I49.9"><label for="I499"><strong>I49.9 — Arritmia cardiaca, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Fibrilación auricular / flutter (1) ===== -->
    <div class="familia" data-familia-id="fam-fa-flutter" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-fa-flutter-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-fa-flutter-block', this)">+</button>
        Fibrilación auricular / flutter<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-fa-flutter-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I480" value="I48.0"><label for="I480"><strong>I48.0 — Fibrilación auricular paroxística</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I481" value="I48.1"><label for="I481"><strong>I48.1 — Fibrilación auricular persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I482" value="I48.2"><label for="I482"><strong>I48.2 — Fibrilación auricular crónica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I483" value="I48.3"><label for="I483"><strong>I48.3 — Flutter auricular típico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I484" value="I48.4"><label for="I484"><strong>I48.4 — Flutter auricular atípico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I489" value="I48.9"><label for="I489"><strong>I48.9 — Fibrilación/Flutter auricular, no especificados</strong></label></div>
      </div>
    </div>

    

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

        <!-- ===================== CATEGORÍA: ❤️‍🩹 INSUFICIENCIA CARDIACA ===================== -->
        <div class="categoria-seccion" id="cat-insuficiencia-cardiaca" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-insuficiencia-cardiaca')">
    <h4>❤️‍🩹 INSUFICIENCIA CARDIACA
      <span class="categoria-badge" id="badge-insuficiencia-cardiaca">0</span>
      </h4>
    <button type="button" class="categoria-toggle" id="toggle-insuficiencia-cardiaca">+</button>
  </div>

    <div class="categoria-content collapsed" id="content-insuficiencia-cardiaca">

    <!-- ===== Familia: Insuficiencia cardíaca (1) ===== -->
    <div class="familia" data-familia-id="fam-ic" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-ic-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ic-block', this)">+</button>
        ❤️‍🩹 INSUFICIENCIA CARDIACA<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-ic-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I500" value="I50.0"><label for="I500"><strong>I50.0 — Insuficiencia cardiaca congestiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I501" value="I50.1"><label for="I501"><strong>I50.1 — Insuficiencia cardiaca izquierda</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I509" value="I50.9"><label for="I509"><strong>I50.9 — Insuficiencia cardiaca, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

  <!-- ===================== CATEGORÍA 03: FUNCIÓN LIMITADA / DISCAPACIDAD / DEPENDENCIA (2) ===================== -->
<div class="categoria-seccion" id="cat-discapacidad" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-discapacidad')">
    <h4>♿ FUNCIÓN LIMITADA / DISCAPACIDAD / DEPENDENCIA
      <span class="categoria-badge" id="badge-discapacidad">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-discapacidad">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-discapacidad">

    <!-- ===== Familia: Trastornos de la marcha y movilidad (R26.x) (2) ===== -->
    <div class="familia" data-familia-id="fam-marcha" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-marcha-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-marcha-block', this)">+</button>
        Trastornos de la marcha y la movilidad (R26.x)<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-marcha-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R260" value="R26.0"><label for="R260"><strong>R26.0 — Marcha atáxica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R261" value="R26.1"><label for="R261"><strong>R26.1 — Marcha paralítica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R262" value="R26.2"><label for="R262"><strong>R26.2 — Dificultad para caminar, no clasificada en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R268" value="R26.8"><label for="R268"><strong>R26.8 — Otras anomalías de la marcha y la movilidad</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dependencia de cuidados (Z74.x) (2) ===== -->
    <div class="familia" data-familia-id="fam-z74" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-z74-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-z74-block', this)">+</button>
        Problemas relacionados con la dependencia de cuidados (Z74.x)<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-z74-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z740" value="Z74.0"><label for="Z740"><strong>Z74.0 — Dependencia por limitación funcional</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z741" value="Z74.1"><label for="Z741"><strong>Z74.1 — Necesidad de asistencia con el cuidado personal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z742" value="Z74.2"><label for="Z742"><strong>Z74.2 — Dependencia de atención domiciliaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z743" value="Z74.3"><label for="Z743"><strong>Z74.3 — Necesidad de supervisión y asistencia continua</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z748" value="Z74.8"><label for="Z748"><strong>Z74.8 — Otros problemas de dependencia del cuidado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z749" value="Z74.9"><label for="Z749"><strong>Z74.9 — Problema de dependencia del cuidado, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dependencia de máquinas y dispositivos (Z99.x) (2) ===== -->
    <div class="familia" data-familia-id="fam-z99" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-z99-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-z99-block', this)">+</button>
        Dependencia de máquinas y dispositivos (Z99.x)<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-z99-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z990" value="Z99.0"><label for="Z990"><strong>Z99.0 — Dependencia de respirador (ventilador)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z991" value="Z99.1"><label for="Z991"><strong>Z99.1 — Dependencia de oxígeno suplementario</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z992" value="Z99.2"><label for="Z992"><strong>Z99.2 — Dependencia de diálisis renal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z993" value="Z99.3"><label for="Z993"><strong>Z99.3 — Dependencia de silla de ruedas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z998" value="Z99.8"><label for="Z998"><strong>Z99.8 — Dependencia de otras máquinas/dispositivos especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z999" value="Z99.9"><label for="Z999"><strong>Z99.9 — Dependencia de máquina/dispositivo, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->


<!-- ===================== CATEGORÍA 04: PATOLOGÍAS DE SALUD MENTAL Y PSIQUIATRÍA ===================== -->
<div class="categoria-seccion" id="cat-salud-mental" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-salud-mental')">
    <h4>🧠 PATOLOGÍAS DE SALUD MENTAL Y PSIQUIATRÍA
      <span class="categoria-badge" id="badge-salud-mental">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-salud-mental">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-salud-mental">

    <!-- ===== Familia: Consumo perjudicial o dependiente de alcohol (1) ===== -->
    <div class="familia" data-familia-id="fam-alcohol" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-alcohol-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-alcohol-block', this)">+</button>
        Consumo perjudicial o dependiente de alcohol<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-alcohol-block">
        <!-- F10.0–F10.9 -->
        <div class="patologia-item"><input type="checkbox" id="F100" value="F10.0"><label for="F100"><strong>F10.0 — Intoxicación aguda por alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F101" value="F10.1"><label for="F101"><strong>F10.1 — Consumo perjudicial de alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F102" value="F10.2"><label for="F102"><strong>F10.2 — Síndrome de dependencia de alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F103" value="F10.3"><label for="F103"><strong>F10.3 — Estado de abstinencia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F104" value="F10.4"><label for="F104"><strong>F10.4 — Abstinencia con delirio (delirium tremens)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F105" value="F10.5"><label for="F105"><strong>F10.5 — Trastorno psicótico inducido por alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F106" value="F10.6"><label for="F106"><strong>F10.6 — Síndrome amnésico inducido por alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F107" value="F10.7"><label for="F107"><strong>F10.7 — Trastornos residuales y de comienzo tardío</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F108" value="F10.8"><label for="F108"><strong>F10.8 — Otros trastornos debidos al alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F109" value="F10.9"><label for="F109"><strong>F10.9 — Trastorno por alcohol, no especificado</strong></label></div>

        <!-- Códigos adicionales -->
        <div class="patologia-item"><input type="checkbox" id="Y912" value="Y91.2"><label for="Y912"><strong>Y91.2 — Intoxicación alcohólica: severa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Y913" value="Y91.3"><label for="Y913"><strong>Y91.3 — Intoxicación alcohólica: muy severa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Y919" value="Y91.9"><label for="Y919"><strong>Y91.9 — Intoxicación alcohólica: no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z714" value="Z71.4"><label for="Z714"><strong>Z71.4 — Asesoramiento por consumo de alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z721" value="Z72.1"><label for="Z721"><strong>Z72.1 — Consumo de alcohol</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Tabaquismo (1) ===== -->
    <div class="familia" data-familia-id="fam-tabaco" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tabaco-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tabaco-block', this)">+</button>
        Tabaquismo<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-tabaco-block">
        <!-- F17.0–F17.9 -->
        <div class="patologia-item"><input type="checkbox" id="F170" value="F17.0"><label for="F170"><strong>F17.0 — Intoxicación aguda por tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F171" value="F17.1"><label for="F171"><strong>F17.1 — Consumo perjudicial de tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F172" value="F17.2"><label for="F172"><strong>F17.2 — Síndrome de dependencia de tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F173" value="F17.3"><label for="F173"><strong>F17.3 — Estado de abstinencia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F174" value="F17.4"><label for="F174"><strong>F17.4 — Abstinencia complicada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F175" value="F17.5"><label for="F175"><strong>F17.5 — Trastorno psicótico inducido por tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F176" value="F17.6"><label for="F176"><strong>F17.6 — Síndrome amnésico inducido por tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F177" value="F17.7"><label for="F177"><strong>F17.7 — Trastornos residuales y de comienzo tardío</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F178" value="F17.8"><label for="F178"><strong>F17.8 — Otros trastornos debidos al tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F179" value="F17.9"><label for="F179"><strong>F17.9 — Trastorno por tabaco, no especificado</strong></label></div>

        <!-- Códigos adicionales -->
        <div class="patologia-item"><input type="checkbox" id="T652" value="T65.2"><label for="T652"><strong>T65.2 — Efecto tóxico de nicotina</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z716" value="Z71.6"><label for="Z716"><strong>Z71.6 — Asesoramiento por consumo de tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z720" value="Z72.0"><label for="Z720"><strong>Z72.0 — Consumo de tabaco</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Consumo perjudicial o dependiente de drogas (1) ===== -->
    <div class="familia" data-familia-id="fam-drogas" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-drogas-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-drogas-block', this)">+</button>
        Consumo perjudicial o dependiente de droga (principal o policonsumo)<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-drogas-block">
        <!-- F11.0–F11.9 Opioides -->
        <div class="subcategoria-header banner-intoxicacion">F11.0 — Intoxicación aguda por opioides</div>
        <div class="patologia-item"><input type="checkbox" id="F111" value="F11.1"><label for="F111"><strong>F11.1 — Consumo perjudicial de opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F112" value="F11.2"><label for="F112"><strong>F11.2 — Síndrome de dependencia de opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F113" value="F11.3"><label for="F113"><strong>F11.3 — Estado de abstinencia (opioides)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F114" value="F11.4"><label for="F114"><strong>F11.4 — Abstinencia con delirio (opioides)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F115" value="F11.5"><label for="F115"><strong>F11.5 — Trastorno psicótico inducido por opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F116" value="F11.6"><label for="F116"><strong>F11.6 — Síndrome amnésico inducido por opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F117" value="F11.7"><label for="F117"><strong>F11.7 — Trastornos residuales y de comienzo tardío (opioides)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F118" value="F11.8"><label for="F118"><strong>F11.8 — Otros trastornos mentales y del comportamiento debidos a opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F119" value="F11.9"><label for="F119"><strong>F11.9 — Trastorno por opioides, no especificado</strong></label></div>

        <!-- F12.0–F12.9 Cannabis -->
        <div class="subcategoria-header banner-intoxicacion">F12.0 — Intoxicación aguda por cannabis</div>
        <div class="patologia-item"><input type="checkbox" id="F121" value="F12.1"><label for="F121"><strong>F12.1 — Consumo perjudicial de cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F122" value="F12.2"><label for="F122"><strong>F12.2 — Síndrome de dependencia de cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F123" value="F12.3"><label for="F123"><strong>F12.3 — Estado de abstinencia (cannabis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F124" value="F12.4"><label for="F124"><strong>F12.4 — Abstinencia con delirio (cannabis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F125" value="F12.5"><label for="F125"><strong>F12.5 — Trastorno psicótico inducido por cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F126" value="F12.6"><label for="F126"><strong>F12.6 — Síndrome amnésico inducido por cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F127" value="F12.7"><label for="F127"><strong>F12.7 — Trastornos residuales y de comienzo tardío (cannabis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F128" value="F12.8"><label for="F128"><strong>F12.8 — Otros trastornos debidos a cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F129" value="F12.9"><label for="F129"><strong>F12.9 — Trastorno por cannabis, no especificado</strong></label></div>

        <!-- F13.0–F13.9 Sedantes/hipnóticos -->
        <div class="subcategoria-header banner-intoxicacion">F13.0 — Intoxicación aguda por sedantes/hipnóticos</div>
        <div class="patologia-item"><input type="checkbox" id="F131" value="F13.1"><label for="F131"><strong>F13.1 — Consumo perjudicial de sedantes/hipnóticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F132" value="F13.2"><label for="F132"><strong>F13.2 — Dependencia de sedantes/hipnóticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F133" value="F13.3"><label for="F133"><strong>F13.3 — Abstinencia (sedantes/hipnóticos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F134" value="F13.4"><label for="F134"><strong>F13.4 — Abstinencia con delirio (sedantes/hipnóticos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F135" value="F13.5"><label for="F135"><strong>F13.5 — Trastorno psicótico inducido por sedantes/hipnóticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F136" value="F13.6"><label for="F136"><strong>F13.6 — Síndrome amnésico inducido por sedantes/hipnóticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F137" value="F13.7"><label for="F137"><strong>F13.7 — Trastornos residuales y de comienzo tardío (sedantes/hipnóticos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F138" value="F13.8"><label for="F138"><strong>F13.8 — Otros trastornos debidos a sedantes/hipnóticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F139" value="F13.9"><label for="F139"><strong>F13.9 — Trastorno por sedantes/hipnóticos, no especificado</strong></label></div>

        <!-- F14.0–F14.9 Cocaína -->
        <div class="subcategoria-header banner-intoxicacion">F14.0 — Intoxicación aguda por cocaína</div>
        <div class="patologia-item"><input type="checkbox" id="F141" value="F14.1"><label for="F141"><strong>F14.1 — Consumo perjudicial de cocaína</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F142" value="F14.2"><label for="F142"><strong>F14.2 — Dependencia de cocaína</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F143" value="F14.3"><label for="F143"><strong>F14.3 — Abstinencia (cocaína)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F144" value="F14.4"><label for="F144"><strong>F14.4 — Abstinencia con delirio (cocaína)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F145" value="F14.5"><label for="F145"><strong>F14.5 — Trastorno psicótico inducido por cocaína</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F146" value="F14.6"><label for="F146"><strong>F14.6 — Síndrome amnésico inducido por cocaína</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F147" value="F14.7"><label for="F147"><strong>F14.7 — Trastornos residuales y de comienzo tardío (cocaína)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F148" value="F14.8"><label for="F148"><strong>F14.8 — Otros trastornos debidos a cocaína</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F149" value="F14.9"><label for="F149"><strong>F14.9 — Trastorno por cocaína, no especificado</strong></label></div>

        <!-- F15.0–F15.9 Estimulantes (incl. cafeína) -->
        <div class="subcategoria-header banner-intoxicacion">F15.0 — Intoxicación aguda por otros estimulantes, incl. cafeína</div>
        <div class="patologia-item"><input type="checkbox" id="F151" value="F15.1"><label for="F151"><strong>F15.1 — Consumo perjudicial de otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F152" value="F15.2"><label for="F152"><strong>F15.2 — Dependencia de otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F153" value="F15.3"><label for="F153"><strong>F15.3 — Abstinencia (otros estimulantes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F154" value="F15.4"><label for="F154"><strong>F15.4 — Abstinencia con delirio (otros estimulantes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F155" value="F15.5"><label for="F155"><strong>F15.5 — Trastorno psicótico inducido por otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F156" value="F15.6"><label for="F156"><strong>F15.6 — Síndrome amnésico inducido por otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F157" value="F15.7"><label for="F157"><strong>F15.7 — Trastornos residuales y de comienzo tardío (otros estimulantes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F158" value="F15.8"><label for="F158"><strong>F15.8 — Otros trastornos debidos a otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F159" value="F15.9"><label for="F159"><strong>F15.9 — Trastorno por otros estimulantes, no especificado</strong></label></div>

        <!-- F16.0–F16.9 Alucinógenos -->
        <div class="subcategoria-header banner-intoxicacion">F16.0 — Intoxicación aguda por alucinógenos</div>
        <div class="patologia-item"><input type="checkbox" id="F161" value="F16.1"><label for="F161"><strong>F16.1 — Consumo perjudicial de alucinógenos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F162" value="F16.2"><label for="F162"><strong>F16.2 — Dependencia de alucinógenos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F163" value="F16.3"><label for="F163"><strong>F16.3 — Abstinencia (alucinógenos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F164" value="F16.4"><label for="F164"><strong>F16.4 — Abstinencia con delirio (alucinógenos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F165" value="F16.5"><label for="F165"><strong>F16.5 — Trastorno psicótico inducido por alucinógenos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F166" value="F16.6"><label for="F166"><strong>F16.6 — Síndrome amnésico inducido por alucinógenos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F167" value="F16.7"><label for="F167"><strong>F16.7 — Trastornos residuales y de comienzo tardío (alucinógenos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F168" value="F16.8"><label for="F168"><strong>F16.8 — Otros trastornos debidos a alucinógenos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F169" value="F16.9"><label for="F169"><strong>F16.9 — Trastorno por alucinógenos, no especificado</strong></label></div>

        <!-- F18.0–F18.9 Disolventes volátiles -->
        <div class="subcategoria-header banner-intoxicacion">F18.0 — Intoxicación aguda por disolventes volátiles</div>
        <div class="patologia-item"><input type="checkbox" id="F181" value="F18.1"><label for="F181"><strong>F18.1 — Consumo perjudicial de disolventes volátiles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F182" value="F18.2"><label for="F182"><strong>F18.2 — Dependencia de disolventes volátiles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F183" value="F18.3"><label for="F183"><strong>F18.3 — Abstinencia (disolventes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F184" value="F18.4"><label for="F184"><strong>F18.4 — Abstinencia con delirio (disolventes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F185" value="F18.5"><label for="F185"><strong>F18.5 — Trastorno psicótico inducido por disolventes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F186" value="F18.6"><label for="F186"><strong>F18.6 — Síndrome amnésico inducido por disolventes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F187" value="F18.7"><label for="F187"><strong>F18.7 — Trastornos residuales y de comienzo tardío (disolventes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F188" value="F18.8"><label for="F188"><strong>F18.8 — Otros trastornos debidos a disolventes volátiles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F189" value="F18.9"><label for="F189"><strong>F18.9 — Trastorno por disolventes volátiles, no especificado</strong></label></div>

        <!-- F19.0–F19.9 Múltiples drogas -->
        <div class="subcategoria-header banner-intoxicacion">F19.0 — Intoxicación aguda por múltiples drogas/otras sustancias</div>
        <div class="patologia-item"><input type="checkbox" id="F191" value="F19.1"><label for="F191"><strong>F19.1 — Consumo perjudicial de múltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F192" value="F19.2"><label for="F192"><strong>F19.2 — Dependencia de múltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F193" value="F19.3"><label for="F193"><strong>F19.3 — Abstinencia (múltiples drogas)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F194" value="F19.4"><label for="F194"><strong>F19.4 — Abstinencia con delirio (múltiples drogas)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F195" value="F19.5"><label for="F195"><strong>F19.5 — Trastorno psicótico inducido por múltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F196" value="F19.6"><label for="F196"><strong>F19.6 — Síndrome amnésico inducido por múltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F197" value="F19.7"><label for="F197"><strong>F19.7 — Trastornos residuales y de comienzo tardío (múltiples drogas)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F198" value="F19.8"><label for="F198"><strong>F19.8 — Otros trastornos debidos a múltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F199" value="F19.9"><label for="F199"><strong>F19.9 — Trastorno por múltiples drogas, no especificado</strong></label></div>

        <!-- Z72.2 -->
        <div class="patologia-item"><input type="checkbox" id="Z722" value="Z72.2"><label for="Z722"><strong>Z72.2 — Consumo de drogas</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastornos alimentarios (1) ===== -->
    <div class="familia" data-familia-id="fam-tca" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tca-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tca-block', this)">+</button>
        Trastornos alimentarios<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-tca-block">
        <div class="patologia-item"><input type="checkbox" id="F500" value="F50.0"><label for="F500"><strong>F50.0 — Anorexia nerviosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F501" value="F50.1"><label for="F501"><strong>F50.1 — Anorexia nerviosa atípica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F502" value="F50.2"><label for="F502"><strong>F50.2 — Bulimia nerviosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F503" value="F50.3"><label for="F503"><strong>F50.3 — Bulimia nerviosa atípica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F504" value="F50.4"><label for="F504"><strong>F50.4 — Hiperfagia psicógena</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F505" value="F50.5"><label for="F505"><strong>F50.5 — Vómitos psicógenos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F508" value="F50.8"><label for="F508"><strong>F50.8 — Otros trastornos de la alimentación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F509" value="F50.9"><label for="F509"><strong>F50.9 — Trastorno de la alimentación, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Depresión leve o moderada (1) ===== -->
    <div class="familia" data-familia-id="fam-depre-leve" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-depre-leve-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-depre-leve-block', this)">+</button>
        Depresión leve o moderada (Trastorno depresivo recurrente)<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-depre-leve-block">
        <div class="patologia-item"><input type="checkbox" id="F330" value="F33.0"><label for="F330"><strong>F33.0 — Episodio actual leve</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F331" value="F33.1"><label for="F331"><strong>F33.1 — Episodio actual moderado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F334" value="F33.4"><label for="F334"><strong>F33.4 — En remisión</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F338" value="F33.8"><label for="F338"><strong>F33.8 — Otros trastornos depresivos recurrentes especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F339" value="F33.9"><label for="F339"><strong>F33.9 — Trastorno depresivo recurrente, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Depresión grave / con psicosis (2) ===== -->
    <div class="familia" data-familia-id="fam-depre-grave" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-depre-grave-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-depre-grave-block', this)">+</button>
        Depresión grave / grave con psicosis (Trastorno depresivo recurrente)<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-depre-grave-block">
        <div class="patologia-item"><input type="checkbox" id="F332" value="F33.2"><label for="F332"><strong>F33.2 — Episodio actual grave sin síntomas psicóticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F333" value="F33.3"><label for="F333"><strong>F33.3 — Episodio actual grave con síntomas psicóticos</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Esquizofrenia y trastornos psicóticos (2) ===== -->
    <div class="familia" data-familia-id="fam-esquizo" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-esquizo-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-esquizo-block', this)">+</button>
        Esquizofrenia y trastornos psicóticos<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-esquizo-block">
        <!-- Esquizofrenia F20.0–F20.9 -->
        <div class="patologia-item"><input type="checkbox" id="F200" value="F20.0"><label for="F200"><strong>F20.0 — Esquizofrenia paranoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F201" value="F20.1"><label for="F201"><strong>F20.1 — Esquizofrenia hebefrénica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F202" value="F20.2"><label for="F202"><strong>F20.2 — Esquizofrenia catatónica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F203" value="F20.3"><label for="F203"><strong>F20.3 — Esquizofrenia indiferenciada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F204" value="F20.4"><label for="F204"><strong>F20.4 — Depresión post-esquizofrénica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F205" value="F20.5"><label for="F205"><strong>F20.5 — Esquizofrenia residual</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F206" value="F20.6"><label for="F206"><strong>F20.6 — Esquizofrenia simple</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F208" value="F20.8"><label for="F208"><strong>F20.8 — Otras esquizofrenias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F209" value="F20.9"><label for="F209"><strong>F20.9 — Esquizofrenia, no especificada</strong></label></div>

        <!-- Trastornos delirantes F22.x -->
        <div class="subcategoria-header banner-psicoticos">F22 — Trastornos delirantes</div>
        <div class="patologia-item"><input type="checkbox" id="F220" value="F22.0"><label for="F220"><strong>F22.0 — Trastorno delirante persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F228" value="F22.8"><label for="F228"><strong>F22.8 — Otros trastornos delirantes persistentes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F229" value="F22.9"><label for="F229"><strong>F22.9 — Trastorno delirante persistente, no especificado</strong></label></div>

        <!-- F21 - Trastorno esquizotípico -->
        <div class="patologia-item"><input type="checkbox" id="F21" value="F21"><label for="F21"><strong>F21 — Trastorno esquizotípico</strong></label></div>

        <!-- Trastornos psicóticos agudos y transitorios F23.x -->
        <div class="subcategoria-header banner-psicoticos">F23 — Trastornos psicóticos agudos y transitorios</div>
        <div class="patologia-item"><input type="checkbox" id="F230" value="F23.0"><label for="F230"><strong>F23.0 — Psicótico agudo polimorfo sin síntomas de esquizofrenia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F231" value="F23.1"><label for="F231"><strong>F23.1 — Psicótico agudo polimorfo con síntomas de esquizofrenia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F232" value="F23.2"><label for="F232"><strong>F23.2 — Psicótico agudo de tipo esquizofrénico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F233" value="F23.3"><label for="F233"><strong>F23.3 — Otros psicóticos agudos predominantemente delirantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F238" value="F23.8"><label for="F238"><strong>F23.8 — Otros psicóticos agudos y transitorios especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F239" value="F23.9"><label for="F239"><strong>F23.9 — Psicótico agudo y transitorio, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Retraso mental (1) ===== -->
    <div class="familia" data-familia-id="fam-retraso-mental" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-retraso-mental-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-retraso-mental-block', this)">+</button>
        Retraso mental<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-retraso-mental-block">
        <!-- F70.x — Retraso mental leve -->
        <div class="subcategoria-header banner-discapacidad">F70 — Retraso mental leve</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F700" name="patologia[]" value="F70.0" data-points="1"><label for="F700"><strong>F70.0 — Leve, con mínima o ninguna alteración del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F701" name="patologia[]" value="F70.1" data-points="1"><label for="F701"><strong>F70.1 — Leve, con alteración significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F708" name="patologia[]" value="F70.8" data-points="1"><label for="F708"><strong>F70.8 — Leve, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F709" name="patologia[]" value="F70.9" data-points="1"><label for="F709"><strong>F70.9 — Leve, sin especificación de alteración del comportamiento</strong></label></div>

        <!-- F71.x — Retraso mental moderado -->
        <div class="subcategoria-header banner-discapacidad">F71 — Retraso mental moderado</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F710" name="patologia[]" value="F71.0" data-points="1"><label for="F710"><strong>F71.0 — Moderado, con mínima o ninguna alteración del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F711" name="patologia[]" value="F71.1" data-points="1"><label for="F711"><strong>F71.1 — Moderado, con alteración significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F718" name="patologia[]" value="F71.8" data-points="1"><label for="F718"><strong>F71.8 — Moderado, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F719" name="patologia[]" value="F71.9" data-points="1"><label for="F719"><strong>F71.9 — Moderado, sin especificación de alteración del comportamiento</strong></label></div>

        <!-- F72.x — Retraso mental grave -->
        <div class="subcategoria-header banner-discapacidad">F72 — Retraso mental grave</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F720" name="patologia[]" value="F72.0" data-points="1"><label for="F720"><strong>F72.0 — Grave, con mínima o ninguna alteración del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F721" name="patologia[]" value="F72.1" data-points="1"><label for="F721"><strong>F72.1 — Grave, con alteración significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F728" name="patologia[]" value="F72.8" data-points="1"><label for="F728"><strong>F72.8 — Grave, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F729" name="patologia[]" value="F72.9" data-points="1"><label for="F729"><strong>F72.9 — Grave, sin especificación de alteración del comportamiento</strong></label></div>

        <!-- F73.x — Retraso mental profundo -->
        <div class="subcategoria-header banner-discapacidad">F73 — Retraso mental profundo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F730" name="patologia[]" value="F73.0" data-points="1"><label for="F730"><strong>F73.0 — Profundo, con mínima o ninguna alteración del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F731" name="patologia[]" value="F73.1" data-points="1"><label for="F731"><strong>F73.1 — Profundo, con alteración significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F738" name="patologia[]" value="F73.8" data-points="1"><label for="F738"><strong>F73.8 — Profundo, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F739" name="patologia[]" value="F73.9" data-points="1"><label for="F739"><strong>F73.9 — Profundo, sin especificación de alteración del comportamiento</strong></label></div>

        <!-- F78.x / F79.x -->
        <div class="subcategoria-header banner-discapacidad">F78 / F79 — Otras formas y no especificado</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F780" name="patologia[]" value="F78.0" data-points="1"><label for="F780"><strong>F78.0 — Otros retrasos mentales, con mínima o ninguna alteración del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F781" name="patologia[]" value="F78.1" data-points="1"><label for="F781"><strong>F78.1 — Otros retrasos mentales, con alteración significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F788" name="patologia[]" value="F78.8" data-points="1"><label for="F788"><strong>F78.8 — Otros retrasos mentales con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F789" name="patologia[]" value="F78.9" data-points="1"><label for="F789"><strong>F78.9 — Otros retrasos mentales, no especificados</strong></label></div>

        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F790" name="patologia[]" value="F79.0" data-points="1"><label for="F790"><strong>F79.0 — Retraso mental no especificado, con mínima o ninguna alteración del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F791" name="patologia[]" value="F79.1" data-points="1"><label for="F791"><strong>F79.1 — Retraso mental no especificado, con alteración significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F798" name="patologia[]" value="F79.8" data-points="1"><label for="F798"><strong>F79.8 — Retraso mental no especificado, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F799" name="patologia[]" value="F79.9" data-points="1"><label for="F799"><strong>F79.9 — Retraso mental no especificado, sin mención de alteración del comportamiento</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastorno ansioso (1) ===== -->
    <div class="familia" data-familia-id="fam-ansiedad" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-ansiedad-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ansiedad-block', this)">+</button>
        Trastorno ansioso<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-ansiedad-block">

        <!-- F40.x — Trastornos fóbico-ansiosos -->
        <div class="subcategoria-header banner-ansiedad">F40 — Trastornos fóbico-ansiosos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F400" name="patologia[]" value="F40.0" data-points="1"><label for="F400"><strong>F40.0 — Agorafobia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F401" name="patologia[]" value="F40.1" data-points="1"><label for="F401"><strong>F40.1 — Fobia social</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F402" name="patologia[]" value="F40.2" data-points="1"><label for="F402"><strong>F40.2 — Fobias específicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F408" name="patologia[]" value="F40.8" data-points="1"><label for="F408"><strong>F40.8 — Otros trastornos fóbico-ansiosos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F409" name="patologia[]" value="F40.9" data-points="1"><label for="F409"><strong>F40.9 — Trastorno fóbico-ansioso, no especificado</strong></label></div>

        <!-- F41.x — Otros trastornos de ansiedad -->
        <div class="subcategoria-header banner-ansiedad">F41 — Otros trastornos de ansiedad</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F410" name="patologia[]" value="F41.0" data-points="1"><label for="F410"><strong>F41.0 — Trastorno de pánico (ansiedad paroxística episódica)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F411" name="patologia[]" value="F41.1" data-points="1"><label for="F411"><strong>F41.1 — Trastorno de ansiedad generalizada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F412" name="patologia[]" value="F41.2" data-points="1"><label for="F412"><strong>F41.2 — Trastorno mixto ansioso-depresivo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F413" name="patologia[]" value="F41.3" data-points="1"><label for="F413"><strong>F41.3 — Otros trastornos mixtos de ansiedad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F418" name="patologia[]" value="F41.8" data-points="1"><label for="F418"><strong>F41.8 — Otros trastornos de ansiedad especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F419" name="patologia[]" value="F41.9" data-points="1"><label for="F419"><strong>F41.9 — Trastorno de ansiedad, no especificado</strong></label></div>

        <!-- F42.x (selección solicitada) — Trastorno obsesivo-compulsivo -->
        <div class="subcategoria-header banner-ansiedad">F42 — Trastorno obsesivo-compulsivo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F422" name="patologia[]" value="F42.2" data-points="1"><label for="F422"><strong>F42.2 — Pensamientos y actos obsesivos mixtos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F428" name="patologia[]" value="F42.8" data-points="1"><label for="F428"><strong>F42.8 — Otros trastornos obsesivo-compulsivos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F429" name="patologia[]" value="F42.9" data-points="1"><label for="F429"><strong>F42.9 — Trastorno obsesivo-compulsivo, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastorno de la personalidad (1) ===== -->
    <div class="familia" data-familia-id="fam-personalidad" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-personalidad-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-personalidad-block', this)">+</button>
        Trastorno de la personalidad<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-personalidad-block">
        <!-- F60.x — Trastornos específicos de la personalidad -->
        <div class="subcategoria-header banner-discapacidad">F60 — Trastornos específicos de la personalidad</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F600" name="patologia[]" value="F60.0" data-points="1"><label for="F600"><strong>F60.0 — Personalidad paranoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F601" name="patologia[]" value="F60.1" data-points="1"><label for="F601"><strong>F60.1 — Personalidad esquizoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F602" name="patologia[]" value="F60.2" data-points="1"><label for="F602"><strong>F60.2 — Personalidad disocial (antisocial)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F603" name="patologia[]" value="F60.3" data-points="1"><label for="F603"><strong>F60.3 — Personalidad emocionalmente inestable (incluye límite/impulsivo)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F604" name="patologia[]" value="F60.4" data-points="1"><label for="F604"><strong>F60.4 — Personalidad histriónica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F605" name="patologia[]" value="F60.5" data-points="1"><label for="F605"><strong>F60.5 — Personalidad anancástica (obsesivo-compulsiva)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F606" name="patologia[]" value="F60.6" data-points="1"><label for="F606"><strong>F60.6 — Personalidad ansiosa (evitativa)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F607" name="patologia[]" value="F60.7" data-points="1"><label for="F607"><strong>F60.7 — Personalidad dependiente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F608" name="patologia[]" value="F60.8" data-points="1"><label for="F608"><strong>F60.8 — Otros trastornos específicos de la personalidad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F609" name="patologia[]" value="F60.9" data-points="1"><label for="F609"><strong>F60.9 — Trastorno específico de la personalidad, no especificado</strong></label></div>

        <!-- F61 / F62 / F68.0 / F69 -->
        <div class="subcategoria-header banner-discapacidad">Otros trastornos de la personalidad y del comportamiento del adulto</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F61" name="patologia[]" value="F61" data-points="1"><label for="F61"><strong>F61 — Trastornos mixtos y otros trastornos de la personalidad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F620" name="patologia[]" value="F62.0" data-points="1"><label for="F620"><strong>F62.0 — Cambios perdurables de la personalidad tras experiencia catastrófica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F621" name="patologia[]" value="F62.1" data-points="1"><label for="F621"><strong>F62.1 — Cambios perdurables de la personalidad tras enfermedad psiquiátrica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F628" name="patologia[]" value="F62.8" data-points="1"><label for="F628"><strong>F62.8 — Otros cambios perdurables de la personalidad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F629" name="patologia[]" value="F62.9" data-points="1"><label for="F629"><strong>F62.9 — Cambio perdurable de la personalidad, no especificado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F680" name="patologia[]" value="F68.0" data-points="1"><label for="F680"><strong>F68.0 — Trastornos somatomorfos por factores psicológicos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F69" name="patologia[]" value="F69" data-points="1"><label for="F69"><strong>F69 — Trastorno de la personalidad y del comportamiento del adulto, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastornos del sueño (1) ===== -->
    <div class="familia" data-familia-id="fam-sueno-mental" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-sueno-mental-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-sueno-mental-block', this)">+</button>
        Trastornos del sueño<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-sueno-mental-block">
        <!-- F51.x — Trastornos no orgánicos del sueño -->
        <div class="subcategoria-header banner-sueno">F51 — Trastornos no orgánicos del sueño</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F510-mental" name="patologia[]" value="F51.0" data-points="1"><label for="F510-mental"><strong>F51.0 — Insomnio no orgánico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F511-mental" name="patologia[]" value="F51.1" data-points="1"><label for="F511-mental"><strong>F51.1 — Hipersomnia no orgánica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F512-mental" name="patologia[]" value="F51.2" data-points="1"><label for="F512-mental"><strong>F51.2 — Alteración del ritmo sueño-vigilia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F514-mental" name="patologia[]" value="F51.4" data-points="1"><label for="F514-mental"><strong>F51.4 — Terrores nocturnos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F518-mental" name="patologia[]" value="F51.8" data-points="1"><label for="F518-mental"><strong>F51.8 — Otros trastornos no orgánicos del sueño</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F519-mental" name="patologia[]" value="F51.9" data-points="1"><label for="F519-mental"><strong>F51.9 — Trastorno no orgánico del sueño, no especificado</strong></label></div>

        <!-- G47.x — Otros trastornos del sueño -->
        <div class="subcategoria-header banner-sueno">G47 — Otros trastornos del sueño</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G473-mental" name="patologia[]" value="G47.3" data-points="1"><label for="G473-mental"><strong>G47.3 — Apnea del sueño</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G474-mental" name="patologia[]" value="G47.4" data-points="1"><label for="G474-mental"><strong>G47.4 — Narcolepsia y cataplejía</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G478-mental" name="patologia[]" value="G47.8" data-points="1"><label for="G478-mental"><strong>G47.8 — Otros trastornos del sueño especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G479-mental" name="patologia[]" value="G47.9" data-points="1"><label for="G479-mental"><strong>G47.9 — Trastorno del sueño, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Otros trastornos de Salud Mental (1) ===== -->
    <div class="familia" data-familia-id="fam-otros-salud-mental" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-otros-salud-mental-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-otros-salud-mental-block', this)">+</button>
        Otros trastornos de Salud Mental<span class="badge-puntos">(1)
      </div>

      <div class="familia-content collapsed" id="fam-otros-salud-mental-block">

        <!-- F31.x — Trastorno afectivo bipolar -->
        <div class="subcategoria-header banner-depresion">F31 — Trastorno afectivo bipolar</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F310" name="patologia[]" value="F31.0" data-points="1">
          <label for="F310"><strong>F31.0 — Episodio actual hipomaníaco</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F311" name="patologia[]" value="F31.1" data-points="1">
          <label for="F311"><strong>F31.1 — Episodio actual maníaco sin síntomas psicóticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F312" name="patologia[]" value="F31.2" data-points="1">
          <label for="F312"><strong>F31.2 — Episodio actual maníaco con síntomas psicóticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F313" name="patologia[]" value="F31.3" data-points="1">
          <label for="F313"><strong>F31.3 — Episodio actual depresivo leve o moderado</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F314" name="patologia[]" value="F31.4" data-points="1">
          <label for="F314"><strong>F31.4 — Episodio actual depresivo grave sin síntomas psicóticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F315" name="patologia[]" value="F31.5" data-points="1">
          <label for="F315"><strong>F31.5 — Episodio actual depresivo grave con síntomas psicóticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F316" name="patologia[]" value="F31.6" data-points="1">
          <label for="F316"><strong>F31.6 — Episodio actual mixto</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F317" name="patologia[]" value="F31.7" data-points="1">
          <label for="F317"><strong>F31.7 — Actualmente en remisión</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F318" name="patologia[]" value="F31.8" data-points="1">
          <label for="F318"><strong>F31.8 — Otros trastornos bipolares especificados</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F319" name="patologia[]" value="F31.9" data-points="1">
          <label for="F319"><strong>F31.9 — Trastorno afectivo bipolar, no especificado</strong></label>
        </div>

        <!-- F66.x — Trastornos psicológicos y del comportamiento asociados al desarrollo sexual y la orientación -->
        <div class="subcategoria-header banner-psicosocial">F66 — Trastornos psicológicos asociados al desarrollo sexual y orientación</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F661" name="patologia[]" value="F66.1" data-points="1">
          <label for="F661"><strong>F66.1 — Orientación sexual egodistónica</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F662" name="patologia[]" value="F66.2" data-points="1">
          <label for="F662"><strong>F66.2 — Trastorno de relación sexual</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F668" name="patologia[]" value="F66.8" data-points="1">
          <label for="F668"><strong>F66.8 — Otros trastornos especificados</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F669" name="patologia[]" value="F66.9" data-points="1">
          <label for="F669"><strong>F66.9 — Trastorno no especificado</strong></label>
        </div>

      </div>
    </div>

     

    </div> <!-- /categoria-content -->
  </div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 05: PATOLOGÍAS NEUROLÓGICAS ===================== -->
<div class="categoria-seccion" id="cat-neurologicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-neurologicas')">
    <h4>🧩 PATOLOGÍAS NEUROLÓGICAS
      <span class="categoria-badge" id="badge-neurologicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-neurologicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-neurologicas">

    <!-- ===== Familia: Parkinsonismo (1) ===== -->
    <div class="familia" data-familia-id="fam-parkinsonismo" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-parkinsonismo-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-parkinsonismo-block', this)">+</button>
        Parkinsonismo<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-parkinsonismo-block">
        <!-- G20 — Enfermedad de Parkinson -->
        <div class="subcategoria-header banner-parkinson">G20 — Enfermedad de Parkinson</div>
        <div class="patologia-item"><input type="checkbox" id="G20" value="G20"><label for="G20"><strong>G20 — Enfermedad de Parkinson</strong></label></div>

        <!-- Parkinsonismo secundario y en otras enfermedades -->
        <div class="patologia-item"><input type="checkbox" id="G211" value="G21.1"><label for="G211"><strong>G21.1 — Parkinsonismo secundario inducido por fármacos (otros)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G22" value="G22"><label for="G22"><strong>G22 — Parkinsonismo en enfermedades clasificadas en otra parte</strong></label></div>

        <!-- Otras enfermedades degenerativas de ganglios basales (G23.x) -->
        <div class="patologia-item"><input type="checkbox" id="G230" value="G23.0"><label for="G230"><strong>G23.0 — Otras enfermedades degenerativas de ganglios basales, forma especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G231" value="G23.1"><label for="G231"><strong>G23.1 — Parálisis supranuclear progresiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G232" value="G23.2"><label for="G232"><strong>G23.2 — Degeneración estriatonigral</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G238" value="G23.8"><label for="G238"><strong>G23.8 — Otras enfermedades degenerativas de ganglios basales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G239" value="G23.9"><label for="G239"><strong>G23.9 — Enfermedad degenerativa de ganglios basales, no especificada</strong></label></div>

        <!-- Distonías (G24.x) -->
        <div class="patologia-item"><input type="checkbox" id="G240" value="G24.0"><label for="G240"><strong>G24.0 — Distonía de torsión de inicio en el adulto</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G241" value="G24.1"><label for="G241"><strong>G24.1 — Distonía familiar idiopática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G242" value="G24.2"><label for="G242"><strong>G24.2 — Tortícolis espasmódica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G244" value="G24.4"><label for="G244"><strong>G24.4 — Distonía oromandibular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G245" value="G24.5"><label for="G245"><strong>G24.5 — Blefaroespasmo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G248" value="G24.8"><label for="G248"><strong>G24.8 — Otras distonías especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G249" value="G24.9"><label for="G249"><strong>G24.9 — Distonía, no especificada</strong></label></div>

        <!-- Otros trastornos del movimiento (G25.x seleccionados) -->
        <div class="patologia-item"><input type="checkbox" id="G252" value="G25.2"><label for="G252"><strong>G25.2 — Otros temblores especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G253" value="G25.3"><label for="G253"><strong>G25.3 — Mioclonías</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G254" value="G25.4"><label for="G254"><strong>G25.4 — Coreas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G255" value="G25.5"><label for="G255"><strong>G25.5 — Otros trastornos coreicos</strong></label></div>

        <!-- Trastornos extrapiramidales en otras enfermedades -->
        <div class="patologia-item"><input type="checkbox" id="G26" value="G26"><label for="G26"><strong>G26 — Trastornos extrapiramidales y del movimiento en enfermedades clasificadas en otra parte</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Demencia (2) ===== -->
    <div class="familia" data-familia-id="fam-demencia" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-demencia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-demencia-block', this)">+</button>
        Demencia<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-demencia-block">
        <!-- Demencia en enfermedad de Alzheimer (F00.x) -->
        <div class="patologia-item"><input type="checkbox" id="F000" value="F00.0"><label for="F000"><strong>F00.0 — Demencia en enfermedad de Alzheimer, inicio temprano</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F001" value="F00.1"><label for="F001"><strong>F00.1 — Demencia en enfermedad de Alzheimer, inicio tardío</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F002" value="F00.2"><label for="F002"><strong>F00.2 — Demencia en enfermedad de Alzheimer, forma atípica o mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F009" value="F00.9"><label for="F009"><strong>F00.9 — Demencia en enfermedad de Alzheimer, no especificada</strong></label></div>

        <!-- Demencia vascular (F01.x) -->
        <div class="patologia-item"><input type="checkbox" id="F010" value="F01.0"><label for="F010"><strong>F01.0 — Demencia vascular de inicio agudo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F011" value="F01.1"><label for="F011"><strong>F01.1 — Demencia por infartos múltiples</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F012" value="F01.2"><label for="F012"><strong>F01.2 — Demencia vascular subcortical</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F013" value="F01.3"><label for="F013"><strong>F01.3 — Demencia mixta, cortical y subcortical</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F018" value="F01.8"><label for="F018"><strong>F01.8 — Otras demencias vasculares</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F019" value="F01.9"><label for="F019"><strong>F01.9 — Demencia vascular, no especificada</strong></label></div>

        <!-- Demencia en otras enfermedades (F02.x) y no especificada (F03) -->
        <div class="patologia-item"><input type="checkbox" id="F020" value="F02.0"><label for="F020"><strong>F02.0 — Demencia en enfermedad de Pick</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F021" value="F02.1"><label for="F021"><strong>F02.1 — Demencia en enfermedad de Creutzfeldt-Jakob</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F022" value="F02.2"><label for="F022"><strong>F02.2 — Demencia en enfermedad de Huntington</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F023" value="F02.3"><label for="F023"><strong>F02.3 — Demencia en enfermedad de Parkinson</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F024" value="F02.4"><label for="F024"><strong>F02.4 — Demencia en infección por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F028" value="F02.8"><label for="F028"><strong>F02.8 — Demencia en otras enfermedades especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="F03" value="F03"><label for="F03"><strong>F03 — Demencia, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dolor neuropático / Fibromialgia (1) ===== -->
<div class="familia" data-familia-id="fam-neuropatico" data-points="1">
  <div class="familia-header" onclick="toggleFamilia('fam-neuropatico-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-neuropatico-block', this)">+</button>
        Dolor neuropático / Fibromialgia<span class="badge-puntos">(1)
      </div>
  <div class="familia-content collapsed" id="fam-neuropatico-block">
    
    <!-- G50.x — Neuralgias del trigémino -->
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G500" name="patologia[]" value="G50.0" data-points="1">
      <label for="G500"><strong>G50.0</strong> — Neuralgia del trigémino</label>
    </div>
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G501" name="patologia[]" value="G50.1" data-points="1">
      <label for="G501"><strong>G50.1</strong> — Dolor facial atípico</label>
    </div>
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G508" name="patologia[]" value="G50.8" data-points="1">
      <label for="G508"><strong>G50.8</strong> — Otros trastornos de nervio trigémino</label>
    </div>
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G509" name="patologia[]" value="G50.9" data-points="1">
      <label for="G509"><strong>G50.9</strong> — Trastorno del trigémino, no especificado</label>
    </div>

    <!-- M79.7 — Fibromialgia -->
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="M797" name="patologia[]" value="M79.7" data-points="1">
      <label for="M797"><strong>M79.7</strong> — Fibromialgia</label>
    </div>

  </div>
</div>

    <!-- ===== Familia: Esclerosis múltiple (1) ===== -->
    <div class="familia" data-familia-id="fam-em" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-em-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-em-block', this)">+</button>
        Esclerosis múltiple<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-em-block">
        <div class="patologia-item"><input type="checkbox" id="G35" value="G35"><label for="G35"><strong>G35 — Esclerosis múltiple</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Epilepsia (1) ===== -->
    <div class="familia" data-familia-id="fam-epilepsia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-epilepsia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-epilepsia-block', this)">+</button>
        Epilepsia<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-epilepsia-block">
        <div class="patologia-item"><input type="checkbox" id="G400" value="G40.0"><label for="G400"><strong>G40.0 — Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G401" value="G40.1"><label for="G401"><strong>G40.1 — Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G402" value="G40.2"><label for="G402"><strong>G40.2 — Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G403" value="G40.3"><label for="G403"><strong>G40.3 — Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G404" value="G40.4"><label for="G404"><strong>G40.4 — Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G406" value="G40.6"><label for="G406"><strong>G40.6 — Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G407" value="G40.7"><label for="G407"><strong>G40.7 — Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G408" value="G40.8"><label for="G408"><strong>G40.8 — Otras epilepsias y síndromes epilépticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="G409" value="G40.9"><label for="G409"><strong>G40.9 — Epilepsia, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 06: ANEMIA CRÓNICA ===================== -->
<div class="categoria-seccion" id="cat-anemia" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-anemia')">
    <h4>🩸 ANEMIA CRÓNICA
      <span class="categoria-badge" id="badge-anemia">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-anemia">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-anemia">

    <!-- ===== Familia: Anemia crónica (1) ===== -->
    <div class="familia" data-familia-id="fam-anemia-cronica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-anemia-cronica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-anemia-cronica-block', this)">+</button>
        Anemia crónica<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-anemia-cronica-block">

        <!-- D50 -->
        <div class="subcategoria-header banner-anemia">D50 — Anemia por deficiencia de hierro</div>

        <!-- D51.x -->
        <div class="patologia-item"><input type="checkbox" id="D510" value="D51.0"><label for="D510"><strong>D51.0 — Anemia megaloblástica por deficiencia de vitamina B12 debida a déficit de factor intrínseco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D511" value="D51.1"><label for="D511"><strong>D51.1 — Anemia megaloblástica por deficiencia de vitamina B12 debida a malabsorción selectiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D512" value="D51.2"><label for="D512"><strong>D51.2 — Deficiencia dietética de vitamina B12</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D513" value="D51.3"><label for="D513"><strong>D51.3 — Otras anemias megaloblásticas por deficiencia de vitamina B12</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D518" value="D51.8"><label for="D518"><strong>D51.8 — Otras anemias por deficiencia de vitamina B12</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D519" value="D51.9"><label for="D519"><strong>D51.9 — Anemia por deficiencia de vitamina B12, no especificada</strong></label></div>

        <!-- D52.x -->
        <div class="subcategoria-header banner-anemia">D52.0 — Anemia megaloblástica por deficiencia de folato secundaria a dieta</div>
        <div class="patologia-item"><input type="checkbox" id="D521" value="D52.1"><label for="D521"><strong>D52.1 — Anemia megaloblástica por deficiencia de folato debida a fármacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D528" value="D52.8"><label for="D528"><strong>D52.8 — Otras anemias megaloblásticas por deficiencia de folato</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D529" value="D52.9"><label for="D529"><strong>D52.9 — Anemia megaloblástica por deficiencia de folato, no especificada</strong></label></div>

        <!-- D53.x -->
        <div class="subcategoria-header banner-anemia">D53.0 — Anemia megaloblástica, no especificada</div>
        <div class="patologia-item"><input type="checkbox" id="D531" value="D53.1"><label for="D531"><strong>D53.1 — Otras anemias megaloblásticas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D532" value="D53.2"><label for="D532"><strong>D53.2 — Anemia por deficiencia de vitamina B6</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D538" value="D53.8"><label for="D538"><strong>D53.8 — Otras anemias nutricionales especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D539" value="D53.9"><label for="D539"><strong>D53.9 — Anemia nutricional, no especificada</strong></label></div>

        <!-- D55.x -->
        <div class="subcategoria-header banner-anemia">D55.0 — Anemia debida a deficiencia de G6PD</div>
        <div class="patologia-item"><input type="checkbox" id="D551" value="D55.1"><label for="D551"><strong>D55.1 — Anemia debida a otros trastornos enzimáticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D552" value="D55.2"><label for="D552"><strong>D55.2 — Anemia debida a trastornos del metabolismo de la glucosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D553" value="D55.3"><label for="D553"><strong>D55.3 — Anemia debida a trastornos del metabolismo de nucleótidos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D558" value="D55.8"><label for="D558"><strong>D55.8 — Otras anemias debidas a trastornos enzimáticos especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D559" value="D55.9"><label for="D559"><strong>D55.9 — Anemia debida a trastornos enzimáticos, no especificada</strong></label></div>

        <!-- D56.x -->
        <div class="subcategoria-header banner-anemia">D56.0 — Talasemia alfa</div>
        <div class="patologia-item"><input type="checkbox" id="D561" value="D56.1"><label for="D561"><strong>D56.1 — Talasemia beta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D562" value="D56.2"><label for="D562"><strong>D56.2 — Talasemia delta-beta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D563" value="D56.3"><label for="D563"><strong>D56.3 — Otras talasemias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D564" value="D56.4"><label for="D564"><strong>D56.4 — Persistencia hereditaria de hemoglobina fetal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D568" value="D56.8"><label for="D568"><strong>D56.8 — Otras talasemias especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D569" value="D56.9"><label for="D569"><strong>D56.9 — Talasemia, no especificada</strong></label></div>

        <!-- D57.x -->
        <div class="subcategoria-header banner-anemia">D57.0 — Anemia drepanocítica con crisis</div>
        <div class="patologia-item"><input type="checkbox" id="D571" value="D57.1"><label for="D571"><strong>D57.1 — Anemia drepanocítica sin crisis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D572" value="D57.2"><label for="D572"><strong>D57.2 — Trastornos de células falciformes heterocigotos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D573" value="D57.3"><label for="D573"><strong>D57.3 — Trastornos de células falciformes heterocigotos dobles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D578" value="D57.8"><label for="D578"><strong>D57.8 — Otros trastornos de células falciformes</strong></label></div>

        <!-- D58.x -->
        <div class="subcategoria-header banner-anemia">D58.0 — Esferocitosis hereditaria</div>
        <div class="patologia-item"><input type="checkbox" id="D581" value="D58.1"><label for="D581"><strong>D58.1 — Eliptocitosis hereditaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D582" value="D58.2"><label for="D582"><strong>D58.2 — Estomatocitosis hereditaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D588" value="D58.8"><label for="D588"><strong>D58.8 — Otros trastornos especificados de glóbulos rojos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D589" value="D58.9"><label for="D589"><strong>D58.9 — Trastorno de glóbulos rojos, no especificado</strong></label></div>

        <!-- D59.x -->
        <div class="patologia-item"><input type="checkbox" id="D590" value="D59.0"><label for="D590"><strong>D59.0 — Anemia hemolítica autoinmune con anticuerpo caliente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D591" value="D59.1"><label for="D591"><strong>D59.1 — Anemia hemolítica autoinmune con anticuerpo frío</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D592" value="D59.2"><label for="D592"><strong>D59.2 — Anemia hemolítica autoinmune mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D593" value="D59.3"><label for="D593"><strong>D59.3 — Anemia hemolítica autoinmune de otro tipo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D594" value="D59.4"><label for="D594"><strong>D59.4 — Anemia hemolítica inducida por fármacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D595" value="D59.5"><label for="D595"><strong>D59.5 — Anemia hemolítica inducida por otras sustancias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D596" value="D59.6"><label for="D596"><strong>D59.6 — Anemia hemolítica debida a anticuerpos contra aloantígenos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D598" value="D59.8"><label for="D598"><strong>D59.8 — Otras anemias hemolíticas adquiridas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D599" value="D59.9"><label for="D599"><strong>D59.9 — Anemia hemolítica adquirida, no especificada</strong></label></div>

        <!-- D60.x -->
        <div class="subcategoria-header banner-anemia">D60 — Aplasia pura adquirida de serie roja, tipo agudo</div>
        <div class="patologia-item"><input type="checkbox" id="D601" value="D60.1"><label for="D601"><strong>D60.1 — Aplasia pura adquirida de serie roja, tipo crónico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D608" value="D60.8"><label for="D608"><strong>D60.8 — Otras aplasias puras adquiridas de serie roja</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D609" value="D60.9"><label for="D609"><strong>D60.9 — Aplasia pura adquirida de serie roja, no especificada</strong></label></div>

        <!-- D61.x -->
        <div class="subcategoria-header banner-anemia">D61 — Otras anemias aplásicas</div>
        <div class="patologia-item"><input type="checkbox" id="D611" value="D61.1"><label for="D611"><strong>D61.1 — Anemia aplásica inducida por fármacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D612" value="D61.2"><label for="D612"><strong>D61.2 — Anemia aplásica inducida por radiación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D613" value="D61.3"><label for="D613"><strong>D61.3 — Anemia aplásica secundaria a otra causa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D618" value="D61.8"><label for="D618"><strong>D61.8 — Otras anemias aplásicas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D619" value="D61.9"><label for="D619"><strong>D61.9 — Anemia aplásica, no especificada</strong></label></div>

        <!-- D62 -->
        <div class="subcategoria-header banner-anemia">D62 — Anemia posthemorrágica aguda</div>

        <!-- D63.x -->
        <div class="subcategoria-header banner-anemia">D63.0 — Anemia en enfermedad neoplásica</div>
        <div class="patologia-item"><input type="checkbox" id="D638" value="D63.8"><label for="D638"><strong>D63.8 — Anemia en otras enfermedades crónicas clasificadas en otra parte</strong></label></div>

        <!-- D64.x -->
        <div class="subcategoria-header banner-anemia">D64 — Otras anemias</div>
        <div class="patologia-item"><input type="checkbox" id="D641" value="D64.1"><label for="D641"><strong>D64.1 — Anemia sideroblástica adquirida secundaria a drogas y toxinas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D642" value="D64.2"><label for="D642"><strong>D64.2 — Anemia sideroblástica adquirida secundaria a otras causas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D643" value="D64.3"><label for="D643"><strong>D64.3 — Anemia sideroblástica, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D644" value="D64.4"><label for="D644"><strong>D64.4 — Anemia diseritropoyética congénita</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D648" value="D64.8"><label for="D648"><strong>D64.8 — Otras anemias especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D649" value="D64.9"><label for="D649"><strong>D64.9 — Anemia, no especificada</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->


        <!-- ===================== CATEGORÍA 07: PATOLOGÍAS METABÓLICAS ===================== -->
<div class="categoria-seccion" id="cat-metabolicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-metabolicas')">
    <h4>🧪 PATOLOGÍAS METABÓLICAS
      <span class="categoria-badge" id="badge-metabolicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-metabolicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-metabolicas">

    <!-- ===== Familia: Diabetes mellitus (2) ===== -->
    <div class="familia" data-familia-id="fam-diabetes" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-diabetes-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-diabetes-block', this)">+</button>
        Diabetes mellitus<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-diabetes-block">

        <!-- E10.x — Diabetes mellitus insulinodependiente (tipo 1) -->
        <div class="subcategoria-header banner-diabetes">E10 — Diabetes mellitus insulinodependiente (tipo 1)</div>
        <div class="patologia-item"><input type="checkbox" id="E100" value="E10.0"><label for="E100"><strong>E10.0 — Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E101" value="E10.1"><label for="E101"><strong>E10.1 — Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E102" value="E10.2"><label for="E102"><strong>E10.2 — Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E103" value="E10.3"><label for="E103"><strong>E10.3 — Con complicaciones oftálmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E104" value="E10.4"><label for="E104"><strong>E10.4 — Con complicaciones neurológicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E105" value="E10.5"><label for="E105"><strong>E10.5 — Con complicaciones circulatorias periféricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E106" value="E10.6"><label for="E106"><strong>E10.6 — Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E107" value="E10.7"><label for="E107"><strong>E10.7 — Con múltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E108" value="E10.8"><label for="E108"><strong>E10.8 — Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E109" value="E10.9"><label for="E109"><strong>E10.9 — Sin complicaciones</strong></label></div>

        <!-- E11.x — Diabetes mellitus no insulinodependiente (tipo 2) -->
        <div class="subcategoria-header banner-diabetes">E11 — Diabetes mellitus no insulinodependiente (tipo 2)</div>
        <div class="patologia-item"><input type="checkbox" id="E110" value="E11.0"><label for="E110"><strong>E11.0 — Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E111" value="E11.1"><label for="E111"><strong>E11.1 — Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E112" value="E11.2"><label for="E112"><strong>E11.2 — Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E113" value="E11.3"><label for="E113"><strong>E11.3 — Con complicaciones oftálmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E114" value="E11.4"><label for="E114"><strong>E11.4 — Con complicaciones neurológicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E115" value="E11.5"><label for="E115"><strong>E11.5 — Con complicaciones circulatorias periféricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E116" value="E11.6"><label for="E116"><strong>E11.6 — Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E117" value="E11.7"><label for="E117"><strong>E11.7 — Con múltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E118" value="E11.8"><label for="E118"><strong>E11.8 — Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E119" value="E11.9"><label for="E119"><strong>E11.9 — Sin complicaciones</strong></label></div>

        <!-- E12.x — Diabetes mellitus relacionada con malnutrición -->
        <div class="subcategoria-header banner-diabetes">E12 — Diabetes mellitus relacionada con malnutrición</div>
        <div class="patologia-item"><input type="checkbox" id="E120" value="E12.0"><label for="E120"><strong>E12.0 — Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E121" value="E12.1"><label for="E121"><strong>E12.1 — Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E122" value="E12.2"><label for="E122"><strong>E12.2 — Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E123" value="E12.3"><label for="E123"><strong>E12.3 — Con complicaciones oftálmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E124" value="E12.4"><label for="E124"><strong>E12.4 — Con complicaciones neurológicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E125" value="E12.5"><label for="E125"><strong>E12.5 — Con complicaciones circulatorias periféricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E126" value="E12.6"><label for="E126"><strong>E12.6 — Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E127" value="E12.7"><label for="E127"><strong>E12.7 — Con múltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E128" value="E12.8"><label for="E128"><strong>E12.8 — Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E129" value="E12.9"><label for="E129"><strong>E12.9 — Sin complicaciones</strong></label></div>

        <!-- E13.x — Otras diabetes especificadas -->
        <div class="subcategoria-header banner-diabetes">E13 — Otras formas de diabetes mellitus, especificadas</div>
        <div class="patologia-item"><input type="checkbox" id="E130" value="E13.0"><label for="E130"><strong>E13.0 — Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E131" value="E13.1"><label for="E131"><strong>E13.1 — Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E132" value="E13.2"><label for="E132"><strong>E13.2 — Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E133" value="E13.3"><label for="E133"><strong>E13.3 — Con complicaciones oftálmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E134" value="E13.4"><label for="E134"><strong>E13.4 — Con complicaciones neurológicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E135" value="E13.5"><label for="E135"><strong>E13.5 — Con complicaciones circulatorias periféricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E136" value="E13.6"><label for="E136"><strong>E13.6 — Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E137" value="E13.7"><label for="E137"><strong>E13.7 — Con múltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E138" value="E13.8"><label for="E138"><strong>E13.8 — Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E139" value="E13.9"><label for="E139"><strong>E13.9 — Sin complicaciones</strong></label></div>

        <!-- E14.x — Diabetes mellitus, no especificada -->
        <div class="subcategoria-header banner-diabetes">E14 — Diabetes mellitus, no especificada</div>
        <div class="patologia-item"><input type="checkbox" id="E140" value="E14.0"><label for="E140"><strong>E14.0 — Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E141" value="E14.1"><label for="E141"><strong>E14.1 — Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E142" value="E14.2"><label for="E142"><strong>E14.2 — Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E143" value="E14.3"><label for="E143"><strong>E14.3 — Con complicaciones oftálmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E144" value="E14.4"><label for="E144"><strong>E14.4 — Con complicaciones neurológicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E145" value="E14.5"><label for="E145"><strong>E14.5 — Con complicaciones circulatorias periféricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E146" value="E14.6"><label for="E146"><strong>E14.6 — Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E147" value="E14.7"><label for="E147"><strong>E14.7 — Con múltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E148" value="E14.8"><label for="E148"><strong>E14.8 — Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E149" value="E14.9"><label for="E149"><strong>E14.9 — Sin complicaciones</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dislipidemias (1) ===== -->
    <div class="familia" data-familia-id="fam-dislipidemias" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-dislipidemias-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-dislipidemias-block', this)">+</button>
        Dislipidemias<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-dislipidemias-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E780" value="E78.0"><label for="E780"><strong>E78.0 — Hipercolesterolemia pura</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E781" value="E78.1"><label for="E781"><strong>E78.1 — Hipertrigliceridemia pura</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E782" value="E78.2"><label for="E782"><strong>E78.2 — Hiperlipidemia mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E783" value="E78.3"><label for="E783"><strong>E78.3 — Hiperquilomicronemia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E784" value="E78.4"><label for="E784"><strong>E78.4 — Otras hiperlipidemias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E785" value="E78.5"><label for="E785"><strong>E78.5 — Hiperlipidemia, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E786" value="E78.6"><label for="E786"><strong>E78.6 — Deficiencia de lipoproteínas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E788" value="E78.8"><label for="E788"><strong>E78.8 — Otros trastornos del metabolismo de las lipoproteínas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E789" value="E78.9"><label for="E789"><strong>E78.9 — Trastorno del metabolismo de las lipoproteínas, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Hiperuricemia / Gota (1) ===== -->
    <div class="familia" data-familia-id="fam-hiperuricemia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hiperuricemia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hiperuricemia-block', this)">+</button>
        Hiperuricemia / Gota<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-hiperuricemia-block">
        <div class="patologia-item"><input type="checkbox" id="M100" value="M10.0"><label for="M100"><strong>M10.0 — Gota idiopática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M101" value="M10.1"><label for="M101"><strong>M10.1 — Gota por plomo (saturnina)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M102" value="M10.2"><label for="M102"><strong>M10.2 — Gota debida a insuficiencia renal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M103" value="M10.3"><label for="M103"><strong>M10.3 — Otras gota secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M104" value="M10.4"><label for="M104"><strong>M10.4 — Gota tofácea (crónica)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M109" value="M10.9"><label for="M109"><strong>M10.9 — Gota, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastornos tiroideos (1) ===== -->
    <div class="familia" data-familia-id="fam-tiroideos" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tiroideos-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tiroideos-block', this)">+</button>
        Trastornos tiroideos<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-tiroideos-block">

        <!-- E01.x — Trastornos por deficiencia de yodo y bocio -->
        <div class="subcategoria-header banner-tiroides">E01 — Trastornos tiroideos asociados a deficiencia de yodo</div>
        <div class="patologia-item"><input type="checkbox" id="E010" value="E01.0"><label for="E010"><strong>E01.0 — Bocio difuso por deficiencia de yodo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E011" value="E01.1"><label for="E011"><strong>E01.1 — Bocio multinodular por deficiencia de yodo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E012" value="E01.2"><label for="E012"><strong>E01.2 — Bocio no especificado por deficiencia de yodo</strong></label></div>

        <!-- E02 — Hipotiroidismo subclínico por deficiencia de yodo -->
        <div class="subcategoria-header banner-tiroides">E02 — Hipotiroidismo subclínico por deficiencia de yodo</div>
        <div class="patologia-item"><input type="checkbox" id="E02" value="E02"><label for="E02"><strong>E02 — Hipotiroidismo subclínico por deficiencia de yodo</strong></label></div>

        <!-- E03.x — Otros hipotiroidismos -->
        <div class="subcategoria-header banner-tiroides">E03 — Otros hipotiroidismos</div>
        <div class="patologia-item"><input type="checkbox" id="E030" value="E03.0"><label for="E030"><strong>E03.0 — Hipotiroidismo congénito con bocio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E031" value="E03.1"><label for="E031"><strong>E03.1 — Hipotiroidismo congénito sin bocio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E032" value="E03.2"><label for="E032"><strong>E03.2 — Hipotiroidismo inducido por fármacos y otras sustancias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E033" value="E03.3"><label for="E033"><strong>E03.3 — Hipotiroidismo postinfeccioso</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E034" value="E03.4"><label for="E034"><strong>E03.4 — Atrofia adquirida de la glándula tiroides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E035" value="E03.5"><label for="E035"><strong>E03.5 — Mixedema coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E038" value="E03.8"><label for="E038"><strong>E03.8 — Otros hipotiroidismos especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E039" value="E03.9"><label for="E039"><strong>E03.9 — Hipotiroidismo, no especificado</strong></label></div>

        <!-- E05.x — Tirotoxicosis (hipertiroidismo) -->
        <div class="subcategoria-header banner-tiroides">E05 — Tirotoxicosis (hipertiroidismo)</div>
        <div class="patologia-item"><input type="checkbox" id="E050" value="E05.0"><label for="E050"><strong>E05.0 — Tirotoxicosis con bocio difuso (Graves)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E051" value="E05.1"><label for="E051"><strong>E05.1 — Tirotoxicosis con bocio tóxico multinodular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E052" value="E05.2"><label for="E052"><strong>E05.2 — Tirotoxicosis con bocio tóxico nodular único</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E053" value="E05.3"><label for="E053"><strong>E05.3 — Tirotoxicosis por tiroiditis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E054" value="E05.4"><label for="E054"><strong>E05.4 — Tirotoxicosis facticia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E055" value="E05.5"><label for="E055"><strong>E05.5 — Crisis tiro tóxica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E058" value="E05.8"><label for="E058"><strong>E05.8 — Otras tirotoxicosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="E059" value="E05.9"><label for="E059"><strong>E05.9 — Tirotoxicosis, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Obesidad (1) ===== -->
    <div class="familia" data-familia-id="fam-obesidad" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-obesidad-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-obesidad-block', this)">+</button>
        Obesidad<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-obesidad-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E660" value="E66.0"><label for="E660"><strong>E66.0 — Obesidad debida a exceso de calorías</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E661" value="E66.1"><label for="E661"><strong>E66.1 — Obesidad inducida por fármacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E662" value="E66.2"><label for="E662"><strong>E66.2 — Obesidad con hipoventilación alveolar (síndrome de Pickwick)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E668" value="E66.8"><label for="E668"><strong>E66.8 — Otras obesidades</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E669" value="E66.9"><label for="E669"><strong>E66.9 — Obesidad, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 08: DIFICULTADES SOCIOECONÓMICAS O PSICOSOCIALES ===================== -->
<div class="categoria-seccion" id="cat-socioeconomicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-socioeconomicas')">
    <h4>⚖️ DIFICULTADES SOCIOECONÓMICAS O PSICOSOCIALES
      <span class="categoria-badge" id="badge-socioeconomicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-socioeconomicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-socioeconomicas">

    <!-- ===== Familia: Dificultades socioeconómicas o psicosociales (1) ===== -->
    <div class="familia" data-familia-id="fam-socioeconomicas" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-socioeconomicas-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-socioeconomicas-block', this)">+</button>
        Dificultades socioeconómicas o psicosociales<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-socioeconomicas-block">

        <!-- Z55.x — Problemas relacionados con la educación y la alfabetización -->
        <div class="subcategoria-header banner-psicosocial">Z55 — Problemas relacionados con la educación y la alfabetización</div>
        <div class="patologia-item"><input type="checkbox" id="Z550" value="Z55.0"><label for="Z550"><strong>Z55.0 — Analfabetismo e instrucción inadecuada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z558" value="Z55.8"><label for="Z558"><strong>Z55.8 — Otros problemas de educación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z559" value="Z55.9"><label for="Z559"><strong>Z55.9 — Problema de educación, no especificado</strong></label></div>

        <!-- Z56.x — Problemas relacionados con el empleo y el desempleo -->
        <div class="subcategoria-header banner-psicosocial">Z56 — Problemas relacionados con el empleo y el desempleo</div>
        <div class="patologia-item"><input type="checkbox" id="Z560" value="Z56.0"><label for="Z560"><strong>Z56.0 — Desempleo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z561" value="Z56.1"><label for="Z561"><strong>Z56.1 — Cambio de trabajo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z566" value="Z56.6"><label for="Z566"><strong>Z56.6 — Otras dificultades físicas y mentales relacionadas con el trabajo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z567" value="Z56.7"><label for="Z567"><strong>Z56.7 — Insatisfacción en el trabajo</strong></label></div>

        <!-- Z57.x — Exposición ocupacional a factores de riesgo -->
        <div class="subcategoria-header banner-psicosocial">Z57 — Exposición ocupacional a factores de riesgo</div>
        <div class="patologia-item"><input type="checkbox" id="Z570" value="Z57.0"><label for="Z570"><strong>Z57.0 — Exposición ocupacional a ruido</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z571" value="Z57.1"><label for="Z571"><strong>Z57.1 — Exposición ocupacional a radiación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z572" value="Z57.2"><label for="Z572"><strong>Z57.2 — Exposición ocupacional a polvo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z573" value="Z57.3"><label for="Z573"><strong>Z57.3 — Exposición ocupacional a humos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z574" value="Z57.4"><label for="Z574"><strong>Z57.4 — Exposición ocupacional a gases</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z575" value="Z57.5"><label for="Z575"><strong>Z57.5 — Exposición ocupacional a vapores</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z576" value="Z57.6"><label for="Z576"><strong>Z57.6 — Exposición ocupacional a temperaturas extremas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z577" value="Z57.7"><label for="Z577"><strong>Z57.7 — Exposición ocupacional a vibración</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z578" value="Z57.8"><label for="Z578"><strong>Z57.8 — Exposición ocupacional a otros riesgos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z579" value="Z57.9"><label for="Z579"><strong>Z57.9 — Exposición ocupacional a riesgo no especificado</strong></label></div>

        <!-- Z58.x — Problemas relacionados con el entorno físico -->
        <div class="subcategoria-header banner-psicosocial">Z58 — Problemas relacionados con el entorno físico</div>
        <div class="patologia-item"><input type="checkbox" id="Z580" value="Z58.0"><label for="Z580"><strong>Z58.0 — Exposición a contaminación atmosférica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z581" value="Z58.1"><label for="Z581"><strong>Z58.1 — Exposición a contaminación del agua</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z582" value="Z58.2"><label for="Z582"><strong>Z58.2 — Exposición a contaminación del suelo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z583" value="Z58.3"><label for="Z583"><strong>Z58.3 — Exposición a contaminación por radiación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z584" value="Z58.4"><label for="Z584"><strong>Z58.4 — Exposición a contaminación acústica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z585" value="Z58.5"><label for="Z585"><strong>Z58.5 — Exposición a otras contaminaciones específicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z588" value="Z58.8"><label for="Z588"><strong>Z58.8 — Otros problemas del entorno físico</strong></label></div>

        <!-- Z59.x — Problemas relacionados con la vivienda y las condiciones económicas -->
        <div class="subcategoria-header banner-psicosocial">Z59 — Problemas relacionados con la vivienda y las condiciones económicas</div>
        <div class="patologia-item"><input type="checkbox" id="Z590" value="Z59.0"><label for="Z590"><strong>Z59.0 — Falta de vivienda</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z591" value="Z59.1"><label for="Z591"><strong>Z59.1 — Vivienda inadecuada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z594" value="Z59.4"><label for="Z594"><strong>Z59.4 — Falta de recursos adecuados de alimentos seguros</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z595" value="Z59.5"><label for="Z595"><strong>Z59.5 — Pobreza extrema</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z596" value="Z59.6"><label for="Z596"><strong>Z59.6 — Baja renta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z597" value="Z59.7"><label for="Z597"><strong>Z59.7 — Vivienda insegura</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z598" value="Z59.8"><label for="Z598"><strong>Z59.8 — Otros problemas de vivienda y económicos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z599" value="Z59.9"><label for="Z599"><strong>Z59.9 — Problemas de vivienda y económicos, no especificados</strong></label></div>

        <!-- Z60.x — Problemas relacionados con el entorno social -->
        <div class="subcategoria-header banner-psicosocial">Z60 — Problemas relacionados con el entorno social</div>
        <div class="patologia-item"><input type="checkbox" id="Z605" value="Z60.5"><label for="Z605"><strong>Z60.5 — Aislamiento social</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z608" value="Z60.8"><label for="Z608"><strong>Z60.8 — Otros problemas relacionados con el entorno social</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z609" value="Z60.9"><label for="Z609"><strong>Z60.9 — Problema relacionado con el entorno social, no especificado</strong></label></div>

        <!-- Z62.x / Z63.x — Problemas relacionados con crianza y relaciones -->
        <div class="subcategoria-header banner-psicosocial">Z62 / Z63 — Problemas relacionados con crianza y relaciones</div>
        <div class="patologia-item"><input type="checkbox" id="Z625" value="Z62.5"><label for="Z625"><strong>Z62.5 — Otras experiencias adversas en la niñez</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z628" value="Z62.8"><label for="Z628"><strong>Z62.8 — Otros problemas relacionados con crianza</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z629" value="Z62.9"><label for="Z629"><strong>Z62.9 — Problemas relacionados con crianza, no especificado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z638" value="Z63.8"><label for="Z638"><strong>Z63.8 — Otros problemas relacionados con la familia y el apoyo primario</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z639" value="Z63.9"><label for="Z639"><strong>Z63.9 — Problema familiar no especificado</strong></label></div>

        <!-- Z65.x — Otros problemas psicosociales -->
        <div class="subcategoria-header banner-psicosocial">Z65 — Otros problemas psicosociales</div>
        <div class="patologia-item"><input type="checkbox" id="Z658" value="Z65.8"><label for="Z658"><strong>Z65.8 — Otros problemas especificados relacionados con circunstancias psicosociales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Z659" value="Z65.9"><label for="Z659"><strong>Z65.9 — Problema psicosocial, no especificado</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 09: PATOLOGÍAS GASTROINTESTINALES ===================== -->
<div class="categoria-seccion" id="cat-gastrointestinales" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-gastrointestinales')">
    <h4>🍽️ PATOLOGÍAS GASTROINTESTINALES
      <span class="categoria-badge" id="badge-gastrointestinales">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-gastrointestinales">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-gastrointestinales">

    <!-- ===== Familia: Enfermedad hepática (1) ===== -->
    <div class="familia" data-familia-id="fam-enfermedad-hepatica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-enfermedad-hepatica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-enfermedad-hepatica-block', this)">+</button>
        Enfermedad hepática<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-enfermedad-hepatica-block">

        <!-- B18.x — Hepatitis viral crónica -->
        <div class="subcategoria-header banner-hepaticas">B18 — Hepatitis viral crónica</div>
        <div class="patologia-item"><input type="checkbox" id="B180" value="B18.0"><label for="B180"><strong>B18.0 — Hepatitis viral crónica B con agente delta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B181" value="B18.1"><label for="B181"><strong>B18.1 — Hepatitis viral crónica B sin agente delta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B182" value="B18.2"><label for="B182"><strong>B18.2 — Hepatitis viral crónica C</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B188" value="B18.8"><label for="B188"><strong>B18.8 — Otras hepatitis virales crónicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B189" value="B18.9"><label for="B189"><strong>B18.9 — Hepatitis viral crónica, no especificada</strong></label></div>

        <!-- K70.x — Enfermedad hepática alcohólica -->
        <div class="subcategoria-header banner-hepaticas">K70 — Enfermedad hepática alcohólica</div>
        <div class="patologia-item"><input type="checkbox" id="K700" value="K70.0"><label for="K700"><strong>K70.0 — Hígado graso alcohólico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K701" value="K70.1"><label for="K701"><strong>K70.1 — Hepatitis alcohólica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K702" value="K70.2"><label for="K702"><strong>K70.2 — Fibrosis y esclerosis hepática alcohólica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K703" value="K70.3"><label for="K703"><strong>K70.3 — Cirrosis hepática alcohólica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K704" value="K70.4"><label for="K704"><strong>K70.4 — Insuficiencia hepática alcohólica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K709" value="K70.9"><label for="K709"><strong>K70.9 — Enfermedad hepática alcohólica, no especificada</strong></label></div>

        <!-- K71.x — Enfermedad tóxica del hígado -->
        <div class="subcategoria-header banner-hepaticas">K71 — Enfermedad tóxica del hígado</div>
        <div class="patologia-item"><input type="checkbox" id="K710" value="K71.0"><label for="K710"><strong>K71.0 — Con colestasis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K711" value="K71.1"><label for="K711"><strong>K71.1 — Con necrosis hepática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K712" value="K71.2"><label for="K712"><strong>K71.2 — Con hepatitis aguda</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K713" value="K71.3"><label for="K713"><strong>K71.3 — Con hepatitis crónica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K714" value="K71.4"><label for="K714"><strong>K71.4 — Con fibrosis y cirrosis hepática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K715" value="K71.5"><label for="K715"><strong>K71.5 — Con insuficiencia hepática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K716" value="K71.6"><label for="K716"><strong>K71.6 — Con otros trastornos hepáticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K717" value="K71.7"><label for="K717"><strong>K71.7 — Con hepatomegalia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K718" value="K71.8"><label for="K718"><strong>K71.8 — Otras enfermedades tóxicas del hígado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K719" value="K71.9"><label for="K719"><strong>K71.9 — Enfermedad tóxica del hígado, no especificada</strong></label></div>

        <!-- K72.1 — Insuficiencia hepática crónica -->
        <div class="subcategoria-header banner-hepaticas">K72 — Insuficiencia hepática (no clasificada en otra parte)</div>
        <div class="patologia-item"><input type="checkbox" id="K721" value="K72.1"><label for="K721"><strong>K72.1 — Insuficiencia hepática crónica</strong></label></div>

        <!-- K73.x — Hepatitis crónica (no clasificada en otra parte) -->
        <div class="subcategoria-header banner-hepaticas">K73 — Hepatitis crónica (no clasificada en otra parte)</div>
        <div class="patologia-item"><input type="checkbox" id="K730" value="K73.0"><label for="K730"><strong>K73.0 — Hepatitis crónica persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K731" value="K73.1"><label for="K731"><strong>K73.1 — Hepatitis crónica lobular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K732" value="K73.2"><label for="K732"><strong>K73.2 — Hepatitis crónica activa, no clasificada en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K738" value="K73.8"><label for="K738"><strong>K73.8 — Otras hepatitis crónicas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K739" value="K73.9"><label for="K739"><strong>K73.9 — Hepatitis crónica, no especificada</strong></label></div>

        <!-- K74.0–K74.5 — Fibrosis y cirrosis del hígado -->
        <div class="subcategoria-header banner-hepaticas">K74 — Fibrosis y cirrosis del hígado</div>
        <div class="patologia-item"><input type="checkbox" id="K740" value="K74.0"><label for="K740"><strong>K74.0 — Fibrosis hepática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K741" value="K74.1"><label for="K741"><strong>K74.1 — Esclerosis hepática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K742" value="K74.2"><label for="K742"><strong>K74.2 — Fibrosis y esclerosis hepática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K743" value="K74.3"><label for="K743"><strong>K74.3 — Cirrosis biliar primaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K744" value="K74.4"><label for="K744"><strong>K74.4 — Cirrosis biliar secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K745" value="K74.5"><label for="K745"><strong>K74.5 — Cirrosis biliar, no especificada</strong></label></div>

        <!-- K76.6 — Hipertensión portal -->
        <div class="subcategoria-header banner-hepaticas">K76 — Otros trastornos del hígado</div>
        <div class="patologia-item"><input type="checkbox" id="K766" value="K76.6"><label for="K766"><strong>K76.6 — Hipertensión portal</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enteritis crónica / colitis ulcerosa / Crohn (1) ===== -->
    <div class="familia" data-familia-id="fam-enteritis-cronica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-enteritis-cronica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-enteritis-cronica-block', this)">+</button>
        Enteritis crónica / colitis ulcerosa / Crohn<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-enteritis-cronica-block">

        <!-- K50.x — Enfermedad de Crohn -->
        <div class="subcategoria-header banner-gastro">K50 — Enfermedad de Crohn</div>
        <div class="patologia-item"><input type="checkbox" id="K500" value="K50.0"><label for="K500"><strong>K50.0 — Enfermedad de Crohn del intestino delgado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K501" value="K50.1"><label for="K501"><strong>K50.1 — Enfermedad de Crohn del intestino grueso</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K508" value="K50.8"><label for="K508"><strong>K50.8 — Otras formas de enfermedad de Crohn</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K509" value="K50.9"><label for="K509"><strong>K50.9 — Enfermedad de Crohn, no especificada</strong></label></div>

        <!-- K51.0–K51.3 — Colitis ulcerosa -->
        <div class="subcategoria-header banner-gastro">K51 — Colitis ulcerosa</div>
        <div class="patologia-item"><input type="checkbox" id="K510" value="K51.0"><label for="K510"><strong>K51.0 — Colitis ulcerosa (pancolitis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K511" value="K51.1"><label for="K511"><strong>K51.1 — Proctitis ulcerosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K512" value="K51.2"><label for="K512"><strong>K51.2 — Proctosigmoiditis ulcerosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K513" value="K51.3"><label for="K513"><strong>K51.3 — Colitis ulcerosa distal (rectosigmoiditis)</strong></label></div>

        <!-- K52.0–K52.3, K52.8–K52.9 — Gastroenteritis/colitis no infecciosas -->
        <div class="subcategoria-header banner-gastro">K52 — Gastroenteritis y colitis no infecciosas</div>
        <div class="patologia-item"><input type="checkbox" id="K520" value="K52.0"><label for="K520"><strong>K52.0 — Gastroenteritis y colitis no infecciosas debidas a radiación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K521" value="K52.1"><label for="K521"><strong>K52.1 — Gastroenteritis y colitis tóxicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K522" value="K52.2"><label for="K522"><strong>K52.2 — Gastroenteritis y colitis alérgicas y dietéticas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K523" value="K52.3"><label for="K523"><strong>K52.3 — Colitis inducida por fármacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K528" value="K52.8"><label for="K528"><strong>K52.8 — Otras gastroenteritis y colitis no infecciosas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="K529" value="K52.9"><label for="K529"><strong>K52.9 — Gastroenteritis y colitis no infecciosas, no especificadas</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 10: PATOLOGÍAS PULMONARES ===================== -->
<div class="categoria-seccion" id="cat-pulmonares" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-pulmonares')">
    <h4>🌬️ PATOLOGÍAS PULMONARES
      <span class="categoria-badge" id="badge-pulmonares">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-pulmonares">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-pulmonares">

    <!-- ===== Familia: Asma (1) ===== -->
    <div class="familia" data-familia-id="fam-asma" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-asma-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-asma-block', this)">+</button>
        Asma<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-asma-block">
        <div class="patologia-item"><input type="checkbox" id="J450" value="J45.0"><label for="J450"><strong>J45.0 — Asma predominantemente alérgica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J451" value="J45.1"><label for="J451"><strong>J45.1 — Asma no alérgica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J458" value="J45.8"><label for="J458"><strong>J45.8 — Asma mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J459" value="J45.9"><label for="J459"><strong>J45.9 — Asma no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J46" value="J46"><label for="J46"><strong>J46 — Estado asmático</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedad pulmonar obstructiva crónica (EPOC) (1) ===== -->
    <div class="familia" data-familia-id="fam-epoc" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-epoc-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-epoc-block', this)">+</button>
        Enfermedad pulmonar obstructiva crónica (EPOC)<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-epoc-block">

        <!-- J41.x — Bronquitis crónica simple y mucopurulenta -->
        <div class="subcategoria-header banner-respiratorias">J41 — Bronquitis crónica simple y mucopurulenta</div>
        <div class="patologia-item"><input type="checkbox" id="J410" value="J41.0"><label for="J410"><strong>J41.0 — Bronquitis crónica simple</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J411" value="J41.1"><label for="J411"><strong>J41.1 — Bronquitis crónica mucopurulenta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J418" value="J41.8"><label for="J418"><strong>J41.8 — Bronquitis crónica mixta simple y mucopurulenta</strong></label></div>

        <!-- J42 — Bronquitis crónica no especificada -->
        <div class="subcategoria-header banner-respiratorias">J42 — Bronquitis crónica no especificada</div>
        <div class="patologia-item"><input type="checkbox" id="J42" value="J42"><label for="J42"><strong>J42 — Bronquitis crónica no especificada</strong></label></div>

        <!-- J43.x — Enfisema -->
        <div class="subcategoria-header banner-respiratorias">J43 — Enfisema</div>
        <div class="patologia-item"><input type="checkbox" id="J430" value="J43.0"><label for="J430"><strong>J43.0 — Enfisema macroscópico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J431" value="J43.1"><label for="J431"><strong>J43.1 — Enfisema panlobular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J432" value="J43.2"><label for="J432"><strong>J43.2 — Enfisema centrolobular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J438" value="J43.8"><label for="J438"><strong>J43.8 — Otras formas de enfisema</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J439" value="J43.9"><label for="J439"><strong>J43.9 — Enfisema, no especificado</strong></label></div>

        <!-- J44.x — Otras enfermedades pulmonares obstructivas crónicas -->
        <div class="subcategoria-header banner-respiratorias">J44 — Otras enfermedades pulmonares obstructivas crónicas</div>
        <div class="patologia-item"><input type="checkbox" id="J440" value="J44.0"><label for="J440"><strong>J44.0 — EPOC con infección respiratoria aguda inferior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J441" value="J44.1"><label for="J441"><strong>J44.1 — EPOC con exacerbación aguda, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J448" value="J44.8"><label for="J448"><strong>J44.8 — Otras EPOC especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="J449" value="J44.9"><label for="J449"><strong>J44.9 — EPOC, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 11: PATOLOGÍAS RENALES Y UROLÓGICAS ===================== -->
<div class="categoria-seccion" id="cat-renales" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-renales')">
    <h4>💧 PATOLOGÍAS RENALES Y UROLÓGICAS
      <span class="categoria-badge" id="badge-renales">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-renales">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-renales">

    <!-- ===== Familia: Enfermedad renal crónica (1) ===== -->
    <div class="familia" data-familia-id="fam-erc" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-erc-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-erc-block', this)">+</button>
        Enfermedad renal crónica<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-erc-block">

        <!-- N15.x -->
        <div class="subcategoria-header banner-renales">N15 — Enfermedades túbulo-intersticiales renales</div>
        <div class="patologia-item"><input type="checkbox" id="N150" value="N15.0"><label for="N150"><strong>N15.0 — Absceso renal y perinefrítico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N151" value="N15.1"><label for="N151"><strong>N15.1 — Nefritis crónica intersticial</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N158" value="N15.8"><label for="N158"><strong>N15.8 — Otras enfermedades renales intersticiales especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N159" value="N15.9"><label for="N159"><strong>N15.9 — Enfermedad renal intersticial, no especificada</strong></label></div>

        <!-- N18.x -->
        <div class="subcategoria-header banner-renales">N18 — Enfermedad renal crónica</div>
        <div class="patologia-item"><input type="checkbox" id="N181" value="N18.1"><label for="N181"><strong>N18.1 — ERC estadio 1</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N182" value="N18.2"><label for="N182"><strong>N18.2 — ERC estadio 2</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N183" value="N18.3"><label for="N183"><strong>N18.3 — ERC estadio 3</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N189" value="N18.9"><label for="N189"><strong>N18.9 — ERC no especificada</strong></label></div>

        <!-- N19 -->
        <div class="patologia-item"><input type="checkbox" id="N19" value="N19"><label for="N19"><strong>N19 — Insuficiencia renal no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedad renal crónica avanzada (2) ===== -->
    <div class="familia" data-familia-id="fam-erc-avanzada" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-erc-avanzada-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-erc-avanzada-block', this)">+</button>
        Enfermedad renal crónica avanzada<span class="badge-puntos">(2)
      </div>
      <div class="familia-content collapsed" id="fam-erc-avanzada-block">
        <div class="patologia-item"><input type="checkbox" id="N184" value="N18.4"><label for="N184"><strong>N18.4 — ERC estadio 4</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N185" value="N18.5"><label for="N185"><strong>N18.5 — ERC estadio 5</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="N186" value="N18.6"><label for="N186"><strong>N18.6 — ERC en tratamiento de diálisis</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Hipertrofia prostática benigna (1) ===== -->
    <div class="familia" data-familia-id="fam-hiperplasia-prostatica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hiperplasia-prostatica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hiperplasia-prostatica-block', this)">+</button>
        Hipertrofia prostática benigna<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-hiperplasia-prostatica-block">
        <div class="patologia-item"><input type="checkbox" id="N40" value="N40"><label for="N40"><strong>N40 — Hipertrofia prostática benigna</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 12: PATOLOGÍAS OFTALMOLÓGICAS ===================== -->
<div class="categoria-seccion" id="cat-oftalmologicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-oftalmologicas')">
    <h4>👁️ PATOLOGÍAS OFTALMOLÓGICAS
      <span class="categoria-badge" id="badge-oftalmologicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-oftalmologicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-oftalmologicas">

   <!-- ===== Familia: Glaucoma (1) ===== -->
<div class="familia" data-familia-id="fam-glaucoma" data-points="1">
  <div class="familia-header" onclick="toggleFamilia('fam-glaucoma-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-glaucoma-block', this)">+</button>
        Glaucoma<span class="badge-puntos">(1)
      </div>
  <div class="familia-content collapsed" id="fam-glaucoma-block">

    <!-- H40.x — Glaucoma -->
    <div class="subcategoria-header banner-oftalmo">H40 — Glaucoma</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H401" name="patologia[]" value="H40.1" data-points="1"><label for="H401"><strong>H40.1 — Glaucoma primario de ángulo abierto</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H402" name="patologia[]" value="H40.2" data-points="1"><label for="H402"><strong>H40.2 — Glaucoma primario de ángulo cerrado</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H403" name="patologia[]" value="H40.3" data-points="1"><label for="H403"><strong>H40.3 — Glaucoma secundario a traumatismo ocular</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H404" name="patologia[]" value="H40.4" data-points="1"><label for="H404"><strong>H40.4 — Glaucoma secundario a inflamación ocular</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H405" name="patologia[]" value="H40.5" data-points="1"><label for="H405"><strong>H40.5 — Glaucoma secundario a otros trastornos del ojo</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H406" name="patologia[]" value="H40.6" data-points="1"><label for="H406"><strong>H40.6 — Glaucoma secundario a fármacos</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H408" name="patologia[]" value="H40.8" data-points="1"><label for="H408"><strong>H40.8 — Otros glaucomas</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H409" name="patologia[]" value="H40.9" data-points="1"><label for="H409"><strong>H40.9 — Glaucoma, no especificado</strong></label></div>

    <!-- H42.x — Glaucoma en enfermedades clasificadas en otra parte -->
    <div class="subcategoria-header banner-oftalmo">H42 — Glaucoma en enfermedades clasificadas en otra parte</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H420" name="patologia[]" value="H42.0" data-points="1"><label for="H420"><strong>H42.0 — En enfermedades endocrinas, nutricionales y metabólicas</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H428" name="patologia[]" value="H42.8" data-points="1"><label for="H428"><strong>H42.8 — En otras enfermedades clasificadas en otra parte</strong></label></div>
  </div>
</div>

<!-- ===== Familia: Catarata / Retinopatía (1) ===== -->
<div class="familia" data-familia-id="fam-catarata-retinopatia" data-points="1">
  <div class="familia-header" onclick="toggleFamilia('fam-catarata-retinopatia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-catarata-retinopatia-block', this)">+</button>
        Catarata / Retinopatía<span class="badge-puntos">(1)
      </div>
  <div class="familia-content collapsed" id="fam-catarata-retinopatia-block">

    <!-- H25 — Catarata senil -->
    <div class="subcategoria-header banner-oftalmo">H25 — Catarata senil</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H250" name="patologia[]" value="H25.0" data-points="1"><label for="H250"><strong>H25.0</strong>Catarata senil nuclear</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H251" name="patologia[]" value="H25.1" data-points="1"><label for="H251"><strong>H25.1</strong>Catarata senil cortical</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H252" name="patologia[]" value="H25.2" data-points="1"><label for="H252"><strong>H25.2</strong>Catarata senil subcapsular posterior</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H258" name="patologia[]" value="H25.8" data-points="1"><label for="H258"><strong>H25.8</strong>Otras cataratas seniles</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H259" name="patologia[]" value="H25.9" data-points="1"><label for="H259"><strong>H25.9</strong>Catarata senil, no especificada</label></div>

    <!-- H26 — Otras cataratas -->
    <div class="subcategoria-header banner-oftalmo">H26 — Otras cataratas</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H260" name="patologia[]" value="H26.0" data-points="1"><label for="H260"><strong>H26.0</strong>Catarata infantil, juvenil o presenil</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H261" name="patologia[]" value="H26.1" data-points="1"><label for="H261"><strong>H26.1</strong>Catarata traumática</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H262" name="patologia[]" value="H26.2" data-points="1"><label for="H262"><strong>H26.2</strong>Catarata complicada</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H263" name="patologia[]" value="H26.3" data-points="1"><label for="H263"><strong>H26.3</strong>Catarata inducida por fármacos</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H264" name="patologia[]" value="H26.4" data-points="1"><label for="H264"><strong>H26.4</strong>After-cataract/Opacificación capsular</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H268" name="patologia[]" value="H26.8" data-points="1"><label for="H268"><strong>H26.8</strong>Otras cataratas especificadas</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H269" name="patologia[]" value="H26.9" data-points="1"><label for="H269"><strong>H26.9</strong>Catarata, no especificada</label></div>

    <!-- H28 — Cambios del cristalino en enfermedades clasificadas en otra parte -->
    <div class="subcategoria-header">H28 — Cambios del cristalino en otras enfermedades</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H280" name="patologia[]" value="H28.0" data-points="1"><label for="H280"><strong>H28.0</strong>Catarata en diabetes y otras enfermedades</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H281" name="patologia[]" value="H28.1" data-points="1"><label for="H281"><strong>H28.1</strong>Cambios del cristalino en otras enfermedades</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H282" name="patologia[]" value="H28.2" data-points="1"><label for="H282"><strong>H28.2</strong>Cambios del cristalino postradiación</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H288" name="patologia[]" value="H28.8" data-points="1"><label for="H288"><strong>H28.8</strong>Otros cambios del cristalino</label></div>

    <!-- Q12 — Anomalías congénitas del cristalino -->
    <div class="subcategoria-header banner-oftalmo">Q12 — Anomalías congénitas del cristalino</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q120" name="patologia[]" value="Q12.0" data-points="1"><label for="Q120"><strong>Q12.0</strong>Afaquia congénita</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q121" name="patologia[]" value="Q12.1" data-points="1"><label for="Q121"><strong>Q12.1</strong>Dislocación congénita del cristalino</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q122" name="patologia[]" value="Q12.2" data-points="1"><label for="Q122"><strong>Q12.2</strong>Esferofaquia congénita</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q123" name="patologia[]" value="Q12.3" data-points="1"><label for="Q123"><strong>Q12.3</strong>Microfaquia congénita</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q124" name="patologia[]" value="Q12.4" data-points="1"><label for="Q124"><strong>Q12.4</strong>Coloboma del cristalino</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q128" name="patologia[]" value="Q12.8" data-points="1"><label for="Q128"><strong>Q12.8</strong>Otras anomalías congénitas del cristalino</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q129" name="patologia[]" value="Q12.9" data-points="1"><label for="Q129"><strong>Q12.9</strong>Anomalía congénita del cristalino, no especificada</label></div>
  </div>
</div>

<!-- ===== Familia: Ceguera (1) ===== -->
<div class="familia" data-familia-id="fam-ceguera" data-points="1">
  <div class="familia-header" onclick="toggleFamilia('fam-ceguera-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ceguera-block', this)">+</button>
        Ceguera<span class="badge-puntos">(1)
      </div>
  <div class="familia-content collapsed" id="fam-ceguera-block">

    <!-- H54 — Ceguera y disminución de la agudeza visual -->
    <div class="subcategoria-header banner-oftalmo">H54 — Ceguera y disminución de la agudeza visual</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H540" name="patologia[]" value="H54.0" data-points="1"><label for="H540"><strong>H54.0</strong>Ceguera binocular</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H541" name="patologia[]" value="H54.1" data-points="1"><label for="H541"><strong>H54.1</strong>Ceguera monocular y visión reducida contralateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H542" name="patologia[]" value="H54.2" data-points="1"><label for="H542"><strong>H54.2</strong>Disminución grave de la agudeza visual, bilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H543" name="patologia[]" value="H54.3" data-points="1"><label for="H543"><strong>H54.3</strong>Disminución moderada de la agudeza visual, bilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H544" name="patologia[]" value="H54.4" data-points="1"><label for="H544"><strong>H54.4</strong>Disminución leve de la agudeza visual, bilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H545" name="patologia[]" value="H54.5" data-points="1"><label for="H545"><strong>H54.5</strong>Disminución no especificada de la agudeza visual</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H546" name="patologia[]" value="H54.6" data-points="1"><label for="H546"><strong>H54.6</strong>Ceguera unilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H547" name="patologia[]" value="H54.7" data-points="1"><label for="H547"><strong>H54.7</strong>Ceguera, no especificada</label></div>
  </div>
</div>

    <!-- ===== Familia: Presbiacusia / Hipoacusia / Sordera (1) ===== -->
    <div class="familia" data-familia-id="fam-hipoacusia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hipoacusia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hipoacusia-block', this)">+</button>
        Presbiacusia / Hipoacusia / Sordera<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-hipoacusia-block">
        
        <!-- H90.x — Hipoacusia de transmisión y neurosensorial -->
        <div class="subcategoria-header">H90 — Hipoacusia de transmisión y neurosensorial</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H900" name="patologia[]" value="H90.0" data-points="1"><label for="H900"><strong>H90.0</strong> — Hipoacusia conductiva bilateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H901" name="patologia[]" value="H90.1" data-points="1"><label for="H901"><strong>H90.1</strong> — Hipoacusia conductiva unilateral con audición irrestricta contralateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H902" name="patologia[]" value="H90.2" data-points="1"><label for="H902"><strong>H90.2</strong> — Hipoacusia conductiva, no especificada</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H903" name="patologia[]" value="H90.3" data-points="1"><label for="H903"><strong>H90.3</strong> — Hipoacusia neurosensorial bilateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H904" name="patologia[]" value="H90.4" data-points="1"><label for="H904"><strong>H90.4</strong> — Hipoacusia neurosensorial unilateral con audición irrestricta contralateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H905" name="patologia[]" value="H90.5" data-points="1"><label for="H905"><strong>H90.5</strong> — Hipoacusia neurosensorial, no especificada</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H906" name="patologia[]" value="H90.6" data-points="1"><label for="H906"><strong>H90.6</strong> — Hipoacusia mixta bilateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H907" name="patologia[]" value="H90.7" data-points="1"><label for="H907"><strong>H90.7</strong> — Hipoacusia mixta unilateral con audición irrestricta contralateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H908" name="patologia[]" value="H90.8" data-points="1"><label for="H908"><strong>H90.8</strong> — Hipoacusia mixta, no especificada</label></div>

        <!-- H91.x — Otras hipoacusias -->
        <div class="subcategoria-header">H91 — Otras hipoacusias</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H910" name="patologia[]" value="H91.0" data-points="1"><label for="H910"><strong>H91.0</strong> — Hipoacusia ototóxica</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H911" name="patologia[]" value="H91.1" data-points="1"><label for="H911"><strong>H91.1</strong> — Presbiacusia</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H912" name="patologia[]" value="H91.2" data-points="1"><label for="H912"><strong>H91.2</strong> — Hipoacusia súbita idiopática</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H918" name="patologia[]" value="H91.8" data-points="1"><label for="H918"><strong>H91.8</strong> — Otras hipoacusias especificadas</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H919" name="patologia[]" value="H91.9" data-points="1"><label for="H919"><strong>H91.9</strong> — Hipoacusia, no especificada</label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 13: PATOLOGÍAS INMUNOLÓGICAS ===================== -->
<div class="categoria-seccion" id="cat-inmunologicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-inmunologicas')">
    <h4>🧬 PATOLOGÍAS INMUNOLÓGICAS
      <span class="categoria-badge" id="badge-inmunologicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-inmunologicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-inmunologicas">

    <!-- ===== Familia: Infección por VIH / SIDA (1) ===== -->
    <div class="familia" data-familia-id="fam-vih" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-vih-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-vih-block', this)">+</button>
        Infección por VIH / SIDA<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-vih-block">

        <!-- B21.x — Enfermedad por VIH que resulta en enfermedades infecciosas y parasitarias -->
        <div class="subcategoria-header banner-vih">B21 — Enfermedad por VIH que resulta en enfermedades infecciosas y parasitarias</div>
        <div class="patologia-item"><input type="checkbox" id="B210" value="B21.0"><label for="B210"><strong>B21.0 — VIH con candidiasis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B211" value="B21.1"><label for="B211"><strong>B21.1 — VIH con otras micosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B212" value="B21.2"><label for="B212"><strong>B21.2 — VIH con enfermedades por otros agentes bacterianos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B213" value="B21.3"><label for="B213"><strong>B21.3 — VIH con otras infecciones víricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B217" value="B21.7"><label for="B217"><strong>B21.7 — VIH con múltiples infecciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B218" value="B21.8"><label for="B218"><strong>B21.8 — VIH con otras enfermedades infecciosas y parasitarias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B219" value="B21.9"><label for="B219"><strong>B21.9 — VIH con enfermedad infecciosa o parasitaria no especificada</strong></label></div>

        <!-- B22.x — Enfermedad por VIH con manifestaciones definitorias de SIDA -->
        <div class="subcategoria-header banner-vih">B22 — Enfermedad por VIH con manifestaciones definitorias de SIDA</div>
        <div class="patologia-item"><input type="checkbox" id="B220" value="B22.0"><label for="B220"><strong>B22.0 — Encefalopatía por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B221" value="B22.1"><label for="B221"><strong>B22.1 — Neumonía intersticial linfoide debida a VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B222" value="B22.2"><label for="B222"><strong>B22.2 — Caquexia por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B227" value="B22.7"><label for="B227"><strong>B22.7 — Otras manifestaciones definitorias de SIDA</strong></label></div>

        <!-- B23.x — Otras afecciones por VIH -->
        <div class="subcategoria-header banner-vih">B23 — Otras afecciones por VIH</div>
        <div class="patologia-item"><input type="checkbox" id="B230" value="B23.0"><label for="B230"><strong>B23.0 — Síndrome agudo de infección por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B231" value="B23.1"><label for="B231"><strong>B23.1 — VIH con linfadenopatía (generalizada) persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B232" value="B23.2"><label for="B232"><strong>B23.2 — VIH con (presencia de) neoplasia maligna</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="B238" value="B23.8"><label for="B238"><strong>B23.8 — Otras afecciones especificadas de VIH</strong></label></div>

        <!-- B24 — Enfermedad por VIH no especificada -->
        <div class="subcategoria-header">B24 — Enfermedad por VIH no especificada</div>
        <div class="patologia-item"><input type="checkbox" id="B24" value="B24"><label for="B24"><strong>B24 — Enfermedad por VIH no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Lupus (1) ===== -->
    <div class="familia" data-familia-id="fam-lupus" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-lupus-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-lupus-block', this)">+</button>
        Lupus<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-lupus-block">

        <!-- L93.x — Lupus eritematoso localizado (cutáneo) -->
        <div class="subcategoria-header banner-lupus">L93 — Lupus eritematoso localizado (cutáneo)</div>
        <div class="patologia-item"><input type="checkbox" id="L930" value="L93.0"><label for="L930"><strong>L93.0 — Lupus eritematoso discoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="L931" value="L93.1"><label for="L931"><strong>L93.1 — Lupus eritematoso subagudo cutáneo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="L932" value="L93.2"><label for="L932"><strong>L93.2 — Otros lupus eritematosos cutáneos y no especificado</strong></label></div>

        <!-- M32.x — Lupus eritematoso sistémico -->
        <div class="subcategoria-header banner-lupus">M32 — Lupus eritematoso sistémico</div>
        <div class="patologia-item"><input type="checkbox" id="M320" value="M32.0"><label for="M320"><strong>M32.0 — Lupus eritematoso sistémico inducido por fármacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M321" value="M32.1"><label for="M321"><strong>M32.1 — Lupus eritematoso sistémico con compromiso de otros órganos y sistemas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M328" value="M32.8"><label for="M328"><strong>M32.8 — Otros lupus eritematosos sistémicos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="M329" value="M32.9"><label for="M329"><strong>M32.9 — Lupus eritematoso sistémico, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Tuberculosis (1) ===== -->
    <div class="familia" data-familia-id="fam-tuberculosis" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tuberculosis-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tuberculosis-block', this)">+</button>
        Tuberculosis<span class="badge-puntos">(1)
      </div>

      <div class="familia-content collapsed" id="fam-tuberculosis-block">

        <!-- A15.x — Tuberculosis respiratoria, bacteriológicamente confirmada -->
        <div class="subcategoria-header banner-vih">A15 — Tuberculosis respiratoria, confirmada</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A150" name="patologia[]" value="A15.0" data-points="1"><label for="A150"><strong>A15.0 — Tuberculosis pulmonar con baciloscopia positiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A151" name="patologia[]" value="A15.1" data-points="1"><label for="A151"><strong>A15.1 — Tuberculosis pulmonar con cultivo positivo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A152" name="patologia[]" value="A15.2" data-points="1"><label for="A152"><strong>A15.2 — Tuberculosis pulmonar confirmada histológicamente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A153" name="patologia[]" value="A15.3" data-points="1"><label for="A153"><strong>A15.3 — Tuberculosis pulmonar confirmada por otros medios</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A154" name="patologia[]" value="A15.4" data-points="1"><label for="A154"><strong>A15.4 — Tuberculosis de ganglios intratorácicos confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A155" name="patologia[]" value="A15.5" data-points="1"><label for="A155"><strong>A15.5 — Tuberculosis de laringe, tráquea o bronquios confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A156" name="patologia[]" value="A15.6" data-points="1"><label for="A156"><strong>A15.6 — Tuberculosis pleural confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A157" name="patologia[]" value="A15.7" data-points="1"><label for="A157"><strong>A15.7 — Tuberculosis primaria confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A158" name="patologia[]" value="A15.8" data-points="1"><label for="A158"><strong>A15.8 — Otras tuberculosis respiratorias confirmadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A159" name="patologia[]" value="A15.9" data-points="1"><label for="A159"><strong>A15.9 — Tuberculosis respiratoria no especificada confirmada</strong></label></div>

        <!-- A17.x — Tuberculosis del sistema nervioso -->
        <div class="subcategoria-header banner-vih">A17 — Tuberculosis del sistema nervioso</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A170" name="patologia[]" value="A17.0" data-points="1"><label for="A170"><strong>A17.0 — Meningitis tuberculosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A171" name="patologia[]" value="A17.1" data-points="1"><label for="A171"><strong>A17.1 — Tuberculoma meníngeo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A178" name="patologia[]" value="A17.8" data-points="1"><label for="A178"><strong>A17.8 — Otras tuberculosis del sistema nervioso</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A179" name="patologia[]" value="A17.9" data-points="1"><label for="A179"><strong>A17.9 — Tuberculosis del sistema nervioso no especificada</strong></label></div>

        <!-- A18.x — Tuberculosis de otros órganos -->
        <div class="subcategoria-header banner-vih">A18 — Tuberculosis de otros órganos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A180" name="patologia[]" value="A18.0" data-points="1"><label for="A180"><strong>A18.0 — Tuberculosis de huesos y articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A181" name="patologia[]" value="A18.1" data-points="1"><label for="A181"><strong>A18.1 — Tuberculosis genitourinaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A182" name="patologia[]" value="A18.2" data-points="1"><label for="A182"><strong>A18.2 — Tuberculosis del intestino, peritoneo y ganglios mesentéricos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A183" name="patologia[]" value="A18.3" data-points="1"><label for="A183"><strong>A18.3 — Tuberculosis de piel y tejido celular subcutáneo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A184" name="patologia[]" value="A18.4" data-points="1"><label for="A184"><strong>A18.4 — Tuberculosis de ojos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A185" name="patologia[]" value="A18.5" data-points="1"><label for="A185"><strong>A18.5 — Tuberculosis de oído</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A186" name="patologia[]" value="A18.6" data-points="1"><label for="A186"><strong>A18.6 — Tuberculosis de glándulas suprarrenales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A187" name="patologia[]" value="A18.7" data-points="1"><label for="A187"><strong>A18.7 — Tuberculosis de hígado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A188" name="patologia[]" value="A18.8" data-points="1"><label for="A188"><strong>A18.8 — Tuberculosis de otros órganos especificados</strong></label></div>

        <!-- A19.x — Tuberculosis miliar -->
        <div class="subcategoria-header banner-vih">A19 — Tuberculosis miliar</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A190" name="patologia[]" value="A19.0" data-points="1"><label for="A190"><strong>A19.0 — Tuberculosis miliar aguda de localización única</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A191" name="patologia[]" value="A19.1" data-points="1"><label for="A191"><strong>A19.1 — Tuberculosis miliar aguda de localizaciones múltiples</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A192" name="patologia[]" value="A19.2" data-points="1"><label for="A192"><strong>A19.2 — Tuberculosis miliar aguda, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A198" name="patologia[]" value="A19.8" data-points="1"><label for="A198"><strong>A19.8 — Otras tuberculosis miliares especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A199" name="patologia[]" value="A19.9" data-points="1"><label for="A199"><strong>A19.9 — Tuberculosis miliar no especificada</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 14: NEOPLASIAS / CÁNCER ===================== -->
<div class="categoria-seccion" id="cat-neoplasias" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-neoplasias')">
    <h4>🧪 MALIGNIDAD / NEOPLASIA / TUMOR MALIGNO / CÁNCER
      <span class="categoria-badge" id="badge-neoplasias">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-neoplasias">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-neoplasias">

    <!-- ===== Familia: Tumores malignos (1) ===== -->
    <div class="familia" data-familia-id="fam-neoplasias" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-neoplasias-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-neoplasias-block', this)">+</button>
        Tumores malignos / cáncer<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-neoplasias-block">

        <!-- C00–C97 — Neoplasias malignas -->
        <div class="subcategoria-header banner-neoplasias">C00 – C97 — Neoplasias malignas (toda la letra C)</div>
        <div class="patologia-item"><input type="checkbox" id="C00-C97" value="C00-C97"><label for="C00-C97"><strong>C00 – C97 — Todas las neoplasias malignas (órganos, tejidos y sistemas)</strong></label></div>

        <!-- D00–D48 — Tumores in situ, benignos e incertos -->
        <div class="subcategoria-header banner-neoplasias">D00 – D48 — Tumores in situ, benignos e incertos (hasta D48.9)</div>
        <div class="patologia-item"><input type="checkbox" id="D00-D48" value="D00-D48"><label for="D00-D48"><strong>D00 – D48 — Tumores in situ, benignos e incertos (incluye D48.0 – D48.9)</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 15: MALTRATO / VIOLENCIA / ABUSO / SUICIDIO ===================== -->
<div class="categoria-seccion" id="cat-maltrato" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-maltrato')">
    <h4>🚨 MALTRATO / VIOLENCIA / ABUSO / SUICIDIO
      <span class="categoria-badge" id="badge-maltrato">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-maltrato">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-maltrato">

    <!-- ===== Familia: Maltrato físico / psicológico / VIF / abuso sexual / suicidio (1) ===== -->
    <div class="familia" data-familia-id="fam-maltrato" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-maltrato-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-maltrato-block', this)">+</button>
        Maltrato físico / psicológico / VIF / abuso sexual / suicidio<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-maltrato-block">

        <!-- T74.x — Síndromes de maltrato -->
        <div class="subcategoria-header banner-maltrato">T74 — Síndromes de maltrato</div>
        <div class="patologia-item"><input type="checkbox" id="T740" value="T74.0"><label for="T740"><strong>T74.0 — Síndrome de maltrato por negligencia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="T741" value="T74.1"><label for="T741"><strong>T74.1 — Síndrome de maltrato físico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="T742" value="T74.2"><label for="T742"><strong>T74.2 — Síndrome de maltrato sexual</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="T743" value="T74.3"><label for="T743"><strong>T74.3 — Síndrome de maltrato psicológico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="T748" value="T74.8"><label for="T748"><strong>T74.8 — Otros síndromes de maltrato</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="T749" value="T74.9"><label for="T749"><strong>T74.9 — Síndrome de maltrato no especificado</strong></label></div>

        <!-- Y07.x — Perpetrador de maltrato -->
        <div class="subcategoria-header banner-maltrato">Y07 — Perpetrador de maltrato</div>
        <div class="patologia-item"><input type="checkbox" id="Y070" value="Y07.0"><label for="Y070"><strong>Y07.0 — Perpetrador: cónyuge o pareja</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Y071" value="Y07.1"><label for="Y071"><strong>Y07.1 — Perpetrador: padre o madre</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Y072" value="Y07.2"><label for="Y072"><strong>Y07.2 — Perpetrador: otro miembro de la familia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Y073" value="Y07.3"><label for="Y073"><strong>Y07.3 — Perpetrador: conocido</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Y078" value="Y07.8"><label for="Y078"><strong>Y07.8 — Perpetrador: otras personas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="Y079" value="Y07.9"><label for="Y079"><strong>Y07.9 — Perpetrador: no especificado</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGORÍA 16: TRASTORNOS DE LA COAGULACIÓN ===================== -->
<div class="categoria-seccion" id="cat-coagulacion" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-coagulacion')">
    <h4>🩸 TRASTORNOS DE LA COAGULACIÓN
      <span class="categoria-badge" id="badge-coagulacion">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-coagulacion">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-coagulacion">

    <!-- ===== Familia: Trastornos de la coagulación (1) ===== -->
    <div class="familia" data-familia-id="fam-coagulacion" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-coagulacion-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-coagulacion-block', this)">+</button>
        Trastornos de la coagulación<span class="badge-puntos">(1)
      </div>
      <div class="familia-content collapsed" id="fam-coagulacion-block">

        <!-- D68.x — Otros defectos de la coagulación -->
        <div class="subcategoria-header">D68 — Otros defectos de la coagulación</div>
        <div class="patologia-item"><input type="checkbox" id="D680" value="D68.0"><label for="D680"><strong>D68.0 — Deficiencia hereditaria del factor VIII</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D681" value="D68.1"><label for="D681"><strong>D68.1 — Deficiencia hereditaria del factor IX</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D682" value="D68.2"><label for="D682"><strong>D68.2 — Deficiencia hereditaria de otros factores de la coagulación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D684" value="D68.4"><label for="D684"><strong>D68.4 — Deficiencia adquirida de factores de la coagulación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D688" value="D68.8"><label for="D688"><strong>D68.8 — Otros defectos especificados de la coagulación</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D689" value="D68.9"><label for="D689"><strong>D68.9 — Defecto de la coagulación, no especificado</strong></label></div>

        <!-- D69.x — Púrpura y otras afecciones hemorrágicas -->
        <div class="subcategoria-header">D69 — Púrpura y otras afecciones hemorrágicas</div>
        <div class="patologia-item"><input type="checkbox" id="D691" value="D69.1"><label for="D691"><strong>D69.1 — Púrpura alérgica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D692" value="D69.2"><label for="D692"><strong>D69.2 — Púrpura trombocitopénica no primaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D693" value="D69.3"><label for="D693"><strong>D69.3 — Púrpura trombocitopénica idiopática</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D694" value="D69.4"><label for="D694"><strong>D69.4 — Otras púrpuras trombocitopénicas primarias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D696" value="D69.6"><label for="D696"><strong>D69.6 — Trombocitopenia secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D698" value="D69.8"><label for="D698"><strong>D69.8 — Otras púrpuras especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D699" value="D69.9"><label for="D699"><strong>D69.9 — Púrpura, no especificada</strong></label></div>

        <!-- D75.x — Otras enfermedades de la sangre -->
        <div class="subcategoria-header">D75 — Otras enfermedades de la sangre y de los órganos hematopoyéticos</div>
        <div class="patologia-item"><input type="checkbox" id="D750" value="D75.0"><label for="D750"><strong>D75.0 — Eritrocitosis secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D758" value="D75.8"><label for="D758"><strong>D75.8 — Otras enfermedades especificadas de la sangre</strong></label></div>
        <div class="patologia-item"><input type="checkbox" id="D759" value="D75.9"><label for="D759"><strong>D75.9 — Enfermedad de la sangre, no especificada</strong></label></div>

        <!-- D77 — Otros trastornos de la sangre -->
        <div class="subcategoria-header">D77 — Otros trastornos de la sangre</div>
        <div class="patologia-item"><input type="checkbox" id="D77" value="D77"><label for="D77"><strong>D77 — Otros trastornos de la sangre, no clasificados en otra parte</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

<!-- ===================== CATEGORÍA 17: ALTERACIONES DE LA CONTINUIDAD DE LA PIEL ===================== -->
<div class="categoria-seccion" id="cat-piel" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-piel')">
    <h4>🩹 ALTERACIONES DE LA CONTINUIDAD DE LA PIEL
      <span class="categoria-badge" id="badge-piel">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-piel">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-piel">

    <!-- ===== Familia: Úlcera crónica de la piel (1) ===== -->
    <div class="familia" data-familia-id="fam-ulcera-piel" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-ulcera-piel-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ulcera-piel-block', this)">+</button>
        Úlcera crónica de la piel<span class="badge-puntos">(1)
      </div>

      <div class="familia-content collapsed" id="fam-ulcera-piel-block">
        
        <!-- I83.x — Várices de miembros inferiores con úlcera -->
        <div class="subcategoria-header banner-sangre">I83 — Várices de miembros inferiores con úlcera</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I830" name="patologia[]" value="I83.0" data-points="1">
          <label for="I830"><strong>I83.0 — Várices de miembros inferiores con úlcera</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I831" name="patologia[]" value="I83.1" data-points="1">
          <label for="I831"><strong>I83.1 — Várices de miembros inferiores con inflamación</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I832" name="patologia[]" value="I83.2" data-points="1">
          <label for="I832"><strong>I83.2 — Várices de miembros inferiores con úlcera e inflamación</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I839" name="patologia[]" value="I83.9" data-points="1">
          <label for="I839"><strong>I83.9 — Várices de miembros inferiores, no especificadas</strong></label>
        </div>

        <!-- L97 — Úlcera de miembros inferiores -->
        <div class="subcategoria-header banner-sangre">L97 — Úlcera de miembros inferiores</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="L97" name="patologia[]" value="L97" data-points="1">
          <label for="L97"><strong>L97 — Úlcera de miembros inferiores, no clasificada en otra parte</strong></label>
        </div>

        <!-- L98.4 — Úlcera crónica de la piel, no clasificada en otra parte -->
        <div class="subcategoria-header banner-sangre">L98.4 — Úlcera crónica de la piel</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="L984" name="patologia[]" value="L98.4" data-points="1">
          <label for="L984"><strong>L98.4 — Úlcera crónica de la piel, no clasificada en otra parte</strong></label>
        </div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

</div> <!-- /patologias-ecicep-container -->
</div> <!-- /patologias-main-container (contenedor colapsable) -->
<!-- === CSS mínimo para colapsar/expandir === -->
<style>
    /* === ESTILOS PARA CONTENEDOR COLAPSABLE DE PATOLOGÍAS === */
    #patologias-main-container {
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }
    
    #patologias-main-container[style*="display: block"] {
        opacity: 1;
        transform: translateY(0);
    }
    
    #btn-toggle-patologias {
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #btn-toggle-patologias:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* --- Moderno para cuadro de patologías resumen --- */
    .patologias-resumen {
      background: #f4f8fb;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(13,110,253,0.07);
      border: 1.5px solid #e0e7ef;
      padding: 18px 20px 12px 20px;
      margin-bottom: 18px;
    }
    .patologias-titulo {
      font-size: 1.08em;
      font-weight: 700;
      color: #0d6efd;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .pat-badges {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .resumen-categoria {
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .resumen-familia {
      margin: 6px 0 6px 12px;
    }
    .resumen-familia > span {
      font-size: 1em;
      font-weight: 600;
      color: #0d6efd;
      display: inline-block;
      margin-bottom: 2px;
    }
    .resumen-patologia {
      margin-left: 18px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .resumen-patologia input[type="checkbox"] {
      accent-color: #0d6efd;
      width: 16px;
      height: 16px;
    }
    .pat-empty {
      color: #6c757d;
      font-style: italic;
    }

    /* --- Botones de expansión de categorías modernos --- */
    .categoria-toggle {
      background: #e7f0fa;
      color: #0d6efd;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.3em;
      font-weight: bold;
      box-shadow: 0 1px 4px rgba(13,110,253,0.08);
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      cursor: pointer;
      margin-left: 10px;
    }
    .categoria-toggle:hover {
      background: #0d6efd;
      color: #fff;
      box-shadow: 0 2px 8px rgba(13,110,253,0.13);
    }
    .categoria-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      padding: 12px 16px;
      margin: 4px 0;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      border: 1px solid #dee2e6;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      user-select: none;
    }
    .categoria-header:hover {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-color: #0d6efd;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(13,110,253,0.15);
    }
    .categoria-header h4 {
      margin: 0;
    }
  .collapsed { display: none; }
  .categoria-content:not(.collapsed),
  .familia-content:not(.collapsed) { display:block; }
</style>

<!-- === JS de toggles y utilidades === -->
<script>
  function toggleCategoria(contentId) {
    const content = document.getElementById(contentId);
    if (!content) return;
    content.classList.toggle('collapsed');

    // Cambiar el signo del botón
    const wrap = content.closest('.categoria-seccion');
    const btn = wrap?.querySelector('.categoria-toggle');
    if (btn) btn.textContent = content.classList.contains('collapsed') ? '+' : '−';
  }

  function toggleFamilia(blockId, familia_header) {
    const block = document.getElementById(blockId);
    if (!block) return;
    block.classList.toggle('collapsed');
    
    // Cambiar el signo del botón
    const btn = familia_header.querySelector('.familia-toggle');
    if (btn) btn.textContent = block.classList.contains('collapsed') ? '+' : '−';
  }

  function toggleCollapse(blockId, btn) {
    const block = document.getElementById(blockId);
    if (!block) return;
    block.classList.toggle('collapsed');
    if (btn) btn.textContent = block.classList.contains('collapsed') ? '+' : '−';
  }

  // === FUNCIÓN PARA COLAPSAR/EXPANDIR TODO EL CONTENEDOR DE PATOLOGÍAS ===
  function togglePatologiasContainer() {
    const container = document.getElementById('patologias-main-container');
    const button = document.getElementById('btn-toggle-patologias');
    
    if (!container || !button) return;
    
    const isHidden = container.style.display === 'none';
    
    if (isHidden) {
      // Mostrar patologías
      container.style.display = 'block';
      button.innerHTML = '🙈 Ocultar Patologías';
      button.style.background = '#ef4444';
      // Añadir efecto de deslizamiento
      setTimeout(() => {
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
      }, 10);
    } else {
      // Ocultar patologías
      container.style.opacity = '0';
      container.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        container.style.display = 'none';
      }, 200);
      button.innerHTML = '👁️ Mostrar Patologías';
      button.style.background = '#6366f1';
    }
  }

  // Botones globales (versión UI familias/categorías)
  function expandirTodasFamilias() {
    document.querySelectorAll('.categoria-content.collapsed').forEach(el => el.classList.remove('collapsed'));
    document.querySelectorAll('.familia-content.collapsed').forEach(el => el.classList.remove('collapsed'));
    document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '−');
    document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '−');
  }

  function contraerTodasFamilias() {
    document.querySelectorAll('.categoria-content:not(.collapsed)').forEach(el => el.classList.add('collapsed'));
    document.querySelectorAll('.familia-content:not(.collapsed)').forEach(el => el.classList.add('collapsed'));
    document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '+');
    document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '+');
  }

  function expandirSoloSeleccionadasFamilias() {
    // Colapsa todo
    contraerTodasFamilias();
    // Abre familias con selección y sus categorías padre
    const seleccionadas = document.querySelectorAll('.familia input[type="checkbox"]:checked');
    const vistas = new Set();
    seleccionadas.forEach(chk => {
      const familia = chk.closest('.familia');
      const famContent = familia?.querySelector('.familia-content');
      if (famContent && famContent.classList.contains('collapsed')) {
        famContent.classList.remove('collapsed');
        const btn = familia.querySelector('.familia-toggle');
        if (btn) btn.textContent = '−';
      }
      const catContent = chk.closest('.categoria-content');
      if (catContent && catContent.classList.contains('collapsed')) {
        catContent.classList.remove('collapsed');
        const catBtn = catContent.closest('.categoria-seccion')?.querySelector('.categoria-toggle');
        if (catBtn) catBtn.textContent = '−';
      }
      vistas.add(catContent?.id);
    });
  }

  // Badges por categoría (cuenta checkboxes dentro)
  function actualizarBadgesCategorias() {
    document.querySelectorAll('.categoria-seccion').forEach(sec => {
      const badge = sec.querySelector('.categoria-badge');
      const content = sec.querySelector('.categoria-content');
      if (!badge || !content) return;
      const count = content.querySelectorAll('input[type="checkbox"].patologia-checkbox:checked').length;
      badge.textContent = String(count);
    });
  }

  // Listeners
  document.addEventListener('change', e => {
    if (e.target && e.target.matches('input[type="checkbox"].patologia-checkbox')) {
      actualizarBadgesCategorias();
      // Manejar selección aditiva de patologías
      manejarSeleccionPatologia(e.target);
    }
  });

  // Al cargar, inicializa los badges (todas las categorías colapsadas por defecto)
  // document.addEventListener('DOMContentLoaded', () => {
  //   actualizarBadgesCategorias();
  // });
</script>
                <small>Selecciona las patologías que correspondan.</small>
                <hr>
                <label for="fecha_acuerdo">Fecha del acuerdo:</label>
                <input type="date" name="fecha_acuerdo" id="fecha_acuerdo" style="margin-bottom:8px;width:200px;"
                    value="{% if acuerdos and acuerdos|length > 0 and acuerdos[0]["fecha_creacion"] %}{{ acuerdos[0]["fecha_creacion"].strftime('%Y-%m-%d') }}{% else %}{{ '' }}{% endif %}">
                {% if acuerdos and acuerdos|length > 0 and acuerdos[0]["fecha_creacion"] %}
                <div style="margin-bottom: 4px;">
                    <span style="color:#0d6efd;font-weight:bold;">Fecha de creación del acuerdo actual:</span>
                    <span style="color:#222;">{{ acuerdos[0]["fecha_creacion"].strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                {% endif %}
                <label for="acuerdos">Acuerdos (puedes modificar o agregar):</label>
                <textarea name="nuevo_acuerdo" id="nuevo_acuerdo" rows="3" style="width:100%" placeholder="Escribe un nuevo acuerdo y presiona 'Agregar Acuerdo' o 'Guardar Usuario y Control' para guardar."></textarea>
                <div style="display: flex; gap: 8px; margin: 6px 0 12px 0; flex-wrap: wrap;">
                    <button type="submit" name="agregar_acuerdo" value="1" style="font-size:13px; background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                        ➕ Agregar Acuerdo
                    </button>
                    <button type="button" onclick="guardarAcuerdosIndependiente()" style="font-size:13px; background: #198754; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;" title="Guardar solo los acuerdos y cumplimiento">
                        💾 Guardar Acuerdos
                    </button>
                </div>
                <label for="cumplimiento">Cumplimiento (opcional): <span id="cumplimiento-suggested" style="color: #6c757d; display: none;">💡</span></label>
                <select name="cumplimiento" id="cumplimiento" style="width:100%">
                    <option value="" selected disabled>Seleccionar opción de cumplimiento</option>
                    <option value="cumple">Cumple</option>
                    <option value="cumple parcialmente">Cumple parcialmente</option>
                    <option value="no cumple">No cumple</option>
                    <option value="inicio de acuerdos consensuados">Inicio de acuerdos consensuados</option>
                </select>
                <small id="cumplimiento-help" style="color: #666; display: none; margin-top: 4px;">Se recomienda seleccionar el cumplimiento cuando hay acuerdos definidos (opcional).</small>
                
                <script>
                // Cambia el color del select según la opción elegida
                function setCumplimientoColor() {
                    var sel = document.getElementById('cumplimiento');
                    var color = '';
                    switch(sel.value) {
                        case 'cumple': color = '#4caf50'; break; // verde
                        case 'cumple parcialmente': color = '#ffc107'; break; // amarillo
                        case 'no cumple': color = '#f44336'; break; // rojo
                        default: color = '';
                    }
                    sel.style.backgroundColor = color;
                    sel.style.color = (sel.value === 'cumple parcialmente') ? '#222' : '#fff';
                }

                // Validación condicional de cumplimiento basado en acuerdos (ahora opcional)
                function validarCumplimientoRequerido() {
                    // PROTECCIÓN PRIORITARIA: No ejecutar si hay errores del servidor
                    if (window.HAS_ERROR) {
                        console.log('🛡️ Validación de cumplimiento omitida debido a error del servidor');
                        return;
                    }
                    
                    var acuerdosTextarea = document.getElementById('acuerdos');
                    var cumplimientoSelect = document.getElementById('cumplimiento');
                    var suggestedIndicator = document.getElementById('cumplimiento-suggested');
                    var helpText = document.getElementById('cumplimiento-help');
                    
                    // PROTECCIÓN: Verificar que los elementos existen
                    if (!acuerdosTextarea || !cumplimientoSelect) {
                        console.log('⚠️ Elementos de cumplimiento no encontrados, omitiendo validación');
                        return;
                    }
                    
                    var tieneAcuerdos = acuerdosTextarea.value.trim().length > 0;
                    
                    if (tieneAcuerdos) {
                        // Ya no es obligatorio, pero se sugiere
                        cumplimientoSelect.removeAttribute('required');
                        suggestedIndicator.style.display = 'inline';
                        helpText.style.display = 'block';
                        helpText.textContent = 'Se recomienda seleccionar el cumplimiento cuando hay acuerdos definidos.';
                        cumplimientoSelect.style.borderColor = '#6c757d';
                    } else {
                        cumplimientoSelect.removeAttribute('required');
                        suggestedIndicator.style.display = 'none';
                        helpText.style.display = 'none';
                        cumplimientoSelect.style.borderColor = '';
                        // Limpiar selección si no hay acuerdos (SOLO SI NO HAY ERRORES)
                        if (!window.HAS_ERROR) {
                            cumplimientoSelect.value = '';
                        }
                        setCumplimientoColor();
                    }
                }

                document.addEventListener('DOMContentLoaded', function() {
                    var sel = document.getElementById('cumplimiento');
                    var acuerdosTextarea = document.getElementById('acuerdos');
                    
                    // Solo ejecutar si los elementos existen
                    if (sel && acuerdosTextarea) {
                        setCumplimientoColor();
                        validarCumplimientoRequerido();
                        
                        sel.addEventListener('change', setCumplimientoColor);
                        acuerdosTextarea.addEventListener('input', validarCumplimientoRequerido);
                        acuerdosTextarea.addEventListener('blur', validarCumplimientoRequerido);
                        
                        // Validación adicional en el envío del formulario
                        var form = document.querySelector('form');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                // Verificar si es un submit de examen (botón guardar_examen)
                                var submitButton = document.activeElement;
                                var esGuardarExamen = submitButton && submitButton.name === 'guardar_examen';
                                
                                // Si es guardar examen, solo validar que hay un RUN
                                if (esGuardarExamen) {
                                    var runInput = document.getElementById('run');
                                    if (!runInput || !runInput.value.trim()) {
                                        e.preventDefault();
                                        mostrarErrorAmigable('requerido', 'run', 
                                            'Debe ingresar un RUN válido antes de guardar un examen.');
                                        return false;
                                    }
                                    
                                    // Validar RUN para exámenes
                                    var runValue = runInput.value.trim();
                                    var runLimpio = runValue.replace(/[^0-9kK]/gi, '');
                                    
                                    if (runLimpio.length >= 8) {
                                        var runFormateado = runLimpio.slice(0, -1) + '-' + runLimpio.slice(-1);
                                        if (!dvValido(runFormateado)) {
                                            e.preventDefault();
                                            mostrarErrorAmigable('run', 'run', 
                                                'El RUN ingresado no es válido según el algoritmo chileno. Por favor, verifique el número y el dígito verificador.');
                                            return false;
                                        }
                                    }
                                    
                                    // Para exámenes, no validar otros campos obligatorios
                                    return true;
                                }
                                
                                // Para otros submit (guardar usuario), validar campos requeridos básicos
                                var camposRequeridos = [
                                    {id: 'run', nombre: 'RUN'},
                                    {id: 'nombre', nombre: 'Nombre'},
                                    {id: 'fecha_nacimiento', nombre: 'Fecha de nacimiento'},
                                    {id: 'sexo', nombre: 'Sexo'}
                                ];
                                
                                for (var i = 0; i < camposRequeridos.length; i++) {
                                    var campo = document.getElementById(camposRequeridos[i].id);
                                    if (!campo || !campo.value.trim()) {
                                        e.preventDefault();
                                        mostrarErrorAmigable('requerido', camposRequeridos[i].id, 
                                            'El campo "' + camposRequeridos[i].nombre + '" es obligatorio.');
                                        return false;
                                    }
                                }
                                
                                // 2. Validar RUN antes de enviar
                                var runInput = document.getElementById('run');
                                if (runInput && runInput.value.trim()) {
                                    var runValue = runInput.value.trim();
                                    var runLimpio = runValue.replace(/[^0-9kK]/gi, '');
                                    
                                    if (runLimpio.length >= 8) {
                                        var runFormateado = runLimpio.slice(0, -1) + '-' + runLimpio.slice(-1);
                                        if (!dvValido(runFormateado)) {
                                            e.preventDefault();
                                            mostrarErrorAmigable('run', 'run', 
                                                'El RUN ingresado no es válido según el algoritmo chileno. Por favor, verifique el número y el dígito verificador.');
                                            return false;
                                        }
                                    }
                                }
                                
                                // 3. Validar edad antes de enviar
                                var fechaNacimiento = document.getElementById('fecha_nacimiento');
                                if (fechaNacimiento && fechaNacimiento.value.trim()) {
                                    var edad = calcularEdadDesde(fechaNacimiento.value);
                                    var edadNum = parseInt(edad, 10);
                                    if (!isNaN(edadNum)) {
                                        if (edadNum < 15) {
                                            e.preventDefault();
                                            mostrarErrorAmigable('fecha', 'fecha_nacimiento', 
                                                'ECICEP requiere usuarios de 15 años o más. Edad actual: ' + edadNum + ' años. Por favor, verifica la fecha de nacimiento.');
                                            return false;
                                        } else if (edadNum > 112) {
                                            e.preventDefault();
                                            mostrarErrorAmigable('fecha', 'fecha_nacimiento', 
                                                'La edad calculada es muy alta (' + edadNum + ' años). Por favor, verifica que la fecha de nacimiento sea correcta.');
                                            return false;
                                        }
                                    }
                                }
                                
                                var acuerdos = document.getElementById('acuerdos');
                                var cumplimiento = document.getElementById('cumplimiento');
                                
                                if (acuerdos && cumplimiento) {
                                    // Ya no hay validación obligatoria - se permite enviar sin cumplimiento
                                    // Comentario: La validación del cumplimiento ahora es opcional
                                }

                                // Asegurar que TODAS las patologías seleccionadas se envíen como patologia[]
                                try {
                                    const seleccionadas = document.querySelectorAll('input.patologia-checkbox:checked');
                                    seleccionadas.forEach(cb => {
                                        if (cb.name !== 'patologia[]') {
                                            const hidden = document.createElement('input');
                                            hidden.type = 'hidden';
                                            hidden.name = 'patologia[]';
                                            hidden.value = cb.value;
                                            form.appendChild(hidden);
                                        }
                                    });
                                } catch (err) {
                                    console.warn('No se pudieron preparar todas las patologías para el envío:', err);
                                }
                            });
                        }
                    } else {
                        console.log('⚠️ Elementos cumplimiento/acuerdos no encontrados - omitiendo inicialización');
                    }
                });
                </script>
                <label for="observaciones">Observaciones:</label>
                <textarea name="observaciones" id="observaciones" rows="2" style="width:100%"></textarea>
                <small>Historial de acuerdos previos:</small>
                                <div style="max-height:120px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:6px; background:#f8f9fa; padding:8px; margin-bottom:8px;">
                                    <table id="tabla-acuerdos" style="width:100%; font-size:12px;">
                                        <thead>
                                            <tr style="background:#e9ecef;">
                                                <th style="padding:2px 6px;">Fecha</th>
                                                <th style="padding:2px 6px;">Acuerdo</th>
                                                <th style="padding:2px 6px;">Cumplimiento</th>
                                                <th style="padding:2px 6px;">Obs.</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ac in acuerdos %}
                                                <tr>
                                                    <td style="padding:2px 6px;">{{ ac.fecha_creacion.strftime('%Y-%m-%d %H:%M') if ac.fecha_creacion else '' }}</td>
                                                    <td style="padding:2px 6px;">{{ ac.acuerdos|e }}</td>
                                                    <td style="padding:2px 6px;">{{ ac.cumplimiento }}</td>
                                                    <td style="padding:2px 6px;">{{ ac.observaciones }}</td>
                                                </tr>
                                            {% else %}
                                                <tr><td colspan="4" style="text-align:center; color:#888;">No hay acuerdos previos.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
            </fieldset>
            
            <fieldset>
                                <legend>Control inicial</legend>
                                <label>Fecha control: <input type="date" name="fecha" style="min-width:280px;max-width:350px;"></label>
                                <label>Profesional:
                                        <select name="profesional" id="profesional" style="min-width:220px;">
                                                <option value="">-- Seleccione profesional --</option>
                                                <option value="dupla">Dupla</option>
                                                <option value="enfermero">Enfermero</option>
                                                <option value="medico">Médico</option>
                                                <option value="nutricionista">Nutricionista</option>
                                                <option value="tens">TENS</option>
                                                <option value="matrona">Matrona</option>
                                                <option value="psicologo">Psicólogo</option>
                                                <option value="asistente social">Asistente Social</option>
                                                <option value="sala era">Sala Era</option>
                                                <option value="urgencias">Urgencias</option>
                                                <option value="dentista">Dentista</option>
                                                <option value="oftalmologo">Oftalmólogo</option>
                                                <option value="uapo">UAPO</option>
                                                <option value="medicina interna">Medicina Interna</option>
                                                <option value="nefrologo">Nefrólogo</option>
                                                <option value="telediabetes">Telediabetes</option>
                                                <option value="ginecologo">Ginecólogo</option>
                                                <option value="politaco">POLITACO</option>
                                                <option value="receta">Receta</option>
                                                <option value="cirujano">Cirujano</option>
                                                <option value="hosp chue">Hosp CHUE</option>
                                                <option value="h lebu">H Lebu</option>
                                                <option value="h arauco">H Arauco</option>
                                        </select>
                                </label>
                                <div class="campos-linea">
                                        <label>Peso: <input type="number" step="0.01" name="peso" style="width: 90px;"></label>
                                        <label>Talla (m): <input type="number" step="0.01" name="talla" placeholder="1.70" min="0.50" max="2.30" style="width: 90px;"></label>
                                        <label>P. Sistólica: <input type="number" name="presion_sistolica" style="width: 90px;"></label>
                                        <label>P. Diastólica: <input type="number" name="presion_diastolica" style="width: 95px;"></label>
                                        <label>HGT: <input type="number" step="0.01" name="hgt" style="width: 90px;"></label>
                                        <label>CC: <input type="number" step="0.01" name="cc" style="width: 90px;"></label>
                                        <label>HbA1c: <input type="number" step="0.01" name="hba1c" style="width: 90px;"></label>
                                </div>

                                <!-- Formulario de ingreso de exámenes -->
                                <hr>
                                <h4 style="margin-top:24px; color:#0d6efd;">Ingreso de Exámenes</h4>
                                <div id="form-examenes-container" style="background:#f8f9fa; border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:16px;">
                                                        <!-- Fila 1: Datos principales -->
                                                        <div style="display: grid; grid-template-columns: 180px 120px 170px 100px 120px 190px; gap: 12px; align-items: end; font-size:10px; margin-bottom:12px;">
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Fecha:</label>
                                                                <input type="date" name="examen_fecha" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">SO2%:</label>
                                                                <input type="number" step="0.01" name="so2_percent" min="0" max="100" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Flujom.:</label>
                                                                <input type="text" name="flujometria" maxlength="64" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Tos:</label>
                                                                <input type="checkbox" name="tos" style="margin-top:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Bacilo:</label>
                                                                <input type="checkbox" name="baciloscopia" style="margin-top:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Creat.:</label>
                                                                <input type="number" step="0.0001" name="creatinemia" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Fila 2: Perfil lipídico -->
                                                        <div style="display: grid; grid-template-columns: 170px 130px 130px 130px 120px 220px; gap: 12px; align-items: end; font-size:10px; margin-bottom:12px;">
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Col Total:</label>
                                                                <input type="number" step="0.01" name="col" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">HDL:</label>
                                                                <input type="number" step="0.01" name="hdl" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">LDL:</label>
                                                                <input type="number" step="0.01" name="ldl" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">TAG:</label>
                                                                <input type="number" step="0.01" name="tag" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Microalb:</label>
                                                                <input type="checkbox" name="microalbuminuria" style="margin-top:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Val.Microalb:</label>
                                                                <input type="number" step="0.0001" name="microalbuminuria_val" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Fila 3: Función renal, hormonas y notas -->
                                                        <div style="display: grid; grid-template-columns: 140px 150px 90px 140px 140px 300px 170px; gap: 12px; align-items: end; font-size:10px;">
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">VFG:</label>
                                                                <input type="number" step="0.01" name="vfg" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">RAC:</label>
                                                                <input type="number" step="0.0001" name="rac" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">RPR:</label>
                                                                <input type="checkbox" name="rpr" style="margin-top:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">TSH:</label>
                                                                <input type="number" step="0.0001" name="tsh" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">HbA1c:</label>
                                                                <input type="number" step="0.01" name="hba1c_examen" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Notas:</label>
                                                                <textarea name="notas" rows="2" style="width:100%; font-size:10px; padding:2px; resize:vertical;"></textarea>
                                                            </div>
                                                            <div>
                                                                <button type="submit" name="guardar_examen" value="1" style="width:100%; font-size:11px; padding:6px 2px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Guardar</button>
                                                            </div>
                                                        </div>
                                </div>

                                <!-- Tabla de exámenes guardados -->
                                <h5 style="margin-top:10px; color:#0d6efd;">Exámenes guardados</h5>
                                <div style="overflow-x:auto;">
                                    <table id="tabla-examenes" class="table table-bordered" style="width:100%; font-size:13px; border: 2px solid #333;">
                                        <thead style="background-color: #f8f9fa;">
                                            <tr>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center; white-space: nowrap;">Fecha del Examen</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">SO2 %</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Flujometría</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Tos</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Baciloscopia</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Creatininemia</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Col</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">HDL</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">LDL</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">TAG</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Microalb.</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Microalb. valor</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">VFG</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">RAC</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">RPR</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">TSH</th>
                                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">HbA1c</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ex in examenes %}
                                            <tr>
                                                <td style="border: 1px solid #333; padding: 8px; white-space: nowrap;">{{ ex.examen_fecha }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.so2_percent }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.flujometria }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.tos %}Sí{% else %}No{% endif %}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.baciloscopia %}Sí{% else %}No{% endif %}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.creatinemia %}{{ "%.2f"|format(ex.creatinemia|float) }}{% endif %}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.col }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;" class="{% if ex.hdl and usuario.sexo %}{% set sexo_norm = usuario.sexo|lower|trim %}{% if ( (sexo_norm in ['femenino','f','mujer'] and ex.hdl|float <= 50) or (sexo_norm in ['masculino','m','hombre','varón','varon'] and ex.hdl|float <= 40) ) %}abnormal-hdl{% endif %}{% endif %}">{{ ex.hdl }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.ldl }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.tag }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.microalbuminuria %}Sí{% else %}No{% endif %}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.microalbuminuria_val }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.vfg }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;" class="{% if ex.rac and ex.rac|float >= 300 %}abnormal{% endif %}">{% if ex.rac %}{{ "%.2f"|format(ex.rac|float) }}{% endif %}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.rpr %}Sí{% else %}No{% endif %}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.tsh }}</td>
                                                <td style="border: 1px solid #333; padding: 8px; text-align: center;" class="hba1c-valor" data-hba1c="{{ ex.hba1c }}" data-usuario-nacimiento="{% if usuario %}{{ usuario.fecha_nacimiento }}{% endif %}">{{ ex.hba1c }}</td>
                                            </tr>
                                            {% else %}
                                            <tr><td colspan="17" style="text-align:center; color:#888; border: 1px solid #333; padding: 15px;">No hay exámenes registrados para este usuario.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Botón de guardado independiente para controles -->
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">
                                    <button type="button" onclick="guardarControlIndependiente()" style="background: #198754; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;" title="Guardar solo los datos de control">
                                        💾 Guardar Control Únicamente
                                    </button>
                                </div>
            </fieldset>
            
            <div class="buttons-container">
                <button type="submit">Guardar Usuario y Control</button>
                <button type="button" class="btn-secondary" onclick="limpiarFormulario()">Limpiar Formulario</button>
                <button type="button" class="btn-secondary" onclick="window.location.href='/'">Cancelar</button>
            </div>
        </form>
    </div>

    <script>
        console.log('🎯 INICIO: Script del formulario cargando...');
        
        // ========= (1) Máscara RUN =========
        function formatearRun(run) {
            let v = run.replace(/[^0-9kK]/g, '').toUpperCase();
            if (v.length > 1) {
                const cuerpo = v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                const dv = v.slice(-1);
                return cuerpo + '-' + dv;
            } else {
                return v;
            }
        }

        // ========= (2) Normalizar para API (12345678-9) =========
        function normalizarRun(s) {
            s = (s || "").toUpperCase().replace(/[^0-9K]/g, '');
            if (s.length < 2) return s;
            return s.slice(0, -1) + '-' + s.slice(-1);
        }

        // ========= (3) Validador DV =========
        function dvValido(runNorm) {
            console.log('🔍 dvValido llamada con:', runNorm);
            
            const m = /^(\d{7,8})-([\dK])$/.exec(runNorm);
            if (!m) {
                console.log('❌ Formato no válido:', runNorm);
                return false;
            }
            
            const cuerpo = m[1], dv = m[2];
            console.log('🔍 Cuerpo:', cuerpo, 'DV:', dv);
            
            let suma = 0;
            let multiplicador = 2;
            
            // Procesar de derecha a izquierda
            for (let i = cuerpo.length - 1; i >= 0; i--) {
                const digito = parseInt(cuerpo[i], 10);
                suma += digito * multiplicador;
                console.log(`  ${cuerpo[i]} × ${multiplicador} = ${digito * multiplicador} (suma: ${suma})`);
                multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
            }
            
            const resto = suma % 11;
            const dvCalc = resto === 0 ? '0' : (resto === 1 ? '1' : (11 - resto) === 10 ? 'K' : (11 - resto).toString());
            
            console.log('📊 Suma:', suma, 'Resto:', resto, 'DV calculado:', dvCalc, 'DV recibido:', dv);
            
            const esValido = dv === dvCalc;
            console.log(esValido ? '✅ RUN válido' : '❌ RUN inválido');
            
            return esValido;
        }

        console.log('🔧 [DEBUG] Función dvValido definida correctamente');

        // ========= (4) Función para actualizar resumen de patologías =========
        console.log('🔧 [DEBUG] Definiendo función actualizarResumenPatologias...');
        function actualizarResumenPatologias() {
            // ...eliminar función duplicada, dejar solo la versión agrupada moderna...
        }

        function actualizarTablaExamenes(examenes) {
            console.log('🔄 actualizarTablaExamenes llamada con:', examenes);
            console.log('📊 Número de exámenes:', examenes ? examenes.length : 'examenes es null/undefined');
            console.log('📊 Tipo de examenes:', typeof examenes);
            console.log('📊 Es array:', Array.isArray(examenes));
            
            const tablaBody = document.querySelector('#tabla-examenes tbody');
            if (!tablaBody) {
                console.error('❌ No se encontró el tbody de la tabla exámenes');
                return;
            }
            
            console.log('🧹 Limpiando contenido actual del tbody');
            // Limpiar contenido actual completamente
            tablaBody.innerHTML = '';
            
            if (examenes && Array.isArray(examenes) && examenes.length > 0) {
                console.log('✅ Agregando', examenes.length, 'exámenes a la tabla');
                
                // Función auxiliar para formatear fecha en formato DD/MM/AAAA
                function formatearFechaCompleta(fecha) {
                    if (!fecha) return '';
                    const fechaObj = new Date(fecha + 'T00:00:00');
                    const dia = String(fechaObj.getDate()).padStart(2, '0');
                    const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                    const año = fechaObj.getFullYear();
                    return `${dia}/${mes}/${año}`;
                }
                
                // Función auxiliar para evaluar valores críticos
                function evaluarValor(valor, campo, sexo = null, edad = null) {
                    if (!valor || valor === '') return { color: '', fondo: '' };
                    
                    const num = parseFloat(valor);
                    if (isNaN(num)) return { color: '', fondo: '' };
                    
                    let critico = false;
                    let esVerde = false; // Nueva variable para manejar el color verde
                    
                    switch(campo) {
                        case 'hba1c':
                            // Obtener edad si no se proporciona
                            if (edad === null) {
                                const edadInput = document.getElementById('edad');
                                if (edadInput && edadInput.value) {
                                    edad = parseInt(edadInput.value, 10);
                                }
                            }
                            
                            // Lógica específica para HbA1c
                            if (edad !== null && edad >= 80) {
                                // Si edad >= 80 años: rojo si HbA1c >= 8, verde si < 8
                                critico = num >= 8.0;
                                esVerde = num < 8.0;
                            } else {
                                // Si edad < 80 años: rojo si HbA1c >= 7, verde si < 7
                                critico = num >= 7.0;
                                esVerde = num < 7.0;
                            }
                            break;
                        case 'col':
                            critico = num >= 200;
                            break;
                        case 'tag':
                            critico = num >= 150;
                            break;
                        case 'vfg':
                            critico = num < 60;
                            break;
                        case 'creatinemia':
                            critico = num >= 1.2;
                            break;
                        case 'rac':
                            critico = num >= 300;
                            break;
                        case 'hdl':
                            if (sexo) {
                                const sexoNorm = sexo.toLowerCase().trim();
                                if (sexoNorm.includes('femenino') || sexoNorm.includes('f') || sexoNorm.includes('mujer')) {
                                    critico = num <= 50;
                                } else if (sexoNorm.includes('masculino') || sexoNorm.includes('m') || sexoNorm.includes('hombre') || sexoNorm.includes('varón') || sexoNorm.includes('varon')) {
                                    critico = num <= 40;
                                }
                            }
                            break;
                    }
                    
                    // Determinar el estilo de retorno
                    if (critico) {
                        return { color: 'color: #dc3545; font-weight: bold;', fondo: 'background-color: #f8d7da;' };
                    } else if (esVerde) {
                        return { color: 'color: #28a745; font-weight: bold;', fondo: 'background-color: #d4edda;' };
                    } else {
                        return { color: '', fondo: '' };
                    }
                }
                
                // Agregar filas con datos de exámenes
                examenes.forEach((ex, index) => {
                    console.log(`🏥 Procesando examen ${index + 1}:`, ex);
                    
                    // Formatear fecha completa
                    const fechaCompleta = formatearFechaCompleta(ex.examen_fecha);
                    
                    // Obtener sexo del usuario para evaluación de HDL
                    const sexoUsuario = document.getElementById('sexo') ? document.getElementById('sexo').value : '';
                    
                    // Obtener edad del usuario para evaluación de HbA1c
                    let edadUsuario = null;
                    const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
                    if (fechaNacimientoInput && fechaNacimientoInput.value) {
                        edadUsuario = calcularEdadDesde(fechaNacimientoInput.value);
                    }
                    
                    // Evaluar valores críticos
                    const estiloHba1c = evaluarValor(ex.hba1c, 'hba1c', sexoUsuario, edadUsuario);
                    const estiloCol = evaluarValor(ex.col, 'col');
                    const estiloTag = evaluarValor(ex.tag, 'tag');
                    const estiloVfg = evaluarValor(ex.vfg, 'vfg');
                    const estiloCreatinemia = evaluarValor(ex.creatinemia, 'creatinemia');
                    const estiloRac = evaluarValor(ex.rac, 'rac');
                    const estiloHdl = evaluarValor(ex.hdl, 'hdl', sexoUsuario);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="border: 1px solid black; padding: 8px; white-space: nowrap; font-size: 12px;">${fechaCompleta}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.so2_percent || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.flujometria || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.tos === true ? 'Sí' : (ex.tos === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.baciloscopia === true ? 'Sí' : (ex.baciloscopia === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloCreatinemia.color} ${estiloCreatinemia.fondo}">${ex.creatinemia ? parseFloat(ex.creatinemia).toFixed(2) : ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloCol.color} ${estiloCol.fondo}">${ex.col || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloHdl.color} ${estiloHdl.fondo}">${ex.hdl || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.ldl || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloTag.color} ${estiloTag.fondo}">${ex.tag || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.microalbuminuria === true ? 'Sí' : (ex.microalbuminuria === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.microalbuminuria_val || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloVfg.color} ${estiloVfg.fondo}">${ex.vfg || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloRac.color} ${estiloRac.fondo}">${ex.rac ? parseFloat(ex.rac).toFixed(2) : ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.rpr === true ? 'Sí' : (ex.rpr === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.tsh || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloHba1c.color} ${estiloHba1c.fondo}">${ex.hba1c || ''}</td>
                    `;
                    tablaBody.appendChild(row);
                });
                console.log('✅ Tabla actualizada con', examenes.length, 'filas');
            } else {
                console.log('⚠️ No hay exámenes válidos, mostrando mensaje de no hay datos');
                // Mostrar mensaje cuando no hay exámenes
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="17" style="text-align:center; color:#888; padding:20px; border: 1px solid black;">No hay exámenes registrados para este usuario.</td>';
                tablaBody.appendChild(row);
            }
        }

        // Función para actualizar la tabla de acuerdos previos
        function actualizarTablaAcuerdos(acuerdos) {
            console.log('🔄 actualizarTablaAcuerdos llamada con:', acuerdos);
            console.log('📊 Número de acuerdos:', acuerdos ? acuerdos.length : 'acuerdos es null/undefined');
            
            const tablaBody = document.querySelector('#tabla-acuerdos tbody');
            if (!tablaBody) {
                console.error('❌ No se encontró el tbody de la tabla acuerdos');
                return;
            }
            
            console.log('🧹 Limpiando contenido actual del tbody de acuerdos');
            // Limpiar contenido actual completamente
            tablaBody.innerHTML = '';
            
            if (acuerdos && Array.isArray(acuerdos) && acuerdos.length > 0) {
                console.log('✅ Agregando', acuerdos.length, 'acuerdos a la tabla');
                
                // Función auxiliar para formatear fecha y hora
                function formatearFechaHora(fechaStr) {
                    if (!fechaStr) return '';
                    try {
                        let s = fechaStr;
                        // Aceptar 'YYYY-MM-DD HH:MM:SS' convirtiendo a ISO básico
                        if (typeof s === 'string' && s.indexOf('T') === -1 && s.indexOf(' ') !== -1) {
                            s = s.replace(' ', 'T');
                        }
                        const fecha = new Date(s);
                        if (isNaN(fecha.getTime())) {
                            // Fallback: parsear manualmente 'YYYY-MM-DD HH:MM[:SS]'
                            const m = String(fechaStr).match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})/);
                            if (m) {
                                return `${m[3]}/${m[2]}/${m[1]} ${m[4]}:${m[5]}`;
                            }
                            return fechaStr;
                        }
                        const dia = String(fecha.getDate()).padStart(2, '0');
                        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                        const año = fecha.getFullYear();
                        const horas = String(fecha.getHours()).padStart(2, '0');
                        const minutos = String(fecha.getMinutes()).padStart(2, '0');
                        return `${dia}/${mes}/${año} ${horas}:${minutos}`;
                    } catch (e) {
                        return fechaStr; // Devolver fecha original si no se puede formatear
                    }
                }
                
                // Agregar filas con datos de acuerdos
                acuerdos.forEach((acuerdo, index) => {
                    console.log(`📝 Procesando acuerdo ${index + 1}:`, acuerdo);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding:2px 6px;">${formatearFechaHora(acuerdo.fecha_creacion)}</td>
                        <td style="padding:2px 6px;">${acuerdo.acuerdos || ''}</td>
                        <td style="padding:2px 6px;">${acuerdo.cumplimiento || ''}</td>
                        <td style="padding:2px 6px;">${acuerdo.observaciones || ''}</td>
                    `;
                    tablaBody.appendChild(row);
                });
                
                console.log('✅ Tabla de acuerdos actualizada con', acuerdos.length, 'filas');
            } else {
                console.log('⚠️ No hay acuerdos válidos, mostrando mensaje de no hay datos');
                // Mostrar mensaje cuando no hay acuerdos
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align:center; color:#888; padding:8px;">No hay acuerdos previos.</td>';
                tablaBody.appendChild(row);
            }
        }

        // Función para crear el mensaje de nuevo usuario si no existe
        function crearMensajeNuevoUsuario() {
            const existingMsg = document.getElementById('usuario-nuevo');
            if (existingMsg) return existingMsg;
            
            const mensajeDiv = document.createElement('div');
            mensajeDiv.id = 'usuario-nuevo';
            mensajeDiv.className = 'nuevo-usuario';
            mensajeDiv.style.cssText = 'display: none; background: #e8f5e8; border: 1px solid #28a745; border-radius: 6px; padding: 12px; margin: 8px 0; color: #155724;';
            mensajeDiv.innerHTML = `
                <strong>🆕 Usuario nuevo</strong>
                <p style="margin: 4px 0 0 0; font-size: 13px;">El RUN no fue encontrado en la base de datos. Puedes completar los campos para crear un nuevo usuario.</p>
            `;
            
            // Insertar después del elemento usuario-encontrado
            const encontradoDiv = document.getElementById('usuario-encontrado');
            if (encontradoDiv && encontradoDiv.parentNode) {
                encontradoDiv.parentNode.insertBefore(mensajeDiv, encontradoDiv.nextSibling);
            }
            
            return mensajeDiv;
        }

        function buscarUsuario(run) {
            if (!run || run.length < 8) return;
            
            // GUARDAR EL RUN ORIGINAL PARA PRESERVARLO
            const runOriginal = run;
            const runInput = document.getElementById('run');
            
            console.log('🔍 buscarUsuario iniciado con RUN:', runOriginal);
            
            const loading = document.getElementById('loading');
            const encontrado = document.getElementById('usuario-encontrado');
            
            loading.style.display = 'block';
            encontrado.style.display = 'none';
            
            fetch('/usuario/buscar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ run: runOriginal })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                // ASEGURAR QUE EL RUN NO SE PIERDA NUNCA
                if (runInput.value !== runOriginal) {
                    console.log('⚠️ RUN cambió durante búsqueda, restaurando:', runOriginal);
                    runInput.value = runOriginal;
                }
                
                if (data.encontrado) {
                    // Llenar los campos con los datos encontrados
                    document.getElementById('nombre').value = data.nombre || '';
                    document.getElementById('fecha_nacimiento').value = data.fecha_nacimiento || '';
                    document.getElementById('direccion').value = data.direccion || '';
                    document.getElementById('telefono').value = data.telefono || '';
                    document.getElementById('fecha_ingreso').value = data.fecha_ingreso || '';
                    document.getElementById('sexo').value = data.sexo || '';
                    document.getElementById('categoria_id').value = data.categoria_id || '';
                    document.getElementById('sector_id').value = data.sector_id || '';
                    
                    // Marcar patologías
                    const checkboxes = document.querySelectorAll('input[name="patologia[]"]');
                    checkboxes.forEach(cb => {
                        cb.checked = data.patologias.includes(parseInt(cb.value));
                    });
                    
                    // Actualizar resumen de patologías
                    actualizarResumenPatologias();
                    
                    // Actualizar tabla de exámenes
                    console.log('📦 Datos del usuario encontrado:', data);
                    console.log('🏥 Exámenes recibidos en buscarUsuario:', data.examenes);
                    console.log('🏥 Tipo de data.examenes:', typeof data.examenes);
                    console.log('🏥 Es array data.examenes:', Array.isArray(data.examenes));
                    console.log('🏥 Longitud de data.examenes:', data.examenes ? data.examenes.length : 'undefined/null');
                    
                    if (data.examenes) {
                        console.log('✅ Llamando a actualizarTablaExamenes con', data.examenes.length, 'exámenes');
                    } else {
                        console.log('⚠️ Llamando a actualizarTablaExamenes con examenes undefined/null');
                    }
                    
                    actualizarTablaExamenes(data.examenes);
                    
                    // Actualizar tabla de acuerdos
                    console.log('📝 Acuerdos recibidos en buscarUsuario:', data.acuerdos);
                    console.log('📝 Tipo de data.acuerdos:', typeof data.acuerdos);
                    console.log('📝 Es array data.acuerdos:', Array.isArray(data.acuerdos));
                    console.log('📝 Longitud de data.acuerdos:', data.acuerdos ? data.acuerdos.length : 'undefined/null');
                    
                    if (data.acuerdos) {
                        console.log('✅ Llamando a actualizarTablaAcuerdos con', data.acuerdos.length, 'acuerdos');
                    } else {
                        console.log('⚠️ Llamando a actualizarTablaAcuerdos con acuerdos undefined/null');
                    }
                    
                    actualizarTablaAcuerdos(data.acuerdos);
                    
                    encontrado.style.display = 'block';
                    
                    // Ocultar mensaje de nuevo usuario si está visible
                    const mensajeNuevo = document.getElementById('usuario-nuevo');
                    if (mensajeNuevo) mensajeNuevo.style.display = 'none';
                    
                    // Cargar patologías guardadas en BD
                    cargarPatologiasGuardadas(run);
                    
                    // Habilitar botones de guardado independiente
                    habilitarBotonesGuardadoIndependiente();
                } else {
                    // Usuario no encontrado - NO limpiar campos automáticamente
                    console.log('🆕 Usuario no encontrado con RUN:', runOriginal);
                    
                    // ASEGURAR QUE EL RUN PERMANEZCA EN EL CAMPO
                    if (runInput.value !== runOriginal) {
                        console.log('🔧 Restaurando RUN que se perdió:', runOriginal);
                        runInput.value = runOriginal;
                    }
                    
                    // Ocultar mensaje de usuario encontrado
                    encontrado.style.display = 'none';
                    
                    // Mostrar mensaje informativo que permite continuar con nuevo usuario
                    const mensajeNuevo = document.getElementById('usuario-nuevo') || crearMensajeNuevoUsuario();
                    mensajeNuevo.style.display = 'block';
                    
                    // Limpiar solo la tabla de exámenes y acuerdos (ya que es un usuario nuevo)
                    actualizarTablaExamenes([]);
                    actualizarTablaAcuerdos([]);
                    
                    // Cargar patologías guardadas si las hay (pueden existir diagnósticos sin estar en tabla usuarios)
                    cargarPatologiasGuardadas(runOriginal);
                    
                    // Habilitar botones de guardado independiente también para usuarios nuevos
                    habilitarBotonesGuardadoIndependiente();
                    
                    // Permitir que el usuario continúe llenando el formulario para crear un nuevo usuario
                    console.log('✅ RUN preservado para nuevo usuario:', runInput.value);
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('Error buscando usuario:', error);
            });
        }

        // Variable para evitar múltiples inicializaciones
        let runEventListenersInitialized = false;
        
        console.log('🔧 Definiendo función initializarEventosRun...');
        
        // FUNCIÓN PRINCIPAL DE INICIALIZACIÓN - SOLO SE EJECUTA UNA VEZ
        function initializarEventosRun() {
            // PROTECCIÓN: Evitar múltiples inicializaciones
            if (runEventListenersInitialized) {
                console.log('⚠️ Event listeners de RUN ya inicializados, omitiendo...');
                return;
            }
            
            console.log('🚀 Inicializando eventos de RUN - ÚNICA VEZ');
            
            const runInput = document.getElementById('run');
            console.log('📍 Elemento RUN encontrado:', runInput);
            
            if (!runInput) {
                console.error('❌ ERROR: No se encontró el elemento con ID "run"');
                return;
            }
            
            let timeoutId;
            
            // Utilidad para marcar estado visual del RUN
            function setRunEstado(estado) { 
                const el = document.getElementById('run');
                if (!el) return;
                
                el.classList.remove('run-valid', 'run-invalid');
                
                if (estado === true) { 
                    el.classList.add('run-valid'); 
                    el.title = 'RUN válido';
                    console.log('✅ RUN válido detectado, habilitando botones de guardado independiente');
                    // Habilitar botones de guardado independiente cuando el RUN es válido
                    if (typeof window.habilitarBotonesGuardadoIndependiente === 'function') {
                        window.habilitarBotonesGuardadoIndependiente();
                    }
                } else if (estado === false) { 
                    el.classList.add('run-invalid'); 
                    el.title = 'RUN inválido';
                    console.log('❌ RUN inválido, ocultando botones');
                    // Ocultar botones cuando el RUN es inválido
                    if (typeof window.ocultarBotonesGestion === 'function') {
                        window.ocultarBotonesGestion();
                    }
                } else { 
                    el.title = '';
                    console.log('⏳ RUN incompleto, ocultando botones');
                    // Ocultar botones cuando el RUN está incompleto
                    if (typeof window.ocultarBotonesGestion === 'function') {
                        window.ocultarBotonesGestion();
                    }
                }
            }

            // Función para habilitar botones de guardado independiente
            function habilitarBotonesGuardadoIndependiente() {
                console.log('🔓 Habilitando botones de guardado independiente...');
                
                const container = document.getElementById('botones-gestion-patologias');
                const btnGuardarPatologias = document.getElementById('btn-guardar-patologias');
                const btnModificarPatologias = document.getElementById('btn-modificar-patologias');
                
                console.log('🔍 Container encontrado:', !!container);
                console.log('🔍 Botón guardar encontrado:', !!btnGuardarPatologias);
                console.log('🔍 Botón modificar encontrado:', !!btnModificarPatologias);
                
                if (container) {
                    container.style.opacity = '1';
                    container.style.pointerEvents = 'auto';
                    container.style.borderColor = 'green';
                    container.style.backgroundColor = '#e8f5e8';
                    container.style.display = 'block';
                    
                    // Ocultar el mensaje de ayuda
                    const helpText = container.querySelector('small');
                    if (helpText) {
                        helpText.style.display = 'none';
                        console.log('👻 Mensaje de ayuda ocultado');
                    }
                    
                    console.log('✅ Container habilitado con estilo verde');
                }
                
                if (btnGuardarPatologias) {
                    btnGuardarPatologias.disabled = false;
                    btnGuardarPatologias.style.cursor = 'pointer';
                    btnGuardarPatologias.style.opacity = '1';
                    btnGuardarPatologias.style.display = 'inline-block';
                    btnGuardarPatologias.title = 'Guardar solo las patologías seleccionadas';
                    console.log('✅ Botón "Guardar Patologías" habilitado');
                } else {
                    console.log('❌ No se encontró el botón btn-guardar-patologias');
                }
                
                if (btnModificarPatologias) {
                    btnModificarPatologias.disabled = false;
                    btnModificarPatologias.style.cursor = 'pointer';
                    btnModificarPatologias.style.opacity = '1';
                    btnModificarPatologias.style.display = 'inline-block';
                    btnModificarPatologias.removeAttribute('aria-disabled');
                    btnModificarPatologias.title = 'Modificar patologías guardadas';
                    console.log('✅ Botón "Modificar Patologías" habilitado');
                }
                
                console.log('✅ Botones de guardado independiente habilitados completamente');
            }

            // Función para deshabilitar los botones de gestión
            function ocultarBotonesGestion() {
                console.log('🔒 Deshabilitando botones de gestión de patologías...');
                
                const container = document.getElementById('botones-gestion-patologias');
                const btnGuardarPatologias = document.getElementById('btn-guardar-patologias');
                const btnModificarPatologias = document.getElementById('btn-modificar-patologias');
                
                if (container) {
                    container.style.opacity = '0.5';
                    container.style.pointerEvents = 'none';
                    container.style.borderColor = '#ccc';
                    container.style.backgroundColor = '#f9f9f9';
                    
                    // Mostrar el mensaje de ayuda
                    const helpText = container.querySelector('small');
                    if (helpText) {
                        helpText.style.display = 'block';
                        console.log('💡 Mensaje de ayuda mostrado');
                    }
                }
                
                if (btnGuardarPatologias) {
                    btnGuardarPatologias.disabled = true;
                    btnGuardarPatologias.style.cursor = 'not-allowed';
                    btnGuardarPatologias.style.opacity = '0.5';
                    btnGuardarPatologias.title = 'Ingrese un RUN válido para habilitar';
                    console.log('🔒 Botón "Guardar Patologías" deshabilitado');
                }
                
                if (btnModificarPatologias) {
                    btnModificarPatologias.disabled = true;
                    btnModificarPatologias.setAttribute('aria-disabled', 'true');
                    btnModificarPatologias.style.opacity = '0.5';
                    btnModificarPatologias.style.cursor = 'not-allowed';
                    btnModificarPatologias.title = 'Ingrese un RUN válido para habilitar';
                    console.log('🔒 Botón "Modificar Patologías" deshabilitado');
                }
                
                console.log('✅ Botones de gestión deshabilitados');
            }

            // Función para guardar patologías independientemente
            function guardarPatologiasIndependiente() {
                console.log('💾 Guardando patologías independientemente...');
                
                const run = document.getElementById('run')?.value;
                if (!run || run.length < 8) {
                    alert('⚠️ Por favor ingrese un RUN válido antes de guardar patologías');
                    return;
                }
                
                // Obtener checkboxes marcados
                const checkboxes = document.querySelectorAll('.patologia-checkbox:checked');
                const cie10Codes = Array.from(checkboxes).map(cb => cb.value);
                
                if (cie10Codes.length === 0) {
                    alert('⚠️ No hay patologías seleccionadas para guardar');
                    return;
                }
                
                const confirmacion = confirm(`¿Desea guardar ${cie10Codes.length} patología(s) seleccionada(s) para el RUN ${run}?`);
                if (!confirmacion) return;
                
                // Crear FormData para enviar al endpoint principal del formulario
                const formData = new FormData();
                formData.append('run', run);
                formData.append('guardar_solo_patologias', '1'); // Flag para guardado independiente de patologías
                
                // Agregar todas las patologías seleccionadas
                cie10Codes.forEach(codigo => {
                    formData.append('patologia[]', codigo);
                });
                
                fetch('/usuario/nuevo', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    if (data.includes('Error') || data.includes('error')) {
                        // Si hay error en la respuesta, mostrar mensaje de error
                        const errorMatch = data.match(/Error[^<]*/i);
                        const errorMsg = errorMatch ? errorMatch[0] : 'Error desconocido';
                        alert('❌ ' + errorMsg);
                    } else {
                        alert('✅ Patologías guardadas exitosamente');
                        // Recargar patologías guardadas
                        if (typeof cargarPatologiasGuardadas === 'function') {
                            cargarPatologiasGuardadas(run);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('❌ Error de conexión al guardar las patologías');
                });
            }

            // Asignar funciones al objeto window para acceso global
            window.habilitarBotonesGuardadoIndependiente = habilitarBotonesGuardadoIndependiente;
            window.ocultarBotonesGestion = ocultarBotonesGestion;
            window.guardarPatologiasIndependiente = guardarPatologiasIndependiente;
            
            console.log('🌐 Funciones asignadas globalmente:', {
                habilitarBotonesGuardadoIndependiente: typeof window.habilitarBotonesGuardadoIndependiente,
                ocultarBotonesGestion: typeof window.ocultarBotonesGestion,
                guardarPatologiasIndependiente: typeof window.guardarPatologiasIndependiente
            });
            
            // Función de test para debugging
            window.testBotones = function() {
                console.log('🧪 Probando funciones de botones...');
                console.log('- guardarPatologiasIndependiente:', typeof window.guardarPatologiasIndependiente);
                console.log('- habilitarBotonesGuardadoIndependiente:', typeof window.habilitarBotonesGuardadoIndependiente);
                console.log('- ocultarBotonesGestion:', typeof window.ocultarBotonesGestion);
                
                const btnGuardar = document.getElementById('btn-guardar-patologias');
                const btnModificar = document.getElementById('btn-modificar-patologias');
                console.log('- Botón guardar encontrado:', !!btnGuardar);
                console.log('- Botón modificar encontrado:', !!btnModificar);
                
                if (btnGuardar) {
                    console.log('- Botón guardar onclick:', btnGuardar.onclick);
                    console.log('- Botón guardar disabled:', btnGuardar.disabled);
                }
                
                return 'Test completado - revisa la consola para detalles';
            };
            
            console.log('🔧 Función de test disponible: window.testBotones()');

            // Función para manejar entrada del RUN
            function manejarBusquedaRun(e) {
                console.log('⌨️ Input detectado en RUN:', e.target.value);
                
                // Aplicar máscara de formato
                let v = e.target.value.replace(/[^0-9kK]/g, '').toUpperCase();
                if (v.length > 1) {
                    const cuerpo = v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    const dv = v.slice(-1);
                    e.target.value = cuerpo + '-' + dv;
                } else {
                    e.target.value = v;
                }
                
                console.log('✨ Valor formateado:', e.target.value);

                // Validar RUN si está completo
                const runNormalizado = normalizarRun(e.target.value);
                const runLimpio = e.target.value.replace(/[^0-9kK]/g, '');
                
                console.log('🔍 RUN normalizado:', runNormalizado, 'Limpio:', runLimpio, 'Longitud:', runLimpio.length);
                
                // Cambiar color según validación
                if (runLimpio.length >= 8) {
                    if (dvValido(runNormalizado)) {
                        console.log('✅ RUN válido, programando búsqueda...');
                        setRunEstado(true);
                        
                        // Limpiar timeout anterior
                        clearTimeout(timeoutId);
                        
                        // Buscar después de 500ms de inactividad
                        timeoutId = setTimeout(() => {
                            const runActual = document.getElementById('run').value;
                            if (runActual && runActual.length >= 8) {
                                console.log('🔍 Ejecutando búsqueda para RUN:', runActual);
                                buscarUsuario(runActual);
                            }
                        }, 500);
                    } else {
                        console.log('❌ RUN inválido');
                        setRunEstado(false);
                    }
                } else {
                    console.log('⏳ RUN incompleto, longitud:', runLimpio.length);
                    setRunEstado(null);
                    if (typeof limpiarPatologiasGuardadas === 'function') {
                        limpiarPatologiasGuardadas();
                    }
                }
            }
            
            // ASIGNAR EVENTOS UNA SOLA VEZ
            console.log('🔗 Asignando eventos al input RUN...');
            runInput.addEventListener('input', manejarBusquedaRun);
            runInput.addEventListener('paste', function() {
                console.log('📋 Evento paste detectado');
                setTimeout(() => {
                    manejarBusquedaRun({ target: runInput });
                }, 100);
            });
            runInput.addEventListener('keyup', function(e) {
                console.log('⌨️ Keyup detectado:', e.key);
                if (e.key === 'Enter') {
                    const runNormalizado = normalizarRun(runInput.value);
                    const runLimpio = runInput.value.replace(/[^0-9kK]/g, '');
                    if (runLimpio.length >= 8 && dvValido(runNormalizado)) {
                        console.log('🚀 Enter presionado, buscando inmediatamente');
                        buscarUsuario(runInput.value);
                    }
                }
            });
            runInput.addEventListener('blur', function() {
                console.log('👁️ Blur detectado en RUN');
                const valor = runInput.value;
                if (valor) {
                    runInput.value = formatearRun(valor);
                    console.log('🎨 Valor reformateado al perder foco:', runInput.value);
                }
                const runNormalizado = normalizarRun(valor);
                const runLimpio = valor.replace(/[^0-9kK]/g, '');
                if (valor && runLimpio.length >= 2) {
                    setRunEstado(dvValido(runNormalizado));
                } else {
                    setRunEstado(null);
                }
            });
            
            console.log('✅ Eventos de RUN configurados correctamente');
            runEventListenersInitialized = true; // Marcar como inicializado
        }
        
        console.log('🔧 [DEBUG] Función initializarEventosRun definida correctamente');
        
        // INICIALIZACIÓN ÚNICA Y CONSOLIDADA
        console.log('🔧 [DEBUG] Definiendo DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('� DOMContentLoaded principal ejecutándose...');
            console.log('🔧 [DEBUG] Dentro de DOMContentLoaded - paso 1');
            initializarEventosRun();
            console.log('🔧 [DEBUG] Dentro de DOMContentLoaded - paso 2');
            
            // Inicializar otros eventos necesarios
            console.log('🔧 [DEBUG] Dentro de DOMContentLoaded - paso 3');
            try {
                var sel = document.getElementById('cumplimiento');
                var acuerdosTextarea = document.getElementById('acuerdos');
                
                if (sel && acuerdosTextarea) {
                    setCumplimientoColor();
                    // Solo validar si no hay errores del servidor
                    if (!window.HAS_ERROR) {
                        validarCumplimientoRequerido();
                    } else {
                        console.log('🛡️ Validación inicial de cumplimiento omitida debido a error del servidor');
                    }
                    
                    sel.addEventListener('change', setCumplimientoColor);
                    acuerdosTextarea.addEventListener('input', validarCumplimientoRequerido);
                    acuerdosTextarea.addEventListener('blur', validarCumplimientoRequerido);
                }
            } catch (e) {
                console.warn('Elementos de cumplimiento no encontrados, omitiendo validación');
            }
            
            // 3. Inicializar categorías y familias colapsadas
            try {
                // Debug: contar cuántas categorías hay
                const categorias = document.querySelectorAll('.categoria-seccion');
                console.log('🔍 Total de categorías encontradas:', categorias.length);
                categorias.forEach((cat, index) => {
                    console.log(`📁 Categoría ${index + 1}:`, cat.id, cat.style.display);
                });
                
                document.querySelectorAll('.categoria-content').forEach(cat => cat.classList.add('collapsed'));
                document.querySelectorAll('.familia-content').forEach(fam => fam.classList.add('collapsed'));
                document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '+');
                document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '+');
                
                // Agregar listeners para actualizar resumen de patologías
                document.querySelectorAll('.familia input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', () => {
                        calcularRiesgo();
                        actualizarResumenPatologias();
                    });
                });
                
                calcularRiesgo();
                actualizarResumenPatologias();
                
                // Inicializar estado del botón de colapsar patologías
                actualizarContadoresCategorias();
            } catch (e) {
                console.warn('Error en inicialización de patologías:', e);
            }

            // Inicializar validaciones de rangos médicos (PA, HbA1c, col, LDL, TAG, talla, etc.)
            try {
                validarRangosMedicos();
            } catch (e) {
                console.warn('No se pudo inicializar validarRangosMedicos:', e);
            }
        });

        console.log('🔧 [DEBUG] DOMContentLoaded definido correctamente');

        // Función para limpiar el formulario
        console.log('🔧 [DEBUG] Definiendo función limpiarFormulario...');
        function limpiarFormulario() {
            // PROTECCIÓN CONTRA ERRORES: NO limpiar si hay errores del servidor
            if (window.HAS_ERROR) {
                console.log('🚨 NO limpiando formulario porque hay errores del servidor (HAS_ERROR=true)');
                return false;
            }
            
            // PROTECCIÓN: NO limpiar el campo RUN nunca
            const runInput = document.getElementById('run');
            const runValue = runInput ? runInput.value : '';
            
            // Limpiar todos los inputs de texto, number, date EXCEPTO el RUN
            const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]');
            inputs.forEach(input => {
                if (input.id !== 'run') { // NO limpiar el RUN
                    input.value = '';
                }
            });
            
            // Limpiar selects
            const selects = document.querySelectorAll('select');
            selects.forEach(select => select.selectedIndex = 0);
            
            // Desmarcar checkboxes (incluyendo patologías ECICEP)
            const checkboxes = document.querySelectorAll('input[type="checkbox"], .patologia-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            
            // Ocultar mensajes
            const loading = document.getElementById('loading');
            const encontrado = document.getElementById('usuario-encontrado');
            const mensajeNuevo = document.getElementById('usuario-nuevo');
            if (loading) loading.style.display = 'none';
            if (encontrado) encontrado.style.display = 'none';
            if (mensajeNuevo) mensajeNuevo.style.display = 'none';
            
            // NO enfocar el RUN para evitar problemas
            // Limpiar resumen de patologías guardadas
            limpiarPatologiasGuardadas();
            
            // Actualizar cálculo de riesgo
            if (typeof calcularRiesgo === 'function') {
                calcularRiesgo();
            }
            
            // RESTAURAR el RUN si se perdió accidentalmente
            if (runInput && runInput.value !== runValue) {
                console.log('🔧 RUN restaurado en limpiarFormulario:', runValue);
                runInput.value = runValue;
            }
        }

        console.log('🔧 [DEBUG] Función limpiarFormulario definida correctamente');

        // Función para limpiar el resumen de patologías guardadas
        console.log('🔧 [DEBUG] Definiendo función limpiarPatologiasGuardadas...');
        function limpiarPatologiasGuardadas() {
            const container = document.getElementById('patologias-guardadas');
            if (container) {
                container.innerHTML = '<span class="pat-empty" style="color: #6b7280;">Sin patologías guardadas en base de datos</span>';
            }
            // Asegura ocultar y deshabilitar los botones de gestión
            ocultarBotonesGestion();
        }

        // Función para obtener el color de fondo según el código CIE10
        console.log('🔧 [DEBUG] Definiendo función obtenerColorPatologia...');
        function obtenerColorPatologia(cie10) {
            switch(cie10) {
                case 'I10': // Hipertensión esencial
                    return '#ef4444'; // Rojo
                case 'E10': // Diabetes mellitus insulinodependiente
                case 'E11': // Diabetes mellitus no insulinodependiente
                    return '#22c55e'; // Verde
                case 'E78': // Dislipidemia
                    return '#eab308'; // Amarillo
                default:
                    return '#059669'; // Verde por defecto para otras patologías
            }
        }

        // Función para actualizar el resumen de patologías guardadas desde la BD
        console.log('🔧 [DEBUG] Definiendo función actualizarPatologiasGuardadas...');
        function actualizarPatologiasGuardadas(patologias) {
            const container = document.getElementById('patologias-guardadas');
            if (!container) return;
            
            if (!patologias || patologias.length === 0) {
                limpiarPatologiasGuardadas();
                ocultarBotonEliminar();
                return;
            }
            
            // Crear badges para cada patología guardada con colores específicos
            const badges = patologias.map(patologia => {
                const nombre = patologia.nombre || '';
                const cie10 = patologia.cie10 || '';
                const nombreTruncado = nombre.length > 40 ? nombre.substring(0, 37) + '...' : nombre;
                
                // Usar el color que viene del endpoint o calcular uno
                let colorFondo;
                if (patologia.color) {
                    // Convertir el color del endpoint a hex
                    switch(patologia.color) {
                        case 'red':
                            colorFondo = '#dc3545';
                            break;
                        case 'green':
                            colorFondo = '#28a745';
                            break;
                        case 'yellow':
                            colorFondo = '#ffc107';
                            break;
                        default:
                            colorFondo = '#6c757d';
                    }
                } else {
                    colorFondo = obtenerColorPatologia(cie10);
                }
                
                return `
                    <span class="pat-badge guardada" 
                          style="background: ${colorFondo}; color: white; margin: 2px; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: inline-block;"
                          title="${nombre} (${cie10})">
                        ${nombreTruncado} (${cie10})
                    </span>
                `;
            }).join('');
            
            container.innerHTML = `
                <div style="margin-bottom: 4px;">
                    <small style="color: #059669; font-weight: 600;">${patologias.length} patología(s) guardada(s):</small>
                </div>
                ${badges}
            `;
            
            // Mostrar botones de gestión cuando hay patologías
            mostrarBotonEliminar();
            
            // Marcar checkboxes y expandir categorías según patologías guardadas
            marcarPatologiasGuardadas(patologias);
        }

        console.log('🚧 [DEBUG] Llegando a definir función cargarPatologiasGuardadas...');
        
        // Función para cargar patologías guardadas desde la API
        function cargarPatologiasGuardadas(run) {
            console.log('🔍 [NUEVO] Cargando patologías para RUN:', run);
            console.log('🏗️ [DEBUG] Función cargarPatologiasGuardadas definida correctamente');
            
            // Validación más estricta: verificar que el RUN esté completo y sea válido
            if (!run || run.length < 8) {
                console.log('🔍 [NUEVO] RUN muy corto o vacío:', run, 'longitud:', run ? run.length : 0);
                limpiarPatologiasGuardadas();
                return;
            }
            
            // Limpiar RUN para validación
            const runLimpioValidacion = run.replace(/[\.\-\s]/g, '');
            if (runLimpioValidacion.length < 8) {
                console.log('🔍 [NUEVO] RUN limpio muy corto:', runLimpioValidacion, 'longitud:', runLimpioValidacion.length);
                limpiarPatologiasGuardadas();
                return;
            }
            
            // Validar formato básico (solo números y K al final)
            if (!/^\d{7,8}[0-9K]$/i.test(runLimpioValidacion)) {
                console.log('🔍 [NUEVO] RUN con formato inválido:', runLimpioValidacion);
                limpiarPatologiasGuardadas();
                return;
            }

            const container = document.getElementById('patologias-guardadas');
            if (!container) {
                console.error('❌ [NUEVO] No se encontró container patologias-guardadas');
                return;
            }
            
            // Mostrar estado de carga
            container.innerHTML = '<span style="color:#6b7280;">🔄 Cargando patologías...</span>';
            
            // Limpiar RUN para la API (solo números y K)
            const runLimpio = run.replace(/[\.\-\s]/g, '');
            console.log('🔍 [NUEVO] RUN limpio para API:', runLimpio);
            
            const url = `/api/patologias/${runLimpio}`;
            console.log('🔍 [NUEVO] URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('📡 [NUEVO] Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('� [NUEVO] Data received:', data);
                    
                    if (data.patologias && Array.isArray(data.patologias) && data.patologias.length > 0) {
                        console.log('✅ [NUEVO] Mostrando', data.patologias.length, 'patologías');
                        mostrarPatologiasEnContainer(data.patologias);
                    } else {
                        console.log('⚪ [NUEVO] Sin patologías');
                        container.innerHTML = '<span style="color:#6b7280;">Sin patologías guardadas</span>';
                    }
                })
                .catch(error => {
                    console.error('❌ [NUEVO] Error:', error);
                    container.innerHTML = '<span style="color:#dc3545;">Error cargando patologías</span>';
                });
        }
        
        // Función para mostrar patologías en el container
        function mostrarPatologiasEnContainer(patologias) {
            console.log('🎨 [NUEVO] Mostrando patologías en container:', patologias);
            
            const container = document.getElementById('patologias-guardadas');
            if (!container) {
                console.error('❌ [NUEVO] Container no encontrado');
                return;
            }
            
            // Crear badges para cada patología
            const badges = patologias.map(pat => {
                console.log('🏷️ [NUEVO] Procesando patología:', pat);
                
                const nombre = pat.nombre || 'Sin nombre';
                const cie10 = pat.cie10 || 'Sin código';
                const color = pat.color || 'default';
                
                // Mapear colores a CSS
                let bgColor;
                let textColor = 'white';
                
                switch(color) {
                    case 'red':
                        bgColor = '#dc3545';
                        break;
                    case 'green':
                        bgColor = '#28a745';
                        break;
                    case 'yellow':
                        bgColor = '#ffc107';
                        textColor = 'black';
                        break;
                    default:
                        bgColor = '#6c757d';
                }
                
                return `
                    <span style="
                        background: ${bgColor}; 
                        color: ${textColor}; 
                        padding: 4px 8px; 
                        margin: 2px; 
                        border-radius: 4px; 
                        display: inline-block; 
                        font-size: 11px;
                    " title="${nombre} - ${cie10}">
                        ${nombre} (${cie10})
                    </span>
                `;
            }).join('');
            
            container.innerHTML = `
                <div style="margin-bottom: 4px;">
                    <small style="color: #059669; font-weight: 600;">
                        ✅ ${patologias.length} patología(s) guardada(s):
                    </small>
                </div>
                ${badges}
            `;
            
            // Marcar checkboxes correspondientes a las patologías guardadas
            marcarCheckboxesPatologias(patologias);
            
            console.log('✅ [NUEVO] Patologías mostradas exitosamente');
        }

        // Función para marcar checkboxes correspondientes a patologías guardadas
        function marcarCheckboxesPatologias(patologias) {
            console.log('🎯 [CHECKBOX] Marcando checkboxes para patologías:', patologias);
            
            // Primero desmarcar todos los checkboxes para empezar limpio
            const todosCheckboxes = document.querySelectorAll('.patologia-checkbox');
            console.log('🔧 [CHECKBOX] Total de checkboxes encontrados:', todosCheckboxes.length);
            
            // Desmarcar todos
            todosCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Marcar solo los que están guardados
            patologias.forEach(patologia => {
                const cie10 = patologia.cie10;
                if (!cie10 || cie10 === 'Sin código') {
                    console.log('⚠️ [CHECKBOX] Patología sin código CIE-10:', patologia.nombre);
                    return;
                }
                
                // Buscar checkbox por valor (el value contiene el código CIE-10)
                const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    console.log('✅ [CHECKBOX] Marcado:', cie10, '-', patologia.nombre);
                } else {
                    console.log('❌ [CHECKBOX] No se encontró checkbox para:', cie10, '-', patologia.nombre);
                }
            });
            
            console.log('🎯 [CHECKBOX] Proceso de marcado completado');
        }

        // Función para manejar la selección de patologías (sistema aditivo)
        function manejarSeleccionPatologia(checkbox) {
            const cie10 = checkbox.value;
            const isChecked = checkbox.checked;
            const run = document.getElementById('run')?.value;
            
            console.log('🎯 [SELECCION] Patología:', cie10, 'Marcada:', isChecked, 'RUN:', run);
            
            if (!run || run.length < 8) {
                console.log('⚠️ [SELECCION] RUN no válido, no se puede guardar automáticamente');
                return;
            }
            
            if (isChecked) {
                // Agregar patología (modo aditivo)
                agregarPatologiaUsuario(run, cie10);
            } else {
                // Intentar eliminar patología (con restricciones)
                eliminarPatologiaUsuario(run, cie10);
            }
        }

        // Función para agregar una patología (modo aditivo)
        function agregarPatologiaUsuario(run, cie10) {
            console.log('➕ [AGREGAR] Agregando patología:', cie10, 'para RUN:', run);
            
            const runLimpio = run.replace(/[\.\-\s]/g, '');
            
            fetch(`/api/agregar_patologias/${runLimpio}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cie10_codes: [cie10]
                })
            })
            .then(response => {
                console.log('📡 [AGREGAR] Respuesta HTTP:', response.status, response.statusText);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('✅ [AGREGAR] Patología agregada exitosamente:', cie10);
                    // Recargar las patologías guardadas para actualizar la vista
                    cargarPatologiasGuardadas(run);
                } else {
                    console.error('❌ [AGREGAR] Error:', data.error);
                    alert(`❌ Error guardando patología ${cie10}: ${data.error}`);
                    // Desmarcar el checkbox si falló
                    const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
                    if (checkbox) checkbox.checked = false;
                }
            })
            .catch(error => {
                console.error('❌ [AGREGAR] Error de red:', error);
                alert(`💥 Error de conexión guardando patología ${cie10}. Verifique la consola para más detalles.`);
                // Desmarcar el checkbox si falló
                const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
                if (checkbox) checkbox.checked = false;
            });
        }

        // Lista de códigos CIE-10 que pueden ser eliminados
        const CIE10_ELIMINABLES = [
            'F50.0', 'F50.1', 'F50.2', 'F50.8', 'F50.9',  // F50.x - Trastornos alimentarios
            'F33.0', 'F33.1', 'F33.2', 'F33.3', 'F33.4', 'F33.8', 'F33.9',  // F33.x - Depresión recurrente
            'F40.0', 'F40.1', 'F40.2', 'F40.8', 'F40.9',  // F40.x - Fobias
            'F41.0', 'F41.1', 'F41.2', 'F41.3', 'F41.8', 'F41.9',  // F41.x - Trastornos de ansiedad
            'F42.0', 'F42.1', 'F42.2', 'F42.8', 'F42.9',  // F42.x - Trastorno obsesivo-compulsivo
            'F51.0', 'F51.1', 'F51.2', 'F51.3', 'F51.4', 'F51.5', 'F51.8', 'F51.9',  // F51.x - Trastornos del sueño
            'G47.0', 'G47.1', 'G47.2', 'G47.3', 'G47.4', 'G47.8', 'G47.9',  // G47.x - Trastornos del sueño
            // D50-D64 - Anemias
            'D50.0', 'D50.1', 'D50.8', 'D50.9', 'D51.0', 'D51.1', 'D51.2', 'D51.3', 'D51.8', 'D51.9',
            'D52.0', 'D52.1', 'D52.8', 'D52.9', 'D53.0', 'D53.1', 'D53.2', 'D53.8', 'D53.9',
            'D55.0', 'D55.1', 'D55.2', 'D55.8', 'D55.9', 'D56.0', 'D56.1', 'D56.2', 'D56.3', 'D56.4', 'D56.8', 'D56.9',
            'D57.0', 'D57.1', 'D57.2', 'D57.3', 'D57.8', 'D58.0', 'D58.1', 'D58.2', 'D58.8', 'D58.9',
            'D59.0', 'D59.1', 'D59.2', 'D59.3', 'D59.4', 'D59.5', 'D59.6', 'D59.8', 'D59.9',
            'D60.0', 'D60.1', 'D60.8', 'D60.9', 'D61.0', 'D61.1', 'D61.2', 'D61.3', 'D61.8', 'D61.9',
            'D62', 'D63.0', 'D63.1', 'D63.8', 'D64.0', 'D64.1', 'D64.2', 'D64.3', 'D64.4', 'D64.8', 'D64.9',
            'E66.0', 'E66.1', 'E66.2', 'E66.8', 'E66.9',  // E66.x - Obesidad
            // Z56-Z65 - Problemas psicosociales
            'Z56.0', 'Z56.1', 'Z56.2', 'Z56.3', 'Z56.4', 'Z56.5', 'Z56.6', 'Z56.7', 'Z56.8', 'Z56.9',
            'Z57.0', 'Z57.1', 'Z57.2', 'Z57.3', 'Z57.4', 'Z57.5', 'Z57.6', 'Z57.7', 'Z57.8', 'Z57.9',
            'Z58.0', 'Z58.1', 'Z58.2', 'Z58.3', 'Z58.4', 'Z58.5', 'Z58.6', 'Z58.7', 'Z58.8', 'Z58.9',
            'Z59.0', 'Z59.1', 'Z59.2', 'Z59.3', 'Z59.4', 'Z59.5', 'Z59.6', 'Z59.7', 'Z59.8', 'Z59.9',
            'Z60.0', 'Z60.1', 'Z60.2', 'Z60.3', 'Z60.4', 'Z60.5', 'Z60.8', 'Z60.9',
            'Z61.0', 'Z61.1', 'Z61.2', 'Z61.3', 'Z61.4', 'Z61.5', 'Z61.6', 'Z61.7', 'Z61.8', 'Z61.9',
            'Z62.0', 'Z62.1', 'Z62.2', 'Z62.3', 'Z62.4', 'Z62.5', 'Z62.6', 'Z62.8', 'Z62.9',
            'Z63.0', 'Z63.1', 'Z63.2', 'Z63.3', 'Z63.4', 'Z63.5', 'Z63.6', 'Z63.7', 'Z63.8', 'Z63.9',
            'Z64.0', 'Z64.1', 'Z64.2', 'Z64.3', 'Z64.4', 'Z65.0', 'Z65.1', 'Z65.2', 'Z65.3', 'Z65.4', 'Z65.5', 'Z65.8', 'Z65.9',
            // C00-C97 - Neoplasias malignas (rango amplio - solo algunos ejemplos principales)
            'C78.0', 'C78.1', 'C78.2', 'C78.3', 'C78.4', 'C78.5', 'C78.6', 'C78.7', 'C78.8',  // Metástasis
            'C79.0', 'C79.1', 'C79.2', 'C79.3', 'C79.4', 'C79.5', 'C79.6', 'C79.7', 'C79.8', 'C79.9',
            'C80.0', 'C80.1', 'C80.9',  // Neoplasia maligna sin especificación
            // D00-D48 - Neoplasias in situ, benignas e inciertas
            'D37.0', 'D37.1', 'D37.2', 'D37.3', 'D37.4', 'D37.5', 'D37.6', 'D37.7', 'D37.9',
            'D48.0', 'D48.1', 'D48.2', 'D48.3', 'D48.4', 'D48.5', 'D48.6', 'D48.7', 'D48.9',
            'T74.0', 'T74.1', 'T74.2', 'T74.3', 'T74.4', 'T74.8', 'T74.9',  // T74.x - Maltrato
            'Y07.0', 'Y07.1', 'Y07.2', 'Y07.3', 'Y07.4', 'Y07.5', 'Y07.6', 'Y07.7', 'Y07.8', 'Y07.9',  // Y07.x - Otros maltratos
            'I83.0', 'I83.1', 'I83.2', 'I83.9',  // I83.x - Venas varicosas
            'L97',    // L97 - Úlcera de miembro inferior no clasificada
            'L98.4'   // L98.4 - Úlcera crónica de la piel
        ];

        // Función para eliminar una patología (con restricciones)
        function eliminarPatologiaUsuario(run, cie10) {
            console.log('➖ [ELIMINAR] Intentando eliminar patología:', cie10);
            
            // Verificar si el código puede ser eliminado
            if (!CIE10_ELIMINABLES.includes(cie10)) {
                console.log('🚫 [ELIMINAR] Código CIE-10 no eliminable:', cie10);
                alert(`No se puede eliminar la patología ${cie10}. Solo ciertos códigos pueden ser eliminados una vez guardados.`);
                // Volver a marcar el checkbox
                const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
                if (checkbox) checkbox.checked = true;
                return;
            }
            
            // Si es eliminable, proceder (aquí puedes implementar la lógica de eliminación)
            console.log('✅ [ELIMINAR] Código CIE-10 eliminable:', cie10);
            // Por ahora solo log, puedes implementar el endpoint de eliminación selectiva después
            alert(`Función de eliminación selectiva para ${cie10} - Pendiente de implementar`);
            
            // Volver a marcar el checkbox por ahora
            const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
            if (checkbox) checkbox.checked = true;
        }

        // Función para validar rangos de valores médicos
        function validarRangosMedicos() {
            // Presión sistólica: rojo si >=140; si edad >=80, rojo si >=150
            const presionSistolica = document.querySelector('input[name="presion_sistolica"]');
            if (presionSistolica) {
                presionSistolica.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    const edadStr = (document.getElementById('edad') || {}).value || '';
                    const edadNum = parseInt(edadStr, 10);
                    const umbral = (!isNaN(edadNum) && edadNum >= 80) ? 150 : 140;
                    if (!isNaN(valor) && valor >= umbral) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // Presión diastólica >= 90 (rojo)
            const presionDiastolica = document.querySelector('input[name="presion_diastolica"]');
            if (presionDiastolica) {
                presionDiastolica.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (valor >= 90) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // Colesterol total: rojo si >= 200
            const col = document.querySelector('input[name="col"]');
            if (col) {
                col.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (!isNaN(valor) && valor >= 200) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // LDL: verde si < 70; rojo si >= 130 (rojo tiene prioridad)
            const ldl = document.querySelector('input[name="ldl"]');
            if (ldl) {
                ldl.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (!isNaN(valor) && valor >= 130) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else if (!isNaN(valor) && valor < 70) {
                        this.style.color = '#16a34a';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // TAG (triglicéridos): rojo si >= 150
            const tag = document.querySelector('input[name="tag"]');
            if (tag) {
                tag.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (!isNaN(valor) && valor >= 150) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // HbA1c: rojo si >=7; si edad >=80, rojo si >=8; verde en caso contrario
            const hba1c = document.querySelector('input[name="hba1c"]');
            if (hba1c) {
                hba1c.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (isNaN(valor) || valor === '') {
                        // Sin valor, sin color
                        this.style.color = '';
                        this.style.fontWeight = '';
                        this.style.backgroundColor = '';
                        return;
                    }
                    
                    const edadStr = (document.getElementById('edad') || {}).value || '';
                    const edadNum = parseInt(edadStr, 10);
                    
                    if (!isNaN(edadNum) && edadNum >= 80) {
                        // Si edad >= 80 años: rojo si HbA1c >= 8, verde si < 8
                        if (valor >= 8) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    } else {
                        // Si edad < 80 años: rojo si HbA1c >= 7, verde si < 7
                        if (valor >= 7) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    }
                });
            }

            // HGT >= 130 (rojo)
            const hgt = document.querySelector('input[name="hgt"]');
            if (hgt) {
                hgt.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (valor >= 130) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // HbA1c para exámenes: misma lógica que HbA1c principal
            const hba1cExamen = document.querySelector('input[name="hba1c_examen"]');
            if (hba1cExamen) {
                hba1cExamen.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (isNaN(valor) || valor === '') {
                        // Sin valor, sin color
                        this.style.color = '';
                        this.style.fontWeight = '';
                        this.style.backgroundColor = '';
                        return;
                    }
                    
                    const edadStr = (document.getElementById('edad') || {}).value || '';
                    const edadNum = parseInt(edadStr, 10);
                    
                    if (!isNaN(edadNum) && edadNum >= 80) {
                        // Si edad >= 80 años: rojo si HbA1c >= 8, verde si < 8
                        if (valor >= 8) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    } else {
                        // Si edad < 80 años: rojo si HbA1c >= 7, verde si < 7
                        if (valor >= 7) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    }
                });
            }

            // Talla (m): autoformateo y validación
            const talla = document.querySelector('input[name="talla"]');
            if (talla) {
                function normalizarTalla() {
                    let raw = (talla.value || '').toString().trim();
                    if (!raw) return;
                    raw = raw.replace(',', '.');
                    let n = parseFloat(raw);
                    if (isNaN(n)) { talla.value = ''; return; }
                    // Si parece estar en centímetros (n > 10), convertir a metros
                    if (n > 10) {
                        n = n / 100;
                    }
                    // Limitar rango permitido [0.50, 2.30]
                    if (n > 2.30) n = 2.30;
                    if (n < 0.50) n = 0.50;
                    talla.value = n.toFixed(2);
                    // Estilo rojo si alcanza el máximo
                    if (n >= 2.30) {
                        talla.style.color = '#e53935';
                        talla.style.fontWeight = 'bold';
                    } else {
                        talla.style.color = '';
                        talla.style.fontWeight = '';
                    }
                }

                // Reemplazar coma por punto y prevenir > 2.30 en tiempo real
                talla.addEventListener('input', function() {
                    // Reemplazar coma por punto
                    if (this.value && this.value.includes(',')) {
                        this.value = this.value.replace(',', '.');
                    }

                    if (!this.value) { this.style.color = ''; this.style.fontWeight = ''; return; }

                    let v = parseFloat(this.value);
                    if (isNaN(v)) { return; }

                    let changed = false;
                    // Si ingresan centímetros (ej: 170), convertir a metros al vuelo
                    if (v > 10) { v = v / 100; changed = true; }
                    // No permitir mayores a 2.30
                    if (v > 2.30) { v = 2.30; changed = true; }
                    // Limitar a 2 decimales mientras escribe si excede
                    const dot = this.value.indexOf('.');
                    if (dot !== -1 && this.value.length - dot - 1 > 2) {
                        changed = true;
                    }
                    if (changed) {
                        this.value = v.toFixed(2);
                    }

                    // Estilo en vivo
                    if (v >= 2.30) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });

                // Autoformatear al terminar de ingresar
                ['change', 'blur'].forEach(ev => talla.addEventListener(ev, normalizarTalla));

                // Normalizar si ya viene con valor al cargar
                if (talla.value) { normalizarTalla(); }
            }

            // Disparar validaciones iniciales si ya hay valores cargados
            [
                'presion_sistolica', 'presion_diastolica', 'hba1c', 'hgt', 'talla', 'col', 'ldl', 'tag'
            ].forEach(name => {
                const el = document.querySelector(`input[name="${name}"]`);
                if (el && el.value) {
                    try { el.dispatchEvent(new Event('input')); } catch (e) {}
                }
            });
        }

        // (Compat) La versión por slug se eliminó; los encabezados usan toggleCategoria(contentId).

        // Función para expandir todas las categorías (proxy a nuevas utilidades)
        function expandirTodasCategorias() {
            if (typeof expandirTodasFamilias === 'function') {
                expandirTodasFamilias();
            }
        }

        // Función para contraer todas las categorías (proxy a nuevas utilidades)
        function contraerTodasCategorias() {
            if (typeof contraerTodasFamilias === 'function') {
                contraerTodasFamilias();
            }
        }

        // Función para expandir solo categorías con patologías seleccionadas (proxy)
        function expandirSoloSeleccionadas() {
            if (typeof expandirSoloSeleccionadasFamilias === 'function') {
                expandirSoloSeleccionadasFamilias();
            } else {
                // Fallback: al menos contraer todo usando el proxy anterior
                contraerTodasCategorias();
            }
        }

        // Función para actualizar contadores de categorías
        function actualizarContadoresCategorias() {
            const categorias = [
                'salud-mental',
                'metabolicas-endocrinas',
                'cardiovasculares',
                'respiratorias',
                'renales-urologicas',
                'digestivas',
                'musculo-esqueleticas',
                'neurologicas',
                'inmunologicas-hematologicas',
                'oftalmologicas',
                'otorrinolaringologicas',
                'socioeconomicas-psicosociales',
                'funcionalidad-discapacidad',
                'oncologicas',
                'dermatologicas'
            ];

            let totalSeleccionadas = 0;

            categorias.forEach(categoriaId => {
                const content = document.getElementById('content-' + categoriaId);
                const badge = document.getElementById('badge-' + categoriaId);
                
                if (content && badge) {
                    const checkboxes = content.querySelectorAll('.patologia-checkbox:checked');
                    const count = checkboxes.length;
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'inline' : 'none';
                    totalSeleccionadas += count;
                }
            });

            // Actualizar el botón principal con el conteo total
            const btnToggle = document.getElementById('btn-toggle-patologias');
            if (btnToggle) {
                const container = document.getElementById('patologias-main-container');
                const isHidden = container && container.style.display === 'none';
                
                if (isHidden) {
                    if (totalSeleccionadas > 0) {
                        btnToggle.innerHTML = `👁️ Mostrar Patologías (${totalSeleccionadas} seleccionadas)`;
                    } else {
                        btnToggle.innerHTML = '👁️ Mostrar Patologías';
                    }
                } else {
                    if (totalSeleccionadas > 0) {
                        btnToggle.innerHTML = `🙈 Ocultar Patologías (${totalSeleccionadas} seleccionadas)`;
                    } else {
                        btnToggle.innerHTML = '🙈 Ocultar Patologías';
                    }
                }
            }
        }

        // Función para cargar datos del usuario por RUN
        function cargarDatosUsuario(run) {
            if (!run || run.length < 3) return;
            
            const loading = document.getElementById('loading');
            const encontrado = document.getElementById('usuario-encontrado');
            
            loading.style.display = 'block';
            encontrado.style.display = 'none';
            
            fetch(`/api/usuario/${run}`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.error) {
                        // Usuario no encontrado - limpiar formulario (solo si no hay error global)
                        if (!window.HAS_ERROR) {
                            limpiarFormulario();
                            limpiarPatologiasGuardadas();
                        }
                        return;
                    }
                    
                    // Usuario encontrado - llenar formulario
                    const usuario = data.usuario;
                    const patologias = data.patologias || [];
                    
                    // Llenar datos básicos
                    document.getElementById('nombre').value = usuario.nombre || '';
                    document.getElementById('fecha_nacimiento').value = usuario.fecha_nacimiento || '';
                    if (typeof actualizarRangoFechaNacimiento === 'function') { actualizarRangoFechaNacimiento(); }
                    if (typeof actualizarEdad === 'function') { actualizarEdad(); }
                    document.getElementById('direccion').value = usuario.direccion || '';
                    document.getElementById('telefono').value = usuario.telefono || '';
                    document.getElementById('sexo').value = usuario.sexo || '';
                    document.getElementById('categoria_id').value = usuario.categoria_id || '';
                    document.getElementById('sector_id').value = usuario.sector_id || '';
                    document.getElementById('fecha_ingreso').value = usuario.fecha_ingreso || '';
                    
                    // Limpiar patologías actuales
                    document.querySelectorAll('.patologia-checkbox').forEach(cb => cb.checked = false);
                    
                    // Marcar patologías del usuario
                    patologias.forEach(patologia => {
                        // Buscar checkbox por código CIE10 (necesitarás un mapeo inverso)
                        const checkbox = encontrarCheckboxPorCIE10(patologia.cie10);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                    
                    // Actualizar interfaz
                    calcularRiesgo();
                    actualizarResumenPatologias();
                    actualizarContadoresCategorias();
                    actualizarPatologiasGuardadas(patologias);
                    
                    // No cargar IMC aquí (deshabilitado por solicitud)
                    
                    encontrado.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading.style.display = 'none';
                });
        }
        
        // Función auxiliar para encontrar checkbox por código CIE10
        function encontrarCheckboxPorCIE10(codigoCIE10) {
            // Mapeo de códigos CIE10 a valores de checkbox
            const mapaCIE10 = {
                'F11': 'abuso_dependencia_opiaceos',
                'F12': 'abuso_dependencia_cannabinoides',
                'F13': 'abuso_dependencia_sedantes_hipnoticos',
                'F14': 'abuso_dependencia_cocaina',
                'F15': 'abuso_dependencia_estimulantes',
                'F16': 'abuso_dependencia_alucinogenos',
                'F18': 'abuso_dependencia_inhalantes',
                'F19': 'abuso_dependencia_multiples_drogas',
                'F10': 'alcoholismo',
                'F17': 'tabaquismo',
                'F31': 'trastorno_bipolar',
                'F32': 'episodio_depresivo_mayor',
                'F33': 'trastorno_depresivo_recurrente',
                'F43.2': 'trastorno_adaptacion_depresion',
                'F41.1': 'trastorno_ansiedad_generalizada',
                'F41.0': 'trastorno_panico',
                'F43.1': 'trastorno_estres_postraumatico',
                'F60.2': 'trastorno_personalidad_antisocial',
                'F60.3': 'trastorno_personalidad_limite',
                'F20': 'esquizofrenia',
                'F23': 'trastorno_psicotico_breve',
                'F22': 'trastorno_delirante',
                'F03': 'demencia_alzheimer',
                'F01': 'demencia_vascular',
                'F06.7': 'deterioro_cognitivo_leve',
                'F90': 'trastorno_deficit_atencion',
                'F84': 'trastorno_espectro_autista',
                'F70-F79': 'discapacidad_intelectual',
                'F50': 'trastorno_alimentario',
                'F45': 'trastorno_somatico',
                'F44': 'trastorno_conversion',
                'F51': 'trastorno_sueno',
                'R45.851': 'ideacion_suicida',
                'T14.91': 'intento_suicidio',
                'E10': 'diabetes_mellitus_tipo1',
                'E11': 'diabetes_mellitus_tipo2',
                'O24': 'diabetes_gestacional',
                'R73.03': 'prediabetes',
                'E66.01': 'obesidad_grado1',
                'E66.3': 'sobrepeso',
                'R63.6': 'bajo_peso',
                'E03': 'hipotiroidismo',
                'E05': 'hipertiroidismo',
                'E04': 'bocio',
                'E04.1': 'nodulo_tiroideo',
                'E88.81': 'sindrome_metabolico',
                'E78': 'dislipidemia',
                'E78.0': 'hipercolesterolemia',
                'E78.1': 'hipertrigliceridemia',
                'E79.0': 'hiperuricemia',
                'M10': 'gota',
                'M81': 'osteoporosis',
                'M85.8': 'osteopenia',
                'E55': 'deficiencia_vitamina_d',
                'E53.8': 'deficiencia_vitamina_b12',
                'D50': 'anemia_ferropenica',
                'E27': 'insuficiencia_suprarrenal',
                'E28.2': 'sindrome_ovario_poliquistico',
                'N95.1': 'menopausia',
                'E89.5': 'andropausia',
                'E01': 'trastornos_tiroideos_deficiencia_yodo',
                'E02': 'hipotiroidismo_subclinico_deficiencia_yodo',
                'I10': 'hipertension_arterial',
                'I15': 'hipertension_secundaria',
                'I16': 'crisis_hipertensiva',
                'I25': 'cardiopatia_isquemica',
                'I21': 'infarto_agudo_miocardio',
                'I20': 'angina_pecho',
                'I50': 'insuficiencia_cardiaca',
                'I49': 'arritmia_cardiaca',
                'I48': 'fibrilacion_auricular',
                'I48.3': 'flutter_auricular',
                'I47.1': 'taquicardia_supraventricular',
                'I47.2': 'taquicardia_ventricular',
                'R00.1': 'bradicardia',
                'I44': 'bloqueo_cardiaco',
                'I35-I39': 'valvulopatia',
                'I33': 'endocarditis',
                'I42': 'miocardiopatia',
                'I30': 'pericarditis',
                'I73': 'enfermedad_vascular_periferica',
                'I80': 'trombosis_venosa_profunda',
                'I26': 'embolia_pulmonar',
                'I71': 'aneurisma_aorta',
                'I71.0': 'diseccion_aorta',
                'I70': 'aterosclerosis',
                'I64': 'accidente_cerebrovascular',
                'G93.1': 'ataque_isquemico_transitorio',
                'I61': 'hemorragia_intracerebral',
                'I60': 'hemorragia_subaracnoidea',
                'Q20-Q28': 'cardiopatia_congenita',
                'I05-I09': 'cardiopatia_reumatica',
                'I27': 'cor_pulmonale',
                'R57.0': 'shock_cardiogenico',
                'I46': 'parada_cardiaca'
                // Agregar más mapeos según sea necesario...
            };
            
            const valorCheckbox = mapaCIE10[codigoCIE10];
            if (valorCheckbox) {
                return document.getElementById(`pat_${valorCheckbox}`);
            }
            return null;
        }

        // COMENTADO: Ya se maneja en DOMContentLoaded principal
        /*
        // Inicializar validaciones cuando la página esté lista
        document.addEventListener('DOMContentLoaded', function() {
            validarRangosMedicos();
            
            // REMOVIDO: Event listener problemático que limpiaba el RUN
            // El manejo de búsqueda se hace solo con manejarBusquedaRun()
            
            // Agregar event listeners a checkboxes de patologías ECICEP
            const checkboxesPatologias = document.querySelectorAll('.patologia-checkbox');
            checkboxesPatologias.forEach(cb => {
                cb.addEventListener('change', function() {
                    calcularRiesgo();
                    actualizarResumenPatologias();
                    actualizarContadoresCategorias();

                    // Guardar automáticamente la categoría en la BD (debounce)
                    if (typeof scheduleGuardarCategoria === 'function') {
                        scheduleGuardarCategoria();
                    }
                });
            });
            
            // Inicializar cálculo de riesgo y contadores
            calcularRiesgo();
            actualizarContadoresCategorias();

            // Inicializar color del select de categoría
            colorearSelectCategoria();
            
            // Función para limpiar formulario también debe actualizar resumen y cálculo
            const originalLimpiar = window.limpiarFormulario;
            window.limpiarFormulario = function() {
                if (originalLimpiar) originalLimpiar();
                
                // Limpiar checkboxes de patologías ECICEP
                document.querySelectorAll('.patologia-checkbox').forEach(cb => cb.checked = false);
                
                // Limpiar patologías guardadas
                limpiarPatologiasGuardadas();
                
                calcularRiesgo();
                actualizarResumenPatologias();
                actualizarContadoresCategorias();
            };
        });
        */

        // ===== Guardado automático de categoria =====
        let _guardarCategoriaTimeout = null;
        function scheduleGuardarCategoria() {
            clearTimeout(_guardarCategoriaTimeout);
            _guardarCategoriaTimeout = setTimeout(() => {
                guardarCategoriaActual();
            }, 800);
        }

        function guardarCategoriaActual() {
            try {
                const run = document.getElementById('run').value.trim();
                const categoriaSelect = document.getElementById('categoria_id');
                if (!run || !categoriaSelect) return;

                const payload = { categoria_id: categoriaSelect.value || null };

                fetch(`/api/usuario/${encodeURIComponent(run)}/categoria`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data && data.success) {
                        // aplicar color al select según la categoría guardada
                        colorearSelectCategoria();
                    } else {
                        console.error('Error guardando categoria:', data && data.error);
                    }
                }).catch(err => console.error('Error guardando categoria (fetch):', err));
            } catch (e) {
                console.error('Error en guardarCategoriaActual:', e);
            }
        }

        function colorearSelectCategoria() {
            try {
                const categoriaSelect = document.getElementById('categoria_id');
                if (!categoriaSelect) return;
                const val = categoriaSelect.value;
                if (val === '1') {
                    categoriaSelect.style.background = '#198754';
                    categoriaSelect.style.color = '#fff';
                } else if (val === '2') {
                    categoriaSelect.style.background = '#ffc107';
                    categoriaSelect.style.color = '#000';
                } else if (val === '3') {
                    categoriaSelect.style.background = '#dc3545';
                    categoriaSelect.style.color = '#fff';
                } else {
                    categoriaSelect.style.background = '';
                    categoriaSelect.style.color = '';
                }
            } catch (e) {
                // ignore
            }
        }
        // ===== fin guardado automático de categoria =====

        // Función para mostrar los botones de gestión cuando hay patologías
        function mostrarBotonesGestion() {
            const botones = document.getElementById('botones-gestion-patologias');
            if (botones) {
                botones.style.display = 'block';
                const btn = document.getElementById('btn-modificar-patologias');
                if (btn) {
                    btn.disabled = false;
                    btn.setAttribute('aria-disabled', 'false');
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        }

        // Función para ocultar los botones de gestión
        function ocultarBotonesGestion() {
            console.log('🔒 Deshabilitando botones de gestión de patologías...');
            
            const container = document.getElementById('botones-gestion-patologias');
            const btnGuardarPatologias = document.getElementById('btn-guardar-patologias');
            const btnModificarPatologias = document.getElementById('btn-modificar-patologias');
            
            if (container) {
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
                
                // Mostrar el mensaje de ayuda
                const helpText = container.querySelector('small');
                if (helpText) {
                    helpText.style.display = 'block';
                    console.log('💡 Mensaje de ayuda mostrado');
                }
            }
            
            if (btnGuardarPatologias) {
                btnGuardarPatologias.disabled = true;
                btnGuardarPatologias.style.cursor = 'not-allowed';
                btnGuardarPatologias.style.opacity = '0.5';
                btnGuardarPatologias.title = 'Ingrese un RUN válido para habilitar';
                console.log('🔒 Botón "Guardar Patologías" deshabilitado');
            }
            
            if (btnModificarPatologias) {
                btnModificarPatologias.disabled = true;
                btnModificarPatologias.setAttribute('aria-disabled', 'true');
                btnModificarPatologias.style.opacity = '0.5';
                btnModificarPatologias.style.cursor = 'not-allowed';
                btnModificarPatologias.title = 'Ingrese un RUN válido para habilitar';
                console.log('🔒 Botón "Modificar Patologías" deshabilitado');
            }
            
            console.log('✅ Botones de gestión deshabilitados');
        }

        // Función para modificar patologías (eliminar 1 o más patologías seleccionadas)
        function modificarPatologias(event) {
          // Solo abrir si viene de una interacción del usuario
          // Evita ejecuciones programáticas o en carga inicial
          if (!event || event.isTrusted !== true) return;
          const runActual = document.getElementById('run').value;
          if (!runActual) {
            alert('⚠️ No hay usuario seleccionado');
            return;
          }
          // Obtener las patologías guardadas
          fetch(`/api/usuario/${encodeURIComponent(runActual)}/patologias`)
            .then(response => response.json())
            .then(data => {
              if (data.patologias && data.patologias.length > 0) {
                mostrarModalSeleccionPatologias(data.patologias, runActual);
              } else {
                alert('❌ No hay patologías guardadas para modificar');
              }
            })
            .catch(error => {
              console.error('Error obteniendo patologías:', error);
              alert('❌ Error obteniendo patologías guardadas');
            });
        }

        // Función para mostrar modal con patologías para seleccionar cuáles eliminar
        function esPatologiaEliminable(cie10) {
            try {
                const c = String(cie10 || '').toUpperCase();
                if (!c) return false;
                const startsWithAny = (s, arr) => arr.some(p => s.startsWith(p));
                if (startsWithAny(c, ['F50', 'F33', 'F40', 'F41', 'F42', 'F51', 'G47', 'E66', 'Z56', 'Z57', 'Z58', 'Z59', 'Z62', 'Z63', 'Z65', 'I83', 'L97', 'T74', 'Y07'])) return true;
                if (['Z60.5', 'Z60.8', 'Z60.9', 'L98.4'].includes(c)) return true;
                if (c[0] === 'C') {
                    const n = parseInt(c.slice(1,3), 10);
                    if (!isNaN(n) && n >= 0 && n <= 97) return true;
                }
                if (c[0] === 'D') {
                    const n = parseInt(c.slice(1,3), 10);
                    if (!isNaN(n) && n >= 0 && n <= 48) return true; // D00..D48
                    if (['D63.0','D63.8'].includes(c)) return true;
                    if (['D50','D51','D52','D53','D55','D56','D57','D58','D59','D60','D61','D62','D64'].some(p => c.startsWith(p))) return true;
                }
                return false;
            } catch(e) { return false; }
        }

        function mostrarModalSeleccionPatologias(patologias, run) {
            // Contenedor overlay
            const overlay = document.createElement('div');
            overlay.id = 'modal-seleccion-patologias';
            overlay.setAttribute('style', 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;');

            // Caja modal - Mejorada para mejor visualización
            const box = document.createElement('div');
            box.setAttribute('style', 'background: white; padding: 25px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); font-family: Arial, sans-serif;');
            overlay.appendChild(box);

            // Título y descripción
            const h3 = document.createElement('h3');
            h3.textContent = '🗑️ Selecciona las patologías a eliminar';
            h3.setAttribute('style', 'margin-top: 0; margin-bottom: 15px; color: #dc2626; font-size: 20px; text-align: center;');
            box.appendChild(h3);

            const p = document.createElement('p');
            p.innerHTML = 'Marca las patologías que deseas eliminar.<br><small style="color:#b45309; font-weight: 500;">Solo algunas patologías son eliminables según reglas del sistema; las no permitidas aparecerán en gris.</small>';
            p.setAttribute('style', 'margin-bottom: 20px; color: #6b7280; text-align: center; line-height: 1.5;');
            box.appendChild(p);

            // Lista - Mejorada con mejor espaciado
            const listaDiv = document.createElement('div');
            listaDiv.id = 'lista-patologias-eliminar';
            listaDiv.setAttribute('style', 'max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; background: #fafafa;');
            box.appendChild(listaDiv);

            // Renderizar elementos
            if (Array.isArray(patologias) && patologias.length > 0) {
                patologias.forEach(p => {
                    const item = document.createElement('div');
                    item.setAttribute('style', 'margin-bottom: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; transition: all 0.2s ease;');

                    const label = document.createElement('label');
                    label.setAttribute('style', 'display: flex; align-items: flex-start; cursor: pointer; width: 100%;');
                    item.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'patologia-eliminar';
                    input.value = p.cie10;
                    input.setAttribute('style', 'margin-right: 12px; margin-top: 3px; width: 16px; height: 16px;');
                    const eliminable = esPatologiaEliminable(p.cie10);
                    if (!eliminable) {
                        input.disabled = true;
                    }
                    label.appendChild(input);

                    const info = document.createElement('div');
                    info.setAttribute('style', 'flex: 1; min-width: 0;');
                    
                    const title = document.createElement('div');
                    title.textContent = (p.nombre_patologia_cie10 || p.nombre || p.cie10);
                    title.setAttribute('style', 'font-weight: 600; color: #374151; font-size: 14px; line-height: 1.4; margin-bottom: 4px; word-wrap: break-word;');
                    
                    const sub = document.createElement('div');
                    sub.textContent = 'CIE10: ' + p.cie10 + (eliminable ? '' : ' • No eliminable');
                    sub.setAttribute('style', 'font-size: 12px; line-height: 1.3; ' + (eliminable ? 'color:#6b7280;' : 'color:#9ca3af; font-weight: 500;'));
                    
                    // Hover effect
                    item.addEventListener('mouseenter', function() {
                        if (eliminable) {
                            this.style.borderColor = '#3b82f6';
                            this.style.backgroundColor = '#f0f9ff';
                        }
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.borderColor = '#e5e7eb';
                        this.style.backgroundColor = 'white';
                    });
                    
                    if (!eliminable) {
                        item.style.opacity = '0.6';
                        item.style.backgroundColor = '#f5f5f5';
                    }
                    
                    info.appendChild(title);
                    info.appendChild(sub);
                    label.appendChild(info);

                    listaDiv.appendChild(item);
                });
            } else {
                const empty = document.createElement('div');
                empty.textContent = 'No hay patologías guardadas';
                empty.setAttribute('style', 'text-align:center; color:#666; padding: 40px; font-style: italic;');
                listaDiv.appendChild(empty);
            }

            // Nota - Mejorada
            const nota = document.createElement('div');
            nota.setAttribute('style', 'margin-top: 15px; padding: 12px; background: linear-gradient(145deg, #fef3c7, #fde68a); border-radius: 8px; font-size: 13px; border-left: 4px solid #f59e0b;');
            nota.innerHTML = '<strong>⚠️ Nota:</strong> Las patologías marcadas serán eliminadas permanentemente. Esta acción no se puede deshacer.';
            box.appendChild(nota);

            // Botonera selección - Mejorada
            const selRow = document.createElement('div');
            selRow.setAttribute('style', 'text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;');
            
            const btnSel = document.createElement('button');
            btnSel.textContent = '✓ Seleccionar Todas';
            btnSel.setAttribute('style', 'background: linear-gradient(145deg, #10b981, #059669); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnSel.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)'; });
            btnSel.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnSel.addEventListener('click', seleccionarTodasPatologias);
            
            const btnDes = document.createElement('button');
            btnDes.textContent = '✗ Deseleccionar Todas';
            btnDes.setAttribute('style', 'background: linear-gradient(145deg, #6b7280, #4b5563); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnDes.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)'; });
            btnDes.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnDes.addEventListener('click', deseleccionarTodasPatologias);
            
            selRow.appendChild(btnSel);
            selRow.appendChild(btnDes);
            box.appendChild(selRow);

            // Separador + acciones - Mejoradas
            const acciones = document.createElement('div');
            acciones.setAttribute('style', 'text-align: center; margin-top: 25px; border-top: 2px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;');
            
            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = '← Cancelar';
            btnCancelar.setAttribute('style', 'background: linear-gradient(145deg, #6b7280, #4b5563); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnCancelar.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)'; });
            btnCancelar.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnCancelar.addEventListener('click', cerrarModalSeleccion);
            
            const btnEliminar = document.createElement('button');
            btnEliminar.textContent = '🗑️ Eliminar Seleccionadas';
            btnEliminar.setAttribute('style', 'background: linear-gradient(145deg, #dc2626, #b91c1c); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnEliminar.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(220,38,38,0.3)'; });
            btnEliminar.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnEliminar.addEventListener('click', () => confirmarEliminacionSelectiva(run));
            
            acciones.appendChild(btnCancelar);
            acciones.appendChild(btnEliminar);
            box.appendChild(acciones);

            // Agregar al DOM con efecto de cierre mejorado
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    cerrarModalSeleccion();
                }
            });
            
            // Cerrar con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('modal-seleccion-patologias')) {
                    cerrarModalSeleccion();
                }
            });
            
            document.body.appendChild(overlay);
        }

        // Funciones auxiliares para el modal de selección
        function seleccionarTodasPatologias() {
            const checkboxes = document.querySelectorAll('input[name="patologia-eliminar"]');
            checkboxes.forEach(cb => { if (!cb.disabled) cb.checked = true; });
        }

        function deseleccionarTodasPatologias() {
            const checkboxes = document.querySelectorAll('input[name="patologia-eliminar"]');
            checkboxes.forEach(cb => cb.checked = false);
        }

        function cerrarModalSeleccion() {
            const modal = document.getElementById('modal-seleccion-patologias');
            if (modal) {
                modal.remove();
            }
        }

        function confirmarEliminacionSelectiva(run) {
            const checkboxes = document.querySelectorAll('input[name="patologia-eliminar"]:checked');
            
            if (checkboxes.length === 0) {
                alert('⚠️ Selecciona al menos una patología para eliminar');
                return;
            }

            const patologiasSeleccionadas = Array.from(checkboxes).map(cb => cb.value);
            
            if (!confirm(`⚠️ ¿Estás seguro de eliminar ${patologiasSeleccionadas.length} patología(s)?\n\nEsta acción NO se puede deshacer.`)) {
                return;
            }

            // Solicitar contraseña del usuario
            const password = prompt('🔐 Ingresa tu contraseña para confirmar la eliminación:');
            
            if (!password) {
                alert('❌ Operación cancelada - Se requiere contraseña');
                return;
            }

            // Eliminar las patologías seleccionadas
            eliminarPatologiasSeleccionadas(run, patologiasSeleccionadas, password);
        }

        function eliminarPatologiasSeleccionadas(run, patologiasCIE10, password) {
            console.log('🗑️ Eliminando patologías seleccionadas:', patologiasCIE10);
            
            fetch('/api/eliminar_patologias_selectivas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    run: run,
                    patologias_cie10: patologiasCIE10,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ ${patologiasCIE10.length} patología(s) eliminada(s) exitosamente`);
                    
                    // Cerrar el modal
                    cerrarModalSeleccion();
                    
                    // Recargar las patologías guardadas
                    cargarPatologiasGuardadas(run);
                    
                } else {
                    alert('❌ Error: ' + (data.error || 'No se pudieron eliminar las patologías'));
                }
            })
            .catch(error => {
                console.error('❌ Error eliminando patologías:', error);
                alert('❌ Error de conexión al eliminar patologías');
            });
        }

    // IMC display removed — funciones eliminadas por request

        // Función para modificar patologías (eliminar solo algunas)
        function modificarPatologias_old() {
            const run = document.getElementById('run').value.trim();
            if (!run) {
                alert('Ingrese un RUN válido');
                return;
            }

            // Mostrar modal de modificación
            mostrarModalModificacion(run);
        }

        // Función para mostrar modal de modificación de patologías (versión programática)
        function mostrarModalModificacion(run) {
            const overlay = document.createElement('div');
            overlay.id = 'modal-modificacion';
            overlay.setAttribute('style', 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;');

            const box = document.createElement('div');
            box.setAttribute('style', 'background: white; border-radius: 8px; padding: 20px; max-width: 600px; max-height: 80%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);');
            overlay.appendChild(box);

            const h3 = document.createElement('h3');
            h3.textContent = '✏️ Modificar Patologías';
            h3.setAttribute('style', 'margin-top: 0; color: #f59e0b;');
            box.appendChild(h3);

            const prun = document.createElement('p');
            prun.innerHTML = 'RUN: <strong></strong>';
            prun.querySelector('strong').textContent = run;
            box.appendChild(prun);

            const lista = document.createElement('div');
            lista.id = 'lista-patologias-modificar';
            lista.setAttribute('style', 'max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; margin: 10px 0;');
            const loading = document.createElement('div');
            loading.setAttribute('style', 'text-align: center; color: #666;');
            loading.textContent = 'Cargando patologías...';
            lista.appendChild(loading);
            box.appendChild(lista);

            const actions = document.createElement('div');
            actions.setAttribute('style', 'margin-top: 15px; text-align: right;');
            const btnCancel = document.createElement('button');
            btnCancel.textContent = 'Cancelar';
            btnCancel.setAttribute('style', 'background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 8px; cursor: pointer;');
            btnCancel.addEventListener('click', cerrarModalModificacion);
            const btnApply = document.createElement('button');
            btnApply.textContent = 'Aplicar Cambios';
            btnApply.setAttribute('style', 'background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;');
            btnApply.addEventListener('click', aplicarModificaciones);
            actions.appendChild(btnCancel);
            actions.appendChild(btnApply);
            box.appendChild(actions);

            document.body.appendChild(overlay);

            // Cargar patologías del usuario
            cargarPatologiasParaModificar(run);
        }

        // Función para cargar patologías en el modal de modificación (programática)
        function cargarPatologiasParaModificar(run) {
            const container = document.getElementById('lista-patologias-modificar');
            if (!container) return;

            fetch(`/api/usuario/${run}/patologias`)
                .then(response => response.json())
                .then(data => {
                    container.innerHTML = '';
                    if (data && data.success && Array.isArray(data.patologias) && data.patologias.length > 0) {
                        const titulo = document.createElement('div');
                        titulo.setAttribute('style', 'margin-bottom: 10px;');
                        titulo.innerHTML = '<strong>Seleccione las patologías a ELIMINAR:</strong>';
                        container.appendChild(titulo);

                        data.patologias.forEach(patologia => {
                            const item = document.createElement('div');
                            item.setAttribute('style', 'margin-bottom: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;');
                            const label = document.createElement('label');
                            label.setAttribute('style', 'display: flex; align-items: flex-start; cursor: pointer;');
                            const input = document.createElement('input');
                            input.type = 'checkbox';
                            input.className = 'patologia-eliminar';
                            input.value = patologia.cie10;
                            input.setAttribute('style', 'margin-right: 8px; margin-top: 2px;');
                            const info = document.createElement('div');
                            const nombre = document.createElement('div');
                            nombre.textContent = patologia.nombre_patologia_cie10;
                            nombre.setAttribute('style', 'font-weight: 500; color: #374151;');
                            const cie = document.createElement('div');
                            cie.textContent = 'CIE10: ' + patologia.cie10;
                            cie.setAttribute('style', 'font-size: 12px; color: #6b7280;');
                            info.appendChild(nombre);
                            info.appendChild(cie);
                            label.appendChild(input);
                            label.appendChild(info);
                            item.appendChild(label);
                            container.appendChild(item);
                        });

                        const nota = document.createElement('div');
                        nota.setAttribute('style', 'margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;');
                        nota.innerHTML = '<strong>⚠️ Nota:</strong> Las patologías marcadas serán eliminadas permanentemente.';
                        container.appendChild(nota);
                    } else {
                        const empty = document.createElement('div');
                        empty.setAttribute('style', 'text-align: center; color: #666;');
                        empty.textContent = 'No hay patologías para modificar';
                        container.appendChild(empty);
                    }
                })
                .catch(error => {
                    console.error('Error cargando patologías:', error);
                    container.innerHTML = '<div style="text-align: center; color: #ef4444;">Error cargando patologías</div>';
                });
        }

        // Función para cerrar el modal de modificación
        function cerrarModalModificacion() {
            const modal = document.getElementById('modal-modificacion');
            if (modal) {
                modal.remove();
            }
        }

        // Función para aplicar las modificaciones
        function aplicarModificaciones() {
            const checkboxes = document.querySelectorAll('.patologia-eliminar:checked');
            
            if (checkboxes.length === 0) {
                alert('Seleccione al menos una patología para eliminar');
                return;
            }

            const cie10sEliminar = Array.from(checkboxes).map(cb => cb.value);
            const count = cie10sEliminar.length;

            if (!confirm(`¿Está seguro de eliminar ${count} patología(s) seleccionada(s)?`)) {
                return;
            }

            // Solicitar contraseña
            const password = prompt('Ingrese su contraseña para confirmar la eliminación:');
            if (!password) {
                return;
            }

            const run = document.getElementById('run').value.trim();

            // Enviar solicitud de eliminación selectiva
            fetch('/api/eliminar_patologias_selectivas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    run: run,
                    password: password,
                    cie10s_eliminar: cie10sEliminar
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ ${count} patología(s) eliminada(s) exitosamente`);
                    cerrarModalModificacion();
                    // Actualizar la vista de patologías guardadas
                    actualizarPatologiasGuardadas();
                } else {
                    alert(`❌ Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error eliminando patologías');
            });
        }

        // Función para marcar checkboxes de patologías guardadas y expandir categorías
        function marcarPatologiasGuardadas(patologias) {
            try {
                if (!Array.isArray(patologias)) return;
                const categoriasConPatologias = new Set();
                patologias.forEach(p => {
                    const c10 = (p.cie10 || '').toUpperCase();
                    if (!c10) return;
                    const cb = document.querySelector(`input.patologia-checkbox[value="${c10}"]`)
                           || document.querySelector(`input[name="patologia[]"][value="${c10}"]`);
                    if (!cb) return;
                    cb.checked = true;
                    const fam = cb.closest('.familia-content');
                    if (fam && fam.classList.contains('collapsed')) {
                        fam.classList.remove('collapsed');
                        const famToggle = fam.closest('.familia')?.querySelector('.familia-toggle');
                        if (famToggle) famToggle.textContent = '−';
                    }
                    const cat = cb.closest('.categoria-seccion');
                    if (cat && cat.id) categoriasConPatologias.add(cat.id);
                });
                categoriasConPatologias.forEach(id => expandirCategoria(id));
                try {
                    if (typeof calcularRiesgo === 'function') calcularRiesgo();
                    if (typeof actualizarResumenPatologias === 'function') actualizarResumenPatologias();
                    if (typeof actualizarContadoresCategorias === 'function') actualizarContadoresCategorias();
                } catch (e) {}
            } catch (e) {
                console.warn('No se pudieron marcar patologías guardadas:', e);
            }
        }

        // Función para crear mapeo CIE10 -> valor de formulario
        async function crearMapeoPatologias() {
            try {
                const response = await fetch('/api/mapeo_cie10_formulario');
                if (response.ok) {
                    const data = await response.json();
                    return data.mapeo || {};
                }
            } catch (error) {
                console.error('Error obteniendo mapeo CIE10:', error);
            }
            return {};
        }

        // Función para expandir una categoría específica
        function expandirCategoria(categoriaId) {
            const categoria = document.getElementById(categoriaId);
            if (!categoria) return;
            const toggle = categoria.querySelector('.categoria-toggle');
            const contenido = categoria.querySelector('.categoria-content');
            if (contenido && contenido.classList.contains('collapsed')) {
                contenido.classList.remove('collapsed');
            }
            if (toggle) toggle.textContent = '−';
        }

        // Funciones heredadas (mantener compatibilidad)
        function mostrarBotonEliminar() {
            mostrarBotonesGestion();
        }

        function ocultarBotonEliminar() {
            ocultarBotonesGestion();
        }
    </script>
<!-- Coloca el siguiente bloque al final, antes de </body> -->
<script>
// ========= CÁLCULO DE RIESGO ECICEP (por FAMILIA, solo 1 y 2 pts) =========
function calcularRiesgo() {
  let total = 0;
  document.querySelectorAll('.familia').forEach(fam => {
    const pts = parseInt(fam.getAttribute('data-points'), 10);
    if (pts === 1 || pts === 2) {
      const tieneSeleccion = !!fam.querySelector('.familia-content input[type="checkbox"]:checked');
      if (tieneSeleccion) total += pts;
    }
  });
  const totalEl = document.getElementById('total-puntos');
  if (totalEl) totalEl.textContent = String(total);
  let categoria = 'G0';
  let bg = '#e9ecef';
  let fg = '#000';
  if (total === 1) { categoria = 'G1'; bg = '#198754'; fg = '#fff'; }
  else if (total >= 2 && total <= 4) { categoria = 'G2'; bg = '#ffc107'; fg = '#000'; }
  else if (total >= 5) { categoria = 'G3'; bg = '#dc3545'; fg = '#fff'; }
  const catEl = document.getElementById('categoria-riesgo');
  if (catEl) {
    catEl.textContent = categoria;
    catEl.style.backgroundColor = bg;
    catEl.style.color = fg;
  }
}

function actualizarResumenPatologias() {
  const container = document.getElementById('patologias-badges');
  if (!container) return;
  const checkboxes = document.querySelectorAll('input[name="patologia[]"]:checked, input.patologia-checkbox:checked');
  container.innerHTML = '';
  if (checkboxes.length === 0) {
    container.innerHTML = '<span class="pat-empty">Sin patologías seleccionadas</span>';
    return;
  }

  // Agrupar por familia y categoría
  const familias = {};
  checkboxes.forEach(cb => {
    // Buscar el contenedor .familia más cercano
    const familiaDiv = cb.closest('.familia');
    if (!familiaDiv) return;
    const familiaId = familiaDiv.getAttribute('data-familia-id') || 'sin-familia';
    // Personalización para insuficiencia cardíaca
    let familiaNombre = familiaDiv.querySelector('.familia-header')?.childNodes[1]?.textContent?.trim() || 'Sin familia';
    let familiaIcono = '';
    if (familiaId === 'fam-ic') {
      familiaNombre = '❤️‍🩹 INSUFICIENCIA CARDIACA';
      familiaIcono = '❤️‍🩹';
    }
    // Buscar la categoría (padre de familia)
    const categoriaDiv = familiaDiv.closest('.categoria-seccion');
    const categoriaNombre = categoriaDiv ? categoriaDiv.querySelector('h4')?.textContent?.trim() : 'Sin categoría';
    const categoriaIcono = categoriaDiv ? categoriaDiv.querySelector('h4')?.innerHTML?.split(' ')[0] : '';
    if (!familias[familiaId]) {
      familias[familiaId] = {
        nombre: familiaNombre,
        icono: familiaIcono,
        categoria: categoriaNombre,
        categoriaIcono: categoriaIcono,
        patologias: []
      };
    }
    const label = cb.parentElement.textContent.trim();
    familias[familiaId].patologias.push({
      label: label,
      checked: cb.checked,
      id: cb.id
    });
  });

  // Agrupar familias por categoría
  const categorias = {};
  Object.values(familias).forEach(fam => {
    if (!categorias[fam.categoria]) {
      categorias[fam.categoria] = {
        icono: fam.icono,
        familias: []
      };
    }
    categorias[fam.categoria].familias.push(fam);
  });

  // Renderizar agrupado
  Object.entries(categorias).forEach(([catNombre, catData]) => {
    const catDiv = document.createElement('div');
    catDiv.className = 'resumen-categoria';
    catDiv.innerHTML = `<strong>${catData.icono ? catData.icono + ' ' : ''}${catNombre}</strong>`;
    catData.familias.forEach(fam => {
      const famDiv = document.createElement('div');
      famDiv.className = 'resumen-familia';
      // Si es insuficiencia cardiaca, mostrar icono especial
      if (fam.icono) {
        famDiv.innerHTML = `<span style=\"font-weight:600; color:#0d6efd;\">${fam.icono} ${fam.nombre}</span>`;
      } else {
        famDiv.innerHTML = `<span style=\"font-weight:600; color:#0d6efd;\">${fam.nombre}</span>`;
      }
      fam.patologias.forEach(pat => {
        const patDiv = document.createElement('div');
        patDiv.className = 'resumen-patologia';
        patDiv.innerHTML = `<input type=\"checkbox\" checked disabled> <span>${pat.label}</span>`;
        famDiv.appendChild(patDiv);
      });
      catDiv.appendChild(famDiv);
    });
    container.appendChild(catDiv);
  });

  // Habilitar solo si hay alguna patología relacionada con diabetes
  try {
    const hbaInput = document.querySelector('input[name="hba1c"]');
    if (hbaInput) {
      const hasDiabetes = Array.from(checkboxes).some(cb => cb.parentElement.textContent.toLowerCase().includes('diabet'));
      hbaInput.disabled = !hasDiabetes;
    }
  } catch (e) {}
}


// COMENTADO: Ya se maneja en DOMContentLoaded principal
/*
// Mostrar todas las familias contraídas por defecto al cargar

// Mostrar todas las familias y categorías contraídas por defecto al cargar
document.addEventListener('DOMContentLoaded', () => {
  // Debug: contar cuántas categorías hay
  const categorias = document.querySelectorAll('.categoria-seccion');
  console.log('🔍 Total de categorías encontradas:', categorias.length);
  categorias.forEach((cat, index) => {
    console.log(`📁 Categoría ${index + 1}:`, cat.id, cat.style.display);
  });
  
  document.querySelectorAll('.categoria-content').forEach(cat => cat.classList.add('collapsed'));
  document.querySelectorAll('.familia-content').forEach(fam => fam.classList.add('collapsed'));
  document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '+');
  document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '+');
  
  // Agregar listeners para actualizar resumen de patologías
  document.querySelectorAll('.familia input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      calcularRiesgo();
      actualizarResumenPatologias();
    });
  });
  
  calcularRiesgo();
  actualizarResumenPatologias();
});
*/
</script>

<!-- SCRIPT SIMPLIFICADO PARA RUN - TIENE PRIORIDAD -->
<script>
console.log('🔧 Script simplificado cargando...');

// TEST: Verificar que JavaScript funciona
console.log('✅ JavaScript está funcionando correctamente');

// Función que se ejecuta inmediatamente cuando el DOM está listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM listo, configurando RUN...');
    
    const runInput = document.getElementById('run');
    console.log('📍 Buscando campo RUN...', runInput);
    
    if (!runInput) {
        console.error('❌ Campo RUN no encontrado');
        return;
    }
    
    console.log('✅ Campo RUN encontrado, ID:', runInput.id);
    
    let timeoutBusqueda;
    // Estado para auto-limpiar cuando se ingresa un nuevo RUN
    let prevRunClean = '';
    let loadedRunClean = '';
    let formClearedForTyping = false;
    
    // Función simple para formatear RUN
    function formatearRUN(input) {
        console.log('🎨 Formateando RUN, valor original:', input.value);
        
        let valor = input.value.replace(/[^0-9kK]/g, '').toUpperCase();
        console.log('📝 Valor limpio:', valor);
        
        if (valor.length > 1) {
            const cuerpo = valor.slice(0, -1);
            const dv = valor.slice(-1);
            const cuerpoFormateado = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = cuerpoFormateado + '-' + dv;
        } else {
            input.value = valor;
        }
        
        console.log('✨ RUN formateado:', input.value);
    }
    
    // Función simple para validar RUN
    function validarRUN(run) {
        console.log('🔍 Validando RUN:', run);
        
        const limpio = run.replace(/[^0-9kK]/gi, '');
        if (limpio.length < 8) {
            console.log('⏳ RUN muy corto:', limpio.length);
            return false;
        }
        
        const cuerpo = limpio.slice(0, -1);
        const dv = limpio.slice(-1).toUpperCase();
        
        console.log('🔍 Cuerpo:', cuerpo, 'DV:', dv);
        
        let suma = 0;
        let multiplicador = 2;
        
        // Procesar dígitos de derecha a izquierda
        for (let i = cuerpo.length - 1; i >= 0; i--) {
            const digito = parseInt(cuerpo[i]);
            const producto = digito * multiplicador;
            suma += producto;
            console.log(`  Posición ${i}: ${digito} × ${multiplicador} = ${producto} (suma acumulada: ${suma})`);
            
            // Incrementar multiplicador de 2 a 7, luego volver a 2
            multiplicador++;
            if (multiplicador > 7) {
                multiplicador = 2;
            }
        }
        
        const resto = suma % 11;
        const dvCalculado = resto < 2 ? resto.toString() : (resto === 10 ? 'K' : (11 - resto).toString());
        
        const esValido = dv === dvCalculado;
        console.log('🔍 Validación detallada:', { 
            cuerpo, 
            dv, 
            suma, 
            resto, 
            dvCalculado, 
            esValido 
        });
        
        return esValido;
    }
    
    // Función para buscar usuario
    function buscarUsuario(run) {
        console.log('🔍 INICIANDO BÚSQUEDA para RUN:', run);
        
        fetch('/usuario/buscar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ run: run })
        })
        .then(response => {
            console.log('📡 Respuesta recibida, status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📥 Datos recibidos:', data);
            
            if (data.encontrado) {
                console.log('✅ USUARIO ENCONTRADO:', data.nombre);
                // Registrar RUN cargado para detectar cambios posteriores
                loadedRunClean = (run || '').replace(/[^0-9kK]/gi, '').toUpperCase();
                formClearedForTyping = false; // permitir limpiar si el usuario empieza a escribir otro RUN
                
                // Autocompletar campos uno por uno
                if (data.nombre) {
                    const nombreInput = document.getElementById('nombre');
                    if (nombreInput) {
                        nombreInput.value = data.nombre;
                        console.log('✅ Nombre completado:', data.nombre);
                    }
                }
                
                if (data.fecha_nacimiento) {
                    const fechaInput = document.getElementById('fecha_nacimiento');
                    if (fechaInput) {
                        fechaInput.value = data.fecha_nacimiento;
                        console.log('✅ Fecha nacimiento completada:', data.fecha_nacimiento);
                        if (typeof actualizarRangoFechaNacimiento === 'function') { actualizarRangoFechaNacimiento(); }
                        if (typeof actualizarEdad === 'function') { actualizarEdad(); }
                    }
                }
                
                if (data.direccion) {
                    const direccionInput = document.getElementById('direccion');
                    if (direccionInput) {
                        direccionInput.value = data.direccion;
                        console.log('✅ Dirección completada:', data.direccion);
                    }
                }
                
                if (data.telefono) {
                    const telefonoInput = document.getElementById('telefono');
                    if (telefonoInput) {
                        telefonoInput.value = data.telefono;
                        console.log('✅ Teléfono completado:', data.telefono);
                    }
                }
                
                // Actualizar tablas de exámenes y acuerdos
                try {
                    console.log('🧾 Actualizando acuerdos y exámenes...');
                    if (typeof actualizarTablaAcuerdos === 'function') {
                        actualizarTablaAcuerdos(Array.isArray(data.acuerdos) ? data.acuerdos : []);
                    }
                    if (typeof actualizarTablaExamenes === 'function') {
                        actualizarTablaExamenes(Array.isArray(data.examenes) ? data.examenes : []);
                    }
                } catch (e) { console.warn('No se pudieron actualizar tablas:', e); }

                // Mostrar mensaje de éxito y estados
                console.log('🎉 AUTOCOMPLETADO EXITOSO');
                const encontradoDiv = document.getElementById('usuario-encontrado');
                if (encontradoDiv) encontradoDiv.style.display = 'block';
                const mensajeNuevo = document.getElementById('usuario-nuevo');
                if (mensajeNuevo) mensajeNuevo.style.display = 'none';

                // Cargar patologías guardadas en BD
                try { if (typeof cargarPatologiasGuardadas === 'function') cargarPatologiasGuardadas(run); } catch (e) {}
                
            } else {
                console.log('ℹ️ Usuario no encontrado');
                // Mostrar mensaje y limpiar tablas para nuevo usuario
                const encontradoDiv = document.getElementById('usuario-encontrado');
                if (encontradoDiv) encontradoDiv.style.display = 'none';
                const mensajeNuevo = document.getElementById('usuario-nuevo') || crearMensajeNuevoUsuario();
                if (mensajeNuevo) mensajeNuevo.style.display = 'block';
                try {
                    if (typeof actualizarTablaAcuerdos === 'function') actualizarTablaAcuerdos([]);
                    if (typeof actualizarTablaExamenes === 'function') actualizarTablaExamenes([]);
                } catch (e) {}
            }
        })
        .catch(error => {
            console.error('❌ Error en búsqueda:', error);
        });
    }
    
    // CONFIGURAR EVENT LISTENER
    console.log('🔗 Configurando event listener...');
    
    runInput.addEventListener('input', function(e) {
        console.log('⌨️ INPUT DETECTADO, valor:', e.target.value);
        
        // Formatear el RUN
        formatearRUN(e.target);
        
        // Verificar longitud
        const limpio = e.target.value.replace(/[^0-9kK]/gi, '');
        // Autolimpiar formulario al iniciar ingreso de un nuevo RUN
        if (!formClearedForTyping) {
            const justStartedTyping = (prevRunClean === '' && limpio !== '');
            const divergedFromLoaded = (loadedRunClean && limpio !== '' && limpio !== loadedRunClean);
            if (justStartedTyping || divergedFromLoaded) {
                if (typeof limpiarFormulario === 'function' && !window.HAS_ERROR) {
                    console.log('🧹 Autolimpiando formulario por nuevo RUN...');
                    limpiarFormulario();
                }
                formClearedForTyping = true;
            }
        }
        // Reset flag si el campo se vacía completamente
        if (limpio === '') {
            formClearedForTyping = false;
            loadedRunClean = '';
        }
        prevRunClean = limpio;
        console.log('� Longitud RUN limpio:', limpio.length);
        
        if (limpio.length >= 8) {
            console.log('📏 RUN completo, validando...');
            
            if (validarRUN(e.target.value)) {
                console.log('✅ RUN VÁLIDO, programando búsqueda...');
                e.target.style.borderColor = 'green';
                e.target.style.borderWidth = '2px';
                
                // Cancelar búsqueda anterior
                clearTimeout(timeoutBusqueda);
                
                // Programar nueva búsqueda
                timeoutBusqueda = setTimeout(() => {
                    console.log('⏰ Timeout completado, ejecutando búsqueda...');
                    buscarUsuario(e.target.value);
                }, 800); // Aumenté a 800ms para dar más tiempo
                
            } else {
                console.log('❌ RUN INVÁLIDO');
                e.target.style.borderColor = 'red';
                e.target.style.borderWidth = '2px';
            }
        } else {
            console.log('⏳ RUN incompleto');
            e.target.style.borderColor = '';
            e.target.style.borderWidth = '';
        }
    });
    
    // Event listener para Enter
    runInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            console.log('🚀 ENTER presionado');
            const limpio = this.value.replace(/[^0-9kK]/gi, '');
            if (limpio.length >= 8 && validarRUN(this.value)) {
                console.log('🚀 Búsqueda inmediata por Enter');
                clearTimeout(timeoutBusqueda);
                buscarUsuario(this.value);
            }
        }
    });
    
    console.log('✅ CONFIGURACIÓN COMPLETA - RUN listo para usar');
});

// TEST: Verificar que el script llegó al final
console.log('🏁 Script completamente cargado');

// Función para guardar acuerdos independientemente
function guardarAcuerdosIndependiente() {
    console.log('💾 Guardando acuerdos independientemente...');
    
    const run = document.getElementById('run')?.value;
    if (!run || run.length < 8) {
        alert('⚠️ Por favor ingrese un RUN válido antes de guardar acuerdos');
        return;
    }
    
    const nuevoAcuerdo = document.getElementById('nuevo_acuerdo')?.value?.trim();
    const cumplimiento = document.getElementById('cumplimiento')?.value;
    const fechaAcuerdo = document.getElementById('fecha_acuerdo')?.value;
    
    if (!nuevoAcuerdo && !cumplimiento) {
        alert('⚠️ Por favor ingrese un acuerdo o seleccione un cumplimiento antes de guardar');
        return;
    }
    
    const confirmacion = confirm(`¿Desea guardar los acuerdos para el RUN ${run}?`);
    if (!confirmacion) return;
    
    // Crear FormData para enviar al backend
    const formData = new FormData();
    formData.append('run', run);
    formData.append('guardar_solo_acuerdos', '1');
    if (nuevoAcuerdo) formData.append('nuevo_acuerdo', nuevoAcuerdo);
    if (cumplimiento) formData.append('cumplimiento', cumplimiento);
    if (fechaAcuerdo) formData.append('fecha_acuerdo', fechaAcuerdo);
    
    fetch('/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        alert('✅ Acuerdos guardados exitosamente');
        // Limpiar el campo de nuevo acuerdo
        document.getElementById('nuevo_acuerdo').value = '';
        // Recargar la página para mostrar los datos actualizados
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error de conexión al guardar acuerdos');
    });
}

// Función para guardar control independientemente
function guardarControlIndependiente() {
    console.log('💾 Guardando control independientemente...');
    
    const run = document.getElementById('run')?.value;
    if (!run || run.length < 8) {
        alert('⚠️ Por favor ingrese un RUN válido antes de guardar el control');
        return;
    }
    
    // Verificar que al menos algunos campos de control estén completados
    const camposControl = [
        'fecha', 'profesional', 'peso', 'talla', 'presion_sistolica', 'presion_diastolica',
        'cc', 'hgt', 'hba1c', 'col', 'hdl', 'ldl', 'tag', 
        'microalbuminuria_val', 'vfg', 'rac', 'tsh', 'creatinemia'
    ];
    
    const algunCampoCompleto = camposControl.some(campo => {
        const elemento = document.querySelector(`[name="${campo}"]`);
        return elemento && elemento.value && elemento.value.trim() !== '';
    });
    
    if (!algunCampoCompleto) {
        alert('⚠️ Por favor complete al menos algunos campos del control antes de guardar');
        return;
    }
    
    const confirmacion = confirm(`¿Desea guardar los datos de control para el RUN ${run}?`);
    if (!confirmacion) return;
    
    // Crear FormData con todos los campos del formulario pero solo guardar control
    const formData = new FormData();
    formData.append('run', run);
    formData.append('guardar_solo_control', '1');
    
    // Agregar campos de control
    camposControl.forEach(campo => {
        const elemento = document.querySelector(`[name="${campo}"]`);
        if (elemento && elemento.value) {
            formData.append(campo, elemento.value);
        }
    });
    
    // Agregar checkboxes especiales
    const microalbuminuria = document.querySelector('[name="microalbuminuria"]');
    if (microalbuminuria && microalbuminuria.checked) {
        formData.append('microalbuminuria', 'on');
    }
    
    const rpr = document.querySelector('[name="rpr"]');
    if (rpr && rpr.checked) {
        formData.append('rpr', 'on');
    }
    
    fetch('/usuario/nuevo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        alert('✅ Control guardado exitosamente');
        // Recargar la página para mostrar los datos actualizados
        window.location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error de conexión al guardar el control');
    });
}

// Función para marcar visualmente campos con errores
function marcarCampoError(campoId) {
    var campo = document.getElementById(campoId);
    if (campo) {
        campo.style.border = '2px solid #dc3545';
        campo.style.backgroundColor = '#fff5f5';
        
        // Remover el estilo de error después de que el usuario interactúe con el campo
        campo.addEventListener('input', function() {
            campo.style.border = '';
            campo.style.backgroundColor = '';
        }, {once: true});
        
        campo.addEventListener('change', function() {
            campo.style.border = '';
            campo.style.backgroundColor = '';
        }, {once: true});
    }
}

// Función para mostrar errores más amigables
function mostrarErrorAmigable(tipoError, campo, mensaje) {
    var iconos = {
        'requerido': '📝',
        'run': '🆔',
        'fecha': '📅',
        'numero': '🔢',
        'email': '📧'
    };
    
    var icon = iconos[tipoError] || '⚠️';
    var mensajeCompleto = icon + ' ' + mensaje + '\n\n💡 Tip: Los datos del formulario se preservarán para que puedas corregir el error.';
    
    alert(mensajeCompleto);
    
    if (campo) {
        marcarCampoError(campo);
        var elemento = document.getElementById(campo);
        if (elemento) {
            elemento.focus();
            elemento.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
    }
}

// Aplicar colores a HbA1c en tabla estática al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    const celdasHbA1c = document.querySelectorAll('.hba1c-valor');
    
    celdasHbA1c.forEach(celda => {
        const valorHbA1c = parseFloat(celda.getAttribute('data-hba1c'));
        const fechaNacimiento = celda.getAttribute('data-usuario-nacimiento');
        
        if (valorHbA1c && fechaNacimiento) {
            const edad = calcularEdadDesde(fechaNacimiento);
            let aplicarRojo = false;
            
            if (edad >= 80) {
                // Si edad >= 80 años: rojo si HbA1c >= 8
                aplicarRojo = valorHbA1c >= 8;
            } else {
                // Si edad < 80 años: rojo si HbA1c >= 7
                aplicarRojo = valorHbA1c >= 7;
            }
            
            if (aplicarRojo) {
                celda.style.backgroundColor = '#ffcccc';
                celda.style.color = '#cc0000';
                celda.style.fontWeight = 'bold';
            } else if (valorHbA1c > 0) { // Solo aplicar verde si hay un valor válido
                celda.style.backgroundColor = '#ccffcc';
                celda.style.color = '#006600';
                celda.style.fontWeight = 'bold';
            }
        }
    });
});

// Test automático removido - las patologías solo deben cargarse cuando se ingrese un RUN válido
</script>

</body>
</html>
