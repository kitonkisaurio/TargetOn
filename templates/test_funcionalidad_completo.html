<!doctype html>
<html lang="es">
  <head>
    <title>üß™ Test de Funcionalidad - Formulario Usuario ECICEP</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin: 10px 0;
        border: 2px solid #ddd;
      }
      .test-success {
        border-color: #28a745;
        background: #d4edda;
      }
      .test-error {
        border-color: #dc3545;
        background: #f8d7da;
      }
      .test-warning {
        border-color: #ffc107;
        background: #fff3cd;
      }
      h1 {
        color: #333;
      }
      h2 {
        color: #007cba;
      }
      .btn {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      .btn-primary {
        background: #007cba;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: black;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
      .status {
        font-weight: bold;
        padding: 5px 10px;
        border-radius: 3px;
      }
      .status-ok {
        background: #d4edda;
        color: #155724;
      }
      .status-error {
        background: #f8d7da;
        color: #721c24;
      }
      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Test de Funcionalidad - Formulario Usuario ECICEP</h1>

    <div class="test-container">
      <h2>üìä Estado del Sistema</h2>
      <div id="sistema-status">
        <span class="status status-pending">üîÑ Verificando...</span>
      </div>
      <div id="sistema-info"></div>
    </div>

    <div class="test-container">
      <h2>üÜî Test de Validaci√≥n RUN</h2>
      <div>
        <input
          type="text"
          id="test-run"
          placeholder="Ingrese RUN para probar"
          style="padding: 8px; width: 200px"
        />
        <button class="btn btn-primary" onclick="testRun()">
          üîç Probar RUN
        </button>
      </div>
      <div id="run-results"></div>
    </div>

    <div class="test-container">
      <h2>üîç Test de B√∫squeda de Usuario</h2>
      <div>
        <input
          type="text"
          id="test-busqueda"
          placeholder="RUN para buscar usuario"
          style="padding: 8px; width: 200px"
        />
        <button class="btn btn-success" onclick="testBusqueda()">
          üîé Buscar Usuario
        </button>
      </div>
      <div id="busqueda-results"></div>
    </div>

    <div class="test-container">
      <h2>üåê Test de Conectividad</h2>
      <button class="btn btn-warning" onclick="testConectividad()">
        üì° Probar Conexiones
      </button>
      <div id="conectividad-results"></div>
    </div>

    <div class="test-container">
      <h2>üìù Logs del Sistema</h2>
      <button class="btn btn-primary" onclick="clearLogs()">
        üóëÔ∏è Limpiar Logs
      </button>
      <pre id="logs-container">Logs aparecer√°n aqu√≠...</pre>
    </div>

    <script>
      console.log("üß™ Test de funcionalidad ECICEP iniciado");

      let logs = [];

      function addLog(mensaje, tipo = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const emoji =
          tipo === "error"
            ? "‚ùå"
            : tipo === "warning"
              ? "‚ö†Ô∏è"
              : tipo === "success"
                ? "‚úÖ"
                : "‚ÑπÔ∏è";
        const logEntry = `[${timestamp}] ${emoji} ${mensaje}`;
        logs.push(logEntry);
        updateLogsDisplay();
      }

      function updateLogsDisplay() {
        const container = document.getElementById("logs-container");
        container.textContent = logs.slice(-20).join("\n"); // Mostrar √∫ltimos 20 logs
        container.scrollTop = container.scrollHeight;
      }

      function clearLogs() {
        logs = [];
        updateLogsDisplay();
        addLog("Logs limpiados", "info");
      }

      // Funci√≥n para normalizar RUN (copia de la funci√≥n del formulario)
      function normalizarRun(s) {
        s = (s || "").toUpperCase().replace(/[^0-9K]/g, "");
        if (s.length < 2) return s;
        return s.slice(0, -1) + "-" + s.slice(-1);
      }

      // Funci√≥n para validar d√≠gito verificador (copia de la funci√≥n del formulario)
      function dvValido(runNorm) {
        runNorm = (runNorm || "").toUpperCase();
        const m = /^(\d{7,8})-([\dK])$/.exec(runNorm);
        if (!m) return false;

        const cuerpo = m[1];
        const dv = m[2];

        const factores = [2, 3, 4, 5, 6, 7];
        let s = 0;
        for (let i = 0; i < cuerpo.length; i++) {
          const dig = parseInt(cuerpo[cuerpo.length - 1 - i], 10);
          s += dig * factores[i % factores.length];
        }
        const resto = 11 - (s % 11);
        const dvCalc = resto === 11 ? "0" : resto === 10 ? "K" : String(resto);
        return dv === dvCalc;
      }

      function testRun() {
        const input = document.getElementById("test-run");
        const results = document.getElementById("run-results");
        const runValue = input.value.trim();

        if (!runValue) {
          results.innerHTML =
            '<div class="status status-error">‚ùå Ingrese un RUN para probar</div>';
          addLog("Test RUN: Sin valor ingresado", "error");
          return;
        }

        addLog(`Test RUN iniciado: ${runValue}`, "info");

        // Normalizar RUN
        const runNormalizado = normalizarRun(runValue);
        const runLimpio = runValue.replace(/[^0-9kK]/g, "");

        let resultHtml = '<div style="margin: 10px 0;">';
        resultHtml += `<strong>RUN Original:</strong> ${runValue}<br>`;
        resultHtml += `<strong>RUN Normalizado:</strong> ${runNormalizado}<br>`;
        resultHtml += `<strong>RUN Limpio:</strong> ${runLimpio}<br>`;
        resultHtml += `<strong>Longitud:</strong> ${runLimpio.length} caracteres<br>`;

        if (runLimpio.length >= 8) {
          const esValido = dvValido(runNormalizado);
          resultHtml += `<strong>Validaci√≥n DV:</strong> <span class="status ${esValido ? "status-ok" : "status-error"}">${esValido ? "‚úÖ V√°lido" : "‚ùå Inv√°lido"}</span>`;
          addLog(
            `Test RUN ${runValue}: ${esValido ? "V√°lido" : "Inv√°lido"}`,
            esValido ? "success" : "error",
          );
        } else {
          resultHtml += `<strong>Validaci√≥n DV:</strong> <span class="status status-error">‚ùå Muy corto (m√≠nimo 8 d√≠gitos)</span>`;
          addLog(`Test RUN ${runValue}: Muy corto`, "warning");
        }

        resultHtml += "</div>";
        results.innerHTML = resultHtml;
      }

      function testBusqueda() {
        const input = document.getElementById("test-busqueda");
        const results = document.getElementById("busqueda-results");
        const runValue = input.value.trim();

        if (!runValue) {
          results.innerHTML =
            '<div class="status status-error">‚ùå Ingrese un RUN para buscar</div>';
          addLog("Test b√∫squeda: Sin RUN ingresado", "error");
          return;
        }

        addLog(`Test b√∫squeda iniciado: ${runValue}`, "info");
        results.innerHTML =
          '<div class="status status-pending">üîÑ Buscando usuario...</div>';

        fetch("/usuario/buscar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ run: runValue }),
        })
          .then((response) => {
            addLog(
              `Respuesta servidor: ${response.status}`,
              response.ok ? "success" : "error",
            );
            return response.json();
          })
          .then((data) => {
            let resultHtml = '<div style="margin: 10px 0;">';

            if (data.error) {
              resultHtml += `<div class="status status-error">‚ùå Error: ${data.error}</div>`;
              addLog(
                `Test b√∫squeda ${runValue}: Error - ${data.error}`,
                "error",
              );
            } else if (data.nombre) {
              resultHtml +=
                '<div class="status status-ok">‚úÖ Usuario encontrado</div>';
              resultHtml += `<strong>Nombre:</strong> ${data.nombre}<br>`;
              resultHtml += `<strong>Fecha Nac.:</strong> ${data.fecha_nacimiento || "No disponible"}<br>`;
              resultHtml += `<strong>Direcci√≥n:</strong> ${data.direccion || "No disponible"}<br>`;
              resultHtml += `<strong>Tel√©fono:</strong> ${data.telefono || "No disponible"}<br>`;
              if (data.sector_nombre)
                resultHtml += `<strong>Sector:</strong> ${data.sector_nombre}<br>`;
              if (data.categoria_nombre)
                resultHtml += `<strong>Categor√≠a:</strong> ${data.categoria_nombre}<br>`;
              addLog(
                `Test b√∫squeda ${runValue}: Usuario encontrado - ${data.nombre}`,
                "success",
              );
            } else {
              resultHtml +=
                '<div class="status status-warning">‚ö†Ô∏è Usuario no encontrado en BD</div>';
              addLog(
                `Test b√∫squeda ${runValue}: Usuario no encontrado`,
                "warning",
              );
            }

            resultHtml += "</div>";
            results.innerHTML = resultHtml;
          })
          .catch((error) => {
            results.innerHTML = `<div class="status status-error">‚ùå Error de conexi√≥n: ${error.message}</div>`;
            addLog(
              `Test b√∫squeda ${runValue}: Error de conexi√≥n - ${error.message}`,
              "error",
            );
          });
      }

      function testConectividad() {
        const results = document.getElementById("conectividad-results");
        addLog("Test conectividad iniciado", "info");
        results.innerHTML =
          '<div class="status status-pending">üîÑ Probando conectividad...</div>';

        let testHtml = '<div style="margin: 10px 0;">';

        // Test 1: Endpoint principal
        fetch("/")
          .then((response) => {
            testHtml += `<div class="status ${response.ok ? "status-ok" : "status-error"}">
                    ${response.ok ? "‚úÖ" : "‚ùå"} Endpoint principal: ${response.status}
                </div>`;
            addLog(
              `Endpoint principal: ${response.status}`,
              response.ok ? "success" : "error",
            );

            // Test 2: Endpoint usuario
            return fetch("/usuario");
          })
          .then((response) => {
            testHtml += `<div class="status ${response.ok ? "status-ok" : "status-error"}">
                    ${response.ok ? "‚úÖ" : "‚ùå"} Endpoint usuario: ${response.status}
                </div>`;
            addLog(
              `Endpoint usuario: ${response.status}`,
              response.ok ? "success" : "error",
            );

            // Test 3: Endpoint b√∫squeda
            return fetch("/usuario/buscar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ run: "test" }),
            });
          })
          .then((response) => {
            testHtml += `<div class="status ${response.ok ? "status-ok" : "status-error"}">
                    ${response.ok ? "‚úÖ" : "‚ùå"} Endpoint b√∫squeda: ${response.status}
                </div>`;
            addLog(
              `Endpoint b√∫squeda: ${response.status}`,
              response.ok ? "success" : "error",
            );

            testHtml += "</div>";
            results.innerHTML = testHtml;
          })
          .catch((error) => {
            testHtml += `<div class="status status-error">‚ùå Error de conectividad: ${error.message}</div></div>`;
            results.innerHTML = testHtml;
            addLog(`Error conectividad: ${error.message}`, "error");
          });
      }

      function verificarSistema() {
        const statusDiv = document.getElementById("sistema-status");
        const infoDiv = document.getElementById("sistema-info");

        addLog("Verificaci√≥n del sistema iniciada", "info");

        fetch("/")
          .then((response) => {
            if (response.ok) {
              statusDiv.innerHTML =
                '<span class="status status-ok">‚úÖ Sistema Online</span>';
              infoDiv.innerHTML = `
                        <div style="margin: 10px 0;">
                            <strong>Estado:</strong> Servidor respondiendo correctamente<br>
                            <strong>URL:</strong> ${window.location.origin}<br>
                            <strong>Timestamp:</strong> ${new Date().toLocaleString()}
                        </div>
                    `;
              addLog("Sistema online y funcional", "success");
            } else {
              statusDiv.innerHTML =
                '<span class="status status-error">‚ùå Sistema con errores</span>';
              addLog(`Sistema con errores: ${response.status}`, "error");
            }
          })
          .catch((error) => {
            statusDiv.innerHTML =
              '<span class="status status-error">‚ùå Sistema no disponible</span>';
            infoDiv.innerHTML = `<div style="margin: 10px 0; color: red;">Error: ${error.message}</div>`;
            addLog(`Sistema no disponible: ${error.message}`, "error");
          });
      }

      // Inicializar al cargar la p√°gina
      document.addEventListener("DOMContentLoaded", function () {
        addLog("Test de funcionalidad ECICEP cargado", "success");
        verificarSistema();

        // Auto-test con RUNs conocidos
        setTimeout(() => {
          addLog("Ejecutando tests autom√°ticos...", "info");

          // Test RUN v√°lido
          document.getElementById("test-run").value = "12345678-5";
          testRun();

          // Test RUN inv√°lido
          setTimeout(() => {
            document.getElementById("test-run").value = "12345678-9";
            testRun();
          }, 1000);
        }, 2000);
      });

      addLog("Script de tests cargado completamente", "success");
    </script>
  </body>
</html>
