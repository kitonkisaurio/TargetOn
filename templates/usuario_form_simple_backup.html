<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ECICEP · Ficha de Usuario</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />


    <!-- Estilos modernos integrados -->
    <style>
      :root {
        --bg: #f8fafc; /* fondo claro elegante */
        --panel: #ffffff; /* paneles/cards */
        --muted: #64748b; /* texto secundario */
        --text: #1e293b; /* texto principal */
        --brand: #0ea5e9; /* color de marca */
        --ok: #16a34a; /* éxito */
        --warn: #d97706; /* advertencia */
        --danger: #dc2626; /* error */
        --card: #f1f5f9; /* variantes */
        --border: #e2e8f0;
        --radius: 14px;
        --gap: 14px;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        --shadow-inset: inset 0 0 0 1px var(--border);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font:
          14px/1.4 system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          Cantarell,
          Noto Sans,
          sans-serif;
      }

      /* ====== LAYOUT GENERAL ====== */
      .appbar {
        position: sticky;
        top: 0;
        z-index: 50;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: var(--gap);
        align-items: center;
        padding: 12px clamp(12px, 2vw, 24px);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.95),
          rgba(248, 250, 252, 0.85)
        );
        border-bottom: 1px solid var(--border);
        backdrop-filter: saturate(140%) blur(8px);
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
      }
      .brand .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--brand);
        box-shadow: 0 0 20px var(--brand);
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--text);
        padding: 8px 12px;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: var(--shadow-inset);
        transition: all 0.2s ease;
      }
      .btn:hover {
        background: rgba(77, 163, 255, 0.1);
        border-color: var(--brand);
      }
      .btn--primary {
        border-color: transparent;
        background: var(--brand);
        color: #ffffff;
        box-shadow: 0 6px 16px rgba(14, 165, 233, 0.25);
      }
      .btn--primary:hover {
        background: #0284c7;
        box-shadow: 0 8px 20px rgba(14, 165, 233, 0.35);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .page {
        display: grid;
        grid-template-columns: 320px minmax(0, 1fr);
        gap: var(--gap);
        padding: var(--gap);
      }
      @media (max-width: 980px) {
        .page {
          grid-template-columns: 1fr;
        }
      }

      /* ====== PANELES LATERAL + CONTENIDO ====== */
      .sidebar {
        position: sticky;
        top: 68px;
        align-self: start;
        display: grid;
        gap: var(--gap);
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }
      .card__hd {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 14px;
        border-bottom: 1px solid var(--border);
      }
      .card__bd {
        padding: 14px;
      }

      .summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .summary .kv {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px;
      }
      .kv b {
        display: block;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      .kv span {
        display: block;
        margin-top: 6px;
        font-weight: 700;
      }

      /* ====== ALERTAS MEJORADAS ====== */
      .alerts {
        display: grid;
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
      }
      .alert-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        transition: all 0.2s ease;
      }
      .alert-item:hover {
        border-color: var(--brand);
        box-shadow: 0 4px 12px rgba(77, 163, 255, 0.15);
      }
      .alert-item .badge {
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 11px;
      }
      .badge--ok {
        color: #ffffff;
        background: var(--ok);
        border-color: var(--ok);
      }
      .badge--warn {
        color: #ffffff;
        background: var(--warn);
        border-color: var(--warn);
      }
      .badge--danger {
        color: #ffffff;
        background: var(--danger);
        border-color: var(--danger);
      }
      .badge--neutral {
        color: var(--muted);
        background: var(--border);
      }

      /* Tabs de alertas */
      .alert-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      .alert-tab {
        padding: 6px 10px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .alert-tab:hover {
        border-color: var(--brand);
      }
      .alert-tab.active {
        background: var(--brand);
        color: #ffffff;
        border-color: transparent;
      }
      .alert-content {
        display: none;
      }
      .alert-content.active {
        display: block;
      }

      /* ====== CONTENIDO PRINCIPAL ====== */
      .content {
        display: grid;
        gap: var(--gap);
      }
      .tabs {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      .tab {
        padding: 8px 12px;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .tab:hover {
        border-color: var(--brand);
        background: rgba(77, 163, 255, 0.1);
      }
      .tab[aria-selected="true"] {
        background: var(--brand);
        color: #ffffff;
        border-color: transparent;
      }

      .sections {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
      }
      .section {
        border-top: 1px solid var(--border);
      }
      .section:first-child {
        border-top: 0;
      }
      .section__hd {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px;
      }
      .section__title {
        font-weight: 700;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 12px;
        padding: 0 14px 14px;
      }
      .col-6 {
        grid-column: span 6;
      }
      .col-4 {
        grid-column: span 4;
      }
      .col-3 {
        grid-column: span 3;
      }
      .col-2 {
        grid-column: span 2;
      }
      .col-12 {
        grid-column: span 12;
      }
      @media (max-width: 980px) {
        .col-6,
        .col-4,
        .col-3,
        .col-2 {
          grid-column: span 12;
        }
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .label {
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }
      .input,
      .select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #ffffff;
        color: var(--text);
        transition: all 0.2s ease;
      }
      .input:focus,
      .select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(77, 163, 255, 0.1);
      }
      .help {
        font-size: 11px;
        color: var(--muted);
      }

      /* Estados de usuario */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }
      .status--found {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
        border: 1px solid rgba(34, 197, 94, 0.3);
      }
      .status--new {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warn);
        border: 1px solid rgba(245, 158, 11, 0.3);
      }
      .status--loading {
        background: rgba(77, 163, 255, 0.15);
        color: var(--brand);
        border: 1px solid rgba(77, 163, 255, 0.3);
      }

      /* Tablas */
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      .table th,
      .table td {
        padding: 8px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      .table th {
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        background: var(--card);
      }
      .table tr:hover {
        background: rgba(77, 163, 255, 0.05);
      }

      .footerbar {
        position: sticky;
        bottom: 0;
        z-index: 30;
        margin-top: var(--gap);
        background: linear-gradient(
          0deg,
          rgba(255, 255, 255, 0.96),
          rgba(248, 250, 252, 0.85)
        );
        border-top: 1px solid var(--border);
        padding: 10px;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        backdrop-filter: saturate(140%) blur(8px);
      }

      /* Indicadores de carga */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid var(--border);
        border-top: 2px solid var(--brand);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Mensajes de estado */
      .message {
        padding: 12px;
        border-radius: 10px;
        margin: 12px 0;
        border-left: 4px solid var(--border);
      }
      .message--success {
        background: rgba(34, 197, 94, 0.1);
        border-color: var(--ok);
        color: var(--ok);
      }
      .message--error {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
        color: var(--danger);
      }
      .message--info {
        background: rgba(77, 163, 255, 0.1);
        border-color: var(--brand);
        color: var(--brand);
      }

      /* Responsive adjustments */
      @media (max-width: 980px) {
        .appbar {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .toolbar {
          justify-content: center;
        }
        .sidebar {
          position: static;
        }
      }

      /* Ocultar elementos por defecto que se muestran condicionalmente */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- ======= APP BAR ======= -->
    <header class="appbar" role="banner">
      <div class="brand" aria-label="ECICEP">
        <div class="dot" aria-hidden="true"></div>
        <div>ECICEP · Ficha de Usuario</div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btn-buscar">
          <span class="loading hidden" id="loading-buscar"></span>
          Buscar RUN
        </button>
        <button class="btn" id="btn-limpiar">Limpiar</button>
        <button class="btn btn--primary" id="btn-guardar">
          <span class="loading hidden" id="loading-guardar"></span>
          Guardar
        </button>
      </div>
    </header>

    <!-- ======= LAYOUT ======= -->
    <main class="page" role="main">
      <!-- ===== Sidebar: Resumen + Alertas ===== -->
      <aside class="sidebar" aria-label="Resumen del usuario">
        <!-- Resumen del usuario -->
        <section class="card">
          <div class="card__hd">
            <strong>Resumen</strong>
            <div id="user-status" class="status-badge status--new">
              <span>👤</span>
              Nuevo usuario
            </div>
          </div>
          <div class="card__bd">
            <div class="summary">
              <div class="kv"><b>RUN</b><span id="kv-run">—</span></div>
              <div class="kv"><b>Nombre</b><span id="kv-nombre">—</span></div>
              <div class="kv"><b>Edad</b><span id="kv-edad">—</span></div>
              <div class="kv"><b>Sexo</b><span id="kv-sexo">—</span></div>
            </div>
          </div>
        </section>

        <!-- Alertas de vigencia -->
        <section class="card" aria-labelledby="hd-alertas">
          <div class="card__hd" id="hd-alertas">
            <strong>Alertas</strong>
            <span style="color: var(--muted); font-size: 12px">(auto)</span>
          </div>
          <div class="card__bd">
            <!-- Tabs de alertas -->
            <div class="alert-tabs">
              <div class="alert-tab active" data-alert-tab="examenes">
                Exámenes
              </div>
              <div class="alert-tab" data-alert-tab="screening">Screening</div>
              <div class="alert-tab" data-alert-tab="tratamientos">
                Tratamientos
              </div>
              <div class="alert-tab" data-alert-tab="cardiovascular">
                Cardio
              </div>
            </div>

            <!-- Contenido de alertas -->
            <div id="alert-examenes" class="alert-content active">
              <div class="alert-item">
                <span>📋</span>
                <div style="flex: 1">Sin exámenes disponibles</div>
                <span class="badge badge--neutral">—</span>
              </div>
            </div>

            <div id="alert-screening" class="alert-content">
              <div class="alert-item">
                <span>🔍</span>
                <div style="flex: 1">Sin screening disponible</div>
                <span class="badge badge--neutral">—</span>
              </div>
            </div>

            <div id="alert-tratamientos" class="alert-content">
              <div class="alert-item">
                <span>💊</span>
                <div style="flex: 1">Sin tratamientos disponibles</div>
                <span class="badge badge--neutral">—</span>
              </div>
            </div>

            <div id="alert-cardiovascular" class="alert-content">
              <div class="alert-item">
                <span>❤️</span>
                <div style="flex: 1">Sin evaluación cardiovascular</div>
                <span class="badge badge--neutral">—</span>
              </div>
            </div>
          </div>
        </section>
      </aside>

      <!-- ===== Content: Tabs + Secciones ===== -->
      <section class="content">
        <!-- Mensajes de estado -->
        <div id="messages-container"></div>

        <nav class="tabs" role="tablist" aria-label="Secciones">
          <button class="tab" role="tab" aria-selected="true" data-tab="datos">
            Datos básicos
          </button>
          <button
            class="tab"
            role="tab"
            aria-selected="false"
            data-tab="examenes"
          >
            Exámenes
          </button>
          <button
            class="tab"
            role="tab"
            aria-selected="false"
            data-tab="screening"
          >
            Screening
          </button>
          <button
            class="tab"
            role="tab"
            aria-selected="false"
            data-tab="controles"
          >
            Controles
          </button>
          <button
            class="tab"
            role="tab"
            aria-selected="false"
            data-tab="patologias"
          >
            Patologías
          </button>
          <button
            class="tab"
            role="tab"
            aria-selected="false"
            data-tab="tratamientos"
          >
            Tratamientos
          </button>
        </nav>

        <div class="sections" id="sections">
          <!-- ===== Sección: Datos básicos ===== -->
          <section class="section" data-panel="datos">
            <div class="section__hd">
              <div class="section__title">Datos del usuario</div>
              <div class="help">Campos obligatorios</div>
            </div>
            <div class="grid">
              <div class="col-6 field">
                <label class="label" for="run">RUN *</label>
                <input
                  class="input"
                  id="run"
                  name="run"
                  placeholder="12.345.678-9"
                  autocomplete="off"
                  spellcheck="false"
                  maxlength="12"
                />
                <div class="help">Formato: 12.345.678-9</div>
              </div>
              <div class="col-6 field">
                <label class="label" for="nombre">Nombre completo *</label>
                <input
                  class="input"
                  id="nombre"
                  name="nombre"
                  placeholder="Nombre Apellido"
                  autocomplete="name"
                />
              </div>
              <div class="col-4 field">
                <label class="label" for="fecha_nacimiento"
                  >Fecha de nacimiento</label
                >
                <input
                  class="input"
                  id="fecha_nacimiento"
                  name="fecha_nacimiento"
                  type="date"
                  autocomplete="bday"
                />
              </div>
              <div class="col-4 field">
                <label class="label" for="sexo">Sexo</label>
                <select class="select" id="sexo" name="sexo" autocomplete="sex">
                  <option value="">Seleccione…</option>
                  <option value="femenino">Femenino</option>
                  <option value="masculino">Masculino</option>
                </select>
              </div>
              <div class="col-4 field">
                <label class="label" for="telefono">Teléfono</label>
                <input
                  class="input"
                  id="telefono"
                  name="telefono"
                  placeholder="+56 9…"
                  autocomplete="tel"
                />
              </div>
              <div class="col-12 field">
                <label class="label" for="direccion">Dirección</label>
                <input
                  class="input"
                  id="direccion"
                  name="direccion"
                  placeholder="Calle, número, comuna"
                  autocomplete="street-address"
                />
              </div>
            </div>
          </section>

          <!-- ===== Sección: Exámenes ===== -->
          <section class="section" data-panel="examenes" hidden>
            <div class="section__hd">
              <div class="section__title">Exámenes</div>
              <div class="help">HbA1c, LDL, VFG, RAC, Creatininemia, EKG…</div>
            </div>
            <div class="grid" id="panel-examenes">
              <!-- Campos de exámenes se cargan dinámicamente -->
              <div class="col-6 field">
                <label class="label" for="hba1c">HbA1c (%)</label>
                <input
                  class="input"
                  id="hba1c"
                  name="hba1c"
                  type="number"
                  step="0.1"
                />
              </div>
              <div class="col-6 field">
                <label class="label" for="hba1c_fecha">Fecha HbA1c</label>
                <input
                  class="input"
                  id="hba1c_fecha"
                  name="hba1c_fecha"
                  type="date"
                />
              </div>
              <div class="col-6 field">
                <label class="label" for="ldl">LDL (mg/dL)</label>
                <input class="input" id="ldl" name="ldl" type="number" />
              </div>
              <div class="col-6 field">
                <label class="label" for="ldl_fecha">Fecha LDL</label>
                <input
                  class="input"
                  id="ldl_fecha"
                  name="ldl_fecha"
                  type="date"
                />
              </div>
              <div class="col-6 field">
                <label class="label" for="vfg">VFG (ml/min/1.73m²)</label>
                <input class="input" id="vfg" name="vfg" type="number" />
              </div>
              <div class="col-6 field">
                <label class="label" for="vfg_fecha">Fecha VFG</label>
                <input
                  class="input"
                  id="vfg_fecha"
                  name="vfg_fecha"
                  type="date"
                />
              </div>
              <div class="col-12">
                <div class="help">
                  Se cargan más exámenes desde backend según perfil del usuario
                </div>
              </div>
            </div>
          </section>

          <!-- ===== Sección: Screening ===== -->
          <section class="section" data-panel="screening" hidden>
            <div class="section__hd">
              <div class="section__title">Screening Preventivo</div>
              <div class="help">PAP, MAMO, PSA, Mamografía…</div>
            </div>
            <div class="grid" id="panel-screening">
              <div class="col-12">
                <div class="help">
                  Se cargan screening específicos según edad y sexo
                </div>
              </div>
            </div>
          </section>

          <!-- ===== Sección: Controles ===== -->
          <section class="section" data-panel="controles" hidden>
            <div class="section__hd">
              <div class="section__title">Controles</div>
              <div class="help">Peso, talla, PA, HGT, CC…</div>
            </div>
            <div class="grid" id="panel-controles">
              <div class="col-3 field">
                <label class="label" for="peso">Peso (kg)</label>
                <input
                  class="input"
                  id="peso"
                  name="peso"
                  type="number"
                  step="0.1"
                />
              </div>
              <div class="col-3 field">
                <label class="label" for="talla">Talla (cm)</label>
                <input
                  class="input"
                  id="talla"
                  name="talla"
                  type="number"
                  step="0.1"
                />
              </div>
              <div class="col-3 field">
                <label class="label" for="ps">PA Sistólica</label>
                <input class="input" id="ps" name="ps" type="number" />
              </div>
              <div class="col-3 field">
                <label class="label" for="pd">PA Diastólica</label>
                <input class="input" id="pd" name="pd" type="number" />
              </div>
              <div class="col-4 field">
                <label class="label" for="hgt">HGT (mg/dL)</label>
                <input class="input" id="hgt" name="hgt" type="number" />
              </div>
              <div class="col-4 field">
                <label class="label" for="cc"
                  >Circunferencia Cintura (cm)</label
                >
                <input class="input" id="cc" name="cc" type="number" />
              </div>
              <div class="col-4 field">
                <label class="label" for="imc">IMC (calc)</label>
                <input
                  class="input"
                  id="imc"
                  name="imc"
                  type="number"
                  step="0.1"
                  readonly
                />
              </div>
            </div>
          </section>

          <!-- ===== Sección: Patologías ===== -->
          <section class="section" data-panel="patologias" hidden>
            <div class="section__hd">
              <div class="section__title">Patologías</div>
              <div class="help">CIE-10: E10-E14 (Diabetes), I10-I15 (HTA)…</div>
            </div>
            <div class="grid" id="panel-patologias">
              <div class="col-12">
                <div class="help">
                  Se cargan patologías según CIE-10 desde backend
                </div>
                <div id="patologias-container"></div>
              </div>
            </div>
          </section>

          <!-- ===== Sección: Tratamientos ===== -->
          <section class="section" data-panel="tratamientos" hidden>
            <div class="section__hd">
              <div class="section__title">Tratamientos</div>
              <div class="help">Insulina, medicación, controles…</div>
            </div>
            <div class="grid" id="panel-tratamientos">
              <div class="col-12">
                <div class="help">
                  Se cargan tratamientos específicos según patologías
                </div>
              </div>
            </div>
          </section>
        </div>

        <div class="footerbar">
          <button class="btn" id="btn-cancelar">Cancelar</button>
          <button class="btn btn--primary" id="btn-guardar-footer">
            <span class="loading hidden" id="loading-guardar-footer"></span>
            Guardar cambios
          </button>
        </div>
      </section>
    </main>

    <!-- Estados ocultos para compatibilidad -->
    <div id="usuario-encontrado" class="hidden"></div>
    <div id="usuario-nuevo" class="hidden"></div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/alertas_vigencia.js') }}"></script>

    <script>
      // ===== Variables globales =====
      let currentUser = null;
      let isLoading = false;

      // ===== Navegación por tabs =====
      const tabs = document.querySelectorAll(".tab");
      const panels = document.querySelectorAll("[data-panel]");

      tabs.forEach((t) =>
        t.addEventListener("click", () => {
          tabs.forEach((b) => b.setAttribute("aria-selected", "false"));
          t.setAttribute("aria-selected", "true");
          const name = t.dataset.tab;
          panels.forEach((p) => (p.hidden = p.dataset.panel !== name));
        }),
      );

      // ===== Navegación de alertas =====
      const alertTabs = document.querySelectorAll(".alert-tab");
      const alertContents = document.querySelectorAll(".alert-content");

      alertTabs.forEach((tab) =>
        tab.addEventListener("click", () => {
          alertTabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const targetId = "alert-" + tab.dataset.alertTab;
          alertContents.forEach((content) => {
            content.classList.remove("active");
            if (content.id === targetId) {
              content.classList.add("active");
            }
          });
        }),
      );

      // ===== Función para actualizar resumen =====
      function updateResumen({ run, nombre, edad, sexo, status = "new" }) {
        document.getElementById("kv-run").textContent = run || "—";
        document.getElementById("kv-nombre").textContent = nombre || "—";
        document.getElementById("kv-edad").textContent = edad || "—";
        document.getElementById("kv-sexo").textContent = sexo
          ? sexo.charAt(0).toUpperCase() + sexo.slice(1)
          : "—";

        // Actualizar estado
        const statusEl = document.getElementById("user-status");
        statusEl.className = "status-badge";

        switch (status) {
          case "found":
            statusEl.classList.add("status--found");
            statusEl.innerHTML = "<span>✅</span> Usuario encontrado";
            break;
          case "loading":
            statusEl.classList.add("status--loading");
            statusEl.innerHTML = '<span class="loading"></span> Buscando...';
            break;
          default:
            statusEl.classList.add("status--new");
            statusEl.innerHTML = "<span>👤</span> Nuevo usuario";
        }
      }

      // ===== Función para mostrar mensajes =====
      function showMessage(text, type = "info") {
        const container = document.getElementById("messages-container");
        const message = document.createElement("div");
        message.className = `message message--${type}`;
        message.textContent = text;

        container.innerHTML = "";
        container.appendChild(message);

        setTimeout(() => message.remove(), 5000);
      }

      // ===== Función para toggle loading =====
      function toggleLoading(btnId, show) {
        const btn = document.getElementById(btnId);
        const loader = btn.querySelector(".loading");
        if (loader) {
          loader.classList.toggle("hidden", !show);
        }
        btn.disabled = show;
      }

      // ===== Búsqueda de usuario =====
      async function buscarUsuario() {
        const runInput = document.getElementById("run");
        const run = runInput.value.trim();

        if (!run) {
          showMessage("Ingrese un RUN válido", "error");
          return;
        }

        updateResumen({ status: "loading" });
        toggleLoading("btn-buscar", true);

        try {
          const response = await fetch(
            `/buscar_usuario?run=${encodeURIComponent(run)}`,
          );
          const data = await response.json();

          if (data.success && data.usuario) {
            const user = data.usuario;
            currentUser = user;

            // Llenar formulario
            document.getElementById("nombre").value = user.nombre || "";
            document.getElementById("fecha_nacimiento").value =
              user.fecha_nacimiento || "";
            document.getElementById("sexo").value = user.sexo || "";
            document.getElementById("telefono").value = user.telefono || "";
            document.getElementById("direccion").value = user.direccion || "";

            // Actualizar resumen
            const edad = user.fecha_nacimiento
              ? calcularEdad(user.fecha_nacimiento)
              : null;
            updateResumen({
              run: run,
              nombre: user.nombre,
              edad: edad,
              sexo: user.sexo,
              status: "found",
            });

            // Mostrar elementos de usuario encontrado (compatibilidad)
            document.getElementById("usuario-encontrado").style.display =
              "block";
            document.getElementById("usuario-nuevo").style.display = "none";

            showMessage("Usuario encontrado exitosamente", "success");

            // Cargar alertas si la función está disponible
            if (typeof cargarAlertasVigenciaFlotante === "function") {
              setTimeout(() => cargarAlertasVigenciaFlotante(run), 500);
            }
          } else {
            // Usuario no encontrado
            currentUser = null;
            document.getElementById("usuario-encontrado").style.display =
              "none";
            document.getElementById("usuario-nuevo").style.display = "block";

            updateResumen({ run: run, status: "new" });
            showMessage(
              "Usuario no encontrado. Puede crear uno nuevo.",
              "info",
            );
          }
        } catch (error) {
          console.error("Error al buscar usuario:", error);
          showMessage("Error al buscar usuario. Intente nuevamente.", "error");
          updateResumen({ status: "new" });
        } finally {
          toggleLoading("btn-buscar", false);
        }
      }

      // ===== Función para calcular edad =====
      function calcularEdad(fechaNacimiento) {
        if (!fechaNacimiento) return null;

        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const meses = hoy.getMonth() - nacimiento.getMonth();

        if (
          meses < 0 ||
          (meses === 0 && hoy.getDate() < nacimiento.getDate())
        ) {
          edad--;
        }

        return edad;
      }

      // ===== Función para limpiar formulario =====
      function limpiarFormulario() {
        document
          .querySelectorAll(".input, .select, textarea")
          .forEach((el) => (el.value = ""));
        currentUser = null;

        updateResumen({
          run: "—",
          nombre: "—",
          edad: "—",
          sexo: "—",
          status: "new",
        });

        // Ocultar estados (compatibilidad)
        document.getElementById("usuario-encontrado").style.display = "none";
        document.getElementById("usuario-nuevo").style.display = "none";

        // Limpiar alertas
        document.querySelectorAll(".alert-content").forEach((content) => {
          const defaultMsg = content.id.includes("examenes")
            ? "Sin exámenes disponibles"
            : content.id.includes("screening")
              ? "Sin screening disponible"
              : content.id.includes("tratamientos")
                ? "Sin tratamientos disponibles"
                : "Sin evaluación cardiovascular";

          content.innerHTML = `
          <div class="alert-item">
            <span>📋</span>
            <div style="flex:1">${defaultMsg}</div>
            <span class="badge badge--neutral">—</span>
          </div>
        `;
        });

        document.getElementById("messages-container").innerHTML = "";
        showMessage("Formulario limpiado", "info");
      }

      // ===== Función para guardar =====
      async function guardarFormulario() {
        toggleLoading("btn-guardar", true);
        toggleLoading("btn-guardar-footer", true);

        try {
          const formData = new FormData();

          // Recopilar todos los datos del formulario
          document
            .querySelectorAll(".input, .select, textarea")
            .forEach((input) => {
              if (input.name && input.value) {
                formData.append(input.name, input.value);
              }
            });

          const response = await fetch("/guardar_usuario", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            showMessage("Usuario guardado exitosamente", "success");
          } else {
            showMessage(result.error || "Error al guardar usuario", "error");
          }
        } catch (error) {
          console.error("Error al guardar:", error);
          showMessage("Error al guardar usuario. Intente nuevamente.", "error");
        } finally {
          toggleLoading("btn-guardar", false);
          toggleLoading("btn-guardar-footer", false);
        }
      }

      // ===== Event listeners =====
      document
        .getElementById("btn-buscar")
        .addEventListener("click", buscarUsuario);
      document
        .getElementById("btn-limpiar")
        .addEventListener("click", limpiarFormulario);
      document
        .getElementById("btn-guardar")
        .addEventListener("click", guardarFormulario);
      document
        .getElementById("btn-guardar-footer")
        .addEventListener("click", guardarFormulario);

      // Buscar al presionar Enter en el campo RUN
      document.getElementById("run").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          buscarUsuario();
        }
      });

      // Buscar cuando el usuario salga del campo RUN (blur)
      document.getElementById("run").addEventListener("blur", (e) => {
        const run = e.target.value.trim();
        if (run.length >= 9 && validarRUN(run)) {
          buscarUsuario();
        }
      });

      // Formateo automático del RUN mientras se escribe
      function formatearRUN(valor) {
        // Remover todo lo que no sea número o K
        let limpio = valor.replace(/[^0-9kK]/g, "");

        // Convertir K a mayúscula
        limpio = limpio.replace(/k/g, "K");

        // Si es muy largo, cortar
        if (limpio.length > 9) {
          limpio = limpio.substring(0, 9);
        }

        // Formatear con puntos y guión
        if (limpio.length > 1) {
          let cuerpo = limpio.slice(0, -1); // Todos menos el último
          let dv = limpio.slice(-1); // Último caracter (dígito verificador)

          // Agregar puntos al cuerpo cada 3 dígitos desde la derecha
          cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

          return cuerpo + "-" + dv;
        }

        return limpio;
      }

      // Validación del RUN chileno
      function validarRUN(run) {
        if (!run) return false;

        // Remover formato
        const runLimpio = run.replace(/[^0-9kK]/g, "");
        if (runLimpio.length < 2) return false;

        const cuerpo = runLimpio.slice(0, -1);
        const dv = runLimpio.slice(-1).toUpperCase();

        if (!/^\d+$/.test(cuerpo)) return false;

        // Calcular dígito verificador
        let suma = 0;
        let multiplicador = 2;

        for (let i = cuerpo.length - 1; i >= 0; i--) {
          suma += parseInt(cuerpo[i]) * multiplicador;
          multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }

        const resto = suma % 11;
        const dvCalculado =
          resto === 0 ? "0" : resto === 1 ? "K" : (11 - resto).toString();

        return dv === dvCalculado;
      }

      document.getElementById("run").addEventListener("input", (e) => {
        const input = e.target;
        const cursorPos = input.selectionStart;
        const valorAnterior = input.value;

        // Contar dígitos antes del cursor para mantener posición relativa
        const digitosAntesCursor = valorAnterior
          .slice(0, cursorPos)
          .replace(/[^0-9kK]/g, "").length;

        const valorFormateado = formatearRUN(valorAnterior);

        // Solo actualizar si cambió
        if (valorFormateado !== valorAnterior) {
          input.value = valorFormateado;

          // Calcular nueva posición del cursor basada en dígitos
          let nuevaPos = 0;
          let digitosContados = 0;

          for (
            let i = 0;
            i < valorFormateado.length && digitosContados < digitosAntesCursor;
            i++
          ) {
            if (/[0-9kK]/.test(valorFormateado[i])) {
              digitosContados++;
            }
            nuevaPos = i + 1;
          }

          // Ajustar si estamos al final
          if (
            digitosAntesCursor >=
            valorFormateado.replace(/[^0-9kK]/g, "").length
          ) {
            nuevaPos = valorFormateado.length;
          }

          // Usar setTimeout para evitar problemas de timing
          setTimeout(() => {
            input.setSelectionRange(nuevaPos, nuevaPos);
          }, 0);
        }

        // Validar RUN y mostrar estado visual
        if (valorFormateado.length >= 9) {
          if (validarRUN(valorFormateado)) {
            input.style.borderColor = "var(--ok)";
            input.style.boxShadow = "0 0 0 3px rgba(22, 163, 74, 0.1)";

            // Disparar autocompletado cuando el RUN es válido
            clearTimeout(window.autocompletadoTimeout);
            window.autocompletadoTimeout = setTimeout(() => {
              buscarUsuario();
            }, 500); // Esperar 500ms después de que deje de escribir
          } else {
            input.style.borderColor = "var(--danger)";
            input.style.boxShadow = "0 0 0 3px rgba(220, 38, 38, 0.1)";
          }
        } else {
          input.style.borderColor = "var(--border)";
          input.style.boxShadow = "none";

          // Cancelar autocompletado si el RUN es muy corto
          clearTimeout(window.autocompletadoTimeout);
        }
      });

      // Calcular IMC automáticamente
      function calcularIMC() {
        const peso = parseFloat(document.getElementById("peso").value);
        const talla = parseFloat(document.getElementById("talla").value);

        if (peso && talla && talla > 0) {
          const tallaMt = talla / 100;
          const imc = (peso / (tallaMt * tallaMt)).toFixed(1);
          document.getElementById("imc").value = imc;
        } else {
          document.getElementById("imc").value = "";
        }
      }

      document.getElementById("peso").addEventListener("input", calcularIMC);
      document.getElementById("talla").addEventListener("input", calcularIMC);

      // ===== Inicialización =====
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 ECICEP moderno inicializado");

        // Estado inicial
        updateResumen({ status: "new" });

        // Verificar si hay un RUN en la URL o campos prellenados
        const urlParams = new URLSearchParams(window.location.search);
        const runParam = urlParams.get("run");

        if (runParam) {
          document.getElementById("run").value = runParam;
          buscarUsuario();
        }

        // Inicializar sistema de alertas si está disponible
        if (typeof mostrarAlertasCompletas === "function") {
          setTimeout(mostrarAlertasCompletas, 1000);
        }
      });

      // ===== Exponer funciones globalmente para compatibilidad =====
      window.buscarUsuario = buscarUsuario;
      window.limpiarFormulario = limpiarFormulario;
      window.guardarFormulario = guardarFormulario;
      window.updateResumen = updateResumen;
      window.showMessage = showMessage;
      window.calcularEdad = calcularEdad;
    </script>
  </body>
</html>
