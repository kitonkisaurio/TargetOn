<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Gráficos — ECICEP</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
      body {
        background: #f8fafc;
      }
      .card {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
      }
      .filter-section {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <a
            class="btn btn-outline-secondary btn-sm"
            href="{{ url_for('index') }}"
            >← Volver al Buscador</a
          >
          <h2 class="mt-2 mb-0">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              style="
                width: 1.2rem;
                height: 1.2rem;
                vertical-align: -0.12em;
                margin-right: 8px;
                color: #6e6e6e;
              "
              fill="currentColor"
              aria-hidden="true"
            >
              <title>Gráficos</title>
              <path
                d="M3 3h3v18H3V3zm6 6h3v12H9V9zm6-4h3v16h-3V5zm6 8h3v8h-3v-8z"
              />
            </svg>
            Gráficos — Distribución de Usuarios
          </h2>
        </div>
        <a
          class="btn btn-outline-secondary btn-sm"
          href="{{ url_for('logout') }}"
          >Cerrar sesión</a
        >
      </div>

      <!-- Filtros -->
      <div class="filter-section">
        <h5>Filtros</h5>
        <div class="row g-2">
          <div class="col-md-2">
            <label class="form-label fw-semibold small">Sectores</label>
            <select id="sectores_select" class="form-select form-select-sm">
              <option value="">Todos</option>
              {% for s in sectores %}
              <option value="{{s.id}}">{{s.nombre}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-1">
            <label class="form-label fw-semibold small">Sexo</label>
            <select id="sexo_select" class="form-select form-select-sm">
              <option value="">Ambos</option>
              <option value="masculino">M</option>
              <option value="femenino">F</option>
            </select>
          </div>
          <div class="col-md-1">
            <label class="form-label fw-semibold small">Cat</label>
            <select id="categorias_select" class="form-select form-select-sm">
              <option value="">Todas</option>
              <option value="1">G1</option>
              <option value="2">G2</option>
              <option value="3">G3</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold small">Edad</label>
            <select id="grupo_etareo_select" class="form-select form-select-sm">
              <option value="">Todos</option>
              <option value="adulto">Adulto</option>
              <option value="adulto mayor">A.Mayor</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold small">Patología</label>
            <select id="patologia_filtro" class="form-select form-select-sm">
              <option value="">Todas</option>
              {% for p in patologias %}
              <option value="{{p.patologia_id}}">{{p.patologia}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold small">Desde</label>
            <input
              id="fecha_desde"
              type="date"
              class="form-control form-control-sm"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold small">Hasta</label>
            <input
              id="fecha_hasta"
              type="date"
              class="form-control form-control-sm"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold small">Agrupar</label>
            <select id="tipo_grafico" class="form-select form-select-sm">
              <option value="sector">Sector</option>
              <option value="sexo">Sexo</option>
              <option value="categoria">Categoría</option>
              <option value="grupo_etareo">Edad</option>
              <option value="etapa_hta">HTA</option>
              <option value="estado_nutricional">Nutricional</option>
              <option value="patologia">Patología</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button
              type="button"
              class="btn btn-primary btn-sm w-100"
              onclick="generarGrafico()"
            >
              Generar
            </button>
          </div>
        </div>
      </div>

      <div class="alert alert-info d-flex align-items-center">
        <span class="me-2">Total de usuarios encontrados:</span>
        <span id="total-usuarios" class="badge bg-primary fs-6">0</span>
      </div>

      <div class="card">
        <div class="card-body">
          <h5 class="card-title" id="chart-title">Distribución de Usuarios</h5>
          <div class="chart-container">
            <canvas id="estadisticasChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      let chart = null;
      Chart.register(ChartDataLabels);

      function generarColores(labels) {
        const base = [
          "#fff176",
          "#43a047",
          "#1976d2",
          "#00bcd4",
          "#a5d6a7",
          "#2e7d32",
          "#e53935",
          "#FF9F40",
        ];
        return labels.map((_, i) => base[i % base.length]);
      }

      async function generarGrafico() {
        try {
          const params = new URLSearchParams();
          const s = document.getElementById("sectores_select").value;
          if (s) params.set("sectores", s);
          const sx = document.getElementById("sexo_select").value;
          if (sx) params.set("sexo", sx);
          const c = document.getElementById("categorias_select").value;
          if (c) params.set("categorias", c);
          const g = document.getElementById("grupo_etareo_select").value;
          if (g) params.set("grupos_etareos", g);
          const p = document.getElementById("patologia_filtro").value;
          if (p) params.set("patologias", p);
          const desde = document.getElementById("fecha_desde").value;
          if (desde) params.set("fecha_desde", desde);
          const hasta = document.getElementById("fecha_hasta").value;
          if (hasta) params.set("fecha_hasta", hasta);
          const tipo = document.getElementById("tipo_grafico").value;
          params.set("agrupar_por", tipo);

          const r = await fetch("/api/estadisticas?" + params.toString());
          if (!r.ok) throw new Error("HTTP " + r.status);
          const data = await r.json();
          document.getElementById("total-usuarios").textContent =
            data.total || 0;
          const ctx = document
            .getElementById("estadisticasChart")
            .getContext("2d");
          if (chart) chart.destroy();
          const labels = data.labels || [];
          const valores = data.valores || [];
          chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                { data: valores, backgroundColor: generarColores(labels) },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                datalabels: {
                  anchor: "center",
                  align: "center",
                  formatter: (v, ctx) => {
                    const t = valores.reduce((a, b) => a + b, 0) || 1;
                    const p = ((v * 100) / t).toFixed(1);
                    return `${v}\n(${p}%)`;
                  },
                },
              },
              scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
            },
          });
        } catch (e) {
          console.error(e);
          alert("Error al cargar gráfico");
        }
      }

      document.addEventListener("DOMContentLoaded", generarGrafico);
    </script>
  </body>
</html>
