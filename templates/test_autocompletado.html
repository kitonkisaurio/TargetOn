<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Autocompletado RUN</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .test-container {
        max-width: 600px;
        margin: 0 auto;
      }
      input {
        padding: 10px;
        margin: 10px;
        font-size: 16px;
        width: 200px;
      }
      .result {
        background: #f0f0f0;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .debug {
        background: #fff3cd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 3px;
        font-family: monospace;
      }
      .success {
        background: #d4edda;
      }
      .error {
        background: #f8d7da;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>üß™ Test Autocompletado RUN - ECICEP</h1>

      <div>
        <label>Ingrese RUN de prueba:</label><br />
        <input
          type="text"
          id="runTest"
          placeholder="Ej: 8.352.262-3"
          maxlength="13"
        />
        <button onclick="probarBusqueda()">üîç Buscar</button>
        <button onclick="probarRuns()">üéØ Probar RUNs conocidos</button>
      </div>

      <div id="debug-log" class="debug">
        <strong>Debug Log:</strong><br />
        <div id="log-content">Listo para probar...</div>
      </div>

      <div id="result" class="result">
        <strong>Resultado:</strong><br />
        <div id="result-content">No hay resultados a√∫n.</div>
      </div>
    </div>

    <script>
      function log(message) {
        const logContent = document.getElementById("log-content");
        const timestamp = new Date().toLocaleTimeString();
        logContent.innerHTML += `<br>[${timestamp}] ${message}`;
        logContent.scrollTop = logContent.scrollHeight;
      }

      function showResult(data, isError = false) {
        const resultContent = document.getElementById("result-content");
        const resultDiv = document.getElementById("result");

        if (isError) {
          resultDiv.className = "result error";
          resultContent.innerHTML = `‚ùå Error: ${data}`;
        } else {
          resultDiv.className = "result success";
          resultContent.innerHTML = `
                    ‚úÖ <strong>Usuario encontrado:</strong><br>
                    ‚Ä¢ RUN: ${data.run || "N/A"}<br>
                    ‚Ä¢ Nombre: ${data.nombre || "N/A"}<br>
                    ‚Ä¢ Sexo: ${data.sexo || "N/A"}<br>
                    ‚Ä¢ Fecha Nacimiento: ${data.fecha_nacimiento || "N/A"}<br>
                    ‚Ä¢ Categor√≠a: ${data.categoria_nombre || "N/A"}<br>
                    ‚Ä¢ Sector: ${data.sector_nombre || "N/A"}<br>
                    ‚Ä¢ Patolog√≠as: ${data.patologias ? data.patologias.length : 0}
                `;
        }
      }

      async function probarBusqueda() {
        const runInput = document.getElementById("runTest");
        const run = runInput.value.trim();

        log(`üöÄ Iniciando b√∫squeda para RUN: "${run}"`);

        if (!run) {
          log("‚ùå RUN vac√≠o");
          showResult("RUN vac√≠o", true);
          return;
        }

        try {
          log("üì° Enviando request a /usuario/buscar...");
          const response = await fetch("/usuario/buscar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ run: run }),
          });

          log(`üì° Respuesta recibida - Status: ${response.status}`);

          const data = await response.json();
          log(`üìÑ Datos recibidos: ${JSON.stringify(data, null, 2)}`);

          if (data.encontrado) {
            log("‚úÖ Usuario encontrado exitosamente");
            showResult(data);
          } else {
            log("‚ö†Ô∏è Usuario no encontrado");
            showResult("Usuario no encontrado en la base de datos", true);
          }
        } catch (error) {
          log(`‚ùå Error en la b√∫squeda: ${error.message}`);
          showResult(`Error de conexi√≥n: ${error.message}`, true);
        }
      }

      async function probarRuns() {
        const runsConocidos = [
          "8.352.262-3",
          "10.000.141-1",
          "83522623",
          "10000141-1",
        ];

        log("üéØ Probando RUNs conocidos...");

        for (const run of runsConocidos) {
          document.getElementById("runTest").value = run;
          log(`\n--- Probando RUN: ${run} ---`);
          await probarBusqueda();
          await new Promise((resolve) => setTimeout(resolve, 1000)); // Esperar 1 segundo
        }
      }

      // Formateo autom√°tico del RUN
      document
        .getElementById("runTest")
        .addEventListener("input", function (e) {
          let v = e.target.value.replace(/[^0-9kK]/g, "").toUpperCase();

          if (v.length >= 2) {
            const cuerpo = v.slice(0, -1);
            const dv = v.slice(-1);
            const cuerpoFormateado = cuerpo.replace(
              /\B(?=(\d{3})+(?!\d))/g,
              ".",
            );
            e.target.value = cuerpoFormateado + "-" + dv;
          } else {
            e.target.value = v;
          }
        });

      // Buscar con Enter
      document
        .getElementById("runTest")
        .addEventListener("keyup", function (e) {
          if (e.key === "Enter") {
            probarBusqueda();
          }
        });

      log("üü¢ Test de autocompletado cargado. Listo para probar.");
    </script>
  </body>
</html>
