<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Egreso de Patolog√≠as - ECICEP</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

    <style>
      :root {
        --bg: #f8fafc;
        --ink: #222;
        --muted: #6c757d;
        --line: #e5e7eb;
        --brand: #0d6efd;
        --brand-600: #0b5ed7;
        --success: #198754;
        --warning: #ffc107;
        --danger: #dc3545;
        --card: #fff;
      }

      /* Estilo especial para el campo de contrase√±a */
      #password_confirmacion {
        border: 2px solid #dc3545;
        border-radius: 6px;
        padding: 10px;
        background: #fff5f5;
      }

      #password_confirmacion:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
        background: #ffffff;
      }

      .form-group label[for="password_confirmacion"] {
        color: #dc3545;
        font-weight: 600;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--ink);
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          Cantarell,
          "Helvetica Neue",
          Arial;
        font-size: 14px;
        line-height: 1.5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--card);
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--line);
      }

      .header h1 {
        color: var(--ink);
        margin: 0;
        font-size: 24px;
        font-weight: 700;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        background: #fff;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--brand);
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
      }

      .btn {
        display: inline-block;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s ease;
        margin: 4px;
      }

      .btn-primary {
        background: var(--brand);
        color: white;
      }

      .btn-primary:hover {
        background: var(--brand-600);
      }

      .btn-success {
        background: var(--success);
        color: white;
      }

      .btn-success:hover {
        background: #157347;
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-danger:hover {
        background: #b02a37;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin: 16px 0;
        font-size: 14px;
        font-weight: 500;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .card-header {
        font-size: 18px;
        font-weight: 600;
        color: var(--brand);
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--line);
      }

      .run-input {
        font-family: "Courier New", monospace;
        font-weight: bold;
        text-transform: uppercase;
      }

      .run-valid {
        color: var(--success) !important;
        border-color: var(--success) !important;
      }

      .run-invalid {
        color: var(--danger) !important;
        border-color: var(--danger) !important;
      }

      .loading {
        display: none;
        color: var(--brand);
        font-style: italic;
        margin: 8px 0;
      }

      .patologias-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--line);
        border-radius: 6px;
        padding: 12px;
        background: #f8f9fa;
        margin-top: 12px;
      }

      .patologia-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin: 4px 0;
        background: white;
        border-radius: 4px;
        border: 1px solid #e5e7eb;
      }

      .patologia-item input[type="checkbox"] {
        margin-right: 12px;
        width: 16px;
        height: 16px;
      }

      .patologia-info {
        flex: 1;
      }

      .patologia-nombre {
        font-weight: 600;
        color: #374151;
        margin-bottom: 2px;
      }

      .patologia-cie10 {
        font-size: 12px;
        color: var(--muted);
      }

      .actions {
        text-align: center;
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid var(--line);
      }

      .form-row {
        display: flex;
        gap: 16px;
        align-items: end;
      }

      .form-row .form-group {
        flex: 1;
      }

      .required {
        color: var(--danger);
      }

      .usuario-info {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 6px;
        padding: 16px;
        margin: 16px 0;
      }

      .usuario-info h3 {
        margin: 0 0 8px 0;
        color: var(--brand);
        font-size: 16px;
      }

      .usuario-datos {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
        font-size: 13px;
      }

      .dato {
        display: flex;
      }

      .dato-label {
        font-weight: 600;
        color: #374151;
        min-width: 80px;
      }

      .dato-value {
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üö™ Egreso de Patolog√≠as</h1>
        <div>
          <a href="/" class="btn btn-secondary">‚Üê Volver al Inicio</a>
        </div>
      </div>

      <div
        class="alert alert-warning"
        style="
          border-left: 5px solid #f39c12;
          background: #fff8e1;
          color: #7a5d00;
        "
      >
        <strong>‚ÑπÔ∏è Nota:</strong> La clasificaci√≥n de
        <em>patolog√≠as modificables / no modificables</em> que ver√° abajo se
        aplica <u>√∫nicamente</u> a las patolog√≠as y diagn√≥sticos actualmente
        registrados para el usuario. Para agregar nuevas patolog√≠as debe hacerlo
        desde el formulario principal de ingreso/edici√≥n.
      </div>

      {% if mensaje %}
      <div class="alert alert-{{ 'success' if exito else 'error' }}">
        {{ mensaje }}
      </div>
      {% endif %}

      <form method="POST" id="form-egreso-patologia">
        <div class="card">
          <div class="card-header">1. Buscar Usuario</div>

          <div class="form-row">
            <div class="form-group">
              <label for="run"
                >RUN del Usuario <span class="required">*</span></label
              >
              <input
                type="text"
                id="run"
                name="run"
                class="run-input"
                placeholder="00.000.000-0"
                value="{{ request.form.get('run', '') }}"
                maxlength="12"
                required
              />
              <small class="loading" id="loading">üîÑ Buscando usuario...</small>
            </div>
            <div class="form-group">
              <button type="button" id="btn-buscar" class="btn btn-primary">
                üîç Buscar Usuario
              </button>
            </div>
          </div>

          <!-- Informaci√≥n del usuario (se llena din√°micamente) -->
          <div id="usuario-info" class="usuario-info" style="display: none">
            <h3>Informaci√≥n del Usuario</h3>
            <div class="usuario-datos" id="usuario-datos">
              <!-- Se llena con JavaScript -->
            </div>
          </div>
        </div>

        <div class="card" id="card-patologias" style="display: none">
          <div class="card-header">2. Seleccionar Patolog√≠as a Egresar</div>

          <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Importante:</strong>
            Puedes egresar la mayor√≠a de patolog√≠as. Solo est√°n restringidas las
            condiciones m√©dicas cr√≠ticas como: ‚Ä¢ Enfermedades cardiovasculares
            graves (infartos, ACV) ‚Ä¢ Diabetes tipo 1 y IRC estadio 5 ‚Ä¢
            Enfermedades degenerativas cr√≥nicas ‚Ä¢ Malformaciones cong√©nitas
          </div>

          <div id="patologias-container">
            <!-- Se llena din√°micamente con las patolog√≠as del usuario -->
          </div>
        </div>

        <div class="card" id="card-datos-egreso" style="display: none">
          <div class="card-header">3. Datos del Egreso</div>

          <div class="form-grid">
            <div class="form-group">
              <label for="motivo_egreso"
                >Motivo del Egreso <span class="required">*</span></label
              >
              <select
                id="motivo_egreso"
                name="motivo_egreso"
                data-required="true"
              >
                <option value="">Seleccionar motivo...</option>
                <option value="resolucion_patologia">
                  Resoluci√≥n de la patolog√≠a
                </option>
                <option value="mejoria_clinica">
                  Mejor√≠a cl√≠nica significativa
                </option>
                <option value="cambio_diagnostico">
                  Cambio de diagn√≥stico
                </option>
                <option value="error_inicial">
                  Error en diagn√≥stico inicial
                </option>
                <option value="traslado_otro_centro">
                  Traslado a otro centro
                </option>
                <option value="fallecimiento">
                  Fallecimiento del paciente
                </option>
                <option value="alta_voluntaria">
                  Alta voluntaria del paciente
                </option>
                <option value="otros">Otros</option>
              </select>
            </div>

            <div class="form-group">
              <label for="fecha_egreso"
                >Fecha de Egreso <span class="required">*</span></label
              >
              <input
                type="date"
                id="fecha_egreso"
                name="fecha_egreso"
                value=""
                required
              />
            </div>

            <div class="form-group">
              <label for="funcionario"
                >Funcionario Responsable <span class="required">*</span></label
              >
              <input
                type="text"
                id="funcionario"
                name="funcionario"
                value="{{ usuario_actual }}"
                placeholder="Nombre del funcionario"
                readonly
                required
              />
              <small style="color: #6c757d; font-size: 12px">
                üë§ Se completa automaticamente con tu usuario conectado
              </small>
            </div>

            <div class="form-group">
              <label for="password_confirmacion"
                >Contrase√±a de Confirmaci√≥n
                <span class="required">*</span></label
              >
              <input
                type="password"
                id="password_confirmacion"
                name="password_confirmacion"
                placeholder="Ingrese su contrase√±a para confirmar el egreso"
                data-required="true"
              />
              <small style="color: #6c757d; font-size: 12px">
                üîí Se requiere confirmaci√≥n para egresar patolog√≠as
              </small>
            </div>
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones Adicionales</label>
            <textarea
              id="observaciones"
              name="observaciones"
              rows="4"
              placeholder="Detalles adicionales sobre el egreso de las patolog√≠as..."
            ></textarea>
          </div>
        </div>

        <div class="actions">
          <button
            type="submit"
            class="btn btn-danger"
            id="btn-registrar"
            style="display: none"
          >
            üö™ Registrar Egreso de Patolog√≠as
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            onclick="limpiarFormulario()"
          >
            üîÑ Limpiar Formulario
          </button>
        </div>
      </form>
    </div>

    <script>
      console.log("üéØ Inicializando formulario de egreso de patolog√≠as...");

      let usuarioActual = null;
      let patologiasUsuario = [];

      // Establecer fecha actual por defecto
      document.addEventListener("DOMContentLoaded", function () {
        const fechaInput = document.getElementById("fecha_egreso");
        const today = new Date().toISOString().split("T")[0];
        fechaInput.value = today;
        fechaInput.max = today;

        console.log("‚úÖ Fecha actual establecida:", today);
      });

      // Funci√≥n para formatear RUN chileno a formato can√≥nico: 10.000.141-1
      function formatearRunCanonico(run) {
        if (!run) return "";
        // Elimina espacios y caracteres no v√°lidos
        run = (run + "").replace(/[^0-9kK]/g, "").toUpperCase();
        if (run.length < 2) return run;
        const cuerpo = run.slice(0, -1);
        const dv = run.slice(-1);
        // Agrega puntos cada 3 d√≠gitos desde la derecha
        let cuerpoConPuntos = "";
        for (let i = cuerpo.length; i > 0; i -= 3) {
          const start = Math.max(i - 3, 0);
          const chunk = cuerpo.substring(start, i);
          cuerpoConPuntos = (start > 0 ? "." : "") + chunk + cuerpoConPuntos;
        }
        return cuerpoConPuntos + "-" + dv;
      }

      // Funci√≥n para normalizar RUN (solo n√∫meros y K)
      function normalizarRun(run) {
        return run.replace(/[^0-9kK]/gi, "").toUpperCase();
      }

      // Funci√≥n para validar RUN
      function validarRun(run) {
        const limpio = run.replace(/[^0-9kK]/gi, "").toUpperCase();
        if (limpio.length < 8 || limpio.length > 9) return false;

        const cuerpo = limpio.slice(0, -1);
        const dv = limpio.slice(-1);

        let suma = 0;
        let multiplicador = 2;

        for (let i = cuerpo.length - 1; i >= 0; i--) {
          suma += parseInt(cuerpo[i]) * multiplicador;
          multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
        }

        const resto = suma % 11;
        const dvCalculado =
          resto === 0 ? "0" : resto === 1 ? "K" : (11 - resto).toString();

        return dv === dvCalculado;
      }

      // Event listeners para el RUN
      document.getElementById("run").addEventListener("input", function () {
        const input = this;
        let valor = input.value;

        // Guardar posici√≥n del cursor
        const cursorPos = input.selectionStart;
        const valorAnterior = valor;

        // Normalizar: solo n√∫meros y K
        const limpio = valor.replace(/[^0-9kK]/gi, "").toUpperCase();

        // Formatear autom√°ticamente si tiene al menos 2 caracteres
        if (limpio.length >= 2) {
          const cuerpo = limpio.slice(0, -1);
          const dv = limpio.slice(-1);

          // Agregar puntos cada 3 d√≠gitos desde la derecha
          let cuerpoConPuntos = "";
          for (let i = cuerpo.length; i > 0; i -= 3) {
            const start = Math.max(i - 3, 0);
            const chunk = cuerpo.substring(start, i);
            cuerpoConPuntos = (start > 0 ? "." : "") + chunk + cuerpoConPuntos;
          }

          valor = cuerpoConPuntos + "-" + dv;
        } else {
          valor = limpio;
        }

        input.value = valor;

        // Ajustar cursor para mantener la posici√≥n relativa
        const diff = valor.length - valorAnterior.length;
        input.setSelectionRange(cursorPos + diff, cursorPos + diff);

        // Validar si tiene longitud suficiente
        if (limpio.length >= 8) {
          if (validarRun(limpio)) {
            input.classList.remove("run-invalid");
            input.classList.add("run-valid");
          } else {
            input.classList.remove("run-valid");
            input.classList.add("run-invalid");
          }
        } else {
          input.classList.remove("run-valid", "run-invalid");
        }

        // Ocultar informaci√≥n previa si cambia el RUN
        document.getElementById("usuario-info").style.display = "none";
        document.getElementById("card-patologias").style.display = "none";
        document.getElementById("card-datos-egreso").style.display = "none";
        document.getElementById("btn-registrar").style.display = "none";
        usuarioActual = null;
        patologiasUsuario = [];
      });

      // Formatear al salir del campo
      document.getElementById("run").addEventListener("blur", function () {
        const input = this;
        const valor = input.value.trim();

        if (valor) {
          const normalizado = normalizarRun(valor);
          const formateado = formatearRunCanonico(normalizado);
          input.value = formateado;

          // Validar
          if (normalizado.length >= 8) {
            if (validarRun(normalizado)) {
              input.classList.remove("run-invalid");
              input.classList.add("run-valid");
            } else {
              input.classList.remove("run-valid");
              input.classList.add("run-invalid");
            }
          } else {
            input.classList.remove("run-valid", "run-invalid");
          }
        }
      });

      // Buscar usuario
      document
        .getElementById("btn-buscar")
        .addEventListener("click", function () {
          const run = document.getElementById("run").value.trim();

          if (!run) {
            alert("‚ö†Ô∏è Ingrese un RUN");
            return;
          }

          if (!validarRun(run)) {
            alert("‚ö†Ô∏è RUN inv√°lido");
            return;
          }

          buscarUsuario(run);
        });

      function buscarUsuario(run) {
        const loading = document.getElementById("loading");

        loading.style.display = "block";

        console.log("üîç [EGRESO] Buscando usuario con RUN:", run);
        console.log("üîç [EGRESO] RUN codificado:", encodeURIComponent(run));
        console.log(
          "üîç [EGRESO] URL completa:",
          `/api/usuario/${encodeURIComponent(run)}`,
        );

        // Usar el RUN tal como est√° (con formato)
        fetch(`/api/usuario/${encodeURIComponent(run)}`)
          .then((response) => {
            console.log("üîç [EGRESO] Response status:", response.status);
            console.log("üîç [EGRESO] Response ok:", response.ok);
            return response.json();
          })
          .then((data) => {
            loading.style.display = "none";
            console.log("üîç [EGRESO] Data recibida:", data);

            if (data.error) {
              console.error("‚ùå [EGRESO] Error en data:", data.error);
              alert("‚ùå Usuario no encontrado");
              return;
            }

            usuarioActual = data;
            mostrarInformacionUsuario(data);
            cargarPatologiasUsuario(run); // Usar el RUN original tambi√©n aqu√≠
          })
          .catch((error) => {
            loading.style.display = "none";
            console.error("‚ùå [EGRESO] Error capturado:", error);
            alert("‚ùå Error buscando usuario");
          });
      }

      function mostrarInformacionUsuario(usuario) {
        const container = document.getElementById("usuario-datos");
        const edad = usuario.edad ? `${usuario.edad} a√±os` : "No especificada";

        container.innerHTML = `
                <div class="dato">
                    <span class="dato-label">Nombre:</span>
                    <span class="dato-value">${usuario.nombre || "No especificado"}</span>
                </div>
                <div class="dato">
                    <span class="dato-label">RUN:</span>
                    <span class="dato-value">${usuario.run}</span>
                </div>
                <div class="dato">
                    <span class="dato-label">Edad:</span>
                    <span class="dato-value">${edad}</span>
                </div>
                <div class="dato">
                    <span class="dato-label">Sexo:</span>
                    <span class="dato-value">${usuario.sexo || "No especificado"}</span>
                </div>
                <div class="dato">
                    <span class="dato-label">Sector:</span>
                    <span class="dato-value">${usuario.sector_nombre || usuario.sector_id || "No especificado"}</span>
                </div>
                <div class="dato">
                    <span class="dato-label">Categor√≠a:</span>
                    <span class="dato-value">${usuario.categoria_nombre || "No especificada"}</span>
                </div>
            `;

        document.getElementById("usuario-info").style.display = "block";
      }

      function cargarPatologiasUsuario(run) {
        fetch(`/api/usuario/${encodeURIComponent(run)}/patologias-diagnosticos`)
          .then((response) => response.json())
          .then((data) => {
            if (data.patologias || data.diagnosticos) {
              // Combinar patolog√≠as y diagn√≥sticos
              const todasLasCondiciones = [];

              // Agregar patolog√≠as
              if (data.patologias) {
                data.patologias.forEach((patologia) => {
                  todasLasCondiciones.push({
                    ...patologia,
                    tipo: "patologia",
                    origen: "Patolog√≠a registrada",
                  });
                });
              }

              // Agregar diagn√≥sticos
              if (data.diagnosticos) {
                data.diagnosticos.forEach((diagnostico) => {
                  todasLasCondiciones.push({
                    ...diagnostico,
                    tipo: "diagnostico",
                    origen: `Diagn√≥stico ${diagnostico.fecha_diagnostico ? "(" + diagnostico.fecha_diagnostico + ")" : ""}`,
                  });
                });
              }

              patologiasUsuario = todasLasCondiciones;
              mostrarPatologiasModificables(todasLasCondiciones);
            } else {
              mostrarPatologiasModificables([]);
            }
          })
          .catch((error) => {
            console.error("Error cargando patolog√≠as y diagn√≥sticos:", error);
            mostrarPatologiasModificables([]);
          });
      }

      function esPatologiaModificable(cie10) {
        const c = String(cie10 || "").toUpperCase();
        if (!c) return false;

        const startsWithAny = (s, arr) => arr.some((p) => s.startsWith(p));

        // === PATOLOG√çAS SIEMPRE NO MODIFICABLES (CR√çTICAS) ===
        // Estas nunca se pueden egresar por seguridad m√©dica
        const noModificables = [
          // Enfermedades cardiovasculares graves
          "I21",
          "I22", // Infarto agudo de miocardio
          "I46", // Paro card√≠aco
          "I60",
          "I61",
          "I63",
          "I64", // ACV y hemorragias cerebrales

          // Enfermedades renales cr√≥nicas graves
          "N18.6", // Enfermedad renal cr√≥nica estadio 5
          "N19", // Enfermedad renal no especificada

          // Diabetes tipo 1 (nunca se "cura")
          "E10", // Diabetes mellitus tipo 1

          // Hipertensi√≥n esencial (raramente se "cura")
          "I10", // Hipertensi√≥n esencial

          // Enfermedades cr√≥nicas degenerativas
          "G20", // Enfermedad de Parkinson
          "G30", // Enfermedad de Alzheimer
          "G35", // Esclerosis m√∫ltiple

          // VIH/SIDA
          "B20",
          "B21",
          "B22",
          "B23",
          "B24", // VIH

          // Trastornos cong√©nitos
          "Q", // Todos los c√≥digos Q (malformaciones cong√©nitas)
        ];

        // Verificar si es una patolog√≠a cr√≠tica no modificable
        if (noModificables.some((codigo) => c.startsWith(codigo))) {
          return false;
        }

        // === PATOLOG√çAS MODIFICABLES (AMPLIADO) ===

        // Trastornos mentales y del comportamiento (F00-F99)
        if (c[0] === "F") return true;

        // Enfermedades endocrinas, nutricionales y metab√≥licas (E00-E89) - EXCEPTO diabetes tipo 1
        if (c[0] === "E" && !c.startsWith("E10")) return true;

        // Anemias y trastornos hematol√≥gicos (D50-D89)
        if (c[0] === "D") return true;

        // Neoplasias (C00-D48) - todas pueden cambiar de estado
        if (c[0] === "C") return true;

        // Factores psicosociales (Z00-Z99)
        if (c[0] === "Z") return true;

        // Enfermedades del sistema respiratorio (J00-J99)
        if (c[0] === "J") return true;

        // Enfermedades del sistema digestivo (K00-K95)
        if (c[0] === "K") return true;

        // Enfermedades de la piel (L00-L99)
        if (c[0] === "L") return true;

        // Enfermedades del sistema musculoesquel√©tico (M00-M99)
        if (c[0] === "M") return true;

        // Enfermedades del sistema genitourinario (N00-N99) - EXCEPTO IRC estadio 5
        if (c[0] === "N" && !c.startsWith("N18.6") && !c.startsWith("N19"))
          return true;

        // Traumatismos, envenenamientos (S00-T98)
        if (c[0] === "S" || c[0] === "T") return true;

        // Causas externas (V01-Y98)
        if (c[0] === "V" || c[0] === "W" || c[0] === "X" || c[0] === "Y")
          return true;

        // Enfermedades del ojo (H00-H59)
        if (
          c.startsWith("H0") ||
          c.startsWith("H1") ||
          c.startsWith("H2") ||
          c.startsWith("H3") ||
          c.startsWith("H4") ||
          c.startsWith("H5")
        )
          return true;

        // Enfermedades del o√≠do (H60-H95)
        if (
          c.startsWith("H6") ||
          c.startsWith("H7") ||
          c.startsWith("H8") ||
          c.startsWith("H9")
        )
          return true;

        // Algunas enfermedades cardiovasculares modificables
        const cardiovascularesModificables = [
          "I83", // Varices
          "I84", // Hemorroides
          "I87", // Otros trastornos venosos
          "I25.1", // Aterosclerosis coronaria
          "I25.9", // Cardiopat√≠a isqu√©mica cr√≥nica
          "I48", // Fibrilaci√≥n/flutter auricular (puede controlarse)
          "I49", // Otras arritmias
          "I50", // Insuficiencia card√≠aca (puede mejorar)
        ];

        if (cardiovascularesModificables.some((codigo) => c.startsWith(codigo)))
          return true;

        // Por defecto, permitir modificar (enfoque menos restrictivo)
        return true;
      }

      function mostrarPatologiasModificables(patologias) {
        const container = document.getElementById("patologias-container");

        if (patologias.length === 0) {
          container.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ÑπÔ∏è Sin patolog√≠as</strong><br>
                        Este usuario no tiene patolog√≠as registradas en el sistema.
                    </div>
                `;
          document.getElementById("card-patologias").style.display = "block";
          return;
        }

        // Separar patolog√≠as modificables y no modificables
        const modificables = patologias.filter((p) =>
          esPatologiaModificable(p.cie10),
        );
        const noModificables = patologias.filter(
          (p) => !esPatologiaModificable(p.cie10),
        );

        let html = "";

        if (modificables.length > 0) {
          html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #198754; margin-bottom: 12px;">‚úÖ Patolog√≠as Modificables (${modificables.length})</h4>
                        <div class="patologias-list">
                `;

          modificables.forEach((p) => {
            html += `
                        <div class="patologia-item">
                            <input type="checkbox" name="patologias_egreso" value="${p.cie10}" id="pat_${p.cie10}">
                            <div class="patologia-info">
                                <div class="patologia-nombre">${p.nombre || p.nombre_patologia_cie10 || "Sin nombre"}</div>
                                <div class="patologia-cie10">CIE10: ${p.cie10}</div>
                            </div>
                        </div>
                    `;
          });

          html += `
                        </div>
                        <div style="margin-top: 12px;">
                            <button type="button" class="btn btn-secondary" onclick="seleccionarTodas(true)">‚úì Seleccionar Todas</button>
                            <button type="button" class="btn btn-secondary" onclick="deseleccionarTodas()">‚úó Deseleccionar Todas</button>
                        </div>
                    </div>
                `;
        }

        if (noModificables.length > 0) {
          html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #dc3545; margin-bottom: 12px;">üîí Patolog√≠as No Modificables (${noModificables.length})</h4>
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Informaci√≥n:</strong> Las siguientes patolog√≠as no pueden ser egresadas por razones de seguridad m√©dica (enfermedades cr√≥nicas graves, cong√©nitas o de alto riesgo).
                        </div>
                        <div class="patologias-list" style="opacity: 0.7;">
                `;

          noModificables.forEach((p) => {
            html += `
                        <div class="patologia-item" style="background: #f8f9fa; border-color: #dee2e6;">
                            <input type="checkbox" disabled style="opacity: 0.5;">
                            <div class="patologia-info">
                                <div class="patologia-nombre" style="color: #6c757d;">${p.nombre || p.nombre_patologia_cie10 || "Sin nombre"}</div>
                                <div class="patologia-cie10" style="color: #6c757d;">CIE10: ${p.cie10} ‚Ä¢ No modificable</div>
                            </div>
                        </div>
                    `;
          });

          html += `
                        </div>
                    </div>
                `;
        }

        if (modificables.length === 0) {
          html = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Sin patolog√≠as modificables</strong><br>
                        Este usuario solo tiene patolog√≠as cr√≠ticas que no pueden ser egresadas por razones de seguridad m√©dica.
                        <details style="margin-top: 8px;">
                            <summary style="cursor: pointer; color: #0d6efd;">Ver patolog√≠as no modificables (${noModificables.length})</summary>
                            <div style="margin-top: 8px; font-size: 13px;">
                                ${noModificables.map((p) => `‚Ä¢ ${p.cie10}: ${p.nombre || p.nombre_patologia_cie10 || "Sin nombre"}`).join("<br>")}
                            </div>
                        </details>
                    </div>
                `;
        }

        container.innerHTML = html;
        document.getElementById("card-patologias").style.display = "block";

        if (modificables.length > 0) {
          const cardEgreso = document.getElementById("card-datos-egreso");
          cardEgreso.style.display = "block";

          // Agregar atributo required a los campos cuando se muestran
          document.querySelectorAll('[data-required="true"]').forEach((el) => {
            el.setAttribute("required", "required");
          });

          document.getElementById("btn-registrar").style.display =
            "inline-block";

          // Event listener para cambios en checkboxes
          document
            .querySelectorAll('input[name="patologias_egreso"]')
            .forEach((checkbox) => {
              checkbox.addEventListener("change", validarSeleccion);
            });
        } else {
          document.getElementById("card-datos-egreso").style.display = "none";
          document.getElementById("btn-registrar").style.display = "none";
        }
      }

      function seleccionarTodas(soloModificables = false) {
        const checkboxes = document.querySelectorAll(
          'input[name="patologias_egreso"]:not(:disabled)',
        );
        checkboxes.forEach((cb) => (cb.checked = true));
        validarSeleccion();
      }

      function deseleccionarTodas() {
        const checkboxes = document.querySelectorAll(
          'input[name="patologias_egreso"]',
        );
        checkboxes.forEach((cb) => (cb.checked = false));
        validarSeleccion();
      }

      function validarSeleccion() {
        const seleccionadas = document.querySelectorAll(
          'input[name="patologias_egreso"]:checked',
        );
        const btnRegistrar = document.getElementById("btn-registrar");

        if (seleccionadas.length > 0) {
          btnRegistrar.textContent = `üö™ Registrar Egreso de ${seleccionadas.length} Patolog√≠a(s)`;
          btnRegistrar.disabled = false;
        } else {
          btnRegistrar.textContent = "üö™ Registrar Egreso de Patolog√≠as";
          btnRegistrar.disabled = true;
        }
      }

      function limpiarFormulario() {
        document.getElementById("form-egreso-patologia").reset();
        document.getElementById("usuario-info").style.display = "none";
        document.getElementById("card-patologias").style.display = "none";
        document.getElementById("card-datos-egreso").style.display = "none";
        document.getElementById("btn-registrar").style.display = "none";
        document
          .getElementById("run")
          .classList.remove("run-valid", "run-invalid");
        usuarioActual = null;
        patologiasUsuario = [];
      }

      // Validaci√≥n del formulario antes de enviar
      document
        .getElementById("form-egreso-patologia")
        .addEventListener("submit", function (e) {
          const seleccionadas = document.querySelectorAll(
            'input[name="patologias_egreso"]:checked',
          );
          const password = document
            .getElementById("password_confirmacion")
            .value.trim();

          if (seleccionadas.length === 0) {
            e.preventDefault();
            alert("‚ö†Ô∏è Debe seleccionar al menos una patolog√≠a para egresar");
            return;
          }

          if (!password) {
            e.preventDefault();
            alert("‚ö†Ô∏è Debe ingresar su contrase√±a para confirmar el egreso");
            document.getElementById("password_confirmacion").focus();
            return;
          }

          const confirmacion = confirm(
            `‚ö†Ô∏è ¬øEst√° seguro de registrar el egreso de ${seleccionadas.length} patolog√≠a(s)?\n\nüîí Esta acci√≥n se registrar√° permanentemente en public.egresos_patologias con su usuario.\n\nüìã Patolog√≠as a egresar:\n${Array.from(
              seleccionadas,
            )
              .map((cb) => "‚Ä¢ " + cb.value)
              .join("\n")}`,
          );

          if (!confirmacion) {
            e.preventDefault();
            // Limpiar contrase√±a si cancela
            document.getElementById("password_confirmacion").value = "";
          }
        });

      console.log(
        "‚úÖ Formulario de egreso de patolog√≠as inicializado correctamente",
      );
    </script>
  </body>
</html>
