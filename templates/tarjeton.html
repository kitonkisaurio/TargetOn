{% extends 'base.html' %}
{% block title %}Tarjet√≥n Usuario{% endblock %}
{% block content %}
<header style="background:linear-gradient(135deg,rgba(248,250,252,0.85),rgba(229,231,235,0.78),rgba(203,213,225,0.7));border-radius:18px;padding:34px 28px;margin-bottom:22px;position:relative;overflow:hidden;color:#0f172a;display:flex;align-items:center;justify-content:center;min-height:120px;">
  <div style="position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 75% 25%,rgba(255,255,255,0.28),transparent 60%);"></div>
  <div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;width:100%;position:relative;z-index:1;">
    <div style="display:flex;align-items:center;justify-content:center;flex:1;gap:22px;">
              </div>
              
              <!-- Fecha de evaluaci√≥n -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  Fecha de evaluaci√≥n
                </label>
                <input type="date" id="fechaActividadFisica" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
              </div>
              
              <!-- Botones de acci√≥n -->
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="guardarActividadFisica()" class="btn" style="font-size:.75rem;background:#16a34a;color:white;border:1px solid #15803d;padding:6px 12px;">
                  üíæ Guardar
                </button>
                <button type="button" onclick="limpiarFormularioActividadFisica()" class="btn btn-outlined" style="font-size:.75rem;">
                  Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de actividad f√≠sica -->
            <div id="historialActividadFisica" style="margin-top:16px;display:none;">
              <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üìã Historial de Actividad F√≠sica
              </h5>
              <div id="listHistorialActividadFisica" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- Se carga din√°micamente -->
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n de MasAma -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;margin-top:12px;">
            <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
              üîç MasAma
            </h4>
            
            <form id="masAmaForm" style="display:grid;gap:10px;">
              <!-- ¬øMasAma positivo? -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  ¬øMasAma positivo?
                </label>
                <div style="display:flex;gap:12px;">
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="masAma" value="si" required>
                    S√≠
                  </label>
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="masAma" value="no" required>
                    No
                  </label>
                </div>
              </div>
              
              <!-- Fecha de evaluaci√≥n -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  Fecha de evaluaci√≥n
                </label>
                <input type="date" id="fechaMasAma" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
              </div>
              
              <!-- Botones de acci√≥n -->
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="guardarMasAma()" class="btn" style="font-size:.75rem;background:#3b82f6;color:white;border:1px solid #2563eb;padding:6px 12px;">
                  üíæ Guardar
                </button>
                <button type="button" onclick="limpiarFormularioMasAma()" class="btn btn-outlined" style="font-size:.75rem;">
                  Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de MasAma -->
            <div id="historialMasAma" style="margin-top:16px;display:none;">
              <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üìã Historial de MasAma
              </h5>
              <div id="listHistorialMasAma" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- Se carga din√°micamente -->
              </div>
            </div>
          </div>
        </div>
        </div>
  <div data-panel="diabetes" style="padding:8px 10px 12px;display:none;">
          <!-- Contenido completo de Evaluaci√≥n Diabetes -->
          <h3 style="margin:0 0 8px;font-size:.95rem;display:flex;align-items:center;gap:6px;font-weight:600;">ü©∫ Evaluaci√≥n Diabetes</h3>
          
          <!-- Primera fila: Evaluaci√≥n Pie Diab√©tico + Comorbilidad/Secuelas -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Evaluaci√≥n Pie Diab√©tico -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px 0;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü¶∂ Evaluaci√≥n Pie Diab√©tico
              </h4>
            
              <form id="evaluacionPieDiabeticoForm" style="display:grid;gap:10px;">
                <!-- ¬øTiene amputaci√≥n o √∫lcera activa? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene amputaci√≥n o √∫lcera activa?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ulceraPieOAmputacion" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ulceraPieOAmputacion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¬øSensibilidad protectora alterada? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSensibilidad protectora alterada?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="sensibilidadProtectora" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="sensibilidadProtectora" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¬øEnfermedad arterial perif√©rica? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øEnfermedad arterial perif√©rica?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="EAP" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="EAP" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¬øTiene deformidad? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene deformidad?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="DEF" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="DEF" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluaci√≥n
                  </label>
                  <input type="date" id="fechaEvaluacionPieDiabetico" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="evaluarRiesgoPieDiabetico()" class="btn btn-azul" style="font-size:.75rem;">
                    Evaluar Riesgo
                  </button>
                  <button type="button" id="btnGuardarPieDiabetico" onclick="guardarEvaluacionPieDiabetico()" class="btn" style="font-size:.75rem !important;background:#16a34a !important;color:white !important;border:1px solid #15803d !important;padding:6px 12px !important;opacity:1 !important;cursor:not-allowed !important;display:inline-flex !important;align-items:center !important;justify-content:center !important;gap:6px !important;min-width:120px !important;pointer-events:none !important;visibility:visible !important;" data-disabled="true" aria-disabled="true">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioPieDiabetico()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
                <div id="estadoPieDiabetico" role="status" style="display:none;font-size:.7rem;margin-top:4px;"></div>
                
                <!-- Resultado -->
                <div id="resultadoPieDiabetico" class="espacioresultado" style="margin-top:12px;padding:12px;border-radius:6px;background:#f1f5f9;border:1px solid #cbd5e1;display:none;">
                  <div class="resultado-contenido" style="font-size:.8rem;line-height:1.4;"></div>
                </div>
              </form>
              
              <!-- Historial de evaluaciones -->
              <div id="historialPieDiabetico" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Evaluaciones
                </h5>
                <div id="listHistorialPieDiabetico" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Comorbilidad/Secuelas -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üìä Comorbilidad / Secuelas
              </h4>
              
              <!-- Panel de diagn√≥sticos detectados -->
              <div id="comorbilidadPanel" style="display:grid;gap:10px;">
                <!-- Estado de carga -->
                <div id="comorbilidadEstado" style="padding:8px;text-align:center;color:#6b7280;font-size:0.75rem;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;">
                  <span>Analizando diagn√≥sticos...</span>
                </div>
                
                <!-- Contenedor de diagn√≥sticos -->
                <div id="diagnosticosDetectados" style="display:none;gap:8px;">
                  <!-- Diagn√≥sticos se activan din√°micamente -->
                  <div id="diagnosticoTabaquismo" style="display:none;padding:10px 12px;border:1px solid #f97316;border-radius:6px;background:linear-gradient(135deg,#fff7ed,#ffedd5);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">üö¨</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#9a3412;">Tabaquismo activo</div>
                          <div style="font-size:0.7rem;color:#9a3412;">Priorizar consejer√≠a y tratamiento de cesaci√≥n</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#9a3412;background:#fdba74;padding:2px 6px;border-radius:999px;">Riesgo CV</span>
                    </div>
                  </div>

                  <div id="diagnosticoErcLeve" style="display:none;padding:10px 12px;border:1px solid #0ea5e9;border-radius:6px;background:linear-gradient(135deg,#eff6ff,#dbeafe);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">üß™</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#1d4ed8;">ERC leve-moderada</div>
                          <div style="font-size:0.7rem;color:#1d4ed8;">Monitorear funci√≥n renal y albuminuria</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#1d4ed8;background:#bfdbfe;padding:2px 6px;border-radius:999px;">Nefroprotecci√≥n</span>
                    </div>
                  </div>

                  <div id="diagnosticoErcAvanzada" style="display:none;padding:10px 12px;border:1px solid #2563eb;border-radius:6px;background:linear-gradient(135deg,#e0f2ff,#bfdbfe);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">ü©∫</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#1e3a8a;">ERC avanzada</div>
                          <div style="font-size:0.7rem;color:#1e3a8a;">Coordinar con nefrolog√≠a y ajustar plan terap√©utico</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#1e3a8a;background:#93c5fd;padding:2px 6px;border-radius:999px;">Alerta</span>
                    </div>
                  </div>

                  <div id="diagnosticoAcv" style="display:none;padding:10px 12px;border:1px solid #f97316;border-radius:6px;background:linear-gradient(135deg,#fff7ed,#fffbeb);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">üß†</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#b45309;">Antecedente de ACV/AVE</div>
                          <div style="font-size:0.7rem;color:#b45309;">Optimizar prevenci√≥n secundaria y control de factores</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#b45309;background:#fcd34d;padding:2px 6px;border-radius:999px;">Prioridad alta</span>
                    </div>
                  </div>

                  <div id="diagnosticoIam" style="display:none;padding:10px 12px;border:1px solid #dc2626;border-radius:6px;background:linear-gradient(135deg,#fef2f2,#fee2e2);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">‚ù§Ô∏è</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#991b1b;">Antecedente de IAM</div>
                          <div style="font-size:0.7rem;color:#991b1b;">Revisar antiagregaci√≥n, estatinas e IECA/ARA II</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#991b1b;background:#fecaca;padding:2px 6px;border-radius:999px;">Cardiolog√≠a</span>
                    </div>
                  </div>

                  <div id="diagnosticoInsulina" style="display:none;padding:10px 12px;border:1px solid #6366f1;border-radius:6px;background:linear-gradient(135deg,#eef2ff,#e0e7ff);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">üíâ</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#4338ca;">Uso activo de insulina</div>
                          <div style="font-size:0.7rem;color:#4338ca;">Coordinar controles y educaci√≥n en manejo de hipoglicemias</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#4338ca;background:#c7d2fe;padding:2px 6px;border-radius:999px;">Seguimiento</span>
                    </div>
                  </div>

                  <div id="recomendacionIecaAra" style="display:none;padding:10px 12px;border:1px dashed #1d4ed8;border-radius:6px;background:#eff6ff;color:#1d4ed8;font-size:0.75rem;line-height:1.4;">
                    üí° Recomendaci√≥n: evaluar IECA/ARA II por nefroprotecci√≥n y control de presi√≥n arterial.
                  </div>
                </div>

                <div id="sinDiagnosticos" style="display:none;padding:12px;text-align:center;border:1px solid #e5e7eb;border-radius:6px;background:#f8fafc;color:#475569;font-size:0.75rem;">
                  ‚úÖ Sin comorbilidades o secuelas relevantes detectadas para diabetes.
                </div>
              </div>
            </div>
          </div>
          
          <!-- Segunda fila: Curaciones + EKG -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Curaciones Pie Diab√©tico -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü©π Curaciones Pie Diab√©tico
              </h4>
              
              <form id="curacionesPieDiabeticoForm" style="display:grid;gap:10px;">
                <!-- ¬øSe encuentra en curaciones? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSe encuentra en curaciones?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="enCuracion" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="enCuracion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Tipo de curaci√≥n (solo si est√° en curaciones) -->
                <div id="tipoCuracionContainer" style="display:none;">
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Tipo de curaci√≥n
                  </label>
                  <select id="tipoCuracion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                    <option value="">-- Seleccione tipo --</option>
                    <option value="Curaci√≥n Convencional">Curaci√≥n Convencional</option>
                    <option value="Curaci√≥n Avanzada">Curaci√≥n Avanzada</option>
                    <option value="Con ayuda t√©cnica de descarga">Con ayuda t√©cnica de descarga</option>
                  </select>
                </div>
                
                <!-- Fecha -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha
                  </label>
                  <input type="date" id="fechaCuracion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarCuracion()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioCuraciones()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de curaciones -->
              <div id="historialCuraciones" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Curaciones
                </h5>
                <div id="listHistorialCuraciones" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de EKG -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ‚ö° Electrocardiograma (EKG)
              </h4>
              
              <form id="ekgForm" style="display:grid;gap:10px;">
                <!-- ¬øSe realiz√≥ EKG? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSe realiz√≥ EKG?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ekgRealizado" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ekgRealizado" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha del EKG -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha del EKG
                  </label>
                  <input type="date" id="fechaEkg" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarEkg()" class="btn" style="font-size:.75rem;background:#7c3aed;color:white;border:1px solid #6d28d9;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioEkg()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de EKG -->
              <div id="historialEkg" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de EKG
                </h5>
                <div id="listHistorialEkg" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tercera fila: Hipoglicemias + Amputaci√≥n -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Hipoglicemias Recurrentes -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü©∏ Hipoglicemias Recurrentes
              </h4>
              
              <form id="hipoglicemiasForm" style="display:grid;gap:10px;">
                <!-- ¬øPresenta hipoglicemias recurrentes? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øPresenta hipoglicemias recurrentes?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="hipoglicemiasRecurrentes" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="hipoglicemiasRecurrentes" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluaci√≥n
                  </label>
                  <input type="date" id="fechaHipoglicemias" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarHipoglicemias()" class="btn" style="font-size:.75rem;background:#dc2626;color:white;border:1px solid #b91c1c;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioHipoglicemias()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de hipoglicemias -->
              <div id="historialHipoglicemias" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Hipoglicemias
                </h5>
                <div id="listHistorialHipoglicemias" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Amputaci√≥n -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü¶ø Amputaci√≥n
              </h4>
              
              <form id="amputacionForm" style="display:grid;gap:10px;">
                <!-- ¬øTiene amputaci√≥n? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene amputaci√≥n?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="tieneAmputacion" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="tieneAmputacion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de amputaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de amputaci√≥n
                  </label>
                  <input type="date" id="fechaAmputacion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarAmputacion()" class="btn" style="font-size:.75rem;background:#f59e0b;color:white;border:1px solid #d97706;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioAmputacion()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de amputaci√≥n -->
              <div id="historialAmputacion" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Amputaci√≥n
                </h5>
                <div id="listHistorialAmputacion" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
          </div>

          <!-- Tarjeta de Tratamiento con Insulina -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;margin-top:12px;">
            <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
              üíâ Tratamiento con Insulina
            </h4>

            <form id="insulinaForm" style="display:grid;gap:10px;">
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  ¬øSe encuentra en tratamiento con insulina?
                </label>
                <div style="display:flex;gap:12px;flex-wrap:wrap;">
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="enTratamientoInsulina" value="si" required>
                    S√≠
                  </label>
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="enTratamientoInsulina" value="no" required>
                    No
                  </label>
                </div>
              </div>

              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  Fecha de evaluaci√≥n
                </label>
                <input type="date" id="fechaInsulina" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
              </div>

              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="guardarInsulina()" class="btn" style="font-size:.75rem;background:#4338ca;color:white;border:1px solid #3730a3;padding:6px 12px;">
                  üíæ Guardar
                </button>
                <button type="button" onclick="limpiarFormularioInsulina()" class="btn btn-outlined" style="font-size:.75rem;">
                  Limpiar
                </button>
              </div>
            </form>

            <div id="historialInsulina" style="margin-top:16px;display:none;">
              <h5 style="margin:0 0 8px;font-size:.8rem;color:#4338ca;display:flex;align-items:center;gap:6px;">
                üìã Historial de Insulina
              </h5>
              <div id="listHistorialInsulina" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- Se carga din√°micamente -->
              </div>
            </div>
          </div>
          
          <!-- Cuarta fila: Atenci√≥n Pod√≥loga + Fondo de Ojos -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Atenci√≥n Pod√≥loga -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü¶∂ Atenci√≥n Pod√≥loga
              </h4>
              
              <form id="podologiaForm" style="display:grid;gap:10px;">
                <!-- ¬øTiene atenci√≥n podol√≥gica vigente? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene atenci√≥n podol√≥gica vigente?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="atencionPodologa" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="atencionPodologa" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluaci√≥n
                  </label>
                  <input type="date" id="fechaPodologia" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarPodologia()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioPodologia()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de atenci√≥n podol√≥gica -->
              <div id="historialPodologia" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Atenci√≥n Podol√≥gica
                </h5>
                <div id="listHistorialPodologia" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Fondo de Ojos -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üëÅÔ∏è Fondo de Ojos
              </h4>
              
              <form id="fondoOjosForm" style="display:grid;gap:10px;">
                <!-- ¬øSe realiz√≥ fondo de ojos? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSe realiz√≥ fondo de ojos?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="fondoOjos" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="fondoOjos" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha del fondo de ojos -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha del fondo de ojos
                  </label>
                  <input type="date" id="fechaFondoOjos" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" id="fondoOjosGuardarBtn" onclick="guardarFondoOjos()" class="btn" style="font-size:.75rem;background:#9333ea;color:white;border:1px solid #7c2d12;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" id="fondoOjosLimpiarBtn" onclick="limpiarFormularioFondoOjos()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de fondo de ojos -->
              <div id="historialFondoOjos" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Fondo de Ojos
                </h5>
                <div id="listHistorialFondoOjos" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
          </div>
        </div>
  <div data-panel="farmacos" hidden style="padding:8px 10px 12px;">
          <!-- Contenido de f√°rmacos -->
          <h3 style="margin:0 0 8px;font-size:.95rem;display:flex;align-items:center;gap:6px;font-weight:600;">üíä F√°rmacos</h3>
          <!-- Grid de f√°rmacos en filas -->
          <div style="display:grid;gap:10px;padding:8px;">
            
            <!-- Primera fila: IECA/ARA II -->
            <div id="seccionIecaAra" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;display:none;">
              <h4 style="margin:0 0 12px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü©∫ IECA / ARA II
                <span style="cursor:help;color:#6b7280;font-size:1rem;" title="Los IECA (Inhibidores de la Enzima Convertidora de Angiotensina) y los ARA II (Antagonistas del Receptor de Angiotensina II) son dos grupos de medicamentos que act√∫an sobre el sistema renina-angiotensina-aldosterona, fundamentales en el manejo de la hipertensi√≥n arterial, la insuficiencia card√≠aca, la nefroprotecci√≥n en diabetes/ERCT y la prevenci√≥n cardiovascular.

Aunque ambos reducen la acci√≥n de la angiotensina II (potente vasoconstrictor), lo hacen por mecanismos distintos:
‚Ä¢ ü©∫ IECA: bloquean la conversi√≥n de angiotensina I en angiotensina II.
‚Ä¢ ü©∫ ARA II: bloquean directamente el receptor AT1 de la angiotensina II.

üß™ Lista de medicamentos m√°s usados

ü©π IECA (Inhibidores de la ECA)
‚Ä¢ Enalapril (Enalapril¬Æ, Renitec¬Æ) - Muy utilizado en HTA y falla card√≠aca
‚Ä¢ Captopril (Capoten¬Æ) - Acci√≥n corta; √∫til en urgencias hipertensivas orales
‚Ä¢ Lisinopril (Zestril¬Æ, Prinivil¬Æ) - Alta duraci√≥n, uso diario
‚Ä¢ Ramipril (Tritace¬Æ) - Cardioprotector y nefroprotector
‚Ä¢ Perindopril (Coversyl¬Æ) - Muy usado en prevenci√≥n secundaria CV

üíä ARA II (Antagonistas del receptor de angiotensina II)
‚Ä¢ Losart√°n (Cozaar¬Æ) - Muy usado en HTA y nefroprotecci√≥n diab√©tica
‚Ä¢ Valsart√°n (Diovan¬Æ) - Cardioprotector post-IAM
‚Ä¢ Candesart√°n (Atacand¬Æ) - Alta potencia y duraci√≥n
‚Ä¢ Irbesart√°n (Aprovel¬Æ) - Excelente opci√≥n renal y CV
‚Ä¢ Olmesart√°n (Benicar¬Æ) - Larga acci√≥n, buen control 24 h

üß† Perlas cl√≠nicas:
‚Ä¢ Nunca se combinan IECA y ARA II juntos salvo indicaciones muy espec√≠ficas
‚Ä¢ En diab√©ticos con microalbuminuria o ERC, IECA o ARA II son primera l√≠nea
‚Ä¢ En insuficiencia card√≠aca con FEVI reducida, suelen ser parte del esquema base">‚ÑπÔ∏è</span>
              </h4>
              
              <form id="iecaAraForm" style="display:grid;gap:12px;">
                <!-- Tipo de medicaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Tipo de medicaci√≥n
                  </label>
                  <select id="tipoIecaAra" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;" required>
                    <option value="">-- Seleccione --</option>
                    <option value="NO">NO</option>
                    <option value="IECA">IECA</option>
                    <option value="ARA II">ARA II</option>
                  </select>
                </div>
                
                <!-- Fecha -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha
                  </label>
                  <input type="date" id="fechaIecaAra" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarIecaAra()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioIecaAra()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de IECA/ARA II -->
              <div id="historialIecaAra" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de IECA/ARA II
                </h5>
                <div id="listHistorialIecaAra" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Segunda fila: Estatinas + Antiagregante plaquetario -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <!-- Tarjeta de Estatinas -->
              <div id="seccionEstatinas" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;display:none;">
                <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üß™ Estatinas
                </h4>
                
                <form id="estatinasForm" style="display:grid;gap:10px;">
                  <!-- ¬øRecibe estatinas? -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ¬øRecibe estatinas?
                    </label>
                    <div style="display:flex;gap:12px;">
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeEstatinas" value="si" required>
                        S√≠
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeEstatinas" value="no" required>
                        No
                      </label>
                    </div>
                  </div>
                  
                  <!-- Fecha -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Fecha
                    </label>
                    <input type="date" id="fechaEstatinas" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                  </div>
                  
                  <!-- Botones de acci√≥n -->
                  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                    <button type="button" onclick="guardarEstatinas()" class="btn" style="font-size:.75rem;background:#7c3aed;color:white;border:1px solid #6d28d9;padding:6px 12px;">
                      üíæ Guardar
                    </button>
                    <button type="button" onclick="limpiarFormularioEstatinas()" class="btn btn-outlined" style="font-size:.75rem;">
                      Limpiar
                    </button>
                  </div>
                </form>
                
                <!-- Historial de estatinas -->
                <div id="historialEstatinas" style="margin-top:16px;display:none;">
                  <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                    üìã Historial de Estatinas
                  </h5>
                  <div id="listHistorialEstatinas" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
              
              <!-- Tarjeta de Antiagregante plaquetario -->
              <div id="seccionAntiagregantes" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;display:none;">
                <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  ü©∏ Antiagregante Plaquetario
                </h4>
                
                <form id="antiagregantesForm" style="display:grid;gap:10px;">
                  <!-- ¬øRecibe antiagregantes? -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ¬øRecibe antiagregante plaquetario?
                    </label>
                    <div style="display:flex;gap:12px;">
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeAntiagregantes" value="si" required>
                        S√≠
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeAntiagregantes" value="no" required>
                        No
                      </label>
                    </div>
                  </div>
                  
                  <!-- Fecha -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Fecha
                    </label>
                    <input type="date" id="fechaAntiagregantes" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                  </div>
                  
                  <!-- Botones de acci√≥n -->
                  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                    <button type="button" onclick="guardarAntiagregantes()" class="btn" style="font-size:.75rem;background:#dc2626;color:white;border:1px solid #b91c1c;padding:6px 12px;">
                      üíæ Guardar
                    </button>
                    <button type="button" onclick="limpiarFormularioAntiagregantes()" class="btn btn-outlined" style="font-size:.75rem;">
                      Limpiar
                    </button>
                  </div>
                </form>
                
                <!-- Historial de antiagregantes -->
                <div id="historialAntiagregantes" style="margin-top:16px;display:none;">
                  <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                    üìã Historial de Antiagregantes
                  </h5>
                  <div id="listHistorialAntiagregantes" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
  <div data-panel="adulto_mayor" hidden style="padding:8px 10px 12px;">
          <!-- Panel de Screening dentro de Evaluaci√≥n Adulto Mayor -->
          <div style="display:grid;gap:12px;">
            
            <!-- Secci√≥n Vacunas -->
            <section class="card" style="padding:12px;">
              <h3 style="margin:0 0 10px;font-size:.9rem;display:flex;align-items:center;gap:6px;">
                üíâ Vacunas
              </h3>
              
              <!-- Vacuna Influenza -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#f9fafb;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">ü¶† Vacuna Influenza</h4>
                <form id="formVacunaInfluenzaAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaInfluenzaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Estado:</label>
                  <select id="estadoInfluenzaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="SI">S√≠</option>
                    <option value="NO">No</option>
                    <option value="RECHAZA">Rechaza</option>
                  </select>
                  
                  <button type="button" onclick="guardarVacuna('influenza')" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar Influenza
                  </button>
                </form>
              </div>
              
              <!-- Vacuna COVID -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#f9fafb;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">ü¶† Vacuna COVID</h4>
                <form id="formVacunaCovidAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaCovidAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Estado:</label>
                  <select id="estadoCovidAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="SI">S√≠</option>
                    <option value="NO">No</option>
                    <option value="RECHAZA">Rechaza</option>
                  </select>
                  
                  <button type="button" onclick="guardarVacuna('covid')" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar COVID
                  </button>
                </form>
              </div>
              
              <!-- Historial de Vacunas -->
              <div id="historialVacunasAM" style="display:none;margin-top:10px;">
                <h4 style="margin:0 0 6px;font-size:.85rem;color:#1e293b;">üìã Historial de Vacunaci√≥n</h4>
                <div id="listaHistorialVacunasAM" style="max-height:180px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </section>
            
            <!-- Secci√≥n Screening por G√©nero -->
            <section class="card" style="padding:12px;">
              <h3 style="margin:0 0 10px;font-size:.9rem;display:flex;align-items:center;gap:6px;">
                üîç Screening por G√©nero
              </h3>
              
              <!-- PAP (Mujeres 25-64 a√±os) -->
              <div id="seccionPAPAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#fef7f7;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">üë©‚Äç‚öïÔ∏è PAP (Mujeres 25-64 a√±os)</h4>
                <form id="formPAPAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaPAPAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Realizado:</label>
                  <select id="estadoPAPAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="true">S√≠</option>
                    <option value="false">No</option>
                  </select>
                  
                  <label style="font-size:.85rem;font-weight:600;">Resultado:</label>
                  <input type="text" id="resultadoPAPAM" placeholder="Resultado del PAP" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <button type="button" onclick="guardarPAP()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar PAP
                  </button>
                </form>
                
                <!-- Historial PAP -->
                <div id="historialPAPAM" style="display:none;margin-top:10px;">
                  <h5 style="margin:0 0 5px;font-size:.75rem;color:#374151;">Historial PAP</h5>
                  <div id="listaHistorialPAPAM" style="max-height:130px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.75rem;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
              
              <!-- Mamograf√≠a (Mujeres 50-69 a√±os) -->
              <div id="seccionMamografiaAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#fef7f7;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">ü©ª Mamograf√≠a (Mujeres 50-69 a√±os)</h4>
                <form id="formMamografiaAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Realizada:</label>
                  <select id="estadoMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="true">S√≠</option>
                    <option value="false">No</option>
                    <option value="alterada">Alterada</option>
                  </select>
                  
                  <label style="font-size:.85rem;font-weight:600;">BI-RADS:</label>
                  <select id="biradsMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="0">0 - Incompleta</option>
                    <option value="1">1 - Negativa</option>
                    <option value="2">2 - Benigna</option>
                    <option value="3">3 - Probablemente benigna</option>
                    <option value="4">4 - Sospechosa</option>
                    <option value="5">5 - Altamente sugestiva</option>
                    <option value="6">6 - Malignidad conocida</option>
                  </select>
                  
                  <button type="button" onclick="guardarMamografia()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar Mamograf√≠a
                  </button>
                </form>
                
                <!-- Historial Mamograf√≠a -->
                <div id="historialMamografiaAM" style="display:none;margin-top:10px;">
                  <h5 style="margin:0 0 5px;font-size:.75rem;color:#374151;">Historial Mamograf√≠a</h5>
                  <div id="listaHistorialMamografiaAM" style="max-height:130px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.75rem;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
              
              <!-- PSA (Hombres ‚â•50 a√±os) -->
              <div id="seccionPSAAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f0f9ff;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">üë®‚Äç‚öïÔ∏è PSA (Hombres ‚â•50 a√±os)</h4>
                <form id="formPSAAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaPSAAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Valor PSA:</label>
                  <input type="number" id="valorPSAAM" placeholder="ng/mL" step="0.01" min="0" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <button type="button" onclick="guardarPSA()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar PSA
                  </button>
                </form>
                
                <!-- Historial PSA -->
                <div id="historialPSAAM" style="display:none;margin-top:10px;">
                  <h5 style="margin:0 0 5px;font-size:.75rem;color:#374151;">Historial PSA</h5>
                  <div id="listaHistorialPSAAM" style="max-height:130px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.75rem;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>
  <script src="/static/js/riesgo_ecicep.js"></script>
  <script src="/static/js/riesgo_cardiovascular.js"></script>
  <script>
    (function initControlChartsLoader(){
      const chartSources = [
        'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.3/chart.umd.min.js'
      ];
      const annotationSources = [
        'https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js'
      ];
      const zoomSources = [
        'https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js'
      ];
      const hammerSources = [
        'https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js'
      ];

      const loadScript = (src) => new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = () => resolve({ src, script });
        script.onerror = () => reject(new Error(`No se pudo cargar ${src}`));
        document.head.appendChild(script);
      });

      const loadWithFallback = async (sources) => {
        let lastError = null;
        for (const src of sources) {
          try {
            return await loadScript(src);
          } catch (err) {
            lastError = err;
            console.warn('[CONTROL-CHARTS] Fall√≥ carga de', src, err.message);
          }
        }
        throw lastError || new Error('Sin fuentes v√°lidas');
      };

      const markFailure = (err) => {
        window.__chartReadyError = err;
        console.warn('[CONTROL-CHARTS] No fue posible cargar Chart.js', err);
        try {
          const wrap = document.getElementById('control-charts');
          if (wrap) {
            wrap.style.display = 'block';
            wrap.setAttribute('data-has-charts','0');
            const statusEl = wrap.querySelector('[data-role="charts-status"]');
            if (statusEl) {
              statusEl.textContent = '‚ö†Ô∏è No fue posible cargar la librer√≠a de gr√°ficos.';
            }
            wrap.querySelectorAll('[data-role="chart-area"]').forEach((area) => {
              area.style.display = 'none';
            });
          }
        } catch (_) {
          // No-op, solo para asegurar que la UI muestre estado de error.
        }
        throw err;
      };

      window.__chartReady = (async () => {
        const { src: chartSrc } = await loadWithFallback(chartSources);
        console.log('[CONTROL-CHARTS] Chart.js cargado desde', chartSrc);
        let hammerSrc = null;
        try {
          ({ src: hammerSrc } = await loadWithFallback(hammerSources));
          console.log('[CONTROL-CHARTS] HammerJS cargado desde', hammerSrc);
        } catch (err) {
          console.warn('[CONTROL-CHARTS] HammerJS no disponible (gestos t√°ctiles limitados)', err.message);
        }
        const { src: pluginSrc } = await loadWithFallback(annotationSources);
        console.log('[CONTROL-CHARTS] Plugin annotation cargado desde', pluginSrc);
        const { src: zoomSrc } = await loadWithFallback(zoomSources);
        console.log('[CONTROL-CHARTS] Plugin zoom cargado desde', zoomSrc);
        return { chartSrc, pluginSrc, zoomSrc, hammerSrc };
      })().catch(markFailure);
    })();
  </script>
  <script>
  (function(){
    const USE_MUY_ALTO = true;
    const DIAS_VIGENCIA = 365;

    const panel = document.getElementById('panel-riesgo-cv');
    if (!panel) return;

    const preview = document.getElementById('riesgo-cv-preview');
    const estado = document.getElementById('estado-riesgo-cv');
    const nivelSelect = document.getElementById('riesgo_cv_nivel');
    const fechaInput = document.getElementById('riesgo_cv_fecha');
    const btnGuardar = document.getElementById('btn-guardar-riesgo-cv');
    const badge = document.getElementById('riesgo-calculado');
    const puntosEl = document.getElementById('puntos-riesgo');
    const detalleEl = document.getElementById('detalle-calculo');
    const resumenSpan = document.getElementById('resumen-riesgo-cv');
    const resumenFechaSpan = document.getElementById('resumen-riesgo-cv-fecha');

    const FIELDS = {
      edad: ['edad','age','anios','anos','years'],
      sexo: ['sexo','genero','gender'],
      pas:  ['pas','sistolica','pa_sistolica','presion_sistolica'],
      col:  ['col_total','colesterol_total','ct','col'],
      hdl:  ['hdl','hdl_col'],
      ldl:  ['ldl','ldl_col'],
      fum:  ['fumador','tabaquismo','smoker'],
      dm:   ['diabetes','dm','dm2','diabetes_mellitus'],
      vfg:  ['vfg','vfge','filtracion_glomerular','egrf','egfr']
    };

    const DATE_FIELDS = [
      'riesgo_cv_fecha',
      'fecha_riesgo',
      'fecha_lab',
      'fecha_pa',
      'fecha_control',
      'fecha_examen',
      'examen_fecha'
    ];

    const CONTROLES_SELECTOR = '#hist-control-tbody tr.ctl-row';

    let ultimoResultado = null;
    let debounce = null;

    const hoyISO = () => new Date().toISOString().slice(0,10);

    function findField(name){
      return document.querySelector(`[name="${name}"]`) || document.getElementById(name);
    }

    function toNumber(value){
      if (value === null || value === undefined) return null;
      if (typeof value === 'number' && Number.isFinite(value)) return value;
      const parsed = Number(String(value).replace(',', '.'));
      return Number.isFinite(parsed) ? parsed : null;
    }

    function getNum(names){
      for (const name of names){
        const el = findField(name);
        if (!el) continue;
        const val = toNumber(el.value ?? el.textContent);
        if (val !== null) return val;
      }
      return null;
    }

    function getText(names){
      for (const name of names){
        const el = findField(name);
        if (!el) continue;
        const raw = el.value ?? el.textContent;
        if (!raw) continue;
        const txt = String(raw).trim();
        if (txt) return txt;
      }
      return '';
    }

    function getBool(names){
      for (const name of names){
        const el = findField(name);
        if (!el) continue;
        if (el.type === 'checkbox' || el.type === 'radio') {
          return el.checked;
        }
        const raw = (el.value ?? el.textContent ?? '').toString().trim().toLowerCase();
        if (!raw) continue;
        if (['si','s√≠','true','1','yes','y'].includes(raw)) return true;
        if (['no','false','0','n'].includes(raw)) return false;
      }
      return null;
    }

    function parseFecha(str){
      if (!str) return null;
      if (str instanceof Date) return Number.isNaN(str.getTime()) ? null : str;
      const value = String(str).trim();
      if (!value) return null;
      if (/^\d{4}[\/-]\d{2}[\/-]\d{2}$/.test(value)){
        const [y,m,d] = value.replace(/\//g,'-').split('-').map(Number);
        const dt = new Date(Date.UTC(y, m-1, d));
        return Number.isNaN(dt.getTime()) ? null : dt;
      }
      if (/^\d{2}[\/-]\d{2}[\/-]\d{4}$/.test(value)){
        const [d,m,y] = value.replace(/\//g,'-').split('-').map(Number);
        const dt = new Date(Date.UTC(y, m-1, d));
        return Number.isNaN(dt.getTime()) ? null : dt;
      }
      const dt = new Date(value);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function diasEntre(fecha){
      if (!(fecha instanceof Date) || Number.isNaN(fecha.getTime())) return Infinity;
      const hoy = new Date();
      const diff = (hoy - fecha) / (1000 * 60 * 60 * 24);
      return Math.floor(diff);
    }

    function maxFecha(actual, candidata){
      if (!actual) return candidata || null;
      if (!candidata) return actual;
      return candidata > actual ? candidata : actual;
    }

    function recolectarFechas(elements){
      let latest = null;
      elements.forEach(el => {
        if (!el) return;
        const raw = el.value ?? el.textContent ?? el.getAttribute('data-fecha');
        const parsed = parseFecha(raw);
        latest = maxFecha(latest, parsed);
      });
      return latest;
    }

    function fechasDesdeDataset(){
      let latest = null;
      document.querySelectorAll('[data-fecha]').forEach(el => {
        const parsed = parseFecha(el.getAttribute('data-fecha'));
        latest = maxFecha(latest, parsed);
      });
      return latest;
    }

    function ultimaFechaEvidencia(){
      const direct = DATE_FIELDS.map(findField);
      let latest = recolectarFechas(direct);

      const numericos = [
        ...FIELDS.pas,
        ...FIELDS.col,
        ...FIELDS.hdl,
        ...FIELDS.ldl,
        ...FIELDS.vfg
      ];
      numericos.forEach(name => {
        const el = findField(name);
        if (!el || !el.dataset) return;
        const parsed = parseFecha(el.dataset.fecha);
        latest = maxFecha(latest, parsed);
      });

      latest = maxFecha(latest, fechasDesdeDataset());

      const labs = Array.isArray(window._histLabsRaw) ? window._histLabsRaw : [];
      labs.forEach(l => { latest = maxFecha(latest, parseFecha(l?.fecha)); });
      if (window.__labsRecientes?.fecha) {
        latest = maxFecha(latest, parseFecha(window.__labsRecientes.fecha));
      }

      return latest;
    }

    function fechaControlReciente(){
      let latest = null;
      if (window.__ultimoControl?.fecha) {
        latest = maxFecha(latest, parseFecha(window.__ultimoControl.fecha));
      }
      if (Array.isArray(window._histControlRaw)) {
        window._histControlRaw.forEach(c => {
          latest = maxFecha(latest, parseFecha(c?.fecha));
        });
      }
      document.querySelectorAll(CONTROLES_SELECTOR).forEach(tr => {
        latest = maxFecha(latest, parseFecha(tr.getAttribute('data-fecha')));
      });
      return latest;
    }

    function fromControl(field){
      if (window.__ultimoControl && window.__ultimoControl[field] !== undefined) {
        const val = toNumber(window.__ultimoControl[field]);
        if (val !== null) return val;
      }
      if (Array.isArray(window._histControlRaw)) {
        for (const item of window._histControlRaw){
          const val = toNumber(item?.[field]);
          if (val !== null) return val;
        }
      }
      return null;
    }

    function fromLab(field){
      if (window.__labsRecientes && window.__labsRecientes[field] !== undefined) {
        const raw = window.__labsRecientes[field];
        const value = typeof raw === 'object' ? (raw.valor ?? raw.value ?? raw) : raw;
        const num = toNumber(value);
        if (num !== null) return num;
      }
      if (Array.isArray(window._histLabsRaw)) {
        for (const item of window._histLabsRaw){
          const num = toNumber(item?.[field]);
          if (num !== null) return num;
        }
      }
      return null;
    }

    function detectFromPatologias(fn){
      const lista = window.__usuarioPatologiasResumen || window._patologiasUsuarioBD;
      if (!Array.isArray(lista)) return false;
      return lista.some(fn);
    }

    function detectSmoker(){
      const explicit = getBool(FIELDS.fum);
      if (explicit !== null) return explicit;
      return detectFromPatologias(p => {
        const nombre = (p?.nombre || '').toLowerCase();
        const cie = (p?.cie10 || p?.codigo || '').toUpperCase();
        return /tabac|fumad|nicotin/.test(nombre) || /^F17|^Z72|^T65/.test(cie);
      });
    }

    function detectDiabetes(){
      const explicit = getBool(FIELDS.dm);
      if (explicit !== null) return explicit;
      return detectFromPatologias(p => {
        const nombre = (p?.nombre || '').toLowerCase();
        const cie = (p?.cie10 || p?.codigo || '').toUpperCase();
        return /diabet/.test(nombre) || /^E1[0-4]/.test(cie);
      });
    }

    function detectECV(){
      if (detectFromPatologias(p => {
        const nombre = (p?.nombre || '').toString().toLowerCase();
        const cie = (p?.cie10 || p?.codigo || '').toString().toUpperCase();
        if (/infarto|cardiopat|angina|stent|bypass|revascular|cardiovascular/.test(nombre)) return true;
        if (/ictus|acv|ave|stroke|aneurisma|claudic/.test(nombre)) return true;
        return /^I2[0-5]|^I5[12]|^I63|^I64|^I65|^I66|^I70|^I71|^I72|^I73|^I74|^G45/.test(cie);
      })) return true;

      const antecedentes = getText(['ecv','iam','acv','antecedentes_ecv','antecedentes_iam','antecedentes_acv']).toUpperCase();
      if (antecedentes) {
        return /IAM|INFART|ACV|ECV|ICTUS|STENT|BYPASS|ANGINA|REINFART/.test(antecedentes);
      }
      return false;
    }

    function vfgeMenor60(vfg){
      if (vfg !== null && vfg !== undefined) return vfg < 60;
      const chip = document.getElementById('erc-g');
      if (chip) {
        const txt = (chip.textContent || '').toUpperCase();
        if (txt.startsWith('G4') || txt.startsWith('G5') || txt.startsWith('G3B')) return true;
      }
      return detectFromPatologias(p => {
        const cie = (p?.cie10 || '').toUpperCase();
        return /^N18[3-5]/.test(cie);
      });
    }

    function puntosEdad(edad, sexo){
      if (edad == null) return 0;
      const h = (sexo || '').toUpperCase().startsWith('M');
      if (edad < 50) return 0 + (h ? 1 : 0);
      if (edad < 55) return 2 + (h ? 1 : 0);
      if (edad < 60) return 4 + (h ? 1 : 0);
      if (edad < 65) return 6 + (h ? 1 : 0);
      if (edad < 70) return 8 + (h ? 1 : 0);
      if (edad < 75) return 10 + (h ? 1 : 0);
      return 12 + (h ? 1 : 0);
    }

    function puntosPAS(pas){
      if (pas == null) return 0;
      if (pas < 120) return 0;
      if (pas < 140) return 2;
      if (pas < 160) return 4;
      if (pas < 180) return 6;
      return 8;
    }

    function puntosCT(ct){
      if (ct == null) return 0;
      if (ct < 180) return 0;
      if (ct < 200) return 1;
      if (ct < 240) return 2;
      if (ct < 280) return 3;
      return 4;
    }

    function puntosHDL(hdl){
      if (hdl == null) return 0;
      if (hdl >= 60) return -1;
      if (hdl < 40) return 1;
      return 0;
    }

    function puntosTabaco(edad, sexo, fum){
      if (!fum) return 0;
      const h = (sexo || '').toUpperCase().startsWith('M');
      return (edad >= 55 ? 4 : 3) + (h ? 1 : 0);
    }

    function puntosDM(dm){
      return dm ? 4 : 0;
    }

    function puntosTotal(vars){
      let p = 0;
      p += puntosEdad(vars.edad, vars.sexo);
      p += puntosPAS(vars.pas);
      p += puntosCT(vars.col);
      p += puntosHDL(vars.hdl);
      p += puntosTabaco(vars.edad, vars.sexo, vars.fum);
      p += puntosDM(vars.dm);
      return p;
    }

    function porcentajeAprox(p){
      if (p <= 4) return 3;
      if (p <= 8) return 7;
      if (p <= 12) return 14;
      if (p <= 16) return 22;
      return 28;
    }

    function categoriaPorcentaje(psc){
      if (psc < 10) return { cat: 'Bajo', bg: '#dcfce7', fg: '#065f46' };
      if (psc < 20) return { cat: 'Moderado', bg: '#fef3c7', fg: '#b45309' };
      return { cat: 'Alto', bg: '#fee2e2', fg: '#991b1b' };
    }

    function mapCategoria(cat){
      if (!cat) return '';
      const lower = cat.toLowerCase();
      if (lower.includes('muy alto')) return 'maximo';
      if (lower.includes('max')) return 'maximo';
      if (lower.includes('alto')) return 'alto';
      if (lower.includes('moderado')) return 'moderado';
      if (lower.includes('bajo')) return 'bajo';
      return '';
    }

    function formatFecha(fecha){
      if (!(fecha instanceof Date) || Number.isNaN(fecha.getTime())) return '‚Äî';
      const d = String(fecha.getDate()).padStart(2,'0');
      const m = String(fecha.getMonth()+1).padStart(2,'0');
      return `${d}/${m}/${fecha.getFullYear()}`;
    }

    function recolectarDatos(){
      const edad = getNum(FIELDS.edad) ?? toNumber(window.__usuarioEdad);
      const sexoTxt = (getText(FIELDS.sexo) || window.__usuarioSexo || '').toString().toUpperCase();
      const sexo = sexoTxt.startsWith('F') ? 'F' : sexoTxt.startsWith('M') ? 'M' : '';
      const pas = getNum(FIELDS.pas) ?? fromControl('presion_sistolica');
      const col = getNum(FIELDS.col) ?? fromLab('col_total') ?? fromLab('col') ?? fromLab('colesterol_total');
      const hdl = getNum(FIELDS.hdl) ?? fromLab('hdl');
      const ldl = getNum(FIELDS.ldl) ?? fromLab('ldl');
      const fum = detectSmoker();
      const dm = detectDiabetes();
      const vfg = getNum(FIELDS.vfg) ?? fromLab('vfg') ?? fromLab('vfge') ?? fromLab('egfr');
      const ecvPrevia = detectECV();
      return { edad, sexo, pas, col, hdl, ldl, fum, dm, vfg, ecvPrevia };
    }

    function calcular(vars, contexto){
      if (!vars) return { valido: false, motivo: 'Sin datos.' };

      if (USE_MUY_ALTO) {
        if (vars.ecvPrevia) {
          return { valido: true, categoria: 'Muy alto', porcentaje: 25, causa: 'ECV previa registrada.', puntos: null };
        }
        if (vars.pas != null && vars.pas >= 180) {
          return { valido: true, categoria: 'Muy alto', porcentaje: 22, causa: 'PAS ‚â• 180 mmHg.', puntos: null };
        }
        if (vars.ldl != null && vars.ldl >= 190) {
          return { valido: true, categoria: 'Muy alto', porcentaje: 21, causa: 'LDL ‚â• 190 mg/dL.', puntos: null };
        }
        if (vfgeMenor60(vars.vfg)) {
          return { valido: true, categoria: 'Muy alto', porcentaje: 20, causa: 'ERC con VFGe < 60.', puntos: null };
        }
      }

      if (!vars.sexo || !Number.isFinite(vars.edad) || !Number.isFinite(vars.pas) || !Number.isFinite(vars.col)) {
        return { valido: false, motivo: 'Faltan sexo, edad, presi√≥n sist√≥lica o colesterol total.' };
      }

      const puntos = puntosTotal(vars);
      const porcentaje = porcentajeAprox(puntos);
      const base = categoriaPorcentaje(porcentaje);

      let categoria = base.cat;
      let motivo = base.detalle || '';
      if (vars.dm && categoria !== 'Alto') {
        categoria = 'Alto';
        motivo = 'Diabetes eleva la categor√≠a a Alto.';
      }

      return {
        valido: true,
        categoria,
        porcentaje,
        puntos,
        causa: motivo || null,
        vigenteDias: contexto?.vigenteDias || null,
        vigenteFecha: contexto?.vigenteFecha || null
      };
    }

    function renderPasivo(ctx){
      const mensaje = 'No hay valores vigentes (‚â•365 d√≠as).';
      if (badge){
        badge.textContent = 'Pasivo';
        badge.style.background = '#e5e7eb';
        badge.style.color = '#111827';
      }
      if (preview){
        preview.innerHTML = `
          <div style="font-size:.65rem;line-height:1.5;">
            ${mensaje}
            <div style="font-size:.6rem;opacity:.7;margin-top:6px;">
              √öltima evidencia: ${formatFecha(ctx.ultimaEvidencia)} ¬∑ Control: ${formatFecha(ctx.ultimaControl)}
            </div>
          </div>
        `;
      }
      if (estado) estado.textContent = mensaje;
      if (puntosEl) puntosEl.textContent = 'Sin vigencia (‚â•365 d√≠as)';
      if (detalleEl) {
        detalleEl.innerHTML = `
          <div>√öltima evidencia: ${formatFecha(ctx.ultimaEvidencia)}</div>
          <div>√öltimo control: ${formatFecha(ctx.ultimaControl)}</div>
        `;
      }
      if (btnGuardar) btnGuardar.disabled = true;
      if (nivelSelect){
        if (nivelSelect.dataset) nivelSelect.dataset.auto = '0';
        nivelSelect.value = '';
      }
      if (fechaInput) fechaInput.value = '';
      if (resumenSpan) resumenSpan.textContent = 'PASIVO';
      if (resumenFechaSpan) resumenFechaSpan.textContent = '‚Äî';
      try { window.actualizarBadgeRiesgo?.('PASIVO'); } catch(e){ console.warn(e); }
    }

    function renderResultado(resultado, ctx){
      if (!resultado || resultado.valido === false){
        const motivo = resultado?.motivo || 'Completa los datos cl√≠nicos para estimar el riesgo.';
        if (preview){
          preview.innerHTML = `<div style="font-size:.65rem;">${motivo}</div>`;
        }
        if (estado) estado.textContent = motivo;
        if (btnGuardar) btnGuardar.disabled = true;
        if (puntosEl) puntosEl.textContent = motivo;
        return;
      }

      const pal = resultado.categoria === 'Bajo'
        ? { bg:'#dcfce7', fg:'#065f46' }
        : resultado.categoria === 'Moderado'
          ? { bg:'#fef3c7', fg:'#b45309' }
          : { bg:'#fee2e2', fg:'#991b1b' };

      if (badge){
        badge.textContent = resultado.categoria;
        badge.style.background = pal.bg;
        badge.style.color = pal.fg;
      }

      const pctTxt = resultado.porcentaje != null ? `‚âà ${resultado.porcentaje}% a 10 a√±os` : '';
      const ptsTxt = resultado.puntos != null ? `Puntos: ${resultado.puntos}` : '';
      const vigenteTxt = ctx?.vigenteFecha ? `Control vigente: ${formatFecha(ctx.vigenteFecha)} (hace ${ctx.vigenteDias} d√≠as)` : '';

      if (preview){
        preview.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="display:inline-block;padding:4px 12px;border-radius:999px;font-weight:600;background:${pal.bg};color:${pal.fg};">${resultado.categoria}</span>
            <span style="font-size:.65rem;color:#0f172a;">${pctTxt}</span>
          </div>
          ${resultado.causa ? `<div style="font-size:.6rem;opacity:.75;margin-top:4px;">${resultado.causa}</div>` : ''}
          ${vigenteTxt ? `<div style="font-size:.6rem;opacity:.75;margin-top:4px;">${vigenteTxt}</div>` : ''}
        `;
      }

      if (estado) estado.textContent = `Calculado: ${resultado.categoria} ${pctTxt}`;
      if (puntosEl) puntosEl.textContent = [pctTxt, ptsTxt].filter(Boolean).join(' ‚Ä¢ ') || resultado.categoria;

      if (detalleEl){
        detalleEl.innerHTML = `
          <div style="font-weight:600;margin-bottom:4px;">${resultado.categoria}</div>
          ${resultado.causa ? `<div style="font-size:.6rem;margin-bottom:6px;">${resultado.causa}</div>` : ''}
          <div style="font-size:.6rem;opacity:.75;">√öltima evidencia: ${formatFecha(ctx?.ultimaEvidencia)}</div>
          <div style="font-size:.6rem;opacity:.75;">√öltimo control: ${formatFecha(ctx?.ultimaControl)}</div>
        `;
      }

      if (btnGuardar) btnGuardar.disabled = false;

      if (nivelSelect && nivelSelect.dataset?.auto !== '0'){
        const mapped = mapCategoria(resultado.categoria);
        if (mapped){
          nivelSelect.value = mapped;
          nivelSelect.dataset.auto = '1';
        }
      }

      if (fechaInput && !fechaInput.value){
        fechaInput.value = hoyISO();
      }

      if (resumenSpan) resumenSpan.textContent = resultado.categoria;
      if (resumenFechaSpan) resumenFechaSpan.textContent = formatFecha(new Date());

      try { window.actualizarBadgeRiesgo?.(resultado.categoria); } catch(err){ console.warn('[RiesgoCV] badge', err); }
    }

    function construirContexto(){
      const ultimaEvidencia = ultimaFechaEvidencia();
      const diasEvidencia = diasEntre(ultimaEvidencia);
      const vigentePorEvidencia = diasEvidencia <= DIAS_VIGENCIA;

      const ultimaControl = fechaControlReciente();
      const diasControl = diasEntre(ultimaControl);
      const vigentePorControl = diasControl <= DIAS_VIGENCIA;

      const vigente = vigentePorEvidencia || vigentePorControl;

      return {
        vigente,
        vigentePorEvidencia,
        vigentePorControl,
        ultimaEvidencia,
        ultimaControl,
        vigenteDias: vigentePorEvidencia ? diasEvidencia : diasControl,
        vigenteFecha: vigentePorEvidencia ? ultimaEvidencia : ultimaControl
      };
    }

    function evaluar(reason){
      const ctx = construirContexto();
      if (!ctx.vigente){
        ultimoResultado = null;
        renderPasivo(ctx);
        window.dispatchEvent(new CustomEvent('riesgo-cv:calculado', { detail: { resultado: null, motivo: 'pasivo', ctx, reason } }));
        return;
      }
      const datos = recolectarDatos();
      const resultado = calcular(datos, ctx);
      ultimoResultado = resultado && resultado.valido ? resultado : null;
      renderResultado(resultado, ctx);
      window.dispatchEvent(new CustomEvent('riesgo-cv:calculado', { detail: { resultado, datos, ctx, reason } }));
    }

    function programarEvaluacion(reason){
      clearTimeout(debounce);
      debounce = setTimeout(() => evaluar(reason), 200);
    }

    function bind(){
      const names = new Set([
        ...FIELDS.edad,
        ...FIELDS.sexo,
        ...FIELDS.pas,
        ...FIELDS.col,
        ...FIELDS.hdl,
        ...FIELDS.ldl,
        ...FIELDS.fum,
        ...FIELDS.dm,
        ...FIELDS.vfg
      ]);
      names.forEach(name => {
        const el = findField(name);
        if (!el) return;
        el.addEventListener('input', () => programarEvaluacion(`input:${name}`));
        el.addEventListener('change', () => programarEvaluacion(`change:${name}`));
      });
      if (nivelSelect){
        nivelSelect.addEventListener('change', () => {
          if (nivelSelect.dataset) nivelSelect.dataset.auto = '0';
        });
      }
      window.addEventListener('usuario:cargado', () => programarEvaluacion('usuario:cargado'));
      window.addEventListener('riesgo-cv:refrescar-control', () => programarEvaluacion('control'));
      window.addEventListener('riesgo-cv:refrescar-labs', () => programarEvaluacion('labs'));
      window.addEventListener('riesgo-cv:actualizado', () => programarEvaluacion('backend'));
      window.addEventListener('riesgo-cv:backend', () => programarEvaluacion('backend-sync'));
    }

    const api = {
      recalcular: () => evaluar('manual'),
      calcularDesdeTarjeton: () => evaluar('manual'),
      recolectarDatos,
      tieneControlVigente: () => {
        const fecha = fechaControlReciente();
        const dias = diasEntre(fecha);
        return { vigente: dias <= DIAS_VIGENCIA, fecha, dias };
      },
      obtenerUltimoResultado: () => ultimoResultado,
      sincronizarBackend: () => programarEvaluacion('backend-sync'),
      init: () => programarEvaluacion('init')
    };
    window.RiesgoCV = api;

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', () => { bind(); evaluar('dom'); });
    } else {
      bind();
      evaluar('dom');
    }
  })();
  </script>
<script id="riesgo-cv-script">
(function(){
  const fechaInput = document.getElementById('riesgo_cv_fecha');
  const nivelSelect = document.getElementById('riesgo_cv_nivel');
  const btnGuardar = document.getElementById('btn-guardar-riesgo-cv');
  const estado = document.getElementById('estado-riesgo-cv');
  const spanUltimo = document.getElementById('ultimo-riesgo-cv');
  const spanUltimoFecha = document.getElementById('ultimo-riesgo-cv-fecha');
  const resumenCategoria = document.querySelector('#resumen-ident .categoria-riesgo');
  const resumenRiesgo = document.getElementById('resumen-riesgo-cv');
  const resumenRiesgoFecha = document.getElementById('resumen-riesgo-cv-fecha');

  function hoyISO(){
    const d=new Date();
    return d.toISOString().slice(0,10);
  }
  if (fechaInput && !fechaInput.value) fechaInput.value = hoyISO();

  const formatRiesgoLabel = (valor) => {
    if (!valor) return '‚Äî';
    const lower = valor.toString().toLowerCase();
    if (lower === 'maximo' || lower.includes('muy')) return 'Muy alto';
    if (lower === 'alto') return 'Alto';
    if (lower === 'moderado') return 'Moderado';
    if (lower === 'bajo') return 'Bajo';
    return valor.toString();
  };

  async function cargarRiesgoCV(run){
    if(!run){ return; }
    try{
      if(estado){ estado.textContent='Cargando‚Ä¶'; }
      const resp = await fetch(`/api/riesgo-cv/ultimo/${encodeURIComponent(run)}`);
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok || data.ok === false){
        throw new Error(data.error || `HTTP ${resp.status}`);
      }
      const info = data.riesgo_cv || null;
      if(info){
        if(spanUltimo){ spanUltimo.textContent = formatRiesgoLabel(info.riesgo); }
        if(spanUltimoFecha){ spanUltimoFecha.textContent = info.fecha || '‚Äî'; }
        if(nivelSelect && !nivelSelect.value){ nivelSelect.value = info.riesgo || ''; }
        if(fechaInput && info.fecha){ fechaInput.value = info.fecha; }
        if(resumenRiesgo){ resumenRiesgo.textContent = formatRiesgoLabel(info.riesgo); }
        if(resumenRiesgoFecha){ resumenRiesgoFecha.textContent = info.fecha || '‚Äî'; }
      } else {
        if(spanUltimo){ spanUltimo.textContent='‚Äî'; }
        if(spanUltimoFecha){ spanUltimoFecha.textContent='‚Äî'; }
        if(resumenRiesgo){ resumenRiesgo.textContent='‚Äî'; }
        if(resumenRiesgoFecha){ resumenRiesgoFecha.textContent='‚Äî'; }
      }
      try {
        window.RiesgoCV?.sincronizarBackend?.();
        window.dispatchEvent(new CustomEvent('riesgo-cv:backend', { detail: info || null }));
      } catch(err) {
        console.warn('[RiesgoCV] backend sync error', err);
      }
      if(estado){ estado.textContent=''; }
    }catch(e){
      console.error('Error cargando riesgo CV', e);
      if(estado){ estado.textContent='Error cargando'; }
    }
  }

  async function guardarRiesgo(){
    const run = (document.getElementById('run')?.value || '').trim();
    const fecha = fechaInput?.value || '';
    const riesgo = nivelSelect?.value || '';
    if(!run || !fecha || !riesgo){
      if(estado){ estado.textContent='Completar campos'; }
      return;
    }
    if(estado){ estado.textContent='Guardando‚Ä¶'; }
    try{
      const resp = await fetch('/api/riesgo-cv', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ run, fecha, riesgo })
      });
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok || data.ok === false){
        throw new Error(data.error || `HTTP ${resp.status}`);
      }
    const info = data.riesgo_cv || { riesgo, fecha };
      if(estado){ estado.textContent='Guardado'; }
    if(spanUltimo){ spanUltimo.textContent = formatRiesgoLabel(info.riesgo || riesgo); }
      if(spanUltimoFecha){ spanUltimoFecha.textContent = info.fecha || fecha || '‚Äî'; }
      if(nivelSelect && info.riesgo){ nivelSelect.value = info.riesgo; }
      if(fechaInput && info.fecha){ fechaInput.value = info.fecha; }
  if(resumenRiesgo){ resumenRiesgo.textContent = formatRiesgoLabel(info.riesgo || riesgo); }
  if(resumenRiesgoFecha){ resumenRiesgoFecha.textContent = info.fecha || fecha || '‚Äî'; }
      if(resumenCategoria && resumenCategoria.textContent && resumenCategoria.textContent.trim() !== '‚Äî'){
        resumenCategoria.setAttribute('data-riesgo-cv', info.riesgo || riesgo);
      }
      try {
        window.RiesgoCV?.sincronizarBackend?.();
        window.dispatchEvent(new CustomEvent('riesgo-cv:backend', { detail: info || { riesgo, fecha } }));
      } catch(err) {
        console.warn('[RiesgoCV] backend update sync error', err);
      }
      window.dispatchEvent(new CustomEvent('riesgo-cv:actualizado', {
        detail: { run, riesgo: info.riesgo || riesgo, fecha: info.fecha || fecha }
      }));
      setTimeout(()=>{ if(estado){ estado.textContent=''; } }, 2000);
    }catch(e){
      console.error('Error guardando riesgo CV', e);
      if(estado){ estado.textContent='Error'; }
    }
  }

  btnGuardar?.addEventListener('click', guardarRiesgo);

  // Hook en flujo existente de autocompletarIdentificacion
  const originalAuto = window.autocompletarIdentificacion;
  window.autocompletarIdentificacion = function(u, selSector){
    try { originalAuto && originalAuto(u, selSector); } catch(_e){}
    const run = u?.run || u?.usuario_run || document.getElementById('run')?.value;
    if(run){ cargarRiesgoCV(run); }
  };

  window.addEventListener('usuario:cargado', (evt)=>{
    const run = (evt?.detail?.run || '').trim();
    if(run){ cargarRiesgoCV(run); }
  });

  window.addEventListener('riesgo-cv:calculado', (evt)=>{
    const resultado = evt?.detail?.resultado || {};
    if(!resultado) return;
    if(nivelSelect && resultado.categoria){
      nivelSelect.value = resultado.categoria;
    }
    if(fechaInput && !fechaInput.value){
      fechaInput.value = hoyISO();
    }
    if(resumenRiesgo && resultado.categoria){
      resumenRiesgo.textContent = (resultado.categoria || '‚Äî').toUpperCase();
    }
    if(resumenRiesgoFecha){
      resumenRiesgoFecha.textContent = hoyISO();
    }
    if(estado && estado.textContent !== 'Guardando‚Ä¶'){
      estado.textContent = 'Calculado (pendiente de guardar)';
    }
  });

  const runInicial = (document.getElementById('run')?.value || '').trim();
  if(runInicial){ cargarRiesgoCV(runInicial); }

  // Exponer funci√≥n manual
  window.cargarRiesgoCV = cargarRiesgoCV;
})();
</script>
<script>
// === IA UNIFICADA TARJET√ìN ===
(function(){
  const btnFull = document.getElementById('btn-ai-autocomplete');
  const btnSimple = document.getElementById('btn-ai-fill');
  const areaFull = document.getElementById('ai-texto-clinico');
  const areaSimple = document.getElementById('ai-texto');
  const statusFull = document.getElementById('ai-autocomplete-status');
  const statusSimple = document.getElementById('ai-fill-status');
  const modifiedFields = new Set();
  const modifiedTabs = new Set();

  // Toast ligero
  function showToast(msg){
    let t = document.getElementById('ai-toast');
    if(!t){
      t = document.createElement('div');
      t.id='ai-toast';
      t.style.cssText='position:fixed;bottom:18px;right:18px;background:#065f46;color:#fff;padding:10px 14px;border-radius:8px;font-size:.75rem;z-index:9999;box-shadow:0 4px 10px rgba(0,0,0,.15);opacity:0;transition:opacity .25s;';
      document.body.appendChild(t);
    }
    t.textContent=msg; t.style.opacity='1';
    setTimeout(()=>{ t.style.opacity='0'; }, 2500);
  }

  function setStatus(el,msg,kind='info'){
    if(!el) return;
    if(!msg){
      el.textContent='';
      el.style.display='none';
      return;
    }
    el.style.display='block';
    const colors={info:'#334155',ok:'#065f46',error:'#b91c1c'};
    el.style.color=colors[kind]||colors.info; el.textContent=msg;
  }

  function escapeHtmlSummary(str){
    return String(str ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function formatSummaryBlock(text){
    if(!text) return '';
    const lines = String(text).split(/\n+/).map(l=>l.trim()).filter(Boolean);
    if(!lines.length) return '';
    const bulletRegex = /^(\d+[\.\)]|[-‚Ä¢*])\s*/;
    const bulletCount = lines.filter(l=>bulletRegex.test(l)).length;
    if(bulletCount >= lines.length/2){
      return '<ul>' + lines.map(line=>{
        const clean = line.replace(bulletRegex,'').trim();
        return `<li>${escapeHtmlSummary(clean)}</li>`;
      }).join('') + '</ul>';
    }
    return lines.map(line=>`<p>${escapeHtmlSummary(line)}</p>`).join('');
  }

  function deriveListFromBlock(text){
    if(!text) return [];
    return String(text)
      .split(/\n+/)
      .map(line=>line.replace(/\s*\|\s*/g,' ').trim())
      .map(line=>line.replace(/^(\d+[\.\)]|[-‚Ä¢*])\s*/, '').trim())
      .filter(Boolean);
  }

  function formatEdadDetallada(det){
    if(!det || typeof det!=='object') return '';
    const parts=[];
    if(Number.isFinite(det.years)) parts.push(`${det.years} a√±os`);
    if(Number.isFinite(det.months)) parts.push(`${det.months} meses`);
    if(Number.isFinite(det.days)) parts.push(`${det.days} d√≠as`);
    return parts.join(' ¬∑ ');
  }

  function buildEmpamText(empam){
    if(!empam) return '';
    if(typeof empam==='string') return empam;
    const parts=[];
    if(empam.puntaje!=null) parts.push(`Puntaje: ${empam.puntaje}`);
    if(empam.clasificacion) parts.push(`Clasificaci√≥n: ${empam.clasificacion}`);
    if(empam.subareas) parts.push(`Sub√°reas: ${empam.subareas}`);
    if(empam.resumen) parts.push(empam.resumen);
    if(!parts.length && empam.texto) parts.push(empam.texto);
    if(!parts.length) return JSON.stringify(empam);
    return parts.join(' ¬∑ ');
  }

  function renderMandrakeSummary(data=null, opts={}){
    const card = document.getElementById('mandrake-summary-card');
    if(!card) return;
    const empty = card.querySelector('[data-role="empty"]');
    const content = card.querySelector('[data-role="content"]');
    const statusBadge = document.getElementById('mandrake-summary-status');
    const ageRow = document.getElementById('mandrake-summary-edad');

    if(!data || typeof data!=='object'){
      card.classList.remove('active','mandrake-summary-highlight');
      if(empty) empty.style.display='block';
      if(content) content.style.display='none';
      if(statusBadge) statusBadge.style.display='none';
      return;
    }

    card.classList.add('active');
    card.classList.add('mandrake-summary-highlight');
    setTimeout(()=>card.classList.remove('mandrake-summary-highlight'), 900);

    if(empty) empty.style.display='none';
    if(content) content.style.display='flex';

    if(statusBadge){
      statusBadge.style.display='inline-flex';
      const src = opts.source ? String(opts.source).toUpperCase() : 'MANUAL';
      const now = new Date();
      const hora = now.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
      statusBadge.textContent = `Fuente ${src} ‚Ä¢ ${hora}`;
    }

    const meta = data.mandrake_meta || {};
    const metaSelectors = {
      fecha_atencion: '[data-ms="fecha_atencion"]',
      hora_atencion: '[data-ms="hora_atencion"]',
      funcionario: '[data-ms="funcionario"]',
      profesion: '[data-ms="profesion"]',
      establecimiento: '[data-ms="establecimiento"]',
      procedencia: '[data-ms="procedencia"]',
      tipo_consulta: '[data-ms="tipo_consulta"]'
    };
    Object.entries(metaSelectors).forEach(([key, selector])=>{
      const el = card.querySelector(selector);
      if(!el) return;
      el.textContent = meta[key] || '‚Äî';
    });

    const edadSpan = card.querySelector('[data-ms="edad_detallada"]');
    if(edadSpan){
      const edadTxt = formatEdadDetallada(meta.edad_detallada);
      if(edadTxt){
        edadSpan.textContent = edadTxt;
        if(ageRow) ageRow.style.display='block';
      } else {
        edadSpan.textContent = '‚Äî';
        if(ageRow) ageRow.style.display='none';
      }
    }

    const sections = data.mandrake_sections || {};
    const sectionMap = {
      motivo_consulta: '[data-section="motivo_consulta"]',
      enfermedad_actual: '[data-section="enfermedad_actual"]',
      atencion_familiar: '[data-section="atencion_familiar"]',
      estudios_relevantes: '[data-section="estudios_relevantes"]',
      condiciones_riesgos: '[data-section="condiciones_riesgos"]',
      indicaciones: '[data-section="indicaciones"]',
      funcionalidad: '[data-section="funcionalidad"]',
      formularios_realizados: '[data-section="formularios_realizados"]'
    };
    Object.entries(sectionMap).forEach(([key, selector])=>{
      const el = card.querySelector(selector);
      if(!el) return;
      const wrapper = el.closest('.mandrake-summary-section') || el;
      const texto = sections[key];
      if(texto){
        el.innerHTML = formatSummaryBlock(texto);
        wrapper.style.display='';
      } else {
        el.innerHTML = '‚Äî';
        wrapper.style.display='none';
      }
    });

    const empamSection = document.getElementById('mandrake-summary-empam');
    if(empamSection){
      const empamText = sections.empam || buildEmpamText(data.empam);
      if(empamText){
        empamSection.style.display='';
        const target = empamSection.querySelector('[data-section="empam"]');
        if(target) target.innerHTML = formatSummaryBlock(empamText);
      } else {
        empamSection.style.display='none';
      }
    }

    const diagDetalle = Array.isArray(data.diagnosticos_detallados) && data.diagnosticos_detallados.length
      ? data.diagnosticos_detallados
      : (Array.isArray(data.diagnosticos) ? data.diagnosticos.map(dx=>({ descripcion: dx })) : []);
    const dxList = card.querySelector('#mandrake-summary-dx-list');
    if(dxList){
      if(diagDetalle.length){
        dxList.innerHTML = diagDetalle.map(item=>{
          const codigo = item.codigo ? `<strong>${escapeHtmlSummary(item.codigo)}</strong> ` : '';
          const descripcion = escapeHtmlSummary(item.descripcion || item.texto || '');
          const estado = item.estado ? ` <span style="color:#0f766e;font-weight:600;">(${escapeHtmlSummary(item.estado)})</span>` : '';
          return `<li>${codigo}${descripcion}${estado}</li>`;
        }).join('');
      } else {
        dxList.innerHTML = '<li style="opacity:.6;">Sin datos</li>';
      }
    }

    const actividadesList = Array.isArray(data.actividades_programadas) && data.actividades_programadas.length
      ? data.actividades_programadas
      : deriveListFromBlock(sections.actividades_programadas);
    const actListEl = card.querySelector('#mandrake-summary-actividades-list');
    if(actListEl){
      if(actividadesList.length){
        actListEl.innerHTML = actividadesList.map(item=>`<li>${escapeHtmlSummary(item)}</li>`).join('');
      } else {
        actListEl.innerHTML = '<li style="opacity:.6;">Sin actividades detectadas</li>';
      }
    }

    const formulariosTarget = card.querySelector('[data-section="formularios_realizados"]');
    if(formulariosTarget){
      const textoForm = sections.formularios_realizados || (Array.isArray(data.formularios_realizados) ? data.formularios_realizados.join('\n') : data.formularios_realizados);
      if(textoForm){
        formulariosTarget.innerHTML = formatSummaryBlock(textoForm);
        formulariosTarget.closest('.mandrake-summary-section').style.display='';
      } else {
        formulariosTarget.innerHTML = '‚Äî';
        formulariosTarget.closest('.mandrake-summary-section').style.display='none';
      }
    }

    window.__mandrakeSummaryLast = { data, source: opts.source || 'unknown', updatedAt: Date.now() };
  }

  window.renderMandrakeSummary = renderMandrakeSummary;

  function highlightField(el, changedTabs){
    if(!el) return;
    el.classList.add('mandrake-modified');
    modifiedFields.add(el);
    const node = el.closest('[data-tab-panel]');
    if(node){
      const key = node.getAttribute('data-tab-panel');
      if(key){
        changedTabs.add(key);
        modifiedTabs.add(key);
      }
    }
  }

  function markTabs(changedTabs){
    if(!changedTabs.size) return;
    changedTabs.forEach(key=>{ if(key) modifiedTabs.add(key); });
    document.querySelectorAll('.t-tab').forEach(tabBtn=>{
      const key = tabBtn.getAttribute('data-tab');
      if(changedTabs.has(key) && !tabBtn.querySelector('.mandrake-indicator')){
        const dot=document.createElement('span');
        dot.className='mandrake-indicator';
        tabBtn.style.position='relative';
        tabBtn.appendChild(dot);
        tabBtn.classList.add('mandrake-tab-modified');
      }
    });
  }

  function clearMandrakeMarks(){
    modifiedFields.forEach(el=>{
      try { el.classList.remove('mandrake-modified'); }
      catch(_e){}
    });
    modifiedFields.clear();
    if(modifiedTabs.size){
      document.querySelectorAll('.t-tab').forEach(tabBtn=>{
        const key = tabBtn.getAttribute('data-tab');
        if(!modifiedTabs.has(key)) return;
        tabBtn.classList.remove('mandrake-tab-modified');
        const dot = tabBtn.querySelector('.mandrake-indicator');
        if(dot){ dot.remove(); }
      });
      modifiedTabs.clear();
    }
  }

  window.clearMandrakeMarks = clearMandrakeMarks;

  const CONTROL_FIELD_NAMES = ['peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'];
  const LAB_FIELD_NAMES = ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'];

  function parseNumericField(root, name){
    const el = root?.querySelector(`[name="${name}"]`);
    if(!el) return undefined;
    const raw = (el.value || '').trim();
    if(!raw) return undefined;
    const parsed = parseFloat(raw.replace(',','.'));
    return Number.isFinite(parsed) ? parsed : undefined;
  }

  function buildControlPayload(runValue){
    if(!runValue) return null;
    const root = document.getElementById('form-control-nuevo');
    if(!root) return null;
    const payload = { run: runValue };
    const fecha = (root.querySelector('[name="fecha"]')?.value || '').trim();
    if(fecha) payload.fecha = fecha;
    let hasChanges = false;
    const profesional = (root.querySelector('[name="profesional"]')?.value || '').trim();
    if(profesional){
      payload.profesional = profesional;
      hasChanges = true;
    }
    CONTROL_FIELD_NAMES.forEach(name=>{
      const val = parseNumericField(root, name);
      if(val !== undefined){
        payload[name] = val;
        hasChanges = true;
      }
    });
    return hasChanges ? payload : null;
  }

  function buildLabPayload(runValue){
    if(!runValue) return null;
    const root = document.getElementById('form-lab-nuevo');
    if(!root) return null;
    const payload = { run: runValue };
    const fecha = (root.querySelector('[name="examen_fecha"]')?.value || '').trim();
    if(fecha) payload.examen_fecha = fecha;
    let hasMetric = false;
    LAB_FIELD_NAMES.forEach(name=>{
      const val = parseNumericField(root, name);
      if(val !== undefined){
        payload[name] = val;
        hasMetric = true;
      }
    });
    return hasMetric ? payload : null;
  }

  async function fastSaveControlAndLabs(runValue){
    const tasks = [];
    const controlPayload = buildControlPayload(runValue);
    if(controlPayload){
      tasks.push({
        label:'control',
        promise: fetch('/api/control/fast-save',{
          method:'POST',
          credentials:'same-origin',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(controlPayload)
        })
      });
    }
    const labPayload = buildLabPayload(runValue);
    if(labPayload){
      tasks.push({
        label:'labs',
        promise: fetch('/api/labs/fast-save',{
          method:'POST',
          credentials:'same-origin',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(labPayload)
        })
      });
    }
    if(!tasks.length){
      return { dispatched:false, successCount:0, failureCount:0 };
    }
    const settled = await Promise.allSettled(tasks.map(t=>t.promise));
    let successCount = 0;
    let failureCount = 0;
    for(let idx = 0; idx < settled.length; idx += 1){
      const result = settled[idx];
      const { label } = tasks[idx];
      if(result.status === 'fulfilled'){
        const res = result.value;
        if(res.ok){
          successCount += 1;
        } else {
          failureCount += 1;
          let detail = null;
          try {
            detail = await res.clone().json();
          } catch(_jsonErr){
            try {
              detail = await res.clone().text();
            } catch(_textErr){
              detail = res.statusText;
            }
          }
          console.warn(`[LABS] Guardado r√°pido ${label} respondi√≥ ${res.status}`, detail);
        }
      } else {
        failureCount += 1;
        console.error(`[LABS] Guardado r√°pido ${label} fall√≥`, result.reason);
      }
    }
    return { dispatched:true, successCount, failureCount };
  }

  // Exponer global para evitar ReferenceError en cargas tempranas
  window.computeIMC = function computeIMC(){
    const peso = parseFloat(document.querySelector('#form-control-nuevo [name="peso"]')?.value||'');
    const talla = parseFloat(document.querySelector('#form-control-nuevo [name="talla"]')?.value||'');
    if(peso>0 && talla>0){
      const imc = peso / Math.pow(talla/100,2);
      const span = document.querySelector('[data-f="imc"]');
      if(span){ span.textContent = imc.toFixed(1); }
      const clas = (imc<18.5)?'Bajo peso':(imc<25)?'Normal':(imc<30)?'Sobrepeso':(imc<35)?'Obesidad I':(imc<40)?'Obesidad II':'Obesidad III';
      const badge=document.getElementById('imc-clasif');
      if(badge){ badge.textContent=clas; badge.style.display='inline-block'; badge.style.background = imc>=30? '#b91c1c' : (imc>=25? '#f59e0b':'#0d9488'); badge.style.color='#fff'; }
    }
  }

  function fillFirstLab(firstLab, changedTabs){
    if(!firstLab) return;
    const root=document.getElementById('form-lab-nuevo');
    if(!root) return;
    const set=(name,val)=>{ if(val!==undefined && val!==null && val!==''){ const el=root.querySelector(`[name="${name}"]`); if(el){ const prev=el.value; el.value=val; if(prev!==String(val)) highlightField(el, changedTabs);} } };
    set('examen_fecha', firstLab.examen_fecha);
    ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'].forEach(k=>set(k, firstLab[k]));
    try {
      if (typeof window !== 'undefined') {
        window.__labsRecientes = window.__labsRecientes || {};
        ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac'].forEach((k) => {
          if (firstLab[k] !== undefined && firstLab[k] !== null && firstLab[k] !== '') {
            window.__labsRecientes[k] = { valor: firstLab[k], fecha: firstLab.examen_fecha || null };
          }
        });
        window.dispatchEvent(new CustomEvent('riesgo-cv:refrescar-labs', { detail: window.__labsRecientes }));
      }
    } catch (err) {
      console.warn('[LABS] No se pudo actualizar cache para riesgo CV', err);
    }
  }

  function applyCanonical(d){
    const changedTabs = new Set();
    const YES_SET = new Set(['si', 's√≠', 's', 'true', 't', '1', 'y', 'yes', 'vigente', 'positivo', 'presenta', 'realizado', 'activo', 'activa']);
    const NO_SET = new Set(['no', 'false', 'f', '0', 'n', 'negativo', 'ausente', 'sin', 'rechaza', 'rechazo', 'no tiene', 'no presenta', 'pendiente']);
    const isBlank = (val) => val === undefined || val === null || (typeof val === 'string' && val.trim() === '');
    const normalizeISODate = (val) => {
      if (val instanceof Date) {
        return val.toISOString().slice(0, 10);
      }
      const str = String(val ?? '').trim();
      if (!str) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      const dash = str.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (dash) return `${dash[3]}-${dash[2]}-${dash[1]}`;
      const slash = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (slash) return `${slash[3]}-${slash[2]}-${slash[1]}`;
      return str;
    };
    const normalizeYesNo = (raw, { yes = 'si', no = 'no' } = {}) => {
      if (raw === undefined || raw === null) return '';
      if (typeof raw === 'boolean') return raw ? yes : no;
      if (typeof raw === 'number') return raw > 0 ? yes : no;
      const txt = String(raw).trim().toLowerCase();
      if (!txt) return '';
      if (YES_SET.has(txt)) return yes;
      if (NO_SET.has(txt)) return no;
      return txt;
    };
    const toBoolString = (value) => {
      const norm = normalizeYesNo(value);
      if (norm === 'si') return 'true';
      if (norm === 'no') return 'false';
      return '';
    };
    const highlightWrapper = (el) => { if (el) highlightField(el, changedTabs); };
    const setFieldValue = (selector, rawValue, opts = {}) => {
      if (isBlank(rawValue)) return;
      const el = document.querySelector(selector);
      if (!el) return;
      let value = rawValue;
      if (value instanceof Date) {
        value = normalizeISODate(value);
      }
      if (opts.transform) {
        try {
          value = opts.transform(value);
        } catch (transformError) {
          console.warn('transform error', transformError);
        }
      }
      if (isBlank(value) || typeof value === 'object') return;
      const newVal = typeof value === 'number' ? String(value) : String(value);
      if (el.value === newVal) return;
      el.value = newVal;
      highlightWrapper(el);
      if (opts.triggerChange) {
        try {
          el.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (_e) {}
      }
    };
    const setRadioGroup = (selector, value) => {
      if (isBlank(value) && typeof value !== 'boolean') return;
      const radios = document.querySelectorAll(selector);
      if (!radios.length) return;
      const norm = normalizeYesNo(value);
      const rawLower = String(value ?? '').trim().toLowerCase();
      const target = Array.from(radios).find((radio) => {
        const radioVal = radio.value.trim().toLowerCase();
        if (norm) {
          if (norm === radioVal) return true;
          if (norm === 'si' && YES_SET.has(radioVal)) return true;
          if (norm === 'no' && NO_SET.has(radioVal)) return true;
        }
        return rawLower && radioVal === rawLower;
      });
      if (target) {
        if (!target.checked) {
          target.checked = true;
          highlightWrapper(target.closest('label') || target);
        }
        try {
          target.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (_e) {}
      }
    };
    const showSection = (id) => {
      const section = document.getElementById(id);
      if (section && section.style.display === 'none') {
        section.style.display = '';
      }
    };
    try {
      window.renderMandrakeSummary && window.renderMandrakeSummary(d || {}, { source: 'AI' });
    } catch(e){ console.warn('renderMandrakeSummary error', e); }
    // Identificaci√≥n b√°sica
    const mapBasic = { run:'run', nombre:'nombre', fecha_nacimiento:'fecha_nacimiento', sexo:'sexo' };
    Object.entries(mapBasic).forEach(([k,id])=>{ const el=document.getElementById(id); if(el && d[k]){ const prev=el.value; el.value=d[k]; if(prev!==d[k]) highlightField(el, changedTabs);} });
    // Control (con conversi√≥n de talla si viene en metros <3)
    const controlMap={ peso:'peso', talla:'talla', presion_sistolica:'presion_sistolica', presion_diastolica:'presion_diastolica', cc:'cc', hgt:'hgt', hba1c:'hba1c' };
    Object.entries(controlMap).forEach(([k,n])=>{
      if(d[k]!=null){
        const el=document.querySelector(`#form-control-nuevo [name="${n}"]`);
        if(el){
          let val=d[k];
          if(n==='talla' && val!=='' && val!=null){
            const num=parseFloat(String(val).replace(',','.'));
            if(!isNaN(num) && num>0 && num<3){ val=(num*100).toFixed(2); }
          }
          const prev=el.value; el.value=val; if(prev!==String(val)) highlightField(el, changedTabs);
        }
      }
    });
    // Fecha control: usar fecha_atencion si viene y campo vac√≠o
    if(d.fecha_atencion){ const fCtl=document.querySelector('#form-control-nuevo [name="fecha"]'); if(fCtl && !fCtl.value){ try { const iso=d.fecha_atencion.length===10? d.fecha_atencion : d.fecha_atencion.split('T')[0]; if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(iso)){ const prev=fCtl.value; fCtl.value=iso; if(prev!==iso) highlightField(fCtl, changedTabs);} } catch(_){} } }
    // Tamizajes
    const dateMap={ fondo_ojo_fecha:'fechaFondoOjos', pie_dm_fecha:'fechaPieDM', podologia_fecha:'fechaPodologia', ekg_fecha:'fechaEkg', mamografia_fecha:'fechaMamografiaAM', psa_fecha:'fechaPSAAM' };
    Object.entries(dateMap).forEach(([k,id])=>{ if(d[k]){ const el=document.getElementById(id); if(el){ const prev=el.value; el.value=d[k]; if(prev!==d[k]) highlightField(el, changedTabs);} } });
    if(d.psa_valor!=null){ const el=document.getElementById('valorPSAAM'); if(el){ const prev=el.value; el.value=d.psa_valor; if(prev!==String(d.psa_valor)) highlightField(el, changedTabs);} }
    if(d.mamografia_birads){ const el=document.getElementById('biradsMamografiaAM'); if(el){ const prev=el.value; el.value=d.mamografia_birads; if(prev!==d.mamografia_birads) highlightField(el, changedTabs);} }
    if(typeof d.mamografia_realizada==='boolean'){ const el=document.getElementById('estadoMamografiaAM'); if(el){ const prev=el.value; el.value=d.mamografia_realizada?'true':'false'; if(prev!==el.value) highlightField(el, changedTabs);} }
    // Patolog√≠as (mostrar lista PERO NO preseleccionar autom√°ticamente en panel riesgo)
    if(Array.isArray(d.patologias)){
      const ul=document.getElementById('lista-patologias');
      if(ul){ ul.innerHTML=''; if(!d.patologias.length){ ul.innerHTML='<li style="opacity:.6;">Sin datos</li>'; } else { d.patologias.forEach(p=>{ const li=document.createElement('li'); li.textContent=p; ul.appendChild(li);}); } highlightField(ul, changedTabs);} 
      // NO marcar autom√°ticamente las patolog√≠as en el checklist
      // Las patolog√≠as solo deben marcarse manualmente o al activar expl√≠citamente el c√°lculo
      // Comentado: La pre-selecci√≥n autom√°tica causa confusi√≥n cuando el usuario est√° en modo CARDIO
      /*
      try {
        if(window._riesgoCatalogo && Array.isArray(window._riesgoCatalogo)){
          const norm=s=>String(s||'').toLowerCase();
          const encontrados=new Set();
          d.patologias.forEach(txt=>{
            const t=norm(txt);
            const hit=window._riesgoCatalogo.find(p=> norm(p.nombre)===t || norm(p.nombre).includes(t) || t.includes(norm(p.nombre)) || (p.cie10 && t.includes(p.cie10.toLowerCase())));
            if(hit){ encontrados.add(hit.id); }
          });
          if(encontrados.size){
            if(window._riesgoSeleccion instanceof Set){ encontrados.forEach(id=>window._riesgoSeleccion.add(id)); }
            if(typeof window._riesgoRender==='function'){ window._riesgoRender(); }
            const estado=document.getElementById('estado-patologias'); if(estado){ estado.textContent='Patolog√≠as detectadas v√≠a IA preseleccionadas ('+encontrados.size+')'; estado.style.color='#0369a1'; }
          }
        }
      } catch(_e){}
      */
    }
    // Labs first
    if(Array.isArray(d.labs) && d.labs.length){ fillFirstLab(d.labs[0], changedTabs); }
    // F√°rmacos
    const farm = d.farmacos || {};
    if(farm.ieca_ara){
      showSection('seccionIecaAra');
      if(farm.ieca_ara.tipo){
        setFieldValue('#tipoIecaAra', farm.ieca_ara.tipo, {
          transform: (val) => {
            const txt = String(val || '').trim().toUpperCase();
            if (!txt) return '';
            if (txt.includes('ARA')) return 'ARA II';
            if (txt.includes('IECA')) return 'IECA';
            if (['NO', 'NINGUNO', 'NINGUNA', 'SIN'].includes(txt)) return 'NO';
            return txt;
          },
          triggerChange: true,
        });
      }
      if(farm.ieca_ara.fecha){
        setFieldValue('#fechaIecaAra', farm.ieca_ara.fecha, { transform: normalizeISODate });
      }
    }
    if(farm.estatinas){
      showSection('seccionEstatinas');
      if(farm.estatinas.recibe !== undefined){
        setRadioGroup('input[name="recibeEstatinas"]', farm.estatinas.recibe);
      }
      if(farm.estatinas.fecha){
        setFieldValue('#fechaEstatinas', farm.estatinas.fecha, { transform: normalizeISODate });
      }
    }
    if(farm.antiagregantes){
      showSection('seccionAntiagregantes');
      if(farm.antiagregantes.recibe !== undefined){
        setRadioGroup('input[name="recibeAntiagregantes"]', farm.antiagregantes.recibe);
      }
      if(farm.antiagregantes.fecha){
        setFieldValue('#fechaAntiagregantes', farm.antiagregantes.fecha, { transform: normalizeISODate });
      }
    }
    // Evaluaci√≥n diabetes
    const evalDb = d.evaluacion_diabetes || {};
    const pie = evalDb.pie_diabetico || {};
    if(Object.keys(pie).length){
      setRadioGroup('input[name="ulceraPieOAmputacion"]', pie.ulcera_o_amputacion);
      setRadioGroup('input[name="sensibilidadProtectora"]', pie.sensibilidad_alterada);
      setRadioGroup('input[name="EAP"]', pie.enfermedad_arterial_periferica);
      setRadioGroup('input[name="DEF"]', pie.deformidad);
      setFieldValue('#fechaEvaluacionPieDiabetico', pie.fecha, { transform: normalizeISODate });
      if(pie.resultado || pie.riesgo){
        const cont = document.getElementById('resultadoPieDiabetico');
        if(cont){
          cont.style.display='';
          const inner = cont.querySelector('.resultado-contenido');
          if(inner){ inner.textContent = pie.resultado || (pie.riesgo ? `Riesgo: ${pie.riesgo}` : ''); }
        }
      }
    }
    const hip = evalDb.hipoglicemias || {};
    if(Object.keys(hip).length){
      setRadioGroup('input[name="hipoglicemiasRecurrentes"]', hip.presenta);
      setFieldValue('#fechaHipoglicemias', hip.fecha, { transform: normalizeISODate });
    }
    const amp = evalDb.amputacion || {};
    if(Object.keys(amp).length){
      setRadioGroup('input[name="tieneAmputacion"]', amp.tiene);
      setFieldValue('#fechaAmputacion', amp.fecha, { transform: normalizeISODate });
    }
    const pod = evalDb.podologia || {};
    if(Object.keys(pod).length){
      setRadioGroup('input[name="atencionPodologa"]', pod.vigente);
      setFieldValue('#fechaPodologia', pod.fecha, { transform: normalizeISODate });
    }
    const fondo = evalDb.fondo_ojo || {};
    if(Object.keys(fondo).length){
      setRadioGroup('input[name="fondoOjos"]', fondo.realizado);
      setFieldValue('#fechaFondoOjos', fondo.fecha, { transform: normalizeISODate });
    }
    const cur = evalDb.curaciones || {};
    if(Object.keys(cur).length){
      setRadioGroup('input[name="enCuracion"]', cur.en_curaciones);
      if(cur.tipo){
        const cont = document.getElementById('tipoCuracionContainer');
        if(cont) cont.style.display='';
        setFieldValue('#tipoCuracion', cur.tipo, { triggerChange: true });
      }
      setFieldValue('#fechaCuracion', cur.fecha, { transform: normalizeISODate });
    }
    const ekg = evalDb.ekg || {};
    if(Object.keys(ekg).length){
      setRadioGroup('input[name="ekgRealizado"]', ekg.realizado);
      setFieldValue('#fechaEkg', ekg.fecha, { transform: normalizeISODate });
    }
    // Vacunas y screening adulto mayor
    const mapVacunaEstado = (estado) => {
      const txt = String(estado || '').trim().toLowerCase();
      if (!txt) return '';
      if (YES_SET.has(txt) || ['completa', 'ald√≠a', 'al d√≠a', 'vigente'].includes(txt)) return 'SI';
      if (['rechaza', 'rechazo', 'declina'].includes(txt)) return 'RECHAZA';
      if (NO_SET.has(txt) || ['pendiente'].includes(txt)) return 'NO';
      return String(estado).toUpperCase();
    };
    const vacunas = d.vacunas || {};
    const applyVacuna = (entry, estadoSelector, fechaSelector) => {
      if(!entry) return;
      if(entry.estado !== undefined){
        setFieldValue(estadoSelector, entry.estado, { transform: mapVacunaEstado, triggerChange: true });
      }
      if(entry.fecha){
        setFieldValue(fechaSelector, entry.fecha, { transform: normalizeISODate });
      }
    };
    applyVacuna(vacunas.influenza, '#estadoInfluenzaAM', '#fechaInfluenzaAM');
    applyVacuna(vacunas.covid, '#estadoCovidAM', '#fechaCovidAM');

    const screening = d.screening || {};
    if(screening.pap){
      setFieldValue('#fechaPAPAM', screening.pap.fecha, { transform: normalizeISODate });
      if(screening.pap.realizado !== undefined){
        const boolVal = toBoolString(screening.pap.realizado);
        if(boolVal){ setFieldValue('#estadoPAPAM', boolVal, { triggerChange: true }); }
      }
      if(screening.pap.resultado){ setFieldValue('#resultadoPAPAM', screening.pap.resultado); }
    }
    if(screening.mamografia){
      setFieldValue('#fechaMamografiaAM', screening.mamografia.fecha, { transform: normalizeISODate });
      if(screening.mamografia.realizada !== undefined){
        const boolVal = toBoolString(screening.mamografia.realizada);
        if(boolVal){ setFieldValue('#estadoMamografiaAM', boolVal, { triggerChange: true }); }
      }
      if(screening.mamografia.birads){
        setFieldValue('#biradsMamografiaAM', screening.mamografia.birads.toString());
      }
    }
    if(screening.psa){
      setFieldValue('#fechaPSAAM', screening.psa.fecha, { transform: normalizeISODate });
      if(screening.psa.valor !== undefined && screening.psa.valor !== null){
        setFieldValue('#valorPSAAM', screening.psa.valor);
      }
    }

    const funcionalidadMap = (raw) => {
      const txt = String(raw || '').trim().toLowerCase();
      if (!txt) return '';
      if (txt.includes('autovalente con riesgo')) return 'autovalente_con_riesgo';
      if (txt.includes('riesgo de dependencia')) return 'riesgo_dependencia';
      if (txt.includes('dependencia total')) return 'dependencia_total';
      if (txt.includes('dependencia moderada')) return 'dependencia_moderada';
      if (txt.includes('dependencia leve')) return 'dependencia_leve';
      if (txt.includes('autovalente')) return 'autovalente';
      return txt.replace(/\s+/g, '_');
    };
    const adulto = d.adulto_mayor || {};
    if(adulto.fecha){ setFieldValue('#fechaEvaluacionAM', adulto.fecha, { transform: normalizeISODate }); }
    if(adulto.funcionalidad){
      const funcVal = funcionalidadMap(adulto.funcionalidad);
      if(funcVal){ setFieldValue('#funcionalidadAM', funcVal, { triggerChange: true }); }
    }
    if(adulto.tug_segundos !== undefined && adulto.tug_segundos !== null){
      setFieldValue('#tugSegundos', adulto.tug_segundos, { triggerChange: true });
    }
    if(adulto.tug_clasificacion){ setFieldValue('#tugClasificacion', adulto.tug_clasificacion); }
    if(adulto.unipodal_derecho !== undefined && adulto.unipodal_derecho !== null){
      setFieldValue('#unipodalPieDerecho', adulto.unipodal_derecho, { triggerChange: true });
    }
    if(adulto.unipodal_izquierdo !== undefined && adulto.unipodal_izquierdo !== null){
      setFieldValue('#unipodalPieIzquierdo', adulto.unipodal_izquierdo, { triggerChange: true });
    }
    if(adulto.unipodal_clasificacion){ setFieldValue('#unipodalClasificacion', adulto.unipodal_clasificacion); }
    if(adulto.observaciones){ setFieldValue('#observacionesAM', adulto.observaciones); }

    const actDetalle = d.actividad_fisica_detalle || {};
    if(Object.keys(actDetalle).length){
      setRadioGroup('input[name="actividadFisica"]', actDetalle.realiza);
      setFieldValue('#fechaActividadFisica', actDetalle.fecha, { transform: normalizeISODate });
    }
    const masDetalle = d.masama_detalle || {};
    if(Object.keys(masDetalle).length){
      setRadioGroup('input[name="masAma"]', masDetalle.positivo);
      setFieldValue('#fechaMasAma', masDetalle.fecha, { transform: normalizeISODate });
    }
    // IMC
    window.computeIMC && window.computeIMC();
    // Tabs
    markTabs(changedTabs);
    // Minimizar bot
    try { const overlay=document.getElementById('mandrake-chat-overlay'); if(overlay && overlay.style.display!=='none'){ overlay.style.display='none'; } } catch(_e){}
  }

  async function runAI(source){
    const isFull = source==='full';
    const btn = isFull? btnFull : btnSimple;
    const area = isFull? areaFull : areaSimple;
    const statusEl = isFull? statusFull : statusSimple;
    if(!btn) return;
    if(!area){
      if(isFull){
        if(areaSimple){
          areaSimple.scrollIntoView({behavior:'smooth', block:'center'});
          try { areaSimple.focus({preventScroll:true}); } catch(_e) { areaSimple.focus(); }
        }
        if(statusSimple){ setStatus(statusSimple,'El modo completo fue retirado. Usa el cuadro de texto inferior para la IA.'); }
      }
      return;
    }
    const raw = (area.value||'').trim();
    if(!raw){ alert('Pega el texto cl√≠nico primero.'); return; }
    const prev=btn.textContent; btn.disabled=true; btn.textContent='Procesando‚Ä¶'; setStatus(statusEl,'Llamando IA‚Ä¶');
    try {
      const resp = await fetch('/api/ai/tarjeton-fill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({texto:raw})});
      const j = await resp.json();
      if(!j.ok){ setStatus(statusEl,'Error: '+(j.error||resp.status),'error'); btn.textContent=prev; btn.disabled=false; return; }
      setStatus(statusEl,'Aplicando datos ('+j.mode+')','ok');
      (function ensureLabsArray(d){
        if(!d) return;
        if(Array.isArray(d.labs)) return; // ya viene bien
        const keys=['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'];
        const has = keys.some(k=> d[k]!=null && d[k]!=='' );
        if(has){
          const labObj={};
          keys.forEach(k=>{ if(d[k]!=null && d[k]!=='' ) labObj[k]=d[k]; });
          labObj.examen_fecha = d.examen_fecha || d.fecha_atencion || d.fecha_examen;
          d.labs=[labObj];
        }
      })(j.data||{});
      applyCanonical(j.data||{});
      // Autosave r√°pido (no bloqueante)
      try {
        const runVal = document.getElementById('run')?.value?.trim();
        if(runVal){
          fastSaveControlAndLabs(runVal)
            .then(summary=>{
              if(summary?.dispatched && summary.successCount){
                showToast('Guardado r√°pido ('+summary.successCount+')');
              }
            })
            .catch(err=>{ console.error('[LABS] Guardado r√°pido completo fall√≥', err); });
        }
      } catch(autoSaveError) {
        console.error('[LABS] Error preparando guardado r√°pido', autoSaveError);
      }
      btn.textContent='‚úÖ IA aplicado';
      showToast('Autocompletado aplicado');
      setTimeout(()=>{ btn.textContent=prev; btn.disabled=false; },2000);
    } catch(e){ console.error(e); setStatus(statusEl,'Excepci√≥n: '+e,'error'); btn.textContent=prev; btn.disabled=false; }
  }

  window.addEventListener('tarjeton:save-result', (evt)=>{
    const detail = evt?.detail || {};
    const ok = Number(detail.ok || 0);
    const fail = Number(detail.fail || 0);
    if(statusSimple){
      if(ok && !fail){
        setStatus(statusSimple,'Guardado exitoso. Listo para un nuevo autocompletado.','ok');
      } else if(ok){
        setStatus(statusSimple,`Guardado parcial: ${ok} ok, ${fail} error${fail===1?'':'es'}. Revisa antes de continuar.`,'error');
      } else if(fail){
        setStatus(statusSimple,'No se pudo guardar. Revisa los campos y reintenta.','error');
      } else {
        setStatus(statusSimple,'Sin cambios para guardar.','info');
      }
    }
    if(ok && !fail){
      if(areaSimple){ areaSimple.value=''; }
      if(areaFull && !areaFull.value && statusFull){ setStatus(statusFull,'', 'info'); }
      clearMandrakeMarks();
      showToast('Guardado exitoso');
      setTimeout(()=>{ setStatus(statusSimple,'','info'); }, 2600);
    }
  });

  if(btnFull){
    if(areaFull){
      btnFull.addEventListener('click', ()=>runAI('full'));
    } else {
      btnFull.textContent = '‚ö° IA (modo simple)';
      btnFull.title = 'El modo completo fue retirado. Usa el cuadro de texto inferior.';
      btnFull.classList.add('btn-outlined');
      btnFull.style.background = '#475569';
      btnFull.style.color = '#f8fafc';
      btnFull.addEventListener('click', ()=>{
        if(areaSimple){
          areaSimple.scrollIntoView({behavior:'smooth', block:'center'});
          try { areaSimple.focus({preventScroll:true}); } catch(_e) { areaSimple.focus(); }
        }
        if(statusSimple){ setStatus(statusSimple,'Pega el texto cl√≠nico en el modo simple para continuar.'); }
      });
    }
  }
  if(btnSimple){ btnSimple.addEventListener('click', ()=>runAI('simple')); }
})();
</script>





<script>
(function(){
  // === Helpers puros ===
  const buildDefaultOptions = (options = {}) => ({
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      ...(options.headers || {}),
    },
  });

  const logByStatus = (response, url) => {
    // Mismo orden y mensajes que el original
    if (response.status === 403) {
      console.log(`[API] Sin autorizaci√≥n: ${url} (posible problema de autenticaci√≥n)`);
    } else if (response.status >= 500) {
      console.log(`[API] Error del servidor: ${url} (${response.status})`);
    } else if (response.status === 404) {
      console.log(`[API] Endpoint no encontrado: ${url}`);
    }
  };

  // Helper para fetch con autenticaci√≥n y manejo de errores mejorado
  const authFetch = async (url, options = {}) => {
    const defaultOptions = buildDefaultOptions(options);
    const timeoutMs = options.timeout === undefined ? 45000 : options.timeout; // 45s por defecto para Mandrake
    const maxRetries = typeof options.retries === 'number' ? options.retries : 1;

    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      const controller = new AbortController();
      const shouldTimeout = Number.isFinite(timeoutMs) && timeoutMs > 0;
      const timeoutId = shouldTimeout ? setTimeout(() => controller.abort(), timeoutMs) : null;
  const { timeout: _timeout, retries: _retries, ...restOptions } = options;
      const fetchOptions = {
        ...defaultOptions,
        ...restOptions,
        signal: controller.signal
      };

      try {
        console.log(`[API] Intento ${attempt + 1}/${maxRetries + 1} - ${url}`);
        const response = await fetch(url, fetchOptions);
        if (timeoutId) clearTimeout(timeoutId);

        logByStatus(response, url);
        return response;
      } catch (error) {
        if (timeoutId) clearTimeout(timeoutId);
        const isTimeout = error.name === 'AbortError' && shouldTimeout;
        if (attempt === maxRetries) {
          if (isTimeout) {
            console.log(`[API] Timeout (${timeoutMs}ms): ${url}`);
            const timeoutError = new Error(`Timeout despu√©s de ${timeoutMs}ms`);
            timeoutError.name = 'TimeoutError';
            throw timeoutError;
          }
          console.log(`[API] Error final de conexi√≥n: ${url}`, error.message);
          throw error;
        }
        console.log(`[API] Error en intento ${attempt + 1}, reintentando: ${url}`, error.message);
        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
      }
    }
  };

  // Funci√≥n para verificar si la sesi√≥n est√° activa
  // Flask-Login ya maneja la sesi√≥n, no necesitamos verificarla manualmente
  const verificarSesion = async () => {
    // Si estamos en esta p√°gina, la sesi√≥n ya est√° activa (protegida por @login_required)
    return true;
  };

  // (Bloque de protecci√≥n de visibilidad eliminado seg√∫n nueva especificaci√≥n)

  const PROGRAMA_MODO_ECICEP = 'ECICEP';
  window.PROGRAMA_MODO_ECICEP = PROGRAMA_MODO_ECICEP;
  let _guardandoProgramaModo = false;
  let _ultimoProgramaModoGuardado = null;

  async function forzarProgramaModoECICEP(run) {
    const runLimpio = (run || '').toString().trim();
    if (!runLimpio) {
      return;
    }
    if (_guardandoProgramaModo) {
      return;
    }
    if (_ultimoProgramaModoGuardado === runLimpio) {
      return;
    }
    _guardandoProgramaModo = true;
    try {
      const resp = await authFetch(
        `/api/usuarios/${encodeURIComponent(runLimpio)}/programa_modo`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ programa: PROGRAMA_MODO_ECICEP })
        }
      );
      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        console.warn('[PROGRAMA] No se pudo fijar programa ECICEP', data);
        return;
      }
      _ultimoProgramaModoGuardado = runLimpio;
      console.log(`[PROGRAMA] Programa modo fijado a ${PROGRAMA_MODO_ECICEP} para ${runLimpio}`);
    } catch (error) {
      console.warn('[PROGRAMA] Error forzando programa ECICEP', error);
    } finally {
      _guardandoProgramaModo = false;
    }
  }

  // Inicializaci√≥n fija para c√°lculo de riesgo ECICEP
  window.programaSeleccionado = PROGRAMA_MODO_ECICEP;
  window.programasActivos = new Set(['INGRESO_ECICEP']);
  console.log('[PROGRAMA] Modo ECICEP activo para c√°lculo de riesgo');

  window._runActivo = window._runActivo || '';

  function obtenerRunActivo() {
    const runCampo = document.getElementById('run');
    const runBusqueda = document.getElementById('run-search');
    const candidato = (runCampo?.value || '').trim() || (runBusqueda?.value || '').trim() || (window._runActivo || '').trim();
    if (candidato) {
      window._runActivo = candidato;
    }
    return candidato;
  }

  function formatearRunParaEnvio(raw) {
    if (!raw) return null;
    const limpio = raw.toString().replace(/[^0-9kK]/g, '').toUpperCase();
    if (limpio.length < 8 || limpio.length > 9) {
      return null;
    }
    const cuerpo = limpio.slice(0, -1);
    const dv = limpio.slice(-1);
    if (!/^[0-9]+$/.test(cuerpo)) {
      return null;
    }
    let suma = 0;
    let multiplicador = 2;
    for (let i = cuerpo.length - 1; i >= 0; i--) {
      suma += parseInt(cuerpo[i], 10) * multiplicador;
      multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
    }
    const resto = suma % 11;
    const dvCalculadoNum = 11 - resto;
    const dvEsperado = dvCalculadoNum === 11 ? '0' : dvCalculadoNum === 10 ? 'K' : String(dvCalculadoNum);
    if (dvEsperado !== dv) {
      return null;
    }
    let formateado;
    if (cuerpo.length === 7) {
      formateado = `${cuerpo[0]}.${cuerpo.slice(1,4)}.${cuerpo.slice(4)}-${dv}`;
    } else if (cuerpo.length === 8) {
      formateado = `${cuerpo.slice(0,2)}.${cuerpo.slice(2,5)}.${cuerpo.slice(5)}-${dv}`;
    } else if (cuerpo.length === 6) {
      formateado = `${cuerpo.slice(0,3)}.${cuerpo.slice(3)}-${dv}`;
    } else {
      formateado = `${cuerpo}-${dv}`;
    }
    return formateado;
  }

  window.obtenerRunActivo = obtenerRunActivo;
  window.formatearRunParaEnvio = formatearRunParaEnvio;

  function actualizarModoPrograma() {
    window.programaSeleccionado = PROGRAMA_MODO_ECICEP;
    console.log(`üîß [PROGRAMA] Modo de riesgo activo: ${PROGRAMA_MODO_ECICEP}`);

    const btnCalc = document.getElementById('btn-calcular-riesgo');
    const btnAplicar = document.getElementById('btn-aplicar-riesgo');
    const detalle = document.getElementById('detalle-calculo');

    if (btnCalc) {
      btnCalc.disabled = false;
      btnCalc.textContent = 'üßÆ Calcular Riesgo';
    }

    if (btnAplicar) {
      btnAplicar.disabled = false;
      btnAplicar.textContent = '‚úÖ Aplicar al Usuario';
    }

    if (detalle && !detalle.innerHTML.trim()) {
      detalle.innerHTML = 'Seleccione patolog√≠as para calcular el riesgo';
    }

    const run = obtenerRunActivo();
    if (run) {
      void forzarProgramaModoECICEP(run);
    }
  }

  function renderProgramButtons() {
    actualizarModoPrograma();
  }

  function sincronizarProgramasActivos(_codigos, _usuarioFallback) {
    if (!(window.programasActivos instanceof Set)) {
      window.programasActivos = new Set();
    }

    window.programasActivos.clear();
    window.programasActivos.add('INGRESO_ECICEP');

    renderProgramButtons();
  }

  function sincronizarPatologiasTrasCambio(run, recalcularRiesgo = true) {
    setTimeout(async () => {
      console.log('üîß [PROGRAMA] Verificando cat√°logo de patolog√≠as...');

      let intentos = 0;
      const maxIntentos = 15;

      while ((!window._riesgoCatalogo || window._riesgoCatalogo.length === 0) && intentos < maxIntentos) {
        console.log(`‚è≥ [PROGRAMA] Esperando cat√°logo... (${intentos + 1}/${maxIntentos})`);
        await new Promise(resolve => setTimeout(resolve, 300));
        intentos++;
      }

      if (!window._riesgoCatalogo || window._riesgoCatalogo.length === 0) {
        console.error('‚ùå [PROGRAMA] Cat√°logo de patolog√≠as no disponible');
        return;
      }

      console.log(`‚úÖ [PROGRAMA] Cat√°logo disponible con ${window._riesgoCatalogo.length} patolog√≠as`);

      if (typeof sincronizarPatologiasUsuario === 'function') {
        const numMarcadas = await sincronizarPatologiasUsuario(run);
        console.log(`üîß [PROGRAMA] ${numMarcadas} patolog√≠as sincronizadas`);

        const totalPatologiasBD = Array.isArray(window._patologiasUsuarioBD)
          ? window._patologiasUsuarioBD.length
          : 0;

        if (recalcularRiesgo) {
          setTimeout(() => {
            console.log('üîß [PROGRAMA] Calculando riesgo autom√°ticamente...');
            if (typeof window.calcularRiesgoECICEP === 'function') {
              window.calcularRiesgoECICEP();
            } else {
              console.warn('‚ö†Ô∏è [PROGRAMA] Funci√≥n calcularRiesgoECICEP no disponible a√∫n');
            }

            if (numMarcadas === 0) {
              if (totalPatologiasBD > 0) {
                console.info(
                  '‚ÑπÔ∏è [PROGRAMA] Patolog√≠as del usuario est√°n registradas en BD pero no se mapearon al cat√°logo visible; el c√°lculo usar√° los datos sincronizados.',
                  { totalPatologiasBD }
                );
              } else {
                console.info('‚ÑπÔ∏è [PROGRAMA] Usuario sin patolog√≠as registradas; se calcular√° riesgo G0.');
              }
            }
          }, 1000);
        } else if (numMarcadas === 0) {
          if (totalPatologiasBD > 0) {
            console.info(
              '‚ÑπÔ∏è [PROGRAMA] Patolog√≠as del usuario est√°n registradas en BD pero no se mapearon al cat√°logo visible; revise coincidencias de CIE10/ID si requiere marcarlas manualmente.',
              { totalPatologiasBD }
            );
          } else {
            console.info('‚ÑπÔ∏è [PROGRAMA] Usuario sin patolog√≠as registradas; no hay riesgo ECICEP que marcar.');
          }
        }
      } else {
        console.error('‚ùå [PROGRAMA] Funci√≥n sincronizarPatologiasUsuario no disponible');
      }
    }, 1500);
  }

  renderProgramButtons();

  // Funci√≥n para cargar programa actual del usuario desde BD
  async function cargarProgramaUsuario(run) {
    if (!run) return;
    
    try {
      const response = await authFetch(`/api/tarjeton/${encodeURIComponent(run)}`);
      if (!response.ok) return;
      
      const data = await response.json();
      if (data && data.ok && data.usuario) {
        sincronizarProgramasActivos(data.programas_activos, data.usuario);
        console.log(`üîß [PROGRAMA] Usuario ${run} programas activos:`, Array.from(window.programasActivos));
        await forzarProgramaModoECICEP(run);
        sincronizarPatologiasTrasCambio(run, true);
      }
    } catch (error) {
      console.error('‚ùå [PROGRAMA] Error cargando programa del usuario:', error);
    }
  }
  
  // Exponer funci√≥n globalmente para que se pueda llamar desde buscarRun
  window.cargarProgramaUsuario = cargarProgramaUsuario;
  window.sincronizarProgramasActivos = sincronizarProgramasActivos;

  // C√°lculo de edad
  const fecha = document.getElementById('fecha_nacimiento');
  const edad = document.getElementById('edad');
  function calcEdad(){
    if(!fecha.value){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    const fn = new Date(fecha.value);
    if(isNaN(fn.getTime())){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    const hoy = new Date();
    let e = hoy.getFullYear()-fn.getFullYear();
    const mDiff = hoy.getMonth()-fn.getMonth();
    if (mDiff<0 || (mDiff===0 && hoy.getDate()<fn.getDate())) e--;
    if (e<0 || e>120){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    edad.value = e;
    
    // Actualizar visibilidad de pesta√±a Adulto Mayor
    if (typeof mostrarOcultarAdultoMayor === 'function') {
      mostrarOcultarAdultoMayor(e);
    }
  }
  fecha.addEventListener('change', calcEdad);
  fecha.addEventListener('input', calcEdad);

  // RUN auto focus
  const run = document.getElementById('run');
  if(run){ run.focus(); }

  // Reset limpia edad
  document.getElementById('btn-reset').addEventListener('click',()=>{ setTimeout(()=>{ edad.value=''; },0); });

  // Tabs
  const tabs = document.querySelectorAll('.t-tab');
  const panels = document.querySelectorAll('[data-panel]');
  function activarTab(k){
    tabs.forEach(b=>{
      if(b.dataset.tab===k){
        b.classList.add('active');
      } else {
        b.classList.remove('active');
      }
    });
    panels.forEach(p=>{ 
      p.style.display = p.getAttribute('data-panel') === k ? 'block' : 'none'; 
    });
    localStorage.setItem('tarjeton.tab', k);
    
    // Cargar historial espec√≠fico del tab si hay usuario activo
    const runField = document.getElementById('run');
    if (runField && runField.value.trim()) {
      if (k === 'adulto_mayor') {
        cargarHistorialAdultoMayor(runField.value.trim());
        // Obtener datos del usuario para filtrar por g√©nero y edad para screening
        const sexoSpan = document.querySelector('[data-f="sexo"]');
        const edadSpan = document.querySelector('[data-f="edad"]');
        const sexoInput = document.getElementById('sexo');
        const edadInput = document.getElementById('edad');
        
        // Intentar obtener de spans del resumen o de inputs del formulario
        const sexo = (sexoSpan ? sexoSpan.textContent.trim() : '') || 
                     (sexoInput ? sexoInput.value : '');
        const edad = (edadSpan ? parseInt(edadSpan.textContent.trim()) : 0) || 
                     (edadInput ? parseInt(edadInput.value) : 0);
        
        console.log('[DEBUG-SCREENING] Tab Adulto Mayor - Sexo:', sexo, 'Edad:', edad);
        console.log('[DEBUG-SCREENING] Elementos encontrados:', {
          sexoSpan: !!sexoSpan,
          edadSpan: !!edadSpan,
          sexoInput: !!sexoInput,
          edadInput: !!edadInput
        });
        
        cargarDatosScreeningAM(runField.value.trim(), sexo, edad);
      } else if (k === 'funcionalidad') {
        cargarHistorialAdultoMayor(runField.value.trim());
        cargarHistorialActividadFisica(runField.value.trim());
        cargarHistorialMasAma(runField.value.trim());
      }
    }
  }
  tabs.forEach(b=> b.addEventListener('click', ()=> activarTab(b.dataset.tab)));
  activarTab(localStorage.getItem('tarjeton.tab')||'control');

  // (cargarDatos eliminado: ahora toda la carga se centraliza en buscarRun/recargaTodo)

  // ===== Helpers para poblar =====
  function byIdPoblar(id) { return document.getElementById(id); }
  function ensure(v) { return (v ?? '‚Äî'); }
  function setText(el, v) { if (el) el.textContent = v; }

  /**
   * Asigna value si el valor es distinto de undefined/null/''
   * y emite el mismo log "Asignado <id>: <val>" que el c√≥digo original.
   * Mantiene el orden de logs/efectos al ser llamado en la misma secuencia.
   */
  function setValueIfPresent(id, value) {
    const el = byIdPoblar(id);
    console.log(`[DEBUG-SETVALUE] Intentando asignar ${id}:`, value, 'Elemento encontrado:', !!el);
    if (el && value !== undefined && value !== null && value !== '') {
      el.value = value;
      console.log(`‚úÖ Asignado ${id}: ${value}`);
    } else {
      console.warn(`‚ö†Ô∏è No se pudo asignar ${id}. Elemento:`, !!el, ', Valor:', value);
    }
  }

  function clasificarPatologia(nombreRaw, cie10Raw) {
    const nombre = (nombreRaw || '').toLowerCase();
    const codigo = (cie10Raw || '').toUpperCase();

    // HTA: por nombre, por I10‚ÄìI13.*, o exactamente I23.2
    if (/hipertens/i.test(nombre) || /^(I10|I11|I12|I13)(\.|$)/i.test(codigo) || /^I23\.2$/i.test(codigo)) {
      return 'pat-hta';
    }
    // Dislipidemia: por nombre o E78.*
    if (/dislipid/i.test(nombre) || /^E78(\.|$)/i.test(codigo)) {
      return 'pat-dislip';
    }
    // Diabetes: por nombre o E10‚ÄìE14.*
    if (/diab/i.test(nombre) || /^E1[0-4](\.|$)/i.test(codigo)) {
      return 'pat-diabetes';
    }
    return '';
  }

  function renderPatologias(ul, pats) {
    console.log('[DEBUG-RENDER-PATS] Renderizando patolog√≠as:', pats, 'UL:', !!ul);
    if (!ul) {
      console.warn('[DEBUG-RENDER-PATS] No se encontr√≥ elemento UL para patolog√≠as');
      return;
    }
    ul.innerHTML = '';
    if (!Array.isArray(pats) || pats.length === 0) {
      console.log('[DEBUG-RENDER-PATS] Sin patolog√≠as para mostrar');
      ul.innerHTML = '<li style="opacity:.6;">Sin datos</li>';
      return;
    }
    console.log(`[DEBUG-RENDER-PATS] Renderizando ${pats.length} patolog√≠as`);
    pats.forEach(p => {
      const li = document.createElement('li');
      const codigo = (p.cie10 || '').toUpperCase();
      const nombre = (p.nombre || '');
      li.className = clasificarPatologia(nombre, codigo);
      li.textContent = (codigo ? (codigo + ' - ') : '') + nombre;
      
      // Hacer clickeable para marcar en checklist de c√°lculo de riesgo
      li.style.cursor = 'pointer';
      li.style.transition = 'all 0.2s';
      li.title = 'Click para marcar en c√°lculo de riesgo';
      
      li.addEventListener('mouseover', () => {
        li.style.opacity = '0.7';
        li.style.transform = 'translateX(3px)';
      });
      
      li.addEventListener('mouseout', () => {
        li.style.opacity = '1';
        li.style.transform = 'translateX(0)';
      });
      
      li.addEventListener('click', () => {
        // Buscar checkbox correspondiente en el panel de c√°lculo de riesgo
        const contenedorPats = document.getElementById('contenedor-patologias');
        if (!contenedorPats) {
          console.warn('[CLICK-PAT] No se encontr√≥ contenedor-patologias');
          return;
        }
        
        // Buscar por c√≥digo CIE10 en los checkboxes
        const checkboxes = contenedorPats.querySelectorAll('input[type="checkbox"]');
        let encontrado = false;
        
        checkboxes.forEach(cb => {
          const label = cb.closest('label');
          if (!label) return;
          
          // Buscar el c√≥digo CIE10 en el label (est√° en el div con CIE-10: ...)
          const cie10Div = label.querySelector('div div[style*="font-size: 0.65rem"]');
          if (cie10Div) {
            const textoCompleto = cie10Div.textContent;
            // Extraer el c√≥digo despu√©s de "CIE-10: "
            const match = textoCompleto.match(/CIE-10:\s*([A-Z]\d+(\.\d+)?)/i);
            if (match) {
              const codigoCb = match[1].toUpperCase();
              // Comparar c√≥digos (match exacto o el del resumen es un prefijo)
              if (codigoCb === codigo || codigoCb.startsWith(codigo) || codigo.startsWith(codigoCb)) {
                // Marcar o desmarcar el checkbox
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event('change'));
                encontrado = true;
                console.log(`[CLICK-PAT] ${cb.checked ? 'Marcado' : 'Desmarcado'}: ${codigo} - ${nombre}`);
                
                // Feedback visual
                li.style.fontWeight = cb.checked ? 'bold' : 'normal';
                li.style.textDecoration = cb.checked ? 'underline' : 'none';
              }
            }
          }
        });
        
        if (!encontrado) {
          console.warn(`[CLICK-PAT] No se encontr√≥ checkbox para: ${codigo} - ${nombre}`);
          // Mostrar mensaje al usuario
          const mensaje = document.createElement('div');
          mensaje.textContent = `‚ö†Ô∏è Patolog√≠a "${codigo}" no encontrada en el cat√°logo de riesgo`;
          mensaje.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#f59e0b;color:white;padding:12px 20px;border-radius:8px;z-index:10000;font-size:0.85rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
          document.body.appendChild(mensaje);
          setTimeout(() => mensaje.remove(), 2500);
        }
      });
      
      ul.appendChild(li);
      console.log(`[DEBUG-RENDER-PATS] Agregada: ${codigo} - ${nombre}`);
    });
    console.log('[DEBUG-RENDER-PATS] Renderizado completo');
    
    // Actualizar estado visual despu√©s de renderizar
    setTimeout(() => {
      if (typeof actualizarEstadoPatologiasResumen === 'function') {
        actualizarEstadoPatologiasResumen();
      }
    }, 100);
  }

  function autocompletarIdentificacion(u, selSector, edadBackend) {
    const formTar = byIdPoblar('form-tarjeton');
    if (!(formTar && u && u.run)) return;

    console.log('Autocompletando formulario con usuario:', u);
    console.log('Edad desde backend:', edadBackend);

    // Mantener exactamente el mismo orden de asignaciones y logs
    setValueIfPresent('run', u.run);
    // Tambi√©n sincronizar el campo de b√∫squeda
    setValueIfPresent('run-search', u.run);
    setValueIfPresent('nombre', u.nombre_completo || u.nombre);
    
    // Convertir fecha_nacimiento a formato YYYY-MM-DD para input type="date"
    if (u.fecha_nacimiento) {
      try {
        const fecha = new Date(u.fecha_nacimiento);
        if (!isNaN(fecha.getTime())) {
          const yyyy = fecha.getFullYear();
          const mm = String(fecha.getMonth() + 1).padStart(2, '0');
          const dd = String(fecha.getDate()).padStart(2, '0');
          const fechaFormateada = `${yyyy}-${mm}-${dd}`;
          console.log(`[DEBUG-FECHA] Fecha original: ${u.fecha_nacimiento}, Formateada: ${fechaFormateada}`);
          setValueIfPresent('fecha_nacimiento', fechaFormateada);
          
          // Calcular edad - prioridad: backend > frontend
          let edadFinal = edadBackend; // Usar edad del backend primero
          
          if (!edadFinal && typeof _calcEdad === 'function') {
            // Si no hay edad del backend, calcular en frontend
            edadFinal = _calcEdad(fechaFormateada);
          }
          
          console.log(`[DEBUG-EDAD] Edad final: ${edadFinal} a√±os (backend: ${edadBackend}, calculada: ${_calcEdad ? _calcEdad(fechaFormateada) : 'N/A'})`);
          
          if (edadFinal !== null && edadFinal !== undefined && edadFinal !== '') {
            setValueIfPresent('edad', edadFinal);
          }
        } else {
          console.warn('[DEBUG-FECHA] Fecha inv√°lida:', u.fecha_nacimiento);
        }
      } catch (e) {
        console.error('[DEBUG-FECHA] Error convirtiendo fecha:', e);
      }
    } else if (edadBackend) {
      // Si no hay fecha de nacimiento pero s√≠ edad del backend, usarla
      console.log(`[DEBUG-EDAD] Usando edad del backend sin fecha: ${edadBackend}`);
      setValueIfPresent('edad', edadBackend);
    }
    
    // Convertir fecha_ingreso a formato YYYY-MM-DD para input type="date"
    if (u.fecha_ingreso) {
      try {
        const fechaIngreso = new Date(u.fecha_ingreso);
        if (!isNaN(fechaIngreso.getTime())) {
          const yyyy = fechaIngreso.getFullYear();
          const mm = String(fechaIngreso.getMonth() + 1).padStart(2, '0');
          const dd = String(fechaIngreso.getDate()).padStart(2, '0');
          const fechaIngresoFormateada = `${yyyy}-${mm}-${dd}`;
          console.log(`[DEBUG-FECHA-INGRESO] Fecha original: ${u.fecha_ingreso}, Formateada: ${fechaIngresoFormateada}`);
          setValueIfPresent('fecha_ingreso', fechaIngresoFormateada);
        } else {
          console.warn('[DEBUG-FECHA-INGRESO] Fecha inv√°lida:', u.fecha_ingreso);
        }
      } catch (e) {
        console.error('[DEBUG-FECHA-INGRESO] Error convirtiendo fecha:', e);
      }
    }
    
    setValueIfPresent('sexo', u.sexo);
    if (selSector && u.sector_id) selSector.value = u.sector_id; // no log aqu√≠ en el original
    setValueIfPresent('telefono', u.telefono);
    setValueIfPresent('direccion', u.direccion);

    // Resetear flag como en el original
    window._identEditadoManualmente = false;
  }

  // ===== MISMA FIRMA P√öBLICA =====
  function poblar(data) {
    console.log('üîß [DEBUG-POBLAR] *** FUNCION POBLAR EJECUTADA ***', data);
    const u = (data && data.usuario) || {};

    // Mostrar resumen y ocultar badge nuevo si existe usuario
    const cardResumenAuto = byIdPoblar('card-resumen');
    if (cardResumenAuto) { cardResumenAuto.style.display = 'flex'; }
    if (u && u.run) {
      const badgeNuevo = byIdPoblar('badge-nuevo-usuario');
      if (badgeNuevo) badgeNuevo.style.display = 'none';
    }

    // Mapa de campos para [data-f]
    const fechaNacFormateada = u.fecha_nacimiento ? new Date(u.fecha_nacimiento).toLocaleDateString('es-CL') : '‚Äî';
    console.log('üîß [DEBUG-POBLAR] Fecha nacimiento original:', u.fecha_nacimiento);
    console.log('üîß [DEBUG-POBLAR] Fecha formateada:', fechaNacFormateada);
    console.log('üîß [DEBUG-POBLAR] Edad del data:', data?.edad);
    
    // Categor√≠a de riesgo (G1/G2/G3) - SIN bypass CARDIO
    let categoriaMostrar = ensure(u.categoria_nombre || u.categoria_ecicep_effectiva);
    console.log('üîß [DEBUG-POBLAR] Categor√≠a del usuario:', categoriaMostrar);
    
    const patologiasResumen = Array.isArray(data?.patologias_resumen) ? data.patologias_resumen : [];
    window.__usuarioPatologiasResumen = patologiasResumen;
    window.__usuarioSexo = u?.sexo ?? '';
    window.__labsRecientes = null;
    window.__ultimoControl = null;
    if (data?.edad != null) {
      const edadNum = Number(data.edad);
      window.__usuarioEdad = Number.isFinite(edadNum) ? edadNum : data.edad;
    } else {
      window.__usuarioEdad = undefined;
    }
    if (typeof data?.tiene_diabetes === 'boolean') {
      window.__usuarioTieneDiabetes = data.tiene_diabetes;
    } else if (patologiasResumen.length) {
      window.__usuarioTieneDiabetes = patologiasResumen.some(p => {
        const nombre = (p.nombre || '').toLowerCase();
        const cie10 = (p.cie10 || p.codigo || '').toLowerCase();
        return nombre.includes('diabet') || /^e1[0-4]/.test(cie10);
      });
    } else {
      window.__usuarioTieneDiabetes = undefined;
    }

    const map = {
      run: ensure(u.run),
      nombre_completo: ensure(u.nombre_completo || u.nombre),
      fecha_nacimiento: fechaNacFormateada,
      edad: ensure(data?.edad),
      sexo: ensure(u.sexo),
      sector_nombre: ensure(u.sector_nombre),
      categoria_nombre: categoriaMostrar,
      telefono: ensure(u.telefono)
    };

    // Volcar [data-f] manteniendo el mismo comportamiento
    console.log('üîß [DEBUG-POBLAR] Elementos data-f encontrados:', document.querySelectorAll('[data-f]').length);
    document.querySelectorAll('[data-f]').forEach(sp => {
      const valor = map[sp.dataset.f] ?? '‚Äî';
      console.log('üîß [DEBUG-POBLAR] Asignando', sp.dataset.f, '=', valor);
      setText(sp, valor);
    });

    // Badge riesgo/categor√≠a (misma posici√≥n en el flujo)
    try {
      if (window.actualizarBadgeRiesgo && typeof window.actualizarBadgeRiesgo === 'function') {
        window.actualizarBadgeRiesgo(map.categoria_nombre);
      }
      
      // Actualizar badge "Actual:" en el panel de c√°lculo de riesgo
      const badgeActual = document.getElementById('riesgo-actual');
      if (badgeActual && map.categoria_nombre && map.categoria_nombre !== '‚Äî') {
        badgeActual.textContent = map.categoria_nombre;
        
        // Aplicar clase de estilo seg√∫n categor√≠a
        badgeActual.className = 'badge-riesgo';
        if (map.categoria_nombre === 'CARDIO') {
          badgeActual.classList.add('badge-neutro');
        } else if (map.categoria_nombre === 'G1') {
          badgeActual.classList.add('badge-g1');
        } else if (map.categoria_nombre === 'G2') {
          badgeActual.classList.add('badge-g2');
        } else if (map.categoria_nombre === 'G3') {
          badgeActual.classList.add('badge-g3');
        } else {
          badgeActual.classList.add('badge-neutro');
        }
        
        console.log('üîß [DEBUG-POBLAR] Badge riesgo actual actualizado:', map.categoria_nombre);
      }
    } catch(e) {
      console.warn('actualizarBadgeRiesgo no disponible:', e.message);
    }

    // Patolog√≠as
  renderPatologias(byIdPoblar('lista-patologias'), patologiasResumen);

    // Acuerdo reciente
    const ac = byIdPoblar('acuerdo-reciente');
    if (ac) {
      if (data?.acuerdo_reciente) {
        const ar = data.acuerdo_reciente;
        ac.textContent = `${ar.fecha_creacion || ''}: ${ar.acuerdos || ''} (${ar.cumplimiento || ''})`;
      } else {
        ac.textContent = '‚Äî';
      }
    }

    // Set select de sector y categor√≠a input (antes del autocompletado, como en el original)
    const selSector = byIdPoblar('sector_id');
    if (selSector && u.sector_id) {
      selSector.value = u.sector_id;
    }
    const cat = byIdPoblar('categoria');
    if (cat) { cat.value = map.categoria_nombre; }

    // Autocompletar identificaci√≥n (manteniendo logs y orden) - Pasar edad del backend
    autocompletarIdentificacion(u, selSector, data?.edad);
    
    // Mostrar/ocultar pesta√±a Adulto Mayor basada en la edad
    mostrarOcultarAdultoMayor(data?.edad);
    
    // Mostrar/ocultar pesta√±a Evaluaci√≥n Diabetes basada en patolog√≠as
    mostrarOcultarDiabetes(data?.patologias_resumen);
    
    // Mostrar/ocultar secci√≥n IECA/ARA II basada en patolog√≠as
    mostrarOcultarIecaAra(data?.patologias_resumen);
    
    // Mostrar/ocultar secci√≥n Estatinas basada en patolog√≠as
    mostrarOcultarEstatinas(data?.patologias_resumen);
    
    // Mostrar/ocultar secci√≥n Antiagregantes basada en patolog√≠as
    mostrarOcultarAntiagregantes(data?.patologias_resumen);
    
    console.log('üîß [DEBUG-POBLAR] *** POBLAR COMPLETADO ***');
    
    // Disparar evento global para flujos dependientes (alertas, etc.)
    try {
      const runEmit = (u?.run || '').trim();
      const payloadAlertas = Array.isArray(data?.alertas_vigencia) ? data.alertas_vigencia : undefined;
      window.dispatchEvent(new CustomEvent('usuario:cargado', {
        detail: {
          run: runEmit || null,
          alertas: payloadAlertas,
          fuente: 'poblar'
        }
      }));
    } catch (e) {
      console.warn('üîß [DEBUG-POBLAR] No se pudo emitir usuario:cargado', e);
    }

    // Verificaci√≥n adicional para pesta√±as condicionales despu√©s de un breve delay
    setTimeout(() => {
      console.log('üîß [DEBUG] Verificaci√≥n post-poblar de pesta√±as condicionales');
      mostrarOcultarAdultoMayor(data?.edad);
      mostrarOcultarDiabetes(data?.patologias_resumen);
      mostrarOcultarIecaAra(data?.patologias_resumen);
      mostrarOcultarEstatinas(data?.patologias_resumen);
      mostrarOcultarAntiagregantes(data?.patologias_resumen);
    }, 100);
  }

  // Funci√≥n para mostrar/ocultar pesta√±a Adulto Mayor basada en la edad
  function mostrarOcultarAdultoMayor(edad) {
    console.log('üîß [DEBUG] Verificando edad para Adulto Mayor:', edad, typeof edad);
    
    // Buscar la pesta√±a de "Adulto Mayor" (funcionalidad)
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    const panelAdultoMayor = document.querySelector('[data-panel="funcionalidad"]');
    
    if (tabAdultoMayor) {
      const edadNumerica = parseInt(edad);
      console.log('üîß [DEBUG] Edad num√©rica calculada:', edadNumerica, 'Es v√°lida:', !isNaN(edadNumerica));
      
      if (!isNaN(edadNumerica) && edadNumerica >= 65) {
        // Mostrar pesta√±a para usuarios de 65 a√±os o m√°s
        tabAdultoMayor.style.display = 'block';
        console.log('üîß [DEBUG] ‚úÖ Mostrando pesta√±a Adulto Mayor para edad:', edadNumerica);
      } else {
        // Ocultar pesta√±a para usuarios menores de 65 a√±os o edad inv√°lida
        tabAdultoMayor.style.display = 'none';
        console.log('üîß [DEBUG] ‚ùå Ocultando pesta√±a Adulto Mayor para edad:', edadNumerica);
        
        // Si la pesta√±a activa es "funcionalidad", cambiar a "control"
        if (tabAdultoMayor.classList.contains('active') || tabAdultoMayor.classList.contains('t-tab-active')) {
          const tabControl = document.querySelector('[data-tab="control"]');
          if (tabControl) {
            tabControl.click();
            console.log('üîß [DEBUG] Cambiando a pesta√±a Control porque Adulto Mayor estaba activa');
          }
        }
      }
      
      // Verificaci√≥n adicional despu√©s del cambio
      const displayFinal = getComputedStyle(tabAdultoMayor).display;
      console.log('üîß [DEBUG] Display final de pesta√±a Adulto Mayor:', displayFinal);
    } else {
      console.warn('üîß [DEBUG] ‚ö†Ô∏è No se encontr√≥ la pesta√±a Adulto Mayor');
    }
  }

  // Funci√≥n para mostrar/ocultar pesta√±a Evaluaci√≥n Diabetes basada en si tiene diabetes
  function mostrarOcultarDiabetes(patologias_resumen) {
    console.log('üîß [DEBUG] Verificando patolog√≠as para Evaluaci√≥n Diabetes (requiere diabetes):', patologias_resumen);
    
    // Buscar la pesta√±a de "Evaluaci√≥n Diabetes"
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    const panelDiabetes = document.querySelector('[data-panel="diabetes"]');
    
    if (tabDiabetes) {
      let tieneDiabetes = false;
      
      // Verificar si tiene diabetes en las patolog√≠as
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        // Verificar diabetes
        tieneDiabetes = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          // Buscar t√©rminos relacionados con diabetes
          return nombre.includes('diabetes') || cie10.includes('e10') || cie10.includes('e11') || 
                 cie10.includes('e12') || cie10.includes('e13') || cie10.includes('e14');
        });
      }
      
      console.log('üîß [DEBUG] Diabetes:', tieneDiabetes);
      
      if (tieneDiabetes) {
        // Mostrar pesta√±a para usuarios con diabetes
        tabDiabetes.style.display = 'block';
        console.log('üîß [DEBUG] Mostrando pesta√±a Evaluaci√≥n Diabetes - usuario tiene diabetes');
      } else {
        // Ocultar pesta√±a para usuarios sin diabetes
        tabDiabetes.style.display = 'none';
        console.log('üîß [DEBUG] Ocultando pesta√±a Evaluaci√≥n Diabetes - usuario sin diabetes');
        
        // Si la pesta√±a activa es "diabetes", cambiar a "control"
        if (tabDiabetes.classList.contains('active') || tabDiabetes.classList.contains('t-tab-active')) {
          const tabControl = document.querySelector('[data-tab="control"]');
          if (tabControl) {
            tabControl.click();
            console.log('üîß [DEBUG] Cambiando a pesta√±a Control porque Evaluaci√≥n Diabetes estaba activa');
          }
        }
      }
    } else {
      console.warn('üîß [DEBUG] No se encontr√≥ la pesta√±a Evaluaci√≥n Diabetes');
    }
  }

  // Funci√≥n para mostrar/ocultar secci√≥n IECA/ARA II (solo para diab√©ticos con ERC)
  function mostrarOcultarIecaAra(patologias_resumen) {
    console.log('üîß [DEBUG-IECA] Verificando patolog√≠as para IECA/ARA II (requiere diabetes + ERC):', patologias_resumen);
    
    const seccionIecaAra = document.getElementById('seccionIecaAra');
    
    if (seccionIecaAra) {
      let tieneDiabetes = false;
      let tieneERC = false;
      
      // Verificar si tiene diabetes Y ERC en las patolog√≠as
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        // Verificar diabetes (E10-E14)
        tieneDiabetes = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          return nombre.includes('diabetes') || 
                 cie10.includes('e10') || cie10.includes('e11') || 
                 cie10.includes('e12') || cie10.includes('e13') || cie10.includes('e14');
        });
        
        // Verificar enfermedad renal cr√≥nica (N18 - cualquier estadio)
        tieneERC = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          return nombre.includes('renal cronica') || nombre.includes('renal cr√≥nica') || 
                 nombre.includes('erc') || nombre.includes('insuficiencia renal') ||
                 nombre.includes('nefropat√≠a') || nombre.includes('nefropatia') ||
                 // N18 (cualquier estadio: N18.0 a N18.9)
                 cie10.includes('n18');
        });
      }
      
      console.log('üîß [DEBUG-IECA] Diabetes:', tieneDiabetes, '- ERC:', tieneERC);
      
      if (tieneDiabetes && tieneERC) {
        // Mostrar secci√≥n para usuarios con diabetes Y ERC
        seccionIecaAra.style.display = 'block';
        console.log('üîß [DEBUG-IECA] Mostrando secci√≥n IECA/ARA II - usuario tiene diabetes + ERC');
      } else {
        // Ocultar secci√≥n para usuarios sin diabetes o sin ERC
        seccionIecaAra.style.display = 'none';
        const razon = !tieneDiabetes ? 'sin diabetes' : 'sin ERC';
        console.log(`üîß [DEBUG-IECA] Ocultando secci√≥n IECA/ARA II - usuario ${razon}`);
      }
    } else {
      console.warn('üîß [DEBUG-IECA] No se encontr√≥ la secci√≥n IECA/ARA II');
    }
  }

  // Funci√≥n para mostrar/ocultar secci√≥n Estatinas (para personas con ECV, IAM o ACV)
  function mostrarOcultarEstatinas(patologias_resumen) {
    console.log('üîß [DEBUG-ESTATINAS] Verificando patolog√≠as para Estatinas (requiere ECV, IAM o ACV):', patologias_resumen);
    
    const seccionEstatinas = document.getElementById('seccionEstatinas');
    
    if (seccionEstatinas) {
      let tieneCondicionCardiovascular = false;
      
      // Verificar si tiene alguna condici√≥n cardiovascular
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        tieneCondicionCardiovascular = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toUpperCase() : '';
          
          // ECV - Enfermedad Cardiovascular (I20-I25 excepto I21/I22, tambi√©n I50)
          const esECV = 
            nombre.includes('cardiovascular') ||
            nombre.includes('cardiopat√≠a') || nombre.includes('cardiopatia') ||
            nombre.includes('angina') ||
            nombre.includes('isquemia') || nombre.includes('isquemica') ||
            nombre.includes('insuficiencia card√≠aca') || nombre.includes('insuficiencia cardiaca') ||
            cie10.includes('I20') || // Angina de pecho
            cie10.includes('I23') || // Complicaciones post-IAM
            cie10.includes('I24') || // Otras enfermedades isqu√©micas agudas
            cie10.includes('I25') || // Enfermedad isqu√©mica cr√≥nica del coraz√≥n
            cie10.includes('I50');   // Insuficiencia card√≠aca
          
          // IAM - Infarto Agudo al Miocardio (I21, I22)
          const esIAM = 
            nombre.includes('infarto') && (nombre.includes('miocardio') || nombre.includes('cardiaco')) ||
            nombre.includes('iam') ||
            cie10.includes('I21') || // IAM
            cie10.includes('I22');   // IAM subsecuente
          
          // ACV - Ataque Cerebrovascular (I63, I64, G45, G46)
          const esACV = 
            nombre.includes('cerebrovascular') ||
            nombre.includes('acv') || nombre.includes('avc') ||
            nombre.includes('ictus') ||
            nombre.includes('accidente vascular') ||
            nombre.includes('infarto cerebral') ||
            nombre.includes('hemorragia cerebral') ||
            nombre.includes('ataque isqu√©mico') || nombre.includes('ataque isquemico') ||
            cie10.includes('I63') ||  // Infarto cerebral
            cie10.includes('I64') ||  // ACV no especificado
            cie10.includes('G45') ||  // Ataques isqu√©micos transitorios
            cie10.includes('G46');    // S√≠ndromes vasculares cerebrales
          
          const resultado = esECV || esIAM || esACV;
          
          if (resultado) {
            console.log('üîß [DEBUG-ESTATINAS] Condici√≥n cardiovascular encontrada:', {
              nombre: patologia.nombre,
              cie10: patologia.cie10,
              esECV: esECV,
              esIAM: esIAM,
              esACV: esACV
            });
          }
          
          return resultado;
        });
      }
      
      console.log('üîß [DEBUG-ESTATINAS] Tiene condici√≥n cardiovascular:', tieneCondicionCardiovascular);
      
      if (tieneCondicionCardiovascular) {
        // Mostrar secci√≥n para usuarios con ECV, IAM o ACV
        seccionEstatinas.style.display = 'block';
        console.log('üîß [DEBUG-ESTATINAS] Mostrando secci√≥n Estatinas - usuario tiene condici√≥n cardiovascular');
      } else {
        // Ocultar secci√≥n para usuarios sin condiciones cardiovasculares
        seccionEstatinas.style.display = 'none';
        console.log('üîß [DEBUG-ESTATINAS] Ocultando secci√≥n Estatinas - usuario sin condici√≥n cardiovascular');
      }
    } else {
      console.warn('üîß [DEBUG-ESTATINAS] No se encontr√≥ la secci√≥n Estatinas');
    }
  }

  // Funci√≥n para mostrar/ocultar secci√≥n Antiagregantes Plaquetarios (mismas condiciones que Estatinas)
  function mostrarOcultarAntiagregantes(patologias_resumen) {
    console.log('üîß [DEBUG-ANTIAGREGANTES] Verificando patolog√≠as para Antiagregantes (requiere ECV, IAM o ACV):', patologias_resumen);
    
    const seccionAntiagregantes = document.getElementById('seccionAntiagregantes');
    
    if (seccionAntiagregantes) {
      let tieneCondicionCardiovascular = false;
      
      // Verificar si tiene alguna condici√≥n cardiovascular (misma l√≥gica que Estatinas)
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        tieneCondicionCardiovascular = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toUpperCase() : '';
          
          // ECV - Enfermedad Cardiovascular (I20-I25 excepto I21/I22, tambi√©n I50)
          const esECV = 
            nombre.includes('cardiovascular') ||
            nombre.includes('cardiopat√≠a') || nombre.includes('cardiopatia') ||
            nombre.includes('angina') ||
            nombre.includes('isquemia') || nombre.includes('isquemica') ||
            nombre.includes('insuficiencia card√≠aca') || nombre.includes('insuficiencia cardiaca') ||
            cie10.includes('I20') || // Angina de pecho
            cie10.includes('I23') || // Complicaciones post-IAM
            cie10.includes('I24') || // Otras enfermedades isqu√©micas agudas
            cie10.includes('I25') || // Enfermedad isqu√©mica cr√≥nica del coraz√≥n
            cie10.includes('I50');   // Insuficiencia card√≠aca
          
          // IAM - Infarto Agudo al Miocardio (I21, I22)
          const esIAM = 
            nombre.includes('infarto') && (nombre.includes('miocardio') || nombre.includes('cardiaco')) ||
            nombre.includes('iam') ||
            cie10.includes('I21') || // IAM
            cie10.includes('I22');   // IAM subsecuente
          
          // ACV - Ataque Cerebrovascular (I63, I64, G45, G46)
          const esACV = 
            nombre.includes('cerebrovascular') ||
            nombre.includes('acv') || nombre.includes('avc') ||
            nombre.includes('ictus') ||
            nombre.includes('accidente vascular') ||
            nombre.includes('infarto cerebral') ||
            nombre.includes('hemorragia cerebral') ||
            nombre.includes('ataque isqu√©mico') || nombre.includes('ataque isquemico') ||
            cie10.includes('I63') ||  // Infarto cerebral
            cie10.includes('I64') ||  // ACV no especificado
            cie10.includes('G45') ||  // Ataques isqu√©micos transitorios
            cie10.includes('G46');    // S√≠ndromes vasculares cerebrales
          
          const resultado = esECV || esIAM || esACV;
          
          if (resultado) {
            console.log('üîß [DEBUG-ANTIAGREGANTES] Condici√≥n cardiovascular encontrada:', {
              nombre: patologia.nombre,
              cie10: patologia.cie10,
              esECV: esECV,
              esIAM: esIAM,
              esACV: esACV
            });
          }
          
          return resultado;
        });
      }
      
      console.log('üîß [DEBUG-ANTIAGREGANTES] Tiene condici√≥n cardiovascular:', tieneCondicionCardiovascular);
      
      if (tieneCondicionCardiovascular) {
        // Mostrar secci√≥n para usuarios con ECV, IAM o ACV
        seccionAntiagregantes.style.display = 'block';
        console.log('üîß [DEBUG-ANTIAGREGANTES] Mostrando secci√≥n Antiagregantes - usuario tiene condici√≥n cardiovascular');
      } else {
        // Ocultar secci√≥n para usuarios sin condiciones cardiovasculares
        seccionAntiagregantes.style.display = 'none';
        console.log('üîß [DEBUG-ANTIAGREGANTES] Ocultando secci√≥n Antiagregantes - usuario sin condici√≥n cardiovascular');
      }
    } else {
      console.warn('üîß [DEBUG-ANTIAGREGANTES] No se encontr√≥ la secci√≥n Antiagregantes');
    }
  }

  // Funci√≥n de diagn√≥stico simple
  window.testSimple = function() {
    console.log('üîß [TEST-SIMPLE] Funci√≥n test disponible');
  };
  
  // Funci√≥n de test para verificar detecci√≥n de diabetes + ERC
  window.testDiabetesERC = function() {
    console.log('üîß [TEST-DIABETES-ERC] Probando detecci√≥n...');
    
    // Caso 1: Solo diabetes
    const soloD = [{nombre: 'Diabetes mellitus tipo 2', cie10: 'E11'}];
    console.log('Test 1 - Solo diabetes:', soloD);
    mostrarOcultarDiabetes(soloD);
    
    // Caso 2: Solo ERC  
    const soloE = [{nombre: 'Enfermedad renal cr√≥nica', cie10: 'N18.6'}];
    console.log('Test 2 - Solo ERC:', soloE);
    mostrarOcultarDiabetes(soloE);
    
    // Caso 3: Diabetes + ERC (deber√≠a mostrar)
    const ambas = [
      {nombre: 'Diabetes mellitus tipo 2', cie10: 'E11'},
      {nombre: 'Enfermedad renal cr√≥nica', cie10: 'N18.6'}
    ];
    console.log('Test 3 - Diabetes + ERC:', ambas);
    mostrarOcultarDiabetes(ambas);
  };
  
  // Funci√≥n de diagn√≥stico para pesta√±as
  window.diagnosticarPestanas = function() {
    console.log('üîß [DIAGNOSTICO] Verificando estado de pesta√±as...');
    
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    const edadSpan = document.querySelector('[data-f="edad"]');
    
    console.log('Pesta√±a Adulto Mayor encontrada:', !!tabAdultoMayor);
    console.log('Pesta√±a Diabetes encontrada:', !!tabDiabetes);
    
    if (tabAdultoMayor) {
      console.log('Adulto Mayor display:', getComputedStyle(tabAdultoMayor).display);
      console.log('Adulto Mayor style.display:', tabAdultoMayor.style.display);
    }
    
    if (tabDiabetes) {
      console.log('Diabetes display:', getComputedStyle(tabDiabetes).display);
      console.log('Diabetes style.display:', tabDiabetes.style.display);
    }
    
    if (edadSpan) {
      const edad = edadSpan.textContent.trim();
      console.log('Edad actual del usuario:', edad);
      
      // Forzar verificaci√≥n de edad
      console.log('Ejecutando mostrarOcultarAdultoMayor con edad:', edad);
      mostrarOcultarAdultoMayor(edad);
    } else {
      console.log('No se encontr√≥ span de edad');
    }
    return 'OK';
  };

  // Funci√≥n de test de poblar con manejo de errores
  window.testPoblar = function() {
    console.log('üîß [TEST] Iniciando test de poblar...');
    try {
      const testData = {
        usuario: {
          run: "10.000.141-1",
          nombre: "Patricio Pino Reyes", 
          fecha_nacimiento: "Thu, 12 Mar 1964 00:00:00 GMT",
          sexo: "masculino",
          sector_nombre: "VERDE"
        },
        edad: 61
      };
      console.log('üîß [TEST] Datos de prueba creados:', testData);
      
      if (typeof poblar === 'function') {
        console.log('üîß [TEST] Funci√≥n poblar encontrada, ejecutando...');
        poblar(testData);
        console.log('üîß [TEST] Funci√≥n poblar ejecutada');
      } else {
        console.error('üîß [TEST] ERROR: funci√≥n poblar no encontrada');
      }
    } catch(error) {
      console.error('üîß [TEST] ERROR en testPoblar:', error);
    }
    console.log('üîß [TEST] Test completado');
    return 'Test ejecutado';
  };

  // Test de fecha espec√≠fico
  window.testFecha = function() {
    console.log('üîß [TEST-FECHA] Probando formateo de fecha...');
    const fecha = 'Thu, 12 Mar 1964 00:00:00 GMT';
    console.log('üîß [TEST-FECHA] Fecha original:', fecha);
    const fechaFormateada = new Date(fecha).toLocaleDateString('es-CL');
    console.log('üîß [TEST-FECHA] Fecha formateada:', fechaFormateada);
    return fechaFormateada;
  };
  // Fuerza estado inicial: s√≥lo toolbar visible
  (function hardStart(){
    const ident = document.getElementById('identificacion-section');
    const cardResumen = document.getElementById('card-resumen');
    if (ident) ident.style.display='none';
    if (cardResumen) cardResumen.style.display='none';
    
    // Asegurar que la pesta√±a Adulto Mayor est√© oculta inicialmente
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    if (tabAdultoMayor) {
      tabAdultoMayor.style.display = 'none';
      console.log('üîß [INIT] Pesta√±a Adulto Mayor oculta al iniciar');
    }
    
    // Asegurar que la pesta√±a Evaluaci√≥n Diabetes est√© oculta inicialmente
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    if (tabDiabetes) {
      tabDiabetes.style.display = 'none';
      console.log('üîß [INIT] Pesta√±a Evaluaci√≥n Diabetes oculta al iniciar (requiere diabetes + ERC)');
    }
    
    // Verificaci√≥n peri√≥dica de pesta√±as para casos donde se cargan datos despu√©s
    setTimeout(() => {
      console.log('üîß [INIT] Verificaci√≥n de pesta√±as condicionales despu√©s de inicializaci√≥n');
      
      // Verificar si hay edad cargada
      const edadSpan = document.querySelector('[data-f="edad"]');
      if (edadSpan && edadSpan.textContent.trim()) {
        const edad = edadSpan.textContent.trim();
        console.log('üîß [INIT] Edad encontrada en DOM:', edad);
        mostrarOcultarAdultoMayor(edad);
      }
      
      // Verificar pesta√±as y forzar estado correcto
      const tabAM = document.querySelector('[data-tab="funcionalidad"]');
      const tabD = document.querySelector('[data-tab="diabetes"]');
      
      if (tabAM && !tabAM.style.display) {
        console.log('üîß [INIT] Forzando ocultamiento de pesta√±a Adulto Mayor sin display definido');
        tabAM.style.display = 'none';
      }
      
      if (tabD && !tabD.style.display) {
        console.log('üîß [INIT] Forzando ocultamiento de pesta√±a Diabetes sin display definido');
        tabD.style.display = 'none';
      }
    }, 500);
  })();

  // --- NUEVO FLUJO BUSCAR RUN ---
  document.addEventListener('DOMContentLoaded', function(){
    const ident = document.getElementById('identificacion-section');
    const formTarjeton = document.getElementById('form-tarjeton');
    const cardResumen = document.getElementById('card-resumen');
    const layoutGrid = document.getElementById('layout-tarjeton-grid');
    const runSearch = document.getElementById('run-search');
    const btnBuscar = document.getElementById('btn-buscar-run');
    const helpSearch = document.getElementById('run-search-help');
    const runForm = document.getElementById('run');
    const btnEditarIdent = document.getElementById('btn-editar-ident');
    window._identEditadoManualmente = false;
    
    console.log('üîç [INIT] Elementos de b√∫squeda cargados:', {
      ident: !!ident,
      formTarjeton: !!formTarjeton,
      cardResumen: !!cardResumen,
      layoutGrid: !!layoutGrid,
      runSearch: !!runSearch,
      btnBuscar: !!btnBuscar,
      helpSearch: !!helpSearch,
      runForm: !!runForm,
      btnEditarIdent: !!btnEditarIdent
    });

    // Funcionalidad de colapso removida - resumen siempre visible

    // Marcar edici√≥n manual en cualquier cambio de inputs clave
    ['run','nombre','fecha_nacimiento','sexo','telefono','direccion','sector_id'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){ el.addEventListener('input', ()=>{ window._identEditadoManualmente = true; }); }
    });

    if(btnEditarIdent){
      btnEditarIdent.addEventListener('click', ()=>{
        if(cardResumen) cardResumen.style.display='none';
        if(ident) ident.style.display='block';
        layoutGrid?.classList.add('no-resumen');
        layoutGrid?.classList.remove('solo-resumen');
        // No reseteamos banderas aqu√≠: se asume usuario quiere preservar cambios
      });
    }

    function mostrarIdentificacionNuevo(runPrefill){
      if (runPrefill && runForm){ runForm.value = runPrefill; }
      if (runPrefill) {
        const runCanon = formatearRunParaEnvio(runPrefill);
        window._runActivo = runCanon || runPrefill;
      }
      if (cardResumen) cardResumen.style.display = 'none';
      if (ident) ident.style.display = 'block';
      layoutGrid?.classList.add('no-resumen');
      const badgeNuevo = document.getElementById('badge-nuevo-usuario');
      if(badgeNuevo) badgeNuevo.style.display='inline-block';
    }
    // Resumen siempre visible: se eliminan mostrarResumen/ocultarTodoMenosToolbar.

    function normalizarRun(v){ return (v||'').toString().replace(/[.\-]/g,'').toUpperCase(); }
    function validarRunCl(v){
      const s = normalizarRun(v);
      if (s.length < 2) return false;
      const cuerpo = s.slice(0,-1); const dv = s.slice(-1);
      if(!/^\d+$/.test(cuerpo)) return false;
      let suma=0, mul=2;
      for(let i=cuerpo.length-1;i>=0;i--){
        suma += parseInt(cuerpo[i],10)*mul;
        mul = (mul===7)?2:(mul+1);
      }
      const res = 11 - (suma % 11);
      const dvCalc = res===11? '0' : (res===10? 'K' : String(res));
      return dvCalc === dv;
    }

    // ==== Helpers de UI/valores (sin efectos secundarios extra√±os) ====
    function trimRun() {
      const vSearch = (runSearch?.value || '').trim();
      if (vSearch) return vSearch;
      const runField = document.getElementById('run');
      return (runField?.value || '').trim();
    }

    function isOkData(resp, data) {
      return resp.ok && data && data.ok && (data.usuario || data.patologias_resumen || data.edad !== undefined);
    }

    function marcarValidez(ok){
      runSearch.classList.toggle('is-invalid', !ok);
      runSearch.classList.toggle('is-valid', !!ok);
      helpSearch.style.display = ok ? 'none' : 'block';
    }

    // Listener mejorado con autocompletado
    runSearch?.addEventListener('input', ()=>{
      const ok = validarRunCl(runSearch.value);
      marcarValidez(ok);
      
      // Sincronizar con campo RUN del formulario
      if (runForm && runSearch.value) {
        runForm.value = runSearch.value;
      }
      if (ok) {
        const runCanon = formatearRunParaEnvio(runSearch.value.trim());
        window._runActivo = runCanon || runSearch.value.trim();
      }
    });

    // Sincronizaci√≥n bidireccional: si se escribe en el formulario, actualizar b√∫squeda
    runForm?.addEventListener('input', ()=>{
      if (runSearch && runForm.value) {
        runSearch.value = runForm.value;
        const ok = validarRunCl(runForm.value);
        marcarValidez(ok);
        if (ok) {
          const runCanon = formatearRunParaEnvio(runForm.value.trim());
          window._runActivo = runCanon || runForm.value.trim();
        }
      }
    });

    async function buscarRun(){
      console.log('üîç [BUSCAR_RUN] =============================================');
      console.log('üîç [BUSCAR_RUN] Funci√≥n buscarRun() ejecutada');
      console.log('üîç [BUSCAR_RUN] Timestamp:', new Date().toISOString());
      
      console.log('üîç [BUSCAR_RUN] Paso 1: Obteniendo RUN con trimRun()...');
      const val = trimRun();
      console.log('üîç [BUSCAR_RUN] RUN obtenido:', `"${val}"`);
      
      if (!val) {
        console.error('‚ùå [BUSCAR_RUN] Campo RUN est√° vac√≠o');
        alert('Por favor, ingrese un RUN para buscar');
        const runInput = document.getElementById('run-search');
        if (runInput) runInput.focus();
        return;
      }

      console.log('üîç [BUSCAR_RUN] Paso 2: Validando RUN...');
      console.log('üîç [BUSCAR_RUN] Funci√≥n validarRunCl disponible:', typeof validarRunCl);
      const esValido = validarRunCl(val);
      console.log('üîç [BUSCAR_RUN] RUN v√°lido:', esValido);
      
      if(!esValido){
        marcarValidez(false);
        console.error('‚ùå [BUSCAR_RUN] RUN inv√°lido, deteniendo');
        alert('RUN inv√°lido. Formato esperado: 12.345.678-9');
        return;
      }
      
      console.log('üîç [BUSCAR_RUN] Paso 3: Marcando como v√°lido...');
      marcarValidez(true);

      window.__buscarRunCola = window.__buscarRunCola || [];
      window.__buscarRunColaTimer = window.__buscarRunColaTimer || null;
      const colaBusquedas = window.__buscarRunCola;

      const mostrarEstadoBusqueda = (mensaje, tipo = 'info') => {
        const estadoRun = document.querySelector('.estado-run') || document.querySelector('.lblEstado');
        if (!estadoRun || !mensaje) return;
        estadoRun.textContent = mensaje;
        if (tipo === 'error') {
          estadoRun.style.color = '#b91c1c';
        } else if (tipo === 'warn') {
          estadoRun.style.color = '#b45309';
        } else {
          estadoRun.style.color = '#334155';
        }
      };

      const programarProcesamientoCola = (delay = 0) => {
        const espera = Math.max(delay, 0);
        if (window.__buscarRunColaTimer) {
          clearTimeout(window.__buscarRunColaTimer);
        }
        window.__buscarRunColaTimer = setTimeout(() => {
          window.__buscarRunColaTimer = null;
          procesarBusquedaPendiente();
        }, espera);
      };

      const encolarBusqueda = (runPendiente, delayMs = 0) => {
        if (!runPendiente) return;
        const readyAt = Date.now() + Math.max(delayMs, 0);
        const existente = colaBusquedas.find(item => item.run === runPendiente);
        if (existente) {
          existente.readyAt = Math.max(existente.readyAt, readyAt);
        } else {
          colaBusquedas.push({ run: runPendiente, readyAt });
        }
        colaBusquedas.sort((a, b) => (a.readyAt || 0) - (b.readyAt || 0));
        const siguiente = colaBusquedas[0];
        if (siguiente) {
          const wait = (siguiente.readyAt || Date.now()) - Date.now();
          programarProcesamientoCola(wait > 0 ? wait : 0);
        }
      };

      const procesarBusquedaPendiente = () => {
        if (window.__buscarRunEnCurso) return;
        if (!colaBusquedas.length) return;
        colaBusquedas.sort((a, b) => (a.readyAt || 0) - (b.readyAt || 0));
        const siguiente = colaBusquedas[0];
        const esperaRestante = (siguiente.readyAt || Date.now()) - Date.now();
        if (esperaRestante > 0) {
          programarProcesamientoCola(esperaRestante);
          return;
        }
        const item = colaBusquedas.shift();
        if (!item || !item.run) return;
        if (runSearch) runSearch.value = item.run;
        if (runForm) runForm.value = item.run;
        marcarValidez(validarRunCl(item.run));
        setTimeout(() => buscarRun(), 200);
      };

      const runParaCola = formatearRunParaEnvio(val) || val.trim();

      if (window.__buscarRunEnCurso) {
        console.warn('üîç [BUSCAR_RUN] Consulta en curso, encolando siguiente ejecuci√≥n:', runParaCola);
        encolarBusqueda(runParaCola);
        mostrarEstadoBusqueda('‚è≥ Consulta en curso. Se ejecutar√° autom√°ticamente en cuanto finalice la actual.', 'warn');
        return;
      }

      window.__buscarRunEnCurso = true;

      const ahora = Date.now();
      const bloqueoActivo = window.__buscarRunRateLimitHasta || 0;
      if (bloqueoActivo && ahora < bloqueoActivo) {
        const esperaMs = bloqueoActivo - ahora;
        console.warn(`üîç [BUSCAR_RUN] Rate limit activo (${esperaMs}ms). Esperando antes de continuar.`);
        mostrarEstadoBusqueda(`‚è≥ Servidor ocupado. Reintentando en ${Math.ceil(esperaMs / 1000)}s...`, 'warn');
        await new Promise(resolve => setTimeout(resolve, esperaMs));
      }

      // === Helpers para b√∫squeda ===
      const createLoadingManager = () => {
        const btnLbl = btnBuscar.querySelector('.lbl');
        const spinWrap = btnBuscar.querySelector('.spinner');
        
        return (on) => {
          if(on){
            btnBuscar.disabled = true;
            btnLbl.style.opacity = '0';
            spinWrap.style.display = 'flex';
          } else {
            btnBuscar.disabled = false;
            btnLbl.style.opacity = '1';
            spinWrap.style.display = 'none';
          }
        };
      };

      // === Helpers puros para buscarRun ===
      const parseJsonOrText = async (r) => {
        try{
          const data = await r.json();
          console.log('üîç [DEBUG] Respuesta JSON parseada:', data);
          return data;
        } catch(jsonError){
          console.error('üîç [DEBUG] Error parseando JSON:', jsonError);
          const textResponse = await r.text();
          console.log('üîç [DEBUG] Respuesta como texto:', textResponse);
          return { ok: false, error: 'JSON_PARSE_ERROR' };
        }
      };

      const aplicarUIUsuarioExistente = async (val, data) => {
        console.log('Aplicando UI para usuario existente:', data?.usuario?.nombre);
        const runCanon = formatearRunParaEnvio(val);
        window._runActivo = runCanon || val;
        
        // Limpiar selecci√≥n de patolog√≠as antes de poblar
        if (typeof window._limpiarSeleccionRiesgo === 'function') {
          window._limpiarSeleccionRiesgo();
          console.log('üßπ [BUSCAR_RUN] Selecci√≥n de patolog√≠as limpiada');
        }
        
        if (typeof poblar === 'function') poblar(data);

        // Cargar programa actual del usuario (CARDIO/ECICEP)
        if (typeof window.cargarProgramaUsuario === 'function') {
          window.cargarProgramaUsuario(val);
        }

        // Ocultar identificaci√≥n si estaba abierta
        if (ident) ident.style.display = 'none';

        // Asegurar resumen visible + ajustar layout
        if (cardResumen){
          cardResumen.style.display = 'flex';
          cardResumen.classList.remove('expandido');
        }
        layoutGrid?.classList.remove('no-resumen');
        layoutGrid?.classList.add('solo-resumen');

        // Acceso seguro evitando TDZ (ReferenceError) si recargaTodo a√∫n no est√° inicializada
        try {
          if (window.recargaTodo instanceof Function) {
            await window.recargaTodo(val);
          }
        } catch(_tdzErr) {
          console.warn('[RUN] recargaTodo no disponible todav√≠a, se omiti√≥ la recarga inicial');
        }
        

      };

      const flujoUsuarioNoExistente = (val) => {
        // Crear di√°logo de confirmaci√≥n mejorado
        const dialogHTML = `
          <div id="confirm-nuevo-usuario" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
          ">
            <div style="
              background: white;
              border-radius: 12px;
              padding: 24px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              max-width: 400px;
              width: 90%;
              text-align: center;
            ">
              <div style="
                width: 60px;
                height: 60px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                margin: 0 auto 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
              ">‚ö†Ô∏è</div>
              
              <h3 style="margin: 0 0 12px; color: #1f2937;">Usuario No Encontrado</h3>
              
              <p style="margin: 0 0 20px; color: #6b7280; line-height: 1.5;">
                El RUN <strong>${val}</strong> es v√°lido pero no existe en el sistema.
                <br><br>
                ¬øDeseas ingresar un nuevo usuario?
              </p>
              
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="btn-confirm-si" style="
                  background: #059669;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#059669'">
                  ‚úÖ S√≠, Ingresar Usuario
                </button>
                
                <button id="btn-confirmar-no" style="
                  background: #6b7280;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                  ‚ùå No, Cancelar
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Agregar animaci√≥n CSS si no existe
        if (!document.getElementById('confirm-dialog-styles')) {
          const style = document.createElement('style');
          style.id = 'confirm-dialog-styles';
          style.textContent = `
            @keyframes fadeIn {
              from { opacity: 0; transform: scale(0.9); }
              to { opacity: 1; transform: scale(1); }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.insertAdjacentHTML('beforeend', dialogHTML);
        
        const dialog = document.getElementById('confirm-nuevo-usuario');
        const btnSi = document.getElementById('btn-confirm-si');
        const btnNo = document.getElementById('btn-confirmar-no');
        
        btnSi.addEventListener('click', () => {
          dialog.remove();
          mostrarIdentificacionNuevo(val);
          const badgeNuevo = document.getElementById('badge-nuevo-usuario');
          if(badgeNuevo) badgeNuevo.style.display='inline-block';
          window._identEditadoManualmente = false;
          
          // Mostrar mensaje de ayuda para patolog√≠as
          setTimeout(() => {
            const estadoPats = document.getElementById('estado-patologias');
            if (estadoPats) {
              estadoPats.textContent = 'üí° Tip: Busca y selecciona patolog√≠as para el nuevo usuario';
              estadoPats.style.color = '#059669';
            }
          }, 500);
        });
        
        btnNo.addEventListener('click', () => {
          dialog.remove();
          if (ident) ident.style.display = 'none';
          if (cardResumen) cardResumen.style.display = 'none';
        });
        
        // Cerrar con Escape
        document.addEventListener('keydown', function handleEscape(e) {
          if (e.key === 'Escape') {
            dialog.remove();
            document.removeEventListener('keydown', handleEscape);
          }
        });
      };

      console.log('üîç [BUSCAR_RUN] Paso 4: Configurando loading manager...');
      const setLoading = createLoadingManager();
      console.log('üîç [BUSCAR_RUN] Loading manager creado:', typeof setLoading);
      
      console.log('üîç [BUSCAR_RUN] Paso 5: Activando loading...');
      setLoading(true);

      const url = `/api/tarjeton/${encodeURIComponent(val)}`;
      console.log('üîç [BUSCAR_RUN] Paso 6: URL generada para API:', url);
      console.log('üîç [BUSCAR_RUN] RUN codificado:', encodeURIComponent(val));
      
      console.log('üîç [BUSCAR_RUN] Paso 7: Iniciando petici√≥n HTTP con authFetch...');
      console.log('üîç [BUSCAR_RUN] Funci√≥n authFetch disponible:', typeof authFetch);

      try{
        const r = await authFetch(url);
        console.log('üîç [DEBUG] Response status (intento 1):', r.status, r.ok);

        if (r.status === 429) {
          const retryAfterHeader = r.headers.get('Retry-After');
          const retrySeconds = retryAfterHeader ? parseInt(retryAfterHeader, 10) : NaN;
          const esperaBase = Number.isFinite(retrySeconds) ? retrySeconds * 1000 : 4000;
          const esperaMs = Math.min(15000, esperaBase + Math.floor(Math.random() * 750));
          window.__buscarRunRateLimitHasta = Date.now() + esperaMs;
          console.warn(`üîç [DEBUG] L√≠mite de solicitudes excedido (429). Reintentando en ${esperaMs}ms`);
          mostrarEstadoBusqueda(`‚ö†Ô∏è Servidor ocupado consultando RUN. Reintentando en ${Math.ceil(esperaMs / 1000)}s...`, 'warn');
          encolarBusqueda(runParaCola, esperaMs + 200);
          return;
        }

        window.__buscarRunRateLimitHasta = 0;

  console.log('üîç [DEBUG] Response status (final):', r.status, r.ok);

  // Manejo espec√≠fico de errores HTTP
        if (r.status === 404) {
          console.log('üîç [DEBUG] Usuario no encontrado (404)');
          flujoUsuarioNoExistente(val);
          setLoading(false);
          return;
        }
        
        if (r.status >= 500) {
          console.error('üîç [DEBUG] Error del servidor:', r.status);
          alert('‚ùå Error del servidor. El sistema puede estar experimentando problemas.\n\nInt√©ntelo nuevamente en unos momentos.');
          setLoading(false);
          return;
        }

        const data = await parseJsonOrText(r);

        if (isOkData(r, data)){
          await aplicarUIUsuarioExistente(val, data);
          setLoading(false);
          return;
        }
        
        // Si llegamos aqu√≠, no hay datos v√°lidos pero tampoco error HTTP
        console.log('üîç [DEBUG] Sin datos v√°lidos, tratando como usuario no existente');
        flujoUsuarioNoExistente(val);
        
      } catch(e){
        console.error('‚ùå [BUSCAR_RUN] Error cr√≠tico capturado en buscarRun()');
        console.error('‚ùå [BUSCAR_RUN] Error completo:', e);
        console.error('‚ùå [BUSCAR_RUN] Tipo de error:', e.name);
        console.error('‚ùå [BUSCAR_RUN] Mensaje:', e.message);
        console.error('‚ùå [BUSCAR_RUN] Stack trace:', e.stack);
        
        // Manejo m√°s espec√≠fico de errores de red
        const esErrorRed = e.name === 'TypeError' && e.message.includes('fetch');
  const esTimeout = e.name === 'TimeoutError' || /timeout/i.test(e.message || '');
        if (esErrorRed || esTimeout) {
          console.error('‚ùå [BUSCAR_RUN] Error de red/timeout detectado');
          mostrarEstadoBusqueda('‚ö†Ô∏è Problema de conexi√≥n. Reintentaremos autom√°ticamente.', 'warn');
          encolarBusqueda(runParaCola, 3000);
          return;
        } else if (e.message.includes('JSON')) {
          console.error('‚ùå [BUSCAR_RUN] Error de parsing JSON detectado');
          alert('‚ö†Ô∏è Error procesando respuesta del servidor. El formato de datos no es v√°lido.');
        } else {
          console.error('‚ùå [BUSCAR_RUN] Error gen√©rico/desconocido');
          alert('‚ùå Error inesperado consultando el RUN.\n\nDetalles: ' + e.message + '\n\nInt√©ntelo nuevamente.');
        }
      } finally {
        console.log('üîç [BUSCAR_RUN] Finally block ejecutado');
        setLoading(false);
        window.__buscarRunEnCurso = false;
        procesarBusquedaPendiente();
        console.log('üîç [BUSCAR_RUN] =============================================');
      }
    }

    // === Configuraci√≥n de event listeners ===
    const setupBuscarEventListeners = () => {
      if (window.__buscarListenersOk) {
        return;
      }
      window.__buscarListenersOk = true;
      // Debug: verificar que los elementos existen
      console.log('btnBuscar encontrado:', !!btnBuscar);
      console.log('runSearch encontrado:', !!runSearch);
      
      btnBuscar?.addEventListener('click', function() {
        console.log('üîç [DEBUG] Click en bot√≥n buscar detectado');
        buscarRun();
      });
      
      runSearch?.addEventListener('keydown', e=>{ 
        if(e.key==='Enter'){ 
          e.preventDefault(); 
          buscarRun(); 
        }
      });
      
      // Debug adicional: verificar si el evento se registr√≥
      if (btnBuscar) {
        console.log('Event listener agregado al bot√≥n de b√∫squeda');
      } else {
        console.error('No se encontr√≥ el bot√≥n btn-buscar-run');
      }

      // Listener Enter directo sobre el campo principal #run
      if (runForm){
        runForm.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            e.preventDefault();
            // Sincronizar visualmente ambos campos antes de buscar
            if(runSearch && runForm.value.trim()){
              runSearch.value = runForm.value.trim();
            }
            buscarRun();
          }
        });
      }

      // Blur listener para runForm con b√∫squeda autom√°tica mejorada
      if (runForm){
        runForm.addEventListener('blur', ()=>{
          const v = runForm.value.trim();
          if(!v) return; 
          runSearch.value = v; 
          
          // Buscar autom√°ticamente si el RUN es v√°lido
          if (validarRunCl(v)) {
            buscarRun();
          }
        });
        
        // Tambi√©n buscar autom√°ticamente cuando se termine de escribir un RUN v√°lido
        let timeoutId;
        runForm.addEventListener('input', () => {
          clearTimeout(timeoutId);
          const v = runForm.value.trim();
          
          if (v && validarRunCl(v)) {
            // Esperar 1 segundo despu√©s de dejar de escribir
            timeoutId = setTimeout(() => {
              runSearch.value = v;
              buscarRun();
            }, 1000);
          }
        });
      }
    };

    setupBuscarEventListeners();
    // Bot√≥n nuevo usuario fuerza formulario vac√≠o
    const btnNuevo = document.getElementById('btn-nuevo-usuario');
    btnNuevo?.addEventListener('click', ()=>{
      if(formTarjeton){ formTarjeton.reset(); }
      if(runForm){ runForm.value=''; }
      if(cardResumen){ cardResumen.style.display='none'; cardResumen.classList.remove('expandido'); }
      if(ident){ ident.style.display='block'; }
      layoutGrid?.classList.add('no-resumen');
      layoutGrid?.classList.remove('solo-resumen');
      const nombre=document.getElementById('nombre');
      setTimeout(()=> nombre&&nombre.focus(),0);
      const badgeNuevo = document.getElementById('badge-nuevo-usuario');
      if(badgeNuevo) badgeNuevo.style.display='inline-block';
    });

    // Bot√≥n limpiar - limpia todo el formulario
    const btnLimpiar = document.getElementById('btn-limpiar');
    btnLimpiar?.addEventListener('click', ()=>{
      if(confirm('¬øEst√°s seguro de que deseas limpiar todo el formulario?')) {
        if(formTarjeton){ formTarjeton.reset(); }
        if(runForm){ runForm.value=''; }
        if(cardResumen){ cardResumen.style.display='none'; cardResumen.classList.remove('expandido'); }
        if(ident){ ident.style.display='block'; }
        layoutGrid?.classList.add('no-resumen');
        layoutGrid?.classList.remove('solo-resumen');
        
        // Limpiar campos espec√≠ficos que podr√≠an no limpiarse con reset()
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          if(input.type === 'checkbox' || input.type === 'radio') {
            input.checked = false;
          } else {
            input.value = '';
          }
        });
        
        const nombre=document.getElementById('nombre');
        setTimeout(()=> nombre&&nombre.focus(),0);
        
        console.log('Formulario limpiado completamente');
      }
    });

    // Bot√≥n MandrakeBot - abrir chat
    const btnMandrakeBot = document.getElementById('btn-mandrake-bot');
    const chatOverlay = document.getElementById('mandrake-chat-overlay'); 
    const chatClose = document.getElementById('mandrake-chat-close');
    const chatMessages = document.getElementById('mandrake-chat-messages');
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    // Debug: verificar que los elementos existen
    console.log('MandrakeBot elements:', {
      btnMandrakeBot: !!btnMandrakeBot,
      chatOverlay: !!chatOverlay,
      chatClose: !!chatClose,
      chatMessages: !!chatMessages,
      chatInput: !!chatInput,
      chatSend: !!chatSend
    });
    
    let isMandrakeActive = false;
    
    // Funci√≥n para agregar mensaje al chat
    function addChatMessage(content, type = 'bot', isHtml = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `mandrake-message ${type}`;
      
      if (isHtml) {
        messageDiv.innerHTML = content;
      } else {
        messageDiv.textContent = content;
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return messageDiv;
    }
    
    // Funci√≥n para mostrar indicador de escritura
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'mandrake-typing';
      typingDiv.innerHTML = `
        <span style="font-size:12px;">MandrakeBot est√° escribiendo</span>
        <div class="mandrake-typing-dots">
          <div class="mandrake-typing-dot"></div>
          <div class="mandrake-typing-dot"></div>
          <div class="mandrake-typing-dot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return typingDiv;
    }
    
    // Funci√≥n para llamar a la IA
    async function callMandrakeAI(userMessage) {
      try {
        const response = await fetch('/api/ai/fill-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: userMessage,
            instruction: `Eres MandrakeBot, un asistente m√©dico inteligente especializado en ECICEP. 
                         Responde de manera profesional, emp√°tica y √∫til. 
                         Si la consulta es m√©dica, proporciona informaci√≥n educativa pero recuerda que no reemplazas el criterio m√©dico profesional.
                         Si pueden ayudar con el formulario actual, ofrece autocompletarlo.
                         Mant√©n respuestas concisas pero completas.`,
            schema: {
              type: "object",
              properties: {
                response: {
                  type: "string",
                  description: "Respuesta del asistente m√©dico"
                },
                suggestions: {
                  type: "array",
                  items: { type: "string" },
                  description: "Sugerencias de seguimiento opcional"
                },
                form_help: {
                  type: "boolean", 
                  description: "Si puede ayudar con el formulario actual"
                }
              }
            }
          })
        });
        
        const result = await response.json();
        
        if (result.ok && result.data) {
          return {
            response: result.data.response || 'Lo siento, no pude procesar tu consulta.',
            suggestions: result.data.suggestions || [],
            form_help: result.data.form_help || false
          };
        } else {
          throw new Error(result._error || 'Error en la respuesta de IA');
        }
      } catch (error) {
        console.error('Error llamando a MandrakeBot:', error);
        return {
          response: 'Lo siento, hay un problema de conexi√≥n. Por favor intenta nuevamente.',
          suggestions: [],
          form_help: false
        };
      }
    }
    
    // Funci√≥n para enviar mensaje
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Agregar mensaje del usuario
      addChatMessage(message, 'user');
      chatInput.value = '';
      chatSend.disabled = true;
      
      // Mostrar indicador de escritura
      const typingIndicator = showTypingIndicator();
      
      // Llamar a la IA
      const aiResponse = await callMandrakeAI(message);
      
      // Remover indicador de escritura
      typingIndicator.remove();
      
      // Agregar respuesta del bot
      let botMessage = aiResponse.response;
      
      // Agregar sugerencias si las hay
      if (aiResponse.suggestions && aiResponse.suggestions.length > 0) {
        botMessage += '\n\nüí° Sugerencias:\n' + aiResponse.suggestions.map(s => `‚Ä¢ ${s}`).join('\n');
      }
      
      // Agregar ayuda con formulario si corresponde
      if (aiResponse.form_help) {
        botMessage += '\n\nüìù ¬øTe gustar√≠a que te ayude a completar alg√∫n campo del formulario actual?';
      }
      
      addChatMessage(botMessage, 'bot');
      chatSend.disabled = false;
      chatInput.focus();
    }
    
    // Event listeners del chat
    if (btnMandrakeBot) {
      btnMandrakeBot.addEventListener('click', () => {
        console.log('MandrakeBot button clicked!');
        if (!chatOverlay) {
          console.error('Chat overlay not found!');
          return;
        }
        chatOverlay.style.display = 'flex';
        isMandrakeActive = true;
        if (chatInput) chatInput.focus();
      
      // Mensaje de bienvenida contextual
      if (chatMessages.children.length === 1) { // Solo mensaje inicial
        const runValue = document.getElementById('run')?.value || '';
        if (runValue) {
          addChatMessage(`Veo que est√°s trabajando con el RUN ${runValue}. ¬øEn qu√© puedo ayudarte con este paciente?`, 'system');
        }
      }
    });
    
    chatClose?.addEventListener('click', () => {
      chatOverlay.style.display = 'none';
      isMandrakeActive = false;
    });
    
    chatOverlay?.addEventListener('click', (e) => {
      if (e.target === chatOverlay) {
        chatOverlay.style.display = 'none';
        isMandrakeActive = false;
      }
    });
    
    chatSend?.addEventListener('click', sendMessage);
    
    chatInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + M para abrir/cerrar MandrakeBot
      if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        if (isMandrakeActive) {
          chatOverlay.style.display = 'none';
          isMandrakeActive = false;
        } else {
          btnMandrakeBot?.click();
        }
      }
      
      // Escape para cerrar chat
      if (e.key === 'Escape' && isMandrakeActive) {
        chatOverlay.style.display = 'none';
        isMandrakeActive = false;
      }
    });
    } else {
      console.error('MandrakeBot button not found!');
    }

  });
  // (Listeners antiguos de cargarDatos y debounce eliminados)

  // Funci√≥n global para abrir MandrakeBot (respaldo)
  function openMandrakeBot() {
    console.log('openMandrakeBot() called');
    const chatOverlay = document.getElementById('mandrake-chat-overlay');
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatClose = document.getElementById('mandrake-chat-close');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    if (chatOverlay) {
      chatOverlay.style.display = 'flex';
      if (chatInput) chatInput.focus();
      
      // Configurar event listeners si no est√°n configurados
      if (chatClose && !chatClose.onclick) {
        chatClose.onclick = () => {
          chatOverlay.style.display = 'none';
        };
      }
      
      if (chatSend && !chatSend.onclick) {
        chatSend.onclick = () => {
          sendMandrakeMessage();
        };
      }
      
      if (chatInput && !chatInput.onkeypress) {
        chatInput.onkeypress = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMandrakeMessage();
          }
        };
      }
      
      // Event listener para cerrar con click fuera
      chatOverlay.onclick = (e) => {
        if (e.target === chatOverlay) {
          chatOverlay.style.display = 'none';
        }
      };
      
      // Mensaje de bienvenida contextual
      const chatMessages = document.getElementById('mandrake-chat-messages');
      if (chatMessages && chatMessages.children.length === 1) {
        const runValue = document.getElementById('run')?.value || '';
        if (runValue) {
          const systemMsg = document.createElement('div');
          systemMsg.className = 'mandrake-message system';
          systemMsg.textContent = `Veo que est√°s trabajando con el RUN ${runValue}. ¬øEn qu√© puedo ayudarte con este paciente?`;
          chatMessages.appendChild(systemMsg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
    } else {
      console.error('Chat overlay not found!');
    }
  }
  
  // Funci√≥n para enviar mensaje
  async function sendMandrakeMessage() {
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatMessages = document.getElementById('mandrake-chat-messages');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Agregar mensaje del usuario
    const userMsg = document.createElement('div');
    userMsg.className = 'mandrake-message user';
    userMsg.textContent = message;
    chatMessages.appendChild(userMsg);
    
    chatInput.value = '';
    chatSend.disabled = true;
    
    // Mostrar indicador de escritura
    const typingDiv = document.createElement('div');
    typingDiv.className = 'mandrake-typing';
    typingDiv.innerHTML = `
      <span style="font-size:12px;">MandrakeBot est√° escribiendo</span>
      <div class="mandrake-typing-dots">
        <div class="mandrake-typing-dot"></div>
        <div class="mandrake-typing-dot"></div>
        <div class="mandrake-typing-dot"></div>
      </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    try {
      // Llamar a la IA
      const response = await fetch('/api/ai/fill-form', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: message,
          instruction: `Eres MandrakeBot, un asistente m√©dico inteligente especializado en ECICEP. 
                       Responde de manera profesional, emp√°tica y √∫til. 
                       Si la consulta es m√©dica, proporciona informaci√≥n educativa pero recuerda que no reemplazas el criterio m√©dico profesional.
                       Si pueden ayudar con el formulario actual, ofrece autocompletarlo.
                       Mant√©n respuestas concisas pero completas.`,
          schema: {
            type: "object",
            properties: {
              response: {
                type: "string",
                description: "Respuesta del asistente m√©dico"
              }
            }
          }
        })
      });
      
      const result = await response.json();
      
      // Remover indicador de escritura
      typingDiv.remove();
      
      // Agregar respuesta del bot
      const botMsg = document.createElement('div');
      botMsg.className = 'mandrake-message bot';
      botMsg.textContent = result.ok && result.data ? 
        result.data.response || 'Lo siento, no pude procesar tu consulta.' :
        'Lo siento, hay un problema de conexi√≥n. Por favor intenta nuevamente.';
      
      chatMessages.appendChild(botMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
    } catch (error) {
      console.error('Error llamando a MandrakeBot:', error);
      typingDiv.remove();
      
      const errorMsg = document.createElement('div');
      errorMsg.className = 'mandrake-message bot';
      errorMsg.textContent = 'Lo siento, hay un problema de conexi√≥n. Por favor intenta nuevamente.';
      chatMessages.appendChild(errorMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    chatSend.disabled = false;
    chatInput.focus();
  }
  
  // Hacer la funci√≥n global para que sea accesible desde los event listeners
  window.sendMandrakeMessage = sendMandrakeMessage;

  const CUMPLIMIENTO_LABELS = {
    "inicio de acuerdos consensuados": "Inicio de acuerdos consensuados",
    cumple: "Cumple",
    "cumple parcialmente": "Cumple parcialmente",
    "no cumple": "No cumple",
  };

  function formatearCumplimiento(valor){
    if(!valor) return '‚Äî';
    const key = valor.toString().trim().toLowerCase();
    return CUMPLIMIENTO_LABELS[key] || valor;
  }

  async function cargarUltimoControl(runVal){
    if(!runVal) return;
    const limpio = runVal.replace(/[^0-9kK]/g,'');
    if(limpio.length < 7) return;
    try{
      const r = await authFetch(`/api/control/ultimo/${encodeURIComponent(runVal)}`);
      const d = await r.json();
      const panel = document.getElementById('panel-control');
      if(!panel) return;
  const ok = (typeof d.ok !== 'undefined') ? d.ok : (typeof d.success !== 'undefined' ? d.success : !!d.control);
  window.__ultimoControl = null;
      if(!ok){ panel.innerHTML='<div style="color:#b91c1c">Error cargando control</div>'; console.warn('Ultimo control respuesta inesperada', d); return; }
      if(!d.control){ panel.innerHTML='<div style="opacity:.6;">Sin control registrado.</div>'; return; }
      const c = normalizarRegistroControl(d.control);
      window.__ultimoControl = c;
      try {
        window.dispatchEvent(new CustomEvent('riesgo-cv:refrescar-control', { detail: c }));
      } catch (err) {
        console.warn('[RIESGO-CV] No se pudo emitir refrescar-control', err);
      }
      const fechaFmt = formatearFechaCorta(c.fecha);
      const { bg: imcBgRaw, color: imcColorRaw } = obtenerColoresIMC(c.imc_clasificacion);
      const { bg: htaBgRaw, color: htaColorRaw } = obtenerColoresHTA(c.hta_clasificacion);
      const badgeBase = 'display:inline-block;padding:2px 10px;border-radius:999px;font-size:.75rem;font-weight:600;';
      const imcBg = imcBgRaw || 'rgba(100, 116, 139, 0.35)';
      const imcColor = imcColorRaw || '#fff';
      const htaBg = htaBgRaw || 'rgba(100, 116, 139, 0.35)';
      const htaColor = htaColorRaw || '#fff';
      const imcTexto = formatearIMCControl(c.imc);
      panel.innerHTML = `
        <div><strong>Fecha:</strong> ${fechaFmt} <strong style="margin-left:8px;">Profesional:</strong> ${c.profesional||'‚Äî'}</div>
        <div><strong>Peso:</strong> ${c.peso??'‚Äî'} kg <strong style="margin-left:8px;">Talla:</strong> ${c.talla??'‚Äî'} <strong style="margin-left:8px;">IMC:</strong> ${imcTexto} <span class="badge-riesgo" style="${badgeBase}background:${imcBg};color:${imcColor};">${c.imc_clasificacion||'‚Äî'}</span></div>
        <div><strong>PA:</strong> ${c.presion_sistolica??'‚Äî'}/${c.presion_diastolica??'‚Äî'} mmHg <span class="badge-riesgo" style="${badgeBase}background:${htaBg};color:${htaColor};">${c.hta_clasificacion||'‚Äî'}</span></div>
        <div><strong>CC:</strong> ${c.cc??'‚Äî'} <strong style="margin-left:8px;">HGT:</strong> ${c.hgt??'‚Äî'} <strong style="margin-left:8px;">HbA1c:</strong> ${c.hba1c??'‚Äî'}</div>
      `;
    }catch(e){ console.warn('Error control', e); }
  }
  // recargaTodo movido al final despu√©s de todas las definiciones de funciones
  // (Listeners vinculados a recargaTodo en input RUN eliminados; flujo centralizado en toolbar)

  // Cargar √∫ltimo examen pie diab√©tico
  async function cargarUltimoExamenPieDiabetico(runVal){
    try {
      // Por ahora solo log, ya que no hay endpoint espec√≠fico disponible
      console.log('[ü¶∂ Pie Diab√©tico] Funci√≥n de carga llamada para:', runVal);
      // TODO: Implementar cuando est√© disponible el endpoint /api/examenes-piedm/ultimo/
    } catch(e) {
      console.warn('[ü¶∂ Pie Diab√©tico] Error cargando √∫ltimo examen pie diab√©tico:', e);
    }
  }

  // Cargar √∫ltima curaci√≥n
  async function cargarUltimaCuracion(runVal){
    try {
      const r = await authFetch(`/api/curaciones-piedm/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[ü©π Curaciones] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de curaciones
        const curacion = data.data;
        console.log('[ü©π Curaciones] √öltima curaci√≥n cargada:', curacion);
        
        // Actualizar formulario si existe
        const tipoSelect = document.getElementById('tipoCuracion');
        const fechaInput = document.getElementById('fechaCuracion');
        
        if (tipoSelect && curacion.tipo_curacion) {
          tipoSelect.value = curacion.tipo_curacion;
        }
        if (fechaInput && curacion.fecha) {
          fechaInput.value = curacion.fecha;
        }
      } else {
        console.log('[ü©π Curaciones] No hay datos de curaciones para este usuario');
      }
    } catch(e) {
      console.log('[ü©π Curaciones] Funci√≥n ejecutada (sin datos disponibles)');
    }
  }

  // Cargar √∫ltima hipoglicemia
  async function cargarUltimaHipoglicemia(runVal){
    try {
      const r = await authFetch(`/api/diabetes/hipoglicemias/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[ü©∏ Hipoglicemias] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de hipoglicemias
        const hipoglicemia = data.data;
        console.log('[ü©∏ Hipoglicemias] √öltima hipoglicemia cargada:', hipoglicemia);
        
        // Actualizar formulario si existe
        const siRadio = document.getElementById('hipoglicemiasSi');
        const noRadio = document.getElementById('hipoglicemiasNo');
        const fechaInput = document.getElementById('fechaHipoglicemias');
        
        if (hipoglicemia.recurrente === true && siRadio) {
          siRadio.checked = true;
        } else if (hipoglicemia.recurrente === false && noRadio) {
          noRadio.checked = true;
        }
        
        if (fechaInput && hipoglicemia.fecha) {
          fechaInput.value = hipoglicemia.fecha;
        }
      } else {
        console.log('[ü©∏ Hipoglicemias] No hay datos de hipoglicemias para este usuario');
      }
    } catch(e) {
      console.log('[ü©∏ Hipoglicemias] Funci√≥n ejecutada (sin datos disponibles)');
    }
  }

  // Cargar √∫ltima amputaci√≥n
  async function cargarUltimaAmputacion(runVal){
    try {
      const r = await authFetch(`/api/examenes/pie_dm/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[ü¶ø Amputaci√≥n] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de amputaci√≥n
        const amputacion = data.data;
        console.log('[ü¶ø Amputaci√≥n] √öltima amputaci√≥n cargada:', amputacion);
        
        // Actualizar formulario si existe
        const fechaInput = document.getElementById('fechaAmputacion');
        
        if (fechaInput && amputacion.fecha_amputacion) {
          fechaInput.value = amputacion.fecha_amputacion;
        }
      } else {
        console.log('[ü¶ø Amputaci√≥n] No hay datos de amputaci√≥n para este usuario');
      }
    } catch(e) {
      console.log('[ü¶ø Amputaci√≥n] Funci√≥n ejecutada (sin datos disponibles)');
    }
  }

  // Cargar sectores
  async function cargarSectores(){
    try{
      const r = await authFetch('/api/sectores');
      if(!r.ok) return; const d = await r.json(); if(!d.ok) return;
      const sel = document.getElementById('sector_id');
      if(!sel) return; const cur = sel.value;
      sel.innerHTML = '<option value="">-- Sector --</option>' + d.sectores.map(s=>`<option value="${s.id}">${s.nombre}</option>`).join('');
      if(cur) sel.value = cur; // mantener si ya hab√≠a
    }catch(e){ console.warn('No se pudieron cargar sectores', e); }
  }
  cargarSectores();

  // Formulario nuevo control
  const formControl = document.getElementById('form-control-nuevo');
  if(formControl){
    const tallaInput = formControl.querySelector('#input-talla');
    const pesoInput = formControl.querySelector('[name="peso"]');
    function normalizarTalla(){
      if(!tallaInput) return; const raw=tallaInput.value.trim(); if(!raw) return; let num=parseFloat(raw.replace(',','.'));
      if(isNaN(num)) return; if(num>0 && num<3){ num = num*100; tallaInput.value = num.toFixed(2); }
  window.computeIMC && window.computeIMC();
    }
    if(tallaInput){ tallaInput.addEventListener('blur', normalizarTalla); tallaInput.addEventListener('change', normalizarTalla); }
    if(pesoInput){ pesoInput.addEventListener('blur', computeIMC); pesoInput.addEventListener('change', computeIMC); }
    formControl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const estado = document.getElementById('estado-control');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal){ estado.textContent='RUN requerido'; estado.style.color='#b91c1c'; return; }
      estado.textContent='Guardando...'; estado.style.color='#334155';
      const fd = new FormData(formControl);
      const payload = { run: runVal };
      ['fecha','profesional','peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{
        const v = fd.get(k);
        if(v!==null && v!=='' ) payload[k]=v;
      });
      try{
        const r = await authFetch('/api/control',{method:'POST',body:JSON.stringify(payload)});
        const d = await r.json();
        if(!r.ok || !d.ok){ estado.textContent='Error'; estado.style.color='#b91c1c'; return; }
        estado.textContent='Guardado ‚úî'; estado.style.color='#065f46';
        // limpiar campos excepto fecha/profesional
        ['peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{ formControl.querySelector(`[name="${k}"]`).value=''; });
        cargarUltimoControl(runVal);
      }catch(err){ estado.textContent='Error red'; estado.style.color='#b91c1c'; }
    });
  }

  // Formulario nuevo acuerdo
  const formAcuerdo = document.getElementById('form-acuerdo-nuevo');
  if(formAcuerdo){
    // Establecer fecha actual por defecto
    const fechaInput = document.getElementById('acuerdo_fecha');
    if(fechaInput && !fechaInput.value){
      const hoy = new Date();
      fechaInput.value = hoy.toISOString().split('T')[0];
    }
    
    formAcuerdo.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const estado = document.getElementById('estado-acuerdo');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal){ 
        estado.textContent='RUN requerido'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      
      const fd = new FormData(formAcuerdo);
  const acuerdos = fd.get('acuerdos')?.trim();
  const cumplimiento = fd.get('cumplimiento')?.trim();
      
      if(!acuerdos){ 
        estado.textContent='Acuerdos requeridos'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      if(!cumplimiento){ 
        estado.textContent='Cumplimiento requerido'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      
      estado.textContent='Guardando...'; 
      estado.style.color='#334155';
      
      const payload = {
        usuario_id: runVal,
        acuerdos: acuerdos,
        cumplimiento: cumplimiento,
        observaciones: fd.get('observaciones')?.trim() || null,
        funcionario: fd.get('funcionario')?.trim() || null,
        fecha_creacion: fd.get('fecha') || null
      };
      
      try{
        const r = await fetch('/api/acuerdos',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const d = await r.json();
        if(!r.ok || !d.ok){ 
          estado.textContent='Error: ' + (d.error || 'Desconocido'); 
          estado.style.color='#b91c1c'; 
          return; 
        }
        estado.textContent='Guardado ‚úî'; 
        estado.style.color='#065f46';
        
        // Limpiar formulario excepto fecha y profesional
        ['acuerdos','observaciones'].forEach(k=>{ 
          const el = formAcuerdo.querySelector(`[name="${k}"]`); 
          if(el) el.value=''; 
        });
        formAcuerdo.querySelector('[name="cumplimiento"]').value = '';
        
        // Recargar hist√≥rico de acuerdos
        cargarHistoricoAcuerdos(runVal);
        
        setTimeout(()=>{
          estado.textContent = '';
        }, 3000);
        
      }catch(err){ 
        console.error('Error guardando acuerdo:', err);
        estado.textContent='Error de red'; 
        estado.style.color='#b91c1c'; 
      }
    });
  }

  // ================= LABS =================
  async function cargarLabs(runVal){
    if(!runVal) return;
    const limpio = runVal.replace(/[^0-9kK]/g,'');
    if(limpio.length < 7) return;
    const cont = document.getElementById('panel-examenes');
    const tabla = document.getElementById('tabla-labs');
    const tbody = tabla.querySelector('tbody');
    if(cont){ cont.querySelector('div[style*="opacity"]')?.remove(); }
    try{
      const r = await authFetch(`/api/examenes/labs/${encodeURIComponent(runVal)}`);
      const j = await r.json();
      if(!r.ok || !j.ok){
        window.__labsRecientes = null;
        tbody.innerHTML = `<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error obteniendo labs (${j.error||r.status})</td></tr>`;
        tabla.style.display='table';
        return;
      }
      const labs = j.labs || {};
      window.__labsRecientes = labs;
      try {
        window.dispatchEvent(new CustomEvent('riesgo-cv:refrescar-labs', { detail: labs }));
      } catch (err) {
        console.warn('[RIESGO-CV] No se pudo emitir refrescar-labs', err);
      }
      const orden = [
        ['glicemia','Glicemia'],
        ['hba1c','HbA1c'],
        ['ldl','LDL'],
        ['hdl','HDL'],
        ['col','Col Total'],
        ['tag','Triglic√©ridos'],
        ['creatinemia','Creatinina'],
        ['vfg','VFG'],
        ['rac','RAC'],
        ['microalbuminuria','Microalbuminuria'],
        ['tsh','TSH'],
        ['rpr','RPR'],
        ['baciloscopia','Baciloscopia'],
        ['tos','Tos']
      ];
      const rows = [];
      orden.forEach(([k,label])=>{
        if(!labs[k]) return; // s√≥lo mostrar presentes
        const reg = labs[k] || {};
        let valorTxt = '';
        if(k==='microalbuminuria'){
          // Puede venir valor, valor_cuant, positiva
            if(reg.valor_cuant!=null) valorTxt = reg.valor_cuant;
            else if(reg.valor!=null) valorTxt = reg.valor;
            if(reg.positiva===true) valorTxt = (valorTxt? valorTxt+' / ' : '') + 'Positiva';
            else if(reg.positiva===false) valorTxt = (valorTxt? valorTxt+' / ' : '') + 'Negativa';
        } else if(reg.valor!=null){
          valorTxt = reg.valor;
        }
        const anot = [];
        if(reg.alerta) anot.push(reg.alerta);
        if(k==='vfg' && reg.erc_estadio) anot.push(reg.erc_estadio);
        const fecha = reg.fecha || '';
        rows.push(`<tr><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${label}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${valorTxt||'‚Äî'}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${fecha||'‚Äî'}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${anot.join(' ‚Ä¢ ')}</td></tr>`);
      });
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos de laboratorio</td></tr>';
      } else {
        tbody.innerHTML = rows.join('');
      }
      tabla.style.display='table';
      // Cargar hist√≥rico en paralelo (no bloquear)
      cargarHistoricoLabs(runVal);
    }catch(e){
      console.error('[üìä Labs] Error', e);
      window.__labsRecientes = null;
      tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error de red labs</td></tr>';
      tabla.style.display='table';
    }
  }

  async function cargarHistoricoLabs(runVal){
    try{
      console.log('[HIST-LABS] Iniciando carga para RUN:', runVal);
      const r = await authFetch(`/api/examenes/labs/historico/${encodeURIComponent(runVal)}?limit=60`);
      console.log('[HIST-LABS] Response status:', r.status, r.ok);
      const j = await r.json();
      console.log('[HIST-LABS] Response data:', j);
      if(!r.ok || !j.ok){ 
        console.warn('[HIST-LABS] Response not OK:', r.ok, j.ok);
        return; 
      }
      const rawData = j.historico || j.registros || j.data || [];
      console.log('[HIST-LABS] Raw data length:', rawData.length);
      _histLabsRaw = rawData.map(x=>{
        const fechaPrincipal = x.examen_fecha || x.fecha_realizacion || x.fecha || x.created_at || null;
        const fechaSec = x.fecha_realizacion || x.fecha || null;

        const microValor = x.microalbuminuria_val ?? x.microalbuminuria_valor ?? x.microalbuminuria_cuant ?? null;
        const microTexto = x.microalbuminuria_descripcion ?? x.microalbuminuria ?? x.microalbuminuria_resultado ?? '';
        let microPos = x.microalbuminuria_positiva;
        if(typeof microPos === 'string'){
          microPos = /^(1|true|positiva|pos)/i.test(microPos);
        }
        if(typeof microPos !== 'boolean'){
          if(typeof microTexto === 'string'){
            const txt = microTexto.toLowerCase();
            if(/pos/.test(txt)) microPos = true;
            else if(/neg/.test(txt)) microPos = false;
          }
        }

        return {
          examen_fecha: fechaPrincipal,
          fecha_realizacion: fechaSec,
          fecha: fechaPrincipal,
          glicemia: x.glicemia ?? x.valor_glicemia ?? null,
          hba1c: x.hba1c ?? x.valor_hba1c ?? null,
          ldl: x.ldl ?? x.valor_ldl ?? null,
          hdl: x.hdl ?? x.valor_hdl ?? null,
          col: x.col ?? x.colesterol_total ?? null,
          tag: x.tag ?? x.trigliceridos ?? null,
          creatinemia: x.creatinemia ?? x.creatinina ?? null,
          vfg: x.vfg ?? x.valor_vfg ?? null,
          erc: x.erc_estadio ?? x.erc ?? null,
          rac: x.rac ?? x.albuminuria_creatinina ?? null,
          microalbuminuria: microTexto,
          microalbuminuria_val: microValor,
          microalbuminuria_positiva: typeof microPos === 'boolean' ? microPos : null,
          tsh: x.tsh ?? x.valor_tsh ?? null
        };
      }).filter(filaLabTieneDatos);
      console.log('[HIST-LABS] Processed data length:', _histLabsRaw.length);
      renderHistoricoLabs('all');
      console.log('[HIST-LABS] Render completed');
      try {
        window.dispatchEvent(new CustomEvent('riesgo-cv:refrescar-labs', { detail: _histLabsRaw }));
      } catch (err) {
        console.warn('[HIST-LABS] Evento refrescar-labs fall√≥', err);
      }
    }catch(e){ 
      console.error('[HIST-LABS] Error:', e); 
      const tbody = document.getElementById('hist-labs-tbody');
      if(tbody) {
        tbody.innerHTML='<tr><td colspan="14" style="padding:6px;color:#b91c1c;">Error cargando hist√≥rico: ' + e.message + '</td></tr>';
      }
    }
  }

  function renderHistoricoLabs(scope){
    const meses = scope === '12m' ? 12 : scope === '6m' ? 6 : null;
    aplicarFiltrosYRenderLabs(meses);
  }

  // Listeners filtros historico labs (solo una vez)
  document.querySelectorAll('[data-filtro-labs]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-filtro-labs');
      renderHistoricoLabs(key);
    }, { once:false });
  });

  // ================= HIST√ìRICOS =================
  // Toggles gen√©ricos
  document.querySelectorAll('[data-toggle]').forEach(tg=>{
    tg.addEventListener('click', ()=>{
      const key = tg.getAttribute('data-toggle');
      const body = document.querySelector(`[data-body="${key}"]`);
      const icon = document.querySelector(`[data-icon="${key}"]`);
      if(!body) return;
      const visible = body.style.display!=='none';
      body.style.display = visible? 'none':'block';
      if(icon) icon.textContent = visible? '‚ñº':'‚ñ≤';
    });
  });

  // Arrays originales para filtros y tendencias
  let _histControlRaw = [];
  let _histLabsRaw = [];
  let _controlCharts = {};
  const _controlChartsPlugins = { annotation: false, zoom: false };
  let _controlChartsAwaitingPromise = null;
  let _controlChartsAwaitingRows = null;
  let _controlChartsDocClickBound = false;

  function _chartInteractiveNode(canvas){
    if(!canvas) return null;
    return canvas.closest('[data-role="chart-area"]') || canvas;
  }

  function _chartCardNode(canvas){
    if(!canvas) return null;
    return canvas.closest('[data-chart-card]') || null;
  }

  function setChartCardZoom(card, zoomed){
    if(!card) return;
    const key = card.getAttribute('data-chart-key');
    const chart = key ? _controlCharts[key] : null;
    const canvas = chart?.canvas || null;
    const interactive = _chartInteractiveNode(canvas) || card;
    card.setAttribute('data-zoomed', zoomed ? '1' : '0');
    const boxShadow = zoomed ? '0 0 0 2px rgba(37, 99, 235, 0.35)' : '';
    const cursorZoom = zoomed ? 'zoom-out' : 'zoom-in';
    interactive.style.cursor = cursorZoom;
    interactive.style.boxShadow = boxShadow;
    if(canvas && canvas !== interactive){
      canvas.style.cursor = cursorZoom;
      canvas.style.boxShadow = boxShadow;
    }
    if(chart && typeof chart.resize === 'function'){
      requestAnimationFrame(() => chart.resize());
    }
  }

  function collapseAllChartCards(exceptCard){
    document.querySelectorAll('#control-charts [data-chart-card]').forEach((card) => {
      if(exceptCard && card === exceptCard) return;
      if(card.getAttribute('data-zoomed') !== '1') return;
      setChartCardZoom(card, false);
    });
  }

  function handleChartCardClick(event){
    console.log('[CONTROL-CHARTS] click detectado', {
      phase: event.eventPhase,
      target: event.target && event.target.id,
      currentTarget: event.currentTarget && event.currentTarget.id
    });
    if(event.eventPhase !== Event.CAPTURING_PHASE){
      event.stopPropagation();
    }
    if(event._controlChartHandled) return;
    event._controlChartHandled = true;
    const current = event.currentTarget;
    let card = current;
    if(card && typeof card.closest === 'function'){
      const located = card.closest('[data-chart-card]');
      if(located) card = located;
    }
    if(!card || !card.hasAttribute('data-chart-card')) return;
    const isZoomed = card.getAttribute('data-zoomed') === '1';
    if(isZoomed){
      setChartCardZoom(card, false);
    } else {
      collapseAllChartCards(card);
      setChartCardZoom(card, true);
    }
  }

  function bindChartCardZoom(key, canvas){
    const card = _chartCardNode(canvas);
    if(!card) return;
    const interactive = _chartInteractiveNode(canvas);
    card.setAttribute('data-chart-key', key);
    if(card._chartZoomBound) return;
    const handler = handleChartCardClick;
    const listeners = [
      { node: card, capture: true },
      { node: card, capture: false },
      { node: interactive, capture: true },
      { node: canvas, capture: true }
    ];
    const boundListeners = [];
    listeners.forEach(({ node, capture }) => {
      if(!node) return;
      node.addEventListener('click', handler, { capture });
      boundListeners.push({ node, capture });
    });
    console.log('[CONTROL-CHARTS] zoom enlazado', key, boundListeners.map(({ node, capture }) => ({
      node: node && (node.id || node.tagName || 'node'),
      capture
    })));
    card._chartZoomBound = true;
    card._chartZoomHandler = handler;
    card._chartZoomListeners = boundListeners;
    setChartCardZoom(card, false);
    if(!_controlChartsDocClickBound){
      document.addEventListener('click', (evt) => {
        if(evt.target.closest('#control-charts [data-chart-card]')) return;
        collapseAllChartCards();
      });
      _controlChartsDocClickBound = true;
    }
  }

  function cloneChartDataItem(value){
    if(value === null || value === undefined) return value;
    if(Array.isArray(value)) return value.map(cloneChartDataItem);
    if(typeof value === 'object') return { ...value };
    return value;
  }

  function cloneChartDataArray(data){
    if(!Array.isArray(data)) return [];
    return data.map(cloneChartDataItem);
  }

  function isFiniteNumber(value){
    return typeof value === 'number' && Number.isFinite(value);
  }

  function parseFechaControl(raw){
    if(!raw) return null;
    if(raw instanceof Date){
      return Number.isNaN(raw.getTime()) ? null : raw;
    }
    const txt = raw.toString().trim();
    if(!txt || txt === '‚Äî' || txt === '-') return null;
    let match = txt.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})/);
    if(match){
      const [,y,m,d] = match;
      const dt = new Date(`${y}-${m}-${d}`);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }
    match = txt.match(/^(\d{2})[\/-](\d{2})[\/-](\d{4})/);
    if(match){
      const [,d,m,y] = match;
      const dt = new Date(`${y}-${m}-${d}`);
      return Number.isNaN(dt.getTime()) ? null : dt;
    }
    const parsed = new Date(txt);
    if(!Number.isNaN(parsed.getTime())) return parsed;
    if(typeof parseFechaFlexible === 'function'){
      const flexible = parseFechaFlexible(txt);
      if(flexible) return flexible;
    }
    return null;
  }

  function ensureControlChartsPlugins(){
    if(typeof Chart === 'undefined') return;
    try {
      if(!_controlChartsPlugins.annotation){
        const annotation = window['chartjs-plugin-annotation'] || annotationPlugin || ChartAnnotation;
        if(annotation){
          Chart.register(annotation.default || annotation);
          _controlChartsPlugins.annotation = true;
          console.log('[CONTROL-CHARTS] Plugin de anotaciones listo.');
        }
      }
    } catch(err){
      console.warn('[CONTROL-CHARTS] No se pudo registrar plugin de anotaciones:', err);
    }

    try {
      if(!_controlChartsPlugins.zoom){
        const zoomPlugin = window['chartjs-plugin-zoom'] || window.ChartZoom || window.ChartjsPluginZoom || window.chartjsPluginZoom;
        if(zoomPlugin){
          Chart.register(zoomPlugin.default || zoomPlugin);
          _controlChartsPlugins.zoom = true;
          console.log('[CONTROL-CHARTS] Plugin de zoom listo.');
        }
      }
    } catch(err){
      console.warn('[CONTROL-CHARTS] No se pudo registrar plugin de zoom:', err);
    }
  }

  function destroyControlChart(key){
    const chart = _controlCharts[key];
    if(!chart) return;
    const canvas = chart.canvas;
    const card = _chartCardNode(canvas);
    if(card){
      if(card._chartZoomBound){
        const listeners = Array.isArray(card._chartZoomListeners) ? card._chartZoomListeners : [];
        listeners.forEach((listener) => {
          const node = listener?.node;
          if(!node) return;
          const capture = !!listener?.capture;
          try {
            node.removeEventListener('click', card._chartZoomHandler, { capture });
          } catch(_){ }
        });
        delete card._chartZoomListeners;
        delete card._chartZoomHandler;
        delete card._chartZoomBound;
      }
      card.setAttribute('data-zoomed', '0');
      delete card.dataset.chartKey;
    }
    const interactiveNode = _chartInteractiveNode(canvas);
    const nodesToReset = new Set([canvas, interactiveNode, card].filter(Boolean));
    nodesToReset.forEach((node) => {
      if(!node || !node.style) return;
      node.style.cursor = '';
      node.style.boxShadow = '';
    });
    try {
      chart.destroy();
    } catch(_){ }
    delete _controlCharts[key];
  }


  function ensureControlChartsStyles(){
    if(document.getElementById('control-charts-zoom-style')) return;
    const style = document.createElement('style');
    style.id = 'control-charts-zoom-style';
    style.textContent = `
      #control-charts [data-chart-card] {
        position: relative;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }
      #control-charts [data-chart-card][data-zoomed="0"] canvas,
      #control-charts [data-chart-card] canvas {
        cursor: zoom-in;
        transition: box-shadow 0.25s ease;
      }
      #control-charts [data-chart-card][data-zoomed="1"] {
        z-index: 20;
        grid-column: 1 / -1;
        transform: scale(1.02);
      }
      #control-charts [data-chart-card][data-zoomed="1"] [data-role="chart-area"] {
        height: 660px !important;
      }
      #control-charts [data-chart-card][data-zoomed="1"] canvas {
        cursor: zoom-out !important;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.35);
      }
      @media (max-width: 768px) {
        #control-charts [data-chart-card][data-zoomed="1"] {
          transform: scale(1);
        }
        #control-charts [data-chart-card][data-zoomed="1"] [data-role="chart-area"] {
          height: 420px !important;
        }
      }
    `;
    document.head.appendChild(style);
  }

  function getControlChartsCommonOpts(){
    return {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      spanGaps: true,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        x: { ticks: { autoSkip: true, maxRotation: 0 } },
        y: { beginAtZero: false }
      },
      plugins: {
        zoom: {
          zoom: {
            wheel: { enabled: true, speed: 0.1 },
            pinch: { enabled: true },
            drag: { enabled: true },
            mode: 'xy'
          },
          pan: {
            enabled: true,
            mode: 'xy'
          }
        }
      }
    };
  }

  function ensureControlChartsContainer(){
    let wrap = document.getElementById('control-charts');
    if(wrap) return wrap;
    const tbody = document.getElementById('hist-control-tbody');
    if(!tbody) return null;
    const table = tbody.closest('table');
    if(!table) return null;
    ensureControlChartsStyles();
    wrap = document.createElement('div');
    wrap.id = 'control-charts';
    wrap.style.marginTop = '10px';
    wrap.style.padding = '10px';
    wrap.style.border = '1px solid #e2e8f0';
    wrap.style.borderRadius = '8px';
    wrap.style.background = '#f8fafc';
    wrap.style.display = 'none';
    wrap.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;margin-bottom:6px;">
        <h4 style="margin:0;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;color:#1f2937;">Evoluci√≥n controles</h4>
        <span data-role="charts-status" style="font-size:.6rem;color:#64748b;"></span>
      </div>
      <div data-role="charts-grid" style="display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));align-items:stretch;">
  <div id="chart-card-peso-imc" data-chart-card data-zoomed="0" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;background:#fff;">
          <h5 style="margin:0 0 6px;font-size:.75rem;color:#1f2937;">Peso (kg) e IMC</h5>
          <div data-role="chart-area" style="position:relative;height:220px;"><canvas id="chart-control-peso-imc"></canvas></div>
        </div>
  <div id="chart-card-pa" data-chart-card data-zoomed="0" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;background:#fff;">
          <h5 style="margin:0 0 6px;font-size:.75rem;color:#1f2937;">Presi√≥n arterial (mmHg)</h5>
          <div data-role="chart-area" style="position:relative;height:220px;"><canvas id="chart-control-pa"></canvas></div>
        </div>
  <div id="chart-card-hgt-cc" data-chart-card data-zoomed="0" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;background:#fff;">
          <h5 style="margin:0 0 6px;font-size:.75rem;color:#1f2937;">HGT (mg/dL) y CC (cm)</h5>
          <div data-role="chart-area" style="position:relative;height:220px;"><canvas id="chart-control-hgt-cc"></canvas></div>
        </div>
  <div id="chart-card-hba1c" data-chart-card data-zoomed="0" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;background:#fff;">
          <h5 style="margin:0 0 6px;font-size:.75rem;color:#1f2937;">HbA1c (%)</h5>
          <div data-role="chart-area" style="position:relative;height:220px;"><canvas id="chart-control-hba1c"></canvas></div>
        </div>
      </div>
    `;
    table.insertAdjacentElement('afterend', wrap);
    return wrap;
  }

  function createControlChart(key, canvasId, labels, datasets, annotations){
    const canvas = document.getElementById(canvasId);
    if(!canvas) return;
    destroyControlChart(key);
    const options = getControlChartsCommonOpts();
    if(Array.isArray(annotations) && annotations.length){
      options.plugins = options.plugins || {};
      options.plugins.annotation = { annotations };
    }
    const chart = new Chart(canvas, {
      type: 'line',
      data: { labels, datasets },
      options
    });
  _controlCharts[key] = chart;
  recordControlChartBaseline(key, chart);
  bindChartCardZoom(key, canvas);
  }

  function reportControlChartsUnavailable(message){
    const wrap = ensureControlChartsContainer();
    if(!wrap) return;
    wrap.style.display = 'block';
    wrap.setAttribute('data-has-charts','0');
    const statusEl = wrap.querySelector('[data-role="charts-status"]');
    if(statusEl) statusEl.textContent = message;
    wrap.querySelectorAll('[data-role="chart-area"]').forEach(area => {
      area.style.display = 'none';
    });
    ['pesoImc','pa','hgtCc','hba1c'].forEach(destroyControlChart);
  }

  function actualizarGraficosEvolucion(rows){
    const wrap = ensureControlChartsContainer();
    if(!wrap) return;

    const statusEl = wrap.querySelector('[data-role="charts-status"]');

    if(typeof Chart === 'undefined'){
      if(window.__chartReady && typeof window.__chartReady.then === 'function'){
        _controlChartsAwaitingRows = Array.isArray(rows) ? [...rows] : [];
        if(!_controlChartsAwaitingPromise){
          _controlChartsAwaitingPromise = window.__chartReady.then(()=>{
            _controlChartsAwaitingPromise = null;
            const pendingRows = _controlChartsAwaitingRows;
            _controlChartsAwaitingRows = null;
            if(Array.isArray(pendingRows)){
              actualizarGraficosEvolucion(pendingRows);
            }
          }).catch(err => {
            _controlChartsAwaitingPromise = null;
            console.warn('[CONTROL-CHARTS] Fall√≥ la carga de Chart.js', err);
            reportControlChartsUnavailable('‚ö†Ô∏è No fue posible cargar la librer√≠a de gr√°ficos.');
          });
        }
        wrap.style.display = 'block';
        wrap.setAttribute('data-has-charts','0');
        if(statusEl) statusEl.textContent = 'Cargando librer√≠a de gr√°ficos...';
        wrap.querySelectorAll('[data-role="chart-area"]').forEach(area => {
          area.style.display = 'none';
        });
        return;
      }
      console.warn('[CONTROL-CHARTS] Chart.js no disponible y no existe promesa pendiente.');
      reportControlChartsUnavailable('‚ö†Ô∏è No se pudo cargar Chart.js (revisa conexi√≥n o bloqueadores).');
      return;
    }

    wrap.querySelectorAll('[data-role="chart-area"]').forEach(area => {
      area.style.display = '';
    });

    const cardPeso = wrap.querySelector('#chart-card-peso-imc');
    const cardPa = wrap.querySelector('#chart-card-pa');
    const cardHgt = wrap.querySelector('#chart-card-hgt-cc');
    const cardHba1c = wrap.querySelector('#chart-card-hba1c');

    const validRows = Array.isArray(rows) ? rows : [];
    const sorted = validRows
      .map(r => ({ ...r, __fecha: parseFechaControl(r?.fecha || r?.fecha_control) }))
      .filter(r => r.__fecha)
      .sort((a,b)=> a.__fecha - b.__fecha);

    if(!sorted.length){
      console.log('[CONTROL-CHARTS] Sin registros con fecha v√°lida, ocultando panel.');
      wrap.style.display = 'none';
      if(statusEl) statusEl.textContent = 'Sin datos para graficar.';
      ['pesoImc','pa','hgtCc','hba1c'].forEach(destroyControlChart);
      return;
    }

    ensureControlChartsPlugins();

    if(!_controlChartsPlugins.zoom){
      if(window.__chartReady && typeof window.__chartReady.then === 'function'){
        _controlChartsAwaitingRows = Array.isArray(rows) ? [...rows] : [];
        if(!_controlChartsAwaitingPromise){
          _controlChartsAwaitingPromise = window.__chartReady.then(() => {
            _controlChartsAwaitingPromise = null;
            const pendingRows = _controlChartsAwaitingRows;
            _controlChartsAwaitingRows = null;
            if(Array.isArray(pendingRows)){
              actualizarGraficosEvolucion(pendingRows);
            }
          }).catch(err => {
            _controlChartsAwaitingPromise = null;
            console.warn('[CONTROL-CHARTS] Fall√≥ la carga de plugins adicionales', err);
            reportControlChartsUnavailable('‚ö†Ô∏è No fue posible activar los gr√°ficos de controles.');
          });
        }
        wrap.style.display = 'block';
        wrap.setAttribute('data-has-charts','0');
        if(statusEl) statusEl.textContent = 'Cargando funciones de zoom para los gr√°ficos...';
        wrap.querySelectorAll('[data-role="chart-area"]').forEach(area => {
          area.style.display = 'none';
        });
        return;
      }
      console.warn('[CONTROL-CHARTS] Plugin de zoom no disponible.');
    }

    const labels = sorted.map(r => formatearFechaCorta(r.__fecha) || r.__fecha.toISOString().slice(0,10));
    const serie = {
      peso: sorted.map(r => toFloatOrNullControl(r.peso)),
      imc: sorted.map(r => {
        const val = toFloatOrNullControl(r.imc);
        return val != null ? Number(val.toFixed(1)) : null;
      }),
      psis: sorted.map(r => toFloatOrNullControl(r.presion_sistolica || r.psis)),
      pdia: sorted.map(r => toFloatOrNullControl(r.presion_diastolica || r.pdia)),
      hgt: sorted.map(r => toFloatOrNullControl(r.hgt)),
      cc: sorted.map(r => toFloatOrNullControl(r.cc)),
      hba1c: sorted.map(r => toFloatOrNullControl(r.hba1c))
    };

    const hasPeso = serie.peso.some(isFiniteNumber) || serie.imc.some(isFiniteNumber);
    const hasPa = serie.psis.some(isFiniteNumber) || serie.pdia.some(isFiniteNumber);
    const hasHgt = serie.hgt.some(isFiniteNumber) || serie.cc.some(isFiniteNumber);
    const hasHba1c = serie.hba1c.some(isFiniteNumber) && (typeof usuarioTieneDiabetes === 'function' ? usuarioTieneDiabetes() : true);
    const any = hasPeso || hasPa || hasHgt || hasHba1c;

    if(!any){
      console.log('[CONTROL-CHARTS] Registros sin valores num√©ricos, ocultando panel.');
      wrap.style.display = 'none';
      if(statusEl) statusEl.textContent = 'Sin datos para graficar.';
      ['pesoImc','pa','hgtCc','hba1c'].forEach(destroyControlChart);
      return;
    }

    wrap.style.display = 'block';
    wrap.setAttribute('data-has-charts','1');
    if(statusEl) statusEl.textContent = `Controles considerados: ${sorted.length}`;

    const edadUsuario = Number.isFinite(window.__usuarioEdad) ? window.__usuarioEdad : null;
    const esAdultoMayor = edadUsuario != null && edadUsuario >= 65;
    const imcRef1 = esAdultoMayor ? 28 : 25;
    const imcRef2 = esAdultoMayor ? 32 : 30;
    const imcLabel1 = esAdultoMayor ? 'IMC 28 SP (AM)' : 'IMC 25 SP';
    const imcLabel2 = esAdultoMayor ? 'IMC 32 OB (AM)' : 'IMC 30 OB';
    const sistolicaRef = edadUsuario != null && edadUsuario >= 80 ? 150 : 140;
    const sistolicaLabel = edadUsuario != null && edadUsuario >= 80 ? 'PA 150 SIS (‚â•80 a√±os)' : 'PA 140 SIS';
    const hba1cRef = edadUsuario != null && edadUsuario >= 80 ? 8 : 7;
    const hba1cLabel = edadUsuario != null && edadUsuario >= 80 ? 'HbA1c 8% (‚â•80 a√±os)' : 'HbA1c 7%';

    if(cardPeso) cardPeso.style.display = hasPeso ? 'block' : 'none';
    if(cardPa) cardPa.style.display = hasPa ? 'block' : 'none';
    if(cardHgt) cardHgt.style.display = hasHgt ? 'block' : 'none';
    if(cardHba1c) cardHba1c.style.display = hasHba1c ? 'block' : 'none';

    if(hasPeso){
      console.log('[CONTROL-CHARTS] Render peso/IMC con', serie.peso.length, 'puntos.');
      createControlChart('pesoImc','chart-control-peso-imc', labels, [
        {
          label: 'Peso (kg)',
          data: serie.peso,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.1)',
          borderWidth: 2,
          tension: 0.2
        },
        {
          label: 'IMC',
          data: serie.imc,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239,68,68,0.1)',
          borderWidth: 2,
          tension: 0.2
        }
      ], [
        {
          type: 'line',
          yMin: imcRef1,
          yMax: imcRef1,
          borderColor: '#ff8c00',
          borderWidth: 2,
          borderDash: [5,5],
          label: { content: imcLabel1, enabled: true, position: 'end' }
        },
        {
          type: 'line',
          yMin: imcRef2,
          yMax: imcRef2,
          borderColor: '#ff8c00',
          borderWidth: 2,
          borderDash: [5,5],
          label: { content: imcLabel2, enabled: true, position: 'end' }
        }
      ]);
    } else {
      destroyControlChart('pesoImc');
    }

    if(hasPa){
      console.log('[CONTROL-CHARTS] Render PA con', serie.psis.length, 'puntos.');
      createControlChart('pa','chart-control-pa', labels, [
        {
          label: 'Sist√≥lica',
          data: serie.psis,
          borderColor: '#dc2626',
          backgroundColor: 'rgba(220,38,38,0.1)',
          borderWidth: 2,
          tension: 0.2
        },
        {
          label: 'Diast√≥lica',
          data: serie.pdia,
          borderColor: '#7c3aed',
          backgroundColor: 'rgba(124,58,237,0.1)',
          borderWidth: 2,
          tension: 0.2
        }
      ], [
        {
          type: 'line',
          yMin: sistolicaRef,
          yMax: sistolicaRef,
          borderColor: '#059669',
          borderWidth: 2,
          borderDash: [5,5],
          label: { content: sistolicaLabel, enabled: true, position: 'end' }
        },
        {
          type: 'line',
          yMin: 90,
          yMax: 90,
          borderColor: '#059669',
          borderWidth: 2,
          borderDash: [5,5],
          label: { content: 'PA 90 DIAS', enabled: true, position: 'end' }
        }
      ]);
    } else {
      destroyControlChart('pa');
    }

    if(hasHgt){
      console.log('[CONTROL-CHARTS] Render HGT/CC con', serie.hgt.length, 'puntos.');
      createControlChart('hgtCc','chart-control-hgt-cc', labels, [
        {
          label: 'HGT (mg/dL)',
          data: serie.hgt,
          borderColor: '#059669',
          backgroundColor: 'rgba(5,150,105,0.1)',
          borderWidth: 2,
          tension: 0.2
        },
        {
          label: 'CC (cm)',
          data: serie.cc,
          borderColor: '#ea580c',
          backgroundColor: 'rgba(234,88,12,0.1)',
          borderWidth: 2,
          tension: 0.2
        }
      ], [
        {
          type: 'line',
          yMin: 100,
          yMax: 100,
          borderColor: '#059669',
          borderWidth: 2,
          borderDash: [5,5],
          label: { content: 'HGT 100', enabled: true, position: 'end' }
        }
      ]);
    } else {
      destroyControlChart('hgtCc');
    }

    if(hasHba1c){
      console.log('[CONTROL-CHARTS] Render HbA1c con', serie.hba1c.length, 'puntos.');
      createControlChart('hba1c','chart-control-hba1c', labels, [
        {
          label: 'HbA1c (%)',
          data: serie.hba1c,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139,92,246,0.1)',
          borderWidth: 2,
          tension: 0.2
        }
      ], [
        {
          type: 'line',
          yMin: hba1cRef,
          yMax: hba1cRef,
          borderColor: '#059669',
          borderWidth: 2,
          borderDash: [5,5],
          label: { content: hba1cLabel, enabled: true, position: 'end' }
        }
      ]);
    } else {
      destroyControlChart('hba1c');
    }
  }
  
  // Funci√≥n global de debug para verificar datos desde consola
  window.debugHistoricos = function() {
    console.log('=== DEBUG HIST√ìRICOS ===');
    console.log('_histControlRaw:', _histControlRaw?.length || 'undefined', _histControlRaw);
    console.log('_histLabsRaw:', _histLabsRaw?.length || 'undefined', _histLabsRaw);
    
    const tbody = document.getElementById('hist-control-tbody');
    if (tbody) {
      console.log('hist-control-tbody existe, contenido:', tbody.innerHTML.substring(0, 300));
    } else {
      console.log('hist-control-tbody NO encontrado');
    }
    
    const tbodyLabs = document.getElementById('hist-labs-tbody');
    if (tbodyLabs) {
      console.log('hist-labs-tbody existe, contenido:', tbodyLabs.innerHTML.substring(0, 300));
    } else {
      console.log('hist-labs-tbody NO encontrado');
    }
  };

  // Funci√≥n de test para forzar carga de hist√≥ricos
  window.testCargarHistoricos = function() {
    console.log('=== TEST FORZAR CARGA HIST√ìRICOS ===');
    const runField = document.getElementById('run');
    const runVal = runField?.value?.trim();
    console.log('RUN detectado:', runVal);
    
    if (runVal) {
      console.log('Ejecutando cargarHistoricoControl...');
      cargarHistoricoControl(runVal);
      
      console.log('Ejecutando cargarHistoricoLabs...');
      cargarHistoricoLabs(runVal);
      
      console.log('Ejecutando cargarHistoricoAcuerdos...');
      cargarHistoricoAcuerdos(runVal);
    } else {
      console.log('No hay RUN disponible');
    }
  };
  
  // Funci√≥n para verificar el estado general del sistema
  window.estadoSistema = function() {
    console.log('=== ESTADO DEL SISTEMA ===');
    const runField = document.getElementById('run');
    const runVal = runField?.value?.trim();
    console.log('Campo RUN:', runField ? 'EXISTE' : 'NO EXISTE');
    console.log('Valor RUN:', runVal || 'VAC√çO');
    
    console.log('Funciones disponibles:');
    console.log('- cargarHistoricoControl:', typeof cargarHistoricoControl);
    console.log('- cargarHistoricoLabs:', typeof cargarHistoricoLabs);
    console.log('- cargarHistoricoAcuerdos:', typeof cargarHistoricoAcuerdos);
    console.log('- recargaTodo:', typeof window.recargaTodo);
    
    console.log('Elementos DOM:');
    console.log('- hist-control-tbody:', document.getElementById('hist-control-tbody') ? 'EXISTE' : 'NO EXISTE');
    console.log('- hist-labs-tbody:', document.getElementById('hist-labs-tbody') ? 'EXISTE' : 'NO EXISTE');
  };

  async function cargarHistoricoControl(runVal){
    const tbody = document.getElementById('hist-control-tbody');
    if(!tbody) {
      console.error('[HIST-CONTROL] No se encontr√≥ tbody con id hist-control-tbody');
      return;
    }
    if(!runVal){ tbody.innerHTML='<tr><td colspan="10" style="padding:6px;opacity:.6;">‚Äî</td></tr>'; return; }
    try{
      console.log('[HIST-CONTROL] Cargando hist√≥rico control para RUN:', runVal);
      const r = await authFetch(`/api/control/historico/${encodeURIComponent(runVal)}?limit=12`);
      console.log('Response status hist√≥rico control:', r.status, r.ok);
      console.log('Response headers:', [...r.headers.entries()]);
      const responseText = await r.text();
      console.log('Response text raw:', responseText);
      let d;
      try {
        d = JSON.parse(responseText);
        console.log('JSON parseado correctamente:', d);
      } catch (parseError) {
        console.error('Error parsing JSON:', parseError);
        console.log('Contenido no es JSON v√°lido:', responseText.substring(0, 200));
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error: respuesta no es JSON v√°lido</td></tr>';
        return;
      }
      
      // Manejo m√°s flexible de la respuesta
      let ok = false;
      let controles = [];
      
      if (d.ok !== undefined) {
        ok = d.ok;
        controles = d.controles || d.data || [];
      } else if (d.success !== undefined) {
        ok = d.success;
        controles = d.controles || d.data || [];
      } else if (Array.isArray(d.controles)) {
        ok = true;
        controles = d.controles;
      } else if (Array.isArray(d.data)) {
        ok = true;
        controles = d.data;
      } else if (Array.isArray(d)) {
        // Si la respuesta es directamente un array
        ok = true;
        controles = d;
      }
      
      console.log('Procesado - ok:', ok, 'controles:', controles.length);
      
      if (!ok) {
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error: respuesta inv√°lida del servidor</td></tr>';
        actualizarGraficosEvolucion([]);
        return;
      }
      
  _histControlRaw = controles.map(normalizarRegistroControl);
      console.log('[HIST-CONTROL] _histControlRaw asignado, longitud:', _histControlRaw.length);
      console.log('[HIST-CONTROL] Primer elemento:', _histControlRaw[0]);
      try {
        window.dispatchEvent(new CustomEvent('riesgo-cv:refrescar-control', { detail: controles?.[0] }));
      } catch (err) {
        console.warn('[HIST-CONTROL] Evento refrescar-control fall√≥', err);
      }
      
      if(!_histControlRaw.length){ 
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; 
        console.log('[HIST-CONTROL] No hay datos de control para mostrar');
        actualizarGraficosEvolucion([]);
        return; 
      }
      
      console.log('[HIST-CONTROL] Llamando aplicarFiltrosYRenderControl con', _histControlRaw.length, 'registros');
      
      // Test immediato para verificar que los datos est√°n disponibles
      setTimeout(() => {
        console.log('[HIST-CONTROL-TEST] Verificando datos despu√©s de 100ms');
        console.log('[HIST-CONTROL-TEST] _histControlRaw length:', _histControlRaw?.length);
        const tbody = document.getElementById('hist-control-tbody');
        if (tbody) {
          console.log('[HIST-CONTROL-TEST] tbody innerHTML length:', tbody.innerHTML.length);
          console.log('[HIST-CONTROL-TEST] tbody innerHTML preview:', tbody.innerHTML.substring(0, 200));
        }
      }, 100);
      
      aplicarFiltrosYRenderControl();
    }catch(e){ 
      console.error('Error cargando hist√≥rico control:', e);
      tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error red: ' + e.message + '</td></tr>'; 
      actualizarGraficosEvolucion([]);
    }
  }



  async function cargarHistoricoAcuerdos(runVal){
    const tbody = document.getElementById('hist-acuerdos-tbody');
    const ult = document.getElementById('acuerdo-ultimo');
    if(!tbody) return;
    if(!runVal){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;opacity:.6;">‚Äî</td></tr>'; ult.textContent='Sin datos'; return; }
    try{
      const r = await authFetch(`/api/acuerdos/historico/${encodeURIComponent(runVal)}?limit=8`);
      const d = await r.json();
      const ok = (typeof d.ok !== 'undefined') ? d.ok : (typeof d.success !== 'undefined' ? d.success : Array.isArray(d.acuerdos));
      if(!ok){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error</td></tr>'; ult.textContent='Error'; return; }
      const rows = d.acuerdos || d.data || [];
      if(!rows.length){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; ult.textContent='Sin datos'; return; }
      const primero = rows[0];
      const cumplimientoPrimero = formatearCumplimiento(primero.cumplimiento);
      const resumenCumplimiento = cumplimientoPrimero === '‚Äî' ? '' : ` (${cumplimientoPrimero})`;
      ult.textContent = `${primero.fecha_creacion || ''}: ${primero.acuerdos || ''}${resumenCumplimiento}`;
      tbody.innerHTML = rows.map(a=>{
        const cumplimientoFmt = formatearCumplimiento(a.cumplimiento);
        return `<tr style=\"border-top:1px solid #e2e8f0;\">\n          <td style=\"padding:4px;\">${a.fecha_creacion||''}</td>\n          <td style=\"padding:4px;\">${(a.acuerdos||'').toString().slice(0,60)}</td>\n          <td style=\"padding:4px;\">${cumplimientoFmt}</td>\n          <td style=\"padding:4px;\">${(a.observaciones||'').toString().slice(0,40)}</td>\n        </tr>`;
      }).join('');
    }catch(e){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error red</td></tr>'; ult.textContent='Error'; }
  }

  function mostrarEstado(msg, tipo='info'){
    let box = document.getElementById('estado-guardar');
    if(!box){
      box = document.createElement('div');
      box.id='estado-guardar';
      box.style.fontSize='.75rem';
      box.style.marginTop='4px';
      document.getElementById('form-tarjeton').appendChild(box);
    }
    const colores = {info:'#334155',ok:'#065f46',error:'#b91c1c'};
    box.style.color = colores[tipo]||colores.info;
    box.textContent = msg;
  }

  async function guardar(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const categoriaRaw = (fd.get('categoria') || '').toString().trim().toUpperCase();
    const categoriaNormalizada = categoriaRaw && categoriaRaw !== '‚Äî' && categoriaRaw !== '-' ? categoriaRaw : null;
    const payload = {
      run: fd.get('run')?.trim(),
      nombre: fd.get('nombre')?.trim() || null,
      fecha_nacimiento: fd.get('fecha_nacimiento') || null,
      sexo: fd.get('sexo')||null,
      direccion: fd.get('direccion')||null,
      telefono: fd.get('telefono')||null,
      sector_id: fd.get('sector_id') || null,
      categoria: categoriaNormalizada
    };
    if(!payload.run){ mostrarEstado('RUN requerido','error'); return; }
    mostrarEstado('Guardando...');
    try{
      const r = await authFetch('/api/tarjeton',{method:'POST',body:JSON.stringify(payload)});
      const data = await r.json().catch(()=>({ok:false,error:'RESPUESTA_INVALIDA'}));
      if(!r.ok || !data.ok){
        mostrarEstado('Error guardando: '+(data.error||r.status),'error');
        return;
      }
      mostrarEstado('Guardado ‚úî','ok');
      poblar(data); // refrescar
    }catch(err){
      console.error(err);
      mostrarEstado('Error de red','error');
    }
  }
  document.getElementById('form-tarjeton').addEventListener('submit', guardar);

  // Event listeners para evaluaci√≥n adulto mayor
  const tugSegundos = document.getElementById('tugSegundos');
  const unipodalDerecho = document.getElementById('unipodalPieDerecho');
  const unipodalIzquierdo = document.getElementById('unipodalPieIzquierdo');
  
  if (tugSegundos) {
    tugSegundos.addEventListener('input', calcularClasificacionTUG);
  }
  
  if (unipodalDerecho || unipodalIzquierdo) {
    unipodalDerecho?.addEventListener('input', calcularClasificacionUnipodal);
    unipodalIzquierdo?.addEventListener('input', calcularClasificacionUnipodal);
  }

  // Delegaci√≥n para filtros
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-filtro-control]');
    if(b){
      const v = b.getAttribute('data-filtro-control');
      aplicarFiltrosYRenderControl(v==='6m'?6: v==='12m'?12: null);
    }
    const b2 = e.target.closest('[data-filtro-labs]');
    if(b2){
      const v = b2.getAttribute('data-filtro-labs');
      aplicarFiltrosYRenderLabs(v==='6m'?6: v==='12m'?12: null);
    }
    const exp = e.target.closest('[data-export]');
    if(exp){
      const tipo = exp.getAttribute('data-export');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal) return;
      window.location = `/api/export/historico/${encodeURIComponent(runVal)}?tipo=${tipo}&formato=xlsx`;
    }
  });

  function claseRiesgo(nombre){
    if(!nombre) return 'badge-neutro';
    const n = nombre.toString().toLowerCase();
    // Mapeo expl√≠cito G1/G2/G3 solicitado: G1 verde, G2 amarillo, G3 rojo
    if(/^g1\b/.test(n)) return 'badge-g1';
    if(/^g2\b/.test(n)) return 'badge-g2';
    if(/^g3\b/.test(n)) return 'badge-g3';
    if(/alto/.test(n)) return 'badge-alto';
    if(/moderado|medio/.test(n)) return 'badge-medio';
    if(/bajo|leve/.test(n)) return 'badge-bajo';
    return 'badge-neutro';
  }
  
  // Actualizar badge de riesgo - SIN bypass CARDIO
  function actualizarBadgeRiesgo(texto){
    let badge = document.getElementById('badge-riesgo');
    if(!badge){
      const contResumen = document.querySelector('#resumen-ident');
      badge = document.createElement('div');
      badge.id='badge-riesgo';
      badge.style.marginTop='6px';
      contResumen.appendChild(badge);
    }
    // Siempre aplica color seg√∫n categor√≠a calculada
    badge.className = 'badge-riesgo '+claseRiesgo(texto);
    badge.textContent = texto || '‚Äî';
    
    const inputCat = document.getElementById('categoria');
    if(inputCat) inputCat.value = texto || '‚Äî';
  }

  // Estilos b√°sicos badges inyectados si no existen
  if(!document.getElementById('css-badges-riesgo')){
    const style = document.createElement('style');
    style.id='css-badges-riesgo';
    style.textContent = `
      .badge-riesgo{display:inline-block;padding:4px 8px;font-size:.65rem;font-weight:600;letter-spacing:.5px;border-radius:14px;background:#e2e8f0;color:#334155;text-transform:uppercase;}
      .badge-riesgo.badge-alto{background:#b91c1c;color:#fff;}
      .badge-riesgo.badge-medio{background:#d97706;color:#fff;}
      .badge-riesgo.badge-bajo{background:#15803d;color:#fff;}
      .badge-riesgo.badge-neutro{background:#64748b;color:#fff;}
      /* Nuevos estilos para categor√≠as renales G1/G2/G3 */
      .badge-riesgo.badge-g1{background:#16a34a;color:#fff;}
      .badge-riesgo.badge-g2{background:#facc15;color:#422006;}
      .badge-riesgo.badge-g3{background:#dc2626;color:#fff;}
      .badge-riesgo.badge-g3{background:#b91c1c;color:#fff;}
    `;
    document.head.appendChild(style);
  }

  // Hacer funci√≥n disponible globalmente
  window.actualizarBadgeRiesgo = actualizarBadgeRiesgo;

  // Estilos alertas hist√≥ricos
  if(!document.getElementById('css-alertas-hist')){
    const st = document.createElement('style');
    st.id='css-alertas-hist';
    st.textContent = `
      .row-danger{background:rgba(185,28,28,0.18)!important;}
      .row-warning{background:rgba(217,119,6,0.18)!important;}
      .row-good{background:rgba(22,163,74,0.18)!important;}
      .delta-up{color:#b91c1c;font-weight:600;}
      .delta-down{color:#15803d;font-weight:600;}
      .delta-flat{color:#475569;opacity:.6;}
    `;
    document.head.appendChild(st);
  }
  // (fin estilos hist√≥ricos)
  
  // Funciones auxiliares para hist√≥ricos
  function obtenerColoresHTA(valorRaw){
    const valor = (valorRaw || '').trim().toLowerCase();
    if(/normotens[oa]/.test(valor)){
      return { bg:'rgba(34, 197, 94, 0.25)', color:'#0f172a' };
    }
    if(/hta\s*etapa\s*1/.test(valor) || /hta\s*etapa\s*i\b/.test(valor)){
      return { bg:'rgba(250, 204, 21, 0.35)', color:'#1f2937' };
    }
    if(/hta\s*etapa\s*2/.test(valor) || /hta\s*etapa\s*ii\b/.test(valor)){
      return { bg:'rgba(249, 115, 22, 0.35)', color:'#fff' };
    }
    if(/hta\s*etapa\s*3/.test(valor) || /hta\s*etapa\s*iii\b/.test(valor)){
      return { bg:'rgba(239, 68, 68, 0.35)', color:'#fff' };
    }
    return { bg:'', color:'' };
  }

  function toFloatOrNullControl(value){
    if(value === null || value === undefined) return null;
    if(typeof value === 'number') return Number.isFinite(value) ? value : null;
    const sanitized = String(value).replace(',', '.').trim();
    if(!sanitized) return null;
    const parsed = parseFloat(sanitized);
    return Number.isFinite(parsed) ? parsed : null;
  }

  function calcularIMCDesdeMedidas(peso, talla){
    const pesoNum = toFloatOrNullControl(peso);
    const tallaNum = toFloatOrNullControl(talla);
    if(pesoNum == null || tallaNum == null || tallaNum <= 0) return null;
    const tallaMetros = tallaNum > 10 ? tallaNum / 100 : tallaNum;
    if(tallaMetros <= 0) return null;
    const imc = pesoNum / (tallaMetros * tallaMetros);
    return Number.isFinite(imc) ? imc : null;
  }

  function clasificarIMCDesdeValor(imc){
    const value = toFloatOrNullControl(imc);
    if(value == null) return null;
    if(value < 18.5) return 'Bajo peso';
    if(value < 25) return 'Normal';
    if(value < 30) return 'Sobrepeso';
    if(value < 35) return 'Obesidad I';
    if(value < 40) return 'Obesidad II';
    return 'Obesidad III';
  }

  function formatearIMCControl(valor){
    const num = toFloatOrNullControl(valor);
    return num != null ? num.toFixed(1) : '‚Äî';
  }

  function normalizarRegistroControl(control){
    if(!control || typeof control !== 'object') return control;
    const normalizado = { ...control };
    const imcOriginal = toFloatOrNullControl(normalizado.imc);
    const recalculado = calcularIMCDesdeMedidas(normalizado.peso, normalizado.talla);
    const usarRecalculado = (imcOriginal == null || imcOriginal <= 0) && recalculado != null;
    const imcFinal = usarRecalculado ? recalculado : imcOriginal;
    if(imcFinal != null){
      normalizado.imc = imcFinal;
      const clasCalculada = clasificarIMCDesdeValor(imcFinal);
      const clasRaw = (normalizado.imc_clasificacion || '').toString().trim().toLowerCase();
      if(usarRecalculado || !clasRaw || clasRaw === 'sin datos' || clasRaw === '‚Äî'){
        normalizado.imc_clasificacion = clasCalculada;
      } else if(!normalizado.imc_clasificacion && clasCalculada){
        normalizado.imc_clasificacion = clasCalculada;
      }
    } else {
      normalizado.imc = null;
      if(normalizado.imc_clasificacion && /sin datos|‚Äî/i.test(normalizado.imc_clasificacion.toString())){
        normalizado.imc_clasificacion = null;
      }
    }
    return normalizado;
  }

  function obtenerColoresIMC(valorRaw){
    const valor = (valorRaw || '').trim().toLowerCase();
    if(/bajo\s*peso/.test(valor)){
      return { bg:'rgba(168, 85, 247, 0.28)', color:'#4c1d95' };
    }
    if(/\bnormal\b/.test(valor)){
      return { bg:'rgba(34, 197, 94, 0.25)', color:'#065f46' };
    }
    if(/sobrepeso/.test(valor)){
      return { bg:'rgba(250, 204, 21, 0.3)', color:'#92400e' };
    }
    if(/obesidad/.test(valor)){
      return { bg:'rgba(239, 68, 68, 0.32)', color:'#7f1d1d' };
    }
    return { bg:'', color:'' };
  }

  function colorearControles(){
    // Colorear filas seg√∫n clasificaciones de riesgo
    document.querySelectorAll('#hist-control-tbody tr.ctl-row').forEach(tr=>{
      tr.style.backgroundColor = '';
  const htaCell = tr.querySelector('[data-hta]');
  const paCell = tr.querySelector('[data-psis]');
  const imcCell = tr.querySelector('[data-imc]');
  const imcClasCell = imcCell?.nextElementSibling || null;
      if(!htaCell){
        if(paCell){
          paCell.style.backgroundColor='';
          paCell.style.color='';
          paCell.style.borderRadius='';
          paCell.style.fontWeight='';
        }
        return;
      }

      const htaAttr = htaCell.getAttribute('data-hta') || '';
      const { bg: htaBg, color: htaColor } = obtenerColoresHTA(htaAttr);

      htaCell.style.backgroundColor = htaBg;
      htaCell.style.color = htaColor || '';
      htaCell.style.borderRadius = htaBg ? '4px' : '';
      htaCell.style.fontWeight = htaBg ? '600' : '';

      if(paCell){
        paCell.style.backgroundColor = htaBg;
        paCell.style.color = htaColor || '';
        paCell.style.borderRadius = htaBg ? '4px' : '';
        paCell.style.fontWeight = htaBg ? '600' : '';
      }

      if(imcCell){
        const clasText = imcClasCell?.textContent || '';
        const { bg: imcBg, color: imcColor } = obtenerColoresIMC(clasText);

        [imcCell, imcClasCell].forEach(cell => {
          if(!cell) return;
          cell.style.backgroundColor = imcBg;
          cell.style.color = imcColor || '';
          cell.style.borderRadius = imcBg ? '4px' : '';
          cell.style.fontWeight = imcBg ? '600' : '';
        });
      }
    });
  }
  
  // === Helpers puros para c√°lculo de tendencias ===
  function num(v){ if (v == null) return null; const n = parseFloat(v); return Number.isNaN(n) ? null : n; }
  function delta(a,b){ const na=num(a), nb=num(b); return (na==null || nb==null) ? null : (na - nb); }

  // Tabla de m√©tricas (misma sem√°ntica)
  const _METRICAS = [
    { key:'presion_sistolica',  thr:5,   tip:false, lab:'PS' },
    { key:'presion_diastolica', thr:5,   tip:false, lab:'PD' },
    { key:'imc',                thr:0.5, tip:true  },
    { key:'hba1c',              thr:0.3, tip:true  },
    { key:'peso',               thr:1,   tip:true  },
    { key:'cc',                 thr:1,   tip:true  },
  ];

  // Puro: genera el array de spans para una fila
  function buildPartes(actual, prev){
    const partes = [];
    for (const m of _METRICAS){
      const d = delta(actual[m.key], prev[m.key]);
      if (d === null) continue;
      if (Math.abs(d) >= m.thr) partes.push(arrowHTML(d, m.thr, !!m.tip, m.lab));
    }
    return partes;
  }

  // MISMA FIRMA
  function calcularTendenciasControles(rows){
    const trs = document.querySelectorAll('#hist-control-tbody tr.ctl-row');
    const last = rows.length - 1;

    for (let i = 0; i < rows.length; i++){
      if (i === last) break; // √∫ltimo no tiene anterior
      const tr = trs[i];
      if (!tr) continue;

      const deltaCell = tr.querySelector('[data-delta]');
      if (!deltaCell) continue;

      const partes = buildPartes(rows[i], rows[i+1]);
      deltaCell.innerHTML = partes.join(' ');
    }
  }
  
  function arrowHTML(delta, umbral, conTooltip, label) {
    if(Math.abs(delta) < umbral) return `<span class="delta-flat">‚Äî</span>`;
    const dir = delta > 0 ? 'up' : 'down';
    const color = delta > 0 ? '#dc2626' : '#16a34a';
    const arrow = delta > 0 ? '‚Üó' : '‚Üò';
    const tooltip = conTooltip ? ` title="Œî ${delta > 0 ? '+' : ''}${delta.toFixed(1)}"` : '';
    const labelTxt = label ? `<sub>${label}</sub>` : '';
    return `<span class="delta-${dir}" style="color:${color};"${tooltip}>${arrow}${labelTxt}</span>`;
  }
  
  function formatearFechaCorta(valor){
    if(!valor) return '‚Äî';

    const pad = (n)=>String(n).padStart(2,'0');
    const render = (dateObj)=>`${pad(dateObj.getDate())}/${pad(dateObj.getMonth()+1)}/${dateObj.getFullYear()}`;

    if(valor instanceof Date && !Number.isNaN(valor.getTime())){
      return render(valor);
    }

    const txt = valor.toString().trim();
    if(!txt) return '‚Äî';

    const parsed = Date.parse(txt);
    if(!Number.isNaN(parsed)){
      return render(new Date(parsed));
    }

    const isoMatch = txt.match(/(\d{4})-(\d{2})-(\d{2})/);
    if(isoMatch){
      const [,y,m,d] = isoMatch;
      return `${d}/${m}/${y}`;
    }

    const slashMatch = txt.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
    if(slashMatch){
      const [,d,m,y] = slashMatch.map((v,i)=> i===0||i===1 ? pad(Number(v)) : v);
      return `${d}/${m}/${y}`;
    }

    const rfcMatch = txt.match(/^(?:[a-zA-Z√±√ë√°√©√≠√≥√∫√º]{3,}),?\s*(\d{1,2})\s+([a-zA-Z√±√ë√°√©√≠√≥√∫√º]{3,})\s+(\d{4})/);
    if(rfcMatch){
      const [,dia,mesTxt,anio] = rfcMatch;
      const meses = {
        ene:'01', feb:'02', mar:'03', abr:'04', may:'05', jun:'06', jul:'07', ago:'08', sep:'09', set:'09', oct:'10', nov:'11', dic:'12',
        jan:'01', febr:'02', apr:'04', jun:'06', jul:'07', aug:'08', dec:'12',
        janv:'01', fev:'02', marz:'03', sept:'09'
      };
      const clave = mesTxt.toLowerCase().slice(0,3);
      const mesNum = meses[clave] || meses[mesTxt.toLowerCase()] || '01';
      return `${pad(Number(dia))}/${mesNum}/${anio}`;
    }

    return txt;
  }

  function normalizarSexo(valor){
    const txt = (valor || '').toString().trim().toLowerCase();
    if(!txt || txt === '‚Äî' || txt === '-') return '';
    if(txt.startsWith('f')) return 'f';
    if(txt.startsWith('m')) return 'm';
    return txt;
  }

  function obtenerSexoUsuario(){
    let sexo = normalizarSexo(window.__usuarioSexo);
    if(sexo) return sexo;

    const sexoSpan = document.querySelector('[data-f="sexo"]');
    if(sexoSpan){
      sexo = normalizarSexo(sexoSpan.textContent);
      if(sexo){
        window.__usuarioSexo = sexo;
        return sexo;
      }
    }

    const sexoInput = document.getElementById('sexo');
    if(sexoInput){
      sexo = normalizarSexo(sexoInput.value || sexoInput.textContent);
      if(sexo){
        window.__usuarioSexo = sexo;
        return sexo;
      }
    }

    return '';
  }

  function usuarioTieneDiabetes(){
    if(typeof window.__usuarioTieneDiabetes === 'boolean'){
      return window.__usuarioTieneDiabetes;
    }
    const patologias = window.__usuarioPatologiasResumen;
    if(Array.isArray(patologias)){
      const tiene = patologias.some(p => {
        const nombre = (p.nombre || '').toLowerCase();
        const cie10 = (p.cie10 || p.codigo || '').toLowerCase();
        return nombre.includes('diabet') || /^e1[0-4]/.test(cie10);
      });
      window.__usuarioTieneDiabetes = tiene;
      return tiene;
    }
    return false;
  }

  function valorNumerico(raw){
    if(raw === null || raw === undefined) return null;
    const txt = raw.toString().replace(',', '.').trim();
    if(!txt) return null;
    const val = Number(txt);
    return Number.isFinite(val) ? val : null;
  }

  function filaLabTieneDatos(row){
    if(!row || typeof row !== 'object') return false;
    const campos = ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','erc','rac','microalbuminuria','microalbuminuria_val','tsh'];
    for(const campo of campos){
      if(!(campo in row)) continue;
      const val = row[campo];
      if(val === null || val === undefined) continue;
      if(typeof val === 'boolean') return true;
      if(typeof val === 'number' && !Number.isNaN(val)) return true;
      if(typeof val === 'string'){
        const txt = val.trim();
        if(!txt) continue;
        const lower = txt.toLowerCase();
        if(lower === '-' || lower === '‚Äî' || lower === 'no') continue;
        return true;
      }
      return true;
    }
    if(typeof row.microalbuminuria_positiva === 'boolean') return true;
    return false;
  }

  if(!document.getElementById('css-colores-labs')){
    const st = document.createElement('style');
    st.id = 'css-colores-labs';
    st.textContent = `
      #hist-labs-tbody td.lab-estado-danger{background:#f87171 !important;color:#450a0a !important;font-weight:600;box-shadow:0 0 0 1px rgba(248,113,113,0.7) inset,0 0 6px rgba(248,113,113,0.4);} 
      #hist-labs-tbody td.lab-estado-warning{background:#fbbf24 !important;color:#422006 !important;font-weight:600;box-shadow:0 0 0 1px rgba(251,191,36,0.65) inset,0 0 6px rgba(251,191,36,0.35);} 
      #hist-labs-tbody td.lab-estado-success{background:#34d399 !important;color:#064e3b !important;font-weight:600;box-shadow:0 0 0 1px rgba(52,211,153,0.55) inset,0 0 6px rgba(34,197,94,0.3);} 
      #hist-labs-tbody td.lab-estado-info{background:#60a5fa !important;color:#1e3a8a !important;font-weight:600;box-shadow:0 0 0 1px rgba(96,165,250,0.55) inset,0 0 6px rgba(96,165,250,0.28);} 
      #hist-labs-tbody tr.lab-row-danger{background:rgba(248,113,113,0.22) !important;}
      #hist-labs-tbody tr.lab-row-warning{background:rgba(251,191,36,0.22) !important;}
      #hist-labs-tbody tr.lab-row-success{background:rgba(34,197,94,0.18) !important;}
    `;
    document.head.appendChild(st);
  }

  const CLASES_LAB_ESTADO = ['lab-estado-danger','lab-estado-warning','lab-estado-success','lab-estado-info'];
  const CLASES_LAB_FILA = ['lab-row-danger','lab-row-warning','lab-row-success'];

  const ESTILOS_LAB_CELDA = {
    danger:  { bg:'rgba(248, 113, 113, 0.55)', color:'#450a0a', bold:true, shadow:'0 0 0 1px rgba(248,113,113,0.7)' },
    warning: { bg:'rgba(251, 191, 36, 0.55)', color:'#422006', bold:true, shadow:'0 0 0 1px rgba(251,191,36,0.65)' },
    success: { bg:'rgba(34, 197, 94, 0.45)',  color:'#064e3b', bold:true, shadow:'0 0 0 1px rgba(34,197,94,0.6)' },
    info:    { bg:'rgba(59, 130, 246, 0.4)',  color:'#1e3a8a', bold:true, shadow:'0 0 0 1px rgba(59,130,246,0.55)' }
  };

  const ESTILOS_LAB_FILA = {
    danger:  'rgba(248, 113, 113, 0.22)',
    warning: 'rgba(251, 191, 36, 0.22)',
    success: 'rgba(34, 197, 94, 0.18)'
  };

  const PRIORIDAD_SEVERIDAD = { danger:3, warning:2, success:1 };

  function limpiarEstiloCelda(cell){
    if(!cell) return;
    cell.style.removeProperty('background-color');
    cell.style.removeProperty('color');
    cell.style.removeProperty('font-weight');
    cell.style.removeProperty('border-radius');
    cell.style.removeProperty('box-shadow');
    if(cell.classList){
      cell.classList.remove(...CLASES_LAB_ESTADO);
    }
  }

  function aplicarEstiloCelda(cell, estado){
    if(!cell){
      return 'neutral';
    }
    limpiarEstiloCelda(cell);
    if(!estado || estado === 'neutral'){
      return 'neutral';
    }
    const estilo = ESTILOS_LAB_CELDA[estado];
    if(!estilo){
      return 'neutral';
    }
    if(cell.classList){
      cell.classList.add(`lab-estado-${estado}`);
    }
    cell.style.setProperty('background-color', estilo.bg, 'important');
    cell.style.setProperty('color', estilo.color, 'important');
    if(estilo.shadow){
      cell.style.setProperty('box-shadow', estilo.shadow, 'important');
    } else {
      cell.style.removeProperty('box-shadow');
    }

    if(estilo.bold){
      cell.style.setProperty('font-weight', '600', 'important');
    } else {
      cell.style.removeProperty('font-weight');
    }
    cell.style.borderRadius = '4px';
    return estado;
  }

  // Render hist√≥rico de controles con posibilidad de filtrar por meses
  function aplicarFiltrosYRenderControl(meses){
    console.log('[RENDER-CONTROL] aplicarFiltrosYRenderControl llamado con meses:', meses);
    console.log('[RENDER-CONTROL] _histControlRaw disponible:', _histControlRaw ? _histControlRaw.length : 'undefined');
    console.log('[RENDER-CONTROL] _histControlRaw primer elemento:', _histControlRaw?.[0]);
    
    const tbody = document.getElementById('hist-control-tbody');
    if(!tbody) {
      console.log('Error: no se encontr√≥ tbody hist-control-tbody');
      return;
    }
    
    let rows = [..._histControlRaw];
    console.log('[RENDER-CONTROL] Filas iniciales:', rows.length);
    console.log('[RENDER-CONTROL] Primera fila de datos:', rows[0]);
    
    if(meses){
      const corte = new Date(); corte.setMonth(corte.getMonth()-meses);
      console.log('[RENDER-CONTROL] Fecha de corte para', meses, 'meses:', corte);
      console.log('[RENDER-CONTROL] Primera fecha ejemplo:', rows[0]?.fecha, '=> Date:', new Date(rows[0]?.fecha));
      rows = rows.filter(r=> {
        if (!r.fecha) return false;
        const fechaRow = new Date(r.fecha);
        const incluir = fechaRow >= corte;
        if (!incluir) console.log('[RENDER-CONTROL] Filtrada:', r.fecha, fechaRow, '<', corte);
        return incluir;
      });
      console.log('[RENDER-CONTROL] Filas despu√©s del filtro de', meses, 'meses:', rows.length);
    }
    
    if(!rows.length){ 
      tbody.innerHTML='<tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; 
      console.log('No hay filas para mostrar');
      actualizarGraficosEvolucion([]);
      return; 
    }
    
    console.log('Generando HTML para', rows.length, 'filas');
    tbody.innerHTML = rows.map((c,idx)=>{
      const fechaFmt = formatearFechaCorta(c.fecha);
      const imcTexto = formatearIMCControl(c.imc);
      const imcAttr = imcTexto === '‚Äî' ? '' : imcTexto;
      return `<tr class="ctl-row" data-index="${idx}" style="border-top:1px solid #e2e8f0;">
          <td style="padding:4px;">${fechaFmt}</td>
          <td style="padding:4px;" data-psis="${c.presion_sistolica??''}" data-pdia="${c.presion_diastolica??''}">${c.presion_sistolica??'‚Äî'}/${c.presion_diastolica??'‚Äî'}</td>
          <td style="padding:4px;" data-imc="${imcAttr}">${imcTexto}</td>
          <td style="padding:4px;">${c.imc_clasificacion||'‚Äî'}</td>
          <td style="padding:4px;" data-hta="${c.hta_clasificacion||''}">${c.hta_clasificacion||'‚Äî'}</td>
          <td style="padding:4px;">${c.peso??'‚Äî'}</td>
          <td style="padding:4px;">${c.talla??'‚Äî'}</td>
          <td style="padding:4px;">${c.cc??'‚Äî'}</td>
          <td style="padding:4px;">${c.hgt??'‚Äî'}</td>
          <td style="padding:4px;" data-hba1c="${c.hba1c??''}">${c.hba1c??'‚Äî'}</td>
          <td style="padding:4px;" data-delta="1"></td>
        </tr>`;}).join('');
    
    console.log('HTML generado e insertado. Aplicando colores y tendencias...');
    colorearControles();
    calcularTendenciasControles(rows);
    actualizarGraficosEvolucion(rows);
    console.log('aplicarFiltrosYRenderControl completado');
  }

  // Render hist√≥rico de labs (tabla amplia) reutilizando _histLabsRaw
  function aplicarFiltrosYRenderLabs(meses){
    const tbody = document.getElementById('hist-labs-tbody');
    if(!tbody) return;
    let rows = [..._histLabsRaw];
    if(meses){
      const corte = new Date(); corte.setMonth(corte.getMonth()-meses);
      rows = rows.filter(r=> (r.examen_fecha||r.fecha_realizacion) && new Date(r.examen_fecha||r.fecha_realizacion) >= corte);
    }
    if(!rows.length){ tbody.innerHTML='<tr><td colspan="13" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; return; }
    function fmt(v){
      if(v===null || v===undefined || v==='') return '‚Äî';
      const asNum = Number(v);
      if(Number.isFinite(asNum)){
        return Math.abs(asNum) >= 100 ? asNum.toFixed(0) : asNum.toString();
      }
      return v;
    }
    tbody.innerHTML = rows.map((r,idx)=>{
      const fecha = r.examen_fecha || r.fecha_realizacion || r.fecha || '';
      const fechaFmt = formatearFechaCorta(fecha);
      const microAttrRaw = r.microalbuminuria_positiva;
      const microBase = r.microalbuminuria;
      const microVal = r.microalbuminuria_val;
      let microAttr = '';
      if(typeof microAttrRaw === 'boolean'){
        microAttr = microAttrRaw ? 'true' : 'false';
      } else if(microBase != null){
        microAttr = microBase;
      }
      let microTexto = '‚Äî';
      if(typeof microAttrRaw === 'boolean'){
        microTexto = microAttrRaw ? 'Positiva' : 'Negativa';
      } else if(typeof microBase === 'string' && microBase.trim()){
        microTexto = microBase.trim();
      } else if(Number.isFinite(Number(microBase))){
        microTexto = fmt(microBase);
      }
      if(microVal != null && microVal !== ''){
        const valFmt = fmt(microVal);
        microTexto = microTexto === '‚Äî' ? valFmt : `${microTexto} ${valFmt}`.trim();
      }
      return `<tr class="lab-row" data-index="${idx}" style="border-top:1px solid #e2e8f0;">
        <td style="padding:4px;">${fechaFmt}</td>
        <td style="padding:4px;" data-glicemia="${r.glicemia??''}">${fmt(r.glicemia)}</td>
        <td style="padding:4px;" data-hba1c="${r.hba1c??''}">${fmt(r.hba1c)}</td>
        <td style="padding:4px;" data-ldl="${r.ldl??''}">${fmt(r.ldl)}</td>
        <td style="padding:4px;" data-hdl="${r.hdl??''}">${fmt(r.hdl)}</td>
        <td style="padding:4px;" data-col="${r.col??''}">${fmt(r.col)}</td>
        <td style="padding:4px;" data-tag="${r.tag??''}">${fmt(r.tag)}</td>
        <td style="padding:4px;" data-creatinemia="${r.creatinemia??''}">${fmt(r.creatinemia)}</td>
        <td style="padding:4px;" data-vfg="${r.vfg??''}">${fmt(r.vfg)}</td>
        <td style="padding:4px;" data-rac="${r.rac??''}">${fmt(r.rac)}</td>
        <td style="padding:4px;" data-micro="${microAttr}">${microTexto}</td>
        <td style="padding:4px;" data-tsh="${r.tsh??''}">${fmt(r.tsh)}</td>
        <td style="padding:4px;" data-delta="1"></td>
      </tr>`;}).join('');
    colorearLabs();
    calcularTendenciasLabs(rows);
  }
  
  function colorearLabs(){
    const diab = usuarioTieneDiabetes();
    const sexo = obtenerSexoUsuario();
    document.querySelectorAll('#hist-labs-tbody tr.lab-row').forEach(tr=>{
      let severidadFila = '';

      const actualizarSeveridad = (estado)=>{
        if(!PRIORIDAD_SEVERIDAD[estado]) return;
        if(!severidadFila || PRIORIDAD_SEVERIDAD[estado] > PRIORIDAD_SEVERIDAD[severidadFila]){
          severidadFila = estado;
        }
      };

      const asignar = (cell, estado)=>{
        const aplicado = aplicarEstiloCelda(cell, estado);
        actualizarSeveridad(aplicado);
      };

      const glicemiaCell = tr.querySelector('[data-glicemia]');
      if(glicemiaCell){
        const val = valorNumerico(glicemiaCell.getAttribute('data-glicemia'));
        let estado = null;
        if(val !== null){
          if(val < 70){
            estado = 'danger';
          } else if(diab){
            if(val >= 180) estado = 'danger';
            else if(val >= 130) estado = 'warning';
            else if(val <= 120) estado = 'success';
          } else {
            if(val >= 140) estado = 'danger';
            else if(val >= 100) estado = 'warning';
            else if(val <= 110) estado = 'success';
          }
        }
        asignar(glicemiaCell, estado);
      }

      const hba1cCell = tr.querySelector('[data-hba1c]');
      if(hba1cCell){
        const val = valorNumerico(hba1cCell.getAttribute('data-hba1c'));
        let estado = null;
        if(val !== null){
          if(val >= 9) estado = 'danger';
          else if(val >= 7) estado = 'warning';
          else if(val >= 5.7) estado = 'success';
        }
        asignar(hba1cCell, estado);
      }

      const ldlCell = tr.querySelector('[data-ldl]');
      if(ldlCell){
        const val = valorNumerico(ldlCell.getAttribute('data-ldl'));
        let estado = null;
        if(val !== null){
          if(val >= 160) estado = 'danger';
          else if(val >= 130) estado = 'warning';
          else if(val <= 100) estado = 'success';
        }
        asignar(ldlCell, estado);
      }

      const hdlCell = tr.querySelector('[data-hdl]');
      if(hdlCell){
        const val = valorNumerico(hdlCell.getAttribute('data-hdl'));
        let estado = null;
        if(val !== null){
          const limiteBajo = sexo === 'f' ? 50 : (sexo === 'm' ? 40 : 45);
          if(val < limiteBajo) estado = 'danger';
          else if(val >= 60) estado = 'success';
        }
        asignar(hdlCell, estado);
      }

      const colCell = tr.querySelector('[data-col]');
      if(colCell){
        const val = valorNumerico(colCell.getAttribute('data-col'));
        let estado = null;
        if(val !== null){
          if(val >= 240) estado = 'danger';
          else if(val >= 200) estado = 'warning';
          else if(val < 200) estado = 'success';
        }
        asignar(colCell, estado);
      }

      const tagCell = tr.querySelector('[data-tag]');
      if(tagCell){
        const val = valorNumerico(tagCell.getAttribute('data-tag'));
        let estado = null;
        if(val !== null){
          if(val >= 200) estado = 'danger';
          else if(val >= 150) estado = 'warning';
          else if(val < 150) estado = 'success';
        }
        asignar(tagCell, estado);
      }

      const creaCell = tr.querySelector('[data-creatinemia]');
      if(creaCell){
        const val = valorNumerico(creaCell.getAttribute('data-creatinemia'));
        let estado = null;
        if(val !== null){
          const limite = sexo === 'f' ? 1.1 : (sexo === 'm' ? 1.3 : 1.2);
          if(val >= limite + 0.3) estado = 'danger';
          else if(val > limite) estado = 'warning';
          else if(val <= limite) estado = 'success';
        }
        asignar(creaCell, estado);
      }

      const vfgCell = tr.querySelector('[data-vfg]');
      if(vfgCell){
        const val = valorNumerico(vfgCell.getAttribute('data-vfg'));
        let estado = null;
        if(val !== null){
          if(val < 30) estado = 'danger';
          else if(val < 60) estado = 'warning';
          else if(val >= 60) estado = 'success';
        }
        asignar(vfgCell, estado);
      }

      const racCell = tr.querySelector('[data-rac]');
      if(racCell){
        const val = valorNumerico(racCell.getAttribute('data-rac'));
        let estado = null;
        if(val !== null){
          if(val >= 300) estado = 'danger';
          else if(val >= 30) estado = 'warning';
          else if(val > 0) estado = 'success';
        }
        asignar(racCell, estado);
      }

      const microCell = tr.querySelector('[data-micro]');
      if(microCell){
        const attr = (microCell.getAttribute('data-micro') || '').toString().toLowerCase();
        const txt = microCell.textContent.toLowerCase();
        let estado = null;
        if(attr === 'true' || attr === '1' || /positiva|s√≠|si/.test(txt)){
          estado = 'danger';
        } else if(/negativa/.test(txt) || attr === 'false'){
          estado = 'success';
        }
        asignar(microCell, estado);
      }

      const tshCell = tr.querySelector('[data-tsh]');
      if(tshCell){
        const val = valorNumerico(tshCell.getAttribute('data-tsh'));
        let estado = null;
        if(val !== null){
          if(val >= 10 || val < 0.1) estado = 'danger';
          else if(val >= 4.5 || val < 0.4) estado = 'warning';
        }
        asignar(tshCell, estado);
      }

      tr.classList.remove(...CLASES_LAB_FILA);
      if(severidadFila && CLASES_LAB_FILA.includes(`lab-row-${severidadFila}`)){
        tr.classList.add(`lab-row-${severidadFila}`);
      }
      if(severidadFila){
        const bg = ESTILOS_LAB_FILA[severidadFila] || '';
        if(bg){
          tr.style.setProperty('background-color', bg, 'important');
        } else {
          tr.style.removeProperty('background-color');
        }
      } else {
        tr.style.removeProperty('background-color');
      }
    });
  }
  
  function calcularTendenciasLabs(rows){
    const trs = document.querySelectorAll('#hist-labs-tbody tr.lab-row');
    rows.forEach((r,i)=>{
      if(i===rows.length-1) return;
      const prev = rows[i+1];
      const deltaLdl = (r.ldl!=null && prev.ldl!=null)? (parseFloat(r.ldl)-parseFloat(prev.ldl)) : null;
      const deltaHba = (r.hba1c!=null && prev.hba1c!=null)? (parseFloat(r.hba1c)-parseFloat(prev.hba1c)) : null;
      const cell = trs[i].querySelector('[data-delta]');
      if(!cell) return;
      let partes=[];
      if(deltaLdl!==null && Math.abs(deltaLdl)>=10) partes.push(arrowHTML(deltaLdl, 10, true));
      if(deltaHba!==null && Math.abs(deltaHba)>=0.3) partes.push(arrowHTML(deltaHba, 0.3, true));
      cell.innerHTML = partes.join(' ');
    });
  }
(async function initRiesgo(){
  const cont = document.getElementById('contenedor-patologias');
  if(!cont) return;
  let catalogo = [];
  let seleccion = new Set();
  let patologiasCargadasUsuario = new Set();
  let usuarioLimpioSeleccion = false; // Rastrear si el usuario limpi√≥ intencionalmente
  const buscador = document.getElementById('buscador-patologia');
  const btnCalc = document.getElementById('btn-calcular-riesgo');
  const btnAplicar = document.getElementById('btn-aplicar-riesgo');
  const btnGuardarPats = document.getElementById('btn-guardar-patologias');
  const btnSelectFiltradas = document.getElementById('btn-select-filtradas');
  const btnClearSel = document.getElementById('btn-clear-seleccion');
  const contadorSel = document.getElementById('contador-seleccion');
  const estadoPats = document.getElementById('estado-patologias');
  const riesgoSug = document.getElementById('riesgo-sugerido');
  const riesgoApl = document.getElementById('riesgo-aplicado');
  const riesgoRaz = document.getElementById('riesgo-razones');

  const toNumericId = (value) => {
    if (value === null || value === undefined || value === '') return null;
    const num = Number(value);
    return Number.isFinite(num) ? num : null;
  };

  const normalizeCie10 = (value) => {
    if (value === null || value === undefined) return '';
    return value.toString().trim().toUpperCase();
  };

  const stripCie10 = (value) => normalizeCie10(value).replace(/[^A-Z0-9]/g, '');

  const normalizeCatalogEntry = (raw = {}) => {
    const candidateId = raw.id ?? raw.patologia_id ?? raw.patologiaId;
    const idNum = toNumericId(candidateId);
    const cie10Upper = normalizeCie10(raw.cie10 || raw.codigo_cie10 || raw.CIE10 || raw.codigo);

    return {
      ...raw,
      id: idNum ?? candidateId ?? null,
      patologia_id: idNum ?? raw.patologia_id ?? raw.patologiaId ?? null,
      cie10: cie10Upper,
      cie10_sin_puntos: stripCie10(cie10Upper),
      nombre: (raw.nombre || raw.descripcion || '').toString().trim()
    };
  };

  const normalizeCatalogList = (lista = []) =>
    lista
      .map(normalizeCatalogEntry)
      .filter(item => item.id !== null && item.id !== undefined);

  const normalizeUsuarioPatologias = (lista = []) => lista.map(normalizeCatalogEntry);

  window.__riesgoUtils = Object.assign(window.__riesgoUtils || {}, {
    toNumericId,
    normalizeCie10,
    stripCie10,
    normalizeCatalogEntry,
    normalizeCatalogList,
    normalizeUsuarioPatologias
  });
  
  // Exponer referencias globales para uso externo (IA, etc.)
  window._riesgoSeleccion = seleccion;
  window._riesgoCatalogo = catalogo;
  window._riesgoRender = () => render();
  
  // Funci√≥n global para limpiar selecci√≥n al cargar nuevo usuario
  window._limpiarSeleccionRiesgo = () => {
    console.log('[üîé Riesgo] Limpiando selecci√≥n de patolog√≠as');
    seleccion.clear();
    usuarioLimpioSeleccion = false;
    render();
    actualizarBotones();
  };
  
  // Exponer funci√≥n eliminarYRecalcular globalmente para botones onclick
  window.eliminarYRecalcular = null; // Se asignar√° despu√©s de la definici√≥n

  function setEstado(msg,tipo='info'){
    estadoPats.textContent = msg||'';
    estadoPats.style.color = tipo==='error' ? '#b91c1c' : '#334155';
  }

  function actualizarBotones(){
    const selCount = seleccion.size;
    if(contadorSel) contadorSel.textContent = selCount ? `${selCount} seleccionada${selCount>1?'s':''}` : '';
    if(btnCalc) btnCalc.disabled = selCount === 0;
    if(btnAplicar) btnAplicar.disabled = selCount === 0;
    if(btnGuardarPats) btnGuardarPats.disabled = selCount === 0;
    if(btnClearSel) btnClearSel.disabled = selCount === 0;
  }

  // --- Persistencia autom√°tica de categor√≠a calculada ---
  let categoriaAutoSaveTimer = null;
  let ultimaFirmaPersistida = null;

  function persistirCategoriaCalculada(categoriaCalculada, puntajeTotal) {
  const categoriaLimpia = (categoriaCalculada || "").toString().trim().toUpperCase();
  const runInput = document.getElementById('run');
  const runVal = runInput?.value?.trim();

    if (!runVal) {
      console.warn('[üîí Categoria] RUN vac√≠o: se omite guardado autom√°tico');
      return;
    }

    void forzarProgramaModoECICEP(runVal);

    if (!categoriaLimpia || categoriaLimpia === '‚Äî' || categoriaLimpia === '-') {
      return;
    }

    // Solo persistir categor√≠as v√°lidas ECICEP (G0-G3)
    if (!['G0', 'G1', 'G2', 'G3'].includes(categoriaLimpia)) {
      console.warn('[üîí Categoria] Categor√≠a fuera de rango ECICEP:', categoriaLimpia);
      return;
    }

    const firma = `${runVal}|${categoriaLimpia}`;
    if (ultimaFirmaPersistida === firma) {
      return;
    }

    if (categoriaAutoSaveTimer) {
      clearTimeout(categoriaAutoSaveTimer);
    }

    categoriaAutoSaveTimer = setTimeout(async () => {
      try {
        console.log(`[üîí Categoria] Guardando categor√≠a ${categoriaLimpia} para ${runVal}`);
        const resp = await authFetch(`/api/usuarios/${encodeURIComponent(runVal)}/categoria`, {
          method: 'POST',
          body: JSON.stringify({
            categoria: categoriaLimpia,
            fuente: 'auto_calculo',
            puntaje: puntajeTotal
          })
        });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data && data.ok) {
          ultimaFirmaPersistida = firma;
          window.__ultimaCategoriaGuardada = categoriaLimpia;
          console.log(`[üîí Categoria] Categor√≠a ${categoriaLimpia} guardada correctamente`);
        } else {
          console.warn('[üîí Categoria] Error al guardar categor√≠a', data || resp.status);
        }
      } catch (error) {
        console.warn('[üîí Categoria] Excepci√≥n guardando categor√≠a', error);
      }
    }, 750);
  }

  // =====================================================================
  // FUNCI√ìN DE C√ÅLCULO DE RIESGO ECICEP (Reutilizable)
  // =====================================================================
  function calcularRiesgoECICEP() {
    console.log('[üîé Riesgo ECICEP] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('[üîé Riesgo ECICEP] INICIANDO C√ÅLCULO DE RIESGO');
    
    // USAR PATOLOG√çAS DEL USUARIO GUARDADAS (no checkboxes temporales)
    // Estas patolog√≠as se cargan desde la BD y se almacenan en window._patologiasUsuarioBD
    let patologiasParaCalcular = window._patologiasUsuarioBD || [];
    
    console.log('[üîé Riesgo ECICEP] Patolog√≠as del usuario (desde BD):', patologiasParaCalcular.length);
    console.log('[üîé Riesgo ECICEP] window._patologiasUsuarioBD completo:', JSON.stringify(window._patologiasUsuarioBD, null, 2));
    
    if (patologiasParaCalcular.length === 0) {
      console.warn('[üîé Riesgo ECICEP] No hay patolog√≠as guardadas del usuario');
      return { categoriaCalculada: 'G0', puntajeTotal: 0, descripcionCategoria: 'Sin riesgo' };
    }
    
    // =====================================================================
    // TABLA OFICIAL COMPLETA DE PONDERACIONES ECICEP
    // Basada en documento oficial "PROCESO DE ESTRATIFICACI√ìN EN PERSONAS DE 15 Y M√ÅS A√ëOS"
    // =====================================================================
    
    // ‚ö†Ô∏è PATOLOG√çAS CR√çTICAS - SOLO ESTAS VALEN 2 PUNTOS ‚ö†Ô∏è
    const patologiasCriticas = {
      // 1. Demencia (2 pts)
      'F00': 2, 'F000': 2, 'F001': 2, 'F002': 2, 'F009': 2,
      'F01': 2, 'F010': 2, 'F011': 2, 'F012': 2, 'F013': 2, 'F018': 2, 'F019': 2,
      'F02': 2, 'F020': 2, 'F021': 2, 'F022': 2, 'F023': 2, 'F024': 2, 'F028': 2,
      'F03': 2,
      
      // 2. Depresi√≥n grave / grave con ideaci√≥n suicida / refractaria / con psicosis (2 pts)
      'F332': 2, 'F333': 2,
      
      // 3. Diabetes mellitus (2 pts) - TODOS LOS TIPOS
      'E10': 2, 'E100': 2, 'E101': 2, 'E102': 2, 'E103': 2, 'E104': 2, 'E105': 2, 'E106': 2, 'E107': 2, 'E108': 2, 'E109': 2,
      'E11': 2, 'E110': 2, 'E111': 2, 'E112': 2, 'E113': 2, 'E114': 2, 'E115': 2, 'E116': 2, 'E117': 2, 'E118': 2, 'E119': 2,
      'E12': 2, 'E120': 2, 'E121': 2, 'E122': 2, 'E123': 2, 'E124': 2, 'E125': 2, 'E126': 2, 'E127': 2, 'E128': 2, 'E129': 2,
      'E13': 2, 'E130': 2, 'E131': 2, 'E132': 2, 'E133': 2, 'E134': 2, 'E135': 2, 'E136': 2, 'E137': 2, 'E138': 2, 'E139': 2,
      'E14': 2, 'E140': 2, 'E141': 2, 'E142': 2, 'E143': 2, 'E144': 2, 'E145': 2, 'E146': 2, 'E147': 2, 'E148': 2, 'E149': 2,
      
      // 4. Enfermedad cerebrovascular / ACV / AVE (2 pts)
      'G46': 2, 'G460': 2, 'G461': 2, 'G462': 2, 'G463': 2, 'G464': 2, 'G465': 2, 'G466': 2, 'G467': 2, 'G468': 2,
      'I64': 2,
      'I67': 2, 'I670': 2, 'I671': 2, 'I672': 2, 'I673': 2, 'I674': 2, 'I675': 2, 'I676': 2, 'I677': 2, 'I678': 2, 'I679': 2,
      'I68': 2, 'I680': 2, 'I681': 2, 'I682': 2, 'I688': 2,
      
      // 5. Enfermedad renal cr√≥nica avanzada (2 pts) - SOLO estadios 4, 5, 6
      'N184': 2, 'N185': 2, 'N186': 2,
      
      // 6. Enfermedades cardiovasculares / IAM / cardiopat√≠a isqu√©mica (2 pts)
      'I20': 2, 'I200': 2, 'I201': 2, 'I208': 2, 'I209': 2,
      'I21': 2, 'I210': 2, 'I211': 2, 'I212': 2, 'I213': 2, 'I214': 2, 'I215': 2, 'I216': 2, 'I217': 2, 'I218': 2, 'I219': 2,
      'I22': 2, 'I220': 2, 'I221': 2, 'I228': 2, 'I229': 2,
      'I25': 2, 'I250': 2, 'I251': 2, 'I252': 2, 'I253': 2, 'I254': 2, 'I255': 2, 'I256': 2, 'I257': 2, 'I258': 2, 'I259': 2,
      'I51': 2, 'I510': 2, 'I514': 2, 'I515': 2, 'I516': 2, 'I517': 2, 'I518': 2, 'I519': 2,
      'I52': 2, 'I520': 2, 'I521': 2, 'I528': 2,
      
      // 7. Esquizofrenia y trastornos psic√≥ticos relacionados (2 pts)
      'F20': 2, 'F200': 2, 'F201': 2, 'F202': 2, 'F203': 2, 'F204': 2, 'F205': 2, 'F206': 2, 'F207': 2, 'F208': 2, 'F209': 2,
      'F21': 2,
      'F22': 2, 'F220': 2, 'F228': 2, 'F229': 2,
      'F23': 2, 'F230': 2, 'F231': 2, 'F232': 2, 'F233': 2, 'F238': 2, 'F239': 2,
      
      // 8. Funci√≥n limitada / discapacidad / dependencia (2 pts)
      'R26': 2, 'R260': 2, 'R261': 2, 'R262': 2, 'R268': 2,
      'Z74': 2, 'Z740': 2, 'Z741': 2, 'Z742': 2, 'Z743': 2, 'Z748': 2, 'Z749': 2,
      'Z99': 2, 'Z990': 2, 'Z991': 2, 'Z992': 2, 'Z993': 2, 'Z998': 2, 'Z999': 2
    };
      
      // ‚úÖ TODAS LAS DEM√ÅS PATOLOG√çAS VALEN 1 PUNTO
      const patologiasStandard = {
        // Consumo perjudicial/dependiente de alcohol (1 pt)
        'F10': 1, 'F100': 1, 'F101': 1, 'F102': 1, 'F103': 1, 'F104': 1, 'F105': 1, 'F106': 1, 'F107': 1, 'F108': 1, 'F109': 1,
        'Y91': 1, 'Y912': 1, 'Y913': 1, 'Y919': 1,
        'Z71': 1, 'Z714': 1, 'Z716': 1,
        'Z72': 1, 'Z720': 1, 'Z721': 1,
        
        // Tabaquismo (1 pt)
        'F17': 1, 'F170': 1, 'F171': 1, 'F172': 1, 'F173': 1, 'F174': 1, 'F175': 1, 'F176': 1, 'F177': 1, 'F178': 1, 'F179': 1,
        'T65': 1, 'T652': 1,
        
        // Consumo perjudicial/dependiente de drogas (1 pt)
        'F11': 1, 'F110': 1, 'F111': 1, 'F112': 1, 'F113': 1, 'F114': 1, 'F115': 1, 'F116': 1, 'F117': 1, 'F118': 1, 'F119': 1,
        'F12': 1, 'F120': 1, 'F121': 1, 'F122': 1, 'F123': 1, 'F124': 1, 'F125': 1, 'F126': 1, 'F127': 1, 'F128': 1, 'F129': 1,
        'F13': 1, 'F130': 1, 'F131': 1, 'F132': 1, 'F133': 1, 'F134': 1, 'F135': 1, 'F136': 1, 'F137': 1, 'F138': 1, 'F139': 1,
        'F14': 1, 'F140': 1, 'F141': 1, 'F142': 1, 'F143': 1, 'F144': 1, 'F145': 1, 'F146': 1, 'F147': 1, 'F148': 1, 'F149': 1,
        'F15': 1, 'F150': 1, 'F151': 1, 'F152': 1, 'F153': 1, 'F154': 1, 'F155': 1, 'F156': 1, 'F157': 1, 'F158': 1, 'F159': 1,
        'F16': 1, 'F160': 1, 'F161': 1, 'F162': 1, 'F163': 1, 'F164': 1, 'F165': 1, 'F166': 1, 'F167': 1, 'F168': 1, 'F169': 1,
        'F18': 1, 'F180': 1, 'F181': 1, 'F182': 1, 'F183': 1, 'F184': 1, 'F185': 1, 'F186': 1, 'F187': 1, 'F188': 1, 'F189': 1,
        'F19': 1, 'F190': 1, 'F191': 1, 'F192': 1, 'F193': 1, 'F194': 1, 'F195': 1, 'F196': 1, 'F197': 1, 'F198': 1, 'F199': 1,
        
        // Anemia cr√≥nica (1 pt)
        'D50': 1,
        'D51': 1, 'D510': 1, 'D511': 1, 'D512': 1, 'D513': 1, 'D518': 1, 'D519': 1,
        'D52': 1, 'D520': 1, 'D521': 1, 'D528': 1, 'D529': 1,
        'D53': 1, 'D530': 1, 'D531': 1, 'D532': 1, 'D538': 1, 'D539': 1,
        'D55': 1, 'D550': 1, 'D551': 1, 'D552': 1, 'D553': 1, 'D558': 1, 'D559': 1,
        'D56': 1, 'D560': 1, 'D561': 1, 'D562': 1, 'D563': 1, 'D564': 1, 'D568': 1, 'D569': 1,
        'D57': 1, 'D570': 1, 'D571': 1, 'D572': 1, 'D573': 1, 'D578': 1,
        'D58': 1, 'D580': 1, 'D581': 1, 'D582': 1, 'D588': 1, 'D589': 1,
        'D59': 1, 'D590': 1, 'D591': 1, 'D592': 1, 'D593': 1, 'D594': 1, 'D595': 1, 'D596': 1, 'D598': 1, 'D599': 1,
        'D60': 1, 'D600': 1, 'D601': 1, 'D608': 1, 'D609': 1,
        'D61': 1, 'D610': 1, 'D611': 1, 'D612': 1, 'D613': 1, 'D618': 1, 'D619': 1,
        'D62': 1,
        'D63': 1, 'D630': 1, 'D638': 1,
        'D64': 1, 'D640': 1, 'D641': 1, 'D642': 1, 'D643': 1, 'D644': 1, 'D648': 1, 'D649': 1,
        
        // Trastornos alimentarios (1 pt)
        'F50': 1, 'F500': 1, 'F501': 1, 'F502': 1, 'F503': 1, 'F504': 1, 'F505': 1, 'F508': 1, 'F509': 1,
        
        // Artritis REUMATOIDEA (1 pt)
        'M05': 1, 'M050': 1, 'M051': 1, 'M052': 1, 'M053': 1, 'M058': 1, 'M059': 1,
        'M06': 1, 'M060': 1, 'M061': 1, 'M062': 1, 'M063': 1, 'M064': 1, 'M068': 1, 'M069': 1,
        
        // Artrosis de rodilla, cadera u otro tipo (1 pt)
        'M15': 1, 'M150': 1, 'M151': 1, 'M152': 1, 'M153': 1, 'M154': 1, 'M158': 1, 'M159': 1,
        'M16': 1, 'M160': 1, 'M161': 1, 'M162': 1, 'M163': 1, 'M164': 1, 'M165': 1, 'M166': 1, 'M167': 1, 'M169': 1,
        'M17': 1, 'M170': 1, 'M171': 1, 'M172': 1, 'M173': 1, 'M174': 1, 'M175': 1, 'M179': 1,
        'M18': 1, 'M180': 1, 'M181': 1, 'M182': 1, 'M183': 1, 'M184': 1, 'M185': 1, 'M189': 1,
        'M19': 1, 'M190': 1, 'M191': 1, 'M192': 1, 'M199': 1,
        
        // Asma (1 pt)
        'J45': 1, 'J450': 1, 'J451': 1, 'J458': 1, 'J459': 1,
        'J46': 1,
        
        // Catarata/Retinopat√≠a (1 pt)
        'H25': 1, 'H250': 1, 'H251': 1, 'H252': 1, 'H258': 1, 'H259': 1,
        'H26': 1, 'H260': 1, 'H261': 1, 'H262': 1, 'H263': 1,
        
        // Alzheimer y otras demencias (1 pt) - NO CONFUNDIR con Demencia (2 pts) que es F00-F03
        'G30': 1, 'G300': 1, 'G301': 1, 'G308': 1, 'G309': 1,
        
        // Dependencia del ox√≠geno (1 pt) - NOTA: Z99 tambi√©n est√° en dependencia (2 pts), prioridad a 2 pts
        
        // Discapacidad visual bilateral (1 pt)
        'H54': 1, 'H540': 1, 'H541': 1, 'H542': 1, 'H543': 1, 'H544': 1, 'H545': 1, 'H546': 1, 'H547': 1,
        
        // Dislipidemias (1 pt)
        'E78': 1, 'E780': 1, 'E781': 1, 'E782': 1, 'E783': 1, 'E784': 1, 'E785': 1, 'E786': 1, 'E788': 1, 'E789': 1,
        
        // TIA / Isquemia cerebral transitoria (1 pt) - NO confundir con ACV (2 pts)
        'G45': 1, 'G450': 1, 'G451': 1, 'G452': 1, 'G453': 1, 'G454': 1, 'G458': 1, 'G459': 1,
        
        // #14: Discapacidad visual bilateral (1 pt)
        'H54': 1, 'H540': 1, 'H541': 1, 'H542': 1, 'H543': 1, 'H544': 1, 'H545': 1, 'H546': 1, 'H547': 1,
        
        // #15: Discapacidad auditiva (1 pt) - similar a #43 Presbiacusia
        
        // #16: Dislipidemias (1 pt)
        'E78': 1, 'E780': 1, 'E781': 1, 'E782': 1, 'E783': 1, 'E784': 1, 'E785': 1, 'E786': 1, 'E788': 1, 'E789': 1,
        
        // #18: Isquemia cerebral transitoria (TIA) (1 pt) - Ya incluido en cr√≠ticas si es G45
        
        // #19: Enfermedad hep√°tica (1 pt)
        'B18': 1, 'B180': 1, 'B181': 1, 'B182': 1, 'B188': 1, 'B189': 1,
        'K70': 1, 'K700': 1, 'K701': 1, 'K702': 1, 'K703': 1, 'K704': 1, 'K709': 1,
        'K71': 1, 'K710': 1, 'K711': 1, 'K712': 1, 'K713': 1, 'K714': 1, 'K715': 1, 'K716': 1, 'K717': 1, 'K718': 1, 'K719': 1,
        'K72': 1, 'K721': 1,
        'K73': 1, 'K730': 1, 'K731': 1, 'K732': 1, 'K738': 1, 'K739': 1,
        'K74': 1, 'K740': 1, 'K741': 1, 'K742': 1, 'K743': 1, 'K744': 1, 'K745': 1, 'K746': 1,
        
        // #20: Enfermedad pulmonar obstructiva cr√≥nica (EPOC) (1 pt)
        'J41': 1, 'J410': 1, 'J411': 1, 'J418': 1,
        'J42': 1,
        'J43': 1, 'J431': 1, 'J432': 1, 'J438': 1, 'J439': 1,
        'J44': 1, 'J440': 1, 'J441': 1, 'J448': 1, 'J449': 1,
        
        // #21: Enfermedad renal cr√≥nica (1 pt) - SOLO estadios 1-3a
        'N15': 1, 'N150': 1, 'N151': 1, 'N158': 1, 'N159': 1,
        'N18': 1, 'N180': 1, 'N181': 1, 'N182': 1, 'N183': 1, 'N189': 1,
        'N19': 1, 'N190': 1, 'N191': 1, 'N198': 1, 'N199': 1,
        
        // #24: Enteritis cr√≥nica/colitis ulcerosa/Crohn (1 pt)
        'K50': 1, 'K500': 1, 'K501': 1, 'K509': 1, 'K508': 1,
        'K51': 1, 'K510': 1, 'K511': 1, 'K518': 1, 'K519': 1, 'K512': 1, 'K513': 1, 'K528': 1, 'K529': 1,
        'K52': 1, 'K520': 1, 'K521': 1, 'K522': 1, 'K523': 1, 'K528': 1, 'K529': 1,
        
        // #25: Epilepsia (1 pt)
        'G40': 1, 'G400': 1, 'G401': 1, 'G402': 1, 'G403': 1, 'G404': 1, 'G406': 1, 'G408': 1, 'G409': 1, 'G407': 1,
        
        // #26: Esclerosis m√∫ltiple (1 pt)
        'G35': 1,
        
        // #28: Fibrilaci√≥n auricular/flutter (1 pt)
        'I48': 1, 'I480': 1, 'I481': 1, 'I482': 1, 'I483': 1, 'I484': 1, 'I489': 1,
        
        // #30: Glaucoma (1 pt)
        'H40': 1, 'H401': 1, 'H402': 1, 'H403': 1, 'H404': 1, 'H405': 1, 'H406': 1, 'H408': 1, 'H409': 1,
        'H42': 1, 'H420': 1, 'H428': 1,
        
        // #31: Hiperuricemia (1 pt)
        'M10': 1,
        
        // #32: Hipertensi√≥n (1 pt) - TODOS los c√≥digos
        'I10': 1, 'I100': 1, 'I109': 1,
        'I11': 1, 'I110': 1, 'I119': 1,
        'I12': 1, 'I120': 1, 'I129': 1,
        'I13': 1, 'I130': 1, 'I131': 1, 'I132': 1, 'I139': 1,
        
        // Insuficiencia card√≠aca (1 pt) - NO confundir con IAM/cardiopat√≠a isqu√©mica (2 pts)
        'I50': 1, 'I500': 1, 'I501': 1, 'I509': 1,
        
        // Hipertrofia prost√°tica benigna (1 pt)
        'N40': 1,
        
        // #34: Trastornos tiroideos (1 pt)
        'E01': 1, 'E010': 1, 'E011': 1, 'E012': 1,
        'E02': 1,
        'E03': 1, 'E030': 1, 'E031': 1, 'E032': 1, 'E033': 1, 'E034': 1, 'E035': 1, 'E038': 1, 'E039': 1,
        'E05': 1, 'E050': 1, 'E051': 1, 'E052': 1, 'E053': 1, 'E054': 1, 'E055': 1, 'E058': 1, 'E059': 1,
        
        // #35: Infecci√≥n por VIH/SIDA (1 pt)
        'B21': 1, 'B210': 1, 'B211': 1, 'B212': 1, 'B213': 1, 'B217': 1, 'B218': 1, 'B219': 1,
        'B22': 1, 'B220': 1, 'B221': 1, 'B222': 1, 'B227': 1,
        'B23': 1, 'B230': 1, 'B231': 1, 'B232': 1, 'B238': 1,
        'B24': 1,
        
        // #37: Lupus (1 pt)
        'L93': 1, 'L930': 1, 'L931': 1, 'L932': 1,
        'M32': 1, 'M320': 1, 'M321': 1, 'M328': 1, 'M329': 1,
        
        // #38: Malignidad/Neoplasia/Tumor maligno/C√°ncer (1 pt)
        'C': 1, // Todos los C00-C97
        'D48': 1,
        
        // #39: Maltrato f√≠sico/psicol√≥gico/violencia/abuso sexual (1 pt)
        'T74': 1, 'T740': 1, 'T741': 1, 'T742': 1, 'T743': 1, 'T748': 1, 'T749': 1,
        'Y07': 1, 'Y070': 1, 'Y071': 1, 'Y072': 1, 'Y073': 1, 'Y078': 1, 'Y079': 1,
        
        // #40: Dolor neurop√°tico/fibromialgia (1 pt)
        'G50': 1, 'G500': 1, 'G501': 1, 'G508': 1, 'G509': 1,
        'M79': 1, 'M797': 1,
        
        // #41: Obesidad (1 pt)
        'E66': 1, 'E660': 1, 'E661': 1, 'E662': 1, 'E669': 1, 'E668': 1,
        
        // #42: Parkinsonismo (1 pt)
        'G20': 1,
        'G21': 1, 'G211': 1,
        'G22': 1,
        'G23': 1, 'G230': 1, 'G231': 1, 'G232': 1, 'G238': 1, 'G239': 1,
        'G24': 1, 'G240': 1, 'G241': 1, 'G242': 1, 'G244': 1, 'G245': 1, 'G248': 1, 'G249': 1,
        'G25': 1, 'G252': 1, 'G253': 1, 'G254': 1, 'G255': 1,
        'G26': 1,
        
        // #43: Presbiacusia/Hipoacusia/Sordera (1 pt)
        'H90': 1, 'H900': 1, 'H901': 1, 'H902': 1, 'H903': 1, 'H904': 1, 'H905': 1, 'H906': 1, 'H907': 1, 'H908': 1,
        'H91': 1, 'H910': 1, 'H911': 1, 'H912': 1, 'H918': 1, 'H919': 1, 'H913': 1,
        
        // #44: Trastornos de la coagulaci√≥n (1 pt)
        'D68': 1, 'D680': 1, 'D681': 1, 'D682': 1, 'D684': 1, 'D688': 1, 'D689': 1,
        'D69': 1, 'D690': 1, 'D692': 1, 'D694': 1, 'D696': 1, 'D698': 1, 'D699': 1,
        'D75': 1, 'D750': 1, 'D758': 1, 'D759': 1,
        'D77': 1,
        
        // #45: Retraso mental (1 pt)
        'F70': 1, 'F700': 1, 'F701': 1, 'F708': 1, 'F709': 1,
        'F71': 1, 'F710': 1, 'F711': 1, 'F718': 1, 'F719': 1,
        'F72': 1, 'F720': 1, 'F721': 1, 'F728': 1, 'F729': 1,
        'F73': 1, 'F730': 1, 'F731': 1, 'F738': 1, 'F739': 1,
        'F78': 1, 'F780': 1, 'F781': 1, 'F788': 1, 'F789': 1,
        'F79': 1, 'F790': 1, 'F791': 1, 'F798': 1, 'F799': 1,
        
        // #46: Arritmia card√≠aca/Taquicardia parox√≠stica (1 pt)
        'I47': 1, 'I470': 1, 'I471': 1, 'I472': 1, 'I479': 1,
        'I49': 1, 'I490': 1, 'I498': 1, 'I499': 1,
        
        // #47: Trastorno Ansioso (1 pt)
        'F40': 1, 'F400': 1, 'F401': 1, 'F402': 1, 'F408': 1, 'F409': 1,
        'F41': 1, 'F410': 1, 'F411': 1, 'F412': 1, 'F413': 1, 'F418': 1, 'F419': 1,
        'F42': 1, 'F422': 1, 'F429': 1, 'F428': 1,
        
        // #48: Trastorno de la personalidad (1 pt)
        'F60': 1, 'F600': 1, 'F601': 1, 'F602': 1, 'F603': 1, 'F604': 1, 'F605': 1, 'F606': 1, 'F607': 1, 'F608': 1, 'F609': 1,
        'F61': 1,
        'F62': 1, 'F620': 1, 'F621': 1, 'F628': 1, 'F629': 1,
        'F68': 1, 'F680': 1,
        'F69': 1,
        
        // Trastornos del sue√±o (1 pt)
        'F51': 1, 'F510': 1, 'F511': 1, 'F512': 1, 'F514': 1, 'F519': 1, 'F518': 1,
        'G47': 1, 'G473': 1, 'G474': 1, 'G478': 1, 'G479': 1,
        
        // Trastornos depresivos LEVES/MODERADOS (1 pt) - NO incluye F33.2 y F33.3 que son 2 pts
        'F31': 1, 'F310': 1, 'F311': 1, 'F312': 1, 'F313': 1, 'F314': 1, 'F315': 1, 'F316': 1, 'F317': 1, 'F318': 1, 'F319': 1,
        'F32': 1, 'F320': 1, 'F321': 1, 'F322': 1, 'F323': 1, 'F328': 1, 'F329': 1,
        'F33': 1, 'F330': 1, 'F331': 1, 'F334': 1, 'F338': 1, 'F339': 1, // F33.2 y F33.3 NO est√°n aqu√≠ (son 2 pts)
        'F34': 1, 'F340': 1, 'F341': 1, 'F348': 1, 'F349': 1,
        'F63': 1, 'F630': 1, 'F632': 1, 'F638': 1, 'F639': 1,
        'F66': 1, 'F661': 1, 'F662': 1, 'F668': 1, 'F669': 1,
        
        // #51: Tuberculosis (1 pt)
        'A15': 1, 'A150': 1, 'A151': 1, 'A152': 1, 'A153': 1, 'A154': 1, 'A155': 1, 'A157': 1, 'A158': 1, 'A159': 1, 'A156': 1,
        'A17': 1, 'A170': 1, 'A171': 1, 'A178': 1, 'A179': 1,
        'A18': 1, 'A180': 1, 'A181': 1, 'A182': 1, 'A183': 1, 'A184': 1, 'A185': 1, 'A186': 1, 'A187': 1, 'A188': 1,
        'A19': 1, 'A190': 1, 'A191': 1, 'A192': 1, 'A198': 1, 'A199': 1,
        
        // #52: √ölcera cr√≥nica de la piel (1 pt)
        'I83': 1, 'I830': 1, 'I831': 1, 'I832': 1, 'I839': 1,
        'L97': 1,
        'L98': 1, 'L984': 1
      };
      
      // =====================================================================
      // C√ÅLCULO DE PUNTAJE TOTAL
      // =====================================================================
      
      let puntajeTotal = 0;
      let detallePatologias = [];
      let tieneCriticas = false;
      
      for (const pat of patologiasParaCalcular) {
        // Acceso robusto a propiedades (puede venir como cie10/CIE10/codigo_cie10)
        const cie10Raw = pat.cie10 || pat.CIE10 || pat.codigo_cie10 || '';
        const nombrePat = pat.nombre || pat.NOMBRE || pat.nombre_patologia || 'Sin nombre';
        
        const cie10Normalizado = cie10Raw.replace(/\./g, '').toUpperCase();
        const cie10Base = cie10Normalizado.substring(0, 3); // Primeros 3 caracteres (ej: I50, E11, N18)
        
        console.log(`[üîé ECICEP] Analizando: ${cie10Raw} ‚Üí Base: ${cie10Base} ‚Üí Nombre: ${nombrePat}`);
        console.log(`[üîé ECICEP] Objeto completo:`, pat);
        
        // Buscar en patolog√≠as cr√≠ticas (2 puntos)
        let puntos = 0;
        let categoria = '';
        
        if (patologiasCriticas[cie10Base] || patologiasCriticas[cie10Normalizado]) {
          puntos = 2;
          categoria = '‚ö†Ô∏è CR√çTICA';
          tieneCriticas = true;
          console.log(`  ‚úÖ CR√çTICA: ${cie10Base} = 2 puntos`);
        }
        // Buscar en patolog√≠as est√°ndar (1 punto)
        else if (patologiasStandard[cie10Base] || patologiasStandard[cie10Normalizado]) {
          puntos = 1;
          categoria = 'Moderada';
          console.log(`  ‚úÖ MODERADA: ${cie10Base} = 1 punto`);
        }
        // Patolog√≠as no catalogadas NO CUENTAN (0 puntos)
        else {
          puntos = 0;
          categoria = 'No catalogada';
          console.log(`  ‚ö†Ô∏è NO CATALOGADA: ${cie10Base} = 0 puntos (no suma al total)`);
        }
        
        // Solo agregar al total y al detalle si tiene puntos
        if (puntos > 0) {
          puntajeTotal += puntos;
          detallePatologias.push(`‚Ä¢ ${cie10Raw}: ${nombrePat} [${puntos} pt${puntos !== 1 ? 's' : ''} - ${categoria}]`);
        } else {
          console.log(`  ‚è≠Ô∏è Omitida del c√°lculo (no catalogada)`);
        }
      }
      
      console.log(`[üîé ECICEP] Puntaje total: ${puntajeTotal} puntos`);
      console.log(`[üîé ECICEP] Tiene patolog√≠as cr√≠ticas (2 pts): ${tieneCriticas}`);
      console.log(`[üîé ECICEP] Detalle patolog√≠as catalogadas (${detallePatologias.length}):`, detallePatologias);
      
      // Advertencia si no hay patolog√≠as catalogadas
      if (detallePatologias.length === 0 && patologiasParaCalcular.length > 0) {
        console.warn(`‚ö†Ô∏è [üîé ECICEP] ADVERTENCIA: El usuario tiene ${patologiasParaCalcular.length} patolog√≠as pero NINGUNA est√° en el cat√°logo ECICEP`);
        console.warn(`‚ö†Ô∏è [üîé ECICEP] Patolog√≠as del usuario:`, patologiasParaCalcular.map(p => {
          const cie10Raw = p.cie10 || p.CIE10 || p.codigo_cie10 || '';
          const nombrePat = p.nombre || p.NOMBRE || p.nombre_patologia || 'Sin nombre';
          return `${cie10Raw} - ${nombrePat}`;
        }));
      }
      
      // =====================================================================
      // CLASIFICACI√ìN SEG√öN PUNTAJE (Algoritmo oficial ECICEP)
      // =====================================================================
      
      let categoriaCalculada = 'G0';
      let descripcionCategoria = '';
      
      console.log('[üîé ECICEP] Aplicando clasificaci√≥n...');
      
      if (puntajeTotal === 0) {
        categoriaCalculada = 'G0';
        descripcionCategoria = detallePatologias.length === 0 && patologiasParaCalcular.length > 0 
          ? 'Patolog√≠as no catalogadas en ECICEP' 
          : 'Sin riesgo';
        console.log('  ‚Üí G0: Puntaje = 0');
      } else if (puntajeTotal === 1) {
        categoriaCalculada = 'G1';
        descripcionCategoria = 'Riesgo BAJO (1 condici√≥n)';
        console.log('  ‚Üí G1: Puntaje = 1');
      } else if (puntajeTotal >= 2 && puntajeTotal <= 4) {
        categoriaCalculada = 'G2';
        descripcionCategoria = 'Riesgo MODERADO (2-4 puntos)';
        console.log(`  ‚Üí G2: Puntaje entre 2 y 4 (actual: ${puntajeTotal})`);
      } else if (puntajeTotal >= 5) {
        categoriaCalculada = 'G3';
        descripcionCategoria = 'Riesgo ALTO (5+ puntos)';
        console.log(`  ‚Üí G3: Puntaje >= 5 (actual: ${puntajeTotal})`);
      }
      
      // Regla especial: Si tiene al menos UNA patolog√≠a cr√≠tica (2 pts), m√≠nimo G2
      if (tieneCriticas && categoriaCalculada === 'G1') {
        categoriaCalculada = 'G2';
        descripcionCategoria = 'Riesgo MODERADO (por patolog√≠a cr√≠tica)';
      }
      
      console.log(`[üîé ECICEP] Categor√≠a calculada: ${categoriaCalculada} - ${descripcionCategoria}`);
      
      // =====================================================================
      // ACTUALIZAR UI CON RESULTADO
      // =====================================================================
      
      // Mostrar en badge "Actual:"
      const badgeActual = document.getElementById('riesgo-actual');
      if (badgeActual) {
        badgeActual.textContent = categoriaCalculada;
        badgeActual.className = 'badge-riesgo';
        
        // Aplicar colores seg√∫n categor√≠a
        if (categoriaCalculada === 'G3') {
          badgeActual.classList.add('badge-g3');
        } else if (categoriaCalculada === 'G2') {
          badgeActual.classList.add('badge-g2');
        } else if (categoriaCalculada === 'G1') {
          badgeActual.classList.add('badge-g1');
        } else {
          badgeActual.classList.add('badge-neutro');
        }
      }
      
      // Mostrar en badge "Calculado:"
      const badgeCalculado = document.getElementById('riesgo-calculado');
      if (badgeCalculado) {
        badgeCalculado.textContent = categoriaCalculada;
        badgeCalculado.className = 'badge-riesgo';
        
        // Aplicar colores seg√∫n categor√≠a
        if (categoriaCalculada === 'G3') {
          badgeCalculado.classList.add('badge-g3');
        } else if (categoriaCalculada === 'G2') {
          badgeCalculado.classList.add('badge-g2');
        } else if (categoriaCalculada === 'G1') {
          badgeCalculado.classList.add('badge-g1');
        } else {
          badgeCalculado.classList.add('badge-neutro');
        }
      }
      
      // Actualizar puntos de riesgo
      const puntosRiesgo = document.getElementById('puntos-riesgo');
      if (puntosRiesgo) {
        puntosRiesgo.innerHTML = `<strong>Puntos: ${puntajeTotal.toFixed(1)}</strong> (${patologiasParaCalcular.length} patolog√≠a${patologiasParaCalcular.length !== 1 ? 's' : ''})`;
      }
      
      // Actualizar detalle de c√°lculo
      const detalleCalculo = document.getElementById('detalle-calculo');
      if (detalleCalculo) {
        detalleCalculo.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px; color: ${
            categoriaCalculada === 'G3' ? '#b91c1c' : 
            categoriaCalculada === 'G2' ? '#d97706' : 
            categoriaCalculada === 'G1' ? '#15803d' : '#64748b'
          }; font-size: 0.85rem;">
            ${categoriaCalculada}: ${descripcionCategoria}
          </div>
          <div style="font-size: 0.7rem; line-height: 1.5; max-height: 200px; overflow-y: auto;">
            ${detallePatologias.join('<br>')}
          </div>
        `;
      }
      
      // Actualizar badge principal de riesgo en resumen
      if (typeof window.actualizarBadgeRiesgo === 'function') {
        window.actualizarBadgeRiesgo(categoriaCalculada);
        console.log('[üîé ECICEP] Badge principal actualizado');
      }
      
      // Actualizar input categoria en formulario principal
      const inputCategoria = document.getElementById('categoria');
      if (inputCategoria) {
        inputCategoria.value = categoriaCalculada;
      }
      
      // Actualizar [data-f="categoria_nombre"] en resumen
      const categoriaResumen = document.querySelector('[data-f="categoria_nombre"]');
      if (categoriaResumen) {
        categoriaResumen.textContent = categoriaCalculada;
      }
      
      // Mostrar mensaje de estado
      setEstado(`‚úÖ ${categoriaCalculada}: ${descripcionCategoria} (${puntajeTotal.toFixed(1)} puntos)`, 'info');
      
      // Notificaci√≥n visual flotante
      const notif = document.createElement('div');
      notif.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 4px;">‚úÖ C√°lculo Completado</div>
        <div>${categoriaCalculada}: ${descripcionCategoria}</div>
        <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 4px;">
          ${puntajeTotal.toFixed(1)} puntos ¬∑ ${patologiasParaCalcular.length} patolog√≠a${patologiasParaCalcular.length !== 1 ? 's' : ''}
        </div>
      `;
      notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${categoriaCalculada === 'G3' ? '#dc2626' : categoriaCalculada === 'G2' ? '#f59e0b' : '#10b981'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 0.85rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        line-height: 1.4;
        max-width: 300px;
      `;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 4500);
      
      console.log('[üîé ECICEP] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('[üîé ECICEP] RESULTADO FINAL');
      console.log('[üîé ECICEP] Categor√≠a:', categoriaCalculada);
      console.log('[üîé ECICEP] Puntaje:', puntajeTotal);
      console.log('[üîé ECICEP] Descripci√≥n:', descripcionCategoria);
      console.log('[üîé ECICEP] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      
    // Guardar autom√°ticamente la categor√≠a calculada en el backend
    persistirCategoriaCalculada(categoriaCalculada, puntajeTotal);
      
      // Retornar resultado del c√°lculo
      return { categoriaCalculada, puntajeTotal, descripcionCategoria, detallePatologias, patologiasSeleccionadas: patologiasParaCalcular };
  }
  
  // Exponer funci√≥n globalmente
  window.calcularRiesgoECICEP = calcularRiesgoECICEP;
  
  // Event listener para el bot√≥n calcular
  if (btnCalc) {
    btnCalc.addEventListener('click', () => {
      if (seleccion.size === 0) {
        alert('Debe seleccionar al menos una patolog√≠a para calcular el riesgo');
        return;
      }
      calcularRiesgoECICEP();
    });
  }

  function render(){
    const q = (buscador.value||'').toLowerCase();
    cont.innerHTML='';
    
    // Filtrar patolog√≠as
    let filtrados = catalogo.filter(p=> 
      !q || 
      p.nombre.toLowerCase().includes(q) || 
      (p.cie10 && p.cie10.toLowerCase().includes(q))
    );

    const coincidencias = filtrados.length;
    const idsImportantes = new Set([...seleccion, ...patologiasCargadasUsuario]);
    const extras = [];

    if (idsImportantes.size) {
      const idsExistentes = new Set(filtrados.map(p => p.id));
      idsImportantes.forEach(id => {
        if (id === null || id === undefined) return;
        if (!idsExistentes.has(id)) {
          const pat = catalogo.find(p => p.id === id);
          if (pat) {
            extras.push(pat);
            idsExistentes.add(id);
          }
        }
      });
      if (extras.length) {
        filtrados = [...extras, ...filtrados];
      }
    }
    
    if(!filtrados.length){ 
      cont.innerHTML = `
        <div style="
          text-align: center; 
          padding: 20px; 
          color: #6b7280; 
          font-style: italic;
          border: 2px dashed #e5e7eb;
          border-radius: 8px;
          background: #f9fafb;
        ">
          ${q ? (idsImportantes.size ? 'Mostrando patolog√≠as guardadas sin coincidencias exactas' : `No se encontraron patolog√≠as que coincidan con "${q}"`) : 'Sin patolog√≠as disponibles'}
        </div>
      `; 
      return;
    }
    
    // Mostrar contador de resultados si hay filtro
    if (q) {
      const contadorDiv = document.createElement('div');
      contadorDiv.style.cssText = `
        font-size: 0.7rem;
        color: #6b7280;
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 4px;
        margin-bottom: 8px;
        text-align: center;
      `;
      let textoResultados;
      if (coincidencias === 0 && extras.length) {
        textoResultados = `Sin coincidencias exactas para "${q}" ¬∑ mostrando ${extras.length} patolog√≠a${extras.length !== 1 ? 's' : ''} guardada${extras.length !== 1 ? 's' : ''}`;
      } else {
        textoResultados = `${coincidencias} coincidencia${coincidencias !== 1 ? 's' : ''}`;
        if (extras.length) {
          textoResultados += ` + ${extras.length} guardada${extras.length !== 1 ? 's' : ''}`;
        }
      }
      contadorDiv.textContent = textoResultados;
      cont.appendChild(contadorDiv);
    }
    
    // Limitar resultados para rendimiento
    const maxResultados = 200;
    let mostrar = filtrados.slice(0, maxResultados);

    if (idsImportantes.size) {
      const idsEnPantalla = new Set(mostrar.map(p => p.id));
      const extrasPantalla = [];
      idsImportantes.forEach(id => {
        if (id === null || id === undefined) return;
        if (!idsEnPantalla.has(id)) {
          const pat = catalogo.find(p => p.id === id);
          if (pat) {
            extrasPantalla.push(pat);
            idsEnPantalla.add(id);
          }
        }
      });
      if (extrasPantalla.length) {
        mostrar = [...extrasPantalla, ...mostrar];
      }
    }
    
    mostrar.forEach((p, index) => {
      const wrap = document.createElement('label');
      wrap.className = 'pat-row';
      
      const estaSel = seleccion.has(p.id);
      const yaExiste = patologiasCargadasUsuario.has(p.id);
      
      wrap.style.cssText = `
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 2px;
        border: 1px solid ${estaSel ? '#10b981' : yaExiste ? '#0ea5e9' : '#e5e7eb'};
        background: ${estaSel ? 'rgba(16, 185, 129, 0.1)' : yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff'};
        transition: all 0.2s ease;
        font-size: 0.75rem;
      `;
      
      // Resaltar t√©rminos de b√∫squeda
      let nombreDisplay = p.nombre;
      let cie10Display = p.cie10 || '';
      
      if (q) {
        const regex = new RegExp(`(${q})`, 'gi');
        nombreDisplay = nombreDisplay.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px; border-radius: 2px;">$1</mark>');
        cie10Display = cie10Display.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px; border-radius: 2px;">$1</mark>');
      }
      
      wrap.innerHTML = `
        <input type="checkbox" data-id="${p.id}" data-cie10="${p.cie10 || ''}" style="margin: 0; transform: scale(1.1);">
        <div style="flex: 1; line-height: 1.3;">
          <div style="color: #1f2937; font-weight: 500;">
            ${nombreDisplay}
          </div>
          ${cie10Display ? `<div style="color: #6b7280; font-size: 0.65rem; margin-top: 2px;">
            <strong>CIE-10:</strong> ${cie10Display}
          </div>` : ''}
        </div>
        ${yaExiste ? '<span style="background: #0ea5e9; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px;">YA TIENE</span>' : ''}
      `;
      
      const cb = wrap.querySelector('input');
      cb.checked = estaSel;
      
      // Eventos
      wrap.addEventListener('mouseover', () => {
        if (!estaSel) {
          wrap.style.background = '#f9fafb';
          wrap.style.borderColor = '#d1d5db';
        }
      });
      
      wrap.addEventListener('mouseout', () => {
        wrap.style.background = estaSel ? 'rgba(16, 185, 129, 0.1)' : yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff';
        wrap.style.borderColor = estaSel ? '#10b981' : yaExiste ? '#0ea5e9' : '#e5e7eb';
      });
      
      cb.addEventListener('change', () => {
        if(cb.checked) {
          seleccion.add(p.id);
          console.log(`‚úÖ [CHECKBOX] Patolog√≠a agregada: ${p.cie10} - ${p.nombre}`);
          
          // Actualizar estilo visual del wrapper SIN redibujar todo
          wrap.style.borderColor = '#10b981';
          wrap.style.background = 'rgba(16, 185, 129, 0.1)';
        } else {
          seleccion.delete(p.id);
          console.log(`‚ûñ [CHECKBOX] Patolog√≠a removida: ${p.cie10} - ${p.nombre}`);
          
          // Restaurar estilo visual del wrapper SIN redibujar todo
          const yaExiste = patologiasCargadasUsuario.has(p.id);
          wrap.style.borderColor = yaExiste ? '#0ea5e9' : '#e5e7eb';
          wrap.style.background = yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff';
        }
        
        actualizarBotones();
        actualizarPatologiasSeleccionadas();
        // ‚ùå NO LLAMAR render() aqu√≠ - causa que se redibujen TODOS los checkboxes
        
        // Recalcular riesgo autom√°ticamente cuando cambia la selecci√≥n
        // Solo si ya hay un usuario cargado
        const runInput = document.getElementById('run');
        if (runInput && runInput.value) {
          setTimeout(() => {
            console.log('üîß [CHECKBOX] Recalculando riesgo autom√°ticamente...');
            if (typeof window.calcularRiesgoECICEP === 'function') {
              const resultado = window.calcularRiesgoECICEP();
              console.log('‚úÖ [CHECKBOX] C√°lculo completado:', resultado);
            } else {
              console.warn('‚ö†Ô∏è [CHECKBOX] Funci√≥n calcularRiesgoECICEP no disponible');
            }
          }, 300);
        }
      });
      
      wrap.addEventListener('click', (e) => {
        if (e.target !== cb) {
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        }
      });
      
      cont.appendChild(wrap);
    });
    
    // Mostrar mensaje si hay m√°s resultados
    if (filtrados.length > maxResultados) {
      const masResultados = document.createElement('div');
      masResultados.style.cssText = `
        text-align: center;
        padding: 8px;
        color: #f59e0b;
        font-size: 0.7rem;
        background: #fffbeb;
        border-radius: 4px;
        margin-top: 4px;
      `;
      masResultados.textContent = `‚ö†Ô∏è Mostrando ${maxResultados} de ${filtrados.length} resultados. Refine su b√∫squeda para ver m√°s.`;
      cont.appendChild(masResultados);
    }
    
    actualizarBotones();
  }
  
  // Nueva funci√≥n para actualizar el panel de patolog√≠as seleccionadas
  function actualizarPatologiasSeleccionadas() {
    const panel = document.getElementById('patologias-seleccionadas');
    if (!panel) return;
    
    if (seleccion.size === 0) {
      panel.innerHTML = '<div style="opacity:.6;text-align:center;padding:10px;">Ninguna patolog√≠a seleccionada</div>';
      // Actualizar estado visual del resumen
      actualizarEstadoPatologiasResumen();
      return;
    }
    
    const seleccionadas = Array.from(seleccion).map(id => 
      catalogo.find(p => p.id === id)
    ).filter(Boolean);
    
    panel.innerHTML = seleccionadas.map(p => `
      <div style="
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 4px;
        padding: 4px 8px;
        margin: 2px 0;
        font-size: 0.65rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <span><strong>${p.cie10}</strong> - ${p.nombre}</span>
        <button onclick="eliminarYRecalcular(${p.id}, this.parentElement);" 
                style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:0.8rem;">√ó</button>
      </div>
    `).join('');
    
    // Actualizar estado visual del resumen
    actualizarEstadoPatologiasResumen();
  }
  
  // Nueva funci√≥n para eliminar patolog√≠a y recalcular riesgo autom√°ticamente
  function eliminarYRecalcular(patologiaId, elemento) {
    console.log('üóëÔ∏è [ELIMINAR-PAT] Eliminando patolog√≠a ID:', patologiaId);
    
    // Eliminar del DOM
    if (elemento) {
      elemento.remove();
    }
    
    // Eliminar de la selecci√≥n
    seleccion.delete(patologiaId);
    
    // Desmarcar el checkbox correspondiente en el checklist
    const contenedorPats = document.getElementById('contenedor-patologias');
    if (contenedorPats) {
      const checkbox = contenedorPats.querySelector(`input[type="checkbox"][data-id="${patologiaId}"]`);
      if (checkbox) {
        checkbox.checked = false;
        
        // Actualizar estilo visual del wrapper
        const wrapper = checkbox.closest('.pat-row');
        if (wrapper) {
          const yaExiste = patologiasCargadasUsuario.has(patologiaId);
          wrapper.style.borderColor = yaExiste ? '#0ea5e9' : '#e5e7eb';
          wrapper.style.background = yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff';
        }
      }
    }
    
    // Actualizar botones y UI
    actualizarBotones();
    actualizarPatologiasSeleccionadas();
    // ‚ùå NO LLAMAR render() aqu√≠ - causa que se redibujen TODOS los checkboxes
    
    // Recalcular riesgo autom√°ticamente despu√©s de eliminar
    setTimeout(() => {
      console.log('üîß [ELIMINAR-PAT] Recalculando riesgo despu√©s de eliminar patolog√≠a...');
      if (typeof window.calcularRiesgoECICEP === 'function') {
        const resultado = window.calcularRiesgoECICEP();
        console.log('‚úÖ [ELIMINAR-PAT] C√°lculo completado:', resultado);
      } else {
        console.warn('‚ö†Ô∏è [ELIMINAR-PAT] Funci√≥n calcularRiesgoECICEP no disponible');
      }
    }, 300);
  }
  
  // Nueva funci√≥n para sincronizar estado visual entre resumen y checklist
  function actualizarEstadoPatologiasResumen() {
    const listaResumen = document.getElementById('lista-patologias');
    if (!listaResumen) return;
    
    const items = listaResumen.querySelectorAll('li');
    items.forEach(li => {
      const texto = li.textContent;
      // Extraer c√≥digo CIE10 del texto (formato: "E11.9 - Diabetes mellitus")
      const match = texto.match(/^([A-Z]\d+(\.\d+)?)\s*-/i);
      if (!match) return;
      
      const codigoResumen = match[1].toUpperCase();
      
      // Verificar si esta patolog√≠a est√° marcada en el checklist
      let estaMarcada = false;
      const contenedorPats = document.getElementById('contenedor-patologias');
      if (contenedorPats) {
        const checkboxes = contenedorPats.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
          const label = cb.closest('label');
          if (!label) return;
          
          const cie10Div = label.querySelector('div div[style*="font-size: 0.65rem"]');
          if (cie10Div) {
            const textoCompleto = cie10Div.textContent;
            const matchCb = textoCompleto.match(/CIE-10:\s*([A-Z]\d+(\.\d+)?)/i);
            if (matchCb) {
              const codigoCb = matchCb[1].toUpperCase();
              if (codigoCb === codigoResumen || codigoCb.startsWith(codigoResumen) || codigoResumen.startsWith(codigoCb)) {
                estaMarcada = true;
              }
            }
          }
        });
      }
      
      // Aplicar estilo visual seg√∫n estado
      if (estaMarcada) {
        li.style.fontWeight = 'bold';
        li.style.textDecoration = 'underline';
        li.title = '‚úì Marcada en c√°lculo de riesgo - Click para desmarcar';
      } else {
        li.style.fontWeight = 'normal';
        li.style.textDecoration = 'none';
        li.title = 'Click para marcar en c√°lculo de riesgo';
      }
    });
  }
  btnGuardarPats.addEventListener('click', async ()=>{
    const runVal = document.getElementById('run').value;
    if(!runVal || !seleccion.size){ return; }
    
    setEstado('Agregando patolog√≠as...'); 
    btnGuardarPats.disabled = true;
    
    // Convertir IDs de patolog√≠as a c√≥digos CIE10
    const cie10Codes = Array.from(seleccion).map(id => {
      const pat = catalogo.find(p => p.id === id);
      return pat ? pat.cie10 : null;
    }).filter(Boolean);
    
    if (cie10Codes.length === 0) {
      setEstado('No se encontraron c√≥digos CIE10 v√°lidos', 'error');
      btnGuardarPats.disabled = false;
      return;
    }
    
    let intentos = 0;
    const maxIntentos = 3;
    
    while (intentos < maxIntentos) {
      try {
        const r = await authFetch(`/api/agregar_patologias/${runVal}`, {
          method: 'POST',
          body: JSON.stringify({cie10_codes: cie10Codes})
        });
        
        if (r.status === 404) {
          setEstado('Usuario no encontrado', 'error');
          break;
        }
        
        if (r.status === 429) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Rate limit - Reintentando (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 2000 * intentos));
            continue;
          } else {
            setEstado('Servidor ocupado - Intente m√°s tarde', 'error');
            break;
          }
        }
        
        if (r.status >= 500) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Error servidor - Reintentando (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
            continue;
          } else {
            setEstado('Error del servidor - Intente m√°s tarde', 'error');
            break;
          }
        }
        
        const d = await r.json();
        if (d.success) { 
          setEstado('‚úÖ Patolog√≠as agregadas exitosamente'); 
          patologiasCargadasUsuario = new Set(seleccion); 
          
          // NO limpiar selecci√≥n - mantener marcadas para calcular riesgo
          // seleccion.clear(); 
          
          // Recargar TODAS las patolog√≠as del usuario desde el servidor
          console.log('üîÑ [Patolog√≠as] Recargando todas las patolog√≠as del usuario...');
          
          try {
            const respPats = await authFetch(`/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`);
            if (respPats.ok) {
              const dataPats = await respPats.json();
              if (dataPats.ok && dataPats.patologias) {
                console.log(`‚úÖ [Patolog√≠as] ${dataPats.patologias.length} patolog√≠as cargadas del usuario`);
                
                // Marcar todas las patolog√≠as del usuario en el checklist
                seleccion.clear(); // Primero limpiar
                dataPats.patologias.forEach(p => {
                  // Buscar la patolog√≠a en el cat√°logo por CIE10 o nombre
                  const patEnCatalogo = catalogo.find(pc => 
                    pc.cie10 === p.cie10 || 
                    pc.id === p.patologia_id ||
                    pc.nombre.toLowerCase() === p.nombre.toLowerCase()
                  );
                  
                  if (patEnCatalogo) {
                    seleccion.add(patEnCatalogo.id);
                    console.log(`‚úÖ Marcada: ${p.cie10} - ${p.nombre}`);
                  }
                });
                
                console.log(`‚úÖ [Patolog√≠as] ${seleccion.size} patolog√≠as marcadas en checklist`);
                patologiasCargadasUsuario = new Set(seleccion);
                
                // ‚úÖ ACTUALIZAR PATOLOG√çAS PARA C√ÅLCULO DE RIESGO
                window._patologiasUsuarioBD = normalizeUsuarioPatologias(dataPats.patologias || []);
                console.log(`‚úÖ [Patolog√≠as] window._patologiasUsuarioBD actualizado con ${window._patologiasUsuarioBD.length} patolog√≠as`);
              }
            }
          } catch (e) {
            console.warn('Error recargando patolog√≠as del usuario:', e);
          }
          
          render(); 
          actualizarBotones();
          
          // Recargar datos del usuario para actualizar pesta√±as condicionales
          try {
            const respUser = await authFetch(`/api/tarjeton/${runVal}`);
            if (respUser.ok) {
              const userData = await authFetch.json();
              if (userData && userData.ok) {
                // Actualizar pesta√±a diabetes basada en nuevas patolog√≠as
                mostrarOcultarDiabetes(userData.patologias_resumen);
                // Actualizar secci√≥n IECA/ARA II basada en nuevas patolog√≠as
                mostrarOcultarIecaAra(userData.patologias_resumen);
                // Actualizar secci√≥n Estatinas basada en nuevas patolog√≠as
                mostrarOcultarEstatinas(userData.patologias_resumen);
                // Actualizar secci√≥n Antiagregantes basada en nuevas patolog√≠as
                mostrarOcultarAntiagregantes(userData.patologias_resumen);
                console.log('üîß [DEBUG] Pesta√±as y secciones actualizadas despu√©s de guardar patolog√≠as');
              }
            }
          } catch (e) {
            console.log('üîß [DEBUG] Error actualizando pesta√±as despu√©s de guardar patolog√≠as:', e);
          }
          
          // Mensaje informativo
          const mensajeDiv = document.createElement('div');
          mensajeDiv.textContent = `‚úÖ Patolog√≠as guardadas. Total: ${seleccion.size} patolog√≠as marcadas. Calculando riesgo...`;
          mensajeDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#10b981;color:white;padding:12px 24px;border-radius:8px;z-index:10000;font-size:0.85rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
          document.body.appendChild(mensajeDiv);
          setTimeout(() => mensajeDiv.remove(), 3500);
          
          // Calcular riesgo autom√°ticamente despu√©s de guardar patolog√≠as
          setTimeout(() => {
            console.log('üîß [GUARDAR-PATS] Activando c√°lculo autom√°tico de riesgo...');
            if (typeof window.calcularRiesgoECICEP === 'function') {
              const resultado = window.calcularRiesgoECICEP();
              console.log('‚úÖ [GUARDAR-PATS] C√°lculo completado:', resultado);
            } else {
              console.warn('‚ö†Ô∏è [GUARDAR-PATS] Funci√≥n calcularRiesgoECICEP no disponible');
            }
          }, 1500);
          
        } else {
          setEstado('Error agregando patolog√≠as: ' + (d.error || 'Error desconocido'), 'error');
        }
        break; // Salir del bucle si llegamos aqu√≠
        
      } catch (e) { 
        intentos++;
        if (intentos < maxIntentos) {
          setEstado(`Error conexi√≥n - Reintentando (${intentos}/${maxIntentos})...`);
          await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
        } else {
          setEstado('Error de conexi√≥n - Verifique su red', 'error');
        }
      }
    }
    
    btnGuardarPats.disabled = false;
  });
  btnSelectFiltradas.addEventListener('click', ()=>{
    const q = (buscador.value||'').toLowerCase();
    let a√±adidas = 0;
    catalogo.forEach(p=>{
      const cie10Lower = (p.cie10 || '').toLowerCase();
      if(!q || p.nombre.toLowerCase().includes(q) || cie10Lower.includes(q)){
        if(!seleccion.has(p.id)) {
          a√±adidas++;
        }
        seleccion.add(p.id);
      }
    });
    patologiasCargadasUsuario.forEach(id => seleccion.add(id));
    render();
    actualizarPatologiasSeleccionadas();
    if (seleccion.size) {
      const total = seleccion.size;
      const detalleFiltradas = a√±adidas ? `${a√±adidas} filtrada${a√±adidas !== 1 ? 's' : ''}` : 'Sin nuevas coincidencias';
      setEstado(`‚úÖ ${total} patolog√≠a${total !== 1 ? 's' : ''} listas (${detalleFiltradas} + guardadas)`, 'info');
    }
  });
  btnClearSel.addEventListener('click', ()=>{
    seleccion.clear();
    usuarioLimpioSeleccion = true; // El usuario limpi√≥ intencionalmente
    console.log('üßπ Usuario limpi√≥ selecci√≥n - pr√≥ximo guardado ser√° en modo REEMPLAZAR');
    render();
  });
  
  // Mejorar bot√≥n "Aplicar al Usuario"
  if (btnAplicar) {
    btnAplicar.addEventListener('click', async () => {
      const runInput = document.getElementById('run');
      const runVal = runInput ? runInput.value.trim() : '';
      
      if (!runVal) {
        setEstado('Error: RUN requerido para aplicar patolog√≠as', 'error');
        return;
      }
      
      if (seleccion.size === 0) {
        setEstado('Error: Seleccione al menos una patolog√≠a', 'error');
        return;
      }
      
      // Confirmar aplicaci√≥n
      const patologiasTexto = Array.from(seleccion).map(id => {
        const pat = catalogo.find(p => p.id === id);
        return pat ? `${pat.cie10} - ${pat.nombre}` : `ID: ${id}`;
      }).join('\n');
      
      const confirmar = confirm(`¬øConfirma aplicar las siguientes patolog√≠as al usuario ${runVal}?\n\n${patologiasTexto}`);
      if (!confirmar) return;
      
      setEstado('Aplicando patolog√≠as al usuario...'); 
      btnAplicar.disabled = true;
      
      let intentos = 0;
      const maxIntentos = 3;
      
      while (intentos < maxIntentos) {
        try {
          // Determinar el modo basado en si el usuario limpi√≥ intencionalmente
          const modo = usuarioLimpioSeleccion ? 'reemplazar' : 'agregar';
          console.log(`üíæ Guardando patolog√≠as en modo: ${modo.toUpperCase()}`);
          
          const r = await authFetch('/api/tarjeton/patologias', {
            method: 'POST',
            body: JSON.stringify({
              run: runVal, 
              patologia_ids: [...seleccion],
              modo: modo
            })
          });
          
          if (r.status === 404) {
            setEstado(`Error: Usuario ${runVal} no encontrado`, 'error');
            break;
          }
          
          if (r.status === 429) {
            intentos++;
            if (intentos < maxIntentos) {
              setEstado(`Rate limit - Reintentando aplicaci√≥n (${intentos}/${maxIntentos})...`);
              await new Promise(resolve => setTimeout(resolve, 2000 * intentos));
              continue;
            } else {
              setEstado('Servidor ocupado - Intente aplicar m√°s tarde', 'error');
              break;
            }
          }
          
          if (r.status >= 500) {
            intentos++;
            if (intentos < maxIntentos) {
              setEstado(`Error servidor - Reintentando aplicaci√≥n (${intentos}/${maxIntentos})...`);
              await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
              continue;
            } else {
              setEstado('Error del servidor - Intente aplicar m√°s tarde', 'error');
              break;
            }
          }
          
          const d = await r.json();
          
          if (d.ok) {
            setEstado(`‚úÖ Patolog√≠as aplicadas exitosamente (${d.total || seleccion.size}) - Modo: ${d.modo || 'desconocido'}`);
            patologiasCargadasUsuario = new Set(seleccion);
            
            // Resetear la bandera despu√©s de un guardado exitoso
            usuarioLimpioSeleccion = false;
            
            // Actualizar interfaz
            render();
            actualizarPatologiasSeleccionadas();
            
            // Recargar datos del usuario si es posible
            if (typeof sincronizarPatologiasUsuario === 'function') {
              setTimeout(() => sincronizarPatologiasUsuario(runVal), 1000);
            }
          } else {
            setEstado(`Error aplicando patolog√≠as: ${d.error || 'Error desconocido'}`, 'error');
          }
          break; // Salir del bucle si llegamos aqu√≠
          
        } catch (error) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Error conexi√≥n - Reintentando aplicaci√≥n (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
          } else {
            console.error('Error aplicando patolog√≠as:', error);
            setEstado('Error de conexi√≥n - Verifique su red', 'error');
          }
        }
      }
      
      btnAplicar.disabled = false;
    });
  }
  // Mejorar buscador con sugerencias
  buscador.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    // Render normal
    render();
    
    // Agregar sugerencias r√°pidas si el query es corto
    if (query.length >= 2 && query.length <= 4) {
      const sugerencias = catalogo
        .filter(p => p.cie10 && p.cie10.toLowerCase().startsWith(query))
        .slice(0, 5);
        
      if (sugerencias.length > 0) {
        const estadoPats = document.getElementById('estado-patologias');
        if (estadoPats) {
          const sugerenciasTexto = sugerencias.map(p => `${p.cie10}: ${p.nombre.substring(0, 30)}...`).join(' | ');
          estadoPats.innerHTML = `üí° Sugerencias: <span style="font-size:0.65rem;">${sugerenciasTexto}</span>`;
          estadoPats.style.color = '#6b7280';
        }
      }
    }
  });
  
  // Agregar sugerencias r√°pidas comunes
  const sugerenciasComunes = [
    { texto: 'HTA', query: 'I10' },
    { texto: 'DM2', query: 'E11' },
    { texto: 'Dislipidemia', query: 'E78' },
    { texto: 'ERC', query: 'N18' },
    { texto: 'Cardiopat√≠a', query: 'I25' }
  ];
  
  // Crear botones de sugerencias
  const sugerenciasDiv = document.createElement('div');
  sugerenciasDiv.style.cssText = 'display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap;';
  sugerenciasDiv.innerHTML = sugerenciasComunes.map(s => 
    `<button onclick="document.getElementById('buscador-patologia').value='${s.query}'; document.getElementById('buscador-patologia').dispatchEvent(new Event('input'));" 
     style="font-size:0.65rem; padding:2px 6px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:3px; cursor:pointer; color:#374151;">
     ${s.texto}
     </button>`
  ).join('');
  
  buscador.parentNode.insertBefore(sugerenciasDiv, buscador.nextSibling);
  
  async function cargarCatalogo(){
    setEstado('Cargando cat√°logo de patolog√≠as...');
    
    try{
      // Intentar m√∫ltiples endpoints para cargar patolog√≠as
      const endpoints = ['/api/patologias_catalogo', '/api/patologias', '/api/cie10'];
      let r, d;
      
      for (const endpoint of endpoints) {
        try {
          r = await authFetch(endpoint);
          if (r.ok) {
            d = await r.json();
            if (d.ok && (d.patologias || d.data)) {
              catalogo = d.patologias || d.data || [];
              console.log(`[üîé ECICEP] Cat√°logo cargado desde ${endpoint}: ${catalogo.length} patolog√≠as`);
              break;
            }
          }
        } catch (endpointError) {
          console.log(`[üîé ECICEP] Error en endpoint ${endpoint}:`, endpointError);
          continue;
        }
      }
      
      // Si no se pudo cargar desde ning√∫n endpoint, usar cat√°logo extendido offline
      if (!catalogo || catalogo.length === 0) {
        console.log('[üîé ECICEP] Usando cat√°logo offline extendido');
        catalogo = [
          {id: 1, cie10: 'I10', nombre: 'Hipertensi√≥n arterial esencial'},
          {id: 2, cie10: 'E11', nombre: 'Diabetes mellitus tipo 2'},
          {id: 3, cie10: 'E78', nombre: 'Trastorno del metabolismo de las lipoprote√≠nas'},
          {id: 4, cie10: 'N18', nombre: 'Enfermedad renal cr√≥nica'},
          {id: 5, cie10: 'I25', nombre: 'Enfermedad isqu√©mica cr√≥nica del coraz√≥n'},
          {id: 6, cie10: 'E10', nombre: 'Diabetes mellitus tipo 1'},
          {id: 7, cie10: 'I50', nombre: 'Insuficiencia card√≠aca'},
          {id: 8, cie10: 'J44', nombre: 'Enfermedad pulmonar obstructiva cr√≥nica'},
          {id: 9, cie10: 'M79', nombre: 'Trastornos de los tejidos blandos'},
          {id: 10, cie10: 'F32', nombre: 'Episodio depresivo'},
          {id: 11, cie10: 'I11', nombre: 'Enfermedad card√≠aca hipertensiva'},
          {id: 12, cie10: 'I12', nombre: 'Enfermedad renal hipertensiva'},
          {id: 13, cie10: 'G93', nombre: 'Otros trastornos del enc√©falo'},
          {id: 14, cie10: 'K29', nombre: 'Gastritis y duodenitis'},
          {id: 15, cie10: 'M17', nombre: 'Gonartrosis'},
        ];
        setEstado(`Cat√°logo offline cargado (${catalogo.length} patolog√≠as principales)`);
      } else {
        setEstado(`Cat√°logo online cargado (${catalogo.length} patolog√≠as)`);
      }

      catalogo = normalizeCatalogList(catalogo);
      
      // Actualizar referencia global al cat√°logo
      window._riesgoCatalogo = catalogo;
      
      render();
      
    } catch(e) {
      console.error('[üîé ECICEP] Error cr√≠tico cargando cat√°logo:', e);
      setEstado('Error cargando patolog√≠as - usando modo b√°sico', 'error');
      catalogo = [
        {id: 1, cie10: 'I10', nombre: 'Hipertensi√≥n arterial esencial'},
        {id: 2, cie10: 'E11', nombre: 'Diabetes mellitus tipo 2'},
        {id: 3, cie10: 'E78', nombre: 'Dislipidemia'}
      ];
      catalogo = normalizeCatalogList(catalogo);
      render();
    }
  }
  
  await cargarCatalogo();
  
  async function sincronizarUsuario(runVal){
    if(!runVal) return;
    try{
      const r = await authFetch(`/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`);
      if(!r.ok) return;
      const d = await r.json();
      if(d.ok && d.patologias){
        patologiasCargadasUsuario = new Set(d.patologias.map(p => p.id));
        render();
      }
    }catch(e){
      console.warn('Error sincronizarUsuario:', e);
    }
  }
  
  // Sincronizar cuando pierde foco RUN
  document.getElementById('run').addEventListener('blur',()=> sincronizarUsuario(document.getElementById('run').value));
  
  // Asignar funci√≥n global despu√©s de la definici√≥n
  if (typeof eliminarYRecalcular === 'function') {
    window.eliminarYRecalcular = eliminarYRecalcular;
  }
})();

// Funci√≥n global para sincronizar patolog√≠as del usuario (llamada desde recargaTodo)
async function sincronizarPatologiasUsuario(runVal) {
  if (!runVal) return 0;

  const {
    toNumericId = (v) => {
      const num = Number(v);
      return Number.isFinite(num) ? num : null;
    },
    normalizeCie10 = (value) => (value ?? '').toString().trim().toUpperCase(),
    stripCie10 = (value) => normalizeCie10(value).replace(/[^A-Z0-9]/g, ''),
    normalizeUsuarioPatologias = (lista = []) => lista
  } = window.__riesgoUtils || {};

  window.__sincronizarPatologiasQueue = window.__sincronizarPatologiasQueue || [];
  const queue = window.__sincronizarPatologiasQueue;

  const obtenerEstadoPatologias = () => document.getElementById('estado-patologias');
  const informarEstadoTemporal = (mensaje, tipo = 'info') => {
    const el = obtenerEstadoPatologias();
    if (!el || !mensaje) return;
    el.textContent = mensaje;
    if (tipo === 'error') {
      el.style.color = '#b91c1c';
    } else if (tipo === 'warn') {
      el.style.color = '#b45309';
    } else {
      el.style.color = '#334155';
    }
  };

  const agregarACola = () => new Promise(resolve => {
    const existente = queue.find(item => item.run === runVal);
    if (existente) {
      existente.resolvers.push(resolve);
    } else {
      queue.push({ run: runVal, resolvers: [resolve] });
    }
  });

  const procesarColaPendiente = () => {
    if (!queue.length) return;
    const siguiente = queue.shift();
    setTimeout(() => {
      sincronizarPatologiasUsuario(siguiente.run)
        .then(resultado => {
          (siguiente.resolvers || []).forEach(resolver => resolver(resultado));
        })
        .catch(error => {
          console.error('[üîé Patolog√≠as] Error procesando cola de sincronizaci√≥n:', error);
          (siguiente.resolvers || []).forEach(resolver => resolver(0));
        });
    }, 120);
  };

  const ahora = Date.now();

  const bloqueadoHasta = window.__sincronizarPatologiasBloqueadoHasta || 0;
  if (bloqueadoHasta && ahora < bloqueadoHasta) {
    const esperaMs = bloqueadoHasta - ahora;
    console.warn(`[üîé Patolog√≠as] Ventana de rate limit activa (${esperaMs}ms restantes). Se esperar√° antes de continuar.`);
    informarEstadoTemporal(`‚è≥ Servidor ocupado. Reintentando en ${Math.ceil(esperaMs / 1000)}s...`, 'warn');
    await new Promise(resolve => setTimeout(resolve, esperaMs));
  }

  if (window.__sincronizarPatologiasEnCurso) {
    console.warn(`[üîé Patolog√≠as] Sincronizaci√≥n en curso. Encolando ejecuci√≥n para ${runVal}.`);
    return agregarACola();
  }

  const ultimoSync = window.__sincronizarPatologiasUltimo;
  if (ultimoSync && ultimoSync.run === runVal && (ahora - ultimoSync.timestamp) < 1200) {
    return ultimoSync.result ?? 0;
  }

  window.__sincronizarPatologiasEnCurso = true;
  const registrarResultado = (valor) => {
    window.__sincronizarPatologiasUltimo = { run: runVal, timestamp: Date.now(), result: valor };
    return valor;
  };

  console.log('[üîé Patolog√≠as] Sincronizando patolog√≠as para usuario:', runVal);
  
  try {
    // Intentar m√∫ltiples endpoints para cargar patolog√≠as del usuario
    const endpoints = [
      `/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`,
      `/api/usuarios/${encodeURIComponent(runVal)}/patologias`,
      `/api/patologias/usuario/${encodeURIComponent(runVal)}`
    ];
    
    let patologiasUsuario = [];
    const maxRetriesPerEndpoint = 2;

    for (const endpoint of endpoints) {
      let intento = 0;
      while (intento <= maxRetriesPerEndpoint) {
        try {
          const r = await authFetch(endpoint);

          if (r.status === 429) {
            const retryAfterHeader = r.headers.get('Retry-After');
            const retrySeconds = retryAfterHeader ? parseInt(retryAfterHeader, 10) : NaN;
            const esperaBase = Number.isFinite(retrySeconds) ? retrySeconds * 1000 : 4000;
            const esperaMs = Math.min(15000, esperaBase + Math.floor(Math.random() * 750));
            window.__sincronizarPatologiasBloqueadoHasta = Date.now() + esperaMs;
            console.warn(`[üîé Patolog√≠as] API respondi√≥ 429 en ${endpoint}. Reintentando en ${esperaMs}ms (intento ${intento + 1}/${maxRetriesPerEndpoint + 1})`);
            informarEstadoTemporal(`‚ö†Ô∏è Servidor ocupado consultando patolog√≠as. Reintentando en ${Math.ceil(esperaMs / 1000)}s...`, 'warn');
            await new Promise(resolve => setTimeout(resolve, esperaMs));
            intento++;
            continue;
          }

          if (r.ok) {
            const d = await r.json();
            if (d.ok && (d.patologias || d.data)) {
              patologiasUsuario = d.patologias || d.data || [];
              console.log(`[üîé Patolog√≠as] Patolog√≠as del usuario cargadas desde ${endpoint}: ${patologiasUsuario.length}`);
              window.__sincronizarPatologiasBloqueadoHasta = 0;
              intento = maxRetriesPerEndpoint + 1;
              break;
            }
          } else {
            console.warn(`[üîé Patolog√≠as] Endpoint ${endpoint} respondi√≥ ${r.status}`);
          }
        } catch (endpointError) {
          console.log(`[üîé Patolog√≠as] Error en endpoint ${endpoint}:`, endpointError);
          if (intento < maxRetriesPerEndpoint) {
            const esperaMs = 600 * (intento + 1);
            await new Promise(resolve => setTimeout(resolve, esperaMs));
            intento++;
            continue;
          }
        }
        break;
      }

      if (patologiasUsuario.length > 0) {
        break;
      }

      await new Promise(resolve => setTimeout(resolve, 150));
    }

    if (!patologiasUsuario.length) {
      informarEstadoTemporal('‚ö†Ô∏è No fue posible sincronizar las patolog√≠as del usuario. Intente nuevamente en unos segundos.', 'warn');
    }

    patologiasUsuario = normalizeUsuarioPatologias(patologiasUsuario);
    
    // ‚úÖ GUARDAR PATOLOG√çAS DEL USUARIO PARA C√ÅLCULO DE RIESGO
    // Estas son las patolog√≠as reales guardadas en la BD, no checkboxes temporales
    window._patologiasUsuarioBD = patologiasUsuario;
    console.log('[üîé Patolog√≠as] Patolog√≠as guardadas en window._patologiasUsuarioBD:', patologiasUsuario.length);
    
    // Actualizar el sistema de patolog√≠as si existe
    const cont = document.getElementById('contenedor-patologias');
    if (cont && patologiasUsuario.length > 0) {
      console.log('[üîé Patolog√≠as] Marcando patolog√≠as del usuario en checklist...');
      console.log('[üîé Patolog√≠as] Patolog√≠as del usuario:', patologiasUsuario);
      
      // Acceder al cat√°logo global o al local del m√≥dulo
      const catalogoDisponible = Array.isArray(window._riesgoCatalogo) ? window._riesgoCatalogo : [];
      console.log('[üîé Patolog√≠as] Cat√°logo disponible:', catalogoDisponible.length, 'patolog√≠as');

      // Construir √≠ndices para coincidencias r√°pidas
      const catalogoIdsSet = new Set();
      const catalogoCieList = [];

      catalogoDisponible.forEach(pc => {
        const catId = toNumericId(pc.id);
        if (catId !== null) {
          catalogoIdsSet.add(catId);
        }
        const cieCatalogo = stripCie10(pc.cie10 || pc.codigo_cie10 || pc.CIE10 || pc.codigo);
        if (cieCatalogo) {
          catalogoCieList.push(cieCatalogo);
        }
      });

      const catalogoCieSet = new Set(catalogoCieList);

      // Construir sets para coincidencias r√°pidas
      const idsUsuario = new Set();
      const cieUsuario = new Set();

      patologiasUsuario.forEach(p => {
        const baseId = toNumericId(p.id);
        const relId = toNumericId(p.patologia_id);
        const cieLimpio = p.cie10_sin_puntos || stripCie10(p.cie10);

        if (baseId !== null) idsUsuario.add(baseId);
        if (relId !== null) idsUsuario.add(relId);
        if (cieLimpio) cieUsuario.add(cieLimpio);
      });

      patologiasCargadasUsuario = new Set(idsUsuario);

      // Limpiar selecci√≥n actual
      if (window._riesgoSeleccion instanceof Set) {
        window._riesgoSeleccion.clear();
        console.log('[üîé Patolog√≠as] Selecci√≥n limpiada');
      }

      let checkboxes = cont.querySelectorAll('input[type="checkbox"]');
      if (!checkboxes.length && typeof window._riesgoRender === 'function') {
        window._riesgoRender();
        checkboxes = cont.querySelectorAll('input[type="checkbox"]');
      }
      console.log('[üîé Patolog√≠as] Total checkboxes encontrados:', checkboxes.length);

      let patologiasMarcadas = 0;
      const cieUsuarioArray = Array.from(cieUsuario);

      checkboxes.forEach(checkbox => {
        const patId = toNumericId(checkbox.dataset.id);
        const cieCheckbox = normalizeCie10(checkbox.dataset.cie10 || '');
        const cieCheckboxStrip = stripCie10(cieCheckbox);

        const patCatalogo =
          (patId !== null && catalogoDisponible.find(pc => toNumericId(pc.id) === patId)) ||
          (cieCheckboxStrip ? catalogoDisponible.find(pc => stripCie10(pc.cie10) === cieCheckboxStrip) : null);

        let tienePatologia = false;

        if (patId !== null && idsUsuario.has(patId)) {
          console.log(`‚úÖ Match por ID: ${patId}`);
          tienePatologia = true;
        } else if (cieCheckboxStrip && cieUsuario.has(cieCheckboxStrip)) {
          console.log(`‚úÖ Match exacto CIE10: ${cieCheckbox}`);
          tienePatologia = true;
        } else if (cieCheckboxStrip) {
          const prefMatch = cieUsuarioArray.find(code => code.startsWith(cieCheckboxStrip) || cieCheckboxStrip.startsWith(code));
          if (prefMatch) {
            console.log(`‚úÖ Match por prefijo CIE10: ${cieCheckbox} ‚Üî ${prefMatch}`);
            tienePatologia = true;
          }
        }

        if (!tienePatologia) {
          return;
        }

        // MARCAR EL CHECKBOX
        checkbox.checked = true;

        // Agregar al Set de selecci√≥n
        const idSeleccion = patId !== null ? patId : toNumericId(patCatalogo?.id);
        if (window._riesgoSeleccion instanceof Set && idSeleccion !== null) {
          window._riesgoSeleccion.add(idSeleccion);
        }

        patologiasMarcadas++;
        if (patCatalogo) {
          console.log(`‚úÖ [Patolog√≠as] Marcada checkbox ID=${patCatalogo.id}: ${patCatalogo.cie10} - ${patCatalogo.nombre}`);
        }

        // Actualizar estilo visual del wrapper
        const wrapper = checkbox.closest('.pat-row');
        if (wrapper) {
          wrapper.style.borderColor = '#10b981';
          wrapper.style.background = 'rgba(16, 185, 129, 0.1)';

          // Agregar indicador visual "YA TIENE"
          if (!wrapper.querySelector('.ya-tiene-indicator')) {
            const indicator = document.createElement('span');
            indicator.className = 'ya-tiene-indicator';
            indicator.style.cssText = 'background: #0ea5e9; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; margin-left: auto;';
            indicator.textContent = 'YA TIENE';
            wrapper.appendChild(indicator);
          }
        }
      });
      
      console.log(`‚úÖ [Patolog√≠as] ${patologiasMarcadas} de ${patologiasUsuario.length} patolog√≠as marcadas en checklist`);
      console.log(`‚úÖ [Patolog√≠as] Set de selecci√≥n tiene ${window._riesgoSeleccion?.size || 0} elementos`);

      const patologiasNoMapeadas = patologiasUsuario.filter(p => {
        const patId = toNumericId(p.id) ?? toNumericId(p.patologia_id);
        const cieBase = normalizeCie10(p.cie10 || p.codigo_cie10 || p.CIE10 || p.codigo);
        const cieStrip = stripCie10(cieBase);

        const matchId = patId !== null && catalogoIdsSet.has(patId);
        if (matchId) {
          return false;
        }

        const matchExacto = cieStrip && catalogoCieSet.has(cieStrip);
        if (matchExacto) {
          return false;
        }

        if (cieStrip) {
          const matchPrefijo = catalogoCieList.some(code => code.startsWith(cieStrip) || cieStrip.startsWith(code));
          if (matchPrefijo) {
            return false;
          }
        }

        return true;
      });

      if (patologiasNoMapeadas.length > 0) {
        console.info(
          `‚ÑπÔ∏è [Patolog√≠as] ${patologiasNoMapeadas.length} patolog√≠as desde BD no encontraron equivalencia directa en el cat√°logo visible`,
          patologiasNoMapeadas
        );
      }
      
      // Forzar actualizaci√≥n del render si existe la funci√≥n
      if (typeof window._riesgoRender === 'function') {
        console.log('[üîé Patolog√≠as] Forzando re-render...');
        window._riesgoRender();
      }
      
      // Actualizar estado
      const estadoPats = document.getElementById('estado-patologias');
      if (estadoPats) {
        const baseMensaje = `‚úÖ ${patologiasMarcadas} patolog√≠a${patologiasMarcadas !== 1 ? 's' : ''} del usuario marcada${patologiasMarcadas !== 1 ? 's' : ''} para c√°lculo`;
        if (patologiasNoMapeadas.length > 0) {
          const ejemplos = patologiasNoMapeadas
            .slice(0, 4)
            .map(p => {
              const cie = normalizeCie10(p.cie10 || p.codigo_cie10 || p.CIE10 || p.codigo);
              const nombre = (p.nombre || p.descripcion || '').toString().trim();
              return cie ? `${cie}${nombre ? ` ‚Äì ${nombre}` : ''}` : nombre || '(sin c√≥digo)';
            })
            .join(', ');
          estadoPats.innerHTML = `${baseMensaje}<br><span style="color:#b45309;font-size:0.7rem;">‚ö†Ô∏è ${patologiasNoMapeadas.length} patolog√≠a${patologiasNoMapeadas.length !== 1 ? 's' : ''} sin mapeo directo. Revise c√≥digos CIE10: ${ejemplos}</span>`;
          estadoPats.style.color = '#059669';
        } else {
          estadoPats.textContent = baseMensaje;
          estadoPats.style.color = '#059669';
        }
      }
      
      // Resetear bandera al cargar patolog√≠as del usuario
      usuarioLimpioSeleccion = false;
      
      // ‚úÖ CALCULAR RIESGO ECICEP AUTOM√ÅTICAMENTE DESPU√âS DE CARGAR PATOLOG√çAS
      if (typeof window.calcularRiesgoECICEP === 'function') {
        console.log('[üîé Patolog√≠as] Calculando riesgo ECICEP autom√°ticamente...');
        setTimeout(() => {
          const resultado = window.calcularRiesgoECICEP();
          console.log('[üîé Patolog√≠as] Riesgo calculado:', resultado);
        }, 500); // Esperar 500ms para asegurar que todo est√© cargado
      }
      
      window.__sincronizarPatologiasBloqueadoHasta = undefined;
      return registrarResultado(patologiasMarcadas); // Retornar cantidad de patolog√≠as marcadas
    }
    
    console.warn('[‚ö†Ô∏è Patolog√≠as] No se encontr√≥ contenedor o no hay patolog√≠as del usuario');
    
    // ‚úÖ CALCULAR RIESGO INCLUSO SIN PATOLOG√çAS (G0)
    if (typeof window.calcularRiesgoECICEP === 'function') {
      setTimeout(() => {
        window.calcularRiesgoECICEP();
      }, 500);
    }
    
    window.__sincronizarPatologiasBloqueadoHasta = undefined;
    return registrarResultado(0);
    
  } catch (error) {
    console.warn('[üîé Patolog√≠as] Error sincronizando patolog√≠as del usuario:', error);
    
    const estadoPats = document.getElementById('estado-patologias');
    if (estadoPats) {
      estadoPats.textContent = '‚ö†Ô∏è No se pudieron cargar las patolog√≠as del usuario';
      estadoPats.style.color = '#f59e0b';
    }
    window.__sincronizarPatologiasBloqueadoHasta = undefined;
    return registrarResultado(0);
  } finally {
    window.__sincronizarPatologiasEnCurso = false;
    procesarColaPendiente();
  }
}

// Deduplicar por seguridad: dejar un solo #identificacion-section
(function dedupIdent() {
  const ids = document.querySelectorAll('#identificacion-section');
  if (ids.length > 1) {
    ids.forEach((el, i) => { if (i > 0) el.parentNode.removeChild(el); });
    console.warn('[Tarjet√≥n] Secciones de Identificaci√≥n duplicadas: normalizadas a 1.');
  }
})();

// === SISTEMA DE MONITOREO DE CONECTIVIDAD ===
(function initConnectivityMonitor() {
  let ultimoEstadoConectividad = 'desconocido';
  let contadorErrores = 0;
  let ultimaPruebaExitosa = Date.now();
  
  // Funci√≥n para mostrar indicador de conectividad
  function actualizarIndicadorConectividad(estado, detalles = '') {
    const indicadores = [
      document.getElementById('estado-patologias'),
      document.querySelector('.estado-run'),
      document.querySelector('.lblEstado')
    ].filter(Boolean);
    
    if (estado !== ultimoEstadoConectividad) {
      console.log(`[üåê Conectividad] Cambio de estado: ${ultimoEstadoConectividad} ‚Üí ${estado}`, detalles);
      ultimoEstadoConectividad = estado;
    }
    
    indicadores.forEach(el => {
      if (!el) return;
      
      let icono = 'üåê';
      let color = '#6b7280';
      let mensaje = '';
      
      switch (estado) {
        case 'online':
          icono = 'üü¢';
          color = '#059669';
          mensaje = detalles || 'Conectado';
          contadorErrores = 0;
          ultimaPruebaExitosa = Date.now();
          break;
        case 'error-temporal':
          icono = 'üü°';
          color = '#f59e0b';
          mensaje = detalles || 'Conexi√≥n intermitente';
          contadorErrores++;
          break;
        case 'error-servidor':
          icono = 'üî¥';
          color = '#dc2626';
          mensaje = detalles || 'Error del servidor';
          contadorErrores++;
          break;
        case 'offline':
          icono = '‚ö´';
          color = '#6b7280';
          mensaje = detalles || 'Sin conexi√≥n';
          contadorErrores++;
          break;
      }
      
      // Agregar indicador si no existe
      let indicador = el.querySelector('.conectividad-indicator');
      if (!indicador) {
        indicador = document.createElement('span');
        indicador.className = 'conectividad-indicator';
        indicador.style.cssText = 'margin-left: 8px; font-size: 0.7rem; font-weight: normal;';
        el.appendChild(indicador);
      }
      
      indicador.textContent = `${icono} ${mensaje}`;
      indicador.style.color = color;
      
      // Agregar tiempo desde √∫ltima conexi√≥n exitosa si hay problemas
      if (estado !== 'online' && ultimaPruebaExitosa) {
        const tiempoDesconectado = Math.floor((Date.now() - ultimaPruebaExitosa) / 1000);
        if (tiempoDesconectado > 30) {
          indicador.textContent += ` (${tiempoDesconectado}s)`;
        }
      }
    });
  }
  
  // Interceptar fetch para monitorear conectividad
  const originalAuthFetch = window.authFetch;
  if (originalAuthFetch) {
    window.authFetch = async function(...args) {
      try {
        const response = await originalAuthFetch(...args);
        
        if (response.ok) {
          actualizarIndicadorConectividad('online', 'API disponible');
        } else if (response.status === 429) {
          actualizarIndicadorConectividad('error-temporal', 'Rate limit');
        } else if (response.status >= 500) {
          actualizarIndicadorConectividad('error-servidor', `Error ${response.status}`);
        } else if (response.status === 404) {
          // 404 no es necesariamente un problema de conectividad
          actualizarIndicadorConectividad('online', 'API disponible');
        }
        
        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          actualizarIndicadorConectividad('error-temporal', 'Timeout');
        } else if (error.message.includes('fetch')) {
          actualizarIndicadorConectividad('offline', 'Sin conexi√≥n');
        } else {
          actualizarIndicadorConectividad('error-temporal', 'Error de red');
        }
        throw error;
      }
    };
  }
  
  // Prueba peri√≥dica de conectividad (cada 30 segundos si hay errores)
  setInterval(async () => {
    if (contadorErrores > 0 || (Date.now() - ultimaPruebaExitosa) > 60000) {
      try {
        const response = await fetch('/api/health', { 
          method: 'HEAD',
          signal: AbortSignal.timeout(5000)
        });
        
        if (response.ok) {
          actualizarIndicadorConectividad('online', 'Conexi√≥n restaurada');
        }
      } catch (error) {
        // Mantener el estado actual, no cambiar por la prueba fallida
        if (ultimoEstadoConectividad === 'online') {
          actualizarIndicadorConectividad('error-temporal', 'Verificando conexi√≥n...');
        }
      }
    }
  }, 30000);
  
  // Estado inicial
  actualizarIndicadorConectividad('online', 'Iniciando...');
})();

// === SISTEMA DE C√ÅLCULO DIN√ÅMICO DE RIESGO ECICEP ===

// === FUNCIONES USO DE INSULINA ===
function obtenerFechaIsoLocal(fechaBase = new Date()) {
  const fecha = fechaBase instanceof Date ? new Date(fechaBase) : new Date(fechaBase);
  if (Number.isNaN(fecha.getTime())) {
    return '';
  }
  fecha.setMinutes(fecha.getMinutes() - fecha.getTimezoneOffset());
  return fecha.toISOString().split('T')[0];
}

function formatearFechaCortaEs(fechaIso) {
  if (!fechaIso || typeof fechaIso !== 'string') {
    return 'Sin fecha';
  }
  const partes = fechaIso.split('-');
  if (partes.length !== 3) {
    return fechaIso;
  }
  const [anio, mes, dia] = partes;
  return `${dia}-${mes}-${anio}`;
}

const PIE_DIABETICO_RIESGOS = {
  bajo: {
    titulo: 'Riesgo BAJO',
    recomendacion: 'Control anual y refuerzo de autocuidado del pie.',
    dias: 365,
    bg: '#dcfce7',
    border: '#bbf7d0',
    color: '#065f46'
  },
  moderado: {
    titulo: 'Riesgo MODERADO',
    recomendacion: 'Control en 6 meses. Refuerza educaci√≥n y uso de calzado protector.',
    dias: 180,
    bg: '#fef9c3',
    border: '#fde68a',
    color: '#92400e'
  },
  alto: {
    titulo: 'Riesgo ALTO',
    recomendacion: 'Evaluaci√≥n en 3 meses. Coordina atenci√≥n podol√≥gica prioritaria.',
    dias: 90,
    bg: '#fee2e2',
    border: '#fecaca',
    color: '#b91c1c'
  },
  maximo: {
    titulo: 'Riesgo M√ÅXIMO',
    recomendacion: 'Derivaci√≥n y evaluaci√≥n inmediata. Manejo intensivo del pie diab√©tico.',
    dias: 30,
    bg: '#ffe4e6',
    border: '#fecdd3',
    color: '#be123c'
  }
};

window._pieDiabeticoEvaluacion = null;

function obtenerValorRadioPie(nombre) {
  const seleccionado = document.querySelector(`input[name="${nombre}"]:checked`);
  return seleccionado ? seleccionado.value : null;
}

function valorRadioABool(valor) {
  if (valor === null || valor === undefined) return null;
  const txt = valor.toString().trim().toLowerCase();
  if (!txt) return null;
  if (['si', 's√≠', 's', 'true', '1'].includes(txt)) return true;
  if (['no', 'n', 'false', '0'].includes(txt)) return false;
  return null;
}

function calcularProximaEvaluacionPie(fechaIso, dias) {
  let base = fechaIso ? new Date(`${fechaIso}T00:00:00`) : new Date();
  if (Number.isNaN(base.getTime())) {
    base = new Date();
  }
  const futura = new Date(base);
  futura.setDate(futura.getDate() + dias);
  return obtenerFechaIsoLocal(futura);
}

function actualizarBotonGuardarPieDiabetico(desactivar) {
  const icono = document.getElementById('iconGuardarPieDiabetico');
  if (icono) {
    const disabled = Boolean(desactivar);
    icono.dataset.disabled = disabled ? 'true' : 'false';
    icono.setAttribute('aria-disabled', disabled ? 'true' : 'false');
    icono.style.display = 'inline-flex';
    icono.style.cursor = disabled ? 'not-allowed' : 'pointer';
    icono.style.opacity = disabled ? '0.5' : '1';
    icono.style.pointerEvents = disabled ? 'none' : 'auto';
    icono.tabIndex = disabled ? -1 : 0;
    console.log('[ü¶∂] Icono actualizado:', { disabled, visible: icono.offsetParent !== null });
  } else {
    console.warn('[ü¶∂] Icono NO encontrado en DOM');
  }
  const boton = document.getElementById('btnGuardarPieDiabetico');
  if (boton) {
    const disabled = Boolean(desactivar);
    boton.dataset.disabled = disabled ? 'true' : 'false';
    boton.setAttribute('aria-disabled', disabled ? 'true' : 'false');
    boton.style.display = 'inline-flex';
    boton.style.cursor = disabled ? 'not-allowed' : 'pointer';
    boton.style.opacity = disabled ? '0.5' : '1';
    boton.style.pointerEvents = disabled ? 'none' : 'auto';
    console.log('[ü¶∂] Bot√≥n actualizado:', { disabled, visible: boton.offsetParent !== null });
  } else {
    console.warn('[ü¶∂] Bot√≥n NO encontrado en DOM');
  }
}

function mostrarEstadoPieDiabetico(mensaje, color) {
  const estado = document.getElementById('estadoPieDiabetico');
  if (!estado) return;
  if (!mensaje) {
    estado.style.display = 'none';
    estado.textContent = '';
    return;
  }
  estado.style.display = 'block';
  estado.style.color = color || '#334155';
  estado.textContent = mensaje;
}

function evaluarRiesgoPieDiabetico() {
  const respuestas = {
    ulcera: obtenerValorRadioPie('ulceraPieOAmputacion'),
    sensibilidad: obtenerValorRadioPie('sensibilidadProtectora'),
    eap: obtenerValorRadioPie('EAP'),
    deformidad: obtenerValorRadioPie('DEF')
  };

  if (Object.values(respuestas).some((v) => v === null)) {
    mostrarEstadoPieDiabetico('Completa todas las preguntas antes de evaluar.', '#b91c1c');
    actualizarBotonGuardarPieDiabetico(true);
    window._pieDiabeticoEvaluacion = null;
    return;
  }

  const campos = {
    ulcera: valorRadioABool(respuestas.ulcera),
    sensibilidad: valorRadioABool(respuestas.sensibilidad),
    eap: valorRadioABool(respuestas.eap),
    deformidad: valorRadioABool(respuestas.deformidad)
  };

  let riesgo = 'bajo';
  if (campos.ulcera) {
    riesgo = 'maximo';
  } else if (campos.eap) {
    riesgo = 'alto';
  } else if (campos.sensibilidad || campos.deformidad) {
    riesgo = 'moderado';
  }

  const configuracion = PIE_DIABETICO_RIESGOS[riesgo] || PIE_DIABETICO_RIESGOS.bajo;
  const fechaInput = document.getElementById('fechaEvaluacionPieDiabetico');
  const fechaEvaluacion = (fechaInput && fechaInput.value) ? fechaInput.value : obtenerFechaIsoLocal();
  if (fechaInput && !fechaInput.value) {
    fechaInput.value = fechaEvaluacion;
  }
  const proxima = calcularProximaEvaluacionPie(fechaEvaluacion, configuracion.dias);

  const resultadoCaja = document.getElementById('resultadoPieDiabetico');
  if (resultadoCaja) {
    resultadoCaja.style.display = 'block';
    resultadoCaja.style.background = configuracion.bg;
    resultadoCaja.style.borderColor = configuracion.border;
    const contenido = resultadoCaja.querySelector('.resultado-contenido');
    if (contenido) {
      contenido.style.color = configuracion.color;
      contenido.innerHTML = `<strong>${configuracion.titulo}</strong><br>${configuracion.recomendacion}<br><span style="font-size:.75rem;">Pr√≥ximo control sugerido: ${formatearFechaCortaEs(proxima)}</span>`;
    }
  }

  actualizarBotonGuardarPieDiabetico(false);
  mostrarEstadoPieDiabetico('Resultado calculado. Presiona üíæ para guardar.', '#0369a1');

  window._pieDiabeticoEvaluacion = {
    campos,
    riesgo,
    recomendacion: configuracion.recomendacion,
    proximaEvaluacion: proxima,
    fechaEvaluacion
  };
}

async function guardarEvaluacionPieDiabetico() {
  try {
    const icono = document.getElementById('iconGuardarPieDiabetico');
    const boton = document.getElementById('btnGuardarPieDiabetico');
    const iconoDesactivado = icono?.dataset?.disabled === 'true';
    const botonDesactivado = boton?.dataset?.disabled === 'true';
    if (iconoDesactivado && botonDesactivado) {
      mostrarEstadoPieDiabetico('Calcula el riesgo antes de guardar.', '#64748b');
      return;
    }

    if (!window._pieDiabeticoEvaluacion) {
      evaluarRiesgoPieDiabetico();
    }
    const evaluacion = window._pieDiabeticoEvaluacion;
    if (!evaluacion) {
      mostrarEstadoPieDiabetico('No hay una evaluaci√≥n para guardar.', '#b91c1c');
      return;
    }

    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      mostrarEstadoPieDiabetico('Debe seleccionar un RUN v√°lido antes de guardar.', '#b91c1c');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      mostrarEstadoPieDiabetico('RUN inv√°lido, verifique el d√≠gito verificador.', '#b91c1c');
      return;
    }

    const payload = {
      run: runNormalizado,
      fecha_realizacion: evaluacion.fechaEvaluacion,
      ulcera_o_amputacion: evaluacion.campos.ulcera === true,
      sensibilidad_protectora: evaluacion.campos.sensibilidad === true,
      eap: evaluacion.campos.eap === true,
      deformidad: evaluacion.campos.deformidad === true,
      riesgo_nivel: evaluacion.riesgo,
      recomendacion: evaluacion.recomendacion,
      proxima_evaluacion: evaluacion.proximaEvaluacion,
      amputacion: evaluacion.campos.ulcera === true
    };

    mostrarEstadoPieDiabetico('Guardando evaluaci√≥n‚Ä¶', '#334155');

    const response = await authFetch('/api/examenes/pie_dm', {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    const ok = response.ok && (result.success || result.ok);
    if (!ok) {
      throw new Error(result.error || 'No se pudo guardar la evaluaci√≥n');
    }

    mostrarEstadoPieDiabetico('Guardado exitoso ‚úî', '#15803d');
    setTimeout(() => mostrarEstadoPieDiabetico('', '#15803d'), 4000);

    try {
      await cargarHistorialPieDiabetico(runNormalizado);
    } catch (err) {
      console.warn('[ü¶∂ Pie Diab√©tico] No se pudo refrescar el historial:', err);
    }

    try {
      await refrescarAlertasVigencia(runNormalizado, { origen: 'pie_dm' });
    } catch (err) {
      console.warn('[ü¶∂ Pie Diab√©tico] No se pudo refrescar alertas:', err);
    }

    actualizarBotonGuardarPieDiabetico(true);
  } catch (error) {
    console.error('[ü¶∂ Pie Diab√©tico] Error guardando evaluaci√≥n:', error);
    mostrarEstadoPieDiabetico(`Error al guardar: ${error.message}`, '#b91c1c');
  }
}

window.evaluarRiesgoPieDiabetico = evaluarRiesgoPieDiabetico;
window.guardarEvaluacionPieDiabetico = guardarEvaluacionPieDiabetico;

document.addEventListener('DOMContentLoaded', () => {
  const icono = document.getElementById('iconGuardarPieDiabetico');
  const boton = document.getElementById('btnGuardarPieDiabetico');
  
  console.log('[ü¶∂ Pie Diab√©tico] Inicializando botones:', {
    icono: icono ? 'encontrado' : 'NO ENCONTRADO',
    boton: boton ? 'encontrado' : 'NO ENCONTRADO'
  });
  
  if (icono || boton) {
    actualizarBotonGuardarPieDiabetico(true);
  } else {
    console.error('[ü¶∂ Pie Diab√©tico] ‚ö†Ô∏è BOTONES NO ENCONTRADOS EN EL DOM');
  }
});

async function guardarInsulina() {
  try {
    const enTratamiento = document.querySelector('input[name="enTratamientoInsulina"]:checked');
    const fechaInsulina = document.getElementById('fechaInsulina');
    if (!enTratamiento) {
      alert('Por favor seleccione si est√° en tratamiento con insulina');
      return;
    }

    const runField = document.getElementById('run');
    const runRaw = runField?.value?.trim();
    if (!runRaw) {
      alert('Debe ingresar un RUN v√°lido antes de guardar');
      return;
    }

    const runNormalizado = typeof formatearRunParaEnvio === 'function'
      ? formatearRunParaEnvio(runRaw)
      : runRaw;
    if (!runNormalizado) {
      alert('RUN inv√°lido, verifique el d√≠gito verificador');
      return;
    }

    const fechaSeleccionada = fechaInsulina?.value?.trim() || '';
    if (fechaSeleccionada && !/^\d{4}-\d{2}-\d{2}$/.test(fechaSeleccionada)) {
      alert('La fecha ingresada no es v√°lida. Use el formato AAAA-MM-DD');
      return;
    }

    const payload = {
      run: runNormalizado,
      en_tratamiento: enTratamiento.value === 'si',
      fecha_evaluacion: fechaSeleccionada || obtenerFechaIsoLocal()
    };

    console.log('[üíâ Insulina] Guardando:', payload);
    const response = await authFetch('/api/insulina-historial', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (response.ok && result.ok) {
      alert('Registro de insulina guardado exitosamente');
      window._runActivo = runNormalizado;
      await cargarUltimaInsulina(runNormalizado);
      await verificarUsoInsulina(runNormalizado);
      await refrescarAlertasVigencia(runNormalizado, { origen: 'insulina' });
    } else {
      throw new Error(result.error || 'Error desconocido');
    }
  } catch (error) {
    console.error('[üíâ Insulina] Error guardando:', error);
    alert('Error al guardar el registro de insulina: ' + error.message);
  }
}

function limpiarFormularioInsulina() {
  const form = document.getElementById('insulinaForm');
  if (form) form.reset();
  const fechaInsulina = document.getElementById('fechaInsulina');
  if (fechaInsulina) fechaInsulina.value = obtenerFechaIsoLocal();
  console.log('[üíâ Insulina] Formulario limpiado');
}

async function cargarHistorialInsulina(run) {
  try {
    if (!run) return;
    const response = await authFetch(`/api/insulina-historial/${run}?limit=10`);
    const result = await response.json();
    const historialDiv = document.getElementById('historialInsulina');
    const listaDiv = document.getElementById('listHistorialInsulina');
    if (!historialDiv || !listaDiv) return;

    if (response.ok && result.ok && Array.isArray(result.historial) && result.historial.length > 0) {
      const historialOrdenado = [...result.historial].sort((a, b) => {
        const fechaA = a?.fecha_evaluacion ? new Date(`${a.fecha_evaluacion}T00:00:00`) : new Date(0);
        const fechaB = b?.fecha_evaluacion ? new Date(`${b.fecha_evaluacion}T00:00:00`) : new Date(0);
        return fechaB - fechaA;
      });

      const registroVigente = historialOrdenado[0];
      historialDiv.style.display = 'block';

      const historialHTML = historialOrdenado.map(item => {
        const fechaLabel = formatearFechaCortaEs(item.fecha_evaluacion);
        const estadoActivo = Boolean(item.en_tratamiento);
        const estadoColor = estadoActivo ? '#2563eb' : '#16a34a';
        const estadoBg = estadoActivo ? '#dbeafe' : '#dcfce7';
        const estadoTexto = estadoActivo ? 'EN TRATAMIENTO' : 'SIN INSULINA';
        const destacado = registroVigente && registroVigente.id === item.id;
        const borde = destacado ? `border:1px solid ${estadoColor};` : 'border:1px solid #e5e7eb;';
        const etiquetaVigente = destacado ? '<span style="font-size:0.65rem;color:#4338ca;background:#ede9fe;padding:2px 6px;border-radius:999px;">Registro vigente</span>' : '';

        return `<div style="padding:8px 12px;${borde}margin-bottom:6px;border-radius:6px;display:flex;justify-content:space-between;align-items:center;background:#fff;">
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap;">
              <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fechaLabel}</span>
              <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">${estadoTexto}</span>
              ${etiquetaVigente}
            </div>
          </div>
          <div style="font-size:0.65rem;color:#9ca3af;">${item.funcionario || 'Sistema'}</div>
        </div>`;
      }).join('');

      listaDiv.innerHTML = historialHTML;
      actualizarEstadoInsulinaVigente(registroVigente);
    } else {
      historialDiv.style.display = 'block';
      listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de insulina</div>';
      actualizarEstadoInsulinaVigente(null);
    }
  } catch (error) {
    console.error('[üíâ Insulina] Error cargando historial:', error);
    const historialDiv = document.getElementById('historialInsulina');
    if (historialDiv) historialDiv.style.display = 'none';
  }
}

async function cargarUltimaInsulina(run) {
  try {
    if (!run) return;
    const response = await authFetch(`/api/insulina-historial/${run}/ultima`);
    const result = await response.json();
    if (response.ok && result.ok && result.registro) {
      const registro = result.registro;
      const insulinaSi = document.querySelector('input[name="enTratamientoInsulina"][value="si"]');
      const insulinaNo = document.querySelector('input[name="enTratamientoInsulina"][value="no"]');
      const fechaInsulina = document.getElementById('fechaInsulina');
      if (registro.en_tratamiento) {
        if (insulinaSi) insulinaSi.checked = true;
      } else {
        if (insulinaNo) insulinaNo.checked = true;
      }
      if (fechaInsulina) {
        fechaInsulina.value = registro.fecha_evaluacion || obtenerFechaIsoLocal();
      }
      actualizarEstadoInsulinaVigente(registro);
    } else {
      actualizarEstadoInsulinaVigente(null);
    }
    await cargarHistorialInsulina(run);
  } catch (error) {
    console.error('[üíâ Insulina] Error cargando √∫ltima evaluaci√≥n:', error);
  }
}

function actualizarEstadoInsulinaVigente(registro) {
  try {
    const banner = document.getElementById('diagnosticoInsulina');
    if (!banner) return;
    if (registro && registro.en_tratamiento) {
      banner.style.display = 'block';
    } else {
      banner.style.display = 'none';
    }
  } catch (error) {
    console.warn('[üíâ Insulina] No se pudo actualizar banner vigente:', error);
  }
}

// === FUNCIONES FONDO DE OJOS (ANTES DE DOM READY) ===

async function guardarFondoOjos() {
  try {
    const fondoOjos = document.querySelector('input[name="fondoOjos"]:checked');
    const fechaFondoOjos = document.getElementById('fechaFondoOjos');
    if (!fondoOjos) {
      alert('Por favor seleccione si se realiz√≥ fondo de ojos');
      return;
    }
    const runField = document.getElementById('run');
    if (!runField || !runField.value.trim()) {
      alert('Debe ingresar un RUN v√°lido antes de guardar');
      return;
    }
    if (!fechaFondoOjos.value || fechaFondoOjos.value.trim() === '') {
      alert('Por favor ingrese la fecha del fondo de ojos');
      return;
    }
    const payload = {
      run: runField.value.trim(),
      fecha: fechaFondoOjos.value,
      resultado: fondoOjos.value === 'si' ? 'realizado' : 'no_realizado'
    };
    console.log('[üëÅÔ∏è Fondo de Ojos] Guardando (historial):', payload);
    const response = await fetch('/api/examenes/fondo_ojos', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    const success = Boolean(result.success ?? result.ok);
    if (response.ok && success) {
      alert('Fondo de ojos guardado exitosamente');
      const runNorm = runField.value.trim();
      await cargarUltimoFondoOjos(runNorm);
      console.log('[üëÅÔ∏è Fondo de Ojos] Guardado exitoso:', result);
    } else {
      throw new Error(result.error || result.message || 'Error desconocido');
    }
  } catch (error) {
    console.error('[üëÅÔ∏è Fondo de Ojos] Error guardando:', error);
    alert('Error al guardar el fondo de ojos: ' + error.message);
  }
}

function limpiarFormularioFondoOjos() {
  const form = document.getElementById('fondoOjosForm');
  if (form) form.reset();
  const fechaFondoOjos = document.getElementById('fechaFondoOjos');
  if (fechaFondoOjos) fechaFondoOjos.value = '';
  console.log('[üëÅÔ∏è Fondo de Ojos] Formulario limpiado');
}

window.guardarFondoOjos = guardarFondoOjos;
window.limpiarFormularioFondoOjos = limpiarFormularioFondoOjos;

// Attach event listeners para Fondo de Ojos INMEDIATAMENTE (no esperar DOMContentLoaded)
(function attachFondoOjosListeners() {
  const fondoGuardar = document.getElementById('fondoOjosGuardarBtn');
  if (fondoGuardar) {
    fondoGuardar.addEventListener('click', guardarFondoOjos);
  }
  const fondoLimpiar = document.getElementById('fondoOjosLimpiarBtn');
  if (fondoLimpiar) {
    fondoLimpiar.addEventListener('click', limpiarFormularioFondoOjos);
  }
})();

document.addEventListener('DOMContentLoaded', () => {
  const fechaInsulina = document.getElementById('fechaInsulina');
  if (fechaInsulina && !fechaInsulina.value) {
    fechaInsulina.value = obtenerFechaIsoLocal();
  }
});

// === FUNCIONES ATENCI√ìN POD√ìLOGA ===

// Funci√≥n para guardar atenci√≥n podol√≥gica
async function guardarPodologia() {
    try {
        // Obtener los valores del formulario
        const atencionPodologa = document.querySelector('input[name="atencionPodologa"]:checked');
        const fechaPodologia = document.getElementById('fechaPodologia');
        
        // Validar campos requeridos
        if (!atencionPodologa) {
            alert('Por favor seleccione si tiene atenci√≥n podol√≥gica vigente');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        const atencionVigenteBool = atencionPodologa.value === 'si';
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            atencion_vigente: atencionVigenteBool,
            fecha: fechaPodologia.value || new Date().toISOString().split('T')[0]
        };
        
        console.log('[ü¶∂ Podolog√≠a] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/podologia-historial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Atenci√≥n podol√≥gica guardada exitosamente');
            // Recargar historial
            cargarHistorialPodologia(runField.value.trim());
            console.log('[ü¶∂ Podolog√≠a] Guardado exitoso:', result);
    } else {
      throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[ü¶∂ Podolog√≠a] Error guardando:', error);
        alert('Error al guardar la atenci√≥n podol√≥gica: ' + error.message);
    }
}

// Funci√≥n para guardar hipoglicemia
async function guardarHipoglicemias() {
    try {
        // Obtener los valores del formulario
        const hipoglicemiaSi = document.querySelector('input[name="hipoglicemiasRecurrentes"][value="si"]');
        const hipoglicemiaNo = document.querySelector('input[name="hipoglicemiasRecurrentes"][value="no"]');
        const fechaHipoglicemia = document.getElementById('fechaHipoglicemias');
        const recurrenteCheckbox = document.querySelector('input[name="hipoglicemiasRecurrentes"]:checked');
        
        // Validar que se haya seleccionado una opci√≥n
        const tieneHipoglicemia = hipoglicemiaSi && hipoglicemiaSi.checked;
        const noTieneHipoglicemia = hipoglicemiaNo && hipoglicemiaNo.checked;
        
        if (!tieneHipoglicemia && !noTieneHipoglicemia) {
            alert('Por favor seleccione si tiene hipoglicemias o no');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Solo guardar si tiene hipoglicemias
        if (!tieneHipoglicemia) {
            alert('No se guardar√° registro ya que no tiene hipoglicemias');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            fecha: fechaHipoglicemia ? fechaHipoglicemia.value : new Date().toISOString().split('T')[0],
            recurrente: recurrenteCheckbox ? recurrenteCheckbox.checked : false
        };
        
        console.log('[ü©∏ Hipoglicemias] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/hipoglicemias-historial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Hipoglicemia guardada exitosamente');
            // Recargar historial
            cargarHistorialHipoglicemias(runField.value.trim());
            console.log('[ü©∏ Hipoglicemias] Guardado exitoso:', result);
    } else {
      throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[ü©∏ Hipoglicemias] Error guardando:', error);
        alert('Error al guardar la hipoglicemia: ' + error.message);
    }
}

// Funci√≥n para guardar amputaci√≥n
async function guardarAmputacion() {
  try {
    const seleccion = document.querySelector('input[name="tieneAmputacion"]:checked');
    const fechaAmputacion = document.getElementById('fechaAmputacion');
    const tipoAmputacion = document.getElementById('tipoAmputacion');

    if (!seleccion) {
      alert('Por favor seleccione si tiene amputaci√≥n');
      return;
    }

    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN v√°lido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inv√°lido, verifique el d√≠gito verificador');
      return;
    }

    const tieneAmputacion = seleccion.value === 'si';
    const fechaSeleccionada = fechaAmputacion?.value?.trim() || '';

    if (tieneAmputacion && !fechaSeleccionada) {
      alert('Debe ingresar la fecha de la amputaci√≥n');
      return;
    }

    const fechaEvaluacion = fechaSeleccionada || obtenerFechaIsoLocal();
    const payload = {
      run: runNormalizado,
      amputacion: tieneAmputacion,
      fecha_amputacion: tieneAmputacion ? fechaSeleccionada : null,
      fecha_evaluacion: fechaEvaluacion,
      tipo_amputacion: tieneAmputacion && tipoAmputacion ? (tipoAmputacion.value || null) : null
    };

    console.log('[ü¶µ Amputaci√≥n] Guardando:', payload);

    const response = await authFetch('/api/examenes-piedm/amputacion', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (!response.ok || !(result.ok || result.success)) {
      throw new Error(result.error || 'Error desconocido');
    }

    alert('Registro de amputaci√≥n guardado exitosamente');
    await cargarHistorialAmputacion(runNormalizado);
    await refrescarAlertasVigencia(runNormalizado, { origen: 'amputacion' });
    console.log('[ü¶µ Amputaci√≥n] Guardado exitoso:', result);
  } catch (error) {
    console.error('[ü¶µ Amputaci√≥n] Error guardando:', error);
    alert('Error al guardar la amputaci√≥n: ' + error.message);
  }
}

// Funci√≥n para limpiar formulario de podolog√≠a
function limpiarFormularioPodologia() {
    const form = document.getElementById('podologiaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaPodologia = document.getElementById('fechaPodologia');
    if (fechaPodologia) {
        fechaPodologia.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[ü¶∂ Podolog√≠a] Formulario limpiado');
}

// Funci√≥n para limpiar formulario de hipoglicemias
function limpiarFormularioHipoglicemias() {
    const form = document.getElementById('hipoglicemiasForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaHipoglicemias = document.getElementById('fechaHipoglicemias');
    if (fechaHipoglicemias) {
        fechaHipoglicemias.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[ü©∏ Hipoglicemias] Formulario limpiado');
}

// Funci√≥n para limpiar formulario de amputaci√≥n
function limpiarFormularioAmputacion() {
    const form = document.getElementById('amputacionForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaAmputacion = document.getElementById('fechaAmputacion');
    if (fechaAmputacion) {
        fechaAmputacion.value = '';
    }
    
    console.log('[ü¶µ Amputaci√≥n] Formulario limpiado');
}

// ======= FUNCIONES EVALUACI√ìN ADULTO MAYOR =======

// Funci√≥n para calcular clasificaci√≥n TUG autom√°ticamente
function calcularClasificacionTUG() {
    const tugSegundos = document.getElementById('tugSegundos');
    const tugClasificacion = document.getElementById('tugClasificacion');
    
    if (tugSegundos && tugClasificacion && tugSegundos.value) {
        const segundos = parseFloat(tugSegundos.value);
        let clasificacion = '';
        
        if (segundos <= 10) {
            clasificacion = 'Bajo riesgo de ca√≠das';
        } else if (segundos >= 11 && segundos <= 19) {
            clasificacion = 'Riesgo leve/intermedio';
        } else if (segundos >= 20) {
            clasificacion = 'Alto riesgo de ca√≠das';
        }
        
        tugClasificacion.value = clasificacion;
    }
}

// Funci√≥n para calcular clasificaci√≥n Unipodal autom√°ticamente
function calcularClasificacionUnipodal() {
    const pieDerecho = document.getElementById('unipodalPieDerecho');
    const pieIzquierdo = document.getElementById('unipodalPieIzquierdo');
    const clasificacion = document.getElementById('unipodalClasificacion');
    
    if (pieDerecho && pieIzquierdo && clasificacion) {
        const derecho = parseFloat(pieDerecho.value) || 0;
        const izquierdo = parseFloat(pieIzquierdo.value) || 0;
        
        // Usar el menor tiempo como referencia
        const menorTiempo = Math.min(derecho, izquierdo);
        let resultado = '';
        
        if (menorTiempo < 5) {
            resultado = 'Alto riesgo de ca√≠das';
        } else if (menorTiempo >= 5 && menorTiempo <= 30) {
            resultado = 'Riesgo intermedio';
        } else if (menorTiempo > 30) {
            resultado = 'Bajo riesgo de ca√≠das';
        }
        
        clasificacion.value = resultado;
    }
}

// Funci√≥n para guardar evaluaci√≥n de adulto mayor
async function guardarEvaluacionAdultoMayor() {
  try {
    // Obtener valores del formulario
    const fechaEvaluacion = document.getElementById('fechaEvaluacionAM');
    const funcionalidad = document.getElementById('funcionalidadAM');
    const tugSegundos = document.getElementById('tugSegundos');
    const tugClasificacion = document.getElementById('tugClasificacion');
    const unipodalDerecho = document.getElementById('unipodalPieDerecho');
    const unipodalIzquierdo = document.getElementById('unipodalPieIzquierdo');
    const unipodalClasificacion = document.getElementById('unipodalClasificacion');
    const observaciones = document.getElementById('observacionesAM');

    // Validaciones
    if (!fechaEvaluacion || !fechaEvaluacion.value) {
      alert('Debe ingresar la fecha de evaluaci√≥n');
      return;
    }

    if (!funcionalidad || !funcionalidad.value) {
      alert('Debe seleccionar el nivel de funcionalidad');
      return;
    }

    // Obtener el RUN actual
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN v√°lido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inv√°lido, verifique el d√≠gito verificador');
      return;
    }

    const resultadoMap = {
      autovalente: 'Autovalente',
      autovalente_con_riesgo: 'Autovalente con Riesgo',
      riesgo_dependencia: 'Riesgo de Dependencia',
      dependencia_leve: 'Dependencia Leve',
      dependencia_moderada: 'Dependencia Moderada',
      dependencia_total: 'Dependencia Total'
    };

    const resultadoClave = funcionalidad.value;
    const resultadoNormalizado = resultadoMap[resultadoClave] || resultadoClave;

    // Preparar datos
    const data = {
      run: runNormalizado,
      usuario_id: runNormalizado,
      fecha_aplicacion: fechaEvaluacion.value,
      resultado: resultadoNormalizado,
      tug_seg: tugSegundos && tugSegundos.value ? parseFloat(tugSegundos.value) : null,
      tug_clasificacion: tugClasificacion ? tugClasificacion.value : null,
      unipodal_seg_pie_der: unipodalDerecho && unipodalDerecho.value ? parseFloat(unipodalDerecho.value) : null,
      unipodal_seg_pie_izq: unipodalIzquierdo && unipodalIzquierdo.value ? parseFloat(unipodalIzquierdo.value) : null,
      unipodal_clasificacion: unipodalClasificacion ? unipodalClasificacion.value : null,
      observaciones: observaciones ? observaciones.value : null
    };

    console.log('[üë¥ Adulto Mayor] Guardando evaluaci√≥n:', data);

    // Enviar al servidor
    const response = await authFetch('/api/examenes/adulto_mayor', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok && result.ok) {
      alert('Evaluaci√≥n de adulto mayor guardada exitosamente');
      // Recargar historial
      window._runActivo = runNormalizado;
      cargarHistorialAdultoMayor(runNormalizado);
      console.log('[üë¥ Adulto Mayor] Guardado exitoso:', result);
    } else {
      throw new Error(result.error || 'Error desconocido');
    }
  } catch (error) {
    console.error('[üë¥ Adulto Mayor] Error guardando:', error);
    alert('Error al guardar la evaluaci√≥n: ' + error.message);
  }
}

// Funci√≥n para limpiar formulario de adulto mayor
function limpiarFormularioAdultoMayor() {
    const form = document.getElementById('adultoMayorForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaEvaluacion = document.getElementById('fechaEvaluacionAM');
    if (fechaEvaluacion) {
        fechaEvaluacion.value = new Date().toISOString().split('T')[0];
    }
    
    // Limpiar campos calculados
    const tugClasificacion = document.getElementById('tugClasificacion');
    const unipodalClasificacion = document.getElementById('unipodalClasificacion');
    
    if (tugClasificacion) tugClasificacion.value = '';
    if (unipodalClasificacion) unipodalClasificacion.value = '';
    
    console.log('[üë¥ Adulto Mayor] Formulario limpiado');
}

// Funci√≥n para cargar historial de evaluaciones de adulto mayor
async function cargarHistorialAdultoMayor(run) {
    try {
        if (!run) return;
        
        console.log('[üë¥ Adulto Mayor] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialAdultoMayor');
        const listaDiv = document.getElementById('listHistorialAdultoMayor');
        
        if (!historialDiv || !listaDiv) {
            console.error('[üë¥ Adulto Mayor] No se encontraron elementos del historial');
            return;
        }
        
        const response = await authFetch(`/api/examenes/adulto_mayor/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üë¥ Adulto Mayor] Respuesta del historial:', result);
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(evaluacion => {
                    let fecha = 'Sin fecha';
                    if (evaluacion.fecha_aplicacion) {
                        fecha = new Date(evaluacion.fecha_aplicacion).toLocaleDateString('es-CL');
                    }
                    
                    // Mapear resultado a texto legible
                    const resultadosMap = {
                        'autovalente': 'Autovalente',
                        'autovalente_con_riesgo': 'Autovalente con Riesgo',
                        'riesgo_dependencia': 'Riesgo de Dependencia',
                        'dependencia_leve': 'Dependencia Leve',
                        'dependencia_moderada': 'Dependencia Moderada',
                        'dependencia_total': 'Dependencia Total'
                    };
                    
                    const resultado = resultadosMap[evaluacion.resultado] || evaluacion.resultado;
                    
                    // Color seg√∫n nivel de funcionalidad
                    let estadoColor = '#16a34a';
                    let estadoBg = '#dcfce7';
                    
                    if (evaluacion.resultado.includes('dependencia')) {
                        estadoColor = '#dc2626';
                        estadoBg = '#fecaca';
                    } else if (evaluacion.resultado.includes('riesgo')) {
                        estadoColor = '#f59e0b';
                        estadoBg = '#fef3c7';
                    }
                    
                    return `<div style="padding:12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            ${evaluacion.tug_seg ? `<div style="font-size:0.7rem;color:#6b7280;">TUG: ${evaluacion.tug_seg}s</div>` : ''}
                        </div>
                        <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${resultado}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay evaluaciones registradas</div>';
            }
        } else {
            console.error('[üë¥ Adulto Mayor] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üë¥ Adulto Mayor] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de atenci√≥n podol√≥gica
async function cargarHistorialPodologia(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶∂ Podolog√≠a] Cargando historial para:', run);
        
    const response = await authFetch(`/api/diabetes/podologia/historial/${encodeURIComponent(run)}`);
    const result = await response.json();
        
        const historialDiv = document.getElementById('historialPodologia');
        const listaDiv = document.getElementById('listHistorialPodologia');
        
        if (!historialDiv || !listaDiv) {
            console.error('[ü¶∂ Podolog√≠a] No se encontraron elementos del historial');
            return;
        }
        
    const success = result?.ok === true || result?.success === true;
    const registros = Array.isArray(result?.historial)
      ? result.historial
      : Array.isArray(result?.data)
        ? result.data
        : [];

    if (response.ok && success && registros.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
      console.log('[ü¶∂ Podolog√≠a] Mostrando historial con', registros.length, 'registros');
            
            // Generar HTML del historial
      const historialHTML = registros.map(atencion => {
                const fecha = new Date(atencion.fecha).toLocaleDateString('es-CL');
                const estadoColor = atencion.atencion_vigente ? '#059669' : '#6b7280';
                const estadoBg = atencion.atencion_vigente ? '#d1fae5' : '#f3f4f6';
                const estadoTexto = atencion.atencion_vigente ? 'ATENCI√ìN VIGENTE' : 'SIN ATENCI√ìN';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${atencion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
      console.log('[ü¶∂ Podolog√≠a] Historial cargado:', registros.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de atenci√≥n podol√≥gica</div>';
            console.log('[ü¶∂ Podolog√≠a] Sin historial para este usuario');
        }
    } catch (error) {
        console.error('[ü¶∂ Podolog√≠a] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialPodologia');
        if (historialDiv) {
            historialDiv.style.display = 'none';
        }
    }
}

// Funci√≥n para cargar √∫ltima atenci√≥n podol√≥gica
async function cargarUltimaPodologia(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶∂ Podolog√≠a] Cargando √∫ltima atenci√≥n para:', run);
        
        const response = await authFetch(`/api/podologia-historial/${run}/ultima`);
        const result = await response.json();
        
        if (response.ok && result.ok && result.atencion) {
            const atencion = result.atencion;
            
            // Cargar valores en el formulario
            const podologiaSi = document.querySelector('input[name="atencionPodologa"][value="si"]');
            const podologiaNo = document.querySelector('input[name="atencionPodologa"][value="no"]');
            const fechaPodologia = document.getElementById('fechaPodologia');
            
            if (atencion.atencion_vigente) {
                if (podologiaSi) podologiaSi.checked = true;
            } else {
                if (podologiaNo) podologiaNo.checked = true;
            }
            
            if (fechaPodologia) {
                fechaPodologia.value = atencion.fecha || new Date().toISOString().split('T')[0];
            }
            
            console.log('[ü¶∂ Podolog√≠a] √öltima atenci√≥n cargada:', atencion);
        } else {
            console.log('[ü¶∂ Podolog√≠a] No hay atenciones previas para este usuario');
        }
        
        // Cargar historial
        await cargarHistorialPodologia(run);
        
    } catch (error) {
        console.error('[ü¶∂ Podolog√≠a] Error cargando √∫ltima atenci√≥n:', error);
    }
}

// Funci√≥n para cargar historial de fondo de ojos
async function cargarHistorialFondoOjos(run) {
    try {
        if (!run) return;

        console.log('[üëÅÔ∏è Fondo de Ojos] Cargando historial para:', run);

        const historialDiv = document.getElementById('historialFondoOjos');
        const listaDiv = document.getElementById('listHistorialFondoOjos');

        if (!historialDiv || !listaDiv) {
            console.error('[üëÅÔ∏è Fondo de Ojos] No se encontraron elementos del historial');
            return;
        }

        const response = await authFetch(`/api/examenes/fondo_ojos/historial/${encodeURIComponent(run)}`);

        if (response.ok) {
            const result = await response.json();
            console.log('[üëÅÔ∏è Fondo de Ojos] Respuesta del historial:', result);

            const success = Boolean(result.success ?? result.ok);
            const items = result.data || result.historial || [];

            if (success && items.length > 0) {
                historialDiv.style.display = 'block';

                const historialHTML = items
                    .map(item => {
                        let fecha = 'Sin fecha';
                        if (item.fecha) {
                            fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                        }

                        if (fecha === 'Invalid Date') {
                            fecha = 'Sin fecha';
                        }

                        const resultadoRaw = (item.resultado || item.estado || '').trim();
                        const resultadoLower = resultadoRaw.toLowerCase();
                        const esNegativo = resultadoLower.startsWith('no') || resultadoLower.includes('pendiente');
                        const esPositivo = !esNegativo && (resultadoLower.includes('realizado') || resultadoLower.includes('normal') || resultadoLower.includes('vigente'));
                        const estadoColor = esPositivo ? '#059669' : '#dc2626';
                        const estadoBg = esPositivo ? '#d1fae5' : '#fef2f2';
                        const estadoTexto = (resultadoRaw || 'SIN RESULTADO').replace(/_/g, ' ').toUpperCase();
                        const observaciones = (item.observaciones || '').trim();

                        const observacionesHtml = observaciones
                            ? `<div style="margin-top:4px;font-size:0.7rem;color:#6b7280;text-align:right;">${observaciones}</div>`
                            : '';

                        return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
                                <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                            </div>
                            ${observacionesHtml}
                        </div>`;
                    })
                    .join('');

                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de fondo de ojos</div>';
            }
        } else {
            console.error('[üëÅÔ∏è Fondo de Ojos] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    } catch (error) {
        console.log('[üëÅÔ∏è Fondo de Ojos] Historial no disponible');
        const historialDiv = document.getElementById('historialFondoOjos');
        if (historialDiv) {
            historialDiv.style.display = 'none';
        }
    }
}

// === Helpers para cargarUltimoFondoOjos ===
function _bySel(sel) { return document.querySelector(sel); }
function _byId(id) { return document.getElementById(id); }
function _setCheckedIf(el) { if (el) el.checked = true; }
function _setValueIf(el, v) { if (el && v != null) el.value = v; }

function _markRadioFondoSi() { _setCheckedIf(_bySel('input[name="fondoOjos"][value="si"]')); }
function _markRadioFondoNo() { _setCheckedIf(_bySel('input[name="fondoOjos"][value="no"]')); }

// Funci√≥n para cargar √∫ltimo fondo de ojos
async function cargarUltimoFondoOjos(run) {
    try {
        if (!run) return;

        console.log('[üëÅÔ∏è Fondo de Ojos] Cargando √∫ltimo examen para:', run);

        const response = await authFetch(`/api/examenes/fondo_ojos/${encodeURIComponent(run)}`);

        if (!response.ok) {
            console.log('[üëÅÔ∏è Fondo de Ojos] No hay datos disponibles (status:', response.status + ')');
            return;
        }

        const result = await response.json();
        const success = Boolean(result.success ?? result.ok);
        const data = result.data || null;
        const found = result.found ?? Boolean(data);

        if (success && found && data) {
            const fechaFondoOjos = _byId('fechaFondoOjos');
            const resultadoRaw = (data.resultado || data.estado || '').trim();
            const resultadoLower = resultadoRaw.toLowerCase();

            if (resultadoLower.startsWith('no') || resultadoLower.includes('pendiente')) {
                _markRadioFondoNo();
            } else if (resultadoLower) {
                _markRadioFondoSi();
            }

            if (fechaFondoOjos && data.fecha) {
                _setValueIf(fechaFondoOjos, data.fecha);
            }

            console.log('[üëÅÔ∏è Fondo de Ojos] √öltimo examen cargado:', data);
        } else {
            console.log('[üëÅÔ∏è Fondo de Ojos] No hay ex√°menes previos para este usuario');
        }

        await cargarHistorialFondoOjos(run);
    } catch (error) {
        console.log('[üëÅÔ∏è Fondo de Ojos] Funci√≥n ejecutada (sin datos disponibles)');
    }
}

// Funci√≥n para cargar historial de curaciones
async function cargarHistorialCuraciones(run) {
    try {
        if (!run) return;
        
        console.log('[ü©π Curaciones] Cargando historial para:', run);
        
        const response = await authFetch(`/api/examenes/curaciones_piedm/historial/${encodeURIComponent(run)}`);
        
        const historialDiv = document.getElementById('historialCuraciones');
        const listaDiv = document.getElementById('listHistorialCuraciones');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü©π Curaciones] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(curacion => {
                    const fecha = new Date(curacion.fecha).toLocaleDateString('es-CL');
                    const estadoColor = curacion.en_curacion ? '#059669' : '#dc2626';
                    const estadoBg = curacion.en_curacion ? '#d1fae5' : '#fef2f2';
                    const estadoTexto = curacion.en_curacion ? 'EN CURACI√ìN' : 'SIN CURACI√ìN';
                    
                    return `<div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                            <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                ${estadoTexto}
                            </span>
                        </div>
                        ${curacion.tipo ? `<div style="font-size:0.7rem;color:#6b7280;">Tipo: ${curacion.tipo}</div>` : ''}
                        ${curacion.funcionario ? `<div style="font-size:0.65rem;color:#9ca3af;margin-top:4px;">Por: ${curacion.funcionario}</div>` : ''}
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de curaciones</div>';
            }
        } else {
            console.error('[ü©π Curaciones] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    } catch (error) {
        console.error('[ü©π Curaciones] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de EKG
async function cargarHistorialEkg(run) {
    try {
        if (!run) return;
        
        console.log('[‚ö° EKG] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialEkg');
        const listaDiv = document.getElementById('listHistorialEkg');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/ekg/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[‚ö° EKG] Respuesta del historial:', result);
            
            if (result.success && result.found && result.data) {
                historialDiv.style.display = 'block';
                
                const ekg = result.data;
                let fecha = 'Sin fecha';
                if (ekg.fecha_ekg) {
                    fecha = new Date(ekg.fecha_ekg).toLocaleDateString('es-CL');
                } else if (ekg.fecha) {
                    fecha = new Date(ekg.fecha).toLocaleDateString('es-CL');
                }
                
                if (fecha === 'Invalid Date') {
                    fecha = 'Sin fecha';
                }
                
                const historialHTML = `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                    <span style="background:#e0f2fe;color:#0284c7;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">EKG</span>
                </div>`;
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de EKG</div>';
            }
        } else {
            console.error('[‚ö° EKG] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial EKG</div>';
        }
        
    } catch (error) {
        console.error('[‚ö° EKG] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialEkg');
        const listaDiv = document.getElementById('listHistorialEkg');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    }
}

// Funci√≥n para cargar historial de hipoglicemias
async function cargarHistorialHipoglicemias(run) {
    try {
        if (!run) return;
        
        console.log('[ü©∏ Hipoglicemias] Cargando historial para:', run);
        
        const response = await authFetch(`/api/diabetes/hipoglicemias/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialHipoglicemias');
        const listaDiv = document.getElementById('listHistorialHipoglicemias');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(hipoglicemia => {
                const fecha = new Date(hipoglicemia.fecha).toLocaleDateString('es-CL');
                const estadoColor = hipoglicemia.recurrente ? '#dc2626' : '#059669';
                const estadoBg = hipoglicemia.recurrente ? '#fef2f2' : '#d1fae5';
                const estadoTexto = hipoglicemia.recurrente ? 'PRESENTA' : 'NO PRESENTA';
                
                return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                    <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                </div>`;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de hipoglicemias</div>';
        }
    } catch (error) {
        console.error('[ü©∏ Hipoglicemias] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de amputaci√≥n
async function cargarHistorialAmputacion(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶ø Amputaci√≥n] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialAmputacion');
        const listaDiv = document.getElementById('listHistorialAmputacion');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/pie_dm/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü¶ø Amputaci√≥n] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                // Filtrar solo registros con amputaci√≥n
                const amputaciones = result.data.filter(item => item.amputacion === true);
                
                if (amputaciones.length > 0) {
                    historialDiv.style.display = 'block';
                    
                    const historialHTML = amputaciones.map(item => {
                        let fecha = 'Sin fecha';
                        if (item.fecha_amputacion) {
                            fecha = new Date(item.fecha_amputacion).toLocaleDateString('es-CL');
                        } else if (item.fecha_realizacion) {
                            fecha = new Date(item.fecha_realizacion).toLocaleDateString('es-CL');
                        } else if (item.fecha) {
                            fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                        }
                        
                        if (fecha === 'Invalid Date') {
                            fecha = 'Sin fecha';
                        }
                        
                        const estadoColor = '#dc2626';
                        const estadoBg = '#fef2f2';
                        const estadoTexto = 'AMPUTACI√ìN';
                        
                        return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                        </div>`;
                    }).join('');
                    
                    listaDiv.innerHTML = historialHTML;
                } else {
                    historialDiv.style.display = 'block';
                    listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de amputaci√≥n</div>';
                }
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de amputaci√≥n</div>';
            }
        } else {
            console.error('[ü¶ø Amputaci√≥n] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
        
    } catch (error) {
        console.error('[ü¶ø Amputaci√≥n] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de pie diab√©tico
async function cargarHistorialPieDiabetico(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶∂ Pie Diab√©tico] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialPieDiabetico');
        const listaDiv = document.getElementById('listHistorialPieDiabetico');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/pie_dm/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü¶∂ Pie Diab√©tico] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(item => {
                    // Manejar m√∫ltiples formatos de fecha
                    let fecha = 'Sin fecha';
                    if (item.fecha_realizacion) {
                        fecha = new Date(item.fecha_realizacion).toLocaleDateString('es-CL');
                    } else if (item.fecha) {
                        fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                    }
                    
                    // Si la fecha es inv√°lida, usar la fecha actual como fallback
                    if (fecha === 'Invalid Date') {
                        fecha = 'Sin fecha';
                    }
                    
                    const riesgoColor = item.riesgo_nivel === 'Alto' ? '#dc2626' : item.riesgo_nivel === 'Medio' ? '#f59e0b' : '#16a34a';
                    const riesgoBg = item.riesgo_nivel === 'Alto' ? '#fecaca' : item.riesgo_nivel === 'Medio' ? '#fef3c7' : '#dcfce7';
                    const riesgo = item.riesgo_nivel || item.riesgo || 'N/A';
                    
                    return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                        <span style="background:${riesgoBg};color:${riesgoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${riesgo}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay evaluaciones de pie diab√©tico registradas</div>';
            }
        } else {
            console.error('[ü¶∂ Pie Diab√©tico] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
        
    } catch (error) {
        console.error('[ü¶∂ Pie Diab√©tico] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialPieDiabetico');
        const listaDiv = document.getElementById('listHistorialPieDiabetico');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    }
}

// ================= FUNCIONES DE F√ÅRMACOS =================

// Funci√≥n para guardar IECA/ARA II
async function guardarIecaAra() {
  try {
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN v√°lido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inv√°lido, verifique el d√≠gito verificador');
      return;
    }

    const tipoIecaAraRaw = document.getElementById('tipoIecaAra').value;
    const fechaIecaAra = document.getElementById('fechaIecaAra').value;

    if (!tipoIecaAraRaw || !fechaIecaAra) {
      alert('Debe completar todos los campos');
      return;
    }

    const tipoNormalizado = tipoIecaAraRaw.trim().toUpperCase();
    if (tipoNormalizado === 'NO') {
      alert('Para registrar ausencia de IECA/ARA II deja el campo sin selecci√≥n o elimina el registro previo.');
      return;
    }
    if (!tipoNormalizado) {
      alert('Seleccione un tipo v√°lido de IECA/ARA II');
      return;
    }

    const payload = {
      run: runNormalizado,
      fecha: fechaIecaAra,
      tipo: tipoNormalizado
    };

    console.log('[üíä IECA/ARA II] Guardando:', payload);

    const response = await authFetch('/api/medicacion/ieca_ara', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    console.log('[üíä IECA/ARA II] Response status:', response.status);
    
    let result;
    try {
      result = await response.json();
    } catch (e) {
      console.error('[üíä IECA/ARA II] Error parseando JSON:', e);
      alert('Error: respuesta inv√°lida del servidor');
      return;
    }
    
    console.log('[üíä IECA/ARA II] Result:', result);

    if (response.ok && (result.success || result.ok)) {
      console.log('[üíä IECA/ARA II] Guardado exitosamente');
      alert('IECA/ARA II guardado exitosamente');
      limpiarFormularioIecaAra();
      window._runActivo = runNormalizado;
      await cargarHistorialIecaAra(runNormalizado);
    } else {
      console.error('[üíä IECA/ARA II] Error al guardar:', result.error);
      const mensaje = result.error || result.message || 'Error desconocido';
      alert('Error al guardar: ' + mensaje);
    }
  } catch (error) {
    console.error('[üíä IECA/ARA II] Error:', error);
    alert('Error de conexi√≥n');
  }
}

// Funci√≥n para limpiar formulario IECA/ARA II
function limpiarFormularioIecaAra() {
    document.getElementById('tipoIecaAra').value = '';
    document.getElementById('fechaIecaAra').value = '';
    console.log('[üíä IECA/ARA II] Formulario limpiado');
}

// Funci√≥n para cargar historial IECA/ARA II
async function cargarHistorialIecaAra(run) {
    try {
        if (!run) return;
        
        console.log('[üíä IECA/ARA II] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/ieca_ara/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
    const historial = Array.isArray(result.historial)
      ? result.historial
      : Array.isArray(result.data)
        ? result.data
        : [];
        
        const historialDiv = document.getElementById('historialIecaAra');
        const listaDiv = document.getElementById('listHistorialIecaAra');
        
        if (!historialDiv || !listaDiv) return;
        
    if (response.ok && (result.success || result.ok) && historial.length > 0) {
            historialDiv.style.display = 'block';
            
      const historialHTML = historial.map(medicacion => {
        const fecha = medicacion.fecha ? new Date(medicacion.fecha).toLocaleDateString('es-CL') : 'Sin fecha';
        const tipoRaw = (medicacion.tipo_medicacion ?? medicacion.tipo ?? '').toString().toUpperCase();
        const enTratamiento = tipoRaw === 'IECA' || tipoRaw === 'ARA II';
        const estadoColor = enTratamiento ? '#059669' : '#dc2626';
        const estadoBg = enTratamiento ? '#d1fae5' : '#fef2f2';
        const estadoTexto = enTratamiento ? tipoRaw : 'NO REGISTRA';
        const funcionario = medicacion.funcionario || medicacion.creado_por || 'Sistema';

        return `
          <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                  ${estadoTexto}
                </span>
              </div>
            </div>
            <div style="font-size:0.65rem;color:#9ca3af;">
              ${funcionario}
            </div>
          </div>
        `;
      }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de IECA/ARA II</div>';
        }
    } catch (error) {
        console.error('[üíä IECA/ARA II] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar estatinas
async function guardarEstatinas() {
  try {
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN v√°lido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inv√°lido, verifique el d√≠gito verificador');
      return;
    }

    const recibeEstatinas = document.querySelector('input[name="recibeEstatinas"]:checked')?.value;
    const fechaEstatinas = document.getElementById('fechaEstatinas').value;

    if (!recibeEstatinas || !fechaEstatinas) {
      alert('Debe completar todos los campos');
      return;
    }

    const payload = {
      run: runNormalizado,
      en_tratamiento: recibeEstatinas === 'si',
      fecha: fechaEstatinas
    };

    console.log('[üíä Estatinas] Guardando:', payload);

    const response = await authFetch('/api/medicacion/estatinas', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (response.ok && result.ok) {
      console.log('[üíä Estatinas] Guardado exitosamente');
      alert('Estatinas guardado exitosamente');
      limpiarFormularioEstatinas();
      window._runActivo = runNormalizado;
      await cargarHistorialEstatinas(runNormalizado);
    } else {
      console.error('[üíä Estatinas] Error al guardar:', result.error);
      alert('Error al guardar: ' + (result.error || 'Error desconocido'));
    }
  } catch (error) {
    console.error('[üíä Estatinas] Error:', error);
    alert('Error de conexi√≥n');
  }
}

// Funci√≥n para limpiar formulario estatinas
function limpiarFormularioEstatinas() {
    document.querySelectorAll('input[name="recibeEstatinas"]').forEach(radio => radio.checked = false);
    document.getElementById('fechaEstatinas').value = '';
    console.log('[üíä Estatinas] Formulario limpiado');
}

// Funci√≥n para cargar historial estatinas
async function cargarHistorialEstatinas(run) {
    try {
        if (!run) return;
        
        console.log('[üíä Estatinas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/estatinas/${run}?limit=10`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialEstatinas');
        const listaDiv = document.getElementById('listHistorialEstatinas');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(medicacion => {
                const fecha = new Date(medicacion.fecha).toLocaleDateString('es-CL');
                const estadoColor = medicacion.en_tratamiento ? '#059669' : '#dc2626';
                const estadoBg = medicacion.en_tratamiento ? '#d1fae5' : '#fef2f2';
                const estadoTexto = medicacion.en_tratamiento ? 'S√ç RECIBE' : 'NO RECIBE';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${medicacion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de estatinas</div>';
        }
    } catch (error) {
        console.error('[üíä Estatinas] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar antiagregantes
async function guardarAntiagregantes() {
  try {
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN v√°lido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inv√°lido, verifique el d√≠gito verificador');
      return;
    }

    const recibeAntiagregantes = document.querySelector('input[name="recibeAntiagregantes"]:checked')?.value;
    const fechaAntiagregantes = document.getElementById('fechaAntiagregantes').value;

    if (!recibeAntiagregantes || !fechaAntiagregantes) {
      alert('Debe completar todos los campos');
      return;
    }

    const payload = {
      run: runNormalizado,
      en_tratamiento: recibeAntiagregantes === 'si',
      fecha: fechaAntiagregantes
    };

    console.log('[üíä Antiagregantes] Guardando:', payload);

    const response = await authFetch('/api/medicacion/antiagregantes', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (response.ok && result.ok) {
      console.log('[üíä Antiagregantes] Guardado exitosamente');
      alert('Antiagregante plaquetario guardado exitosamente');
      limpiarFormularioAntiagregantes();
      window._runActivo = runNormalizado;
      await cargarHistorialAntiagregantes(runNormalizado);
    } else {
      console.error('[üíä Antiagregantes] Error al guardar:', result.error);
      alert('Error al guardar: ' + (result.error || 'Error desconocido'));
    }
  } catch (error) {
    console.error('[üíä Antiagregantes] Error:', error);
    alert('Error de conexi√≥n');
  }
}

// Funci√≥n para limpiar formulario antiagregantes
function limpiarFormularioAntiagregantes() {
    document.querySelectorAll('input[name="recibeAntiagregantes"]').forEach(radio => radio.checked = false);
    document.getElementById('fechaAntiagregantes').value = '';
    console.log('[üíä Antiagregantes] Formulario limpiado');
}

// Funci√≥n para cargar historial antiagregantes
async function cargarHistorialAntiagregantes(run) {
    try {
        if (!run) return;
        
        console.log('[üíä Antiagregantes] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/antiagregantes/${run}?limit=10`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialAntiagregantes');
        const listaDiv = document.getElementById('listHistorialAntiagregantes');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(medicacion => {
                const fecha = new Date(medicacion.fecha).toLocaleDateString('es-CL');
                const estadoColor = medicacion.en_tratamiento ? '#059669' : '#dc2626';
                const estadoBg = medicacion.en_tratamiento ? '#d1fae5' : '#fef2f2';
                const estadoTexto = medicacion.en_tratamiento ? 'S√ç RECIBE' : 'NO RECIBE';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${medicacion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de antiagregantes</div>';
        }
    } catch (error) {
        console.error('[üíä Antiagregantes] Error cargando historial:', error);
    }
}

// ================= FUNCIONES DE COMORBILIDAD/SECUELAS =================

// Funci√≥n para analizar comorbilidades y secuelas
async function analizarComorbilidades(run) {
    try {
        if (!run) return;
        
        console.log('[üìä Comorbilidad] Analizando diagn√≥sticos para:', run);
        console.log('[üìä Comorbilidad] Timestamp:', new Date().toISOString());
        
        const estadoDiv = document.getElementById('comorbilidadEstado');
        const diagnosticosDiv = document.getElementById('diagnosticosDetectados');
        const sinDiagnosticosDiv = document.getElementById('sinDiagnosticos');
        
        if (!estadoDiv || !diagnosticosDiv || !sinDiagnosticosDiv) return;
        
        // Mostrar estado de carga
        estadoDiv.style.display = 'block';
        estadoDiv.innerHTML = '<span>üîç Analizando patolog√≠as...</span>';
        diagnosticosDiv.style.display = 'none';
        sinDiagnosticosDiv.style.display = 'none';
        
        // Obtener patolog√≠as del usuario
        const response = await authFetch(`/api/usuario/${encodeURIComponent(run)}/patologias`);
        if (!response.ok) {
            estadoDiv.innerHTML = '<span style="color:#dc2626;">‚ùå Error al obtener patolog√≠as</span>';
            return;
        }
        
        const result = await response.json();
        console.log('[üìä Comorbilidad] Respuesta API:', result);
        
        if (!result.patologias || result.patologias.length === 0) {
            estadoDiv.innerHTML = '<span style="color:#6b7280;">‚ÑπÔ∏è Sin patolog√≠as registradas</span>';
            return;
        }
        
        const patologias = result.patologias;
        console.log('[üìä Comorbilidad] Patolog√≠as encontradas:', patologias.length);
        console.log('[üìä Comorbilidad] Muestra de patolog√≠as:', patologias.slice(0, 3));
        
        // Verificar si tiene diabetes  
        const tieneDiabetes = patologias.some(p => 
            (p.nombre && /diab/i.test(p.nombre)) || 
            (p.cie10 && /E1[0-4]/i.test(p.cie10))
        );
        
        if (!tieneDiabetes) {
            estadoDiv.innerHTML = '<span style="color:#6b7280;">‚ÑπÔ∏è An√°lisis requiere diagn√≥stico de diabetes</span>';
            return;
        }
        
        let diagnosticosEncontrados = 0;
        
        // Resetear todos los diagn√≥sticos
        document.getElementById('diagnosticoTabaquismo').style.display = 'none';
        document.getElementById('diagnosticoErcLeve').style.display = 'none';
        document.getElementById('diagnosticoErcAvanzada').style.display = 'none';
        document.getElementById('diagnosticoAcv').style.display = 'none';
        document.getElementById('diagnosticoIam').style.display = 'none';
        document.getElementById('diagnosticoInsulina').style.display = 'none';
        document.getElementById('recomendacionIecaAra').style.display = 'none';
        
        // 1. Detectar Tabaquismo (F17, T65.2, Z71.6, Z72.0)
        const tieneTabaquismo = patologias.some(p => 
            (p.cie10 && (/F17/i.test(p.cie10) || 
            /T65\.2/i.test(p.cie10) || 
            /Z71\.6/i.test(p.cie10) || 
            /Z72\.0/i.test(p.cie10))) ||
            (p.nombre && /tabaco|tabaquismo|fumar|fumador/i.test(p.nombre))
        );
        
        if (tieneTabaquismo) {
            document.getElementById('diagnosticoTabaquismo').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: Tabaquismo');
        }
        
        // 2. Detectar ERC Leve-Moderada (N18.1, N18.2, N18.3, N18.9, N19)
        const tieneErcLeve = patologias.some(p => 
            (p.cie10 && (/N18\.[123]/i.test(p.cie10) || 
            /N18\.9/i.test(p.cie10) || 
            /N19/i.test(p.cie10))) ||
            (p.nombre && /renal.*cr√≥nica/i.test(p.nombre) && !/estadio.*[45]/i.test(p.nombre))
        );
        
        // 3. Detectar ERC Avanzada (N18.4, N18.5, N18.6)
        const tieneErcAvanzada = patologias.some(p => 
            (p.cie10 && /N18\.[456]/i.test(p.cie10)) ||
            (p.nombre && ((/renal.*cr√≥nica/i.test(p.nombre) && /estadio.*[45]/i.test(p.nombre)) ||
            /di√°lisis/i.test(p.nombre)))
        );
        
        if (tieneErcAvanzada) {
            document.getElementById('diagnosticoErcAvanzada').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: ERC Avanzada');
        } else if (tieneErcLeve) {
            document.getElementById('diagnosticoErcLeve').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: ERC Leve-Moderada');
        }
        
        // 4. Detectar ACV/AVE (G46, I64, I67, I68)
        const tieneAcv = patologias.some(p => 
            (p.cie10 && (/G46/i.test(p.cie10) || 
            /I64/i.test(p.cie10) || 
            /I67/i.test(p.cie10) || 
            /I68/i.test(p.cie10))) ||
            (p.nombre && /cerebrovascular|acv|ave|accidente.*cerebral|ictus/i.test(p.nombre))
        );
        
        if (tieneAcv) {
            document.getElementById('diagnosticoAcv').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: ACV/AVE');
        }
        
        // 5. Detectar IAM (I21)
        const tieneIam = patologias.some(p => 
            (p.cie10 && /I21/i.test(p.cie10)) ||
            (p.nombre && /infarto.*miocardio|iam/i.test(p.nombre))
        );
        
        if (tieneIam) {
            document.getElementById('diagnosticoIam').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: IAM');
        }
        
        // 6. Verificar uso de insulina
        await verificarUsoInsulina(run);
        
        // 7. Verificar recomendaci√≥n IECA/ARA II para ERC + DM
        if (tieneErcLeve || tieneErcAvanzada) {
            await verificarRecomendacionIecaAra(run);
        }
        
        // Mostrar resultados
        estadoDiv.style.display = 'none';
        
        if (diagnosticosEncontrados > 0) {
            diagnosticosDiv.style.display = 'block';
            sinDiagnosticosDiv.style.display = 'none';
        } else {
            diagnosticosDiv.style.display = 'none';
            sinDiagnosticosDiv.style.display = 'block';
        }
        
        console.log('[üìä Comorbilidad] An√°lisis completado. Diagn√≥sticos encontrados:', diagnosticosEncontrados);
        
    } catch (error) {
        console.error('[üìä Comorbilidad] Error en an√°lisis:', error);
        const estadoDiv = document.getElementById('comorbilidadEstado');
        if (estadoDiv) {
            estadoDiv.innerHTML = '<span style="color:#dc2626;">‚ùå Error en an√°lisis</span>';
        }
    }
}

// Funci√≥n para verificar uso de insulina
async function verificarUsoInsulina(run) {
    try {
    const response = await authFetch(`/api/insulina-historial/${run}/ultima`);
    if (response.ok) {
      const result = await response.json();
      const registro = result && result.ok ? result.registro || result.insulina : null;
      actualizarEstadoInsulinaVigente(registro);
      if (registro && registro.en_tratamiento) {
        console.log('[üìä Comorbilidad] Detectado: Uso de Insulina');
      }
    }
    } catch (error) {
        console.log('[üìä Comorbilidad] No se pudo verificar uso de insulina');
    }
}

// Funci√≥n para verificar recomendaci√≥n IECA/ARA II
async function verificarRecomendacionIecaAra(run) {
    try {
        const response = await authFetch(`/api/medicacion/ieca_ara/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            // Si no tiene IECA/ARA II o el √∫ltimo registro es "NO", mostrar recomendaci√≥n
            if (!result.ok || !result.historial || result.historial.length === 0 || 
                (result.historial[0] && !result.historial[0].en_tratamiento)) {
                document.getElementById('recomendacionIecaAra').style.display = 'block';
                console.log('[üìä Comorbilidad] Recomendaci√≥n: IECA/ARA II para nefroprotecci√≥n');
            }
        }
    } catch (error) {
        console.log('[üìä Comorbilidad] No se pudo verificar IECA/ARA II');
    }
}

// Funci√≥n principal para recargar todos los datos despu√©s de buscar usuario
async function recargaTodo(runVal){
    console.log('üîÑ [SISTEMA] *** RECARGA TODO EJECUTANDOSE *** para usuario:', runVal);
    
    // Verificar sesi√≥n antes de proceder
    const sesionActiva = await verificarSesion();
    if (!sesionActiva) {
        console.log('‚ö†Ô∏è [SISTEMA] Sesi√≥n no activa - algunas funciones pueden no estar disponibles');
    }
    
    // Crear un contador de errores para mostrar estado general
    window._errorCount = 0;
    window._totalCalls = 24; // Incrementado por las funciones de historial + f√°rmacos + comorbilidad
    
    // Funci√≥n helper para manejar errores silenciosamente
    const safeCall = async (fn, name) => {
        try {
            console.log(`üîÑ [${name}] Iniciando...`);
            if (typeof fn === 'function') {
                await fn(runVal);
                console.log(`‚úÖ [${name}] Completado exitosamente`);
            } else {
                window._errorCount++;
                console.error(`‚ùå [${name}] Funci√≥n no definida`);
            }
        } catch (error) {
            window._errorCount++;
            console.error(`‚ùå [${name}] Error:`, error.message, error);
        }
    };
    
    console.log('üîÑ [SISTEMA] Iniciando carga de historiales de evaluaci√≥n diabetes para:', runVal);
    
    Promise.all([
        safeCall(cargarUltimoControl, 'Control'),
        safeCall(cargarLabs, 'Laboratorio'),
        safeCall(cargarHistoricoControl, 'Hist.Control'),
        safeCall(cargarHistoricoLabs, 'Hist.Labs'),
        safeCall(cargarHistoricoAcuerdos, 'Acuerdos'),
        safeCall(sincronizarPatologiasUsuario, 'Patolog√≠as'),
        safeCall(cargarUltimoExamenPieDiabetico, 'PieDiab√©tico'),
        safeCall(cargarUltimaCuracion, 'Curaciones'),
        safeCall(cargarUltimaHipoglicemia, 'Hipoglicemias'),
        safeCall(cargarUltimaAmputacion, 'Amputaci√≥n'),
        safeCall(cargarUltimaInsulina, 'Insulina'),
        safeCall(cargarUltimaPodologia, 'Podolog√≠a'),
        safeCall(cargarUltimoFondoOjos, 'FondoOjos'),
        // Funciones de historial - ACTUALIZADAS
        safeCall(cargarHistorialPieDiabetico, 'Hist.PieDiab√©tico'),
        safeCall(cargarHistorialCuraciones, 'Hist.Curaciones'),
        safeCall(cargarHistorialEkg, 'Hist.EKG'),
        safeCall(cargarHistorialHipoglicemias, 'Hist.Hipoglicemias'),
        safeCall(cargarHistorialAmputacion, 'Hist.Amputaci√≥n'),
        safeCall(cargarHistorialInsulina, 'Hist.Insulina'),
        safeCall(cargarHistorialPodologia, 'Hist.Podolog√≠a'),
        safeCall(cargarHistorialFondoOjos, 'Hist.FondoOjos'),
        // Funciones de historial de f√°rmacos
        safeCall(cargarHistorialIecaAra, 'Hist.IECA/ARA II'),
        safeCall(cargarHistorialEstatinas, 'Hist.Estatinas'),
        safeCall(cargarHistorialAntiagregantes, 'Hist.Antiagregantes'),
        // An√°lisis de comorbilidades y secuelas
        safeCall(analizarComorbilidades, 'Comorbilidad/Secuelas')
    ]).then(() => {
        const available = window._totalCalls - window._errorCount;
        console.log(`‚úÖ [SISTEMA] *** RECARGA TODO COMPLETADA *** : ${available}/${window._totalCalls} m√≥dulos disponibles`);
        
        if (window._errorCount > 6) {
            console.log('‚ÑπÔ∏è [SISTEMA] Algunos m√≥dulos no est√°n disponibles - esto es normal');
        }
    });
}

// Hacer recargaTodo global para debugging
window.recargaTodo = recargaTodo;

// ================= FUNCI√ìN DE PRUEBA DE HISTORIALES =================

async function probarHistorialesDiabetes(run = '10.000.141-1') {
    console.log('üß™ [PRUEBA] Probando todos los historiales de diabetes para:', run);
    
    const funciones = [
        { func: cargarHistorialPieDiabetico, nombre: 'ü¶∂ Pie Diab√©tico' },
        { func: cargarHistorialCuraciones, nombre: 'ü©π Curaciones' },
        { func: cargarHistorialEkg, nombre: '‚ö° EKG' },
        { func: cargarHistorialHipoglicemias, nombre: 'ü©∏ Hipoglicemias' },
        { func: cargarHistorialAmputacion, nombre: 'ü¶ø Amputaci√≥n' },
        { func: cargarHistorialInsulina, nombre: 'üíâ Insulina' },
        { func: cargarHistorialPodologia, nombre: 'ü¶∂ Podolog√≠a' },
        { func: cargarHistorialFondoOjos, nombre: 'üëÅÔ∏è Fondo de Ojos' }
    ];
    
    for (const { func, nombre } of funciones) {
        try {
            console.log(`üß™ [PRUEBA] Probando ${nombre}...`);
            await func(run);
            console.log(`‚úÖ [PRUEBA] ${nombre} - Completado`);
        } catch (error) {
            console.error(`‚ùå [PRUEBA] ${nombre} - Error:`, error);
        }
    }
    
    console.log('üß™ [PRUEBA] Prueba de historiales completada');
}

// Disponible globalmente para pruebas manuales
window.probarHistorialesDiabetes = probarHistorialesDiabetes;

// Exponer funciones de historial globalmente para debug y uso manual
window.cargarHistorialPieDiabetico = cargarHistorialPieDiabetico;
window.cargarHistorialCuraciones = cargarHistorialCuraciones;
window.cargarHistorialHipoglicemias = cargarHistorialHipoglicemias;  
window.cargarHistorialFondoOjos = cargarHistorialFondoOjos;
window.cargarHistorialAmputacion = cargarHistorialAmputacion;
window.cargarHistorialInsulina = cargarHistorialInsulina;
window.cargarHistorialPodologia = cargarHistorialPodologia;
window.cargarHistorialEkg = cargarHistorialEkg;

// Exponer funciones de guardado globalmente para botones onclick
window.guardarIecaAra = guardarIecaAra;
window.guardarEstatinas = guardarEstatinas;
window.guardarAntiagregantes = guardarAntiagregantes;
window.guardarPodologia = guardarPodologia;
window.guardarHipoglicemias = guardarHipoglicemias;
window.guardarAmputacion = guardarAmputacion;
// guardarFondoOjos ya est√° exportado en l√≠nea 9543

// Exponer funciones de limpiar globalmente para botones onclick
window.limpiarFormularioIecaAra = limpiarFormularioIecaAra;
window.limpiarFormularioEstatinas = limpiarFormularioEstatinas;
window.limpiarFormularioAntiagregantes = limpiarFormularioAntiagregantes;
window.limpiarFormularioHipoglicemias = limpiarFormularioHipoglicemias;
window.limpiarFormularioAmputacion = limpiarFormularioAmputacion;
// limpiarFormularioFondoOjos ya est√° exportado en l√≠nea 9543

// ======= FUNCIONES ACTIVIDAD F√çSICA =======

// Funci√≥n para guardar actividad f√≠sica
async function guardarActividadFisica() {
    try {
        // Obtener RUN del paciente
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('No hay RUN seleccionado');
            return;
        }

        // Obtener valores del formulario
        const actividadRadios = document.querySelectorAll('input[name="actividadFisica"]:checked');
        const fechaInput = document.getElementById('fechaActividadFisica');

        // Validaciones
        if (actividadRadios.length === 0) {
            alert('Por favor seleccione si realiza actividad f√≠sica');
            return;
        }

        if (!fechaInput || !fechaInput.value) {
            alert('Por favor ingrese la fecha de evaluaci√≥n');
            return;
        }

        const actividadValue = actividadRadios[0].value;
        const activo = actividadValue === 'si';

        console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Guardando:', {
            run: runField.value.trim(),
            activo: activo,
            fecha: fechaInput.value
        });

        // Preparar datos para enviar
        const data = {
            run: runField.value.trim(),
            activo: activo,
            fecha: fechaInput.value
        };

        // Enviar datos al servidor
        const response = await authFetch('/api/actividad_fisica/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            alert('Actividad f√≠sica guardada exitosamente');
            // Recargar historial
            cargarHistorialActividadFisica(runField.value.trim());
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }

    } catch (error) {
        console.error('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Error guardando:', error);
        alert('Error al guardar la actividad f√≠sica: ' + error.message);
    }
}

// Funci√≥n para limpiar formulario de actividad f√≠sica
function limpiarFormularioActividadFisica() {
    const form = document.getElementById('actividadFisicaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaInput = document.getElementById('fechaActividadFisica');
    if (fechaInput) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Formulario limpiado');
}

// Funci√≥n para cargar historial de actividad f√≠sica
async function cargarHistorialActividadFisica(run) {
    try {
        if (!run) return;
        
        console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Cargando historial para:', run);
        
        const response = await authFetch(`/api/actividad_fisica/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialActividadFisica');
        const listaDiv = document.getElementById('listHistorialActividadFisica');
        
        if (!historialDiv || !listaDiv) {
            console.error('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(registro => {
                const fecha = new Date(registro.fecha).toLocaleDateString('es-CL');
                const estadoColor = registro.activo ? '#059669' : '#dc2626';
                const estadoBg = registro.activo ? '#d1fae5' : '#fecaca';
                const estadoTexto = registro.activo ? 'S√ç ACTIVO' : 'NO ACTIVO';
                const icono = registro.activo ? 'üèÉ‚Äç‚ôÇÔ∏è' : '‚ùå';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:1rem;">${icono}</span>
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${registro.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#6b7280;font-size:0.8rem;">
                    <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üèÉ‚Äç‚ôÇÔ∏è</span>
                    Sin registros de actividad f√≠sica
                </div>
            `;
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Sin historial disponible');
        }
        
    } catch (error) {
        console.error('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialActividadFisica');
        const listaDiv = document.getElementById('listHistorialActividadFisica');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#ef4444;font-size:0.8rem;">
                    Error al cargar el historial
                </div>
            `;
        }
    }
}

// Exponer funciones de actividad f√≠sica globalmente
window.guardarActividadFisica = guardarActividadFisica;
window.limpiarFormularioActividadFisica = limpiarFormularioActividadFisica;
window.cargarHistorialActividadFisica = cargarHistorialActividadFisica;

// ======= FUNCIONES MASAMA =======

// Funci√≥n para guardar MasAma
async function guardarMasAma() {
    try {
        // Obtener RUN del paciente
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('No hay RUN seleccionado');
            return;
        }

        // Obtener valores del formulario
        const masAmaRadios = document.querySelectorAll('input[name="masAma"]:checked');
        const fechaInput = document.getElementById('fechaMasAma');

        // Validaciones
        if (masAmaRadios.length === 0) {
            alert('Por favor seleccione el resultado de MasAma');
            return;
        }

        if (!fechaInput || !fechaInput.value) {
            alert('Por favor ingrese la fecha de evaluaci√≥n');
            return;
        }

        const masAmaValue = masAmaRadios[0].value;
        const masama = masAmaValue === 'si';

        console.log('[üîç MasAma] Guardando:', {
            usuario_id: runField.value.trim(),
            masama: masama,
            fecha: fechaInput.value
        });

        // Preparar datos para enviar
        const data = {
            usuario_id: runField.value.trim(),
            masama: masama,
            fecha: fechaInput.value
        };

        // Enviar datos al servidor
        const response = await authFetch('/api/masama/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            alert('MasAma guardado exitosamente');
            // Recargar historial
            cargarHistorialMasAma(runField.value.trim());
            console.log('[üîç MasAma] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }

    } catch (error) {
        console.error('[üîç MasAma] Error guardando:', error);
        alert('Error al guardar MasAma: ' + error.message);
    }
}

// Funci√≥n para limpiar formulario de MasAma
function limpiarFormularioMasAma() {
    const form = document.getElementById('masAmaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaInput = document.getElementById('fechaMasAma');
    if (fechaInput) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[üîç MasAma] Formulario limpiado');
}

// Funci√≥n para cargar historial de MasAma
async function cargarHistorialMasAma(run) {
    try {
        if (!run) return;
        
        console.log('[üîç MasAma] Cargando historial para:', run);
        
        const response = await authFetch(`/api/masama/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialMasAma');
        const listaDiv = document.getElementById('listHistorialMasAma');
        
        if (!historialDiv || !listaDiv) {
            console.error('[üîç MasAma] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[üîç MasAma] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(registro => {
                const fecha = new Date(registro.fecha).toLocaleDateString('es-CL');
                const estadoColor = registro.masama ? '#dc2626' : '#059669';
                const estadoBg = registro.masama ? '#fecaca' : '#d1fae5';
                const estadoTexto = registro.masama ? 'POSITIVO' : 'NEGATIVO';
                const icono = registro.masama ? '‚ö†Ô∏è' : '‚úÖ';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:1rem;">${icono}</span>
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${registro.created_at ? new Date(registro.created_at).toLocaleDateString('es-CL') : 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[üîç MasAma] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#6b7280;font-size:0.8rem;">
                    <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üîç</span>
                    Sin registros de MasAma
                </div>
            `;
            console.log('[üîç MasAma] Sin historial disponible');
        }
        
    } catch (error) {
        console.error('[üîç MasAma] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialMasAma');
        const listaDiv = document.getElementById('listHistorialMasAma');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#ef4444;font-size:0.8rem;">
                    Error al cargar el historial
                </div>
            `;
        }
    }
}

// Exponer funciones de MasAma globalmente
window.guardarMasAma = guardarMasAma;
window.limpiarFormularioMasAma = limpiarFormularioMasAma;
window.cargarHistorialMasAma = cargarHistorialMasAma;

// Exponer funciones de adulto mayor globalmente
window.guardarEvaluacionAdultoMayor = guardarEvaluacionAdultoMayor;
window.limpiarFormularioAdultoMayor = limpiarFormularioAdultoMayor;
window.cargarHistorialAdultoMayor = cargarHistorialAdultoMayor;

// ========================= FUNCIONES DE SCREENING ===============================

// Funci√≥n para guardar vacuna (influenza o covid)
async function guardarVacuna(tipo) {
    try {
        // Obtener valores del formulario
        const fechaInput = document.getElementById(`fecha${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        const estadoInput = document.getElementById(`estado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha de vacunaci√≥n');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar el estado de la vacuna');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        const fecha = new Date(fechaInput.value);
        const anio = fecha.getFullYear();
        
        // Preparar datos
        const data = {
            tipo: tipo,
            estado: estadoInput.value,
            fecha: fechaInput.value,
            anio: anio
        };
        
        console.log(`[üíâ Vacuna ${tipo}] Guardando:`, data);
        
        // Enviar al servidor
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(runField.value.trim())}/vacunas`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert(`Vacuna ${tipo} guardada exitosamente`);
            // Recargar historial
            cargarHistorialVacunas(runField.value.trim());
            console.log(`[üíâ Vacuna ${tipo}] Guardado exitoso:`, result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error(`[üíâ Vacuna ${tipo}] Error guardando:`, error);
        alert(`Error al guardar la vacuna ${tipo}: ` + error.message);
    }
}

// Funci√≥n para cargar historial de vacunas
async function cargarHistorialVacunas(run) {
    try {
        if (!run) return;
        
        console.log('[üíâ Vacunas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üíâ Vacunas] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialVacunas');
            const listaDiv = document.getElementById('listaHistorialVacunas');
            
            if (!historialDiv || !listaDiv) {
                console.error('[üíâ Vacunas] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(vacuna => `
                    <div style="padding:8px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;font-size:0.8rem;">
                        <div><strong>${vacuna.tipo.toUpperCase()}</strong></div>
                        <div>${vacuna.fecha ? new Date(vacuna.fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            vacuna.estado === 'SI' ? 'background:#dcfce7;color:#166534;' :
                            vacuna.estado === 'NO' ? 'background:#fef2f2;color:#dc2626;' :
                            'background:#fef3c7;color:#d97706;'
                        }">${vacuna.estado}</span></div>
                        <div style="color:#6b7280;">${vacuna.anio}</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay vacunas registradas</div>';
            }
        } else {
            console.error('[üíâ Vacunas] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üíâ Vacunas] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar PAP
async function guardarPAP() {
    try {
        const fechaInput = document.getElementById('fechaPAP');
        const estadoInput = document.getElementById('estadoPAP');
        const resultadoInput = document.getElementById('resultadoPAP');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha del PAP');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar si se realiz√≥ el PAP');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            pap_fecha: fechaInput.value,
            pap: estadoInput.value === 'true',
            pap_resultado: resultadoInput.value || null
        };
        
        console.log('[üë©‚Äç‚öïÔ∏è PAP] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/pap', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('PAP guardado exitosamente');
            // Recargar historial
            cargarHistorialPAP(runField.value.trim());
            console.log('[üë©‚Äç‚öïÔ∏è PAP] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[üë©‚Äç‚öïÔ∏è PAP] Error guardando:', error);
        alert('Error al guardar el PAP: ' + error.message);
    }
}

// Funci√≥n para cargar historial de PAP
async function cargarHistorialPAP(run) {
    try {
        if (!run) return;
        
        console.log('[üë©‚Äç‚öïÔ∏è PAP] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/pap/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üë©‚Äç‚öïÔ∏è PAP] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialPAP');
            const listaDiv = document.getElementById('listaHistorialPAP');
            
            if (!historialDiv || !listaDiv) {
                console.error('[üë©‚Äç‚öïÔ∏è PAP] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(pap => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 2fr;gap:8px;align-items:center;">
                        <div>${pap.pap_fecha ? new Date(pap.pap_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            pap.pap ? 'background:#dcfce7;color:#166534;' : 'background:#fef2f2;color:#dc2626;'
                        }">${pap.pap ? 'Realizado' : 'No realizado'}</span></div>
                        <div style="font-size:0.75rem;color:#6b7280;">${pap.pap_resultado || 'Sin resultado'}</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay PAPs registrados</div>';
            }
        } else {
            console.error('[üë©‚Äç‚öïÔ∏è PAP] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üë©‚Äç‚öïÔ∏è PAP] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar Mamograf√≠a
async function guardarMamografia() {
    try {
    // Preferir campos gen√©ricos y caer al formulario AM si es el √∫nico disponible
  const fechaInput = document.getElementById('fechaMamografia') || document.getElementById('fechaMamografiaAM');
  const estadoInput = document.getElementById('estadoMamografia') || document.getElementById('estadoMamografiaAM');
  const biradesInput = document.getElementById('biradsMamografia') || document.getElementById('biradsMamografiaAM');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha de la mamograf√≠a');
            return;
        }
        
    if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar si se realiz√≥ la mamograf√≠a');
            return;
        }

    const estadoRaw = (estadoInput.value || '').toLowerCase();
    let estado;
    if (estadoRaw === 'true' || estadoRaw === 'si' || estadoRaw === 'realizada') {
      estado = 'realizada';
    } else if (estadoRaw === 'false' || estadoRaw === 'no' || estadoRaw === 'pendiente') {
      estado = 'pendiente';
    } else if (estadoRaw === 'alterada') {
      estado = 'alterada';
    } else {
      alert('Debe seleccionar un estado v√°lido para la mamograf√≠a');
      return;
    }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Preparar datos
    const data = {
      run: runField.value.trim(),
      fecha: fechaInput.value,
      estado,
    };

    if (biradesInput && biradesInput.value) {
      const biradsVal = parseInt(biradesInput.value, 10);
      if (!Number.isNaN(biradsVal)) {
        data.birads = biradsVal;
        data.mamografia_birads = biradsVal;
      }
    }
        
        console.log('[ü©ª Mamograf√≠a] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/mamografia', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('Mamograf√≠a guardada exitosamente');
            // Recargar historial
            cargarHistorialMamografia(runField.value.trim());
            console.log('[ü©ª Mamograf√≠a] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[ü©ª Mamograf√≠a] Error guardando:', error);
        alert('Error al guardar la mamograf√≠a: ' + error.message);
    }
}

// Funci√≥n para cargar historial de Mamograf√≠a
async function cargarHistorialMamografia(run) {
    try {
        if (!run) return;
        
        console.log('[ü©ª Mamograf√≠a] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/mamografia/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü©ª Mamograf√≠a] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialMamografia') || document.getElementById('historialMamografiaAM');
            const listaDiv = document.getElementById('listaHistorialMamografia') || document.getElementById('listaHistorialMamografiaAM');
            
            if (!historialDiv || !listaDiv) {
                console.error('[ü©ª Mamograf√≠a] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
        const historialHTML = result.data.map(mamografia => {
          const estadoRaw = (() => {
            if (mamografia.estado) return String(mamografia.estado).toLowerCase();
            if (typeof mamografia.mamografia === 'boolean') {
              return mamografia.mamografia ? 'realizada' : 'pendiente';
            }
            return '';
          })();
          const estadoTexto = estadoRaw === 'realizada'
            ? 'Realizada'
            : estadoRaw === 'pendiente'
            ? 'Pendiente'
            : estadoRaw === 'alterada'
            ? 'Alterada'
            : (mamografia.estado || 'Sin estado');
          const estadoStyles = estadoRaw === 'realizada'
            ? 'background:#dcfce7;color:#166534;'
            : estadoRaw === 'alterada'
            ? 'background:#fee2e2;color:#b91c1c;'
            : 'background:#fef3c7;color:#92400e;';
                    const fechaRaw = mamografia.fecha || mamografia.mamografia_fecha || null;
                    const fechaStr = fechaRaw ? new Date(fechaRaw).toLocaleDateString('es-CL') : 'Sin fecha';
          const birads = mamografia.birads ?? mamografia.mamografia_birads ?? null;
          return `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center;">
            <div>${fechaStr}</div>
            <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${estadoStyles}">${estadoTexto}</span></div>
            <div style="font-size:0.75rem;color:#6b7280;">${birads !== null ? `BI-RADS ${birads}` : 'Sin BI-RADS'}</div>
                    </div>
        `;
        }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay mamograf√≠as registradas</div>';
            }
        } else {
            console.error('[ü©ª Mamograf√≠a] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[ü©ª Mamograf√≠a] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar PSA
async function guardarPSA() {
    try {
        const fechaInput = document.getElementById('fechaPSA');
        const valorInput = document.getElementById('valorPSA');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha del PSA');
            return;
        }
        
        if (!valorInput || !valorInput.value) {
            alert('Debe ingresar el valor del PSA');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            examen_fecha: fechaInput.value,
            psa_valor: parseFloat(valorInput.value)
        };
        
        console.log('[üë®‚Äç‚öïÔ∏è PSA] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/psa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('PSA guardado exitosamente');
            // Recargar historial
            cargarHistorialPSA(runField.value.trim());
            console.log('[üë®‚Äç‚öïÔ∏è PSA] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[üë®‚Äç‚öïÔ∏è PSA] Error guardando:', error);
        alert('Error al guardar el PSA: ' + error.message);
    }
}

// Funci√≥n para cargar historial de PSA
async function cargarHistorialPSA(run) {
    try {
        if (!run) return;
        
        console.log('[üë®‚Äç‚öïÔ∏è PSA] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/psa/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üë®‚Äç‚öïÔ∏è PSA] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialPSA');
            const listaDiv = document.getElementById('listaHistorialPSA');
            
            if (!historialDiv || !listaDiv) {
                console.error('[üë®‚Äç‚öïÔ∏è PSA] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(psa => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center;">
                        <div>${psa.examen_fecha ? new Date(psa.examen_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div style="font-weight:600;color:#1e293b;">${psa.psa_valor} ng/mL</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay PSAs registrados</div>';
            }
        } else {
            console.error('[üë®‚Äç‚öïÔ∏è PSA] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üë®‚Äç‚öïÔ∏è PSA] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar datos de screening seg√∫n el g√©nero y edad
async function cargarDatosScreening(run, sexo, edad) {
    if (!run) return;
    
    console.log('[üîç Screening] Cargando datos para:', run, 'Sexo:', sexo, 'Edad:', edad);
    
    // Mostrar/ocultar secciones seg√∫n g√©nero y edad
    const seccionPAP = document.getElementById('seccionPAP');
    const seccionMamografia = document.getElementById('seccionMamografia');
    const seccionPSA = document.getElementById('seccionPSA');
    
    if (seccionPAP && seccionMamografia && seccionPSA) {
        // PAP: Mujeres 25-64 a√±os
        if (sexo === 'F' && edad >= 25 && edad <= 64) {
            seccionPAP.style.display = 'block';
        } else {
            seccionPAP.style.display = 'none';
        }
        
        // Mamograf√≠a: Mujeres 50-69 a√±os
        if (sexo === 'F' && edad >= 50 && edad <= 69) {
            seccionMamografia.style.display = 'block';
        } else {
            seccionMamografia.style.display = 'none';
        }
        
        // PSA: Hombres ‚â•50 a√±os
        if (sexo === 'M' && edad >= 50) {
            seccionPSA.style.display = 'block';
        } else {
            seccionPSA.style.display = 'none';
        }
    }
    
    // Cargar datos de screening generales
    try {
        const response = await authFetch(`/api/screening/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.screening) {
                console.log('[üîç Screening] Datos cargados:', result.screening);
                mostrarDatosScreeningActuales(result.screening);
            }
        }
    } catch (error) {
        console.error('[ÔøΩ Medicaci√≥n - Screening] Error cargando datos generales:', error);
    }
    
    // Cargar historial de vacunas (aplica a todos)
    cargarHistorialVacunas(run);
}

// === Helpers para screening (sin efectos externos salvo DOM espec√≠fico) ===
function byId(id) {
    return document.getElementById(id);
}

function setValueIf(el, value) {
    if (el && value != null) el.value = String(value);
}

function setBooleanString(el, condition) {
    if (el) el.value = condition ? 'true' : 'false';
}

/**
 * Garantiza un √∫nico .estado-actual dentro de un contenedor por id
 * y luego asigna su innerHTML. No altera el orden de efectos de la secci√≥n.
 */
function upsertEstadoActual(containerId, html) {
    const cont = byId(containerId);
    if (!cont) return;
    let estadoDiv = cont.querySelector('.estado-actual');
    if (!estadoDiv) {
        estadoDiv = document.createElement('div');
        estadoDiv.className = 'estado-actual';
        cont.appendChild(estadoDiv);
    }
    estadoDiv.innerHTML = html;
}

// Funci√≥n para mostrar datos actuales de screening (MISMA FIRMA, MISMO ORDEN)
function mostrarDatosScreeningActuales(screening) {
    if (!screening || typeof screening !== 'object') return;

    // ===== PAP =====
    if (screening.pap) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaPAP'), screening.pap.fecha);

        const papOk = screening.pap.estado === 'al_dia' || screening.pap.estado === 'realizado';
        setBooleanString(byId('estadoPAP'), papOk);

        setValueIf(byId('resultadoPAP'), screening.pap.resultado);

        // 2) Estado en interfaz (mismo estilo y en el mismo punto de la secci√≥n)
        const papHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>√öltimo PAP:</strong> ${screening.pap.fecha} - Estado: ${screening.pap.estado}
            </div>`;
        upsertEstadoActual('seccionPAP', papHTML);
    }

    // ===== MAMOGRAF√çA =====
    if (screening.mamografia) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaMamografia'), screening.mamografia.fecha);

        const mamOk = screening.mamografia.estado === 'realizada';
        setBooleanString(byId('estadoMamografia'), mamOk);

        // birads solo si !== undefined (conserva el comportamiento exacto)
        if (screening.mamografia.birads !== undefined) {
            setValueIf(byId('biradsMamografia'), screening.mamografia.birads);
        }

        // 2) Estado en interfaz
        const mamHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>√öltima Mamograf√≠a:</strong> ${screening.mamografia.fecha} - Estado: ${screening.mamografia.estado}
            </div>`;
        upsertEstadoActual('seccionMamografia', mamHTML);
    }

    // ===== PSA =====
    if (screening.psa) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaPSA'), screening.psa.fecha);
        setValueIf(byId('valorPSA'), screening.psa.psa_valor);
        // (No hay bloque visual/estado-actual para PSA en el c√≥digo original)
        
        // Mostrar estado en la interfaz
        const seccionPSA = document.getElementById('seccionPSA');
        if (seccionPSA) {
            const estadoHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>√öltimo PSA:</strong> ${screening.psa.fecha} - Valor: ${screening.psa.psa_valor} ng/mL
            </div>`;
            
            let estadoDiv = seccionPSA.querySelector('.estado-actual');
            if (!estadoDiv) {
                estadoDiv = document.createElement('div');
                estadoDiv.className = 'estado-actual';
                seccionPSA.appendChild(estadoDiv);
            }
            estadoDiv.innerHTML = estadoHTML;
        }
    }
}

// Funci√≥n para cargar datos de screening en Adulto Mayor seg√∫n el g√©nero y edad
async function cargarDatosScreeningAM(run, sexo, edad) {
    if (!run) return;
    
    console.log('[üë¥ Adulto Mayor - Screening] Cargando datos para:', run, 'Sexo:', sexo, 'Edad:', edad);
  let sexoNorm = '';
  try {
    const raw = (sexo ?? '').toString().trim().toLowerCase();
    if (raw) {
      if (['m', 'masculino', 'hombre', 'male', 'var√≥n', 'varon'].includes(raw)) {
        sexoNorm = 'M';
      } else if (['f', 'femenino', 'mujer', 'female'].includes(raw)) {
        sexoNorm = 'F';
      } else if (raw.length === 1) {
        sexoNorm = raw.toUpperCase();
      }
    }
  } catch (err) {
    console.warn('[DEBUG-SCREENING] No se pudo normalizar sexo:', err);
    sexoNorm = '';
  }
  const edadNum = Number.parseInt(edad, 10);
  const edadValida = Number.isFinite(edadNum) ? edadNum : NaN;

  console.log('[DEBUG-SCREENING] Sexo normalizado:', sexoNorm, 'Edad num√©rica:', edadValida);
    console.log('[DEBUG-SCREENING] Valores recibidos:', {
        run: run,
    sexo: sexo,
    sexoNormalizado: sexoNorm,
    sexoTipo: typeof sexo,
    edad: edad,
    edadTipo: typeof edad,
    edadEsNumero: Number.isFinite(edadValida)
    });
    
    // Mostrar/ocultar secciones seg√∫n g√©nero y edad
    const seccionPAPAM = document.getElementById('seccionPAPAM');
    const seccionMamografiaAM = document.getElementById('seccionMamografiaAM');
    const seccionPSAAM = document.getElementById('seccionPSAAM');
    
    console.log('[DEBUG-SCREENING] Elementos de secci√≥n:', {
        PAP: !!seccionPAPAM,
        Mamografia: !!seccionMamografiaAM,
        PSA: !!seccionPSAAM
    });
    
    if (seccionPAPAM && seccionMamografiaAM && seccionPSAAM) {
        // PAP: Mujeres 25-64 a√±os
    const mostrarPAP = sexoNorm === 'F' && edadValida >= 25 && edadValida <= 64;
        console.log('[DEBUG-SCREENING] PAP - Condiciones:', {
      sexo: sexo,
      sexoNorm,
      sexoEsF: sexoNorm === 'F',
      edad: edad,
      edadNum: edadValida,
      edadEntre25y64: edadValida >= 25 && edadValida <= 64,
            mostrar: mostrarPAP
        });
        if (mostrarPAP) {
            seccionPAPAM.style.display = 'block';
        } else {
            seccionPAPAM.style.display = 'none';
        }
        
        // Mamograf√≠a: Mujeres 50-69 a√±os
    const mostrarMamo = sexoNorm === 'F' && edadValida >= 50 && edadValida <= 69;
        console.log('[DEBUG-SCREENING] Mamograf√≠a - Condiciones:', {
      sexo: sexo,
      sexoNorm,
      sexoEsF: sexoNorm === 'F',
      edad: edad,
      edadNum: edadValida,
      edadEntre50y69: edadValida >= 50 && edadValida <= 69,
            mostrar: mostrarMamo
        });
        if (mostrarMamo) {
            seccionMamografiaAM.style.display = 'block';
        } else {
            seccionMamografiaAM.style.display = 'none';
        }
        
        // PSA: Hombres ‚â•50 a√±os
    const mostrarPSA = sexoNorm === 'M' && edadValida >= 50;
        console.log('[DEBUG-SCREENING] PSA - Condiciones:', {
      sexo: sexo,
      sexoNorm,
      sexoEsM: sexoNorm === 'M',
      edad: edad,
      edadNum: edadValida,
      edadMayor50: edadValida >= 50,
            mostrar: mostrarPSA
        });
        if (mostrarPSA) {
            seccionPSAAM.style.display = 'block';
        } else {
            seccionPSAAM.style.display = 'none';
        }
    }
    
    // Cargar datos de screening generales
    try {
        const response = await authFetch(`/api/screening/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.screening) {
                console.log('[üë¥ Adulto Mayor - Screening] Datos cargados:', result.screening);
                mostrarDatosScreeningActualesAM(result.screening);
            }
        }
    } catch (error) {
        console.error('[üë¥ Adulto Mayor - Screening] Error cargando datos generales:', error);
    }
    
    // Cargar historial de vacunas (aplica a todos)
  cargarHistorialVacunasAM(run);
}

// Funci√≥n para mostrar datos actuales de screening en Adulto Mayor (MISMA FIRMA, MISMO ORDEN)
function mostrarDatosScreeningActualesAM(screening) {
    if (!screening || typeof screening !== 'object') return;

    // ===== PAP =====
    if (screening.pap) {
        setValueIf(byId('fechaPAPAM'), screening.pap.fecha);

        const papOk = screening.pap.estado === 'al_dia' || screening.pap.estado === 'realizado';
        setBooleanString(byId('estadoPAPAM'), papOk);

        setValueIf(byId('resultadoPAPAM'), screening.pap.resultado);

        // Calcular vigencia (3 a√±os)
        const fechaPAP = new Date(screening.pap.fecha);
        const hoy = new Date();
        const diffAnios = (hoy - fechaPAP) / (1000 * 60 * 60 * 24 * 365.25);
        const vigente = diffAnios <= 3;
        
        let estadoVigencia = '';
        let colorVigencia = '#10b981'; // verde por defecto
        let bgVigencia = '#d1fae5';
        
        if (vigente) {
            estadoVigencia = '‚úÖ Vigente';
        } else {
            estadoVigencia = '‚ö†Ô∏è Vencido (m√°s de 3 a√±os)';
            colorVigencia = '#ef4444'; // rojo
            bgVigencia = '#fee2e2';
        }

        const papHTML = `<div style="margin-top:8px;padding:8px;background:${bgVigencia};border-radius:4px;font-size:0.8rem;border-left:3px solid ${colorVigencia};">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>√öltimo PAP:</strong> ${screening.pap.fecha} - Estado: ${screening.pap.estado}
                </div>
                <div style="font-weight:600;color:${colorVigencia};">
                    ${estadoVigencia}
                </div>
            </div>
            ${!vigente ? '<div style="margin-top:4px;font-size:0.75rem;color:#991b1b;">‚ö†Ô∏è Requiere actualizaci√≥n</div>' : ''}
        </div>`;
        upsertEstadoActual('seccionPAPAM', papHTML);
    }

    // ===== MAMOGRAF√çA =====
    if (screening.mamografia) {
        setValueIf(byId('fechaMamografiaAM'), screening.mamografia.fecha);

        const mamOk = screening.mamografia.estado === 'realizada';
        setBooleanString(byId('estadoMamografiaAM'), mamOk);

        if (screening.mamografia.birads !== undefined) {
            const elBirads = byId('biradsMamografiaAM');
            if (elBirads) elBirads.value = String(screening.mamografia.birads);
        }

        // Calcular vigencia (2 a√±os)
        const fechaMamo = new Date(screening.mamografia.fecha);
        const hoy = new Date();
        const diffAniosMamo = (hoy - fechaMamo) / (1000 * 60 * 60 * 24 * 365.25);
        const vigenteMamo = diffAniosMamo <= 2;
        
        let estadoVigenciaMamo = '';
        let colorVigenciaMamo = '#10b981';
        let bgVigenciaMamo = '#d1fae5';
        
        if (vigenteMamo) {
            estadoVigenciaMamo = '‚úÖ Vigente';
        } else {
            estadoVigenciaMamo = '‚ö†Ô∏è Vencido (m√°s de 2 a√±os)';
            colorVigenciaMamo = '#ef4444';
            bgVigenciaMamo = '#fee2e2';
        }

        const mamHTML = `<div style="margin-top:8px;padding:8px;background:${bgVigenciaMamo};border-radius:4px;font-size:0.8rem;border-left:3px solid ${colorVigenciaMamo};">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>√öltima Mamograf√≠a:</strong> ${screening.mamografia.fecha} - Estado: ${screening.mamografia.estado}
                </div>
                <div style="font-weight:600;color:${colorVigenciaMamo};">
                    ${estadoVigenciaMamo}
                </div>
            </div>
            ${!vigenteMamo ? '<div style="margin-top:4px;font-size:0.75rem;color:#991b1b;">‚ö†Ô∏è Requiere actualizaci√≥n</div>' : ''}
        </div>`;
        upsertEstadoActual('seccionMamografiaAM', mamHTML);
    }

    // ===== PSA =====
    if (screening.psa) {
        setValueIf(byId('fechaPSAAM'), screening.psa.fecha);
        // Mantener sem√°ntica original: solo asigna si psa_valor es truthy (0 se omite)
        setValueIf(byId('valorPSAAM'), screening.psa.psa_valor);

        // Calcular vigencia (1 a√±o)
        const fechaPSA = new Date(screening.psa.fecha);
        const hoy = new Date();
        const diffAniosPSA = (hoy - fechaPSA) / (1000 * 60 * 60 * 24 * 365.25);
        const vigentePSA = diffAniosPSA <= 1;
        
        let estadoVigenciaPSA = '';
        let colorVigenciaPSA = '#10b981';
        let bgVigenciaPSA = '#d1fae5';
        
        if (vigentePSA) {
            estadoVigenciaPSA = '‚úÖ Vigente';
        } else {
            estadoVigenciaPSA = '‚ö†Ô∏è Vencido (m√°s de 1 a√±o)';
            colorVigenciaPSA = '#ef4444';
            bgVigenciaPSA = '#fee2e2';
        }

        const psaHTML = `<div style="margin-top:8px;padding:8px;background:${bgVigenciaPSA};border-radius:4px;font-size:0.8rem;border-left:3px solid ${colorVigenciaPSA};">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>√öltimo PSA:</strong> ${screening.psa.fecha} - Valor: ${screening.psa.psa_valor} ng/mL
                </div>
                <div style="font-weight:600;color:${colorVigenciaPSA};">
                    ${estadoVigenciaPSA}
                </div>
            </div>
            ${!vigentePSA ? '<div style="margin-top:4px;font-size:0.75rem;color:#991b1b;">‚ö†Ô∏è Requiere actualizaci√≥n</div>' : ''}
        </div>`;
        upsertEstadoActual('seccionPSAAM', psaHTML);
    }
}

// Funci√≥n para cargar historial de vacunas en Adulto Mayor
async function cargarHistorialVacunasAM(run) {
    try {
        if (!run) return;
        
        console.log('[üë¥ Adulto Mayor - Vacunas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`);
        if (!response.ok) {
            console.log('[üë¥ Adulto Mayor - Vacunas] No hay historial disponible');
            return;
        }
        
        const result = await response.json();
        const historialDiv = document.getElementById('historialVacunasAM');
        const listaDiv = document.getElementById('listaHistorialVacunasAM');
        
        if (!historialDiv || !listaDiv) return;
        
        if (result && result.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.map(vacuna => {
                const fecha = new Date(vacuna.fecha).toLocaleDateString('es-CL');
                const tipoDisplay = vacuna.tipo === 'influenza' ? 'Influenza' : 'COVID';
                const estadoColor = vacuna.estado === 'SI' ? '#10b981' : vacuna.estado === 'NO' ? '#ef4444' : '#f59e0b';
                const estadoBg = vacuna.estado === 'SI' ? '#d1fae5' : vacuna.estado === 'NO' ? '#fef2f2' : '#fef3c7';
                
                return `
                    <div style="padding:6px 8px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">
                                <span style="font-size:0.7rem;font-weight:600;color:#1f2937;">${tipoDisplay}</span>
                                <span style="font-size:0.65rem;color:#6b7280;">${fecha}</span>
                            </div>
                        </div>
                        <span style="background:${estadoBg};color:${estadoColor};padding:1px 4px;border-radius:2px;font-size:0.6rem;font-weight:600;">
                            ${vacuna.estado}
                        </span>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.7rem;">No hay historial de vacunas</div>';
        }
    } catch (error) {
        console.error('[üë¥ Adulto Mayor - Vacunas] Error cargando historial:', error);
    }
}

// Exponer funciones globalmente
window.guardarVacuna = guardarVacuna;
window.cargarHistorialVacunas = cargarHistorialVacunas;
window.guardarPAP = guardarPAP;
window.cargarHistorialPAP = cargarHistorialPAP;
window.guardarMamografia = guardarMamografia;
window.cargarHistorialMamografia = cargarHistorialMamografia;
window.guardarPSA = guardarPSA;
window.cargarHistorialPSA = cargarHistorialPSA;
window.cargarDatosScreening = cargarDatosScreening;
window.cargarDatosScreeningAM = cargarDatosScreeningAM;
window.cargarHistorialVacunasAM = cargarHistorialVacunasAM;
window.calcularClasificacionTUG = calcularClasificacionTUG;
window.calcularClasificacionUnipodal = calcularClasificacionUnipodal;

})(); // Cierre de la funci√≥n an√≥nima principal

// ========== FUNCIONES DE DEBUG GLOBALES ==========

// Funci√≥n de diagn√≥stico mejorada
window.diagnosticarHistoriales = function(run = '10.000.141-1') {
    console.log('üîç [DIAGN√ìSTICO] Iniciando diagn√≥stico de historiales...');
    
    const elementos = [
        'historialPieDiabetico',
        'historialCuraciones', 
        'historialEkg',
        'historialHipoglicemias',
        'historialAmputacion',
        'historialInsulina',
        'historialPodologia',
        'historialFondoOjos'
    ];
    
    console.log('üìã [DOM] Verificando elementos del DOM...');
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        console.log(`${elemento ? '‚úÖ' : '‚ùå'} ${id}: ${elemento ? 'Encontrado' : 'NO ENCONTRADO'}`);
    });
    
    console.log('üîç [DIAGN√ìSTICO] Diagn√≥stico completado - Revisa los resultados arriba');
};

// Funci√≥n simplificada para probar endpoints directamente
window.probarEndpoint = async function(endpoint, nombre) {
    console.log(`üß™ [ENDPOINT] Probando ${nombre}: ${endpoint}`);
    try {
        const response = await fetch(endpoint, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token') || 'NO_TOKEN'}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log(`‚úÖ [${nombre}] Status: ${response.status}`, data);
        } else {
            console.log(`‚ùå [${nombre}] Status: ${response.status}`, await response.text());
        }
    } catch (error) {
        console.error(`‚ùå [${nombre}] Error:`, error);
    }
};

// Funci√≥n para probar todos los endpoints de diabetes
window.probarEndpointsDiabetes = async function(run = '10.000.141-1') {
    console.log('üöÄ [ENDPOINTS] Probando todos los endpoints de diabetes...');
    
    const endpoints = [
        [`/api/examenes/pie_dm/historial/${run}`, 'Pie Diab√©tico'],
        [`/api/examenes/curaciones_piedm/historial/${run}`, 'Curaciones'],
        [`/api/examenes/ekg/${run}`, 'EKG'],
        [`/api/diabetes/hipoglicemias/historial/${run}`, 'Hipoglicemias'],
        [`/api/examenes/fondo_ojos/historial/${run}`, 'Fondo de Ojos'],
        [`/api/diabetes/podologia/historial/${run}`, 'Podolog√≠a']
    ];
    
    for (const [endpoint, nombre] of endpoints) {
        await probarEndpoint(`http://127.0.0.1:8000${endpoint}`, nombre);
        await new Promise(resolve => setTimeout(resolve, 500)); // Pausa de 500ms entre requests
    }
    
    console.log('‚úÖ [ENDPOINTS] Prueba de endpoints completada');
};

// Inicializar fechas al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar fecha de actividad f√≠sica
    const fechaActividadFisica = document.getElementById('fechaActividadFisica');
    if (fechaActividadFisica) {
        fechaActividadFisica.value = new Date().toISOString().split('T')[0];
    }
    
    // Inicializar fecha de MasAma
    const fechaMasAma = document.getElementById('fechaMasAma');
    if (fechaMasAma) {
        fechaMasAma.value = new Date().toISOString().split('T')[0];
    }

    // ============ CARGA AUTOM√ÅTICA DESDE P√ÅGINA DETALLE ============
    // Nota: Este c√≥digo se movi√≥ al final del script para asegurar que todas las funciones est√©n disponibles

    // ---- FIX MANDRAKEBOT: Timing correcto del DOM ----
    console.log('ü§ñ Inicializando MandrakeBot con DOM listo...');
    
    // 1) Referencias √∫nicas
    const btnMandrakeBot = document.getElementById('btn-mandrake-bot');
    const chatOverlay     = document.getElementById('mandrake-chat-overlay');
    const chatClose       = document.getElementById('mandrake-chat-close');
    const chatMessages    = document.getElementById('mandrake-chat-messages');
    const chatInput       = document.getElementById('mandrake-chat-input');
    const chatSend        = document.getElementById('mandrake-chat-send');

    if (!btnMandrakeBot || !chatOverlay) {
        console.error('‚ùå MandrakeBot button/overlay not found; verifica IDs y orden de carga');
        console.log('Elementos encontrados:', {
            btnMandrakeBot: !!btnMandrakeBot,
            chatOverlay: !!chatOverlay,
            chatClose: !!chatClose,
            chatMessages: !!chatMessages,
            chatInput: !!chatInput,
            chatSend: !!chatSend
        });
        return;
    }

    console.log('‚úÖ MandrakeBot elementos encontrados correctamente');

    // 2) Abrir/cerrar
    const open = () => {
        console.log('ü§ñ Abriendo MandrakeBot...');
        chatOverlay.style.display = 'flex';
        chatInput?.focus();
        
        // Mensaje de bienvenida si es la primera vez
        if (chatMessages && chatMessages.children.length === 1) {
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'mandrake-message system';
            welcomeMsg.innerHTML = '¬°Hola! üëã<br><br>Escribe "<strong>demo</strong>" para ver autocompletado o haz consultas m√©dicas.<br><br>Ejemplos:<br>‚Ä¢ "Paciente diab√©tico de 60 a√±os"<br>‚Ä¢ "S√≠ntomas de hipertensi√≥n"<br>‚Ä¢ "demo" para datos de prueba';
            chatMessages.appendChild(welcomeMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    };
    
    const close = () => {
        console.log('ü§ñ Cerrando MandrakeBot...');
        chatOverlay.style.display = 'none';
    };

    // 3) Listeners (una sola vez)
    btnMandrakeBot.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('ü§ñ Click en bot√≥n MandrakeBot');
        open();
    });
    
    chatClose?.addEventListener('click', close);
    
    chatOverlay.addEventListener('click', (e) => { 
        if (e.target === chatOverlay) close(); 
    });
    
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
            e.preventDefault(); 
            (chatOverlay.style.display === 'flex' ? close() : open());
        }
        if (e.key === 'Escape' && chatOverlay.style.display === 'flex') close();
    });

    // 4) Enviar mensaje mejorado con autollenado inmediato
    
    // Funci√≥n auxiliar para mostrar alertas visuales
    function showAlert(message, type) {
        // Crear elemento de alerta
        const alert = document.createElement('div');
        alert.className = `mandrake-alert mandrake-alert-${type}`;
        alert.innerHTML = message;
        
        // Estilos din√°micos
        const alertStyles = {
            success: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;',
            warning: 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;',
            error: 'background: #f8d7da; color: #721c24; border: 1px solid #f1b0b7;'
        };
        
        alert.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            ${alertStyles[type] || alertStyles.success}
        `;
        
        // Agregar animaci√≥n CSS si no existe
        if (!document.getElementById('mandrake-alert-styles')) {
            const style = document.createElement('style');
            style.id = 'mandrake-alert-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(alert);
        
        // Auto-remover despu√©s de 4 segundos
        setTimeout(() => {
            alert.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        }, 4000);
        
        // Permitir cerrar con click
        alert.addEventListener('click', () => {
            alert.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        });
    }
    
    // Funci√≥n para minimizar MandrakeBot
    function minimizeMandrakeBot() {
        const chatOverlay = document.getElementById('mandrake-chat-overlay');
        const chatNotification = document.createElement('div');
        
        if (!chatOverlay) return;
        
        // Ocultar el chat overlay
        chatOverlay.style.display = 'none';
        
        // Mostrar notificaci√≥n de minimizaci√≥n
        chatNotification.className = 'mandrake-minimize-notification';
        chatNotification.innerHTML = `
            <div style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                z-index: 1001;
                font-size: 14px;
                animation: slideInUp 0.3s ease-out;
                cursor: pointer;
                user-select: none;
            " onclick="this.remove()">
                ü§ñ MandrakeBot minimizado. Revisa los campos destacados.
                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                    Click para cerrar esta notificaci√≥n
                </div>
            </div>
        `;
        
        // Agregar animaci√≥n CSS si no existe
        if (!document.getElementById('mandrake-minimize-styles')) {
            const style = document.createElement('style');
            style.id = 'mandrake-minimize-styles';
            style.textContent = `
                @keyframes slideInUp {
                    from { transform: translateY(100%); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(chatNotification);
        
        // Auto-remover la notificaci√≥n despu√©s de 8 segundos
        setTimeout(() => {
            if (chatNotification.parentNode) {
                chatNotification.style.transition = 'all 0.3s ease-out';
                chatNotification.style.transform = 'translateY(100%)';
                chatNotification.style.opacity = '0';
                setTimeout(() => {
                    if (chatNotification.parentNode) {
                        chatNotification.parentNode.removeChild(chatNotification);
                    }
                }, 300);
            }
        }, 8000);
        
        console.log('ü§ñ MandrakeBot minimizado - usuario puede revisar formulario');
    }
    
    chatSend?.addEventListener('click', sendMandrakeMessage);
    chatInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            sendMandrakeMessage(); 
        }
    });

    // 5) Respaldo global (si mantienes onclick="openMandrakeBot()")
    window.openMandrakeBot = open;
    
    console.log('ü§ñ MandrakeBot inicializado correctamente!');
});

</script>

<!-- Chat MandrakeBot -->
<div id="mandrake-chat-overlay">
  <div id="mandrake-chat-container">
    <div id="mandrake-chat-header">
      <div>
        <h3 style="margin:0;font-size:18px;font-weight:600;">ü§ñ MandrakeBot</h3>
        <p style="margin:0;font-size:12px;opacity:0.9;">Asistente m√©dico inteligente</p>
      </div>
      <button id="mandrake-chat-close">&times;</button>
    </div>
    
    <div id="mandrake-chat-messages">
      <div class="mandrake-message bot">
        ¬°Hola! Soy MandrakeBot, tu asistente m√©dico inteligente. üëã<br><br>
        Puedo ayudarte con:
        <ul style="margin:8px 0;padding-left:20px;">
          <li>Autocompletar formularios m√©dicos</li>
          <li>Sugerir diagn√≥sticos basados en s√≠ntomas</li>
          <li>Validar datos cl√≠nicos</li>
          <li>Interpretar resultados de ex√°menes</li>
          <li>Recordar protocolos m√©dicos</li>
        </ul>
        ¬øEn qu√© puedo ayudarte hoy?
      </div>
    </div>
    
    <div id="mandrake-chat-input-container">
      <input type="text" id="mandrake-chat-input" placeholder="Escribe tu consulta m√©dica..." maxlength="500">
      <button id="mandrake-chat-send">Enviar</button>
    </div>
  </div>
</div>

<!-- Mandrake API disponible globalmente -->
<script>
// ---- MANDRAKE API: Sistema de autocompletado de formularios ----
(function () {
  const FIELD_MAP = {
    run:              ['#run'],
    nombre:           ['#nombre'],
    sexo:             ['#sexo'],
    fecha_nacimiento: ['#fecha_nacimiento'],
    edad:             ['#edad'],
    direccion:        ['#direccion'],
    telefono:         ['#telefono'],
    nivel_educacion:  ['#nivel_educacion'],
    origen_etnico:    ['#origen_etnico'],
    sector_id:        ['#sector_id'],
    categoria:        ['#categoria']
  };

  const _pad2 = n => String(n).padStart(2, '0');
  const _toISO = v => {
    if (!v) return '';
    const s = String(v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})$/);
    if (!m) return s;
    return `${m[3]}-${_pad2(m[2])}-${_pad2(m[1])}`;
  };
  
  const _calcEdad = iso => {
    try {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(+d)) return '';
      const t = new Date();
      let e = t.getFullYear() - d.getFullYear();
      const m = t.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && t.getDate() < d.getDate())) e--;
      return e >= 0 ? String(e) : '';
    } catch { return ''; }
  };

  function setValue(selArr, value) {
    selArr.forEach(sel => {
      const el = document.querySelector(sel);
      if (!el) return;
      if (el.type === 'date') {
        const iso = _toISO(value);
        if (iso) el.value = iso;
      } else if (el.tagName === 'SELECT') {
        el.value = value ?? '';
      } else if (el.hasAttribute('readonly')) {
        el.value = value ?? '';
      } else {
        el.value = value ?? '';
      }
    });
  }

  // Sistema de destacado de campos modificados
  const highlightedFields = new Set();
  const highlightedTabs = new Set();

  function highlightField(selector) {
    const el = (typeof selector==='string')? document.querySelector(selector) : selector;
    if(!el) return;
    el.classList.add('mandrake-modified');
    if(typeof selector==='string') highlightedFields.add(selector);
    const tab = el.closest('[data-panel]');
    if(tab){ const tabName = tab.getAttribute('data-panel'); highlightTab(tabName); }
  }
  function highlightTab(tabName) {
    const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
    if (tabButton && !tabButton.classList.contains('mandrake-tab-modified')) {
      tabButton.classList.add('mandrake-tab-modified');
      highlightedTabs.add(tabName);
      
      // Agregar indicador visual en la pesta√±a
      if (!tabButton.querySelector('.mandrake-indicator')) {
        const indicator = document.createElement('span');
        indicator.className = 'mandrake-indicator';
        indicator.innerHTML = '‚óè';
        indicator.title = 'Modificado por MandrakeBot';
        tabButton.appendChild(indicator);
      }
    }
  }

  function clearHighlights() {
    // Limpiar campos
    highlightedFields.forEach(selector => {
      const el = document.querySelector(selector);
      if (el) el.classList.remove('mandrake-modified');
    });
    highlightedFields.clear();

    // Limpiar pesta√±as
    highlightedTabs.forEach(tabName => {
      const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
      if (tabButton) {
        tabButton.classList.remove('mandrake-tab-modified');
        const indicator = tabButton.querySelector('.mandrake-indicator');
        if (indicator) indicator.remove();
      }
    });
    highlightedTabs.clear();
  }


  // API p√∫blica
  window.Mandrake = {
    apply(raw, { autoEdad = true } = {}) {
      const data = typeof raw === 'string' ? JSON.parse(raw) : (raw || {});
      if (data.fecha_nacimiento) {
        data.fecha_nacimiento = _toISO(data.fecha_nacimiento);
      }
      if (autoEdad && !data.edad && data.fecha_nacimiento) {
        data.edad = _calcEdad(data.fecha_nacimiento);
      }
      
      // Contar campos que realmente van a cambiar
      let fieldsToModify = 0;
      Object.entries(FIELD_MAP).forEach(([k, sels]) => {
        if (data[k] !== undefined && data[k] !== null && data[k] !== '') {
          sels.forEach(sel => {
            const el = document.querySelector(sel);
            if (el && (el.value || '') !== (data[k] || '')) {
              fieldsToModify++;
            }
          });
        }
      });

      // Aplicar cambios
      Object.entries(FIELD_MAP).forEach(([k, sels]) => {
        if (data[k] !== undefined && data[k] !== null && data[k] !== '') {
          setValue(sels, data[k]);
        }
      });

      // Mostrar notificaci√≥n de revisi√≥n si se modificaron campos
      if (fieldsToModify > 0) {
        showReviewNotification(fieldsToModify);
      }
      
      // Actualizar resumen visual
      const spRun = document.querySelector('[data-f="run"]');
      if (spRun && data.run) spRun.textContent = data.run;
      const spNom = document.querySelector('[data-f="nombre_completo"]');
      if (spNom && (data.nombre || data.nombre_completo)) {
        spNom.textContent = data.nombre || data.nombre_completo;
      }
      const spFn = document.querySelector('[data-f="fecha_nacimiento"]');
      if (spFn && data.fecha_nacimiento) spFn.textContent = data.fecha_nacimiento;
      const spEdad = document.querySelector('[data-f="edad"]');
      if (spEdad && data.edad) spEdad.textContent = data.edad;
      const spSexo = document.querySelector('[data-f="sexo"]');
      if (spSexo && data.sexo) spSexo.textContent = data.sexo;

      try {
        window.renderMandrakeSummary && window.renderMandrakeSummary(data, { source: 'mandrake.apply' });
      } catch (err) {
        console.warn('Mandrake summary render failed', err);
      }

      console.log('ü§ñ Mandrake.apply() ejecutado:', data);
      return data;
    }
  };
  
  window.MandrakeApply = (data) => window.Mandrake.apply(data);
})();
</script>

<!-- MandrakePaste: Parser de textos cl√≠nicos -->
<script>
(function(){
  // ============ Helpers de normalizaci√≥n ============
  const _pad2 = n => String(n).padStart(2,'0');
  const _toISO = (s) => {
    if(!s) return '';
    s = String(s).trim();
    // YYYY-MM-DD
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // dd-mm-aaaa | dd/mm/aaaa | dd.mm.aaaa
    const m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
    if(!m) return '';
    const y = m[3].length===2 ? ('20'+m[3]) : m[3];
    return `${y}-${_pad2(m[2])}-${_pad2(m[1])}`;
  };
  const _sanitizeRun = s => (s||'').replace(/[.\s-]/g,'').toUpperCase();
  const _onlyDigits = s => (s||'').replace(/[^\d]/g,'');
  const _num = (s) => {
    if(s==null) return null;
    let t = String(s).trim();
    if(!t) return null;
    if(/,\d{1,3}$/.test(t)){
      t = t.replace(/\./g,'').replace(',', '.');
    } else {
      t = t
        .replace(/\s+/g,'')
        .replace(/(\d)[\.¬∑](?=\d{3}(?:[^0-9]|$))/g,'$1')
        .replace(/,(?=\d{3}(?:[^0-9]|$))/g,'');
    }
    const v = parseFloat(t);
    return Number.isFinite(v)? v : null;
  };
  const _pickLineOrNext = (text, pattern) => {
    const re = pattern instanceof RegExp ? pattern : new RegExp(pattern, 'i');
    const lines = String(text||'').split(/\r?\n/);
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      if(!re.test(line)) continue;
      const colonMatch = line.match(/:\s*(.+)$/);
      if(colonMatch && colonMatch[1].trim()) return colonMatch[1].trim();
      const stripped = line.replace(re,'').replace(/^[\s:.-]+/,'').trim();
      if(stripped) return stripped;
      for(let j=i+1;j<lines.length;j++){
        const candidate = lines[j].trim();
        if(candidate) return candidate;
      }
    }
    return null;
  };
  const _calcEdad = (y, m, d) => {
    try{
      const dob = new Date(Number(y), Number(m)-1, Number(d));
      if(isNaN(+dob)) return null;
      const t = new Date();
      let e = t.getFullYear()-dob.getFullYear();
      const mm = t.getMonth()-dob.getMonth();
      if(mm<0 || (mm===0 && t.getDate()<dob.getDate())) e--;
      return e;
    }catch{ return null; }
  };
  
  const SECTION_RULES = [
    { key:'motivo_consulta', re:/^Motivo(?:\s+de)?\s+consulta\b/i },
    { key:'enfermedad_actual', re:/^(?:Anamnesis|Enfermedad\s+actual|Historia\s+actual|Historial\s+de\s+la\s+enfermedad|Motivo\s+de\s+consulta\s+detallado)\b/i },
    { key:'estudios_relevantes', re:/^(?:Estudios|Ex[√°a]menes|Resultados|Laboratorios?|Imagen(?:es)?|Examenes\s+complementarios)\b/i },
    { key:'condiciones_riesgos', re:/^(?:Condiciones|Factores\s+de\s+riesgo|Antecedentes|Riesgos\s+asociados|Comorbilidades)\b/i },
    { key:'indicaciones', re:/^(?:Indicaciones|Plan\s+de\s+cuidado|Plan\s+de\s+tratamiento|Conducta|Manejo)\b/i },
    { key:'funcionalidad', re:/^(?:Funcionalidad|Evaluaci[o√≥]n\s+funcional|Barthel|Lawton|Katz|EFAM|EMPAM|Autovalencia)\b/i },
    { key:'actividades_programadas', re:/^(?:Actividades|Derivaciones|Seguimiento|Tareas|Pr[o√≥]ximos\s+controles)\b/i },
    { key:'formularios_realizados', re:/^(?:Formularios|Cuestionarios|Escalas|Instrumentos)\b/i },
    { key:'empam', re:/^(?:EMPAM|EFAM|Aplicaci[o√≥]n\s+EMPAM|Aplicaci[o√≥]n\s+EFAM)\b/i },
    { key:'atencion_familiar', re:/^Atenci[o√≥]n\s+Familiar\b/i }
  ];

  const SECTION_STOP_RX = /^(?:Diagn[o√≥]sticos?|Cierre\s+diagn[o√≥]stico|Resumen\s+diagn[o√≥]stico)\b/i;

  function _matchSection(line){
    if(!line) return null;
    const cleaned = line.replace(/[:Ôºö\-]+$/,'').trim();
    return SECTION_RULES.find(rule => rule.re.test(cleaned)) || null;
  }

  function _extractSections(text){
    const sections = {};
    if(!text) return sections;
    const lines = String(text).split(/\r?\n/);
    let current = null;
    for(const rawLine of lines){
      const trimmed = rawLine.trim();
      if(!trimmed) continue;
      if(SECTION_STOP_RX.test(trimmed)){
        current = null;
        continue;
      }
      const match = _matchSection(trimmed);
      if(match){
        current = match.key;
        if(!sections[current]) sections[current] = [];
        let remainder = '';
        const colonParts = trimmed.split(/:\s*/);
        if(colonParts.length>1){
          remainder = colonParts.slice(1).join(': ').trim();
        } else {
          remainder = trimmed.replace(match.re,'').trim();
        }
        if(remainder) sections[current].push(remainder);
        continue;
      }
      if(current){
        sections[current].push(trimmed);
      }
    }
    Object.keys(sections).forEach(key => {
      const joined = sections[key].join('\n').trim();
      if(joined) sections[key] = joined; else delete sections[key];
    });
    return sections;
  }

  function _splitListBlock(text){
    if(!text) return [];
    return String(text)
      .split(/\r?\n+/)
      .map(line => line.replace(/^(?:[\d]+(?:[\.\)]|\s)|[-‚Ä¢*])\s*/,'').trim())
      .filter(Boolean);
  }

  function _parseEmpamBlock(text){
    if(!text) return null;
    const base = String(text);
    const empam = { texto: base.trim() };
    const puntaje = base.match(/Puntaj[e√©]\s*[:=]\s*(\d{1,3})/i);
    if(puntaje) empam.puntaje = Number(puntaje[1]);
    const clas = base.match(/Clasificaci[o√≥]n\s*[:=]\s*([^\n]+)/i);
    if(clas) empam.clasificacion = clas[1].trim();
    const sub = base.match(/Sub[√°a]reas?\s*[:=]\s*([^\n]+)/i);
    if(sub) empam.subareas = sub[1].trim();
    const resumen = base.match(/Resumen\s*[:=]\s*([^\n]+)/i);
    if(resumen) empam.resumen = resumen[1].trim();
    return empam;
  }
  
  // ============ Extractores (regex robustos para espa√±ol cl√≠nico) ============
  const RX = {
    rut: /R\.?U\.?T\.?\s*:\s*([0-9.\-Kk]+)/i,
    nombre: /Nombre\s*:\s*(?:\([^)]+\)\s*)?([A-Za-z√Å√â√ç√ì√ö√ë√ú√§√´√Ø√∂√º√°√©√≠√≥√∫√±√º'¬¥` ]{3,})/i,
    edad_det: /Edad\s*:\s*(\d{1,3})\s*a√±os(?:\s*(\d{1,2})\s*mes(?:es)?)?(?:\s*(\d{1,2})\s*d[i√≠]as?)?/i,
    fecha_hora: /Fecha\s*y\s*Hora\s*de\s*atenci[o√≥]n\s*:\s*([0-9\/\-.]{8,10})\s+([0-9:]{4,5})/i,
    funcionario: /Funcionario(?:\(s\)\s*que\s*participa\(n\))?\s*:\s*([^\n]+)/i,
    profesion: /Profes[i√≠]o[nm]\s*:\s*([^\n]+)/i,
    establecimiento: /Establecimiento\s*:\s*([^\n]+)/i,
    procedencia: /Procedencia\s*:\s*([^\n]+)/i,
    tipo_consulta: /Tipo\s+de\s+consulta\s*:\s*([^\n]+)/i,
    pa: /Presi[o√≥]n\s*Arterial\s*\(mmHg\)\s*:\s*(\d{2,3})\s*\/\s*(\d{2,3})/i,
    pulso: /Pulso.*?:\s*(\d{2,3})\b/i,
    hgt: /Hemoglucotest.*?:\s*([0-9.,]+)\b/i,
    peso: /Peso\s*\(Kg\)\s*:\s*([0-9.,]+)\b/i,
    talla: /Talla\s*\(cm\)\s*:\s*([0-9.,]+)\b/i,
    imc: /I\.?M\.?C\.?(?:\s*\*?)?\s*:\s*([0-9.,]+)\b/i,
    cc: /Circunferencia\s*de\s*Cintura.*?:\s*([0-9.,]+)\b/i,
    hba1c: /Hb?a1c?\s*[:=]?\s*([0-9.,]+)\b/i,
  ldl: /\b(?:LDL|C(?:olesterol)?\s*LDL)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  glicemia: /\b(?:glic(?:emia)?|glucosa|gpa)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  hdl: /\b(?:HDL(?:-C)?|C(?:olesterol)?\s*HDL)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  col_total: /\b(?:Col(?:esterol)?\s*(?:Total|Tot)|C\/T|CT)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  trigliceridos: /\b(?:Triglic[√©e]ridos?|TAG|TG\b)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  creatinina: /\b(?:Creatin(?:ina|emia|inemia)|Cr(?:s|e)?|CrS)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  sodio: /\b(?:Sodio|Na(?:\s*seric[oa])?)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  potasio: /\b(?:Potasio|K(?:\s*seric[oa])?)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  cloro: /\b(?:Clor[oa]?|Cloruro|Cl)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  uremia: /\b(?:Uremia|Urea)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  bun: /\bNitr[o√≥]geno\s+Ureico\b[^0-9]{0,8}([0-9.,]+)\b/i,
  vfg: /\b(?:VFG|TFG|eGFR|TFGe)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  rac: /\b(?:RAC|√ç?NDICE\s*MAU\s*\/?\s*CREA(?:U)?|MAU\s*\/?\s*CREA(?:U)?)\b[^0-9]{0,10}([0-9.,]+)\b/i,
  microalbuminuria: /\b(?:Micro(?:albuminuria|alb)|MAU)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  creatininuria: /\b(?:Creatininuria|Creatinuria|Creatinina\s+(?:en\s+)?Orina(?:\s+Aislada)?|Creatinina\s+Urinaria)\b[^0-9]{0,10}([0-9.,]+)\b/i,
  hematocrito: /\b(?:Hematocrito|Hto\.?|HCT)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  hemoglobina: /\b(?:Hemoglobina(?:\s+Total)?|Hb\s*(?!a1c|A1c))\b[^0-9]{0,6}([0-9.,]+)\b/i,
  leucocitos: /\b(?:Leucocitos|Leu(?:cocitos)?|Rct(?:o)?\.?\s*de\s*Leucocitos)\b[^0-9]{0,10}([0-9.,]+)\b/i,
  plaquetas: /\b(?:Plaquetas|Plaq\.?|Rct(?:o)?\.?\s*de\s*Plaquetas)\b[^0-9]{0,10}([0-9.,]+)\b/i,
  vcm: /\bVCM\b[^0-9]{0,6}([0-9.,]+)\b/i,
  hcm: /\bHCM\b[^0-9]{0,6}([0-9.,]+)\b/i,
    tsh: /\bTSH\b[^0-9]{0,5}([0-9.,]+)\b/i,
    fecha_examen: /(?:Fecha\s*(?:de\s*)?(?:examen|toma|muestra)|Examen\s*fecha)\s*[:=]?\s*([0-9\/\.\-]{8,10})/i,
    // bloque diagn√≥sticos: desde "Diagn√≥stico(s)" hasta el siguiente encabezado relevante
    diagBlock: /Diagn[o√≥]sticos?[\s\S]{0,6}\n([\s\S]*?)(?:\n\s*(?:Actividades|Indicaciones|Funcionalidad|Formularios|Principales|Atenciones?|Examen(?:es)?|Condiciones)\b)/i
  };

    const NORMALIZADOR_EXAMENES_RAW = {
    'hba1c': 'HEMOGLOBINA GLICOSILADA',
    'hba1 c': 'HEMOGLOBINA GLICOSILADA',
    'hb a1c': 'HEMOGLOBINA GLICOSILADA',
    'hb a1 c': 'HEMOGLOBINA GLICOSILADA',
      'hemoglobina glicosilada': 'HEMOGLOBINA GLICOSILADA',
    'hemoglobina glicada': 'HEMOGLOBINA GLICOSILADA',
    'hemoglobina glucosilada': 'HEMOGLOBINA GLICOSILADA',
    'hb glicada': 'HEMOGLOBINA GLICOSILADA',
    'hb glicosilada': 'HEMOGLOBINA GLICOSILADA',
      'hb clico': 'HEMOGLOBINA GLICOSILADA',
      'hb glico': 'HEMOGLOBINA GLICOSILADA',
      'creatinina': 'CREATININA',
    'creatininemia': 'CREATININA',
      'crea': 'CREATININA',
    'cretinina': 'CREATININA',
      'vfg': 'VFG',
      'filtracion glomerular': 'VFG',
    'velocidad de filtracion glomerular': 'VFG',
      'tfg': 'VFG',
      'uremia': 'UREMIA',
      'urea': 'UREMIA',
    'urea nitrogenada': 'UREMIA',
    'urea nitrogenada en sangre': 'UREMIA',
      'bun': 'NITROGENO UREICO',
      'nitr√≥geno ureico': 'NITROGENO UREICO',
      'nitrogeno ureico': 'NITROGENO UREICO',
    'nitrogen ureico': 'NITROGENO UREICO',
      'sodio': 'SODIO',
      'na': 'SODIO',
      'potasio': 'POTASIO',
    'k': 'POTASIO',
      'colesterol total': 'COLESTEROL TOTAL',
      'col total': 'COLESTEROL TOTAL',
    'colesterol total plasmatico': 'COLESTEROL TOTAL',
      'hdl': 'COLESTEROL HDL',
      'col hdl': 'COLESTEROL HDL',
    'colesterol hdl': 'COLESTEROL HDL',
      'ldl': 'COLESTEROL LDL',
      'col ldl': 'COLESTEROL LDL',
    'colesterol ldl': 'COLESTEROL LDL',
      'trigliceridos': 'TRIGLICERIDOS',
      'triglic√©ridos': 'TRIGLICERIDOS',
      'tg': 'TRIGLICERIDOS',
      'hematocrito': 'HEMATOCRITO',
      'hto': 'HEMATOCRITO',
      'hemoglobina': 'HEMOGLOBINA',
      'hb': 'HEMOGLOBINA',
      'leucocitos': 'LEUCOCITOS',
      'leuco': 'LEUCOCITOS',
    'globulos blancos': 'LEUCOCITOS',
      'plaquetas': 'PLAQUETAS',
      'plt': 'PLAQUETAS',
      'microalbuminuria': 'MICROALBUMINURIA',
      'micro albuminuria': 'MICROALBUMINURIA',
      'microalbumina': 'MICROALBUMINURIA',
      'microalb/crea': 'MICROALBUMINURIA',
      'micro alb': 'MICROALBUMINURIA',
      'indice mau': 'RAC',
      'mau/crea': 'RAC',
      'indice mau/creau': 'RAC',
      'micro alb/crea': 'RAC',
    'microalb/crea': 'RAC',
    'microalb/creat': 'RAC',
    'alb/crea': 'RAC',
    'micro albumina/creatinina': 'RAC',
    'microalb/creatinina': 'RAC',
    'micro alb/creatinina': 'RAC',
      'razon albumina creatinina': 'RAC',
      'albumina creatinina': 'RAC',
      'albumina/creatinina': 'RAC',
      'alb√∫mina creatinina': 'RAC',
      'acr': 'RAC',
      'uacr': 'RAC',
      'creatininuria': 'CREATINURIA',
      'creat urinaria': 'CREATINURIA',
      'creatinuria aislada': 'CREATINURIA',
    'creatinuria': 'CREATINURIA',
      'creatinina en orina': 'CREATINURIA',
      'creatinuria orina': 'CREATINURIA',
    'creatinina urinaria': 'CREATINURIA',
    'creat orina': 'CREATINURIA',
    'crea orina': 'CREATINURIA',
      'glicemia': 'GLICEMIA',
      'glucosa': 'GLICEMIA',
      'glucemia': 'GLICEMIA',
      'tsh': 'TSH',
      'cloro': 'CLORO',
      'vcm': 'VCM',
      'hcm': 'HCM'
    };

    const _slugExamKey = (str) => {
      return String(str || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9 %]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    };

    const NORMALIZADOR_EXAMENES = {};
    Object.entries(NORMALIZADOR_EXAMENES_RAW).forEach(([key, value]) => {
      const slug = _slugExamKey(key);
      if(slug){ NORMALIZADOR_EXAMENES[slug] = value; }
    });
    const NORMALIZADOR_EXAMEN_KEYS = Object.keys(NORMALIZADOR_EXAMENES).sort((a,b)=>b.length - a.length);

    const EXAM_FIELD_MAP = {
      'HEMOGLOBINA GLICOSILADA': 'hba1c',
      'CREATININA': 'creatinemia',
      'VFG': 'vfg',
      'UREMIA': 'uremia',
      'NITROGENO UREICO': 'nitrogeno_ureico',
      'SODIO': 'sodio',
      'POTASIO': 'potasio',
      'COLESTEROL TOTAL': 'col',
      'COLESTEROL HDL': 'hdl',
      'COLESTEROL LDL': 'ldl',
      'TRIGLICERIDOS': 'tag',
      'HEMATOCRITO': 'hematocrito',
      'HEMOGLOBINA': 'hemoglobina',
      'LEUCOCITOS': 'leucocitos',
      'PLAQUETAS': 'plaquetas',
      'MICROALBUMINURIA': 'microalbuminuria_val',
      'CREATINURIA': 'creatininuria',
      'RAC': 'rac',
      'GLICEMIA': 'glicemia',
      'TSH': 'tsh',
      'CLORO': 'cloro',
      'VCM': 'vcm',
      'HCM': 'hcm'
    };

    function _normalizeExamLabel(raw){
      if(!raw) return null;
      const slug = _slugExamKey(raw);
      if(!slug) return null;
      for(const key of NORMALIZADOR_EXAMEN_KEYS){
        if(key.length <= 2){
          if(slug === key) return NORMALIZADOR_EXAMENES[key];
          const tokens = slug.split(' ');
          if(tokens.includes(key)) return NORMALIZADOR_EXAMENES[key];
          continue;
        }
        if(slug.includes(key)) return NORMALIZADOR_EXAMENES[key];
      }
      return null;
    }

  const PROFESION_CANON_DIRECT = {
    'medico': 'medico',
    'medica': 'medico',
    'medico a': 'medico',
    'medico tratante': 'medico',
    'doctor': 'medico',
    'doctora': 'medico',
    'dr': 'medico',
    'dra': 'medico',
    'enfermera': 'enfermero',
    'enfermero': 'enfermero',
    'enfermero a': 'enfermero',
    'enfermeria': 'enfermero',
    'tens': 'enfermero',
    'tec enf': 'enfermero',
    'tecnico en enfermeria': 'enfermero',
    'tecnica en enfermeria': 'enfermero',
    'nutricionista': 'nutricionista',
    'nutricionista a': 'nutricionista',
    'trabajador social': 'asistente social',
    'trabajadora social': 'asistente social',
    'asistente social': 'asistente social',
    'politaco': 'politaco',
    'politaca': 'politaco',
    'visita': 'VDI',
    'visita domiciliaria': 'VDI',
    'visita domiciliaria integral': 'VDI',
    'visita domiciliaria programada': 'VDI',
    'vdi': 'VDI'
  };

  const PROFESION_CANON_HEURISTICS = [
    { re: /^medic[oa]\b/, value: 'medico' },
    { re: /^drs?\b/, value: 'medico' },
    { re: /^doctora?\b/, value: 'medico' },
    { re: /^enfermer[oa]\b/, value: 'enfermero' },
    { re: /^tec(?:nico|nica)?\s+en\s+enfermer/, value: 'enfermero' },
    { re: /^nutricionist[ao]\b/, value: 'nutricionista' },
    { re: /^asistente\s+social\b/, value: 'asistente social' },
    { re: /^trabajador(?:a)?\s+social\b/, value: 'asistente social' },
    { re: /^politac[oa]\b/, value: 'politaco' },
    { re: /^visita(?:\s+domiciliaria(?:\s+integral)?)?$/, value: 'VDI' },
    { re: /^vdi\b/, value: 'VDI' }
  ];

  function normalizeProfesionValue(value, { allowHeuristics = true } = {}) {
    if(value==null) return null;
    const original = String(value).trim();
    if(!original) return null;
    const base = original
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,' ')
      .trim();
    if(!base) return null;
    const compact = base.replace(/\s+/g,'');
    const direct = PROFESION_CANON_DIRECT[base] ?? PROFESION_CANON_DIRECT[compact];
    if(direct) return direct;
    if(!allowHeuristics) return null;
    for(const rule of PROFESION_CANON_HEURISTICS){
      if(rule.re.test(base)) return rule.value;
    }
    return null;
  }

  // Conversi√≥n aproximada de mmol/L a mg/dL para algunos analitos comunes
  function _convertIfMmol(label, value, originalText){
    // Detecta si en el contexto cercano aparece 'mmol' y no 'mg'
    if(value==null) return value;
    const txt = originalText || '';
    // ventana: 40 caracteres alrededor del n√∫mero (simple)
    // si el bloque contiene 'mmol' y no contiene 'mg/dl' asumimos mmol/L
    const mmol = /mmol/i.test(txt);
    const hasMg = /mg\s*\/\s*d?l/i.test(txt);
    if(!mmol || hasMg) return value; // ya est√° en mg/dL o no hay marca mmol
    // factores (mg/dL = mmol/L * factor)
    const FACTORS = { glicemia:18, glic:18, glucosa:18, hba1c:1, ldl:38.67, hdl:38.67, col:38.67, col_total:38.67, trigliceridos:88.5, tag:88.5 };
    const f = FACTORS[label];
    if(!f) return value; // sin factor definido
    return +(value * f).toFixed(1);
  }

  function _cleanNombre(n){
    if(!n) return '';
    // remueve alias iniciales: "(Patricio) Patricio Pino Reyes" -> "Patricio Pino Reyes"
    return String(n).replace(/^\([^)]*\)\s*/,'').replace(/\s{2,}/g,' ').trim();
  }

  function _pick(text, rx, idx=1){ const m = text.match(rx); return m? m[idx] : null; }

  function parseClinicalFreeText(text){
    const t = String(text||'');
    const out = {};
    const sections = _extractSections(t);
    if(Object.keys(sections).length){
      const anamCanon = normalizeProfesionValue(sections.enfermedad_actual, { allowHeuristics: false });
      if(anamCanon) sections.enfermedad_actual = anamCanon;
      out.mandrake_sections = sections;
    }

    // RUN
    const rutRaw = _pick(t, RX.rut);
    if(rutRaw){
      const compact = _sanitizeRun(rutRaw);
      if(/^\d{7,9}[0-9K]$/i.test(compact)){
        out.run = compact.slice(0, -1) + '-' + compact.slice(-1);
      }else{
        // si no calza, al menos guarda compactado sin gui√≥n
        out.run = compact;
      }
    }

    // Nombre
    const nombre = _cleanNombre(_pick(t, RX.nombre));
    if(nombre) out.nombre = nombre;

    // Edad
    const em = t.match(RX.edad_det);
    if(em){
      const a = _num(em[1]), me = _num(em[2]), d = _num(em[3]);
      // si no hay fecha de nacimiento, al menos setear edad num√©rica
      if(a!=null) out.edad = String(a);
      const det = {};
      if(a!=null) det.years = a;
      if(me!=null) det.months = me;
      if(d!=null) det.days = d;
      if(Object.keys(det).length) out.edad_detallada = det;
    }

    // Fecha/Hora de atenci√≥n
    const fhm = t.match(RX.fecha_hora);
    if(fhm){
      const fISO = _toISO(fhm[1]);
      if(fISO) out.fecha_atencion = fISO;
      out.hora_atencion = fhm[2];
    }

    let funcionario = _pick(t, RX.funcionario);
    if(!funcionario) funcionario = _pickLineOrNext(t, /Funcionario(?:\(s\)|\s*\(s\)\s*prestador\(es\))?/i);
    if(funcionario){
      const cleanedFuncionario = funcionario.replace(/\s{2,}/g,' ').trim();
  const profGuess = cleanedFuncionario.match(/\b(M[e√©]dico(?:a)?|Enfermer[oa](?:\(a\))?|Kinesi[o√≥]log[oa]|Nutricionist[ao]|Trabajador(?:a)?\s+Social|Asistente\s+Social|Psic[o√≥]log[oa]|Matron[ao]|Fonoaudi[o√≥]log[oa]|TENS?|Tec\.\s*Enf\.?|Qu[i√≠]mico\s+Farmac[e√©]utico|Politac[oa]|VDI|Visita(?:\s+Domiciliaria(?:\s+Integral)?)?|Dr\.?|Dra\.?)\b/i);
      if(profGuess){
        const rawProf = profGuess[0].replace(/\s+/g,' ').trim();
        const canonProf = normalizeProfesionValue(rawProf) || rawProf;
        if(!out.profesion) out.profesion = canonProf;
        const nameOnly = cleanedFuncionario.replace(profGuess[0], '').trim().replace(/[,-]$/, '').trim();
        out.funcionario = nameOnly || cleanedFuncionario;
      } else {
        out.funcionario = cleanedFuncionario;
      }
    }

    let profesion = _pick(t, RX.profesion);
    if(!profesion) profesion = _pickLineOrNext(t, /Profes[i√≠]o[nm]/i);
    if(profesion) out.profesion = (out.profesion || profesion.trim());

    if(out.profesion){
      const profCanon = normalizeProfesionValue(out.profesion) || out.profesion.trim();
      out.profesion = profCanon;
    }

    let establecimiento = _pick(t, RX.establecimiento);
    if(!establecimiento) establecimiento = _pickLineOrNext(t, /Establecimiento/i);
    if(establecimiento) out.establecimiento = establecimiento.trim();

    let procedencia = _pick(t, RX.procedencia);
    if(!procedencia) procedencia = _pickLineOrNext(t, /Procedencia/i);
    if(procedencia) out.procedencia = procedencia.trim();

    let tipoConsulta = _pick(t, RX.tipo_consulta);
    if(!tipoConsulta) tipoConsulta = _pickLineOrNext(t, /Tipo\s+de\s+consulta/i);
    if(tipoConsulta) out.tipo_consulta = tipoConsulta.trim();

    // Signos vitales / antropometr√≠a
    const pa = t.match(RX.pa);
    if(pa){ out.presion_sistolica = _num(pa[1]); out.presion_diastolica = _num(pa[2]); }
    const pulso = _pick(t, RX.pulso);
    if(pulso) out.pulso = _num(pulso);
    const hgt = _pick(t, RX.hgt);
    if(hgt) out.hgt = _num(hgt);
    const peso = _pick(t, RX.peso);
    if(peso!=null) out.peso = _num(peso);
    const talla = _pick(t, RX.talla);
    if(talla!=null) out.talla = _num(talla);
    const imc = _pick(t, RX.imc);
    if(imc!=null) out.imc = _num(imc);
    const cc = _pick(t, RX.cc);
    if(cc!=null) out.cc = _num(cc);

    // Labs ampliados
  const hba = _pick(t, RX.hba1c); if(hba!=null) out.hba1c = _convertIfMmol('hba1c', _num(hba), hba);
  const ldl = _pick(t, RX.ldl); if(ldl!=null) out.ldl = _convertIfMmol('ldl', _num(ldl), ldl);
  const glic = _pick(t, RX.glicemia); if(glic!=null) out.glicemia = _convertIfMmol('glicemia', _num(glic), glic);
  const hdl = _pick(t, RX.hdl); if(hdl!=null) out.hdl = _convertIfMmol('hdl', _num(hdl), hdl);
  const col = _pick(t, RX.col_total); if(col!=null) out.col = _convertIfMmol('col', _num(col), col);
  const tag = _pick(t, RX.trigliceridos); if(tag!=null) out.tag = _convertIfMmol('tag', _num(tag), tag);
  const crea = _pick(t, RX.creatinina); if(crea!=null) out.creatinemia = _num(crea);
  const sodio = _pick(t, RX.sodio); if(sodio!=null) out.sodio = _num(sodio);
  const potasio = _pick(t, RX.potasio); if(potasio!=null) out.potasio = _num(potasio);
  const cloro = _pick(t, RX.cloro); if(cloro!=null) out.cloro = _num(cloro);
  const uremia = _pick(t, RX.uremia); if(uremia!=null) out.uremia = _num(uremia);
  const bun = _pick(t, RX.bun); if(bun!=null) out.nitrogeno_ureico = _num(bun);
  const hematocrito = _pick(t, RX.hematocrito); if(hematocrito!=null) out.hematocrito = _num(hematocrito);
  const hemoglobina = _pick(t, RX.hemoglobina); if(hemoglobina!=null) out.hemoglobina = _num(hemoglobina);
  const leucocitos = _pick(t, RX.leucocitos); if(leucocitos!=null) out.leucocitos = _num(leucocitos);
  const plaquetas = _pick(t, RX.plaquetas); if(plaquetas!=null) out.plaquetas = _num(plaquetas);
  const vcm = _pick(t, RX.vcm); if(vcm!=null) out.vcm = _num(vcm);
  const hcm = _pick(t, RX.hcm); if(hcm!=null) out.hcm = _num(hcm);
  const vfg = _pick(t, RX.vfg); if(vfg!=null) out.vfg = _num(vfg);
  const rac = _pick(t, RX.rac); if(rac!=null) out.rac = _num(rac);
  const micro = _pick(t, RX.microalbuminuria); if(micro!=null) out.microalbuminuria_val = _num(micro);
  const creatiUr = _pick(t, RX.creatininuria); if(creatiUr!=null) out.creatininuria = _num(creatiUr);
  const tsh = _pick(t, RX.tsh); if(tsh!=null) out.tsh = _num(tsh);

  const fallbackLabRegex = /(?:^|[\n\r])\s*([A-Z√Å√â√ç√ì√ö√ë√úa-z√°√©√≠√≥√∫√±√º0-9\/().%¬∞ -]{3,60}?)(?:\s*(?:=|:)\s*|\s+)([-+]?\d+(?:[.,]\d+)?)/g;
  const fallbackSeen = new Set();
  let fallbackMatch;
  while((fallbackMatch = fallbackLabRegex.exec(t))){
    const labelCandidate = (fallbackMatch[1] || '').trim();
    const canonical = _normalizeExamLabel(labelCandidate);
    if(!canonical) continue;
    const fieldKey = EXAM_FIELD_MAP[canonical];
    if(!fieldKey || fallbackSeen.has(fieldKey) || out[fieldKey]!=null) continue;
    const value = _num(fallbackMatch[2]);
    if(value==null) continue;
    const originalChunk = fallbackMatch[0] || '';
    out[fieldKey] = _convertIfMmol(fieldKey, value, originalChunk);
    fallbackSeen.add(fieldKey);
  }
    const fex = _pick(t, RX.fecha_examen); if(fex){ const isoF = _toISO(fex); if(isoF) out.examen_fecha = isoF; }
    if(!out.examen_fecha && out.fecha_atencion){ out.examen_fecha = out.fecha_atencion; }

    // Construir labs[] si hay al menos un valor
    const labFields = [
      'glicemia','hba1c','ldl','hdl','col','tag','creatinemia',
      'sodio','potasio','cloro','uremia','nitrogeno_ureico','vfg','rac',
      'microalbuminuria_val','tsh','hematocrito','hemoglobina','leucocitos',
      'plaquetas','vcm','hcm','creatininuria'
    ];
    const hasLab = labFields.some(k=> out[k]!=null);
    if(hasLab){
      const labObj = { examen_fecha: out.examen_fecha };
      labFields.forEach(k=>{ if(out[k]!=null) labObj[k]=out[k]; });
      out.labs = [labObj];
    }

    // Diagn√≥sticos (lista textual)
    const db = t.match(RX.diagBlock);
    if(db){
      const raw = db[1] || '';
      const normalizedRaw = raw
        .replace(/\)\s+(?=[A-Z√Å√â√ç√ì√ö√ë])/g, ')\n')
        .replace(/\b(Repetida|Confirmada|Sospecha|Nueva)\)\s+(?=[A-Z√Å√â√ç√ì√ö√ë])/gi, '$1)\n');
      const lines = normalizedRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const dx = [];
      const dxDet = [];
      for(const ln of lines){
        if(!ln) continue;
        const cleaned = ln
          .replace(/\(?(Confirmada|Repetida|Nueva|Sospecha|AUGE|GES|Cr[o√≥]nica|Aguda|Control)\)?/ig,'')
          .replace(/\s{2,}/g,' ')
          .replace(/^[\-\d\.\)]\s*/,'')
          .trim();
        if(!cleaned) continue;
        const detalle = { descripcion: cleaned };
        const codeMatch = ln.match(/\b([A-TV-Z][0-9]{2}(?:\.[0-9A-Z]{1,2})?)\b/);
        if(codeMatch) detalle.codigo = codeMatch[1].toUpperCase();
        const estadoMatch = ln.match(/\b(Confirmada|Sospecha|Repetida|Nueva|Control|Cr[o√≥]nica|Aguda|GES|AUGE)\b/i);
        if(estadoMatch) detalle.estado = estadoMatch[1];
        dxDet.push(detalle);

        const fragments = cleaned.split(/\s{2,}(?=[A-Z√Å√â√ç√ì√ö√ë])/).map(f=>f.trim()).filter(Boolean);
        if(fragments.length){
          fragments.forEach(fragment=>{ if(!dx.includes(fragment)) dx.push(fragment); });
        } else if(!dx.includes(cleaned)){
          dx.push(cleaned);
        }
      }
      if(dx.length) out.diagnosticos = dx;
      if(dxDet.some(item => item.codigo || item.descripcion)) out.diagnosticos_detallados = dxDet;
    }

    if(sections.actividades_programadas){
      const acts = _splitListBlock(sections.actividades_programadas);
      if(acts.length) out.actividades_programadas = acts;
    }

    if(sections.formularios_realizados){
      const forms = _splitListBlock(sections.formularios_realizados);
      if(forms.length) out.formularios_realizados = forms;
    }

    if(!out.empam && sections.empam){
      const empamParsed = _parseEmpamBlock(sections.empam);
      if(empamParsed) out.empam = empamParsed;
    }

    if(!out.empam && sections.funcionalidad && /\b(EFAM|EMPAM)\b/i.test(sections.funcionalidad)){
      const empamAlt = _parseEmpamBlock(sections.funcionalidad);
      if(empamAlt) out.empam = empamAlt;
    }

    // Campos del front que probablemente quieres llenar HOY
    // (ajusta a tus IDs/FIELD_MAP reales)
    const payload = {
      run: out.run,
      nombre: out.nombre,
      // fecha_nacimiento: (no viene en el texto; la edad ya va calculada arriba si aparece DOB)
      edad: (out.edad!=null ? String(out.edad) : undefined),
      edad_detallada: out.edad_detallada,

      // vitals / control
      presion_sistolica: out.presion_sistolica,
      presion_diastolica: out.presion_diastolica,
      hgt: out.hgt,
      peso: out.peso,
      talla: out.talla != null ? (out.talla / 100).toFixed(2) : undefined, // convertir cm a metros
      imc: out.imc,
      cc: out.cc,
      hba1c: out.hba1c,
      ldl: out.ldl,
      glicemia: out.glicemia,
      hdl: out.hdl,
      col: out.col,
      tag: out.tag,
      creatinemia: out.creatinemia,
      vfg: out.vfg,
      rac: out.rac,
      microalbuminuria_val: out.microalbuminuria_val,
      tsh: out.tsh,
  sodio: out.sodio,
  potasio: out.potasio,
  cloro: out.cloro,
  uremia: out.uremia,
  nitrogeno_ureico: out.nitrogeno_ureico,
  creatininuria: out.creatininuria,
  hematocrito: out.hematocrito,
  hemoglobina: out.hemoglobina,
  leucocitos: out.leucocitos,
  plaquetas: out.plaquetas,
  vcm: out.vcm,
  hcm: out.hcm,
      examen_fecha: out.examen_fecha,

      labs: out.labs,

      // metadatos √∫tiles
      fecha_atencion: out.fecha_atencion,
      hora_atencion: out.hora_atencion,
      funcionario: out.funcionario,
      profesion: out.profesion,
      establecimiento: out.establecimiento,
      procedencia: out.procedencia,
      tipo_consulta: out.tipo_consulta,
      diagnosticos: out.diagnosticos,
      diagnosticos_detallados: out.diagnosticos_detallados,
      actividades_programadas: out.actividades_programadas,
      formularios_realizados: out.formularios_realizados,
      atencion_familiar: sections.atencion_familiar,
      empam: out.empam
    };

    if(out.mandrake_sections) payload.mandrake_sections = out.mandrake_sections;

    const mandrakeMeta = {
      fecha_atencion: out.fecha_atencion,
      hora_atencion: out.hora_atencion,
      funcionario: out.funcionario,
      profesion: out.profesion,
      establecimiento: out.establecimiento,
      procedencia: out.procedencia,
      tipo_consulta: out.tipo_consulta,
      edad_detallada: out.edad_detallada
    };
    Object.keys(mandrakeMeta).forEach(k=> (mandrakeMeta[k]==null || mandrakeMeta[k]==='') && delete mandrakeMeta[k]);
    if(Object.keys(mandrakeMeta).length) payload.mandrake_meta = mandrakeMeta;

    // elimina undefined para no contaminar la aplicaci√≥n
    Object.keys(payload).forEach(k=> (payload[k]===undefined || payload[k]===null) && delete payload[k]);
    return payload;
  }

  // ============ Integraci√≥n con Mandrake ============
  // Requiere que Mandrake.apply ya est√© cargado en la p√°gina
  async function pegarYAutollenarDesdeTexto(texto, {overwrite=false} = {}){
    const parsed = parseClinicalFreeText(texto);
    // Mapea a tus inputs. Si ya definiste FIELD_MAP, esto bastar√°:
    if(window.Mandrake && typeof window.Mandrake.apply === 'function'){
      window.Mandrake.apply(parsed, {overwrite});
    }
    return parsed;
  }

  // ============ API global ============
  window.MandrakePaste = {
    parse: parseClinicalFreeText,
    applyFromText: pegarYAutollenarDesdeTexto
  };

  // (opcional) bot√≥n que pide pegar desde el portapapeles
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btn-pegar-texto-clinico');
    if(btn && navigator.clipboard){
      btn.addEventListener('click', async ()=>{
        try{
          const txt = await navigator.clipboard.readText();
          const out = await pegarYAutollenarDesdeTexto(txt, {overwrite:false});
          console.log('[MandrakePaste] parsed:', out);
          alert('Texto pegado y aplicado al formulario ‚úÖ');
        }catch(e){
          console.warn('No se pudo leer portapapeles:', e);
          alert('No pude leer el portapapeles. Pega el texto manualmente en un cuadro y te lo proceso.');
        }
      });
    }
  });
})();
</script>

<!-- Parser duplicado removido: unificado al MandrakePaste principal -->

<script>
(function(){
  const LOG_PREFIX = 'üß™ [SmartLabs]';

  const normalizeText = (value) => String(value || '')
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase();

  const num = (raw) => {
    if(raw == null) return null;
    let txt = String(raw).trim();
    if(!txt) return null;
    txt = txt.replace(/\s+/g,'');
    const thousandLike = txt.match(/^(\d{1,3})(?:\.(\d{3}))+$/);
    if(thousandLike){
      txt = txt.replace(/\./g,'');
    }
    txt = txt.replace(/,/g,'.');
    const parsed = parseFloat(txt);
    return Number.isFinite(parsed) ? parsed : null;
  };

  const CANON_INPUT = {
    glicemia: 'glicemia',
    hba1c: 'hba1c',
    ldl: 'ldl',
    hdl: 'hdl',
    col: 'col',
    tag: 'tag',
    creatininemia: 'creatinemia',
    vfg: 'vfg',
    rac: 'rac',
    microalbuminuria_val: 'microalbuminuria_val',
    tsh: 'tsh'
  };

  const FIELD_BY_CANON = {
    glicemia: 'glicemia',
    hba1c: 'hba1c',
    ldl: 'ldl',
    hdl: 'hdl',
    col: 'col',
    tag: 'tag',
    creatininemia: 'creatinemia',
    vfg: 'vfg',
    rac: 'rac',
    microalbuminuria_val: 'microalbuminuria_val',
    tsh: 'tsh'
  };

  const CANON_LABEL = {
    glicemia: 'Glicemia',
    hba1c: 'HbA1c',
    ldl: 'LDL',
    hdl: 'HDL',
    col: 'Colesterol Total',
    tag: 'Triglic√©ridos',
    creatininemia: 'Creatininemia',
    vfg: 'VFG',
    rac: 'RAC',
    microalbuminuria_val: 'Microalbuminuria',
    tsh: 'TSH',
    uremia: 'Uremia'
  };

  const NORM = {
    'glicemia': 'glicemia', 'glucosa': 'glicemia', 'hgt': 'glicemia',
    'hba1c': 'hba1c', 'hb a1c': 'hba1c', 'hb a1 c': 'hba1c', 'hemoglobina glicosilada': 'hba1c', 'hemoglobina glicada': 'hba1c', 'hb glico': 'hba1c', 'hb clico': 'hba1c',
    'ldl': 'ldl', 'colesterol ldl': 'ldl', 'col ldl': 'ldl',
    'hdl': 'hdl', 'colesterol hdl': 'hdl', 'col hdl': 'hdl',
    'colesterol total': 'col', 'col total': 'col', 'col': 'col',
    'tag': 'tag', 'trigliceridos': 'tag', 'triglic√©ridos': 'tag', 'tg': 'tag',
    'creatinina': 'creatinemia', 'crea': 'creatinemia', 'creat': 'creatinemia', 'creatinemia': 'creatinemia', 'creatininemia': 'creatinemia',
    'vfg': 'vfg', 'tfg': 'vfg', 'filtracion glomerular': 'vfg', 'filtraci√≥n glomerular': 'vfg', 'egfr': 'vfg',
    'rac': 'rac', 'mau/crea': 'rac', 'indice mau/crea': 'rac', 'indice mau/creau': 'rac', 'microalb/crea': 'rac', 'uacr': 'rac', 'acr': 'rac', 'razon albumina creatinina': 'rac', 'albumina/creatinina': 'rac',
    'microalbuminuria': 'microalbuminuria_val', 'micro alb': 'microalbuminuria_val', 'microalb': 'microalbuminuria_val', 'microalbumina': 'microalbuminuria_val',
  'tsh': 'tsh',
  'uremia': 'uremia', 'bun': 'uremia', 'nitrogeno ureico': 'uremia', 'nitr√≥geno ureico': 'uremia'
  };

  const PATS = {
    glicemia: /(glicemia|glucosa|hgt)[^0-9]{0,12}(-?\d+[.,]?\d*)/i,
    hba1c: /(hba1c|hb\s*a1c|hemoglobina\s+glic(?:o|√≥)silada|hb\s*glic(?:o|√≥))(?:[^0-9]{0,12}|[:\s]*)(-?\d+[.,]?\d*)/i,
    ldl: /(ldl|colesterol\s*ldl)[^0-9]{0,12}(-?\d+[.,]?\d*)/i,
    hdl: /(hdl|colesterol\s*hdl)[^0-9]{0,12}(-?\d+[.,]?\d*)/i,
    col: /(col(?:esterol)?\s*(?:total)?|col\s*total)[^0-9]{0,12}(-?\d+[.,]?\d*)/i,
    tag: /(tg|tag|trigliceridos|triglic[e√©]ridos)[^0-9]{0,12}(-?\d+[.,]?\d*)/i,
    creatininemia: /(creatinina|crea(?:t)?|creatinemia)[^0-9]{0,12}(-?\d+[.,]?\d*)/i,
    vfg: /(vfg|tfg|e?gfr|filtraci[o√≥]n?\s+glomerular)[^0-9]{0,16}(-?\d+[.,]?\d*)/i,
    rac: /(rac|mau\/crea(?:u)?|uacr|acr|[√≠i]ndice\s*mau\/crea(?:u)?|raz[o√≥]n\s+albu(?:mina|)\s*creatinina)[^0-9]{0,18}(-?\d+[.,]?\d*)/i,
    microalbuminuria_val: /(micro\s*alb(?:uminuria)?|microalbuminuria)[^0-9]{0,16}(-?\d+[.,]?\d*)/i,
    tsh: /(tsh)[^0-9]{0,12}(-?\d+[.,]?\d*)/i,
    uremia: /(uremia|bun|nitr[o√≥]geno\s*ureico)[^0-9]{0,12}(-?\d+[.,]?\d*)/i
  };

  const FALLBACK_KEYS = Object.keys(NORM).sort((a,b)=>b.length-a.length);

  function parseFechaFlexible(s){
    if(!s) return null;
    const txt = normalizeText(s);
    const MES = {
      ene:1, enero:1, feb:2, febrero:2, mar:3, marzo:3, abr:4, abril:4, may:5, mayo:5,
      jun:6, junio:6, jul:7, julio:7, ago:8, agosto:8, sep:9, set:9, septiembre:9,
      oct:10, octubre:10, nov:11, noviembre:11, dic:12, diciembre:12
    };
    const fixYY = (yy) => {
      const n = parseInt(yy,10);
      return n <= 79 ? 2000 + n : 1900 + n;
    };
    const pad2 = (n) => String(n).padStart(2,'0');

    let m = txt.match(/\b(\d{1,2})[\/-\.](\d{1,2})[\/-\.](\d{2,4})\b/);
    if(m){
      let [, d, mm, yy] = m;
      const Y = yy.length === 2 ? fixYY(yy) : parseInt(yy,10);
      const M = Math.max(1, Math.min(12, parseInt(mm,10)));
      const D = Math.max(1, Math.min(31, parseInt(d,10)));
      return `${Y}-${pad2(M)}-${pad2(D)}`;
    }

    m = txt.match(/\b(\d{1,2})\s*(?:de)?\s*(enero|ene|febrero|feb|marzo|mar|abril|abr|mayo|may|junio|jun|julio|jul|agosto|ago|septiembre|sep|set|octubre|oct|noviembre|nov|diciembre|dic)\s*(?:de)?\s*(\d{2,4})\b/);
    if(m){
      let [, d, mesTxt, yy] = m;
      const M = MES[mesTxt] || 1;
      const Y = yy.length === 2 ? fixYY(yy) : parseInt(yy,10);
      const D = Math.max(1, Math.min(31, parseInt(d,10)));
      return `${Y}-${pad2(M)}-${pad2(D)}`;
    }

    m = txt.match(/\b(enero|ene|febrero|feb|marzo|mar|abril|abr|mayo|may|junio|jun|julio|jul|agosto|ago|septiembre|sep|set|octubre|oct|noviembre|nov|diciembre|dic)[\s\/\-.]+(\d{2,4})\b/);
    if(m){
      let [, mesTxt, yy] = m;
      const M = MES[mesTxt] || 1;
      const Y = yy.length === 2 ? fixYY(yy) : parseInt(yy,10);
      return `${Y}-${pad2(M)}-01`;
    }

    m = txt.match(/\b(\d{1,2})[\/-\.](\d{2,4})\b/);
    if(m){
      let [, mm, yy] = m;
      const M = Math.max(1, Math.min(12, parseInt(mm,10)));
      const Y = yy.length === 2 ? fixYY(yy) : parseInt(yy,10);
      return `${Y}-${pad2(M)}-01`;
    }

    return null;
  }

  function splitByFechas(text){
    const lines = String(text || '').split(/\n+/);
    const out = [];
    let currentDate = null;
    let buffer = [];

    const push = () => {
      if(buffer.length){
        out.push({ fechaISO: currentDate, chunk: buffer.join('\n').trim() });
        buffer = [];
      }
    };

    for(const line of lines){
      const detected = parseFechaFlexible(line);
      if(detected){
        push();
        currentDate = detected;
      }
      buffer.push(line);
    }
    push();
    return out;
  }

  function parseLabs(text){
    const blocks = splitByFechas(text);
    const rows = [];

    for(const { fechaISO, chunk } of blocks){
      const sane = normalizeText(chunk);

      for(const [canon, rx] of Object.entries(PATS)){
        const match = sane.match(rx);
        if(!match) continue;
        const value = num(match[match.length - 1]);
        if(Number.isFinite(value)){
          rows.push({ canon, val: value, fechaISO });
        }
      }

      const sentences = sane.split(/[\n.;]+/);
      for(const sentence of sentences){
        const trimmed = sentence.trim();
        if(!trimmed) continue;
        for(const key of FALLBACK_KEYS){
          if(!trimmed.includes(key)) continue;
          const canon = NORM[key];
          if(!canon) continue;
          const fieldName = FIELD_BY_CANON[canon];
          const fallbackMatch = trimmed.match(/(-?\d+[.,]?\d*)/);
          if(!fallbackMatch) continue;
          const value = num(fallbackMatch[1]);
          if(Number.isFinite(value)){
            rows.push({ canon, val: value, fechaISO, field: fieldName });
          }
        }
      }
    }

    return rows;
  }

  function applyLabsToFormFromRows(rows){
    const form = document.getElementById('form-lab-nuevo');
    if(!form) return [];
    const latestByCanon = new Map();

    rows.forEach((row, idx) => {
      if(!row) return;
      const field = FIELD_BY_CANON[row.canon];
      if(!field) return;
      const ts = row.fechaISO ? Date.parse(row.fechaISO) : NaN;
      const weight = Number.isFinite(ts) ? ts : null;
      const current = latestByCanon.get(row.canon);
      if(!current){
        latestByCanon.set(row.canon, { val: row.val, ts: weight, idx });
        return;
      }
      if(weight != null){
        if(current.ts == null || weight > current.ts || (weight === current.ts && idx > current.idx)){
          latestByCanon.set(row.canon, { val: row.val, ts: weight, idx });
        }
      } else if(current.ts == null && idx > current.idx){
        latestByCanon.set(row.canon, { val: row.val, ts: current.ts, idx });
      }
    });

    const assigned = [];
    for(const [canon, data] of latestByCanon.entries()){
      const field = FIELD_BY_CANON[canon];
      if(!field) continue;
      const input = form.querySelector(`[name="${field}"]`);
      if(!input) continue;
      input.value = String(data.val);
      assigned.push(`${CANON_LABEL[canon] || canon}=${data.val}`);
    }
    return assigned;
  }

  function renderMiniTablaFromRows(rows){
    const table = document.getElementById('tabla-labs');
    if(!table) return;
    const tbody = table.querySelector('tbody');
    if(!tbody) return;
    tbody.querySelectorAll('tr[data-source="smart-labs"]').forEach((row)=>row.remove());
    if(!rows.length){
      return;
    }
    const today = new Date().toISOString().slice(0,10);
    rows.forEach(({ canon, val, fechaISO }) => {
      const tr = document.createElement('tr');
      tr.setAttribute('data-source','smart-labs');
      tr.innerHTML = `
        <td style="padding:4px 8px;">${CANON_LABEL[canon] || canon}</td>
        <td style="padding:4px 8px;">${val}</td>
        <td style="padding:4px 8px;">${fechaISO || today}</td>
        <td style="padding:4px 8px;color:#64748b;font-size:.62rem;">Autodetectado</td>`;
      tbody.prepend(tr);
    });
    table.style.display = 'table';
  }

  function detectLabsFromText(text){
    const rows = parseLabs(text);
    const asignados = applyLabsToFormFromRows(rows);
    renderMiniTablaFromRows(rows);
    const labs = {};
    rows.forEach(({ canon, val }) => {
      if(!(canon in labs)){
        labs[canon] = val;
      }
    });
    return { rows, labs, asignados };
  }

  const statusEl = document.getElementById('detectar-labs-estado');
  const detectBtn = document.getElementById('detectar-labs-btn');
  detectBtn?.addEventListener('click', () => {
    const raw = document.getElementById('raw-labs-text')?.value || '';
    const { asignados, rows } = detectLabsFromText(raw);
    if(statusEl){
      if(asignados.length){
        statusEl.textContent = `Detectados y asignados: ${asignados.join(', ')}`;
        statusEl.style.color = '#065f46';
      }else{
        statusEl.textContent = 'No se detectaron ex√°menes en el texto.';
        statusEl.style.color = '#b91c1c';
      }
    }
    console.log(LOG_PREFIX, 'Filas detectadas', rows);
  });

  const chatInput = document.getElementById('mandrake-chat-input');
  const chatSend = document.getElementById('mandrake-chat-send');
  const chatMessages = document.getElementById('mandrake-chat-messages');

  const addChatMessage = (content, type = 'bot') => {
    if(!chatMessages) return;
    const div = document.createElement('div');
    div.className = `mandrake-message ${type}`;
    div.textContent = content;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  };

  const handleLabsCommand = (commandText) => {
    const payload = commandText.replace(/^\/labs\s*/i,'').trim();
    if(!payload){
      addChatMessage('Env√≠a `/labs` seguido del texto cl√≠nico para analizar.', 'bot');
      return;
    }
    addChatMessage(payload, 'user');
    const { rows } = detectLabsFromText(payload);
    if(rows.length){
      const resumen = rows.map(r => `${CANON_LABEL[r.canon] || r.canon}=${r.val}`).join(', ');
      addChatMessage(`üß™ Detect√© ${rows.length} resultados (fechas flexibles OK): ${resumen}`, 'bot');
    }else{
      addChatMessage('No detect√© ex√°menes en el texto.', 'bot');
    }
  };

  chatSend?.addEventListener('click', (ev) => {
    const value = chatInput?.value?.trim() || '';
    if(/^\/labs\b/i.test(value)){
      ev.preventDefault();
      ev.stopImmediatePropagation?.();
      chatInput.value = '';
      handleLabsCommand(value);
    }
  }, true);

  chatInput?.addEventListener('keydown', (ev) => {
    if(ev.key === 'Enter' && !ev.shiftKey){
      const value = chatInput.value.trim();
      if(/^\/labs\b/i.test(value)){
        ev.preventDefault();
        chatInput.value = '';
        handleLabsCommand(value);
      }
    }
  });

  window.SmartLabs = {
    parse: parseLabs,
    detectText: detectLabsFromText,
    parseFechaFlexible,
    splitByFechas
  };

  console.log(LOG_PREFIX, 'Inicializado');
})();
</script>

<script>
// === Bot√≥n Guardar Todo (control + labs + acuerdos si hay datos) ===
(()=>{
  if (window.__tarjetonSaveAllInit || window.__tarjetonSaveAllDisabled) {
    return;
  }
  window.__tarjetonSaveAllInit = true;

  const btn = document.getElementById('btn-save-all');
  if (!btn) {
    return;
  }
  if (btn.dataset.saveAllBound === 'true') {
    return;
  }
  btn.dataset.saveAllBound = 'true';

  btn.addEventListener('click', async () => {
    if (btn.disabled) {
      return;
    }

    const original = btn.innerHTML;
    const runElement = document.getElementById('run');
    const runRaw = runElement?.value?.trim();
    if (!runRaw) {
      alert('RUN vac√≠o. Busca un usuario primero.');
      return;
    }

    const runCanon = typeof formatearRunParaEnvio === 'function'
      ? (formatearRunParaEnvio(runRaw) || runRaw)
      : runRaw;

    btn.disabled = true;
    btn.innerHTML = 'üíæ Guardando...';

    const tareas = [];
    const pushTask = (label, promise) => {
      tareas.push(
        promise.then(async (res) => {
          const contentType = res.headers?.get('Content-Type') || '';
          let data = null;
          if (contentType.includes('application/json')) {
            try {
              data = await res.json();
            } catch (jsonErr) {
              console.warn(`[Guardar todo] ${label}: respuesta JSON inv√°lida`, jsonErr);
            }
          }
          return { label, res, data };
        }).catch((error) => {
          throw { label, error };
        })
      );
    };

    const cleanValue = (value) => {
      if (value === undefined || value === null) {
        return null;
      }
      const str = value.toString().trim();
      return str === '' ? null : str;
    };

    const programaObjetivo = (window.PROGRAMA_MODO_ECICEP || 'ECICEP').toString().trim() || 'ECICEP';
    let programaForzadoOk = false;
    if (runCanon && programaObjetivo) {
      try {
        console.log(`[Guardar todo] Asegurando programa ${programaObjetivo} antes de guardar identificaci√≥n`);
        const respProg = await authFetch(`/api/usuarios/${encodeURIComponent(runCanon)}/programa_modo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ programa: programaObjetivo })
        });
        if (!respProg.ok) {
          const dataProg = await respProg.json().catch(() => ({}));
          console.warn('[Guardar todo] No se pudo fijar programa antes del guardado', dataProg || respProg.status);
        } else {
          programaForzadoOk = true;
        }
      } catch (progError) {
        console.warn('[Guardar todo] Error forzando programa antes del guardado', progError);
      }
    }

    // --- Control ---
    try {
      const payloadControl = buildControlPayload(runCanon);
      if (payloadControl) {
        pushTask('control', fetch('/api/control/fast-save', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payloadControl)
        }));
      }
    } catch (controlErr) {
      console.error('Control no guardado', controlErr);
    }

    // --- Labs ---
    try {
      const lf = document.getElementById('form-lab-nuevo');
      if (lf) {
        const fd = new FormData(lf);
        const payloadLab = {
          run: (window._runActivo || runCanon || (fd.get('run') || '')).toString().trim()
        };

        [
          'examen_fecha',
          'creatinemia',
          'clearence_creatinina',
          'col_total',
          'col_hdl',
          'col_hdl_porcentaje',
          'col_no_hdl',
          'col_ldl',
          'col_ldl_porcentaje',
          'col_vldl',
          'col_vldl_porcentaje',
          'glicemia',
          'glicemia_post',
          'glicemia_hb',
          'hba1c',
          'hemoglobina',
          'hematocrito',
          'indice_aterogenico',
          'indice_aterogenico_no_hdl',
          'insulina',
          'microalbuminuria',
          'peso',
          'talla',
          'trigliceridos',
          'tsh',
          'tgo',
          'tgp',
          'uricemia',
          'urea',
          'magnesio',
          'cloro',
          'potasio',
          'sodio',
          'otros',
          'observaciones'
        ].forEach((field) => {
          const value = cleanValue(fd.get(field));
          if (value !== null) {
            payloadLab[field] = value;
          }
        });

        const hasRelevantFields = Object.keys(payloadLab).some((key) => {
          if (key === 'run') {
            return false;
          }
          if (key === 'examen_fecha') {
            return Boolean(payloadLab.examen_fecha);
          }
          return payloadLab[key] !== undefined && payloadLab[key] !== null && payloadLab[key] !== '';
        });

        if (hasRelevantFields && payloadLab.run) {
          pushTask('labs', fetch('/api/labs/fast-save', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payloadLab)
          }));
        }
      }
    } catch (labsErr) {
      console.error('Laboratorios no guardados', labsErr);
    }

    // --- Acuerdos ---
    try {
      const acuerdoForm = document.getElementById('form-nuevo-acuerdo');
      if (acuerdoForm) {
        const fdAcuerdo = new FormData(acuerdoForm);
        const acuerdosPayload = {
          run: runCanon,
          acuerdo_fecha: cleanValue(fdAcuerdo.get('fecha')),
          acuerdo_motivo: cleanValue(fdAcuerdo.get('motivo')),
          acuerdo_observacion: cleanValue(fdAcuerdo.get('observacion')),
          acuerdo_tipo: cleanValue(fdAcuerdo.get('tipo'))
        };

        const acuerdosTieneDatos = Object.keys(acuerdosPayload).some((key) => key !== 'run' && acuerdosPayload[key]);
        if (acuerdosPayload.run && acuerdosTieneDatos) {
          pushTask('acuerdo', fetch('/api/acuerdos/registrar', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(acuerdosPayload)
          }));
        }
      }
    } catch (acuerdoErr) {
      console.error('Acuerdos no guardados', acuerdoErr);
    }

    try {
      if (tareas.length === 0) {
        alert('No hay datos para guardar.');
        return;
      }

      const results = await Promise.allSettled(tareas);
      const errores = results.filter((r) => r.status === 'rejected');
      if (errores.length > 0) {
        console.warn('[Guardar todo] Algunas tareas fallaron', errores);
        alert('Guardado parcial con errores, revisa la consola.');
      } else {
        alert('Guardado exitoso ‚úîÔ∏è');
        if (!programaForzadoOk && programaObjetivo) {
          console.warn('[Guardar todo] Programa objetivo no se pudo fijar antes del guardado');
        }
      }
    } catch (err) {
      console.error('[Guardar todo] Error agrupado', err);
      alert('Hubo un problema guardando los datos.');
    } finally {
      btn.disabled = false;
      btn.innerHTML = original;
    }
  });
})();
</script>

<script>
console.log('üìã [INIT] Cargando sistema de alertas de vigencia...');

let alertasCache = null;
let alertasReconocidas = false;

function detenerDestelloAlertas() {
  const chipV = document.getElementById('chip-alertas-vencidos');
  const chipF = document.getElementById('chip-alertas-faltantes');
  if (chipV) {
    chipV.classList.remove('blink-rojo');
  }
  if (chipF) {
    chipF.classList.remove('blink-amarillo');
  }
}

function actualizarIndicadoresAlertas(vencidos = 0, faltantes = 0, vigentes = null) {
  const chipV = document.getElementById('chip-alertas-vencidos');
  const chipF = document.getElementById('chip-alertas-faltantes');
  const chipOk = document.getElementById('chip-alertas-ok');

  if (!chipV || !chipF || !chipOk) {
    return;
  }

  const hayDatos = vigentes !== null || vencidos > 0 || faltantes > 0;
  if (!hayDatos) {
    chipV.classList.add('oculta');
    chipF.classList.add('oculta');
    chipOk.classList.add('oculta');
    return;
  }

  if (vencidos > 0) {
    chipV.classList.remove('oculta');
    const countV = chipV.querySelector('.count');
    if (countV) {
      countV.textContent = vencidos > 99 ? '99+' : vencidos;
    }
    if (!alertasReconocidas) {
      chipV.classList.add('blink-rojo');
    } else {
      chipV.classList.remove('blink-rojo');
    }
  } else {
    chipV.classList.add('oculta');
    chipV.classList.remove('blink-rojo');
  }

  if (faltantes > 0) {
    chipF.classList.remove('oculta');
    const countF = chipF.querySelector('.count');
    if (countF) {
      countF.textContent = faltantes > 99 ? '99+' : faltantes;
    }
    if (!alertasReconocidas) {
      chipF.classList.add('blink-amarillo');
    } else {
      chipF.classList.remove('blink-amarillo');
    }
  } else {
    chipF.classList.add('oculta');
    chipF.classList.remove('blink-amarillo');
  }

  if (vigentes !== null && vigentes > 0) {
    chipOk.classList.remove('oculta');
    const countOk = chipOk.querySelector('.count');
    if (countOk) {
      countOk.textContent = vigentes > 99 ? '99+' : Math.max(vigentes, 0);
    }
  } else {
    chipOk.classList.add('oculta');
  }
}

async function refrescarAlertasVigencia(run, opciones = {}) {
  try {
    if (!run) return;
    const response = await authFetch(`/api/vigencia/alertas/${encodeURIComponent(run)}`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    if (!data.success || !Array.isArray(data.alertas)) {
      console.warn('[üîî Alertas] Respuesta sin alertas v√°lidas', data);
      return;
    }

    alertasCache = data.alertas;
    const pendientes = alertasCache.filter(a => !a.vigente && a.detalle).length;
    const sinDatos = alertasCache.filter(a => !a.detalle).length;
    const vigentes = alertasCache.filter(a => a.vigente).length;
    actualizarIndicadoresAlertas(pendientes, sinDatos, vigentes);

    const modal = document.getElementById('modal-alertas-vigencia');
    if (modal && modal.style.display !== 'none') {
      renderizarAlertas(alertasCache);
    }

    if (opciones?.origen) {
      console.log(`[üîî Alertas] Refrescadas tras ${opciones.origen}`);
    }

    try {
      window.dispatchEvent(new CustomEvent('alertas:actualizadas', {
        detail: {
          run,
          origen: opciones?.origen || null,
          alertas: alertasCache
        }
      }));
    } catch (emitError) {
      console.warn('[üîî Alertas] No se pudo emitir evento alertas:actualizadas', emitError);
    }
  } catch (error) {
    console.error('[üîî Alertas] Error al refrescar alertas de vigencia:', error);
  }
}

window.refrescarAlertasVigencia = refrescarAlertasVigencia;

// Funci√≥n para mostrar modal de alertas
async function mostrarAlertasVigencia() {
  const modal = document.getElementById('modal-alertas-vigencia');
  const contenido = document.getElementById('contenido-alertas');
  
  if (!modal) {
    console.error('‚ùå Modal de alertas no encontrado');
    return;
  }

  alertasReconocidas = true;
  detenerDestelloAlertas();
  
  // Mostrar modal
  modal.style.display = 'flex';
  
  // Obtener RUN del usuario actual
  const runInput = document.getElementById('run');
  const run = runInput?.value?.trim();
  
  if (!run) {
    contenido.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:16px;">‚ö†Ô∏è</div>
        <div style="font-size:1.1rem;color:#dc2626;font-weight:600;">No hay usuario seleccionado</div>
        <div style="margin-top:8px;opacity:0.7;">Por favor, busque un usuario primero</div>
      </div>
    `;
    return;
  }
  
  // Mostrar loading
  contenido.innerHTML = `
    <div style="text-align:center;padding:40px;">
      <div style="font-size:3rem;margin-bottom:16px;">‚è≥</div>
      <div>Cargando alertas para usuario ${run}...</div>
    </div>
  `;
  
  try {
    // Llamar al endpoint de alertas
    const response = await fetch(`/api/vigencia/alertas/${encodeURIComponent(run)}`);
    
    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Error desconocido');
    }
    
    alertasCache = data.alertas || [];
    renderizarAlertas(alertasCache);
    
  } catch (error) {
    console.error('‚ùå Error cargando alertas:', error);
    contenido.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:16px;">‚ùå</div>
        <div style="font-size:1.1rem;color:#dc2626;font-weight:600;">Error cargando alertas</div>
        <div style="margin-top:8px;opacity:0.7;">${error.message}</div>
      </div>
    `;
  }
}

// Funci√≥n para renderizar alertas
function renderizarAlertas(alertas) {
  const contenido = document.getElementById('contenido-alertas');
  
  if (!alertas || alertas.length === 0) {
    contenido.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:16px;">‚úÖ</div>
        <div style="font-size:1.1rem;color:#059669;font-weight:600;">No hay alertas pendientes</div>
        <div style="margin-top:8px;opacity:0.7;">Todos los controles est√°n al d√≠a</div>
      </div>
    `;
    return;
  }
  
  // Agrupar alertas por categor√≠a
  const categorias = {};
  alertas.forEach(alerta => {
    if (!categorias[alerta.categoria]) {
      categorias[alerta.categoria] = [];
    }
    categorias[alerta.categoria].push(alerta);
  });
  
  // Contador de alertas pendientes
  const pendientes = alertas.filter(a => !a.vigente && a.detalle).length;
  const sinDatos = alertas.filter(a => !a.detalle).length;
  const vigentes = alertas.filter(a => a.vigente).length;

  actualizarIndicadoresAlertas(pendientes, sinDatos, vigentes);
  
  // Header con resumen
  let html = `
    <div style="background:#f8fafc;padding:16px;border-radius:8px;margin-bottom:24px;display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
      <div style="text-align:center;padding:12px 20px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="font-size:1.8rem;font-weight:bold;color:#059669;">${alertas.filter(a => a.vigente).length}</div>
        <div style="font-size:0.75rem;opacity:0.7;text-transform:uppercase;">Al d√≠a</div>
      </div>
      <div style="text-align:center;padding:12px 20px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="font-size:1.8rem;font-weight:bold;color:#dc2626;">${pendientes}</div>
        <div style="font-size:0.75rem;opacity:0.7;text-transform:uppercase;">Vencidos</div>
      </div>
      <div style="text-align:center;padding:12px 20px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="font-size:1.8rem;font-weight:bold;color:#64748b;">${sinDatos}</div>
        <div style="font-size:0.75rem;opacity:0.7;text-transform:uppercase;">Sin datos</div>
      </div>
    </div>
  `;
  
  // Renderizar por categor√≠a
  const iconosCategorias = {
    'Vacunas': 'üíâ',
    'Screening': 'üîé',
    'Diabetes': 'ü©∫',
    'Cardiovascular': '‚ù§Ô∏è',
    'Adulto Mayor': 'üë¥',
    'Actividad F√≠sica': 'üö∂',
    'Tratamientos': 'üíä'
  };
  
  Object.keys(categorias).sort().forEach(categoria => {
    const alertasCategoria = categorias[categoria];
    const icono = iconosCategorias[categoria] || 'üìã';
    
    html += `
      <div style="margin-bottom:24px;">
        <h3 style="margin:0 0 12px;font-size:1.1rem;color:#334155;display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:2px solid #e2e8f0;">
          ${icono} ${categoria}
          <span style="font-size:0.7rem;opacity:0.6;font-weight:normal;">(${alertasCategoria.length})</span>
        </h3>
        <div style="display:grid;gap:8px;">
    `;
    
    alertasCategoria.forEach(alerta => {
      const esVigente = alerta.vigente;
      const tieneDetalle = alerta.detalle && alerta.detalle !== 'Sin datos';
      
      let colorFondo, colorBorde, colorTexto, icono;
      
      if (!tieneDetalle) {
        colorFondo = '#f8fafc';
        colorBorde = '#cbd5e1';
        colorTexto = '#64748b';
        icono = '‚ö™';
      } else if (esVigente) {
        colorFondo = '#f0fdf4';
        colorBorde = '#86efac';
        colorTexto = '#059669';
        icono = '‚úÖ';
      } else {
        colorFondo = '#fef2f2';
        colorBorde = '#fca5a5';
        colorTexto = '#dc2626';
        icono = '‚ö†Ô∏è';
      }
      
      html += `
        <div style="padding:12px;background:${colorFondo};border:1px solid ${colorBorde};border-radius:6px;display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div style="flex:1;">
            <div style="font-size:0.85rem;font-weight:600;color:#334155;margin-bottom:4px;">
              ${icono} ${alerta.descripcion}
            </div>
            <div style="font-size:0.7rem;opacity:0.7;margin-bottom:4px;">
              ${alerta.aplicable}
            </div>
            <div style="font-size:0.75rem;color:${colorTexto};font-weight:600;">
              ${tieneDetalle ? alerta.detalle : 'Sin datos registrados'}
            </div>
          </div>
          <div style="text-align:right;min-width:80px;">
            <div style="font-size:0.65rem;opacity:0.7;">Estado</div>
            <div style="font-size:1.2rem;">${alerta.estado}</div>
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  contenido.innerHTML = html;
}

// Funci√≥n para cerrar modal
function cerrarModalAlertas() {
  const modal = document.getElementById('modal-alertas-vigencia');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Funci√≥n para actualizar badge de alertas pendientes
if (!window.__alertasVigenciaHandlers) {
  window.__alertasVigenciaHandlers = true;

  const handleModalOutsideClick = (e) => {
    const modal = document.getElementById('modal-alertas-vigencia');
    if (modal && e.target === modal) {
      cerrarModalAlertas();
    }
  };

  const handleModalEscape = (e) => {
    if (e.key === 'Escape') {
      cerrarModalAlertas();
    }
  };

  const handleUsuarioCargado = (e) => {
    const detail = e?.detail || {};
    const run = (detail.run || '').trim();
    const alertasPre = Array.isArray(detail.alertas) ? detail.alertas : null;

    alertasReconocidas = false;
    actualizarIndicadoresAlertas(0, 0, null);

    if (alertasPre) {
      try {
        const pendientes = alertasPre.filter(a => !a.vigente && a.detalle).length;
        const sinDatos = alertasPre.filter(a => !a.detalle).length;
        const vigentes = alertasPre.filter(a => a.vigente).length;
        actualizarIndicadoresAlertas(pendientes, sinDatos, vigentes);
        return;
      } catch (err) {
        console.warn('Error procesando alertas precargadas:', err);
      }
    }

    if (!run) {
      return;
    }

    // Cargar alertas en background
    setTimeout(() => {
      fetch(`/api/vigencia/alertas/${encodeURIComponent(run)}`)
        .then(r => r.json())
        .then(data => {
          if (data.success && data.alertas) {
            const pendientes = data.alertas.filter(a => !a.vigente && a.detalle).length;
            const sinDatos = data.alertas.filter(a => !a.detalle).length;
            const vigentes = data.alertas.filter(a => a.vigente).length;
            actualizarIndicadoresAlertas(pendientes, sinDatos, vigentes);
          }
        })
        .catch(err => console.error('Error cargando alertas:', err));
    }, 1000);
  };

  document.addEventListener('click', handleModalOutsideClick);
  document.addEventListener('keydown', handleModalEscape);
  window.addEventListener('usuario:cargado', handleUsuarioCargado);
}

console.log('‚úÖ [INIT] Sistema de alertas de vigencia cargado');

// ===== FUNCIONES DE DIAGNOSTICO GLOBALES =====
console.log('üîß [INIT] Cargando funciones de diagn√≥stico...');

window.testFecha = function() {
  console.log('üîß [TEST-FECHA] Probando formateo de fecha...');
  const fecha = 'Thu, 12 Mar 1964 00:00:00 GMT';
  console.log('üîß [TEST-FECHA] Fecha original:', fecha);
  const fechaFormateada = new Date(fecha).toLocaleDateString('es-CL');
  console.log('üîß [TEST-FECHA] Fecha formateada:', fechaFormateada);
  return fechaFormateada;
};

window.testPoblarDirect = function() {
  console.log('üîß [TEST-DIRECT] Test directo de poblar...');
  try {
    console.log('üîß [TEST-DIRECT] Verificando funci√≥n poblar:', typeof window.poblar);
    
    const testData = {
      usuario: {
        run: "10.000.141-1",
        nombre: "Patricio Pino Reyes", 
        fecha_nacimiento: "Thu, 12 Mar 1964 00:00:00 GMT",
        sexo: "masculino",
        sector_nombre: "VERDE"
      },
      edad: 61
    };
    
    if (typeof poblar === 'function') {
      console.log('üîß [TEST-DIRECT] Ejecutando poblar...');
      poblar(testData);
      console.log('üîß [TEST-DIRECT] Poblar ejecutado correctamente');
    } else {
      console.error('üîß [TEST-DIRECT] Funci√≥n poblar no encontrada');
    }
  } catch(error) {
    console.error('üîß [TEST-DIRECT] Error:', error);
  }
  return 'Test completado';
};

console.log('üîß [INIT] Funciones de diagn√≥stico cargadas');

// ============ FUNCI√ìN DE DIAGN√ìSTICO PARA PROBLEMAS DE B√öSQUEDA ============
window.diagnosticarBusqueda = function() {
    console.log('üîç [DIAGNOSTICO] Iniciando diagn√≥stico de b√∫squeda...');
    
    // Verificar elementos del DOM
    const elementos = {
        'runSearch (#run-search)': document.getElementById('run-search'),
        'btnBuscar (#btn-buscar-run)': document.getElementById('btn-buscar-run'),
        'runForm (#run)': document.getElementById('run'),
        'helpSearch (#run-search-help)': document.getElementById('run-search-help')
    };
    
    console.log('üîç [DIAGNOSTICO] Elementos del DOM:');
    Object.entries(elementos).forEach(([nombre, elemento]) => {
        console.log(`  ${nombre}: ${elemento ? '‚úÖ Encontrado' : '‚ùå No encontrado'}`);
        if (elemento && elemento.value !== undefined) {
            console.log(`    Valor actual: "${elemento.value}"`);
        }
    });
    
    // Verificar funciones
    const funciones = {
        'buscarRun': typeof buscarRun,
        'trimRun': typeof trimRun,
        'validarRunCl': typeof validarRunCl,
        'marcarValidez': typeof marcarValidez
    };
    
    console.log('üîç [DIAGNOSTICO] Funciones disponibles:');
    Object.entries(funciones).forEach(([nombre, tipo]) => {
        console.log(`  ${nombre}: ${tipo === 'function' ? '‚úÖ Disponible' : `‚ùå ${tipo}`}`);
    });
    
    // Probar validaci√≥n con RUN de ejemplo
    if (typeof validarRunCl === 'function') {
        const runTest = '12.345.678-9';
        console.log(`üîç [DIAGNOSTICO] Probando validaci√≥n con RUN: ${runTest}`);
        console.log(`  Resultado: ${validarRunCl(runTest)}`);
    }
    
    // Verificar event listeners
    const btnBuscar = document.getElementById('btn-buscar-run');
    if (btnBuscar) {
        console.log('üîç [DIAGNOSTICO] Analizando bot√≥n de b√∫squeda...');
        console.log(`  Texto del bot√≥n: "${btnBuscar.textContent.trim()}"`);
        console.log(`  Disabled: ${btnBuscar.disabled}`);
        console.log(`  Visible: ${btnBuscar.offsetWidth > 0 && btnBuscar.offsetHeight > 0}`);
        console.log(`  Event listeners: ${btnBuscar.onclick ? 'onclick definido' : 'sin onclick'}`);
    }
    
    // Probar funci√≥n buscarRun directamente
    if (typeof buscarRun === 'function') {
        console.log('üîç [DIAGNOSTICO] Funci√≥n buscarRun disponible');
        
        // Llenar campo con RUN de prueba
        const runInput = document.getElementById('run-search');
        if (runInput) {
            const runPrueba = '12.345.678-9';
            runInput.value = runPrueba;
            console.log(`üîç [DIAGNOSTICO] Campo llenado con RUN de prueba: ${runPrueba}`);
            
            console.log('üîç [DIAGNOSTICO] Ejecutando buscarRun() directamente...');
            try {
                buscarRun();
                console.log('  ‚úÖ buscarRun() ejecutado sin errores sincronos');
            } catch (error) {
                console.error('  ‚ùå Error ejecutando buscarRun():', error);
            }
        }
    } else {
        console.error('üîç [DIAGNOSTICO] ‚ùå Funci√≥n buscarRun NO est√° disponible');
    }
    
    return 'Diagn√≥stico completado - revisa los logs arriba';
};

// ============ CARGA AUTOM√ÅTICA DESDE P√ÅGINA DETALLE ============
// Ejecutar despu√©s de que todas las funciones est√©n definidas
if (typeof window.cargarUsuarioDesdeURL !== 'function') {
  window.cargarUsuarioDesdeURL = function cargarUsuarioDesdeURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const runParam = urlParams.get('run');
    const autoload = urlParams.get('autoload');
        
    if (runParam && autoload === 'true') {
      console.log('üè• [AUTOLOAD] Detectado RUN desde p√°gina detalle:', runParam);
            
      // Limpiar par√°metros de la URL sin recargar la p√°gina
      const newUrl = window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
            
      // Cargar el RUN en el campo de b√∫squeda
      const runInput = document.getElementById('run');
      const buscarRunInput = document.getElementById('buscar-run');
            
      if (runInput) {
        runInput.value = runParam;
        console.log('‚úÖ [AUTOLOAD] RUN cargado en campo principal:', runParam);
      }
            
      if (buscarRunInput) {
        buscarRunInput.value = runParam;
        console.log('‚úÖ [AUTOLOAD] RUN cargado en campo de b√∫squeda:', runParam);
      }
            
      // Verificar si hay datos en sessionStorage
      const runKey = runParam.replace(/[.-]/g, '');
      const datosGuardados = sessionStorage.getItem('usuario_precarga_' + runKey);
            
      if (datosGuardados) {
        try {
          const datos = JSON.parse(datosGuardados);
          console.log('üìã [AUTOLOAD] Datos de usuario encontrados en sessionStorage:', datos);
                    
          // Mostrar mensaje de bienvenida
          if (datos.nombre) {
            const mensaje = `üè• Cargando datos de ${datos.nombre} (${runParam})...`;
            console.log(mensaje);
                        
            // Si hay un elemento de estado, mostrar el mensaje
            const estadoElementos = [
              document.querySelector('.estado-run'),
              document.getElementById('estado-busqueda'),
              document.querySelector('.lblEstado')
            ].filter(Boolean);
                        
            estadoElementos.forEach(el => {
              if (el) {
                el.textContent = mensaje;
                el.style.color = '#059669';
              }
            });
          }
                    
          // Limpiar datos temporales
          sessionStorage.removeItem('usuario_precarga_' + runKey);
        } catch (error) {
          console.warn('‚ö†Ô∏è [AUTOLOAD] Error procesando datos guardados:', error);
        }
      }
            
      // Buscar autom√°ticamente despu√©s de un breve delay
      setTimeout(() => {
        if (typeof buscarRun === 'function') {
          console.log('üîç [AUTOLOAD] Iniciando b√∫squeda autom√°tica...');
          buscarRun();
        } else {
          console.error('‚ùå [AUTOLOAD] Funci√≥n buscarRun no disponible');
        }
      }, 200);
            
      return true;
    }
        
    return false;
  };
}

// Ejecutar la carga autom√°tica al final del script
if (!window.__tarjetonAutoLoadScheduled) {
  window.__tarjetonAutoLoadScheduled = true;
  setTimeout(() => {
    const cargaAutomatica = window.cargarUsuarioDesdeURL?.();
        
    if (cargaAutomatica) {
      console.log('‚úÖ [AUTOLOAD] Proceso de carga autom√°tica iniciado');
    } else {
      console.log('‚ÑπÔ∏è [AUTOLOAD] No se detectaron par√°metros de carga autom√°tica');
    }
  }, 100);
}

</script>

{% endblock %}
