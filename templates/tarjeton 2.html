{% extends 'base.html' %}
{% block title %}Tarjetón Usuario{% endblock %}
{% block content %}
<header style="background:linear-gradient(135deg,#065f46,#047857,#059669);border-radius:18px;padding:34px 28px;margin-bottom:22px;position:relative;overflow:hidden;color:#fff;display:flex;align-items:center;justify-content:center;min-height:120px;">
  <div style="position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 75% 25%,rgba(255,255,255,0.15),transparent 60%);"></div>
  <div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;width:100%;position:relative;z-index:1;">
    <div style="display:flex;align-items:center;justify-content:center;flex:1;gap:20px;">
  <img src="/static/logo_ecicep.jpg" alt="ECICEP" style="width:80px;height:80px;border-radius:50%;box-shadow:0 6px 16px rgba(0,0,0,.3);object-fit:cover;">
  <img src="/static/tarjeton.png" alt="Tarjetón" style="height:180px;width:auto;object-fit:contain;border-radius:16px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.25),0 4px 6px -2px rgba(0,0,0,0.2);transition:transform .3s ease;filter:brightness(1.05) contrast(1.05);">
    </div>
  </div>
</header>

<style>
  /* Estados de validación RUN */
  .is-invalid { border-color:#dc2626 !important; outline-color:#dc2626 !important; }
  .is-valid { border-color:#16a34a !important; outline-color:#16a34a !important; }
  /* ===== Modo compacto ECICEP ===== */
  .ec-compact {
    --fs-xs: 12px;
    --fs-sm: 13px;
    --fs-base: 14px;
    --pad-sm: 6px;
    --pad-md: 10px;
    --gap-sm: 6px;
    --gap-md: 10px;
    --radius: 10px;
  }
  .ec-compact body,
  .ec-compact .card { font-size: var(--fs-base); }
  .ec-compact .card { padding: var(--pad-md); border-radius: var(--radius); }
  .ec-compact .mini-grid { display:grid !important; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)) !important; gap:var(--gap-md) !important; }
  .ec-compact label { font-size: var(--fs-sm); }
  .ec-compact input, .ec-compact select { padding:6px 8px; height:36px; }
  .ec-compact .btn { min-height:34px; padding:6px 10px; }
  .ec-compact .t-tab { padding:8px 10px; font-size:var(--fs-sm); }
  
  /* Estilos para las pestañas (tabs) */
  .t-tab {
    background: #f8fafc;
    color: #475569;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 10px 16px;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    margin: 0 4px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .t-tab:hover {
    background: #e2e8f0;
    color: #1e293b;
    transform: translateY(-1px);
  }

  .t-tab.active {
    background: #475569;
    color: white;
    border-color: #334155;
    box-shadow: 0 4px 8px rgba(71, 85, 105, 0.3);
    transform: translateY(-1px);
  }

  .t-tab.active:hover {
    background: #334155;
    transform: translateY(-1px);
  }
  
  /* Pestaña Adulto Mayor - oculta por defecto, se muestra via JavaScript según edad */
  .t-tab[data-tab="funcionalidad"] {
    display: none;
  }
  
  /* Pestaña Evaluación Diabetes - oculta por defecto, se muestra via JavaScript si tiene diabetes + ERC */
  .t-tab[data-tab="diabetes"] {
    display: none;
  }
  
  /* Responsivo para pestañas en pantallas pequeñas */
  @media (max-width: 768px) {
    .t-tab {
      padding: 8px 12px;
      font-size: 0.8rem;
      margin: 0 1px;
    }
  }

  
  .mini-btn {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    color: #64748b;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.65rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .mini-btn:hover {
    background: #e2e8f0;
    color: #374151;
  }
  
  .mini-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
  }
  
  /* Estilos para los nuevos botones */
  #btn-inicio { background:#2563eb; color:white; border:none; border-radius:6px; margin-left:8px; }
  #btn-inicio:hover { background:#1d4ed8; }
  
  #btn-limpiar { background:#f59e0b; color:white; border:none; border-radius:6px; margin-left:8px; }
  #btn-limpiar:hover { background:#d97706; }
  
  #btn-mandrake-bot { background:#10b981; color:white; border:none; border-radius:6px; margin-left:8px; font-weight:500; }
  #btn-mandrake-bot:hover { background:#059669; transform:scale(1.02); }
  #btn-mandrake-bot:active { transform:scale(0.98); }
  
  /* Botón alertas (nueva ubicación) */
  .alertas-toolbar {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
  }

  .chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 2px solid #F59E0B;
    background: #FFFBEB;
    color: #B45309;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 8px 16px rgba(245, 158, 11, 0.25);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .chip .icon {
    color: #B45309;
    font-size: 1rem;
  }

  .chip .label {
    font-size: 0.78rem;
  }

  .chip .count {
    background: #B45309;
    color: #fff;
    padding: 2px 8px;
    border-radius: 999px;
    font-weight: 700;
    font-size: 0.75rem;
    min-width: 28px;
    text-align: center;
  }

  .chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 24px rgba(245, 158, 11, 0.35);
  }

  .chip:active {
    transform: scale(0.97);
  }

  .chip-critical {
    background: #FDE8E8;
    border-color: #DC2626;
    color: #991B1B;
    box-shadow: 0 8px 16px rgba(220, 38, 38, 0.25);
  }

  .chip-critical .icon {
    color: #B91C1C;
  }

  .chip-critical .count {
    background: #B91C1C;
  }

  .chip-warning {
    background: #FFFBEB;
    border-color: #F59E0B;
    color: #B45309;
    box-shadow: 0 8px 16px rgba(245, 158, 11, 0.25);
  }

  .chip-warning .icon {
    color: #B45309;
  }

  .chip-warning .count {
    background: #B45309;
  }

  .chip-success {
    background: #ECFDF5;
    border-color: #10B981;
    color: #065F46;
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.25);
  }

  .chip-success .icon {
    color: #047857;
  }

  .chip-success .count {
    background: #047857;
  }

  .chip.oculta {
    display: none !important;
  }

  @keyframes blinkRojo {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); }
    50% { opacity: 0.4; box-shadow: 0 0 12px 2px rgba(239, 68, 68, 0.75); }
  }

  @keyframes blinkAmarillo {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.6); }
    50% { opacity: 0.5; box-shadow: 0 0 12px 2px rgba(250, 204, 21, 0.8); }
  }

  .blink-rojo {
    animation: blinkRojo 1.1s ease-in-out infinite;
  }

  .blink-amarillo {
    animation: blinkAmarillo 1.4s ease-in-out infinite;
  }

  /* Chat MandrakeBot */
  #mandrake-chat-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  
  #mandrake-chat-container {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    height: 80%;
    max-height: 700px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  #mandrake-chat-header {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 16px 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  #mandrake-chat-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
  }
  
  #mandrake-chat-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  #mandrake-chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .mandrake-message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 16px;
    line-height: 1.5;
    font-size: 14px;
  }
  
  .mandrake-message.user {
    align-self: flex-end;
    background: #2563eb;
    color: white;
  }
  
  .mandrake-message.bot {
    align-self: flex-start;
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #e5e7eb;
  }
  
  .mandrake-message.system {
    align-self: center;
    background: #fef3c7;
    color: #92400e;
    font-size: 12px;
    font-style: italic;
  }
  
  #mandrake-chat-input-container {
    padding: 16px 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  #mandrake-chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 24px;
    font-size: 14px;
    outline: none;
  }
  
  #mandrake-chat-input:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
  }
  
  #mandrake-chat-send {
    background: #10b981;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 24px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  #mandrake-chat-send:hover {
    background: #059669;
    transform: scale(1.02);
  }
  
  #mandrake-chat-send:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }
  
  .mandrake-typing {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: #f3f4f6;
    border-radius: 16px;
    align-self: flex-start;
    max-width: 80%;
  }
  
  .mandrake-typing-dots {
    display: flex;
    gap: 4px;
  }
  
  .mandrake-typing-dot {
    width: 8px;
    height: 8px;
    background: #6b7280;
    border-radius: 50%;
    animation: mandrakePulse 1.4s infinite ease-in-out;
  }
  
  .mandrake-typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .mandrake-typing-dot:nth-child(2) { animation-delay: -0.16s; }
  .mandrake-typing-dot:nth-child(3) { animation-delay: 0s; }
  
  @keyframes mandrakePulse {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
  .ec-compact #tabs-content { padding:6px 14px; }
  .ec-compact table th, .ec-compact table td { padding:4px 6px !important; font-size:12px !important; }
  .ec-compact #card-resumen { gap:10px; min-height:320px; }
  .zoom-hover, .btn:hover, button:hover, input:hover, select:hover, textarea:hover { transform:none !important; box-shadow:none !important; }
  /* Reiterar estados RUN (ya definidos arriba) */
  :root { --resumen-w:320px; }
  #layout-tarjeton-grid { grid-template-columns:1fr; }
  #layout-tarjeton-grid.no-resumen { grid-template-columns:1fr !important; }
  #layout-tarjeton-grid.solo-resumen { grid-template-columns:var(--resumen-w) minmax(0,1fr) !important; }
  #layout-tarjeton-grid.resumen-colapsado { grid-template-columns:46px minmax(0,1fr) !important; }
  /* El resumen ahora ocupa todo el ancho disponible (igual a Identificación) */
  #card-resumen { width:100%; }
  #card-resumen.expandido { width:100%; min-height:460px; }
  @media (max-width: 1200px){ :root { --resumen-w:300px; } }
  @media (max-width: 1050px){ #layout-tarjeton-grid.solo-resumen { grid-template-columns:1fr !important; } #card-resumen { width:100%; } }
  @media (min-width:1600px){ :root { --resumen-w:360px; } }
  /* Toolbar RUN fija (sticky) en la parte superior al hacer scroll) */
  #toolbar-buscar-run {
    position:sticky;
    top:8px; /* separacion del borde superior */
    z-index:60;
    background:#f8fafc;
    padding:8px 10px;
    border:1px solid #e2e8f0;
    border-radius:12px;
    box-shadow:0 2px 4px rgba(0,0,0,0.05);
  }
  /* Evitar que elementos flex internos colapsen alturas al sticky */
  #toolbar-buscar-run > * { margin-top:0 !important; }
  /* Colores patologías clave */
  #lista-patologias li.pat-hta{background:#b91c1c;color:#fff;padding:2px 6px;border-radius:4px;margin:2px 0;font-weight:600;}
  #lista-patologias li.pat-dislip{background:#facc15;color:#422006;padding:2px 6px;border-radius:4px;margin:2px 0;font-weight:600;}
  #lista-patologias li.pat-diabetes{background:#16a34a;color:#fff;padding:2px 6px;border-radius:4px;margin:2px 0;font-weight:600;}
  
  /* Evaluación Diabetes - Grid responsivo */
  @media (max-width: 768px) {
    #evaluacion-diabetes div[style*="grid-template-columns:1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
  
  /* Fármacos - Grid responsivo */
  @media (max-width: 768px) {
    #farmacos div[style*="grid-template-columns:1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
  
  /* === MandrakeBot - Sistema de destacado de campos === */
  .mandrake-modified {
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)) !important;
    border: 2px solid #10b981 !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
    transition: all 0.3s ease !important;
    animation: mandrake-highlight 1s ease-out !important;
  }
  
  .mandrake-tab-modified {
    background: linear-gradient(135deg, #10b981, #059669) !important;
    color: white !important;
    position: relative !important;
    animation: mandrake-tab-pulse 2s infinite !important;
  }
  
  .mandrake-indicator {
    position: absolute !important;
    top: -2px !important;
    right: -2px !important;
    width: 8px !important;
    height: 8px !important;
    background: #dc2626 !important;
    border-radius: 50% !important;
    animation: mandrake-pulse 1.5s infinite !important;
  }
  
  @keyframes mandrake-highlight {
    0% { 
      background: rgba(16, 185, 129, 0.3);
      transform: scale(1.02);
    }
    100% { 
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      transform: scale(1);
    }
  }
  
  @keyframes mandrake-tab-pulse {
    0%, 100% { 
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
    }
    50% { 
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.1);
    }
  }
  
  @keyframes mandrake-pulse {
    0%, 100% { 
      opacity: 1; 
      transform: scale(1);
    }
    50% { 
      opacity: 0.5; 
      transform: scale(1.2);
    }
  }

  /* === Mandrake Summary Card === */
  #mandrake-summary-card {
    display:none;
    position:relative;
  }

  #mandrake-summary-card.active {
    display:flex;
  }

  .mandrake-summary-meta {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:8px;
    font-size:.7rem;
  }

  .mandrake-summary-meta div {
    background:#f8fafc;
    border:1px solid #e2e8f0;
    border-radius:6px;
    padding:8px;
  }

  .mandrake-summary-section {
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .mandrake-summary-section h4 {
    margin:0;
    font-size:.72rem;
    text-transform:uppercase;
    letter-spacing:.4px;
    color:#0f172a;
  }

  .mandrake-summary-text {
    font-size:.72rem;
    line-height:1.45;
    background:#f8fafc;
    border:1px solid #e2e8f0;
    border-radius:8px;
    padding:10px;
    color:#1f2937;
  }

  .mandrake-summary-text p {
    margin:0 0 6px;
  }

  .mandrake-summary-text p:last-child {
    margin-bottom:0;
  }

  .mandrake-summary-text ul {
    margin:0;
    padding-left:18px;
  }

  .mandrake-summary-list {
    margin:0;
    padding-left:20px;
    display:grid;
    gap:4px;
    font-size:.72rem;
    color:#0f172a;
  }

  .mandrake-summary-badge {
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:.65rem;
    font-weight:600;
    color:#047857;
    background:linear-gradient(135deg,#d1fae5,#bbf7d0);
    border:1px solid #059669;
    border-radius:999px;
    padding:2px 8px;
  }

  .mandrake-summary-highlight {
    animation: mandrake-summary-pop 1s ease;
  }

  @keyframes mandrake-summary-pop {
    0% { box-shadow:0 0 0 0 rgba(5,150,105,.35); transform:scale(.99); }
    50% { box-shadow:0 0 0 12px rgba(5,150,105,0); transform:scale(1.01); }
    100% { box-shadow:none; transform:scale(1); }
  }
</style>

<div id="layout-tarjeton-grid" style="display:flex;flex-direction:column;gap:18px;align-items:stretch;">
  <!-- Toolbar Buscar RUN -->
  <div id="toolbar-buscar-run" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;position:sticky;top:8px;z-index:60;background:#f8fafc;padding:8px 10px;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
      <label style="display:flex;flex-direction:column;gap:4px;">
        <span style="font-size:.75rem;font-weight:600;letter-spacing:.3px;">RUN a buscar</span>
        <input type="text" id="run-search" placeholder="00.000.000-0" maxlength="13" style="min-width:220px;" />
        <small id="run-search-help" style="display:none;color:#b91c1c;">RUN inválido</small>
      </label>
      <button type="button" id="btn-buscar-run" class="btn btn-verde" style="position:relative;">
        <span class="lbl">Buscar RUN</span>
        <span class="spinner" style="display:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
          <span style="width:14px;height:14px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;display:inline-block;animation:spin .7s linear infinite;"></span>
        </span>
      </button>
      <button type="button" id="btn-nuevo-usuario" class="btn btn-outlined">Nuevo usuario</button>
      <button type="button" id="btn-inicio" class="btn btn-primary" onclick="window.location.href='/'">Inicio</button>
      <button type="button" id="btn-limpiar" class="btn btn-warning">Limpiar</button>
      <button type="button" id="btn-mandrake-bot" class="btn btn-success" onclick="openMandrakeBot()">🤖MandrakeBot</button>
      <button type="button" id="btn-ai-autocomplete" class="btn btn-amarillo" style="background:#9333ea;color:#fff;border:none;" title="Extraer datos desde texto libre">⚡ Autocompletar IA</button>
      <button type="button" id="btn-save-all" class="btn" title="Guardar todo" style="background:#0f766e;color:#fff;display:flex;align-items:center;gap:4px;">
        💾 <span style="font-size:.65rem;font-weight:600;letter-spacing:.5px;">Guardar</span>
      </button>
      <div id="ai-autocomplete-status" style="display:none;"></div>
      <style>@keyframes spin{to{transform:rotate(360deg);}}</style>
  </div>
  <!-- Bloque adicional simple para IA (versión solicitada) -->
  <div class="card" style="padding:12px;display:flex;flex-direction:column;gap:8px;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <strong style="font-size:.8rem;letter-spacing:.5px;">Autocompletar Tarjetón (Modo Simple)</strong>
      <button id="btn-ai-fill" type="button" class="btn" style="background:#2563eb;color:#fff;">Autocompletar con IA</button>
    </div>
    <textarea id="ai-texto" placeholder="Pega aquí la nota clínica para autocompletar…" style="width:100%;min-height:90px;font-size:.75rem;padding:8px;border:1px solid #cbd5e1;border-radius:8px;resize:vertical;"></textarea>
    <small style="opacity:.7;font-size:.6rem;">Usa texto resumido (&lt;=6000 chars). Este modo no guarda datos automáticamente.</small>
    <div id="ai-fill-status" style="display:none;font-size:.65rem;"></div>
  </div>
  <section id="mandrake-summary-card" class="card" style="padding:16px;flex-direction:column;gap:12px;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <h3 style="margin:0;font-size:0.95rem;display:flex;align-items:center;gap:6px;color:#065f46;">
        🤖 Resumen Mandrake
      </h3>
      <span id="mandrake-summary-status" class="mandrake-summary-badge" style="display:none;">Actualizado</span>
    </div>
    <div data-role="empty" style="font-size:.72rem;color:#64748b;">
      Pega una nota clínica o ejecuta el autocompletado para ver aquí el resumen estructurado.
    </div>
    <div data-role="content" style="display:none;flex-direction:column;gap:12px;">
      <div class="mandrake-summary-meta">
        <div><strong>Fecha atención</strong><br><span data-ms="fecha_atencion">—</span></div>
        <div><strong>Hora</strong><br><span data-ms="hora_atencion">—</span></div>
        <div><strong>Funcionario</strong><br><span data-ms="funcionario">—</span></div>
        <div><strong>Profesión</strong><br><span data-ms="profesion">—</span></div>
        <div><strong>Establecimiento</strong><br><span data-ms="establecimiento">—</span></div>
        <div><strong>Procedencia</strong><br><span data-ms="procedencia">—</span></div>
        <div><strong>Tipo consulta</strong><br><span data-ms="tipo_consulta">—</span></div>
      </div>
      <div style="font-size:.68rem;color:#475569;display:none;" id="mandrake-summary-edad">
        <strong>Edad detallada:</strong> <span data-ms="edad_detallada">—</span>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-motivo">
        <h4>Motivo de consulta</h4>
        <div class="mandrake-summary-text" data-section="motivo_consulta">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-enfermedad">
        <h4>Enfermedad actual</h4>
        <div class="mandrake-summary-text" data-section="enfermedad_actual">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-familiar" style="display:none;">
        <h4>Atención familiar</h4>
        <div class="mandrake-summary-text" data-section="atencion_familiar">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-estudios">
        <h4>Estudios relevantes</h4>
        <div class="mandrake-summary-text" data-section="estudios_relevantes">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-condiciones">
        <h4>Condiciones o riesgos</h4>
        <div class="mandrake-summary-text" data-section="condiciones_riesgos">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-indicaciones">
        <h4>Indicaciones</h4>
        <div class="mandrake-summary-text" data-section="indicaciones">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-funcionalidad">
        <h4>Funcionalidad / apoyo</h4>
        <div class="mandrake-summary-text" data-section="funcionalidad">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-diagnosticos">
        <h4>Diagnósticos detectados</h4>
        <ul class="mandrake-summary-list" id="mandrake-summary-dx-list">
          <li style="opacity:.6;">Sin datos</li>
        </ul>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-actividades">
        <h4>Actividades programadas</h4>
        <ul class="mandrake-summary-list" id="mandrake-summary-actividades-list">
          <li style="opacity:.6;">Sin actividades detectadas</li>
        </ul>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-formularios">
        <h4>Formularios y escalas</h4>
        <div class="mandrake-summary-text" data-section="formularios_realizados">—</div>
      </div>
      <div class="mandrake-summary-section" id="mandrake-summary-empam" style="display:none;">
        <h4>EMPAM / EFAM</h4>
        <div class="mandrake-summary-text" data-section="empam">—</div>
      </div>
    </div>
  </section>
  <!-- Resumen siempre visible debajo del toolbar -->
  <aside id="card-resumen" class="card" style="padding:16px;flex-direction:column;gap:14px;min-height:220px;display:flex;position:relative;">
    <h3 style="margin:0;font-size:1.05rem;display:flex;align-items:center;gap:6px;">🩺 Resumen</h3>
    <button type="button" id="btn-editar-ident" class="btn btn-amarillo" style="align-self:flex-start;margin-bottom:4px;padding:4px 10px;font-size:.65rem;letter-spacing:.5px;">Editar identificación</button>
    <div class="resumen-body" style="display:flex;flex-direction:column;gap:10px;">
      <div id="resumen-ident" style="font-size:.82rem;line-height:1.35;display:grid;gap:4px;">
      <div><strong>RUN:</strong> <span data-f="run">—</span></div>
      <div><strong>Nombre:</strong> <span data-f="nombre_completo">—</span></div>
      <div><strong>Fecha Nacimiento:</strong> <span data-f="fecha_nacimiento">—</span></div>
    <div><strong>Edad:</strong> <span data-f="edad">—</span></div>
      <div><strong>Sexo:</strong> <span data-f="sexo">—</span></div>
  <div><strong>Sector:</strong> <span data-f="sector_nombre">—</span></div>
  <div><strong>Categoría:</strong> <span data-f="categoria_nombre" class="categoria-riesgo">—</span></div>
      <div><strong>Teléfono:</strong> <span data-f="telefono">—</span></div>
      </div>
      
      <!-- Sección resumen-general para compatibilidad con el código de riesgo -->
      <div id="resumen-general" style="display:none;">
        <span class="categoria-riesgo">—</span>
      </div>
      <hr style="margin:4px 0 0 0;">
      <div>
      <h4 style="margin:4px 0 6px;font-size:.85rem;letter-spacing:.5px;text-transform:uppercase;color:#065f46;">Patologías</h4>
      <ul id="lista-patologias" style="margin:0;padding-left:18px;font-size:.75rem;max-height:160px;overflow:auto;">
        <li style="opacity:.6;">Sin datos</li>
      </ul>
      </div>
      <div style="margin-top:auto;padding-top:6px;border-top:1px solid #e2e8f0;">
      <h4 style="margin:0 0 4px;font-size:.78rem;text-transform:uppercase;letter-spacing:.5px;color:#065f46;">Acuerdo reciente</h4>
      <div id="acuerdo-reciente" style="font-size:.7rem;line-height:1.3;opacity:.85;">—</div>
      </div>
    </div>
  </aside>

  <!-- Identificación + Tabs -->
  <div style="display:flex;flex-direction:column;gap:18px;">
    <form id="form-tarjeton" autocomplete="off" novalidate class="card" style="gap:16px;">
      <fieldset id="identificacion-section" style="display:none; border:1px solid var(--gris-borde,#cbd5e1); border-radius:10px; padding:16px;">
        <legend style="padding:0 8px; font-weight:600; display:flex; align-items:center; gap:8px;">Identificación
          <span id="badge-nuevo-usuario" style="display:none; font-size:.65rem; background:#0f766e; color:#ecfdf5; padding:2px 6px; border-radius:6px; letter-spacing:.5px; font-weight:500;">Usuario nuevo</span>
        </legend>
  <div class="mini-grid" style="--cols:6; display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:18px;">
          <label>RUN
            <input type="text" name="run" id="run" maxlength="13" placeholder="00.000.000-0" required>
          </label>
          <label>Nombre
            <input type="text" name="nombre" id="nombre" required>
          </label>
          <label>Sexo
            <select name="sexo" id="sexo" required>
              <option value="">-- Seleccione --</option>
              <option value="masculino">Masculino</option>
              <option value="femenino">Femenino</option>
            </select>
          </label>
          <label>Fecha nacimiento
            <input type="date" name="fecha_nacimiento" id="fecha_nacimiento" required>
          </label>
          <label>Fecha ingreso
            <input type="date" name="fecha_ingreso" id="fecha_ingreso">
          </label>
          <label>Edad (años)
            <input type="number" id="edad" name="edad" readonly placeholder="0">
          </label>
          <label>Dirección
            <input type="text" name="direccion" id="direccion">
          </label>
          <label>Teléfono
            <input type="text" name="telefono" id="telefono" placeholder="+569...">
          </label>
          <label>Nivel educación
            <select name="nivel_educacion" id="nivel_educacion">
              <option value="">-- Seleccione --</option>
              <option value="Analfabeto">Analfabeto</option>
              <option value="Básica incompleta">Básica incompleta</option>
              <option value="Básica Completa">Básica Completa</option>
              <option value="Media incompleta">Media incompleta</option>
              <option value="Media completa">Media completa</option>
              <option value="Universitaria incompleta">Universitaria incompleta</option>
              <option value="Universitaria completa">Universitaria completa</option>
            </select>
          </label>
          <label>Origen étnico
            <select name="origen_etnico" id="origen_etnico">
              <option value="">-- Seleccione --</option>
              <option value="Chileno">🇨🇱 Chileno</option>
              <option value="Mapuche">Mapuche</option>
              <option value="Extranjero">Extranjero</option>
            </select>
          </label>
          <label>Sector
            <select name="sector_id" id="sector_id" data-load="sectores">
              <option value="">-- Sector --</option>
            </select>
          </label>
          <label>Categoría/Riesgo
            <input type="text" name="categoria" id="categoria" placeholder="—" readonly>
          </label>
        </div>
      </fieldset>
      <div style="display:flex; gap:12px;">
        <button type="submit" class="btn btn-verde">Guardar</button>
        <button type="reset" class="btn btn-outlined" id="btn-reset">Limpiar</button>
      </div>
    </form>

    <!-- Botones de Alertas de Vigencia -->
    <div class="alertas-toolbar">
      <button type="button" id="chip-alertas-vencidos" class="chip chip-critical oculta" onclick="mostrarAlertasVigencia()" title="Alertas vencidas">
        <span class="icon">❗</span>
        <span class="label">Vencidos</span>
        <span class="count">0</span>
      </button>
      <button type="button" id="chip-alertas-faltantes" class="chip chip-warning oculta" onclick="mostrarAlertasVigencia()" title="Alertas sin registro">
        <span class="icon">⚠️</span>
        <span class="label">Pendientes</span>
        <span class="count">0</span>
      </button>
      <button type="button" id="chip-alertas-ok" class="chip chip-success oculta" onclick="mostrarAlertasVigencia()" title="Alertas al día">
        <span class="icon">✅</span>
        <span class="label">Al día</span>
        <span class="count">0</span>
      </button>
    </div>

    <!-- Modal de Alertas de Vigencia -->
    <div id="modal-alertas-vigencia" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;overflow-y:auto;padding:20px;">
      <div style="background:white;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);display:flex;flex-direction:column;">
        <!-- Header -->
        <div style="padding:20px 24px;background:linear-gradient(135deg,#0ea5e9,#06b6d4);color:white;display:flex;justify-content:space-between;align-items:center;">
          <h2 style="margin:0;font-size:1.3rem;display:flex;align-items:center;gap:8px;">
            📋 Alertas de Vigencia ECICEP
          </h2>
          <button onclick="cerrarModalAlertas()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:background 0.2s;"
                  onmouseover="this.style.background='rgba(255,255,255,0.3)';"
                  onmouseout="this.style.background='rgba(255,255,255,0.2)';">
            ✕
          </button>
        </div>
        
        <!-- Content -->
        <div id="contenido-alertas" style="padding:24px;overflow-y:auto;flex:1;">
          <div style="text-align:center;padding:40px;opacity:0.6;">
            <div style="font-size:3rem;margin-bottom:16px;">⏳</div>
            <div>Cargando alertas...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cálculo dinámico de riesgo ECICEP -->
    <section class="card" id="riesgo-dinamico" style="padding:16px;">
      <h3 style="margin:0 0 12px;font-size:1rem;display:flex;align-items:center;gap:6px;">🔎 Cálculo dinámico de riesgo ECICEP y ingreso de patologías</h3>
      
      <!-- Selector de Programa -->
      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;">
        <span style="font-size:.7rem;font-weight:600;opacity:.75;">PROGRAMA:</span>
        <button type="button" id="btn-programa-ecicep-riesgo" class="btn btn-verde" style="font-size:.7rem;">ECICEP</button>
        <button type="button" id="btn-programa-cardio-riesgo" class="btn btn-outlined" style="font-size:.7rem;">CARDIO</button>
        <button type="button" id="btn-programa-dependencia" class="btn btn-outlined" style="font-size:.7rem;">Dependencia</button>
        <button type="button" id="btn-programa-pam" class="btn btn-outlined" style="font-size:.7rem;">PAM</button>
        <button type="button" id="btn-programa-era" class="btn btn-outlined" style="font-size:.7rem;">ERA</button>
        <button type="button" id="btn-programa-otras-cronicas" class="btn btn-outlined" style="font-size:.7rem;">Otras crónicas</button>
      </div>
      
      <div style="display:flex;flex-wrap:wrap;gap:14px;align-items:flex-start;">
        <!-- Panel de Patologías -->
        <div style="flex:1 1 320px;min-width:300px;">
          <label style="display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;font-weight:600;opacity:.75;">Buscar patología</label>
          <input type="text" id="buscador-patologia" placeholder="Nombre o CIE10" style="width:100%;margin-bottom:8px;padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
          <div id="contenedor-patologias" style="max-height:240px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px;padding:8px;font-size:.7rem;display:grid;gap:4px;background:#f9fafb;">
            <div style="opacity:.6;text-align:center;padding:20px;">Cargando catálogo...</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center;">
            <button type="button" id="btn-guardar-patologias" class="btn btn-verde" disabled style="font-size:.7rem;">Guardar selección</button>
            <button type="button" id="btn-select-filtradas" class="btn btn-outlined" disabled style="font-size:.7rem;">Seleccionar filtradas</button>
            <button type="button" id="btn-clear-seleccion" class="btn btn-outlined" disabled style="font-size:.7rem;">Limpiar</button>
            <span id="contador-seleccion" style="font-size:.65rem;opacity:.75;">0 seleccionadas</span>
          </div>
          <div id="estado-patologias" style="font-size:.65rem;margin-top:4px;padding:4px;"></div>
        </div>
        
        <!-- Panel de Cálculo -->
        <div style="flex:1 1 300px;min-width:280px;display:flex;flex-direction:column;gap:12px;">
          <!-- Patologías Seleccionadas -->
          <div>
            <span style="font-size:.7rem;text-transform:uppercase;font-weight:600;opacity:.75;">Patologías Seleccionadas</span>
            <div id="patologias-seleccionadas" style="max-height:120px;overflow:auto;border:1px solid #e2e8f0;border-radius:6px;padding:6px;margin-top:4px;font-size:.65rem;background:#fff;">
              <div style="opacity:.6;text-align:center;padding:10px;">Ninguna patología seleccionada</div>
            </div>
          </div>
          
          <!-- Resultado de Riesgo -->
          <div>
            <span style="font-size:.7rem;text-transform:uppercase;font-weight:600;opacity:.75;">Cálculo de Riesgo</span>
            <div style="display:flex;gap:8px;margin-top:6px;align-items:center;flex-wrap:wrap;">
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:.65rem;opacity:.75;">Actual:</span>
                <div id="riesgo-actual" class="badge-riesgo badge-neutro" title="Categoría actual del usuario">—</div>
              </div>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:.65rem;opacity:.75;">Calculado:</span>
                <div id="riesgo-calculado" class="badge-riesgo badge-neutro" title="Resultado del cálculo">—</div>
              </div>
            </div>
            <div id="puntos-riesgo" style="font-size:.65rem;margin-top:4px;opacity:.75;">Puntos: 0</div>
            <div id="detalle-calculo" style="font-size:.6rem;line-height:1.3;margin-top:6px;padding:6px;background:#f9fafb;border-radius:4px;opacity:.85;">
              Seleccione patologías para calcular el riesgo
            </div>
          </div>
          
          <!-- Botones de Acción -->
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" id="btn-calcular-riesgo" class="btn btn-outlined" disabled style="font-size:.7rem;">🧮 Calcular Riesgo</button>
            <button type="button" id="btn-aplicar-riesgo" class="btn btn-verde" disabled style="font-size:.7rem;">✅ Aplicar al Usuario</button>
          </div>
          
          <!-- Leyenda -->
          <div style="margin-top:8px;font-size:.6rem;line-height:1.4;padding:8px;background:#f1f5f9;border-radius:6px;">
            <strong>Leyenda ECICEP:</strong><br>
            <span class="badge-riesgo badge-g1" style="margin:2px;">G1</span> 1 punto o condición<br>
            <span class="badge-riesgo badge-g2" style="margin:2px;">G2</span> 2-4 puntos o condiciones<br>
            <span class="badge-riesgo badge-g3" style="margin:2px;">G3</span> 5+ puntos o condiciones
          </div>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="card" style="padding:0;overflow:hidden;margin-top:8px;">
      <nav style="display:flex;flex-wrap:wrap;gap:2px;padding:4px 8px;background:#f1f5f9;border-bottom:1px solid #e2e8f0;">
        {% set tabs = [
          ('control','📊 Control'),
          ('farmacos','💊 Fármacos'),
          ('examenes','🧪 Exámenes'),
          ('acuerdos','👍🏼 Acuerdos'),
          ('funcionalidad','👴 Adulto Mayor'),
          ('diabetes','💉Evaluación Diabetes🦶🏻'),
          ('adulto_mayor','🔎 Screening'),

        ] %}
        {% for key,label in tabs %}
          <button type="button" class="t-tab" data-tab="{{ key }}">{{ label }}</button>
        {% endfor %}
      </nav>
      <div id="tabs-content" style="padding:0;min-height:150px;font-size:.9rem;">
        <div data-panel="control" style="padding:8px;">
          <div style="display:grid;gap:10px;">
            <form id="form-control-nuevo" style="display:grid;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:8px;background:#f8fafc;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));align-items:end;">
              <div style="grid-column:1 / -1;font-size:.65rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:#334155;">Nuevo control</div>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Fecha
                <input type="date" name="fecha" style="padding:4px;font-size:.7rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Profesional
                <input type="text" name="profesional" placeholder="Nombre" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Peso (kg)
                <input type="number" step="0.1" name="peso" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Talla (cm)
                <input id="input-talla" type="number" step="0.1" name="talla" style="padding:4px;font-size:.7rem;"/>
              </label>
              <div style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">
                <span style="font-weight:600;">IMC</span>
                <div id="imc-control" style="padding:4px;font-size:.75rem;background:#fff;border:1px solid #cbd5e1;border-radius:4px;min-height:28px;display:flex;align-items:center;gap:6px;">
                  <span data-f="imc">—</span>
                  <span id="imc-clasif" style="font-size:.6rem;padding:2px 6px;border-radius:12px;background:#e2e8f0;color:#334155;display:none;"></span>
                </div>
              </div>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">PSIS
                <input type="number" name="presion_sistolica" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">PDIA
                <input type="number" name="presion_diastolica" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">CC (cm)
                <input type="number" step="0.1" name="cc" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">HGT
                <input type="number" step="0.1" name="hgt" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">HbA1c (%)
                <input type="number" step="0.1" name="hba1c" style="padding:4px;font-size:.7rem;"/>
              </label>
              <div style="display:flex;gap:6px;align-items:center;">
                <button type="submit" class="btn btn-verde" style="font-size:.65rem;padding:6px 10px;">Guardar</button>
                <span id="estado-control" style="font-size:.6rem;opacity:.8;"></span>
              </div>
            </form>
            <div id="panel-control" style="font-size:.75rem;line-height:1.4;display:grid;gap:4px;">
              <div style="opacity:.6;">Seleccione RUN para mostrar último control.</div>
            </div>
            <div id="panel-riesgo-cv" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f8fafc;display:grid;gap:10px;font-size:.7rem;">
              <div style="display:flex;flex-wrap:wrap;align-items:center;gap:12px;justify-content:space-between;">
                <h4 style="margin:0;font-size:.75rem;display:flex;align-items:center;gap:6px;color:#0f172a;">
                  💓 Riesgo Cardiovascular
                </h4>
                <div style="font-size:.65rem;opacity:.8;">
                  Último registro: <strong id="ultimo-riesgo-cv">—</strong>
                  <span style="margin-left:4px;">(<span id="ultimo-riesgo-cv-fecha">—</span>)</span>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;align-items:end;">
                <label style="display:flex;flex-direction:column;gap:4px;font-size:.65rem;font-weight:600;">
                  Fecha
                  <input type="date" id="riesgo_cv_fecha" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;font-size:.7rem;">
                </label>
                <label style="display:flex;flex-direction:column;gap:4px;font-size:.65rem;font-weight:600;">
                  Nivel
                  <select id="riesgo_cv_nivel" style="padding:6px;border:1px solid #d1d5db;border-radius:6px;font-size:.7rem;">
                    <option value="">-- Seleccionar --</option>
                    <option value="bajo">Bajo</option>
                    <option value="moderado">Moderado</option>
                    <option value="alto">Alto</option>
                  </select>
                </label>
                <div style="display:flex;gap:8px;align-items:center;">
                  <button type="button" id="btn-guardar-riesgo-cv" class="btn btn-verde" style="font-size:.65rem;padding:8px 12px;">Guardar</button>
                  <span id="estado-riesgo-cv" style="font-size:.6rem;opacity:.8;"></span>
                </div>
              </div>
            </div>
            <div id="historico-control" class="hist-section" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" data-toggle="hist-control">
                <h4 style="margin:0;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">Histórico controles</h4>
                <span style="font-size:.65rem;opacity:.7;" data-icon="hist-control">▼</span>
              </div>
              <div data-body="hist-control" style="display:none;margin-top:6px;">
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;align-items:center;">
                  <div style="display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-filtro-control="all">Todos</button>
                    <button type="button" class="mini-btn" data-filtro-control="12m">12m</button>
                    <button type="button" class="mini-btn" data-filtro-control="6m">6m</button>
                  </div>
                  <div style="margin-left:auto;display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-export="controls" title="Exportar controles">⬇️ XLSX</button>
                  </div>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:.62rem;">
                  <thead>
                    <tr style="background:#f1f5f9;">
                      <th style="padding:4px;">Fecha</th><th style="padding:4px;">PSIS/PDIA</th><th style="padding:4px;">IMC</th><th style="padding:4px;">Clas IMC</th><th style="padding:4px;">HTA</th><th style="padding:4px;">Peso</th><th style="padding:4px;">Talla</th><th style="padding:4px;">CC</th><th style="padding:4px;">HGT</th><th style="padding:4px;">HbA1c</th><th style="padding:4px;">Δ</th>
                    </tr>
                  </thead>
                  <tbody id="hist-control-tbody"><tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div data-panel="examenes" hidden style="padding:8px;">
          <div id="panel-examenes" style="font-size:.72rem;line-height:1.3;display:flex;flex-direction:column;gap:6px;">
            <div style="opacity:.6;">Seleccione RUN para mostrar últimos exámenes de laboratorio.</div>
            <form id="form-lab-nuevo" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;align-items:end;background:#f8fafc;padding:8px;border:1px solid #e2e8f0;border-radius:8px;font-size:.6rem;">
              <div style="grid-column:1/-1;font-size:.6rem;font-weight:600;opacity:.8;">Nuevo laboratorio rápido</div>
              <label style="display:flex;flex-direction:column;gap:2px;">Fecha
                <input type="date" name="examen_fecha" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">Glicemia
                <input type="number" step="0.1" name="glicemia" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">HbA1c
                <input type="number" step="0.1" name="hba1c" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">LDL
                <input type="number" step="0.1" name="ldl" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">HDL
                <input type="number" step="0.1" name="hdl" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">Col
                <input type="number" step="0.1" name="col" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">TAG
                <input type="number" step="0.1" name="tag" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">Creat
                <input type="number" step="0.01" name="creatinemia" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">VFG
                <input type="number" step="1" name="vfg" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">RAC
                <input type="number" step="0.1" name="rac" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">MicroAlb
                <input type="number" step="0.1" name="microalbuminuria_val" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">TSH
                <input type="number" step="0.01" name="tsh" style="padding:4px;font-size:.65rem;" />
              </label>
              <div style="display:flex;gap:6px;align-items:center;">
                <button type="submit" class="btn btn-verde" style="font-size:.6rem;padding:6px 10px;">Guardar</button>
                <span id="estado-lab" style="font-size:.55rem;opacity:.85;"></span>
              </div>
            </form>
            <div id="examenes-tabla-wrapper" style="overflow-x:auto;">
              <table id="tabla-labs" style="border-collapse:collapse;min-width:620px;display:none;">
                <thead>
                  <tr style="background:#f1f5f9;">
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Parámetro</th>
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Valor</th>
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Fecha</th>
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Anotaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="historico-labs" class="hist-section" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" data-toggle="hist-labs">
                <h4 style="margin:0;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">Histórico laboratorios</h4>
                <span style="font-size:.65rem;opacity:.7;" data-icon="hist-labs">▼</span>
              </div>
              <div data-body="hist-labs" style="display:none;margin-top:6px;overflow-x:auto;">
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;align-items:center;">
                  <div style="display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-filtro-labs="all">Todos</button>
                    <button type="button" class="mini-btn" data-filtro-labs="12m">12m</button>
                    <button type="button" class="mini-btn" data-filtro-labs="6m">6m</button>
                  </div>
                  <div style="margin-left:auto;display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-export="labs" title="Exportar labs">⬇️ XLSX</button>
                  </div>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:.6rem;min-width:820px;">
                  <thead>
                    <tr style="background:#f1f5f9;">
                      <th style="padding:4px;">Fecha</th><th style="padding:4px;">Glic</th><th style="padding:4px;">HbA1c</th><th style="padding:4px;">LDL</th><th style="padding:4px;">HDL</th><th style="padding:4px;">Col</th><th style="padding:4px;">TAG</th><th style="padding:4px;">Creat</th><th style="padding:4px;">VFG</th><th style="padding:4px;">ERC</th><th style="padding:4px;">RAC</th><th style="padding:4px;">MicroAlb</th><th style="padding:4px;">TSH</th><th style="padding:4px;">Δ</th>
                    </tr>
                  </thead>
                  <tbody id="hist-labs-tbody"><tr><td colspan="14" style="padding:6px;opacity:.6;">Sin datos</td></tr></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
        <div data-panel="acuerdos" hidden style="padding:8px;">
          <div id="panel-acuerdos" style="font-size:.7rem;display:grid;gap:6px;">
            <div id="acuerdo-ultimo" style="padding:6px;border:1px solid #e2e8f0;border-radius:6px;font-size:.68rem;">Sin datos</div>
            
            <!-- Formulario Nuevo Acuerdo -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f8fafc;">
              <h4 style="margin:0 0 8px;font-size:.75rem;color:#374151;text-transform:uppercase;letter-spacing:.5px;">📝 Nuevo Acuerdo</h4>
              <form id="form-acuerdo-nuevo" style="display:grid;gap:8px;">
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;">
                  <label style="font-size:.7rem;font-weight:500;">Fecha:</label>
                  <input type="date" name="fecha" id="acuerdo_fecha" style="padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;" value="">
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;">
                  <label style="font-size:.7rem;font-weight:500;">Acuerdos:</label>
                  <textarea name="acuerdos" placeholder="Descripción de los acuerdos establecidos..." 
                    style="padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;min-height:60px;resize:vertical;"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;">
                  <label style="font-size:.7rem;font-weight:500;">Cumplimiento:</label>
                  <select name="cumplimiento" style="padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;">
                    <option value="">-- Seleccionar --</option>
                    <option value="inicio de acuerdos consensuados">Inicio de acuerdos consensuados (Pendiente)</option>
                    <option value="cumple">Cumple</option>
                    <option value="cumple parcialmente">Cumple parcialmente</option>
                    <option value="no cumple">No cumple</option>
                  </select>
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;">
                  <label style="font-size:.7rem;font-weight:500;">Observaciones:</label>
                  <textarea name="observaciones" placeholder="Observaciones adicionales (opcional)..." 
                    style="padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;min-height:40px;resize:vertical;"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;">
                  <label style="font-size:.7rem;font-weight:500;">Profesional:</label>
                  <input type="text" name="funcionario" placeholder="Nombre del profesional" 
                    style="padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;">
                </div>
                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                  <button type="button" onclick="document.getElementById('form-acuerdo-nuevo').reset()" 
                    style="padding:6px 12px;background:#6b7280;color:white;border:none;border-radius:4px;font-size:.7rem;cursor:pointer;">
                    Limpiar
                  </button>
                  <button type="submit" 
                    style="padding:6px 12px;background:#059669;color:white;border:none;border-radius:4px;font-size:.7rem;cursor:pointer;">
                    Guardar
                  </button>
                </div>
                <div id="estado-acuerdo" style="font-size:.65rem;margin-top:4px;"></div>
              </form>
            </div>
            
            <div id="historico-acuerdos" class="hist-section" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" data-toggle="hist-acuerdos">
                <h4 style="margin:0;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">Histórico acuerdos</h4>
                <span style="font-size:.65rem;opacity:.7;" data-icon="hist-acuerdos">▼</span>
              </div>
              <div data-body="hist-acuerdos" style="display:none;margin-top:6px;">
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;align-items:center;">
                  <div style="margin-left:auto;display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-export="acuerdos" title="Exportar acuerdos">⬇️ XLSX</button>
                  </div>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:.62rem;">
                  <thead>
                    <tr style="background:#f1f5f9;">
                      <th style="padding:4px;">Fecha</th><th style="padding:4px;">Acuerdos</th><th style="padding:4px;">Cumpl.</th><th style="padding:4px;">Obs</th>
                    </tr>
                  </thead>
                  <tbody id="hist-acuerdos-tbody"><tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div data-panel="funcionalidad" hidden style="padding:8px;">
          <!-- Contenido de Evaluación Adulto Mayor -->
          <h3 style="margin:0 0 8px;font-size:.95rem;display:flex;align-items:center;gap:6px;background:#f1f5f9;border-bottom:1px solid #e2e8f0;padding:8px 8px 4px;">👴 Evaluación Adulto Mayor</h3>
          
          <!-- Formulario de Evaluación Adulto Mayor -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
            <form id="adultoMayorForm" style="display:grid;gap:16px;">
              
              <!-- Primera fila: Fecha y Funcionalidad -->
              <div style="display:grid;grid-template-columns:1fr 2fr;gap:16px;">
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    📅 Fecha de Evaluación
                  </label>
                  <input type="date" id="fechaEvaluacionAM" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:.85rem;" required>
                </div>
                
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    🏃 Funcionalidad
                  </label>
                  <select id="funcionalidadAM" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:.85rem;" required>
                    <option value="">Seleccionar...</option>
                    <option value="autovalente">Autovalente</option>
                    <option value="autovalente_con_riesgo">Autovalente con Riesgo</option>
                    <option value="riesgo_dependencia">Riesgo de Dependencia</option>
                    <option value="dependencia_leve">Dependencia Leve</option>
                    <option value="dependencia_moderada">Dependencia Moderada</option>
                    <option value="dependencia_total">Dependencia Total</option>
                  </select>
                </div>
              </div>
              
              <!-- Segunda fila: Test TUG -->
              <div style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;background:#ffffff;">
                <h5 style="margin:0 0 12px;font-size:.85rem;color:#374151;font-weight:600;">⏱️ Test TUG (Tiempo de apoyo en un pie)</h5>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Tiempo (segundos)
                    </label>
                    <input type="number" id="tugSegundos" step="0.01" min="0" max="999" 
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;"
                           placeholder="Ej: 12.5">
                  </div>
                  
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Clasificación
                    </label>
                    <input type="text" id="tugClasificacion" readonly 
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;background:#f9fafb;color:#6b7280;">
                  </div>
                </div>
                
                <!-- Tabla de interpretación TUG -->
                <div style="margin-top:12px;font-size:.7rem;">
                  <strong>📊 Interpretación:</strong>
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:6px;text-align:center;">
                    <div style="padding:4px;background:#dcfce7;border-radius:4px;">≤ 10s: <strong>Bajo riesgo</strong></div>
                    <div style="padding:4px;background:#fef3c7;border-radius:4px;">11-19s: <strong>Riesgo leve</strong></div>
                    <div style="padding:4px;background:#fecaca;border-radius:4px;">≥ 20s: <strong>Alto riesgo</strong></div>
                  </div>
                </div>
              </div>
              
              <!-- Tercera fila: Test Unipodal -->
              <div style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;background:#ffffff;">
                <h5 style="margin:0 0 12px;font-size:.85rem;color:#374151;font-weight:600;">🦶 Test Estación Unipodal</h5>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      🦶 Pie Derecho (seg)
                    </label>
                    <input type="number" id="unipodalPieDerecho" step="0.01" min="0" max="999"
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;"
                           placeholder="Ej: 25.0">
                  </div>
                  
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      🦶 Pie Izquierdo (seg)
                    </label>
                    <input type="number" id="unipodalPieIzquierdo" step="0.01" min="0" max="999"
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;"
                           placeholder="Ej: 28.0">
                  </div>
                  
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Clasificación
                    </label>
                    <input type="text" id="unipodalClasificacion" readonly
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;background:#f9fafb;color:#6b7280;">
                  </div>
                </div>
                
                <!-- Tabla de interpretación Unipodal -->
                <div style="margin-top:12px;font-size:.7rem;">
                  <strong>📊 Interpretación:</strong>
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:6px;text-align:center;">
                    <div style="padding:4px;background:#fecaca;border-radius:4px;">&lt; 5s: <strong>Alto riesgo</strong></div>
                    <div style="padding:4px;background:#fef3c7;border-radius:4px;">5-30s: <strong>Riesgo intermedio</strong></div>
                    <div style="padding:4px;background:#dcfce7;border-radius:4px;">≥ 30s: <strong>Bajo riesgo</strong></div>
                  </div>
                </div>
              </div>
              
              <!-- Campo de observaciones -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  📝 Observaciones
                </label>
                <textarea id="observacionesAM" rows="3" 
                          style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;resize:vertical;"
                          placeholder="Observaciones adicionales sobre la evaluación..."></textarea>
              </div>
              
              <!-- Botones de acción -->
              <div style="display:flex;gap:12px;margin-top:8px;">
                <button type="button" onclick="guardarEvaluacionAdultoMayor()" class="btn" 
                        style="background:#059669;color:white;border:1px solid #047857;padding:10px 16px;font-size:.85rem;">
                  💾 Guardar Evaluación
                </button>
                <button type="button" onclick="limpiarFormularioAdultoMayor()" class="btn btn-outlined" 
                        style="padding:10px 16px;font-size:.85rem;">
                  🧹 Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de evaluaciones -->
            <div id="historialAdultoMayor" style="margin-top:20px;display:none;">
              <h5 style="margin:0 0 12px;font-size:.85rem;color:#374151;font-weight:600;">
                📋 Historial de Evaluaciones
              </h5>
              <div id="listHistorialAdultoMayor" style="max-height:300px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- El historial se carga dinámicamente aquí -->
              </div>
            </div>
          </div>
          
          <!-- Sección de Actividad Física -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;margin-top:12px;">
            <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
              🏃‍♂️ Actividad Física
            </h4>
            
            <form id="actividadFisicaForm" style="display:grid;gap:10px;">
              <!-- ¿Realiza actividad física? -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  ¿Realiza actividad física?
                </label>
                <div style="display:flex;gap:12px;">
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="actividadFisica" value="si" required>
                    Sí
                  </label>
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="actividadFisica" value="no" required>
                    No
                  </label>
                </div>
              </div>
              
              <!-- Fecha de evaluación -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  Fecha de evaluación
                </label>
                <input type="date" id="fechaActividadFisica" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
              </div>
              
              <!-- Botones de acción -->
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="guardarActividadFisica()" class="btn" style="font-size:.75rem;background:#16a34a;color:white;border:1px solid #15803d;padding:6px 12px;">
                  💾 Guardar
                </button>
                <button type="button" onclick="limpiarFormularioActividadFisica()" class="btn btn-outlined" style="font-size:.75rem;">
                  Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de actividad física -->
            <div id="historialActividadFisica" style="margin-top:16px;display:none;">
              <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                📋 Historial de Actividad Física
              </h5>
              <div id="listHistorialActividadFisica" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- Se carga dinámicamente -->
              </div>
            </div>
          </div>
          
          <!-- Sección de MasAma -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;margin-top:12px;">
            <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
              🔍 MasAma
            </h4>
            
            <form id="masAmaForm" style="display:grid;gap:10px;">
              <!-- ¿MasAma positivo? -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  ¿MasAma positivo?
                </label>
                <div style="display:flex;gap:12px;">
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="masAma" value="si" required>
                    Sí
                  </label>
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="masAma" value="no" required>
                    No
                  </label>
                </div>
              </div>
              
              <!-- Fecha de evaluación -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  Fecha de evaluación
                </label>
                <input type="date" id="fechaMasAma" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
              </div>
              
              <!-- Botones de acción -->
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="guardarMasAma()" class="btn" style="font-size:.75rem;background:#3b82f6;color:white;border:1px solid #2563eb;padding:6px 12px;">
                  💾 Guardar
                </button>
                <button type="button" onclick="limpiarFormularioMasAma()" class="btn btn-outlined" style="font-size:.75rem;">
                  Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de MasAma -->
            <div id="historialMasAma" style="margin-top:16px;display:none;">
              <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                📋 Historial de MasAma
              </h5>
              <div id="listHistorialMasAma" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- Se carga dinámicamente -->
              </div>
            </div>
          </div>
        </div>
        </div>
  <div data-panel="diabetes" hidden style="padding:8px 10px 12px;">
          <!-- Contenido completo de Evaluación Diabetes -->
          <h3 style="margin:0 0 8px;font-size:.95rem;display:flex;align-items:center;gap:6px;font-weight:600;">🩺 Evaluación Diabetes</h3>
          
          <!-- Primera fila: Evaluación Pie Diabético + Comorbilidad/Secuelas -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Evaluación Pie Diabético -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                🦶 Evaluación Pie Diabético
              </h4>
            
              <form id="evaluacionPieDiabeticoForm" style="display:grid;gap:10px;">
                <!-- ¿Tiene amputación o úlcera activa? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Tiene amputación o úlcera activa?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ulceraPieOAmputacion" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ulceraPieOAmputacion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¿Sensibilidad protectora alterada? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Sensibilidad protectora alterada?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="sensibilidadProtectora" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="sensibilidadProtectora" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¿Enfermedad arterial periférica? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Enfermedad arterial periférica?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="EAP" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="EAP" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¿Tiene deformidad? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Tiene deformidad?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="DEF" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="DEF" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluación -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluación
                  </label>
                  <input type="date" id="fechaEvaluacionPieDiabetico" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="evaluarRiesgoPieDiabetico()" class="btn btn-azul" style="font-size:.75rem;">
                    Evaluar Riesgo
                  </button>
                  <button type="button" id="btnGuardarPieDiabetico" onclick="guardarEvaluacionPieDiabetico()" class="btn" style="font-size:.75rem;display:none;background:#16a34a;color:white;border:1px solid #15803d;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioPieDiabetico()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
                
                <!-- Resultado -->
                <div id="resultadoPieDiabetico" class="espacioresultado" style="margin-top:12px;padding:12px;border-radius:6px;background:#f1f5f9;border:1px solid #cbd5e1;display:none;">
                  <div class="resultado-contenido" style="font-size:.8rem;line-height:1.4;"></div>
                </div>
              </form>
              
              <!-- Historial de evaluaciones -->
              <div id="historialPieDiabetico" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de Evaluaciones
                </h5>
                <div id="listHistorialPieDiabetico" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Comorbilidad/Secuelas -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                📊 Comorbilidad / Secuelas
              </h4>
              
              <!-- Panel de diagnósticos detectados -->
              <div id="comorbilidadPanel" style="display:grid;gap:10px;">
                <!-- Estado de carga -->
                <div id="comorbilidadEstado" style="padding:8px;text-align:center;color:#6b7280;font-size:0.75rem;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;">
                  <span>Analizando diagnósticos...</span>
                </div>
                
                <!-- Contenedor de diagnósticos -->
                <div id="diagnosticosDetectados" style="display:none;gap:8px;">
                  <!-- Diagnósticos se activan dinámicamente -->
                  <div id="diagnosticoTabaquismo" style="display:none;padding:10px 12px;border:1px solid #f97316;border-radius:6px;background:linear-gradient(135deg,#fff7ed,#ffedd5);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">🚬</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#9a3412;">Tabaquismo activo</div>
                          <div style="font-size:0.7rem;color:#9a3412;">Priorizar consejería y tratamiento de cesación</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#9a3412;background:#fdba74;padding:2px 6px;border-radius:999px;">Riesgo CV</span>
                    </div>
                  </div>

                  <div id="diagnosticoErcLeve" style="display:none;padding:10px 12px;border:1px solid #0ea5e9;border-radius:6px;background:linear-gradient(135deg,#eff6ff,#dbeafe);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">🧪</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#1d4ed8;">ERC leve-moderada</div>
                          <div style="font-size:0.7rem;color:#1d4ed8;">Monitorear función renal y albuminuria</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#1d4ed8;background:#bfdbfe;padding:2px 6px;border-radius:999px;">Nefroprotección</span>
                    </div>
                  </div>

                  <div id="diagnosticoErcAvanzada" style="display:none;padding:10px 12px;border:1px solid #2563eb;border-radius:6px;background:linear-gradient(135deg,#e0f2ff,#bfdbfe);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">🩺</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#1e3a8a;">ERC avanzada</div>
                          <div style="font-size:0.7rem;color:#1e3a8a;">Coordinar con nefrología y ajustar plan terapéutico</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#1e3a8a;background:#93c5fd;padding:2px 6px;border-radius:999px;">Alerta</span>
                    </div>
                  </div>

                  <div id="diagnosticoAcv" style="display:none;padding:10px 12px;border:1px solid #f97316;border-radius:6px;background:linear-gradient(135deg,#fff7ed,#fffbeb);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">🧠</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#b45309;">Antecedente de ACV/AVE</div>
                          <div style="font-size:0.7rem;color:#b45309;">Optimizar prevención secundaria y control de factores</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#b45309;background:#fcd34d;padding:2px 6px;border-radius:999px;">Prioridad alta</span>
                    </div>
                  </div>

                  <div id="diagnosticoIam" style="display:none;padding:10px 12px;border:1px solid #dc2626;border-radius:6px;background:linear-gradient(135deg,#fef2f2,#fee2e2);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">❤️</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#991b1b;">Antecedente de IAM</div>
                          <div style="font-size:0.7rem;color:#991b1b;">Revisar antiagregación, estatinas e IECA/ARA II</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#991b1b;background:#fecaca;padding:2px 6px;border-radius:999px;">Cardiología</span>
                    </div>
                  </div>

                  <div id="diagnosticoInsulina" style="display:none;padding:10px 12px;border:1px solid #6366f1;border-radius:6px;background:linear-gradient(135deg,#eef2ff,#e0e7ff);">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                      <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:1.1rem;">💉</span>
                        <div>
                          <div style="font-size:0.8rem;font-weight:600;color:#4338ca;">Uso activo de insulina</div>
                          <div style="font-size:0.7rem;color:#4338ca;">Coordinar controles y educación en manejo de hipoglicemias</div>
                        </div>
                      </div>
                      <span style="font-size:0.7rem;font-weight:600;color:#4338ca;background:#c7d2fe;padding:2px 6px;border-radius:999px;">Seguimiento</span>
                    </div>
                  </div>

                  <div id="recomendacionIecaAra" style="display:none;padding:10px 12px;border:1px dashed #1d4ed8;border-radius:6px;background:#eff6ff;color:#1d4ed8;font-size:0.75rem;line-height:1.4;">
                    💡 Recomendación: evaluar IECA/ARA II por nefroprotección y control de presión arterial.
                  </div>
                </div>

                <div id="sinDiagnosticos" style="display:none;padding:12px;text-align:center;border:1px solid #e5e7eb;border-radius:6px;background:#f8fafc;color:#475569;font-size:0.75rem;">
                  ✅ Sin comorbilidades o secuelas relevantes detectadas para diabetes.
                </div>
              </div>
            </div>
          </div>
          
          <!-- Segunda fila: Curaciones + EKG -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Curaciones Pie Diabético -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                🩹 Curaciones Pie Diabético
              </h4>
              
              <form id="curacionesPieDiabeticoForm" style="display:grid;gap:10px;">
                <!-- ¿Se encuentra en curaciones? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Se encuentra en curaciones?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="enCuracion" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="enCuracion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Tipo de curación (solo si está en curaciones) -->
                <div id="tipoCuracionContainer" style="display:none;">
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Tipo de curación
                  </label>
                  <select id="tipoCuracion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                    <option value="">-- Seleccione tipo --</option>
                    <option value="Curación Convencional">Curación Convencional</option>
                    <option value="Curación Avanzada">Curación Avanzada</option>
                    <option value="Con ayuda técnica de descarga">Con ayuda técnica de descarga</option>
                  </select>
                </div>
                
                <!-- Fecha -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha
                  </label>
                  <input type="date" id="fechaCuracion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarCuracion()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioCuraciones()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de curaciones -->
              <div id="historialCuraciones" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de Curaciones
                </h5>
                <div id="listHistorialCuraciones" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de EKG -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ⚡ Electrocardiograma (EKG)
              </h4>
              
              <form id="ekgForm" style="display:grid;gap:10px;">
                <!-- ¿Se realizó EKG? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Se realizó EKG?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ekgRealizado" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ekgRealizado" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha del EKG -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha del EKG
                  </label>
                  <input type="date" id="fechaEkg" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarEkg()" class="btn" style="font-size:.75rem;background:#7c3aed;color:white;border:1px solid #6d28d9;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioEkg()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de EKG -->
              <div id="historialEkg" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de EKG
                </h5>
                <div id="listHistorialEkg" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tercera fila: Hipoglicemias + Amputación -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Hipoglicemias Recurrentes -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                🩸 Hipoglicemias Recurrentes
              </h4>
              
              <form id="hipoglicemiasForm" style="display:grid;gap:10px;">
                <!-- ¿Presenta hipoglicemias recurrentes? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Presenta hipoglicemias recurrentes?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="hipoglicemiasRecurrentes" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="hipoglicemiasRecurrentes" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluación -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluación
                  </label>
                  <input type="date" id="fechaHipoglicemias" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarHipoglicemias()" class="btn" style="font-size:.75rem;background:#dc2626;color:white;border:1px solid #b91c1c;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioHipoglicemias()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de hipoglicemias -->
              <div id="historialHipoglicemias" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de Hipoglicemias
                </h5>
                <div id="listHistorialHipoglicemias" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Amputación -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                🦿 Amputación
              </h4>
              
              <form id="amputacionForm" style="display:grid;gap:10px;">
                <!-- ¿Tiene amputación? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Tiene amputación?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="tieneAmputacion" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="tieneAmputacion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de amputación -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de amputación
                  </label>
                  <input type="date" id="fechaAmputacion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarAmputacion()" class="btn" style="font-size:.75rem;background:#f59e0b;color:white;border:1px solid #d97706;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioAmputacion()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de amputación -->
              <div id="historialAmputacion" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de Amputación
                </h5>
                <div id="listHistorialAmputacion" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Cuarta fila: Atención Podóloga + Fondo de Ojos -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <!-- Tarjeta de Atención Podóloga -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                🦶 Atención Podóloga
              </h4>
              
              <form id="podologiaForm" style="display:grid;gap:10px;">
                <!-- ¿Tiene atención podológica vigente? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Tiene atención podológica vigente?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="atencionPodologa" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="atencionPodologa" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluación -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluación
                  </label>
                  <input type="date" id="fechaPodologia" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarPodologia()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioPodologia()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de atención podológica -->
              <div id="historialPodologia" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de Atención Podológica
                </h5>
                <div id="listHistorialPodologia" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Fondo de Ojos -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;">
              <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                👁️ Fondo de Ojos
              </h4>
              
              <form id="fondoOjosForm" style="display:grid;gap:10px;">
                <!-- ¿Se realizó fondo de ojos? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¿Se realizó fondo de ojos?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="fondoOjos" value="si" required>
                      Sí
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="fondoOjos" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha del fondo de ojos -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha del fondo de ojos
                  </label>
                  <input type="date" id="fechaFondoOjos" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarFondoOjos()" class="btn" style="font-size:.75rem;background:#9333ea;color:white;border:1px solid #7c2d12;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioFondoOjos()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de fondo de ojos -->
              <div id="historialFondoOjos" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de Fondo de Ojos
                </h5>
                <div id="listHistorialFondoOjos" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
          </div>
        </div>
  <div data-panel="farmacos" hidden style="padding:8px 10px 12px;">
          <!-- Contenido de fármacos -->
          <h3 style="margin:0 0 8px;font-size:.95rem;display:flex;align-items:center;gap:6px;font-weight:600;">💊 Fármacos</h3>
          <!-- Grid de fármacos en filas -->
          <div style="display:grid;gap:10px;padding:8px;">
            
            <!-- Primera fila: IECA/ARA II -->
            <div id="seccionIecaAra" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;display:none;">
              <h4 style="margin:0 0 12px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                🩺 IECA / ARA II
                <span style="cursor:help;color:#6b7280;font-size:1rem;" title="Los IECA (Inhibidores de la Enzima Convertidora de Angiotensina) y los ARA II (Antagonistas del Receptor de Angiotensina II) son dos grupos de medicamentos que actúan sobre el sistema renina-angiotensina-aldosterona, fundamentales en el manejo de la hipertensión arterial, la insuficiencia cardíaca, la nefroprotección en diabetes/ERCT y la prevención cardiovascular.

Aunque ambos reducen la acción de la angiotensina II (potente vasoconstrictor), lo hacen por mecanismos distintos:
• 🩺 IECA: bloquean la conversión de angiotensina I en angiotensina II.
• 🩺 ARA II: bloquean directamente el receptor AT1 de la angiotensina II.

🧪 Lista de medicamentos más usados

🩹 IECA (Inhibidores de la ECA)
• Enalapril (Enalapril®, Renitec®) - Muy utilizado en HTA y falla cardíaca
• Captopril (Capoten®) - Acción corta; útil en urgencias hipertensivas orales
• Lisinopril (Zestril®, Prinivil®) - Alta duración, uso diario
• Ramipril (Tritace®) - Cardioprotector y nefroprotector
• Perindopril (Coversyl®) - Muy usado en prevención secundaria CV

💊 ARA II (Antagonistas del receptor de angiotensina II)
• Losartán (Cozaar®) - Muy usado en HTA y nefroprotección diabética
• Valsartán (Diovan®) - Cardioprotector post-IAM
• Candesartán (Atacand®) - Alta potencia y duración
• Irbesartán (Aprovel®) - Excelente opción renal y CV
• Olmesartán (Benicar®) - Larga acción, buen control 24 h

🧠 Perlas clínicas:
• Nunca se combinan IECA y ARA II juntos salvo indicaciones muy específicas
• En diabéticos con microalbuminuria o ERC, IECA o ARA II son primera línea
• En insuficiencia cardíaca con FEVI reducida, suelen ser parte del esquema base">ℹ️</span>
              </h4>
              
              <form id="iecaAraForm" style="display:grid;gap:12px;">
                <!-- Tipo de medicación -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Tipo de medicación
                  </label>
                  <select id="tipoIecaAra" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;" required>
                    <option value="">-- Seleccione --</option>
                    <option value="NO">NO</option>
                    <option value="IECA">IECA</option>
                    <option value="ARA II">ARA II</option>
                  </select>
                </div>
                
                <!-- Fecha -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha
                  </label>
                  <input type="date" id="fechaIecaAra" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acción -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarIecaAra()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    💾 Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioIecaAra()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de IECA/ARA II -->
              <div id="historialIecaAra" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  📋 Historial de IECA/ARA II
                </h5>
                <div id="listHistorialIecaAra" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </div>
            
            <!-- Segunda fila: Estatinas + Antiagregante plaquetario -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
              <!-- Tarjeta de Estatinas -->
              <div id="seccionEstatinas" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;display:none;">
                <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  🧪 Estatinas
                </h4>
                
                <form id="estatinasForm" style="display:grid;gap:10px;">
                  <!-- ¿Recibe estatinas? -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ¿Recibe estatinas?
                    </label>
                    <div style="display:flex;gap:12px;">
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeEstatinas" value="si" required>
                        Sí
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeEstatinas" value="no" required>
                        No
                      </label>
                    </div>
                  </div>
                  
                  <!-- Fecha -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Fecha
                    </label>
                    <input type="date" id="fechaEstatinas" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                  </div>
                  
                  <!-- Botones de acción -->
                  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                    <button type="button" onclick="guardarEstatinas()" class="btn" style="font-size:.75rem;background:#7c3aed;color:white;border:1px solid #6d28d9;padding:6px 12px;">
                      💾 Guardar
                    </button>
                    <button type="button" onclick="limpiarFormularioEstatinas()" class="btn btn-outlined" style="font-size:.75rem;">
                      Limpiar
                    </button>
                  </div>
                </form>
                
                <!-- Historial de estatinas -->
                <div id="historialEstatinas" style="margin-top:16px;display:none;">
                  <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                    📋 Historial de Estatinas
                  </h5>
                  <div id="listHistorialEstatinas" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                    <!-- Se carga dinámicamente -->
                  </div>
                </div>
              </div>
              
              <!-- Tarjeta de Antiagregante plaquetario -->
              <div id="seccionAntiagregantes" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f9fafb;display:none;">
                <h4 style="margin:0 0 10px;font-size:.85rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  🩸 Antiagregante Plaquetario
                </h4>
                
                <form id="antiagregantesForm" style="display:grid;gap:10px;">
                  <!-- ¿Recibe antiagregantes? -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ¿Recibe antiagregante plaquetario?
                    </label>
                    <div style="display:flex;gap:12px;">
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeAntiagregantes" value="si" required>
                        Sí
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeAntiagregantes" value="no" required>
                        No
                      </label>
                    </div>
                  </div>
                  
                  <!-- Fecha -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Fecha
                    </label>
                    <input type="date" id="fechaAntiagregantes" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                  </div>
                  
                  <!-- Botones de acción -->
                  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                    <button type="button" onclick="guardarAntiagregantes()" class="btn" style="font-size:.75rem;background:#dc2626;color:white;border:1px solid #b91c1c;padding:6px 12px;">
                      💾 Guardar
                    </button>
                    <button type="button" onclick="limpiarFormularioAntiagregantes()" class="btn btn-outlined" style="font-size:.75rem;">
                      Limpiar
                    </button>
                  </div>
                </form>
                
                <!-- Historial de antiagregantes -->
                <div id="historialAntiagregantes" style="margin-top:16px;display:none;">
                  <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                    📋 Historial de Antiagregantes
                  </h5>
                  <div id="listHistorialAntiagregantes" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                    <!-- Se carga dinámicamente -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
  <div data-panel="adulto_mayor" hidden style="padding:8px 10px 12px;">
          <!-- Panel de Screening dentro de Evaluación Adulto Mayor -->
          <div style="display:grid;gap:12px;">
            
            <!-- Sección Vacunas -->
            <section class="card" style="padding:12px;">
              <h3 style="margin:0 0 10px;font-size:.9rem;display:flex;align-items:center;gap:6px;">
                💉 Vacunas
              </h3>
              
              <!-- Vacuna Influenza -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#f9fafb;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">🦠 Vacuna Influenza</h4>
                <form id="formVacunaInfluenzaAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaInfluenzaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Estado:</label>
                  <select id="estadoInfluenzaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="SI">Sí</option>
                    <option value="NO">No</option>
                    <option value="RECHAZA">Rechaza</option>
                  </select>
                  
                  <button type="button" onclick="guardarVacuna('influenza')" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar Influenza
                  </button>
                </form>
              </div>
              
              <!-- Vacuna COVID -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#f9fafb;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">🦠 Vacuna COVID</h4>
                <form id="formVacunaCovidAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaCovidAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Estado:</label>
                  <select id="estadoCovidAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="SI">Sí</option>
                    <option value="NO">No</option>
                    <option value="RECHAZA">Rechaza</option>
                  </select>
                  
                  <button type="button" onclick="guardarVacuna('covid')" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar COVID
                  </button>
                </form>
              </div>
              
              <!-- Historial de Vacunas -->
              <div id="historialVacunasAM" style="display:none;margin-top:10px;">
                <h4 style="margin:0 0 6px;font-size:.85rem;color:#1e293b;">📋 Historial de Vacunación</h4>
                <div id="listaHistorialVacunasAM" style="max-height:180px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;">
                  <!-- Se carga dinámicamente -->
                </div>
              </div>
            </section>
            
            <!-- Sección Screening por Género -->
            <section class="card" style="padding:12px;">
              <h3 style="margin:0 0 10px;font-size:.9rem;display:flex;align-items:center;gap:6px;">
                🔍 Screening por Género
              </h3>
              
              <!-- PAP (Mujeres 25-64 años) -->
              <div id="seccionPAPAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#fef7f7;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">👩‍⚕️ PAP (Mujeres 25-64 años)</h4>
                <form id="formPAPAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaPAPAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Realizado:</label>
                  <select id="estadoPAPAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="true">Sí</option>
                    <option value="false">No</option>
                  </select>
                  
                  <label style="font-size:.85rem;font-weight:600;">Resultado:</label>
                  <input type="text" id="resultadoPAPAM" placeholder="Resultado del PAP" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <button type="button" onclick="guardarPAP()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar PAP
                  </button>
                </form>
                
                <!-- Historial PAP -->
                <div id="historialPAPAM" style="display:none;margin-top:10px;">
                  <h5 style="margin:0 0 5px;font-size:.75rem;color:#374151;">Historial PAP</h5>
                  <div id="listaHistorialPAPAM" style="max-height:130px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.75rem;">
                    <!-- Se carga dinámicamente -->
                  </div>
                </div>
              </div>
              
              <!-- Mamografía (Mujeres 50-69 años) -->
              <div id="seccionMamografiaAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin-bottom:12px;background:#fef7f7;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">🩻 Mamografía (Mujeres 50-69 años)</h4>
                <form id="formMamografiaAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Realizada:</label>
                  <select id="estadoMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="true">Sí</option>
                    <option value="false">No</option>
                  </select>
                  
                  <label style="font-size:.85rem;font-weight:600;">BI-RADS:</label>
                  <select id="biradsMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="0">0 - Incompleta</option>
                    <option value="1">1 - Negativa</option>
                    <option value="2">2 - Benigna</option>
                    <option value="3">3 - Probablemente benigna</option>
                    <option value="4">4 - Sospechosa</option>
                    <option value="5">5 - Altamente sugestiva</option>
                    <option value="6">6 - Malignidad conocida</option>
                  </select>
                  
                  <button type="button" onclick="guardarMamografia()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar Mamografía
                  </button>
                </form>
                
                <!-- Historial Mamografía -->
                <div id="historialMamografiaAM" style="display:none;margin-top:10px;">
                  <h5 style="margin:0 0 5px;font-size:.75rem;color:#374151;">Historial Mamografía</h5>
                  <div id="listaHistorialMamografiaAM" style="max-height:130px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.75rem;">
                    <!-- Se carga dinámicamente -->
                  </div>
                </div>
              </div>
              
              <!-- PSA (Hombres ≥50 años) -->
              <div id="seccionPSAAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f0f9ff;">
                <h4 style="margin:0 0 8px;font-size:.85rem;color:#1e293b;">👨‍⚕️ PSA (Hombres ≥50 años)</h4>
                <form id="formPSAAM" style="display:grid;gap:10px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaPSAAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Valor PSA:</label>
                  <input type="number" id="valorPSAAM" placeholder="ng/mL" step="0.01" min="0" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <button type="button" onclick="guardarPSA()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar PSA
                  </button>
                </form>
                
                <!-- Historial PSA -->
                <div id="historialPSAAM" style="display:none;margin-top:10px;">
                  <h5 style="margin:0 0 5px;font-size:.75rem;color:#374151;">Historial PSA</h5>
                  <div id="listaHistorialPSAAM" style="max-height:130px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.75rem;">
                    <!-- Se carga dinámicamente -->
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<script id="riesgo-cv-script">
(function(){
  const fechaInput = document.getElementById('riesgo_cv_fecha');
  const nivelSelect = document.getElementById('riesgo_cv_nivel');
  const btnGuardar = document.getElementById('btn-guardar-riesgo-cv');
  const estado = document.getElementById('estado-riesgo-cv');
  const spanUltimo = document.getElementById('ultimo-riesgo-cv');
  const spanUltimoFecha = document.getElementById('ultimo-riesgo-cv-fecha');
  const resumenCategoria = document.querySelector('#resumen-ident .categoria-riesgo');

  function hoyISO(){
    const d=new Date();
    return d.toISOString().slice(0,10);
  }
  if (fechaInput && !fechaInput.value) fechaInput.value = hoyISO();

  async function cargarRiesgoCV(run){
    if(!run){ return; }
    try{
      if(estado){ estado.textContent='Cargando…'; }
      const resp = await fetch(`/api/riesgo-cv/ultimo/${encodeURIComponent(run)}`);
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok || data.ok === false){
        throw new Error(data.error || `HTTP ${resp.status}`);
      }
      const info = data.riesgo_cv || null;
      if(info){
        if(spanUltimo){ spanUltimo.textContent = (info.riesgo || '—').toUpperCase(); }
        if(spanUltimoFecha){ spanUltimoFecha.textContent = info.fecha || '—'; }
        if(nivelSelect && !nivelSelect.value){ nivelSelect.value = info.riesgo || ''; }
        if(fechaInput && info.fecha){ fechaInput.value = info.fecha; }
      } else {
        if(spanUltimo){ spanUltimo.textContent='—'; }
        if(spanUltimoFecha){ spanUltimoFecha.textContent='—'; }
      }
      if(estado){ estado.textContent=''; }
    }catch(e){
      console.error('Error cargando riesgo CV', e);
      if(estado){ estado.textContent='Error cargando'; }
    }
  }

  async function guardarRiesgo(){
    const run = (document.getElementById('run')?.value || '').trim();
    const fecha = fechaInput?.value || '';
    const riesgo = nivelSelect?.value || '';
    if(!run || !fecha || !riesgo){
      if(estado){ estado.textContent='Completar campos'; }
      return;
    }
    if(estado){ estado.textContent='Guardando…'; }
    try{
      const resp = await fetch('/api/riesgo-cv', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ run, fecha, riesgo })
      });
      const data = await resp.json().catch(()=>({}));
      if(!resp.ok || data.ok === false){
        throw new Error(data.error || `HTTP ${resp.status}`);
      }
      const info = data.riesgo_cv || { riesgo, fecha };
      if(estado){ estado.textContent='Guardado'; }
      if(spanUltimo){ spanUltimo.textContent = (info.riesgo || riesgo || '—').toUpperCase(); }
      if(spanUltimoFecha){ spanUltimoFecha.textContent = info.fecha || fecha || '—'; }
      if(nivelSelect && info.riesgo){ nivelSelect.value = info.riesgo; }
      if(fechaInput && info.fecha){ fechaInput.value = info.fecha; }
      if(resumenCategoria && resumenCategoria.textContent && resumenCategoria.textContent.trim() !== '—'){
        resumenCategoria.setAttribute('data-riesgo-cv', info.riesgo || riesgo);
      }
      window.dispatchEvent(new CustomEvent('riesgo-cv:actualizado', {
        detail: { run, riesgo: info.riesgo || riesgo, fecha: info.fecha || fecha }
      }));
      setTimeout(()=>{ if(estado){ estado.textContent=''; } }, 2000);
    }catch(e){
      console.error('Error guardando riesgo CV', e);
      if(estado){ estado.textContent='Error'; }
    }
  }

  btnGuardar?.addEventListener('click', guardarRiesgo);

  // Hook en flujo existente de autocompletarIdentificacion
  const originalAuto = window.autocompletarIdentificacion;
  window.autocompletarIdentificacion = function(u, selSector){
    try { originalAuto && originalAuto(u, selSector); } catch(_e){}
    const run = u?.run || u?.usuario_run || document.getElementById('run')?.value;
    if(run){ cargarRiesgoCV(run); }
  };

  window.addEventListener('usuario:cargado', (evt)=>{
    const run = (evt?.detail?.run || '').trim();
    if(run){ cargarRiesgoCV(run); }
  });

  const runInicial = (document.getElementById('run')?.value || '').trim();
  if(runInicial){ cargarRiesgoCV(runInicial); }

  // Exponer función manual
  window.cargarRiesgoCV = cargarRiesgoCV;
})();
</script>
<script>
// === IA UNIFICADA TARJETÓN ===
(function(){
  const btnFull = document.getElementById('btn-ai-autocomplete');
  const btnSimple = document.getElementById('btn-ai-fill');
  const areaFull = document.getElementById('ai-texto-clinico');
  const areaSimple = document.getElementById('ai-texto');
  const statusFull = document.getElementById('ai-autocomplete-status');
  const statusSimple = document.getElementById('ai-fill-status');

  // Toast ligero
  function showToast(msg){
    let t = document.getElementById('ai-toast');
    if(!t){
      t = document.createElement('div');
      t.id='ai-toast';
      t.style.cssText='position:fixed;bottom:18px;right:18px;background:#065f46;color:#fff;padding:10px 14px;border-radius:8px;font-size:.75rem;z-index:9999;box-shadow:0 4px 10px rgba(0,0,0,.15);opacity:0;transition:opacity .25s;';
      document.body.appendChild(t);
    }
    t.textContent=msg; t.style.opacity='1';
    setTimeout(()=>{ t.style.opacity='0'; }, 2500);
  }

  function setStatus(el,msg,kind='info'){
    if(!el) return;
    el.style.display='block';
    const colors={info:'#334155',ok:'#065f46',error:'#b91c1c'};
    el.style.color=colors[kind]||colors.info; el.textContent=msg;
  }

  function escapeHtmlSummary(str){
    return String(str ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function formatSummaryBlock(text){
    if(!text) return '';
    const lines = String(text).split(/\n+/).map(l=>l.trim()).filter(Boolean);
    if(!lines.length) return '';
    const bulletRegex = /^(\d+[\.\)]|[-•*])\s*/;
    const bulletCount = lines.filter(l=>bulletRegex.test(l)).length;
    if(bulletCount >= lines.length/2){
      return '<ul>' + lines.map(line=>{
        const clean = line.replace(bulletRegex,'').trim();
        return `<li>${escapeHtmlSummary(clean)}</li>`;
      }).join('') + '</ul>';
    }
    return lines.map(line=>`<p>${escapeHtmlSummary(line)}</p>`).join('');
  }

  function deriveListFromBlock(text){
    if(!text) return [];
    return String(text)
      .split(/\n+/)
      .map(line=>line.replace(/\s*\|\s*/g,' ').trim())
      .map(line=>line.replace(/^(\d+[\.\)]|[-•*])\s*/, '').trim())
      .filter(Boolean);
  }

  function formatEdadDetallada(det){
    if(!det || typeof det!=='object') return '';
    const parts=[];
    if(Number.isFinite(det.years)) parts.push(`${det.years} años`);
    if(Number.isFinite(det.months)) parts.push(`${det.months} meses`);
    if(Number.isFinite(det.days)) parts.push(`${det.days} días`);
    return parts.join(' · ');
  }

  function buildEmpamText(empam){
    if(!empam) return '';
    if(typeof empam==='string') return empam;
    const parts=[];
    if(empam.puntaje!=null) parts.push(`Puntaje: ${empam.puntaje}`);
    if(empam.clasificacion) parts.push(`Clasificación: ${empam.clasificacion}`);
    if(empam.subareas) parts.push(`Subáreas: ${empam.subareas}`);
    if(empam.resumen) parts.push(empam.resumen);
    if(!parts.length && empam.texto) parts.push(empam.texto);
    if(!parts.length) return JSON.stringify(empam);
    return parts.join(' · ');
  }

  function renderMandrakeSummary(data=null, opts={}){
    const card = document.getElementById('mandrake-summary-card');
    if(!card) return;
    const empty = card.querySelector('[data-role="empty"]');
    const content = card.querySelector('[data-role="content"]');
    const statusBadge = document.getElementById('mandrake-summary-status');
    const ageRow = document.getElementById('mandrake-summary-edad');

    if(!data || typeof data!=='object'){
      card.classList.remove('active','mandrake-summary-highlight');
      if(empty) empty.style.display='block';
      if(content) content.style.display='none';
      if(statusBadge) statusBadge.style.display='none';
      return;
    }

    card.classList.add('active');
    card.classList.add('mandrake-summary-highlight');
    setTimeout(()=>card.classList.remove('mandrake-summary-highlight'), 900);

    if(empty) empty.style.display='none';
    if(content) content.style.display='flex';

    if(statusBadge){
      statusBadge.style.display='inline-flex';
      const src = opts.source ? String(opts.source).toUpperCase() : 'MANUAL';
      const now = new Date();
      const hora = now.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
      statusBadge.textContent = `Fuente ${src} • ${hora}`;
    }

    const meta = data.mandrake_meta || {};
    const metaSelectors = {
      fecha_atencion: '[data-ms="fecha_atencion"]',
      hora_atencion: '[data-ms="hora_atencion"]',
      funcionario: '[data-ms="funcionario"]',
      profesion: '[data-ms="profesion"]',
      establecimiento: '[data-ms="establecimiento"]',
      procedencia: '[data-ms="procedencia"]',
      tipo_consulta: '[data-ms="tipo_consulta"]'
    };
    Object.entries(metaSelectors).forEach(([key, selector])=>{
      const el = card.querySelector(selector);
      if(!el) return;
      el.textContent = meta[key] || '—';
    });

    const edadSpan = card.querySelector('[data-ms="edad_detallada"]');
    if(edadSpan){
      const edadTxt = formatEdadDetallada(meta.edad_detallada);
      if(edadTxt){
        edadSpan.textContent = edadTxt;
        if(ageRow) ageRow.style.display='block';
      } else {
        edadSpan.textContent = '—';
        if(ageRow) ageRow.style.display='none';
      }
    }

    const sections = data.mandrake_sections || {};
    const sectionMap = {
      motivo_consulta: '[data-section="motivo_consulta"]',
      enfermedad_actual: '[data-section="enfermedad_actual"]',
      atencion_familiar: '[data-section="atencion_familiar"]',
      estudios_relevantes: '[data-section="estudios_relevantes"]',
      condiciones_riesgos: '[data-section="condiciones_riesgos"]',
      indicaciones: '[data-section="indicaciones"]',
      funcionalidad: '[data-section="funcionalidad"]',
      formularios_realizados: '[data-section="formularios_realizados"]'
    };
    Object.entries(sectionMap).forEach(([key, selector])=>{
      const el = card.querySelector(selector);
      if(!el) return;
      const wrapper = el.closest('.mandrake-summary-section') || el;
      const texto = sections[key];
      if(texto){
        el.innerHTML = formatSummaryBlock(texto);
        wrapper.style.display='';
      } else {
        el.innerHTML = '—';
        wrapper.style.display='none';
      }
    });

    const empamSection = document.getElementById('mandrake-summary-empam');
    if(empamSection){
      const empamText = sections.empam || buildEmpamText(data.empam);
      if(empamText){
        empamSection.style.display='';
        const target = empamSection.querySelector('[data-section="empam"]');
        if(target) target.innerHTML = formatSummaryBlock(empamText);
      } else {
        empamSection.style.display='none';
      }
    }

    const diagDetalle = Array.isArray(data.diagnosticos_detallados) && data.diagnosticos_detallados.length
      ? data.diagnosticos_detallados
      : (Array.isArray(data.diagnosticos) ? data.diagnosticos.map(dx=>({ descripcion: dx })) : []);
    const dxList = card.querySelector('#mandrake-summary-dx-list');
    if(dxList){
      if(diagDetalle.length){
        dxList.innerHTML = diagDetalle.map(item=>{
          const codigo = item.codigo ? `<strong>${escapeHtmlSummary(item.codigo)}</strong> ` : '';
          const descripcion = escapeHtmlSummary(item.descripcion || item.texto || '');
          const estado = item.estado ? ` <span style="color:#0f766e;font-weight:600;">(${escapeHtmlSummary(item.estado)})</span>` : '';
          return `<li>${codigo}${descripcion}${estado}</li>`;
        }).join('');
      } else {
        dxList.innerHTML = '<li style="opacity:.6;">Sin datos</li>';
      }
    }

    const actividadesList = Array.isArray(data.actividades_programadas) && data.actividades_programadas.length
      ? data.actividades_programadas
      : deriveListFromBlock(sections.actividades_programadas);
    const actListEl = card.querySelector('#mandrake-summary-actividades-list');
    if(actListEl){
      if(actividadesList.length){
        actListEl.innerHTML = actividadesList.map(item=>`<li>${escapeHtmlSummary(item)}</li>`).join('');
      } else {
        actListEl.innerHTML = '<li style="opacity:.6;">Sin actividades detectadas</li>';
      }
    }

    const formulariosTarget = card.querySelector('[data-section="formularios_realizados"]');
    if(formulariosTarget){
      const textoForm = sections.formularios_realizados || (Array.isArray(data.formularios_realizados) ? data.formularios_realizados.join('\n') : data.formularios_realizados);
      if(textoForm){
        formulariosTarget.innerHTML = formatSummaryBlock(textoForm);
        formulariosTarget.closest('.mandrake-summary-section').style.display='';
      } else {
        formulariosTarget.innerHTML = '—';
        formulariosTarget.closest('.mandrake-summary-section').style.display='none';
      }
    }

    window.__mandrakeSummaryLast = { data, source: opts.source || 'unknown', updatedAt: Date.now() };
  }

  window.renderMandrakeSummary = renderMandrakeSummary;

  function highlightField(el, changedTabs){
    if(!el) return;
    el.classList.add('mandrake-modified');
    const node = el.closest('[data-tab-panel]');
    if(node){ changedTabs.add(node.getAttribute('data-tab-panel')); }
  }

  function markTabs(changedTabs){
    if(!changedTabs.size) return;
    document.querySelectorAll('.t-tab').forEach(tabBtn=>{
      const key = tabBtn.getAttribute('data-tab');
      if(changedTabs.has(key) && !tabBtn.querySelector('.mandrake-indicator')){
        const dot=document.createElement('span');
        dot.className='mandrake-indicator';
        tabBtn.style.position='relative';
        tabBtn.appendChild(dot);
        tabBtn.classList.add('mandrake-tab-modified');
      }
    });
  }

  // Exponer global para evitar ReferenceError en cargas tempranas
  window.computeIMC = function computeIMC(){
    const peso = parseFloat(document.querySelector('#form-control-nuevo [name="peso"]')?.value||'');
    const talla = parseFloat(document.querySelector('#form-control-nuevo [name="talla"]')?.value||'');
    if(peso>0 && talla>0){
      const imc = peso / Math.pow(talla/100,2);
      const span = document.querySelector('[data-f="imc"]');
      if(span){ span.textContent = imc.toFixed(1); }
      const clas = (imc<18.5)?'Bajo peso':(imc<25)?'Normal':(imc<30)?'Sobrepeso':(imc<35)?'Obesidad I':(imc<40)?'Obesidad II':'Obesidad III';
      const badge=document.getElementById('imc-clasif');
      if(badge){ badge.textContent=clas; badge.style.display='inline-block'; badge.style.background = imc>=30? '#b91c1c' : (imc>=25? '#f59e0b':'#0d9488'); badge.style.color='#fff'; }
    }
  }

  function fillFirstLab(firstLab, changedTabs){
    if(!firstLab) return;
    const root=document.getElementById('form-lab-nuevo');
    if(!root) return;
    const set=(name,val)=>{ if(val!==undefined && val!==null && val!==''){ const el=root.querySelector(`[name="${name}"]`); if(el){ const prev=el.value; el.value=val; if(prev!==String(val)) highlightField(el, changedTabs);} } };
    set('examen_fecha', firstLab.examen_fecha);
    ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'].forEach(k=>set(k, firstLab[k]));
  }

  function applyCanonical(d){
    const changedTabs = new Set();
    const YES_SET = new Set(['si', 'sí', 's', 'true', 't', '1', 'y', 'yes', 'vigente', 'positivo', 'presenta', 'realizado', 'activo', 'activa']);
    const NO_SET = new Set(['no', 'false', 'f', '0', 'n', 'negativo', 'ausente', 'sin', 'rechaza', 'rechazo', 'no tiene', 'no presenta', 'pendiente']);
    const isBlank = (val) => val === undefined || val === null || (typeof val === 'string' && val.trim() === '');
    const normalizeISODate = (val) => {
      if (val instanceof Date) {
        return val.toISOString().slice(0, 10);
      }
      const str = String(val ?? '').trim();
      if (!str) return '';
      if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
      const dash = str.match(/^(\d{2})-(\d{2})-(\d{4})$/);
      if (dash) return `${dash[3]}-${dash[2]}-${dash[1]}`;
      const slash = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (slash) return `${slash[3]}-${slash[2]}-${slash[1]}`;
      return str;
    };
    const normalizeYesNo = (raw, { yes = 'si', no = 'no' } = {}) => {
      if (raw === undefined || raw === null) return '';
      if (typeof raw === 'boolean') return raw ? yes : no;
      if (typeof raw === 'number') return raw > 0 ? yes : no;
      const txt = String(raw).trim().toLowerCase();
      if (!txt) return '';
      if (YES_SET.has(txt)) return yes;
      if (NO_SET.has(txt)) return no;
      return txt;
    };
    const toBoolString = (value) => {
      const norm = normalizeYesNo(value);
      if (norm === 'si') return 'true';
      if (norm === 'no') return 'false';
      return '';
    };
    const highlightWrapper = (el) => { if (el) highlightField(el, changedTabs); };
    const setFieldValue = (selector, rawValue, opts = {}) => {
      if (isBlank(rawValue)) return;
      const el = document.querySelector(selector);
      if (!el) return;
      let value = rawValue;
      if (value instanceof Date) {
        value = normalizeISODate(value);
      }
      if (opts.transform) {
        try {
          value = opts.transform(value);
        } catch (transformError) {
          console.warn('transform error', transformError);
        }
      }
      if (isBlank(value) || typeof value === 'object') return;
      const newVal = typeof value === 'number' ? String(value) : String(value);
      if (el.value === newVal) return;
      el.value = newVal;
      highlightWrapper(el);
      if (opts.triggerChange) {
        try {
          el.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (_e) {}
      }
    };
    const setRadioGroup = (selector, value) => {
      if (isBlank(value) && typeof value !== 'boolean') return;
      const radios = document.querySelectorAll(selector);
      if (!radios.length) return;
      const norm = normalizeYesNo(value);
      const rawLower = String(value ?? '').trim().toLowerCase();
      const target = Array.from(radios).find((radio) => {
        const radioVal = radio.value.trim().toLowerCase();
        if (norm) {
          if (norm === radioVal) return true;
          if (norm === 'si' && YES_SET.has(radioVal)) return true;
          if (norm === 'no' && NO_SET.has(radioVal)) return true;
        }
        return rawLower && radioVal === rawLower;
      });
      if (target) {
        if (!target.checked) {
          target.checked = true;
          highlightWrapper(target.closest('label') || target);
        }
        try {
          target.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (_e) {}
      }
    };
    const showSection = (id) => {
      const section = document.getElementById(id);
      if (section && section.style.display === 'none') {
        section.style.display = '';
      }
    };
    try {
      window.renderMandrakeSummary && window.renderMandrakeSummary(d || {}, { source: 'AI' });
    } catch(e){ console.warn('renderMandrakeSummary error', e); }
    // Identificación básica
    const mapBasic = { run:'run', nombre:'nombre', fecha_nacimiento:'fecha_nacimiento', sexo:'sexo' };
    Object.entries(mapBasic).forEach(([k,id])=>{ const el=document.getElementById(id); if(el && d[k]){ const prev=el.value; el.value=d[k]; if(prev!==d[k]) highlightField(el, changedTabs);} });
    // Control (con conversión de talla si viene en metros <3)
    const controlMap={ peso:'peso', talla:'talla', presion_sistolica:'presion_sistolica', presion_diastolica:'presion_diastolica', cc:'cc', hgt:'hgt', hba1c:'hba1c' };
    Object.entries(controlMap).forEach(([k,n])=>{
      if(d[k]!=null){
        const el=document.querySelector(`#form-control-nuevo [name="${n}"]`);
        if(el){
          let val=d[k];
          if(n==='talla' && val!=='' && val!=null){
            const num=parseFloat(String(val).replace(',','.'));
            if(!isNaN(num) && num>0 && num<3){ val=(num*100).toFixed(2); }
          }
          const prev=el.value; el.value=val; if(prev!==String(val)) highlightField(el, changedTabs);
        }
      }
    });
    // Fecha control: usar fecha_atencion si viene y campo vacío
    if(d.fecha_atencion){ const fCtl=document.querySelector('#form-control-nuevo [name="fecha"]'); if(fCtl && !fCtl.value){ try { const iso=d.fecha_atencion.length===10? d.fecha_atencion : d.fecha_atencion.split('T')[0]; if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(iso)){ const prev=fCtl.value; fCtl.value=iso; if(prev!==iso) highlightField(fCtl, changedTabs);} } catch(_){} } }
    // Tamizajes
    const dateMap={ fondo_ojo_fecha:'fechaFondoOjos', pie_dm_fecha:'fechaPieDM', podologia_fecha:'fechaPodologia', ekg_fecha:'fechaEkg', mamografia_fecha:'fechaMamografiaAM', psa_fecha:'fechaPSAAM' };
    Object.entries(dateMap).forEach(([k,id])=>{ if(d[k]){ const el=document.getElementById(id); if(el){ const prev=el.value; el.value=d[k]; if(prev!==d[k]) highlightField(el, changedTabs);} } });
    if(d.psa_valor!=null){ const el=document.getElementById('valorPSAAM'); if(el){ const prev=el.value; el.value=d.psa_valor; if(prev!==String(d.psa_valor)) highlightField(el, changedTabs);} }
    if(d.mamografia_birads){ const el=document.getElementById('biradsMamografiaAM'); if(el){ const prev=el.value; el.value=d.mamografia_birads; if(prev!==d.mamografia_birads) highlightField(el, changedTabs);} }
    if(typeof d.mamografia_realizada==='boolean'){ const el=document.getElementById('estadoMamografiaAM'); if(el){ const prev=el.value; el.value=d.mamografia_realizada?'true':'false'; if(prev!==el.value) highlightField(el, changedTabs);} }
    // Patologías (mostrar lista PERO NO preseleccionar automáticamente en panel riesgo)
    if(Array.isArray(d.patologias)){
      const ul=document.getElementById('lista-patologias');
      if(ul){ ul.innerHTML=''; if(!d.patologias.length){ ul.innerHTML='<li style="opacity:.6;">Sin datos</li>'; } else { d.patologias.forEach(p=>{ const li=document.createElement('li'); li.textContent=p; ul.appendChild(li);}); } highlightField(ul, changedTabs);} 
      // NO marcar automáticamente las patologías en el checklist
      // Las patologías solo deben marcarse manualmente o al activar explícitamente el cálculo
      // Comentado: La pre-selección automática causa confusión cuando el usuario está en modo CARDIO
      /*
      try {
        if(window._riesgoCatalogo && Array.isArray(window._riesgoCatalogo)){
          const norm=s=>String(s||'').toLowerCase();
          const encontrados=new Set();
          d.patologias.forEach(txt=>{
            const t=norm(txt);
            const hit=window._riesgoCatalogo.find(p=> norm(p.nombre)===t || norm(p.nombre).includes(t) || t.includes(norm(p.nombre)) || (p.cie10 && t.includes(p.cie10.toLowerCase())));
            if(hit){ encontrados.add(hit.id); }
          });
          if(encontrados.size){
            if(window._riesgoSeleccion instanceof Set){ encontrados.forEach(id=>window._riesgoSeleccion.add(id)); }
            if(typeof window._riesgoRender==='function'){ window._riesgoRender(); }
            const estado=document.getElementById('estado-patologias'); if(estado){ estado.textContent='Patologías detectadas vía IA preseleccionadas ('+encontrados.size+')'; estado.style.color='#0369a1'; }
          }
        }
      } catch(_e){}
      */
    }
    // Labs first
    if(Array.isArray(d.labs) && d.labs.length){ fillFirstLab(d.labs[0], changedTabs); }
    // Fármacos
    const farm = d.farmacos || {};
    if(farm.ieca_ara){
      showSection('seccionIecaAra');
      if(farm.ieca_ara.tipo){
        setFieldValue('#tipoIecaAra', farm.ieca_ara.tipo, {
          transform: (val) => {
            const txt = String(val || '').trim().toUpperCase();
            if (!txt) return '';
            if (txt.includes('ARA')) return 'ARA II';
            if (txt.includes('IECA')) return 'IECA';
            if (['NO', 'NINGUNO', 'NINGUNA', 'SIN'].includes(txt)) return 'NO';
            return txt;
          },
          triggerChange: true,
        });
      }
      if(farm.ieca_ara.fecha){
        setFieldValue('#fechaIecaAra', farm.ieca_ara.fecha, { transform: normalizeISODate });
      }
    }
    if(farm.estatinas){
      showSection('seccionEstatinas');
      if(farm.estatinas.recibe !== undefined){
        setRadioGroup('input[name="recibeEstatinas"]', farm.estatinas.recibe);
      }
      if(farm.estatinas.fecha){
        setFieldValue('#fechaEstatinas', farm.estatinas.fecha, { transform: normalizeISODate });
      }
    }
    if(farm.antiagregantes){
      showSection('seccionAntiagregantes');
      if(farm.antiagregantes.recibe !== undefined){
        setRadioGroup('input[name="recibeAntiagregantes"]', farm.antiagregantes.recibe);
      }
      if(farm.antiagregantes.fecha){
        setFieldValue('#fechaAntiagregantes', farm.antiagregantes.fecha, { transform: normalizeISODate });
      }
    }
    // Evaluación diabetes
    const evalDb = d.evaluacion_diabetes || {};
    const pie = evalDb.pie_diabetico || {};
    if(Object.keys(pie).length){
      setRadioGroup('input[name="ulceraPieOAmputacion"]', pie.ulcera_o_amputacion);
      setRadioGroup('input[name="sensibilidadProtectora"]', pie.sensibilidad_alterada);
      setRadioGroup('input[name="EAP"]', pie.enfermedad_arterial_periferica);
      setRadioGroup('input[name="DEF"]', pie.deformidad);
      setFieldValue('#fechaEvaluacionPieDiabetico', pie.fecha, { transform: normalizeISODate });
      if(pie.resultado || pie.riesgo){
        const cont = document.getElementById('resultadoPieDiabetico');
        if(cont){
          cont.style.display='';
          const inner = cont.querySelector('.resultado-contenido');
          if(inner){ inner.textContent = pie.resultado || (pie.riesgo ? `Riesgo: ${pie.riesgo}` : ''); }
        }
      }
    }
    const hip = evalDb.hipoglicemias || {};
    if(Object.keys(hip).length){
      setRadioGroup('input[name="hipoglicemiasRecurrentes"]', hip.presenta);
      setFieldValue('#fechaHipoglicemias', hip.fecha, { transform: normalizeISODate });
    }
    const amp = evalDb.amputacion || {};
    if(Object.keys(amp).length){
      setRadioGroup('input[name="tieneAmputacion"]', amp.tiene);
      setFieldValue('#fechaAmputacion', amp.fecha, { transform: normalizeISODate });
    }
    const pod = evalDb.podologia || {};
    if(Object.keys(pod).length){
      setRadioGroup('input[name="atencionPodologa"]', pod.vigente);
      setFieldValue('#fechaPodologia', pod.fecha, { transform: normalizeISODate });
    }
    const fondo = evalDb.fondo_ojo || {};
    if(Object.keys(fondo).length){
      setRadioGroup('input[name="fondoOjos"]', fondo.realizado);
      setFieldValue('#fechaFondoOjos', fondo.fecha, { transform: normalizeISODate });
    }
    const cur = evalDb.curaciones || {};
    if(Object.keys(cur).length){
      setRadioGroup('input[name="enCuracion"]', cur.en_curaciones);
      if(cur.tipo){
        const cont = document.getElementById('tipoCuracionContainer');
        if(cont) cont.style.display='';
        setFieldValue('#tipoCuracion', cur.tipo, { triggerChange: true });
      }
      setFieldValue('#fechaCuracion', cur.fecha, { transform: normalizeISODate });
    }
    const ekg = evalDb.ekg || {};
    if(Object.keys(ekg).length){
      setRadioGroup('input[name="ekgRealizado"]', ekg.realizado);
      setFieldValue('#fechaEkg', ekg.fecha, { transform: normalizeISODate });
    }
    // Vacunas y screening adulto mayor
    const mapVacunaEstado = (estado) => {
      const txt = String(estado || '').trim().toLowerCase();
      if (!txt) return '';
      if (YES_SET.has(txt) || ['completa', 'aldía', 'al día', 'vigente'].includes(txt)) return 'SI';
      if (['rechaza', 'rechazo', 'declina'].includes(txt)) return 'RECHAZA';
      if (NO_SET.has(txt) || ['pendiente'].includes(txt)) return 'NO';
      return String(estado).toUpperCase();
    };
    const vacunas = d.vacunas || {};
    const applyVacuna = (entry, estadoSelector, fechaSelector) => {
      if(!entry) return;
      if(entry.estado !== undefined){
        setFieldValue(estadoSelector, entry.estado, { transform: mapVacunaEstado, triggerChange: true });
      }
      if(entry.fecha){
        setFieldValue(fechaSelector, entry.fecha, { transform: normalizeISODate });
      }
    };
    applyVacuna(vacunas.influenza, '#estadoInfluenzaAM', '#fechaInfluenzaAM');
    applyVacuna(vacunas.covid, '#estadoCovidAM', '#fechaCovidAM');

    const screening = d.screening || {};
    if(screening.pap){
      setFieldValue('#fechaPAPAM', screening.pap.fecha, { transform: normalizeISODate });
      if(screening.pap.realizado !== undefined){
        const boolVal = toBoolString(screening.pap.realizado);
        if(boolVal){ setFieldValue('#estadoPAPAM', boolVal, { triggerChange: true }); }
      }
      if(screening.pap.resultado){ setFieldValue('#resultadoPAPAM', screening.pap.resultado); }
    }
    if(screening.mamografia){
      setFieldValue('#fechaMamografiaAM', screening.mamografia.fecha, { transform: normalizeISODate });
      if(screening.mamografia.realizada !== undefined){
        const boolVal = toBoolString(screening.mamografia.realizada);
        if(boolVal){ setFieldValue('#estadoMamografiaAM', boolVal, { triggerChange: true }); }
      }
      if(screening.mamografia.birads){
        setFieldValue('#biradsMamografiaAM', screening.mamografia.birads.toString());
      }
    }
    if(screening.psa){
      setFieldValue('#fechaPSAAM', screening.psa.fecha, { transform: normalizeISODate });
      if(screening.psa.valor !== undefined && screening.psa.valor !== null){
        setFieldValue('#valorPSAAM', screening.psa.valor);
      }
    }

    const funcionalidadMap = (raw) => {
      const txt = String(raw || '').trim().toLowerCase();
      if (!txt) return '';
      if (txt.includes('autovalente con riesgo')) return 'autovalente_con_riesgo';
      if (txt.includes('riesgo de dependencia')) return 'riesgo_dependencia';
      if (txt.includes('dependencia total')) return 'dependencia_total';
      if (txt.includes('dependencia moderada')) return 'dependencia_moderada';
      if (txt.includes('dependencia leve')) return 'dependencia_leve';
      if (txt.includes('autovalente')) return 'autovalente';
      return txt.replace(/\s+/g, '_');
    };
    const adulto = d.adulto_mayor || {};
    if(adulto.fecha){ setFieldValue('#fechaEvaluacionAM', adulto.fecha, { transform: normalizeISODate }); }
    if(adulto.funcionalidad){
      const funcVal = funcionalidadMap(adulto.funcionalidad);
      if(funcVal){ setFieldValue('#funcionalidadAM', funcVal, { triggerChange: true }); }
    }
    if(adulto.tug_segundos !== undefined && adulto.tug_segundos !== null){
      setFieldValue('#tugSegundos', adulto.tug_segundos, { triggerChange: true });
    }
    if(adulto.tug_clasificacion){ setFieldValue('#tugClasificacion', adulto.tug_clasificacion); }
    if(adulto.unipodal_derecho !== undefined && adulto.unipodal_derecho !== null){
      setFieldValue('#unipodalPieDerecho', adulto.unipodal_derecho, { triggerChange: true });
    }
    if(adulto.unipodal_izquierdo !== undefined && adulto.unipodal_izquierdo !== null){
      setFieldValue('#unipodalPieIzquierdo', adulto.unipodal_izquierdo, { triggerChange: true });
    }
    if(adulto.unipodal_clasificacion){ setFieldValue('#unipodalClasificacion', adulto.unipodal_clasificacion); }
    if(adulto.observaciones){ setFieldValue('#observacionesAM', adulto.observaciones); }

    const actDetalle = d.actividad_fisica_detalle || {};
    if(Object.keys(actDetalle).length){
      setRadioGroup('input[name="actividadFisica"]', actDetalle.realiza);
      setFieldValue('#fechaActividadFisica', actDetalle.fecha, { transform: normalizeISODate });
    }
    const masDetalle = d.masama_detalle || {};
    if(Object.keys(masDetalle).length){
      setRadioGroup('input[name="masAma"]', masDetalle.positivo);
      setFieldValue('#fechaMasAma', masDetalle.fecha, { transform: normalizeISODate });
    }
    // IMC
    window.computeIMC && window.computeIMC();
    // Tabs
    markTabs(changedTabs);
    // Minimizar bot
    try { const overlay=document.getElementById('mandrake-chat-overlay'); if(overlay && overlay.style.display!=='none'){ overlay.style.display='none'; } } catch(_e){}
  }

  async function runAI(source){
    const isFull = source==='full';
    const btn = isFull? btnFull : btnSimple;
    const area = isFull? areaFull : areaSimple;
    const statusEl = isFull? statusFull : statusSimple;
    if(!btn) return;
    if(!area){
      if(isFull){
        if(areaSimple){
          areaSimple.scrollIntoView({behavior:'smooth', block:'center'});
          try { areaSimple.focus({preventScroll:true}); } catch(_e) { areaSimple.focus(); }
        }
        if(statusSimple){ setStatus(statusSimple,'El modo completo fue retirado. Usa el cuadro de texto inferior para la IA.'); }
      }
      return;
    }
    const raw = (area.value||'').trim();
    if(!raw){ alert('Pega el texto clínico primero.'); return; }
    const prev=btn.textContent; btn.disabled=true; btn.textContent='Procesando…'; setStatus(statusEl,'Llamando IA…');
    try {
      const resp = await fetch('/api/ai/tarjeton-fill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({texto:raw})});
      const j = await resp.json();
      if(!j.ok){ setStatus(statusEl,'Error: '+(j.error||resp.status),'error'); btn.textContent=prev; btn.disabled=false; return; }
      setStatus(statusEl,'Aplicando datos ('+j.mode+')','ok');
      (function ensureLabsArray(d){
        if(!d) return;
        if(Array.isArray(d.labs)) return; // ya viene bien
        const keys=['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'];
        const has = keys.some(k=> d[k]!=null && d[k]!=='' );
        if(has){
          const labObj={};
          keys.forEach(k=>{ if(d[k]!=null && d[k]!=='' ) labObj[k]=d[k]; });
          labObj.examen_fecha = d.examen_fecha || d.fecha_atencion || d.fecha_examen;
          d.labs=[labObj];
        }
      })(j.data||{});
      applyCanonical(j.data||{});
      // Autosave rápido (no bloqueante)
      try {
        const runVal = document.getElementById('run')?.value?.trim();
        if(runVal){
          const ctlRoot = document.getElementById('form-control-nuevo');
            const takeNum = (name)=>{ const el=ctlRoot?.querySelector(`[name="${name}"]`); if(!el) return undefined; const v=el.value.trim(); if(!v) return undefined; const n=parseFloat(v.replace(',','.')); return isNaN(n)? undefined : n; };
            const payloadControl = {
              run: runVal,
              peso: takeNum('peso'),
              talla: takeNum('talla'),
              presion_sistolica: takeNum('presion_sistolica'),
              presion_diastolica: takeNum('presion_diastolica'),
              cc: takeNum('cc'),
              hgt: takeNum('hgt'),
              hba1c: takeNum('hba1c')
            };
            const hasControl = Object.values(payloadControl).some(v=>typeof v==='number');
            const labRoot = document.getElementById('form-lab-nuevo');
            const labTake = (name)=>{ const el=labRoot?.querySelector(`[name="${name}"]`); if(!el) return undefined; const v=el.value.trim(); if(!v) return undefined; const n=parseFloat(v.replace(',','.')); return isNaN(n)? undefined : n; };
            const payloadLab = {
              run: runVal,
              examen_fecha: labRoot?.querySelector('[name="examen_fecha"]')?.value || undefined,
              glicemia: labTake('glicemia'),
              hba1c: labTake('hba1c'),
              ldl: labTake('ldl'),
              hdl: labTake('hdl'),
              col: labTake('col'),
              tag: labTake('tag'),
              creatinemia: labTake('creatinemia'),
              vfg: labTake('vfg'),
              rac: labTake('rac'),
              microalbuminuria_val: labTake('microalbuminuria_val'),
              tsh: labTake('tsh')
            };
            const hasLabs = Object.entries(payloadLab).some(([k,v])=>['run','examen_fecha'].indexOf(k)===-1 && typeof v==='number');
            const ops = [];
            if(hasControl){ ops.push(fetch('/api/control/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadControl)})); }
            if(hasLabs){ ops.push(fetch('/api/labs/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadLab)})); }
            if(ops.length){ Promise.allSettled(ops).then(rs=>{ const ok=rs.filter(r=>r.status==='fulfilled').length; if(ok){ showToast('Guardado rápido ('+ok+')'); } }).catch(()=>{}); }
        }
      } catch(_e) {}
      btn.textContent='✅ IA aplicado';
      showToast('Autocompletado aplicado');
      setTimeout(()=>{ btn.textContent=prev; btn.disabled=false; },2000);
    } catch(e){ console.error(e); setStatus(statusEl,'Excepción: '+e,'error'); btn.textContent=prev; btn.disabled=false; }
  }

  if(btnFull){
    if(areaFull){
      btnFull.addEventListener('click', ()=>runAI('full'));
    } else {
      btnFull.textContent = '⚡ IA (modo simple)';
      btnFull.title = 'El modo completo fue retirado. Usa el cuadro de texto inferior.';
      btnFull.classList.add('btn-outlined');
      btnFull.style.background = '#475569';
      btnFull.style.color = '#f8fafc';
      btnFull.addEventListener('click', ()=>{
        if(areaSimple){
          areaSimple.scrollIntoView({behavior:'smooth', block:'center'});
          try { areaSimple.focus({preventScroll:true}); } catch(_e) { areaSimple.focus(); }
        }
        if(statusSimple){ setStatus(statusSimple,'Pega el texto clínico en el modo simple para continuar.'); }
      });
    }
  }
  if(btnSimple){ btnSimple.addEventListener('click', ()=>runAI('simple')); }
})();
</script>





<script>
(function(){
  // === Helpers puros ===
  const buildDefaultOptions = (options = {}) => ({
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      ...(options.headers || {}),
    },
  });

  const logByStatus = (response, url) => {
    // Mismo orden y mensajes que el original
    if (response.status === 403) {
      console.log(`[API] Sin autorización: ${url} (posible problema de autenticación)`);
    } else if (response.status >= 500) {
      console.log(`[API] Error del servidor: ${url} (${response.status})`);
    } else if (response.status === 404) {
      console.log(`[API] Endpoint no encontrado: ${url}`);
    }
  };

  // Helper para fetch con autenticación y manejo de errores mejorado
  const authFetch = async (url, options = {}) => {
    const defaultOptions = buildDefaultOptions(options);
    
    // Agregar timeout por defecto
    const timeoutMs = options.timeout || 10000; // 10 segundos
    const maxRetries = options.retries || 1;
    
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        // Crear AbortController para timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        
        const fetchOptions = { 
          ...defaultOptions, 
          ...options, 
          signal: controller.signal 
        };
        
        console.log(`[API] Intento ${attempt + 1}/${maxRetries + 1} - ${url}`);
        
        const response = await fetch(url, fetchOptions);
        clearTimeout(timeoutId);

        // Logs de estado
        logByStatus(response, url);

        return response;
        
      } catch (error) {
        if (attempt === maxRetries) {
          // Último intento fallido
          if (error.name === 'AbortError') {
            console.log(`[API] Timeout (${timeoutMs}ms): ${url}`);
            const timeoutError = new Error(`Timeout después de ${timeoutMs}ms`);
            timeoutError.name = 'TimeoutError';
            throw timeoutError;
          } else {
            console.log(`[API] Error final de conexión: ${url}`, error.message);
            throw error;
          }
        } else {
          // Reintento
          console.log(`[API] Error en intento ${attempt + 1}, reintentando: ${url}`, error.message);
          await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1))); // Backoff exponencial
        }
      }
    }
  };

  // Función para verificar si la sesión está activa
  // Flask-Login ya maneja la sesión, no necesitamos verificarla manualmente
  const verificarSesion = async () => {
    // Si estamos en esta página, la sesión ya está activa (protegida por @login_required)
    return true;
  };

  // (Bloque de protección de visibilidad eliminado según nueva especificación)

  // Inicialización simple sin bypass CARDIO
  window.programaSeleccionado = 'ECICEP'; // Valor por defecto hasta que se cargue el usuario
  window.programasActivos = new Set();
  console.log('[PROGRAMA] Inicializado en modo ECICEP por defecto');

  const PROGRAMAS_CONFIG = [
    { id: 'btn-programa-ecicep-riesgo', code: 'INGRESO_ECICEP', label: 'Ingreso a Plataforma ECICEP', modo: 'ECICEP' },
    { id: 'btn-programa-cardio-riesgo', code: 'PSCV', label: 'Programa Salud Cardiovascular (PSCV)', modo: 'CARDIO' },
    { id: 'btn-programa-dependencia', code: 'DEPENDENCIA', label: 'Programa Dependencia' },
    { id: 'btn-programa-pam', code: 'PAM', label: 'Programa PAM' },
    { id: 'btn-programa-era', code: 'ERA', label: 'Programa ERA' },
    { id: 'btn-programa-otras-cronicas', code: 'OTRAS_CRONICAS', label: 'Programa Otras crónicas' }
  ];

  window._runActivo = window._runActivo || '';

  function obtenerRunActivo() {
    const runCampo = document.getElementById('run');
    const runBusqueda = document.getElementById('run-search');
    const candidato = (runCampo?.value || '').trim() || (runBusqueda?.value || '').trim() || (window._runActivo || '').trim();
    if (candidato) {
      window._runActivo = candidato;
    }
    return candidato;
  }

  function formatearRunParaEnvio(raw) {
    if (!raw) return null;
    const limpio = raw.toString().replace(/[^0-9kK]/g, '').toUpperCase();
    if (limpio.length < 8 || limpio.length > 9) {
      return null;
    }
    const cuerpo = limpio.slice(0, -1);
    const dv = limpio.slice(-1);
    if (!/^[0-9]+$/.test(cuerpo)) {
      return null;
    }
    let suma = 0;
    let multiplicador = 2;
    for (let i = cuerpo.length - 1; i >= 0; i--) {
      suma += parseInt(cuerpo[i], 10) * multiplicador;
      multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
    }
    const resto = suma % 11;
    const dvCalculadoNum = 11 - resto;
    const dvEsperado = dvCalculadoNum === 11 ? '0' : dvCalculadoNum === 10 ? 'K' : String(dvCalculadoNum);
    if (dvEsperado !== dv) {
      return null;
    }
    let formateado;
    if (cuerpo.length === 7) {
      formateado = `${cuerpo[0]}.${cuerpo.slice(1,4)}.${cuerpo.slice(4)}-${dv}`;
    } else if (cuerpo.length === 8) {
      formateado = `${cuerpo.slice(0,2)}.${cuerpo.slice(2,5)}.${cuerpo.slice(5)}-${dv}`;
    } else if (cuerpo.length === 6) {
      formateado = `${cuerpo.slice(0,3)}.${cuerpo.slice(3)}-${dv}`;
    } else {
      formateado = `${cuerpo}-${dv}`;
    }
    return formateado;
  }

  window.obtenerRunActivo = obtenerRunActivo;
  window.formatearRunParaEnvio = formatearRunParaEnvio;

  function actualizarModoPrograma(modo) {
    const modoLimpio = (modo || 'ECICEP').toString().trim().toUpperCase();
    window.programaSeleccionado = modoLimpio;
    console.log(`🔧 [PROGRAMA] Modo de riesgo activo: ${modoLimpio}`);
  }

  function renderProgramButtons() {
    PROGRAMAS_CONFIG.forEach(({ id, code }) => {
      const btn = document.getElementById(id);
      if (!btn) return;
      const activo = window.programasActivos.has(code);
      btn.classList.toggle('btn-verde', activo);
      btn.classList.toggle('btn-outlined', !activo);
    });
  }

  function sincronizarProgramasActivos(codigos, usuarioFallback) {
    if (!(window.programasActivos instanceof Set)) {
      window.programasActivos = new Set();
    }

    window.programasActivos.clear();

    if (Array.isArray(codigos)) {
      codigos.forEach((codigo) => {
        const normalizado = (codigo || '').toString().trim().toUpperCase();
        if (normalizado) {
          window.programasActivos.add(normalizado);
        }
      });
    }

    if (window.programasActivos.size === 0 && usuarioFallback) {
      if (usuarioFallback.en_programa_cv) {
        window.programasActivos.add('PSCV');
      }
      if (usuarioFallback.ingreso_ecicep) {
        window.programasActivos.add('INGRESO_ECICEP');
      }
    }

    renderProgramButtons();

    if (window.programasActivos.has('PSCV')) {
      actualizarModoPrograma('CARDIO');
    } else if (window.programasActivos.has('INGRESO_ECICEP')) {
      actualizarModoPrograma('ECICEP');
    } else {
      actualizarModoPrograma(window.programaSeleccionado || 'ECICEP');
    }
  }

  function sincronizarPatologiasTrasCambio(run, recalcularRiesgo = true) {
    setTimeout(async () => {
      console.log('🔧 [PROGRAMA] Verificando catálogo de patologías...');

      let intentos = 0;
      const maxIntentos = 15;

      while ((!window._riesgoCatalogo || window._riesgoCatalogo.length === 0) && intentos < maxIntentos) {
        console.log(`⏳ [PROGRAMA] Esperando catálogo... (${intentos + 1}/${maxIntentos})`);
        await new Promise(resolve => setTimeout(resolve, 300));
        intentos++;
      }

      if (!window._riesgoCatalogo || window._riesgoCatalogo.length === 0) {
        console.error('❌ [PROGRAMA] Catálogo de patologías no disponible');
        return;
      }

      console.log(`✅ [PROGRAMA] Catálogo disponible con ${window._riesgoCatalogo.length} patologías`);

      if (typeof sincronizarPatologiasUsuario === 'function') {
        const numMarcadas = await sincronizarPatologiasUsuario(run);
        console.log(`🔧 [PROGRAMA] ${numMarcadas} patologías sincronizadas`);

        if (recalcularRiesgo && numMarcadas > 0) {
          setTimeout(() => {
            console.log('🔧 [PROGRAMA] Calculando riesgo automáticamente...');
            if (typeof window.calcularRiesgoECICEP === 'function') {
              window.calcularRiesgoECICEP();
            } else {
              console.warn('⚠️ [PROGRAMA] Función calcularRiesgoECICEP no disponible aún');
            }
          }, 1000);
        } else if (numMarcadas === 0) {
          console.warn('⚠️ [PROGRAMA] No se marcaron patologías - no se puede calcular riesgo');
        }
      } else {
        console.error('❌ [PROGRAMA] Función sincronizarPatologiasUsuario no disponible');
      }
    }, 1500);
  }

  async function manejarCambioPrograma(config, activar) {
    const runField = document.getElementById('run');
    const run = runField?.value?.trim();

    if (!run) {
      alert('Debe seleccionar un usuario primero');
      return;
    }

    const accionTexto = activar ? 'Activar' : 'Desactivar';
    const etiqueta = config.label || config.code;

    if (!confirm(`¿${accionTexto} ${etiqueta}?`)) {
      return;
    }

    try {
      console.log(`🔧 [PROGRAMA] ${accionTexto} ${config.code} para ${run}...`);

      const response = await authFetch('/api/tarjeton/cambiar_programa', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          run,
          programa: config.code,
          activo: activar
        })
      });

      const result = await response.json();

      if (!response.ok || !result.ok) {
        throw new Error(result.error || 'Error cambiando programa');
      }

      if (Array.isArray(result.programas_activos)) {
        sincronizarProgramasActivos(result.programas_activos, null);
      } else {
        if (activar) {
          window.programasActivos.add(config.code);
        } else {
          window.programasActivos.delete(config.code);
        }
        renderProgramButtons();
      }

      if (config.modo) {
        if (activar) {
          actualizarModoPrograma(config.modo);
        } else if (window.programaSeleccionado === config.modo) {
          if (window.programasActivos.has('PSCV')) {
            actualizarModoPrograma('CARDIO');
          } else {
            actualizarModoPrograma('ECICEP');
          }
        }
      }

      alert(`${accionTexto} ${etiqueta} correctamente.`);

      if (typeof buscarRun === 'function') {
        buscarRun(run);
      }
      sincronizarPatologiasTrasCambio(run, true);
    } catch (error) {
      console.error('❌ [PROGRAMA] Error cambiando programa:', error);
      alert(`Error cambiando programa: ${error.message}`);
    }
  }

  PROGRAMAS_CONFIG.forEach((config) => {
    const btn = document.getElementById(config.id);
    if (!btn) return;

    btn.addEventListener('click', () => {
      const yaActivo = window.programasActivos.has(config.code);
      manejarCambioPrograma(config, !yaActivo);
    });
  });

  renderProgramButtons();

  // Función para cargar programa actual del usuario desde BD
  async function cargarProgramaUsuario(run) {
    if (!run) return;
    
    try {
      const response = await authFetch(`/api/tarjeton/${encodeURIComponent(run)}`);
      if (!response.ok) return;
      
      const data = await response.json();
      if (data && data.ok && data.usuario) {
        sincronizarProgramasActivos(data.programas_activos, data.usuario);
        console.log(`🔧 [PROGRAMA] Usuario ${run} programas activos:`, Array.from(window.programasActivos));
        sincronizarPatologiasTrasCambio(run, true);
      }
    } catch (error) {
      console.error('❌ [PROGRAMA] Error cargando programa del usuario:', error);
    }
  }
  
  // Exponer función globalmente para que se pueda llamar desde buscarRun
  window.cargarProgramaUsuario = cargarProgramaUsuario;
  window.sincronizarProgramasActivos = sincronizarProgramasActivos;

  // Cálculo de edad
  const fecha = document.getElementById('fecha_nacimiento');
  const edad = document.getElementById('edad');
  function calcEdad(){
    if(!fecha.value){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    const fn = new Date(fecha.value);
    if(isNaN(fn.getTime())){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    const hoy = new Date();
    let e = hoy.getFullYear()-fn.getFullYear();
    const mDiff = hoy.getMonth()-fn.getMonth();
    if (mDiff<0 || (mDiff===0 && hoy.getDate()<fn.getDate())) e--;
    if (e<0 || e>120){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    edad.value = e;
    
    // Actualizar visibilidad de pestaña Adulto Mayor
    if (typeof mostrarOcultarAdultoMayor === 'function') {
      mostrarOcultarAdultoMayor(e);
    }
  }
  fecha.addEventListener('change', calcEdad);
  fecha.addEventListener('input', calcEdad);

  // RUN auto focus
  const run = document.getElementById('run');
  if(run){ run.focus(); }

  // Reset limpia edad
  document.getElementById('btn-reset').addEventListener('click',()=>{ setTimeout(()=>{ edad.value=''; },0); });

  // Tabs
  const tabs = document.querySelectorAll('.t-tab');
  const panels = document.querySelectorAll('[data-panel]');
  function activarTab(k){
    tabs.forEach(b=>{
      if(b.dataset.tab===k){
        b.classList.add('active');
      } else {
        b.classList.remove('active');
      }
    });
    panels.forEach(p=>{ p.hidden = p.getAttribute('data-panel')!==k; });
    localStorage.setItem('tarjeton.tab', k);
    
    // Cargar historial específico del tab si hay usuario activo
    const runField = document.getElementById('run');
    if (runField && runField.value.trim()) {
      if (k === 'adulto_mayor') {
        cargarHistorialAdultoMayor(runField.value.trim());
        // Obtener datos del usuario para filtrar por género y edad para screening
        const sexoSpan = document.querySelector('[data-f="sexo"]');
        const edadSpan = document.querySelector('[data-f="edad"]');
        const sexoInput = document.getElementById('sexo');
        const edadInput = document.getElementById('edad');
        
        // Intentar obtener de spans del resumen o de inputs del formulario
        const sexo = (sexoSpan ? sexoSpan.textContent.trim() : '') || 
                     (sexoInput ? sexoInput.value : '');
        const edad = (edadSpan ? parseInt(edadSpan.textContent.trim()) : 0) || 
                     (edadInput ? parseInt(edadInput.value) : 0);
        
        console.log('[DEBUG-SCREENING] Tab Adulto Mayor - Sexo:', sexo, 'Edad:', edad);
        console.log('[DEBUG-SCREENING] Elementos encontrados:', {
          sexoSpan: !!sexoSpan,
          edadSpan: !!edadSpan,
          sexoInput: !!sexoInput,
          edadInput: !!edadInput
        });
        
        cargarDatosScreeningAM(runField.value.trim(), sexo, edad);
      } else if (k === 'funcionalidad') {
        cargarHistorialAdultoMayor(runField.value.trim());
        cargarHistorialActividadFisica(runField.value.trim());
        cargarHistorialMasAma(runField.value.trim());
      }
    }
  }
  tabs.forEach(b=> b.addEventListener('click', ()=> activarTab(b.dataset.tab)));
  activarTab(localStorage.getItem('tarjeton.tab')||'control');

  // (cargarDatos eliminado: ahora toda la carga se centraliza en buscarRun/recargaTodo)

  // ===== Helpers para poblar =====
  function byIdPoblar(id) { return document.getElementById(id); }
  function ensure(v) { return (v ?? '—'); }
  function setText(el, v) { if (el) el.textContent = v; }

  /**
   * Asigna value si el valor es distinto de undefined/null/''
   * y emite el mismo log "Asignado <id>: <val>" que el código original.
   * Mantiene el orden de logs/efectos al ser llamado en la misma secuencia.
   */
  function setValueIfPresent(id, value) {
    const el = byIdPoblar(id);
    console.log(`[DEBUG-SETVALUE] Intentando asignar ${id}:`, value, 'Elemento encontrado:', !!el);
    if (el && value !== undefined && value !== null && value !== '') {
      el.value = value;
      console.log(`✅ Asignado ${id}: ${value}`);
    } else {
      console.warn(`⚠️ No se pudo asignar ${id}. Elemento:`, !!el, ', Valor:', value);
    }
  }

  function clasificarPatologia(nombreRaw, cie10Raw) {
    const nombre = (nombreRaw || '').toLowerCase();
    const codigo = (cie10Raw || '').toUpperCase();

    // HTA: por nombre, por I10–I13.*, o exactamente I23.2
    if (/hipertens/i.test(nombre) || /^(I10|I11|I12|I13)(\.|$)/i.test(codigo) || /^I23\.2$/i.test(codigo)) {
      return 'pat-hta';
    }
    // Dislipidemia: por nombre o E78.*
    if (/dislipid/i.test(nombre) || /^E78(\.|$)/i.test(codigo)) {
      return 'pat-dislip';
    }
    // Diabetes: por nombre o E10–E14.*
    if (/diab/i.test(nombre) || /^E1[0-4](\.|$)/i.test(codigo)) {
      return 'pat-diabetes';
    }
    return '';
  }

  function renderPatologias(ul, pats) {
    console.log('[DEBUG-RENDER-PATS] Renderizando patologías:', pats, 'UL:', !!ul);
    if (!ul) {
      console.warn('[DEBUG-RENDER-PATS] No se encontró elemento UL para patologías');
      return;
    }
    ul.innerHTML = '';
    if (!Array.isArray(pats) || pats.length === 0) {
      console.log('[DEBUG-RENDER-PATS] Sin patologías para mostrar');
      ul.innerHTML = '<li style="opacity:.6;">Sin datos</li>';
      return;
    }
    console.log(`[DEBUG-RENDER-PATS] Renderizando ${pats.length} patologías`);
    pats.forEach(p => {
      const li = document.createElement('li');
      const codigo = (p.cie10 || '').toUpperCase();
      const nombre = (p.nombre || '');
      li.className = clasificarPatologia(nombre, codigo);
      li.textContent = (codigo ? (codigo + ' - ') : '') + nombre;
      
      // Hacer clickeable para marcar en checklist de cálculo de riesgo
      li.style.cursor = 'pointer';
      li.style.transition = 'all 0.2s';
      li.title = 'Click para marcar en cálculo de riesgo';
      
      li.addEventListener('mouseover', () => {
        li.style.opacity = '0.7';
        li.style.transform = 'translateX(3px)';
      });
      
      li.addEventListener('mouseout', () => {
        li.style.opacity = '1';
        li.style.transform = 'translateX(0)';
      });
      
      li.addEventListener('click', () => {
        // Buscar checkbox correspondiente en el panel de cálculo de riesgo
        const contenedorPats = document.getElementById('contenedor-patologias');
        if (!contenedorPats) {
          console.warn('[CLICK-PAT] No se encontró contenedor-patologias');
          return;
        }
        
        // Buscar por código CIE10 en los checkboxes
        const checkboxes = contenedorPats.querySelectorAll('input[type="checkbox"]');
        let encontrado = false;
        
        checkboxes.forEach(cb => {
          const label = cb.closest('label');
          if (!label) return;
          
          // Buscar el código CIE10 en el label (está en el div con CIE-10: ...)
          const cie10Div = label.querySelector('div div[style*="font-size: 0.65rem"]');
          if (cie10Div) {
            const textoCompleto = cie10Div.textContent;
            // Extraer el código después de "CIE-10: "
            const match = textoCompleto.match(/CIE-10:\s*([A-Z]\d+(\.\d+)?)/i);
            if (match) {
              const codigoCb = match[1].toUpperCase();
              // Comparar códigos (match exacto o el del resumen es un prefijo)
              if (codigoCb === codigo || codigoCb.startsWith(codigo) || codigo.startsWith(codigoCb)) {
                // Marcar o desmarcar el checkbox
                cb.checked = !cb.checked;
                cb.dispatchEvent(new Event('change'));
                encontrado = true;
                console.log(`[CLICK-PAT] ${cb.checked ? 'Marcado' : 'Desmarcado'}: ${codigo} - ${nombre}`);
                
                // Feedback visual
                li.style.fontWeight = cb.checked ? 'bold' : 'normal';
                li.style.textDecoration = cb.checked ? 'underline' : 'none';
              }
            }
          }
        });
        
        if (!encontrado) {
          console.warn(`[CLICK-PAT] No se encontró checkbox para: ${codigo} - ${nombre}`);
          // Mostrar mensaje al usuario
          const mensaje = document.createElement('div');
          mensaje.textContent = `⚠️ Patología "${codigo}" no encontrada en el catálogo de riesgo`;
          mensaje.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#f59e0b;color:white;padding:12px 20px;border-radius:8px;z-index:10000;font-size:0.85rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
          document.body.appendChild(mensaje);
          setTimeout(() => mensaje.remove(), 2500);
        }
      });
      
      ul.appendChild(li);
      console.log(`[DEBUG-RENDER-PATS] Agregada: ${codigo} - ${nombre}`);
    });
    console.log('[DEBUG-RENDER-PATS] Renderizado completo');
    
    // Actualizar estado visual después de renderizar
    setTimeout(() => {
      if (typeof actualizarEstadoPatologiasResumen === 'function') {
        actualizarEstadoPatologiasResumen();
      }
    }, 100);
  }

  function autocompletarIdentificacion(u, selSector, edadBackend) {
    const formTar = byIdPoblar('form-tarjeton');
    if (!(formTar && u && u.run)) return;

    console.log('Autocompletando formulario con usuario:', u);
    console.log('Edad desde backend:', edadBackend);

    // Mantener exactamente el mismo orden de asignaciones y logs
    setValueIfPresent('run', u.run);
    // También sincronizar el campo de búsqueda
    setValueIfPresent('run-search', u.run);
    setValueIfPresent('nombre', u.nombre_completo || u.nombre);
    
    // Convertir fecha_nacimiento a formato YYYY-MM-DD para input type="date"
    if (u.fecha_nacimiento) {
      try {
        const fecha = new Date(u.fecha_nacimiento);
        if (!isNaN(fecha.getTime())) {
          const yyyy = fecha.getFullYear();
          const mm = String(fecha.getMonth() + 1).padStart(2, '0');
          const dd = String(fecha.getDate()).padStart(2, '0');
          const fechaFormateada = `${yyyy}-${mm}-${dd}`;
          console.log(`[DEBUG-FECHA] Fecha original: ${u.fecha_nacimiento}, Formateada: ${fechaFormateada}`);
          setValueIfPresent('fecha_nacimiento', fechaFormateada);
          
          // Calcular edad - prioridad: backend > frontend
          let edadFinal = edadBackend; // Usar edad del backend primero
          
          if (!edadFinal && typeof _calcEdad === 'function') {
            // Si no hay edad del backend, calcular en frontend
            edadFinal = _calcEdad(fechaFormateada);
          }
          
          console.log(`[DEBUG-EDAD] Edad final: ${edadFinal} años (backend: ${edadBackend}, calculada: ${_calcEdad ? _calcEdad(fechaFormateada) : 'N/A'})`);
          
          if (edadFinal !== null && edadFinal !== undefined && edadFinal !== '') {
            setValueIfPresent('edad', edadFinal);
          }
        } else {
          console.warn('[DEBUG-FECHA] Fecha inválida:', u.fecha_nacimiento);
        }
      } catch (e) {
        console.error('[DEBUG-FECHA] Error convirtiendo fecha:', e);
      }
    } else if (edadBackend) {
      // Si no hay fecha de nacimiento pero sí edad del backend, usarla
      console.log(`[DEBUG-EDAD] Usando edad del backend sin fecha: ${edadBackend}`);
      setValueIfPresent('edad', edadBackend);
    }
    
    // Convertir fecha_ingreso a formato YYYY-MM-DD para input type="date"
    if (u.fecha_ingreso) {
      try {
        const fechaIngreso = new Date(u.fecha_ingreso);
        if (!isNaN(fechaIngreso.getTime())) {
          const yyyy = fechaIngreso.getFullYear();
          const mm = String(fechaIngreso.getMonth() + 1).padStart(2, '0');
          const dd = String(fechaIngreso.getDate()).padStart(2, '0');
          const fechaIngresoFormateada = `${yyyy}-${mm}-${dd}`;
          console.log(`[DEBUG-FECHA-INGRESO] Fecha original: ${u.fecha_ingreso}, Formateada: ${fechaIngresoFormateada}`);
          setValueIfPresent('fecha_ingreso', fechaIngresoFormateada);
        } else {
          console.warn('[DEBUG-FECHA-INGRESO] Fecha inválida:', u.fecha_ingreso);
        }
      } catch (e) {
        console.error('[DEBUG-FECHA-INGRESO] Error convirtiendo fecha:', e);
      }
    }
    
    setValueIfPresent('sexo', u.sexo);
    if (selSector && u.sector_id) selSector.value = u.sector_id; // no log aquí en el original
    setValueIfPresent('telefono', u.telefono);
    setValueIfPresent('direccion', u.direccion);

    // Resetear flag como en el original
    window._identEditadoManualmente = false;
  }

  // ===== MISMA FIRMA PÚBLICA =====
  function poblar(data) {
    console.log('🔧 [DEBUG-POBLAR] *** FUNCION POBLAR EJECUTADA ***', data);
    const u = (data && data.usuario) || {};

    // Mostrar resumen y ocultar badge nuevo si existe usuario
    const cardResumenAuto = byIdPoblar('card-resumen');
    if (cardResumenAuto) { cardResumenAuto.style.display = 'flex'; }
    if (u && u.run) {
      const badgeNuevo = byIdPoblar('badge-nuevo-usuario');
      if (badgeNuevo) badgeNuevo.style.display = 'none';
    }

    // Mapa de campos para [data-f]
    const fechaNacFormateada = u.fecha_nacimiento ? new Date(u.fecha_nacimiento).toLocaleDateString('es-CL') : '—';
    console.log('🔧 [DEBUG-POBLAR] Fecha nacimiento original:', u.fecha_nacimiento);
    console.log('🔧 [DEBUG-POBLAR] Fecha formateada:', fechaNacFormateada);
    console.log('🔧 [DEBUG-POBLAR] Edad del data:', data?.edad);
    
    // Categoría de riesgo (G1/G2/G3) - SIN bypass CARDIO
    let categoriaMostrar = ensure(u.categoria_nombre || u.categoria_ecicep_effectiva);
    console.log('🔧 [DEBUG-POBLAR] Categoría del usuario:', categoriaMostrar);
    
    const patologiasResumen = Array.isArray(data?.patologias_resumen) ? data.patologias_resumen : [];
    window.__usuarioPatologiasResumen = patologiasResumen;
    window.__usuarioSexo = u?.sexo ?? '';
    if (typeof data?.tiene_diabetes === 'boolean') {
      window.__usuarioTieneDiabetes = data.tiene_diabetes;
    } else if (patologiasResumen.length) {
      window.__usuarioTieneDiabetes = patologiasResumen.some(p => {
        const nombre = (p.nombre || '').toLowerCase();
        const cie10 = (p.cie10 || p.codigo || '').toLowerCase();
        return nombre.includes('diabet') || /^e1[0-4]/.test(cie10);
      });
    } else {
      window.__usuarioTieneDiabetes = undefined;
    }

    const map = {
      run: ensure(u.run),
      nombre_completo: ensure(u.nombre_completo || u.nombre),
      fecha_nacimiento: fechaNacFormateada,
      edad: ensure(data?.edad),
      sexo: ensure(u.sexo),
      sector_nombre: ensure(u.sector_nombre),
      categoria_nombre: categoriaMostrar,
      telefono: ensure(u.telefono)
    };

    // Volcar [data-f] manteniendo el mismo comportamiento
    console.log('🔧 [DEBUG-POBLAR] Elementos data-f encontrados:', document.querySelectorAll('[data-f]').length);
    document.querySelectorAll('[data-f]').forEach(sp => {
      const valor = map[sp.dataset.f] ?? '—';
      console.log('🔧 [DEBUG-POBLAR] Asignando', sp.dataset.f, '=', valor);
      setText(sp, valor);
    });

    // Badge riesgo/categoría (misma posición en el flujo)
    try {
      if (window.actualizarBadgeRiesgo && typeof window.actualizarBadgeRiesgo === 'function') {
        window.actualizarBadgeRiesgo(map.categoria_nombre);
      }
      
      // Actualizar badge "Actual:" en el panel de cálculo de riesgo
      const badgeActual = document.getElementById('riesgo-actual');
      if (badgeActual && map.categoria_nombre && map.categoria_nombre !== '—') {
        badgeActual.textContent = map.categoria_nombre;
        
        // Aplicar clase de estilo según categoría
        badgeActual.className = 'badge-riesgo';
        if (map.categoria_nombre === 'CARDIO') {
          badgeActual.classList.add('badge-neutro');
        } else if (map.categoria_nombre === 'G1') {
          badgeActual.classList.add('badge-g1');
        } else if (map.categoria_nombre === 'G2') {
          badgeActual.classList.add('badge-g2');
        } else if (map.categoria_nombre === 'G3') {
          badgeActual.classList.add('badge-g3');
        } else {
          badgeActual.classList.add('badge-neutro');
        }
        
        console.log('🔧 [DEBUG-POBLAR] Badge riesgo actual actualizado:', map.categoria_nombre);
      }
    } catch(e) {
      console.warn('actualizarBadgeRiesgo no disponible:', e.message);
    }

    // Patologías
  renderPatologias(byIdPoblar('lista-patologias'), patologiasResumen);

    // Acuerdo reciente
    const ac = byIdPoblar('acuerdo-reciente');
    if (ac) {
      if (data?.acuerdo_reciente) {
        const ar = data.acuerdo_reciente;
        ac.textContent = `${ar.fecha_creacion || ''}: ${ar.acuerdos || ''} (${ar.cumplimiento || ''})`;
      } else {
        ac.textContent = '—';
      }
    }

    // Set select de sector y categoría input (antes del autocompletado, como en el original)
    const selSector = byIdPoblar('sector_id');
    if (selSector && u.sector_id) {
      selSector.value = u.sector_id;
    }
    const cat = byIdPoblar('categoria');
    if (cat) { cat.value = map.categoria_nombre; }

    // Autocompletar identificación (manteniendo logs y orden) - Pasar edad del backend
    autocompletarIdentificacion(u, selSector, data?.edad);
    
    // Mostrar/ocultar pestaña Adulto Mayor basada en la edad
    mostrarOcultarAdultoMayor(data?.edad);
    
    // Mostrar/ocultar pestaña Evaluación Diabetes basada en patologías
    mostrarOcultarDiabetes(data?.patologias_resumen);
    
    // Mostrar/ocultar sección IECA/ARA II basada en patologías
    mostrarOcultarIecaAra(data?.patologias_resumen);
    
    // Mostrar/ocultar sección Estatinas basada en patologías
    mostrarOcultarEstatinas(data?.patologias_resumen);
    
    // Mostrar/ocultar sección Antiagregantes basada en patologías
    mostrarOcultarAntiagregantes(data?.patologias_resumen);
    
    console.log('🔧 [DEBUG-POBLAR] *** POBLAR COMPLETADO ***');
    
    // Disparar evento global para flujos dependientes (alertas, etc.)
    try {
      const runEmit = (u?.run || '').trim();
      const payloadAlertas = Array.isArray(data?.alertas_vigencia) ? data.alertas_vigencia : undefined;
      window.dispatchEvent(new CustomEvent('usuario:cargado', {
        detail: {
          run: runEmit || null,
          alertas: payloadAlertas,
          fuente: 'poblar'
        }
      }));
    } catch (e) {
      console.warn('🔧 [DEBUG-POBLAR] No se pudo emitir usuario:cargado', e);
    }

    // Verificación adicional para pestañas condicionales después de un breve delay
    setTimeout(() => {
      console.log('🔧 [DEBUG] Verificación post-poblar de pestañas condicionales');
      mostrarOcultarAdultoMayor(data?.edad);
      mostrarOcultarDiabetes(data?.patologias_resumen);
      mostrarOcultarIecaAra(data?.patologias_resumen);
      mostrarOcultarEstatinas(data?.patologias_resumen);
      mostrarOcultarAntiagregantes(data?.patologias_resumen);
    }, 100);
  }

  // Función para mostrar/ocultar pestaña Adulto Mayor basada en la edad
  function mostrarOcultarAdultoMayor(edad) {
    console.log('🔧 [DEBUG] Verificando edad para Adulto Mayor:', edad, typeof edad);
    
    // Buscar la pestaña de "Adulto Mayor" (funcionalidad)
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    const panelAdultoMayor = document.querySelector('[data-panel="funcionalidad"]');
    
    if (tabAdultoMayor) {
      const edadNumerica = parseInt(edad);
      console.log('🔧 [DEBUG] Edad numérica calculada:', edadNumerica, 'Es válida:', !isNaN(edadNumerica));
      
      if (!isNaN(edadNumerica) && edadNumerica >= 65) {
        // Mostrar pestaña para usuarios de 65 años o más
        tabAdultoMayor.style.display = 'block';
        console.log('🔧 [DEBUG] ✅ Mostrando pestaña Adulto Mayor para edad:', edadNumerica);
      } else {
        // Ocultar pestaña para usuarios menores de 65 años o edad inválida
        tabAdultoMayor.style.display = 'none';
        console.log('🔧 [DEBUG] ❌ Ocultando pestaña Adulto Mayor para edad:', edadNumerica);
        
        // Si la pestaña activa es "funcionalidad", cambiar a "control"
        if (tabAdultoMayor.classList.contains('active') || tabAdultoMayor.classList.contains('t-tab-active')) {
          const tabControl = document.querySelector('[data-tab="control"]');
          if (tabControl) {
            tabControl.click();
            console.log('🔧 [DEBUG] Cambiando a pestaña Control porque Adulto Mayor estaba activa');
          }
        }
      }
      
      // Verificación adicional después del cambio
      const displayFinal = getComputedStyle(tabAdultoMayor).display;
      console.log('🔧 [DEBUG] Display final de pestaña Adulto Mayor:', displayFinal);
    } else {
      console.warn('🔧 [DEBUG] ⚠️ No se encontró la pestaña Adulto Mayor');
    }
  }

  // Función para mostrar/ocultar pestaña Evaluación Diabetes basada en si tiene diabetes + ERC
  function mostrarOcultarDiabetes(patologias_resumen) {
    console.log('🔧 [DEBUG] Verificando patologías para Evaluación Diabetes (requiere diabetes + ERC):', patologias_resumen);
    
    // Buscar la pestaña de "Evaluación Diabetes"
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    const panelDiabetes = document.querySelector('[data-panel="diabetes"]');
    
    if (tabDiabetes) {
      let tieneDiabetes = false;
      let tieneERC = false;
      
      // Verificar si tiene diabetes Y ERC en las patologías
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        // Verificar diabetes
        tieneDiabetes = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          // Buscar términos relacionados con diabetes
          return nombre.includes('diabetes') || cie10.includes('e10') || cie10.includes('e11') || 
                 cie10.includes('e12') || cie10.includes('e13') || cie10.includes('e14');
        });
        
        // Verificar enfermedad renal crónica (ERC)
        tieneERC = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          // Buscar términos relacionados con ERC
          return nombre.includes('renal cronica') || nombre.includes('renal crónica') || 
                 nombre.includes('erc') || nombre.includes('insuficiencia renal') ||
                 nombre.includes('nefropatía') || nombre.includes('nefropatia') ||
                 // Códigos CIE10 para ERC (N18 - Enfermedad renal crónica)
                 cie10.includes('n18') || cie10.includes('n180') || cie10.includes('n181') ||
                 cie10.includes('n182') || cie10.includes('n183') || cie10.includes('n184') ||
                 cie10.includes('n185') || cie10.includes('n186') || cie10.includes('n189');
        });
      }
      
      console.log('🔧 [DEBUG] Diabetes:', tieneDiabetes, '- ERC:', tieneERC);
      
      if (tieneDiabetes && tieneERC) {
        // Mostrar pestaña para usuarios con diabetes Y ERC
        tabDiabetes.style.display = 'block';
        console.log('🔧 [DEBUG] Mostrando pestaña Evaluación Diabetes - usuario tiene diabetes + ERC');
      } else {
        // Ocultar pestaña para usuarios sin diabetes o sin ERC
        tabDiabetes.style.display = 'none';
        const razon = !tieneDiabetes ? 'sin diabetes' : 'sin ERC';
        console.log(`🔧 [DEBUG] Ocultando pestaña Evaluación Diabetes - usuario ${razon}`);
        
        // Si la pestaña activa es "diabetes", cambiar a "control"
        if (tabDiabetes.classList.contains('active') || tabDiabetes.classList.contains('t-tab-active')) {
          const tabControl = document.querySelector('[data-tab="control"]');
          if (tabControl) {
            tabControl.click();
            console.log('🔧 [DEBUG] Cambiando a pestaña Control porque Evaluación Diabetes estaba activa');
          }
        }
      }
    } else {
      console.warn('🔧 [DEBUG] No se encontró la pestaña Evaluación Diabetes');
    }
  }

  // Función para mostrar/ocultar sección IECA/ARA II (solo para diabéticos con ERC)
  function mostrarOcultarIecaAra(patologias_resumen) {
    console.log('🔧 [DEBUG-IECA] Verificando patologías para IECA/ARA II (requiere diabetes + ERC):', patologias_resumen);
    
    const seccionIecaAra = document.getElementById('seccionIecaAra');
    
    if (seccionIecaAra) {
      let tieneDiabetes = false;
      let tieneERC = false;
      
      // Verificar si tiene diabetes Y ERC en las patologías
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        // Verificar diabetes (E10-E14)
        tieneDiabetes = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          return nombre.includes('diabetes') || 
                 cie10.includes('e10') || cie10.includes('e11') || 
                 cie10.includes('e12') || cie10.includes('e13') || cie10.includes('e14');
        });
        
        // Verificar enfermedad renal crónica (N18 - cualquier estadio)
        tieneERC = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          return nombre.includes('renal cronica') || nombre.includes('renal crónica') || 
                 nombre.includes('erc') || nombre.includes('insuficiencia renal') ||
                 nombre.includes('nefropatía') || nombre.includes('nefropatia') ||
                 // N18 (cualquier estadio: N18.0 a N18.9)
                 cie10.includes('n18');
        });
      }
      
      console.log('🔧 [DEBUG-IECA] Diabetes:', tieneDiabetes, '- ERC:', tieneERC);
      
      if (tieneDiabetes && tieneERC) {
        // Mostrar sección para usuarios con diabetes Y ERC
        seccionIecaAra.style.display = 'block';
        console.log('🔧 [DEBUG-IECA] Mostrando sección IECA/ARA II - usuario tiene diabetes + ERC');
      } else {
        // Ocultar sección para usuarios sin diabetes o sin ERC
        seccionIecaAra.style.display = 'none';
        const razon = !tieneDiabetes ? 'sin diabetes' : 'sin ERC';
        console.log(`🔧 [DEBUG-IECA] Ocultando sección IECA/ARA II - usuario ${razon}`);
      }
    } else {
      console.warn('🔧 [DEBUG-IECA] No se encontró la sección IECA/ARA II');
    }
  }

  // Función para mostrar/ocultar sección Estatinas (para personas con ECV, IAM o ACV)
  function mostrarOcultarEstatinas(patologias_resumen) {
    console.log('🔧 [DEBUG-ESTATINAS] Verificando patologías para Estatinas (requiere ECV, IAM o ACV):', patologias_resumen);
    
    const seccionEstatinas = document.getElementById('seccionEstatinas');
    
    if (seccionEstatinas) {
      let tieneCondicionCardiovascular = false;
      
      // Verificar si tiene alguna condición cardiovascular
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        tieneCondicionCardiovascular = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toUpperCase() : '';
          
          // ECV - Enfermedad Cardiovascular (I20-I25 excepto I21/I22, también I50)
          const esECV = 
            nombre.includes('cardiovascular') ||
            nombre.includes('cardiopatía') || nombre.includes('cardiopatia') ||
            nombre.includes('angina') ||
            nombre.includes('isquemia') || nombre.includes('isquemica') ||
            nombre.includes('insuficiencia cardíaca') || nombre.includes('insuficiencia cardiaca') ||
            cie10.includes('I20') || // Angina de pecho
            cie10.includes('I23') || // Complicaciones post-IAM
            cie10.includes('I24') || // Otras enfermedades isquémicas agudas
            cie10.includes('I25') || // Enfermedad isquémica crónica del corazón
            cie10.includes('I50');   // Insuficiencia cardíaca
          
          // IAM - Infarto Agudo al Miocardio (I21, I22)
          const esIAM = 
            nombre.includes('infarto') && (nombre.includes('miocardio') || nombre.includes('cardiaco')) ||
            nombre.includes('iam') ||
            cie10.includes('I21') || // IAM
            cie10.includes('I22');   // IAM subsecuente
          
          // ACV - Ataque Cerebrovascular (I63, I64, G45, G46)
          const esACV = 
            nombre.includes('cerebrovascular') ||
            nombre.includes('acv') || nombre.includes('avc') ||
            nombre.includes('ictus') ||
            nombre.includes('accidente vascular') ||
            nombre.includes('infarto cerebral') ||
            nombre.includes('hemorragia cerebral') ||
            nombre.includes('ataque isquémico') || nombre.includes('ataque isquemico') ||
            cie10.includes('I63') ||  // Infarto cerebral
            cie10.includes('I64') ||  // ACV no especificado
            cie10.includes('G45') ||  // Ataques isquémicos transitorios
            cie10.includes('G46');    // Síndromes vasculares cerebrales
          
          const resultado = esECV || esIAM || esACV;
          
          if (resultado) {
            console.log('🔧 [DEBUG-ESTATINAS] Condición cardiovascular encontrada:', {
              nombre: patologia.nombre,
              cie10: patologia.cie10,
              esECV: esECV,
              esIAM: esIAM,
              esACV: esACV
            });
          }
          
          return resultado;
        });
      }
      
      console.log('🔧 [DEBUG-ESTATINAS] Tiene condición cardiovascular:', tieneCondicionCardiovascular);
      
      if (tieneCondicionCardiovascular) {
        // Mostrar sección para usuarios con ECV, IAM o ACV
        seccionEstatinas.style.display = 'block';
        console.log('🔧 [DEBUG-ESTATINAS] Mostrando sección Estatinas - usuario tiene condición cardiovascular');
      } else {
        // Ocultar sección para usuarios sin condiciones cardiovasculares
        seccionEstatinas.style.display = 'none';
        console.log('🔧 [DEBUG-ESTATINAS] Ocultando sección Estatinas - usuario sin condición cardiovascular');
      }
    } else {
      console.warn('🔧 [DEBUG-ESTATINAS] No se encontró la sección Estatinas');
    }
  }

  // Función para mostrar/ocultar sección Antiagregantes Plaquetarios (mismas condiciones que Estatinas)
  function mostrarOcultarAntiagregantes(patologias_resumen) {
    console.log('🔧 [DEBUG-ANTIAGREGANTES] Verificando patologías para Antiagregantes (requiere ECV, IAM o ACV):', patologias_resumen);
    
    const seccionAntiagregantes = document.getElementById('seccionAntiagregantes');
    
    if (seccionAntiagregantes) {
      let tieneCondicionCardiovascular = false;
      
      // Verificar si tiene alguna condición cardiovascular (misma lógica que Estatinas)
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        tieneCondicionCardiovascular = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toUpperCase() : '';
          
          // ECV - Enfermedad Cardiovascular (I20-I25 excepto I21/I22, también I50)
          const esECV = 
            nombre.includes('cardiovascular') ||
            nombre.includes('cardiopatía') || nombre.includes('cardiopatia') ||
            nombre.includes('angina') ||
            nombre.includes('isquemia') || nombre.includes('isquemica') ||
            nombre.includes('insuficiencia cardíaca') || nombre.includes('insuficiencia cardiaca') ||
            cie10.includes('I20') || // Angina de pecho
            cie10.includes('I23') || // Complicaciones post-IAM
            cie10.includes('I24') || // Otras enfermedades isquémicas agudas
            cie10.includes('I25') || // Enfermedad isquémica crónica del corazón
            cie10.includes('I50');   // Insuficiencia cardíaca
          
          // IAM - Infarto Agudo al Miocardio (I21, I22)
          const esIAM = 
            nombre.includes('infarto') && (nombre.includes('miocardio') || nombre.includes('cardiaco')) ||
            nombre.includes('iam') ||
            cie10.includes('I21') || // IAM
            cie10.includes('I22');   // IAM subsecuente
          
          // ACV - Ataque Cerebrovascular (I63, I64, G45, G46)
          const esACV = 
            nombre.includes('cerebrovascular') ||
            nombre.includes('acv') || nombre.includes('avc') ||
            nombre.includes('ictus') ||
            nombre.includes('accidente vascular') ||
            nombre.includes('infarto cerebral') ||
            nombre.includes('hemorragia cerebral') ||
            nombre.includes('ataque isquémico') || nombre.includes('ataque isquemico') ||
            cie10.includes('I63') ||  // Infarto cerebral
            cie10.includes('I64') ||  // ACV no especificado
            cie10.includes('G45') ||  // Ataques isquémicos transitorios
            cie10.includes('G46');    // Síndromes vasculares cerebrales
          
          const resultado = esECV || esIAM || esACV;
          
          if (resultado) {
            console.log('🔧 [DEBUG-ANTIAGREGANTES] Condición cardiovascular encontrada:', {
              nombre: patologia.nombre,
              cie10: patologia.cie10,
              esECV: esECV,
              esIAM: esIAM,
              esACV: esACV
            });
          }
          
          return resultado;
        });
      }
      
      console.log('🔧 [DEBUG-ANTIAGREGANTES] Tiene condición cardiovascular:', tieneCondicionCardiovascular);
      
      if (tieneCondicionCardiovascular) {
        // Mostrar sección para usuarios con ECV, IAM o ACV
        seccionAntiagregantes.style.display = 'block';
        console.log('🔧 [DEBUG-ANTIAGREGANTES] Mostrando sección Antiagregantes - usuario tiene condición cardiovascular');
      } else {
        // Ocultar sección para usuarios sin condiciones cardiovasculares
        seccionAntiagregantes.style.display = 'none';
        console.log('🔧 [DEBUG-ANTIAGREGANTES] Ocultando sección Antiagregantes - usuario sin condición cardiovascular');
      }
    } else {
      console.warn('🔧 [DEBUG-ANTIAGREGANTES] No se encontró la sección Antiagregantes');
    }
  }

  // Función de diagnóstico simple
  window.testSimple = function() {
    console.log('🔧 [TEST-SIMPLE] Función test disponible');
  };
  
  // Función de test para verificar detección de diabetes + ERC
  window.testDiabetesERC = function() {
    console.log('🔧 [TEST-DIABETES-ERC] Probando detección...');
    
    // Caso 1: Solo diabetes
    const soloD = [{nombre: 'Diabetes mellitus tipo 2', cie10: 'E11'}];
    console.log('Test 1 - Solo diabetes:', soloD);
    mostrarOcultarDiabetes(soloD);
    
    // Caso 2: Solo ERC  
    const soloE = [{nombre: 'Enfermedad renal crónica', cie10: 'N18.6'}];
    console.log('Test 2 - Solo ERC:', soloE);
    mostrarOcultarDiabetes(soloE);
    
    // Caso 3: Diabetes + ERC (debería mostrar)
    const ambas = [
      {nombre: 'Diabetes mellitus tipo 2', cie10: 'E11'},
      {nombre: 'Enfermedad renal crónica', cie10: 'N18.6'}
    ];
    console.log('Test 3 - Diabetes + ERC:', ambas);
    mostrarOcultarDiabetes(ambas);
  };
  
  // Función de diagnóstico para pestañas
  window.diagnosticarPestanas = function() {
    console.log('🔧 [DIAGNOSTICO] Verificando estado de pestañas...');
    
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    const edadSpan = document.querySelector('[data-f="edad"]');
    
    console.log('Pestaña Adulto Mayor encontrada:', !!tabAdultoMayor);
    console.log('Pestaña Diabetes encontrada:', !!tabDiabetes);
    
    if (tabAdultoMayor) {
      console.log('Adulto Mayor display:', getComputedStyle(tabAdultoMayor).display);
      console.log('Adulto Mayor style.display:', tabAdultoMayor.style.display);
    }
    
    if (tabDiabetes) {
      console.log('Diabetes display:', getComputedStyle(tabDiabetes).display);
      console.log('Diabetes style.display:', tabDiabetes.style.display);
    }
    
    if (edadSpan) {
      const edad = edadSpan.textContent.trim();
      console.log('Edad actual del usuario:', edad);
      
      // Forzar verificación de edad
      console.log('Ejecutando mostrarOcultarAdultoMayor con edad:', edad);
      mostrarOcultarAdultoMayor(edad);
    } else {
      console.log('No se encontró span de edad');
    }
    return 'OK';
  };

  // Función de test de poblar con manejo de errores
  window.testPoblar = function() {
    console.log('🔧 [TEST] Iniciando test de poblar...');
    try {
      const testData = {
        usuario: {
          run: "10.000.141-1",
          nombre: "Patricio Pino Reyes", 
          fecha_nacimiento: "Thu, 12 Mar 1964 00:00:00 GMT",
          sexo: "masculino",
          sector_nombre: "VERDE"
        },
        edad: 61
      };
      console.log('🔧 [TEST] Datos de prueba creados:', testData);
      
      if (typeof poblar === 'function') {
        console.log('🔧 [TEST] Función poblar encontrada, ejecutando...');
        poblar(testData);
        console.log('🔧 [TEST] Función poblar ejecutada');
      } else {
        console.error('🔧 [TEST] ERROR: función poblar no encontrada');
      }
    } catch(error) {
      console.error('🔧 [TEST] ERROR en testPoblar:', error);
    }
    console.log('🔧 [TEST] Test completado');
    return 'Test ejecutado';
  };

  // Test de fecha específico
  window.testFecha = function() {
    console.log('🔧 [TEST-FECHA] Probando formateo de fecha...');
    const fecha = 'Thu, 12 Mar 1964 00:00:00 GMT';
    console.log('🔧 [TEST-FECHA] Fecha original:', fecha);
    const fechaFormateada = new Date(fecha).toLocaleDateString('es-CL');
    console.log('🔧 [TEST-FECHA] Fecha formateada:', fechaFormateada);
    return fechaFormateada;
  };
  // Fuerza estado inicial: sólo toolbar visible
  (function hardStart(){
    const ident = document.getElementById('identificacion-section');
    const cardResumen = document.getElementById('card-resumen');
    if (ident) ident.style.display='none';
    if (cardResumen) cardResumen.style.display='none';
    
    // Asegurar que la pestaña Adulto Mayor esté oculta inicialmente
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    if (tabAdultoMayor) {
      tabAdultoMayor.style.display = 'none';
      console.log('🔧 [INIT] Pestaña Adulto Mayor oculta al iniciar');
    }
    
    // Asegurar que la pestaña Evaluación Diabetes esté oculta inicialmente
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    if (tabDiabetes) {
      tabDiabetes.style.display = 'none';
      console.log('🔧 [INIT] Pestaña Evaluación Diabetes oculta al iniciar (requiere diabetes + ERC)');
    }
    
    // Verificación periódica de pestañas para casos donde se cargan datos después
    setTimeout(() => {
      console.log('🔧 [INIT] Verificación de pestañas condicionales después de inicialización');
      
      // Verificar si hay edad cargada
      const edadSpan = document.querySelector('[data-f="edad"]');
      if (edadSpan && edadSpan.textContent.trim()) {
        const edad = edadSpan.textContent.trim();
        console.log('🔧 [INIT] Edad encontrada en DOM:', edad);
        mostrarOcultarAdultoMayor(edad);
      }
      
      // Verificar pestañas y forzar estado correcto
      const tabAM = document.querySelector('[data-tab="funcionalidad"]');
      const tabD = document.querySelector('[data-tab="diabetes"]');
      
      if (tabAM && !tabAM.style.display) {
        console.log('🔧 [INIT] Forzando ocultamiento de pestaña Adulto Mayor sin display definido');
        tabAM.style.display = 'none';
      }
      
      if (tabD && !tabD.style.display) {
        console.log('🔧 [INIT] Forzando ocultamiento de pestaña Diabetes sin display definido');
        tabD.style.display = 'none';
      }
    }, 500);
  })();

  // --- NUEVO FLUJO BUSCAR RUN ---
  document.addEventListener('DOMContentLoaded', function(){
    const ident = document.getElementById('identificacion-section');
    const formTarjeton = document.getElementById('form-tarjeton');
    const cardResumen = document.getElementById('card-resumen');
    const layoutGrid = document.getElementById('layout-tarjeton-grid');
    const runSearch = document.getElementById('run-search');
    const btnBuscar = document.getElementById('btn-buscar-run');
    const helpSearch = document.getElementById('run-search-help');
    const runForm = document.getElementById('run');
    const btnEditarIdent = document.getElementById('btn-editar-ident');
    window._identEditadoManualmente = false;
    
    console.log('🔍 [INIT] Elementos de búsqueda cargados:', {
      ident: !!ident,
      formTarjeton: !!formTarjeton,
      cardResumen: !!cardResumen,
      layoutGrid: !!layoutGrid,
      runSearch: !!runSearch,
      btnBuscar: !!btnBuscar,
      helpSearch: !!helpSearch,
      runForm: !!runForm,
      btnEditarIdent: !!btnEditarIdent
    });

    // Funcionalidad de colapso removida - resumen siempre visible

    // Marcar edición manual en cualquier cambio de inputs clave
    ['run','nombre','fecha_nacimiento','sexo','telefono','direccion','sector_id'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){ el.addEventListener('input', ()=>{ window._identEditadoManualmente = true; }); }
    });

    if(btnEditarIdent){
      btnEditarIdent.addEventListener('click', ()=>{
        if(cardResumen) cardResumen.style.display='none';
        if(ident) ident.style.display='block';
        layoutGrid?.classList.add('no-resumen');
        layoutGrid?.classList.remove('solo-resumen');
        // No reseteamos banderas aquí: se asume usuario quiere preservar cambios
      });
    }

    function mostrarIdentificacionNuevo(runPrefill){
      if (runPrefill && runForm){ runForm.value = runPrefill; }
      if (runPrefill) {
        const runCanon = formatearRunParaEnvio(runPrefill);
        window._runActivo = runCanon || runPrefill;
      }
      if (cardResumen) cardResumen.style.display = 'none';
      if (ident) ident.style.display = 'block';
      layoutGrid?.classList.add('no-resumen');
      const badgeNuevo = document.getElementById('badge-nuevo-usuario');
      if(badgeNuevo) badgeNuevo.style.display='inline-block';
    }
    // Resumen siempre visible: se eliminan mostrarResumen/ocultarTodoMenosToolbar.

    function normalizarRun(v){ return (v||'').toString().replace(/[.\-]/g,'').toUpperCase(); }
    function validarRunCl(v){
      const s = normalizarRun(v);
      if (s.length < 2) return false;
      const cuerpo = s.slice(0,-1); const dv = s.slice(-1);
      if(!/^\d+$/.test(cuerpo)) return false;
      let suma=0, mul=2;
      for(let i=cuerpo.length-1;i>=0;i--){
        suma += parseInt(cuerpo[i],10)*mul;
        mul = (mul===7)?2:(mul+1);
      }
      const res = 11 - (suma % 11);
      const dvCalc = res===11? '0' : (res===10? 'K' : String(res));
      return dvCalc === dv;
    }

    // ==== Helpers de UI/valores (sin efectos secundarios extraños) ====
    function trimRun() {
      const vSearch = (runSearch?.value || '').trim();
      if (vSearch) return vSearch;
      const runField = document.getElementById('run');
      return (runField?.value || '').trim();
    }

    function isOkData(resp, data) {
      return resp.ok && data && data.ok && (data.usuario || data.patologias_resumen || data.edad !== undefined);
    }

    function marcarValidez(ok){
      runSearch.classList.toggle('is-invalid', !ok);
      runSearch.classList.toggle('is-valid', !!ok);
      helpSearch.style.display = ok ? 'none' : 'block';
    }

    // Listener mejorado con autocompletado
    runSearch?.addEventListener('input', ()=>{
      const ok = validarRunCl(runSearch.value);
      marcarValidez(ok);
      
      // Sincronizar con campo RUN del formulario
      if (runForm && runSearch.value) {
        runForm.value = runSearch.value;
      }
      if (ok) {
        const runCanon = formatearRunParaEnvio(runSearch.value.trim());
        window._runActivo = runCanon || runSearch.value.trim();
      }
    });

    // Sincronización bidireccional: si se escribe en el formulario, actualizar búsqueda
    runForm?.addEventListener('input', ()=>{
      if (runSearch && runForm.value) {
        runSearch.value = runForm.value;
        const ok = validarRunCl(runForm.value);
        marcarValidez(ok);
        if (ok) {
          const runCanon = formatearRunParaEnvio(runForm.value.trim());
          window._runActivo = runCanon || runForm.value.trim();
        }
      }
    });

    async function buscarRun(){
      console.log('🔍 [BUSCAR_RUN] =============================================');
      console.log('🔍 [BUSCAR_RUN] Función buscarRun() ejecutada');
      console.log('🔍 [BUSCAR_RUN] Timestamp:', new Date().toISOString());
      
      console.log('🔍 [BUSCAR_RUN] Paso 1: Obteniendo RUN con trimRun()...');
      const val = trimRun();
      console.log('🔍 [BUSCAR_RUN] RUN obtenido:', `"${val}"`);
      
      if (!val) {
        console.error('❌ [BUSCAR_RUN] Campo RUN está vacío');
        alert('Por favor, ingrese un RUN para buscar');
        const runInput = document.getElementById('run-search');
        if (runInput) runInput.focus();
        return;
      }

      console.log('🔍 [BUSCAR_RUN] Paso 2: Validando RUN...');
      console.log('🔍 [BUSCAR_RUN] Función validarRunCl disponible:', typeof validarRunCl);
      const esValido = validarRunCl(val);
      console.log('🔍 [BUSCAR_RUN] RUN válido:', esValido);
      
      if(!esValido){
        marcarValidez(false);
        console.error('❌ [BUSCAR_RUN] RUN inválido, deteniendo');
        alert('RUN inválido. Formato esperado: 12.345.678-9');
        return;
      }
      
      console.log('🔍 [BUSCAR_RUN] Paso 3: Marcando como válido...');
      marcarValidez(true);

      // === Helpers para búsqueda ===
      const createLoadingManager = () => {
        const btnLbl = btnBuscar.querySelector('.lbl');
        const spinWrap = btnBuscar.querySelector('.spinner');
        
        return (on) => {
          if(on){
            btnBuscar.disabled = true;
            btnLbl.style.opacity = '0';
            spinWrap.style.display = 'flex';
          } else {
            btnBuscar.disabled = false;
            btnLbl.style.opacity = '1';
            spinWrap.style.display = 'none';
          }
        };
      };

      // === Helpers puros para buscarRun ===
      const parseJsonOrText = async (r) => {
        try{
          const data = await r.json();
          console.log('🔍 [DEBUG] Respuesta JSON parseada:', data);
          return data;
        } catch(jsonError){
          console.error('🔍 [DEBUG] Error parseando JSON:', jsonError);
          const textResponse = await r.text();
          console.log('🔍 [DEBUG] Respuesta como texto:', textResponse);
          return { ok: false, error: 'JSON_PARSE_ERROR' };
        }
      };

      const aplicarUIUsuarioExistente = async (val, data) => {
        console.log('Aplicando UI para usuario existente:', data?.usuario?.nombre);
        const runCanon = formatearRunParaEnvio(val);
        window._runActivo = runCanon || val;
        
        // Limpiar selección de patologías antes de poblar
        if (typeof window._limpiarSeleccionRiesgo === 'function') {
          window._limpiarSeleccionRiesgo();
          console.log('🧹 [BUSCAR_RUN] Selección de patologías limpiada');
        }
        
        if (typeof poblar === 'function') poblar(data);

        // Cargar programa actual del usuario (CARDIO/ECICEP)
        if (typeof window.cargarProgramaUsuario === 'function') {
          window.cargarProgramaUsuario(val);
        }

        // Ocultar identificación si estaba abierta
        if (ident) ident.style.display = 'none';

        // Asegurar resumen visible + ajustar layout
        if (cardResumen){
          cardResumen.style.display = 'flex';
          cardResumen.classList.remove('expandido');
        }
        layoutGrid?.classList.remove('no-resumen');
        layoutGrid?.classList.add('solo-resumen');

        // Acceso seguro evitando TDZ (ReferenceError) si recargaTodo aún no está inicializada
        try {
          if (window.recargaTodo instanceof Function) {
            await window.recargaTodo(val);
          }
        } catch(_tdzErr) {
          console.warn('[RUN] recargaTodo no disponible todavía, se omitió la recarga inicial');
        }
        

      };

      const flujoUsuarioNoExistente = (val) => {
        // Crear diálogo de confirmación mejorado
        const dialogHTML = `
          <div id="confirm-nuevo-usuario" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
          ">
            <div style="
              background: white;
              border-radius: 12px;
              padding: 24px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              max-width: 400px;
              width: 90%;
              text-align: center;
            ">
              <div style="
                width: 60px;
                height: 60px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                margin: 0 auto 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
              ">⚠️</div>
              
              <h3 style="margin: 0 0 12px; color: #1f2937;">Usuario No Encontrado</h3>
              
              <p style="margin: 0 0 20px; color: #6b7280; line-height: 1.5;">
                El RUN <strong>${val}</strong> es válido pero no existe en el sistema.
                <br><br>
                ¿Deseas ingresar un nuevo usuario?
              </p>
              
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="btn-confirm-si" style="
                  background: #059669;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#059669'">
                  ✅ Sí, Ingresar Usuario
                </button>
                
                <button id="btn-confirmar-no" style="
                  background: #6b7280;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                  ❌ No, Cancelar
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Agregar animación CSS si no existe
        if (!document.getElementById('confirm-dialog-styles')) {
          const style = document.createElement('style');
          style.id = 'confirm-dialog-styles';
          style.textContent = `
            @keyframes fadeIn {
              from { opacity: 0; transform: scale(0.9); }
              to { opacity: 1; transform: scale(1); }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.insertAdjacentHTML('beforeend', dialogHTML);
        
        const dialog = document.getElementById('confirm-nuevo-usuario');
        const btnSi = document.getElementById('btn-confirm-si');
        const btnNo = document.getElementById('btn-confirmar-no');
        
        btnSi.addEventListener('click', () => {
          dialog.remove();
          mostrarIdentificacionNuevo(val);
          const badgeNuevo = document.getElementById('badge-nuevo-usuario');
          if(badgeNuevo) badgeNuevo.style.display='inline-block';
          window._identEditadoManualmente = false;
          
          // Mostrar mensaje de ayuda para patologías
          setTimeout(() => {
            const estadoPats = document.getElementById('estado-patologias');
            if (estadoPats) {
              estadoPats.textContent = '💡 Tip: Busca y selecciona patologías para el nuevo usuario';
              estadoPats.style.color = '#059669';
            }
          }, 500);
        });
        
        btnNo.addEventListener('click', () => {
          dialog.remove();
          if (ident) ident.style.display = 'none';
          if (cardResumen) cardResumen.style.display = 'none';
        });
        
        // Cerrar con Escape
        document.addEventListener('keydown', function handleEscape(e) {
          if (e.key === 'Escape') {
            dialog.remove();
            document.removeEventListener('keydown', handleEscape);
          }
        });
      };

      console.log('🔍 [BUSCAR_RUN] Paso 4: Configurando loading manager...');
      const setLoading = createLoadingManager();
      console.log('🔍 [BUSCAR_RUN] Loading manager creado:', typeof setLoading);
      
      console.log('🔍 [BUSCAR_RUN] Paso 5: Activando loading...');
      setLoading(true);

      const url = `/api/tarjeton/${encodeURIComponent(val)}`;
      console.log('🔍 [BUSCAR_RUN] Paso 6: URL generada para API:', url);
      console.log('🔍 [BUSCAR_RUN] RUN codificado:', encodeURIComponent(val));
      
      console.log('🔍 [BUSCAR_RUN] Paso 7: Iniciando petición HTTP con authFetch...');
      console.log('🔍 [BUSCAR_RUN] Función authFetch disponible:', typeof authFetch);

      try{
        const r = await authFetch(url);
        console.log('🔍 [DEBUG] Response status:', r.status, r.ok);

        // Manejo específico de errores HTTP
        if (r.status === 404) {
          console.log('🔍 [DEBUG] Usuario no encontrado (404)');
          flujoUsuarioNoExistente(val);
          setLoading(false);
          return;
        }
        
        if (r.status === 429) {
          console.warn('🔍 [DEBUG] Límite de solicitudes excedido (429)');
          alert('⚠️ Demasiadas solicitudes. Espere un momento e intente nuevamente.');
          setLoading(false);
          return;
        }
        
        if (r.status >= 500) {
          console.error('🔍 [DEBUG] Error del servidor:', r.status);
          alert('❌ Error del servidor. El sistema puede estar experimentando problemas.\n\nInténtelo nuevamente en unos momentos.');
          setLoading(false);
          return;
        }

        const data = await parseJsonOrText(r);

        if (isOkData(r, data)){
          await aplicarUIUsuarioExistente(val, data);
          setLoading(false);
          return;
        }
        
        // Si llegamos aquí, no hay datos válidos pero tampoco error HTTP
        console.log('🔍 [DEBUG] Sin datos válidos, tratando como usuario no existente');
        flujoUsuarioNoExistente(val);
        
      } catch(e){
        console.error('❌ [BUSCAR_RUN] Error crítico capturado en buscarRun()');
        console.error('❌ [BUSCAR_RUN] Error completo:', e);
        console.error('❌ [BUSCAR_RUN] Tipo de error:', e.name);
        console.error('❌ [BUSCAR_RUN] Mensaje:', e.message);
        console.error('❌ [BUSCAR_RUN] Stack trace:', e.stack);
        
        // Manejo más específico de errores de red
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
          console.error('❌ [BUSCAR_RUN] Error de red/fetch detectado');
          alert('❌ Error de conexión. Verifique su conexión a internet e intente nuevamente.');
        } else if (e.message.includes('JSON')) {
          console.error('❌ [BUSCAR_RUN] Error de parsing JSON detectado');
          alert('⚠️ Error procesando respuesta del servidor. El formato de datos no es válido.');
        } else {
          console.error('❌ [BUSCAR_RUN] Error genérico/desconocido');
          alert('❌ Error inesperado consultando el RUN.\n\nDetalles: ' + e.message + '\n\nInténtelo nuevamente.');
        }
      } finally {
        console.log('🔍 [BUSCAR_RUN] Finally block ejecutado');
        setLoading(false);
        console.log('🔍 [BUSCAR_RUN] =============================================');
      }
    }

    // === Configuración de event listeners ===
    const setupBuscarEventListeners = () => {
      // Debug: verificar que los elementos existen
      console.log('btnBuscar encontrado:', !!btnBuscar);
      console.log('runSearch encontrado:', !!runSearch);
      
      btnBuscar?.addEventListener('click', function() {
        console.log('🔍 [DEBUG] Click en botón buscar detectado');
        buscarRun();
      });
      
      runSearch?.addEventListener('keydown', e=>{ 
        if(e.key==='Enter'){ 
          e.preventDefault(); 
          buscarRun(); 
        }
      });
      
      // Debug adicional: verificar si el evento se registró
      if (btnBuscar) {
        console.log('Event listener agregado al botón de búsqueda');
      } else {
        console.error('No se encontró el botón btn-buscar-run');
      }

      // Listener Enter directo sobre el campo principal #run
      if (runForm){
        runForm.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            e.preventDefault();
            // Sincronizar visualmente ambos campos antes de buscar
            if(runSearch && runForm.value.trim()){
              runSearch.value = runForm.value.trim();
            }
            buscarRun();
          }
        });
      }

      // Blur listener para runForm con búsqueda automática mejorada
      if (runForm){
        runForm.addEventListener('blur', ()=>{
          const v = runForm.value.trim();
          if(!v) return; 
          runSearch.value = v; 
          
          // Buscar automáticamente si el RUN es válido
          if (validarRunCl(v)) {
            buscarRun();
          }
        });
        
        // También buscar automáticamente cuando se termine de escribir un RUN válido
        let timeoutId;
        runForm.addEventListener('input', () => {
          clearTimeout(timeoutId);
          const v = runForm.value.trim();
          
          if (v && validarRunCl(v)) {
            // Esperar 1 segundo después de dejar de escribir
            timeoutId = setTimeout(() => {
              runSearch.value = v;
              buscarRun();
            }, 1000);
          }
        });
      }
    };

    setupBuscarEventListeners();
    // Botón nuevo usuario fuerza formulario vacío
    const btnNuevo = document.getElementById('btn-nuevo-usuario');
    btnNuevo?.addEventListener('click', ()=>{
      if(formTarjeton){ formTarjeton.reset(); }
      if(runForm){ runForm.value=''; }
      if(cardResumen){ cardResumen.style.display='none'; cardResumen.classList.remove('expandido'); }
      if(ident){ ident.style.display='block'; }
      layoutGrid?.classList.add('no-resumen');
      layoutGrid?.classList.remove('solo-resumen');
      const nombre=document.getElementById('nombre');
      setTimeout(()=> nombre&&nombre.focus(),0);
      const badgeNuevo = document.getElementById('badge-nuevo-usuario');
      if(badgeNuevo) badgeNuevo.style.display='inline-block';
    });

    // Botón limpiar - limpia todo el formulario
    const btnLimpiar = document.getElementById('btn-limpiar');
    btnLimpiar?.addEventListener('click', ()=>{
      if(confirm('¿Estás seguro de que deseas limpiar todo el formulario?')) {
        if(formTarjeton){ formTarjeton.reset(); }
        if(runForm){ runForm.value=''; }
        if(cardResumen){ cardResumen.style.display='none'; cardResumen.classList.remove('expandido'); }
        if(ident){ ident.style.display='block'; }
        layoutGrid?.classList.add('no-resumen');
        layoutGrid?.classList.remove('solo-resumen');
        
        // Limpiar campos específicos que podrían no limpiarse con reset()
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          if(input.type === 'checkbox' || input.type === 'radio') {
            input.checked = false;
          } else {
            input.value = '';
          }
        });
        
        const nombre=document.getElementById('nombre');
        setTimeout(()=> nombre&&nombre.focus(),0);
        
        console.log('Formulario limpiado completamente');
      }
    });

    // Botón MandrakeBot - abrir chat
    const btnMandrakeBot = document.getElementById('btn-mandrake-bot');
    const chatOverlay = document.getElementById('mandrake-chat-overlay'); 
    const chatClose = document.getElementById('mandrake-chat-close');
    const chatMessages = document.getElementById('mandrake-chat-messages');
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    // Debug: verificar que los elementos existen
    console.log('MandrakeBot elements:', {
      btnMandrakeBot: !!btnMandrakeBot,
      chatOverlay: !!chatOverlay,
      chatClose: !!chatClose,
      chatMessages: !!chatMessages,
      chatInput: !!chatInput,
      chatSend: !!chatSend
    });
    
    let isMandrakeActive = false;
    
    // Función para agregar mensaje al chat
    function addChatMessage(content, type = 'bot', isHtml = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `mandrake-message ${type}`;
      
      if (isHtml) {
        messageDiv.innerHTML = content;
      } else {
        messageDiv.textContent = content;
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return messageDiv;
    }
    
    // Función para mostrar indicador de escritura
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'mandrake-typing';
      typingDiv.innerHTML = `
        <span style="font-size:12px;">MandrakeBot está escribiendo</span>
        <div class="mandrake-typing-dots">
          <div class="mandrake-typing-dot"></div>
          <div class="mandrake-typing-dot"></div>
          <div class="mandrake-typing-dot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return typingDiv;
    }
    
    // Función para llamar a la IA
    async function callMandrakeAI(userMessage) {
      try {
        const response = await fetch('/api/ai/fill-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: userMessage,
            instruction: `Eres MandrakeBot, un asistente médico inteligente especializado en ECICEP. 
                         Responde de manera profesional, empática y útil. 
                         Si la consulta es médica, proporciona información educativa pero recuerda que no reemplazas el criterio médico profesional.
                         Si pueden ayudar con el formulario actual, ofrece autocompletarlo.
                         Mantén respuestas concisas pero completas.`,
            schema: {
              type: "object",
              properties: {
                response: {
                  type: "string",
                  description: "Respuesta del asistente médico"
                },
                suggestions: {
                  type: "array",
                  items: { type: "string" },
                  description: "Sugerencias de seguimiento opcional"
                },
                form_help: {
                  type: "boolean", 
                  description: "Si puede ayudar con el formulario actual"
                }
              }
            }
          })
        });
        
        const result = await response.json();
        
        if (result.ok && result.data) {
          return {
            response: result.data.response || 'Lo siento, no pude procesar tu consulta.',
            suggestions: result.data.suggestions || [],
            form_help: result.data.form_help || false
          };
        } else {
          throw new Error(result._error || 'Error en la respuesta de IA');
        }
      } catch (error) {
        console.error('Error llamando a MandrakeBot:', error);
        return {
          response: 'Lo siento, hay un problema de conexión. Por favor intenta nuevamente.',
          suggestions: [],
          form_help: false
        };
      }
    }
    
    // Función para enviar mensaje
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Agregar mensaje del usuario
      addChatMessage(message, 'user');
      chatInput.value = '';
      chatSend.disabled = true;
      
      // Mostrar indicador de escritura
      const typingIndicator = showTypingIndicator();
      
      // Llamar a la IA
      const aiResponse = await callMandrakeAI(message);
      
      // Remover indicador de escritura
      typingIndicator.remove();
      
      // Agregar respuesta del bot
      let botMessage = aiResponse.response;
      
      // Agregar sugerencias si las hay
      if (aiResponse.suggestions && aiResponse.suggestions.length > 0) {
        botMessage += '\n\n💡 Sugerencias:\n' + aiResponse.suggestions.map(s => `• ${s}`).join('\n');
      }
      
      // Agregar ayuda con formulario si corresponde
      if (aiResponse.form_help) {
        botMessage += '\n\n📝 ¿Te gustaría que te ayude a completar algún campo del formulario actual?';
      }
      
      addChatMessage(botMessage, 'bot');
      chatSend.disabled = false;
      chatInput.focus();
    }
    
    // Event listeners del chat
    if (btnMandrakeBot) {
      btnMandrakeBot.addEventListener('click', () => {
        console.log('MandrakeBot button clicked!');
        if (!chatOverlay) {
          console.error('Chat overlay not found!');
          return;
        }
        chatOverlay.style.display = 'flex';
        isMandrakeActive = true;
        if (chatInput) chatInput.focus();
      
      // Mensaje de bienvenida contextual
      if (chatMessages.children.length === 1) { // Solo mensaje inicial
        const runValue = document.getElementById('run')?.value || '';
        if (runValue) {
          addChatMessage(`Veo que estás trabajando con el RUN ${runValue}. ¿En qué puedo ayudarte con este paciente?`, 'system');
        }
      }
    });
    
    chatClose?.addEventListener('click', () => {
      chatOverlay.style.display = 'none';
      isMandrakeActive = false;
    });
    
    chatOverlay?.addEventListener('click', (e) => {
      if (e.target === chatOverlay) {
        chatOverlay.style.display = 'none';
        isMandrakeActive = false;
      }
    });
    
    chatSend?.addEventListener('click', sendMessage);
    
    chatInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + M para abrir/cerrar MandrakeBot
      if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        if (isMandrakeActive) {
          chatOverlay.style.display = 'none';
          isMandrakeActive = false;
        } else {
          btnMandrakeBot?.click();
        }
      }
      
      // Escape para cerrar chat
      if (e.key === 'Escape' && isMandrakeActive) {
        chatOverlay.style.display = 'none';
        isMandrakeActive = false;
      }
    });
    } else {
      console.error('MandrakeBot button not found!');
    }

  });
  // (Listeners antiguos de cargarDatos y debounce eliminados)

  // Función global para abrir MandrakeBot (respaldo)
  function openMandrakeBot() {
    console.log('openMandrakeBot() called');
    const chatOverlay = document.getElementById('mandrake-chat-overlay');
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatClose = document.getElementById('mandrake-chat-close');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    if (chatOverlay) {
      chatOverlay.style.display = 'flex';
      if (chatInput) chatInput.focus();
      
      // Configurar event listeners si no están configurados
      if (chatClose && !chatClose.onclick) {
        chatClose.onclick = () => {
          chatOverlay.style.display = 'none';
        };
      }
      
      if (chatSend && !chatSend.onclick) {
        chatSend.onclick = () => {
          sendMandrakeMessage();
        };
      }
      
      if (chatInput && !chatInput.onkeypress) {
        chatInput.onkeypress = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMandrakeMessage();
          }
        };
      }
      
      // Event listener para cerrar con click fuera
      chatOverlay.onclick = (e) => {
        if (e.target === chatOverlay) {
          chatOverlay.style.display = 'none';
        }
      };
      
      // Mensaje de bienvenida contextual
      const chatMessages = document.getElementById('mandrake-chat-messages');
      if (chatMessages && chatMessages.children.length === 1) {
        const runValue = document.getElementById('run')?.value || '';
        if (runValue) {
          const systemMsg = document.createElement('div');
          systemMsg.className = 'mandrake-message system';
          systemMsg.textContent = `Veo que estás trabajando con el RUN ${runValue}. ¿En qué puedo ayudarte con este paciente?`;
          chatMessages.appendChild(systemMsg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
    } else {
      console.error('Chat overlay not found!');
    }
  }
  
  // Función para enviar mensaje
  async function sendMandrakeMessage() {
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatMessages = document.getElementById('mandrake-chat-messages');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Agregar mensaje del usuario
    const userMsg = document.createElement('div');
    userMsg.className = 'mandrake-message user';
    userMsg.textContent = message;
    chatMessages.appendChild(userMsg);
    
    chatInput.value = '';
    chatSend.disabled = true;
    
    // Mostrar indicador de escritura
    const typingDiv = document.createElement('div');
    typingDiv.className = 'mandrake-typing';
    typingDiv.innerHTML = `
      <span style="font-size:12px;">MandrakeBot está escribiendo</span>
      <div class="mandrake-typing-dots">
        <div class="mandrake-typing-dot"></div>
        <div class="mandrake-typing-dot"></div>
        <div class="mandrake-typing-dot"></div>
      </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    try {
      // Llamar a la IA
      const response = await fetch('/api/ai/fill-form', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: message,
          instruction: `Eres MandrakeBot, un asistente médico inteligente especializado en ECICEP. 
                       Responde de manera profesional, empática y útil. 
                       Si la consulta es médica, proporciona información educativa pero recuerda que no reemplazas el criterio médico profesional.
                       Si pueden ayudar con el formulario actual, ofrece autocompletarlo.
                       Mantén respuestas concisas pero completas.`,
          schema: {
            type: "object",
            properties: {
              response: {
                type: "string",
                description: "Respuesta del asistente médico"
              }
            }
          }
        })
      });
      
      const result = await response.json();
      
      // Remover indicador de escritura
      typingDiv.remove();
      
      // Agregar respuesta del bot
      const botMsg = document.createElement('div');
      botMsg.className = 'mandrake-message bot';
      botMsg.textContent = result.ok && result.data ? 
        result.data.response || 'Lo siento, no pude procesar tu consulta.' :
        'Lo siento, hay un problema de conexión. Por favor intenta nuevamente.';
      
      chatMessages.appendChild(botMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
    } catch (error) {
      console.error('Error llamando a MandrakeBot:', error);
      typingDiv.remove();
      
      const errorMsg = document.createElement('div');
      errorMsg.className = 'mandrake-message bot';
      errorMsg.textContent = 'Lo siento, hay un problema de conexión. Por favor intenta nuevamente.';
      chatMessages.appendChild(errorMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    chatSend.disabled = false;
    chatInput.focus();
  }
  
  // Hacer la función global para que sea accesible desde los event listeners
  window.sendMandrakeMessage = sendMandrakeMessage;

  const CUMPLIMIENTO_LABELS = {
    "inicio de acuerdos consensuados": "Inicio de acuerdos consensuados",
    cumple: "Cumple",
    "cumple parcialmente": "Cumple parcialmente",
    "no cumple": "No cumple",
  };

  function formatearCumplimiento(valor){
    if(!valor) return '—';
    const key = valor.toString().trim().toLowerCase();
    return CUMPLIMIENTO_LABELS[key] || valor;
  }

  async function cargarUltimoControl(runVal){
    if(!runVal) return;
    const limpio = runVal.replace(/[^0-9kK]/g,'');
    if(limpio.length < 7) return;
    try{
      const r = await authFetch(`/api/control/ultimo/${encodeURIComponent(runVal)}`);
      const d = await r.json();
      const panel = document.getElementById('panel-control');
      if(!panel) return;
      const ok = (typeof d.ok !== 'undefined') ? d.ok : (typeof d.success !== 'undefined' ? d.success : !!d.control);
      if(!ok){ panel.innerHTML='<div style="color:#b91c1c">Error cargando control</div>'; console.warn('Ultimo control respuesta inesperada', d); return; }
      if(!d.control){ panel.innerHTML='<div style="opacity:.6;">Sin control registrado.</div>'; return; }
      const c = d.control;
      const fechaFmt = formatearFechaCorta(c.fecha);
      const { bg: imcBgRaw, color: imcColorRaw } = obtenerColoresIMC(c.imc_clasificacion);
      const { bg: htaBgRaw, color: htaColorRaw } = obtenerColoresHTA(c.hta_clasificacion);
      const badgeBase = 'display:inline-block;padding:2px 10px;border-radius:999px;font-size:.75rem;font-weight:600;';
      const imcBg = imcBgRaw || 'rgba(100, 116, 139, 0.35)';
      const imcColor = imcColorRaw || '#fff';
      const htaBg = htaBgRaw || 'rgba(100, 116, 139, 0.35)';
      const htaColor = htaColorRaw || '#fff';
      panel.innerHTML = `
        <div><strong>Fecha:</strong> ${fechaFmt} <strong style="margin-left:8px;">Profesional:</strong> ${c.profesional||'—'}</div>
        <div><strong>Peso:</strong> ${c.peso??'—'} kg <strong style="margin-left:8px;">Talla:</strong> ${c.talla??'—'} <strong style="margin-left:8px;">IMC:</strong> ${c.imc??'—'} <span class="badge-riesgo" style="${badgeBase}background:${imcBg};color:${imcColor};">${c.imc_clasificacion||'—'}</span></div>
        <div><strong>PA:</strong> ${c.presion_sistolica??'—'}/${c.presion_diastolica??'—'} mmHg <span class="badge-riesgo" style="${badgeBase}background:${htaBg};color:${htaColor};">${c.hta_clasificacion||'—'}</span></div>
        <div><strong>CC:</strong> ${c.cc??'—'} <strong style="margin-left:8px;">HGT:</strong> ${c.hgt??'—'} <strong style="margin-left:8px;">HbA1c:</strong> ${c.hba1c??'—'}</div>
      `;
    }catch(e){ console.warn('Error control', e); }
  }
  // recargaTodo movido al final después de todas las definiciones de funciones
  // (Listeners vinculados a recargaTodo en input RUN eliminados; flujo centralizado en toolbar)

  // Cargar último examen pie diabético
  async function cargarUltimoExamenPieDiabetico(runVal){
    try {
      // Por ahora solo log, ya que no hay endpoint específico disponible
      console.log('[🦶 Pie Diabético] Función de carga llamada para:', runVal);
      // TODO: Implementar cuando esté disponible el endpoint /api/examenes-piedm/ultimo/
    } catch(e) {
      console.warn('[🦶 Pie Diabético] Error cargando último examen pie diabético:', e);
    }
  }

  // Cargar última curación
  async function cargarUltimaCuracion(runVal){
    try {
      const r = await authFetch(`/api/curaciones-piedm/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[🩹 Curaciones] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de curaciones
        const curacion = data.data;
        console.log('[🩹 Curaciones] Última curación cargada:', curacion);
        
        // Actualizar formulario si existe
        const tipoSelect = document.getElementById('tipoCuracion');
        const fechaInput = document.getElementById('fechaCuracion');
        
        if (tipoSelect && curacion.tipo_curacion) {
          tipoSelect.value = curacion.tipo_curacion;
        }
        if (fechaInput && curacion.fecha) {
          fechaInput.value = curacion.fecha;
        }
      } else {
        console.log('[🩹 Curaciones] No hay datos de curaciones para este usuario');
      }
    } catch(e) {
      console.log('[🩹 Curaciones] Función ejecutada (sin datos disponibles)');
    }
  }

  // Cargar última hipoglicemia
  async function cargarUltimaHipoglicemia(runVal){
    try {
      const r = await authFetch(`/api/diabetes/hipoglicemias/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[🩸 Hipoglicemias] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de hipoglicemias
        const hipoglicemia = data.data;
        console.log('[🩸 Hipoglicemias] Última hipoglicemia cargada:', hipoglicemia);
        
        // Actualizar formulario si existe
        const siRadio = document.getElementById('hipoglicemiasSi');
        const noRadio = document.getElementById('hipoglicemiasNo');
        const fechaInput = document.getElementById('fechaHipoglicemias');
        
        if (hipoglicemia.recurrente === true && siRadio) {
          siRadio.checked = true;
        } else if (hipoglicemia.recurrente === false && noRadio) {
          noRadio.checked = true;
        }
        
        if (fechaInput && hipoglicemia.fecha) {
          fechaInput.value = hipoglicemia.fecha;
        }
      } else {
        console.log('[🩸 Hipoglicemias] No hay datos de hipoglicemias para este usuario');
      }
    } catch(e) {
      console.log('[🩸 Hipoglicemias] Función ejecutada (sin datos disponibles)');
    }
  }

  // Cargar última amputación
  async function cargarUltimaAmputacion(runVal){
    try {
      const r = await authFetch(`/api/examenes/pie_dm/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[🦿 Amputación] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de amputación
        const amputacion = data.data;
        console.log('[🦿 Amputación] Última amputación cargada:', amputacion);
        
        // Actualizar formulario si existe
        const fechaInput = document.getElementById('fechaAmputacion');
        
        if (fechaInput && amputacion.fecha_amputacion) {
          fechaInput.value = amputacion.fecha_amputacion;
        }
      } else {
        console.log('[🦿 Amputación] No hay datos de amputación para este usuario');
      }
    } catch(e) {
      console.log('[🦿 Amputación] Función ejecutada (sin datos disponibles)');
    }
  }

  // Cargar sectores
  async function cargarSectores(){
    try{
      const r = await authFetch('/api/sectores');
      if(!r.ok) return; const d = await r.json(); if(!d.ok) return;
      const sel = document.getElementById('sector_id');
      if(!sel) return; const cur = sel.value;
      sel.innerHTML = '<option value="">-- Sector --</option>' + d.sectores.map(s=>`<option value="${s.id}">${s.nombre}</option>`).join('');
      if(cur) sel.value = cur; // mantener si ya había
    }catch(e){ console.warn('No se pudieron cargar sectores', e); }
  }
  cargarSectores();

  // Formulario nuevo control
  const formControl = document.getElementById('form-control-nuevo');
  if(formControl){
    const tallaInput = formControl.querySelector('#input-talla');
    const pesoInput = formControl.querySelector('[name="peso"]');
    function normalizarTalla(){
      if(!tallaInput) return; const raw=tallaInput.value.trim(); if(!raw) return; let num=parseFloat(raw.replace(',','.'));
      if(isNaN(num)) return; if(num>0 && num<3){ num = num*100; tallaInput.value = num.toFixed(2); }
  window.computeIMC && window.computeIMC();
    }
    if(tallaInput){ tallaInput.addEventListener('blur', normalizarTalla); tallaInput.addEventListener('change', normalizarTalla); }
    if(pesoInput){ pesoInput.addEventListener('blur', computeIMC); pesoInput.addEventListener('change', computeIMC); }
    formControl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const estado = document.getElementById('estado-control');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal){ estado.textContent='RUN requerido'; estado.style.color='#b91c1c'; return; }
      estado.textContent='Guardando...'; estado.style.color='#334155';
      const fd = new FormData(formControl);
      const payload = { run: runVal };
      ['fecha','profesional','peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{
        const v = fd.get(k);
        if(v!==null && v!=='' ) payload[k]=v;
      });
      try{
        const r = await authFetch('/api/control',{method:'POST',body:JSON.stringify(payload)});
        const d = await r.json();
        if(!r.ok || !d.ok){ estado.textContent='Error'; estado.style.color='#b91c1c'; return; }
        estado.textContent='Guardado ✔'; estado.style.color='#065f46';
        // limpiar campos excepto fecha/profesional
        ['peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{ formControl.querySelector(`[name="${k}"]`).value=''; });
        cargarUltimoControl(runVal);
      }catch(err){ estado.textContent='Error red'; estado.style.color='#b91c1c'; }
    });
  }

  // Formulario nuevo acuerdo
  const formAcuerdo = document.getElementById('form-acuerdo-nuevo');
  if(formAcuerdo){
    // Establecer fecha actual por defecto
    const fechaInput = document.getElementById('acuerdo_fecha');
    if(fechaInput && !fechaInput.value){
      const hoy = new Date();
      fechaInput.value = hoy.toISOString().split('T')[0];
    }
    
    formAcuerdo.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const estado = document.getElementById('estado-acuerdo');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal){ 
        estado.textContent='RUN requerido'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      
      const fd = new FormData(formAcuerdo);
  const acuerdos = fd.get('acuerdos')?.trim();
  const cumplimiento = fd.get('cumplimiento')?.trim();
      
      if(!acuerdos){ 
        estado.textContent='Acuerdos requeridos'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      if(!cumplimiento){ 
        estado.textContent='Cumplimiento requerido'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      
      estado.textContent='Guardando...'; 
      estado.style.color='#334155';
      
      const payload = {
        usuario_id: runVal,
        acuerdos: acuerdos,
        cumplimiento: cumplimiento,
        observaciones: fd.get('observaciones')?.trim() || null,
        funcionario: fd.get('funcionario')?.trim() || null,
        fecha_creacion: fd.get('fecha') || null
      };
      
      try{
        const r = await fetch('/api/acuerdos',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const d = await r.json();
        if(!r.ok || !d.ok){ 
          estado.textContent='Error: ' + (d.error || 'Desconocido'); 
          estado.style.color='#b91c1c'; 
          return; 
        }
        estado.textContent='Guardado ✔'; 
        estado.style.color='#065f46';
        
        // Limpiar formulario excepto fecha y profesional
        ['acuerdos','observaciones'].forEach(k=>{ 
          const el = formAcuerdo.querySelector(`[name="${k}"]`); 
          if(el) el.value=''; 
        });
        formAcuerdo.querySelector('[name="cumplimiento"]').value = '';
        
        // Recargar histórico de acuerdos
        cargarHistoricoAcuerdos(runVal);
        
        setTimeout(()=>{
          estado.textContent = '';
        }, 3000);
        
      }catch(err){ 
        console.error('Error guardando acuerdo:', err);
        estado.textContent='Error de red'; 
        estado.style.color='#b91c1c'; 
      }
    });
  }

  // ================= LABS =================
  async function cargarLabs(runVal){
    if(!runVal) return;
    const limpio = runVal.replace(/[^0-9kK]/g,'');
    if(limpio.length < 7) return;
    const cont = document.getElementById('panel-examenes');
    const tabla = document.getElementById('tabla-labs');
    const tbody = tabla.querySelector('tbody');
    if(cont){ cont.querySelector('div[style*="opacity"]')?.remove(); }
    try{
      const r = await authFetch(`/api/examenes/labs/${encodeURIComponent(runVal)}`);
      const j = await r.json();
      if(!r.ok || !j.ok){
        tbody.innerHTML = `<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error obteniendo labs (${j.error||r.status})</td></tr>`;
        tabla.style.display='table';
        return;
      }
      const labs = j.labs || {};
      const orden = [
        ['glicemia','Glicemia'],
        ['hba1c','HbA1c'],
        ['ldl','LDL'],
        ['hdl','HDL'],
        ['col','Col Total'],
        ['tag','Triglicéridos'],
        ['creatinemia','Creatinina'],
        ['vfg','VFG'],
        ['rac','RAC'],
        ['microalbuminuria','Microalbuminuria'],
        ['tsh','TSH'],
        ['rpr','RPR'],
        ['baciloscopia','Baciloscopia'],
        ['tos','Tos']
      ];
      const rows = [];
      orden.forEach(([k,label])=>{
        if(!labs[k]) return; // sólo mostrar presentes
        const reg = labs[k] || {};
        let valorTxt = '';
        if(k==='microalbuminuria'){
          // Puede venir valor, valor_cuant, positiva
            if(reg.valor_cuant!=null) valorTxt = reg.valor_cuant;
            else if(reg.valor!=null) valorTxt = reg.valor;
            if(reg.positiva===true) valorTxt = (valorTxt? valorTxt+' / ' : '') + 'Positiva';
            else if(reg.positiva===false) valorTxt = (valorTxt? valorTxt+' / ' : '') + 'Negativa';
        } else if(reg.valor!=null){
          valorTxt = reg.valor;
        }
        const anot = [];
        if(reg.alerta) anot.push(reg.alerta);
        if(k==='vfg' && reg.erc_estadio) anot.push(reg.erc_estadio);
        const fecha = reg.fecha || '';
        rows.push(`<tr><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${label}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${valorTxt||'—'}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${fecha||'—'}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${anot.join(' • ')}</td></tr>`);
      });
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos de laboratorio</td></tr>';
      } else {
        tbody.innerHTML = rows.join('');
      }
      tabla.style.display='table';
      // Cargar histórico en paralelo (no bloquear)
      cargarHistoricoLabs(runVal);
    }catch(e){
      console.error('[📊 Labs] Error', e);
      tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error de red labs</td></tr>';
      tabla.style.display='table';
    }
  }

  async function cargarHistoricoLabs(runVal){
    try{
      console.log('[HIST-LABS] Iniciando carga para RUN:', runVal);
      const r = await authFetch(`/api/examenes/labs/historico/${encodeURIComponent(runVal)}?limit=60`);
      console.log('[HIST-LABS] Response status:', r.status, r.ok);
      const j = await r.json();
      console.log('[HIST-LABS] Response data:', j);
      if(!r.ok || !j.ok){ 
        console.warn('[HIST-LABS] Response not OK:', r.ok, j.ok);
        return; 
      }
      const rawData = j.historico || j.registros || j.data || [];
      console.log('[HIST-LABS] Raw data length:', rawData.length);
      _histLabsRaw = rawData.map(x=>{
        const fechaPrincipal = x.examen_fecha || x.fecha_realizacion || x.fecha || x.created_at || null;
        const fechaSec = x.fecha_realizacion || x.fecha || null;

        const microValor = x.microalbuminuria_val ?? x.microalbuminuria_valor ?? x.microalbuminuria_cuant ?? null;
        const microTexto = x.microalbuminuria_descripcion ?? x.microalbuminuria ?? x.microalbuminuria_resultado ?? '';
        let microPos = x.microalbuminuria_positiva;
        if(typeof microPos === 'string'){
          microPos = /^(1|true|positiva|pos)/i.test(microPos);
        }
        if(typeof microPos !== 'boolean'){
          if(typeof microTexto === 'string'){
            const txt = microTexto.toLowerCase();
            if(/pos/.test(txt)) microPos = true;
            else if(/neg/.test(txt)) microPos = false;
          }
        }

        return {
          examen_fecha: fechaPrincipal,
          fecha_realizacion: fechaSec,
          fecha: fechaPrincipal,
          glicemia: x.glicemia ?? x.valor_glicemia ?? null,
          hba1c: x.hba1c ?? x.valor_hba1c ?? null,
          ldl: x.ldl ?? x.valor_ldl ?? null,
          hdl: x.hdl ?? x.valor_hdl ?? null,
          col: x.col ?? x.colesterol_total ?? null,
          tag: x.tag ?? x.trigliceridos ?? null,
          creatinemia: x.creatinemia ?? x.creatinina ?? null,
          vfg: x.vfg ?? x.valor_vfg ?? null,
          erc: x.erc_estadio ?? x.erc ?? null,
          rac: x.rac ?? x.albuminuria_creatinina ?? null,
          microalbuminuria: microTexto,
          microalbuminuria_val: microValor,
          microalbuminuria_positiva: typeof microPos === 'boolean' ? microPos : null,
          tsh: x.tsh ?? x.valor_tsh ?? null
        };
      }).filter(filaLabTieneDatos);
      console.log('[HIST-LABS] Processed data length:', _histLabsRaw.length);
      renderHistoricoLabs('all');
      console.log('[HIST-LABS] Render completed');
    }catch(e){ 
      console.error('[HIST-LABS] Error:', e); 
      const tbody = document.getElementById('hist-labs-tbody');
      if(tbody) {
        tbody.innerHTML='<tr><td colspan="14" style="padding:6px;color:#b91c1c;">Error cargando histórico: ' + e.message + '</td></tr>';
      }
    }
  }

  function renderHistoricoLabs(scope){
    const meses = scope === '12m' ? 12 : scope === '6m' ? 6 : null;
    aplicarFiltrosYRenderLabs(meses);
  }

  // Listeners filtros historico labs (solo una vez)
  document.querySelectorAll('[data-filtro-labs]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-filtro-labs');
      renderHistoricoLabs(key);
    }, { once:false });
  });

  // ================= HISTÓRICOS =================
  // Toggles genéricos
  document.querySelectorAll('[data-toggle]').forEach(tg=>{
    tg.addEventListener('click', ()=>{
      const key = tg.getAttribute('data-toggle');
      const body = document.querySelector(`[data-body="${key}"]`);
      const icon = document.querySelector(`[data-icon="${key}"]`);
      if(!body) return;
      const visible = body.style.display!=='none';
      body.style.display = visible? 'none':'block';
      if(icon) icon.textContent = visible? '▼':'▲';
    });
  });

  // Arrays originales para filtros y tendencias
  let _histControlRaw = [];
  let _histLabsRaw = [];
  
  // Función global de debug para verificar datos desde consola
  window.debugHistoricos = function() {
    console.log('=== DEBUG HISTÓRICOS ===');
    console.log('_histControlRaw:', _histControlRaw?.length || 'undefined', _histControlRaw);
    console.log('_histLabsRaw:', _histLabsRaw?.length || 'undefined', _histLabsRaw);
    
    const tbody = document.getElementById('hist-control-tbody');
    if (tbody) {
      console.log('hist-control-tbody existe, contenido:', tbody.innerHTML.substring(0, 300));
    } else {
      console.log('hist-control-tbody NO encontrado');
    }
    
    const tbodyLabs = document.getElementById('hist-labs-tbody');
    if (tbodyLabs) {
      console.log('hist-labs-tbody existe, contenido:', tbodyLabs.innerHTML.substring(0, 300));
    } else {
      console.log('hist-labs-tbody NO encontrado');
    }
  };

  // Función de test para forzar carga de históricos
  window.testCargarHistoricos = function() {
    console.log('=== TEST FORZAR CARGA HISTÓRICOS ===');
    const runField = document.getElementById('run');
    const runVal = runField?.value?.trim();
    console.log('RUN detectado:', runVal);
    
    if (runVal) {
      console.log('Ejecutando cargarHistoricoControl...');
      cargarHistoricoControl(runVal);
      
      console.log('Ejecutando cargarHistoricoLabs...');
      cargarHistoricoLabs(runVal);
      
      console.log('Ejecutando cargarHistoricoAcuerdos...');
      cargarHistoricoAcuerdos(runVal);
    } else {
      console.log('No hay RUN disponible');
    }
  };
  
  // Función para verificar el estado general del sistema
  window.estadoSistema = function() {
    console.log('=== ESTADO DEL SISTEMA ===');
    const runField = document.getElementById('run');
    const runVal = runField?.value?.trim();
    console.log('Campo RUN:', runField ? 'EXISTE' : 'NO EXISTE');
    console.log('Valor RUN:', runVal || 'VACÍO');
    
    console.log('Funciones disponibles:');
    console.log('- cargarHistoricoControl:', typeof cargarHistoricoControl);
    console.log('- cargarHistoricoLabs:', typeof cargarHistoricoLabs);
    console.log('- cargarHistoricoAcuerdos:', typeof cargarHistoricoAcuerdos);
    console.log('- recargaTodo:', typeof window.recargaTodo);
    
    console.log('Elementos DOM:');
    console.log('- hist-control-tbody:', document.getElementById('hist-control-tbody') ? 'EXISTE' : 'NO EXISTE');
    console.log('- hist-labs-tbody:', document.getElementById('hist-labs-tbody') ? 'EXISTE' : 'NO EXISTE');
  };

  async function cargarHistoricoControl(runVal){
    const tbody = document.getElementById('hist-control-tbody');
    if(!tbody) {
      console.error('[HIST-CONTROL] No se encontró tbody con id hist-control-tbody');
      return;
    }
    if(!runVal){ tbody.innerHTML='<tr><td colspan="10" style="padding:6px;opacity:.6;">—</td></tr>'; return; }
    try{
      console.log('[HIST-CONTROL] Cargando histórico control para RUN:', runVal);
      const r = await authFetch(`/api/control/historico/${encodeURIComponent(runVal)}?limit=12`);
      console.log('Response status histórico control:', r.status, r.ok);
      console.log('Response headers:', [...r.headers.entries()]);
      const responseText = await r.text();
      console.log('Response text raw:', responseText);
      let d;
      try {
        d = JSON.parse(responseText);
        console.log('JSON parseado correctamente:', d);
      } catch (parseError) {
        console.error('Error parsing JSON:', parseError);
        console.log('Contenido no es JSON válido:', responseText.substring(0, 200));
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error: respuesta no es JSON válido</td></tr>';
        return;
      }
      
      // Manejo más flexible de la respuesta
      let ok = false;
      let controles = [];
      
      if (d.ok !== undefined) {
        ok = d.ok;
        controles = d.controles || d.data || [];
      } else if (d.success !== undefined) {
        ok = d.success;
        controles = d.controles || d.data || [];
      } else if (Array.isArray(d.controles)) {
        ok = true;
        controles = d.controles;
      } else if (Array.isArray(d.data)) {
        ok = true;
        controles = d.data;
      } else if (Array.isArray(d)) {
        // Si la respuesta es directamente un array
        ok = true;
        controles = d;
      }
      
      console.log('Procesado - ok:', ok, 'controles:', controles.length);
      
      if (!ok) {
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error: respuesta inválida del servidor</td></tr>';
        return;
      }
      
      _histControlRaw = controles;
      console.log('[HIST-CONTROL] _histControlRaw asignado, longitud:', _histControlRaw.length);
      console.log('[HIST-CONTROL] Primer elemento:', _histControlRaw[0]);
      
      if(!_histControlRaw.length){ 
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; 
        console.log('[HIST-CONTROL] No hay datos de control para mostrar');
        return; 
      }
      
      console.log('[HIST-CONTROL] Llamando aplicarFiltrosYRenderControl con', _histControlRaw.length, 'registros');
      
      // Test immediato para verificar que los datos están disponibles
      setTimeout(() => {
        console.log('[HIST-CONTROL-TEST] Verificando datos después de 100ms');
        console.log('[HIST-CONTROL-TEST] _histControlRaw length:', _histControlRaw?.length);
        const tbody = document.getElementById('hist-control-tbody');
        if (tbody) {
          console.log('[HIST-CONTROL-TEST] tbody innerHTML length:', tbody.innerHTML.length);
          console.log('[HIST-CONTROL-TEST] tbody innerHTML preview:', tbody.innerHTML.substring(0, 200));
        }
      }, 100);
      
      aplicarFiltrosYRenderControl();
    }catch(e){ 
      console.error('Error cargando histórico control:', e);
      tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error red: ' + e.message + '</td></tr>'; 
    }
  }



  async function cargarHistoricoAcuerdos(runVal){
    const tbody = document.getElementById('hist-acuerdos-tbody');
    const ult = document.getElementById('acuerdo-ultimo');
    if(!tbody) return;
    if(!runVal){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;opacity:.6;">—</td></tr>'; ult.textContent='Sin datos'; return; }
    try{
      const r = await authFetch(`/api/acuerdos/historico/${encodeURIComponent(runVal)}?limit=8`);
      const d = await r.json();
      const ok = (typeof d.ok !== 'undefined') ? d.ok : (typeof d.success !== 'undefined' ? d.success : Array.isArray(d.acuerdos));
      if(!ok){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error</td></tr>'; ult.textContent='Error'; return; }
      const rows = d.acuerdos || d.data || [];
      if(!rows.length){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; ult.textContent='Sin datos'; return; }
      const primero = rows[0];
      const cumplimientoPrimero = formatearCumplimiento(primero.cumplimiento);
      const resumenCumplimiento = cumplimientoPrimero === '—' ? '' : ` (${cumplimientoPrimero})`;
      ult.textContent = `${primero.fecha_creacion || ''}: ${primero.acuerdos || ''}${resumenCumplimiento}`;
      tbody.innerHTML = rows.map(a=>{
        const cumplimientoFmt = formatearCumplimiento(a.cumplimiento);
        return `<tr style=\"border-top:1px solid #e2e8f0;\">\n          <td style=\"padding:4px;\">${a.fecha_creacion||''}</td>\n          <td style=\"padding:4px;\">${(a.acuerdos||'').toString().slice(0,60)}</td>\n          <td style=\"padding:4px;\">${cumplimientoFmt}</td>\n          <td style=\"padding:4px;\">${(a.observaciones||'').toString().slice(0,40)}</td>\n        </tr>`;
      }).join('');
    }catch(e){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error red</td></tr>'; ult.textContent='Error'; }
  }

  function mostrarEstado(msg, tipo='info'){
    let box = document.getElementById('estado-guardar');
    if(!box){
      box = document.createElement('div');
      box.id='estado-guardar';
      box.style.fontSize='.75rem';
      box.style.marginTop='4px';
      document.getElementById('form-tarjeton').appendChild(box);
    }
    const colores = {info:'#334155',ok:'#065f46',error:'#b91c1c'};
    box.style.color = colores[tipo]||colores.info;
    box.textContent = msg;
  }

  async function guardar(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const categoriaRaw = (fd.get('categoria') || '').toString().trim().toUpperCase();
    const categoriaNormalizada = categoriaRaw && categoriaRaw !== '—' && categoriaRaw !== '-' ? categoriaRaw : null;
    const payload = {
      run: fd.get('run')?.trim(),
      nombre: fd.get('nombre')?.trim() || null,
      fecha_nacimiento: fd.get('fecha_nacimiento') || null,
      sexo: fd.get('sexo')||null,
      direccion: fd.get('direccion')||null,
      telefono: fd.get('telefono')||null,
      sector_id: fd.get('sector_id') || null,
      categoria: categoriaNormalizada
    };
    if(!payload.run){ mostrarEstado('RUN requerido','error'); return; }
    mostrarEstado('Guardando...');
    try{
      const r = await authFetch('/api/tarjeton',{method:'POST',body:JSON.stringify(payload)});
      const data = await r.json().catch(()=>({ok:false,error:'RESPUESTA_INVALIDA'}));
      if(!r.ok || !data.ok){
        mostrarEstado('Error guardando: '+(data.error||r.status),'error');
        return;
      }
      mostrarEstado('Guardado ✔','ok');
      poblar(data); // refrescar
    }catch(err){
      console.error(err);
      mostrarEstado('Error de red','error');
    }
  }
  document.getElementById('form-tarjeton').addEventListener('submit', guardar);

  // Event listeners para evaluación adulto mayor
  const tugSegundos = document.getElementById('tugSegundos');
  const unipodalDerecho = document.getElementById('unipodalPieDerecho');
  const unipodalIzquierdo = document.getElementById('unipodalPieIzquierdo');
  
  if (tugSegundos) {
    tugSegundos.addEventListener('input', calcularClasificacionTUG);
  }
  
  if (unipodalDerecho || unipodalIzquierdo) {
    unipodalDerecho?.addEventListener('input', calcularClasificacionUnipodal);
    unipodalIzquierdo?.addEventListener('input', calcularClasificacionUnipodal);
  }

  // Delegación para filtros
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-filtro-control]');
    if(b){
      const v = b.getAttribute('data-filtro-control');
      aplicarFiltrosYRenderControl(v==='6m'?6: v==='12m'?12: null);
    }
    const b2 = e.target.closest('[data-filtro-labs]');
    if(b2){
      const v = b2.getAttribute('data-filtro-labs');
      aplicarFiltrosYRenderLabs(v==='6m'?6: v==='12m'?12: null);
    }
    const exp = e.target.closest('[data-export]');
    if(exp){
      const tipo = exp.getAttribute('data-export');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal) return;
      window.location = `/api/export/historico/${encodeURIComponent(runVal)}?tipo=${tipo}&formato=xlsx`;
    }
  });

  function claseRiesgo(nombre){
    if(!nombre) return 'badge-neutro';
    const n = nombre.toString().toLowerCase();
    // Mapeo explícito G1/G2/G3 solicitado: G1 verde, G2 amarillo, G3 rojo
    if(/^g1\b/.test(n)) return 'badge-g1';
    if(/^g2\b/.test(n)) return 'badge-g2';
    if(/^g3\b/.test(n)) return 'badge-g3';
    if(/alto/.test(n)) return 'badge-alto';
    if(/moderado|medio/.test(n)) return 'badge-medio';
    if(/bajo|leve/.test(n)) return 'badge-bajo';
    return 'badge-neutro';
  }
  
  // Actualizar badge de riesgo - SIN bypass CARDIO
  function actualizarBadgeRiesgo(texto){
    let badge = document.getElementById('badge-riesgo');
    if(!badge){
      const contResumen = document.querySelector('#resumen-ident');
      badge = document.createElement('div');
      badge.id='badge-riesgo';
      badge.style.marginTop='6px';
      contResumen.appendChild(badge);
    }
    // Siempre aplica color según categoría calculada
    badge.className = 'badge-riesgo '+claseRiesgo(texto);
    badge.textContent = texto || '—';
    
    const inputCat = document.getElementById('categoria');
    if(inputCat) inputCat.value = texto || '—';
  }

  // Estilos básicos badges inyectados si no existen
  if(!document.getElementById('css-badges-riesgo')){
    const style = document.createElement('style');
    style.id='css-badges-riesgo';
    style.textContent = `
      .badge-riesgo{display:inline-block;padding:4px 8px;font-size:.65rem;font-weight:600;letter-spacing:.5px;border-radius:14px;background:#e2e8f0;color:#334155;text-transform:uppercase;}
      .badge-riesgo.badge-alto{background:#b91c1c;color:#fff;}
      .badge-riesgo.badge-medio{background:#d97706;color:#fff;}
      .badge-riesgo.badge-bajo{background:#15803d;color:#fff;}
      .badge-riesgo.badge-neutro{background:#64748b;color:#fff;}
      /* Nuevos estilos para categorías renales G1/G2/G3 */
      .badge-riesgo.badge-g1{background:#16a34a;color:#fff;}
      .badge-riesgo.badge-g2{background:#facc15;color:#422006;}
      .badge-riesgo.badge-g3{background:#dc2626;color:#fff;}
      .badge-riesgo.badge-g3{background:#b91c1c;color:#fff;}
    `;
    document.head.appendChild(style);
  }

  // Hacer función disponible globalmente
  window.actualizarBadgeRiesgo = actualizarBadgeRiesgo;

  // Estilos alertas históricos
  if(!document.getElementById('css-alertas-hist')){
    const st = document.createElement('style');
    st.id='css-alertas-hist';
    st.textContent = `
      .row-danger{background:rgba(185,28,28,0.18)!important;}
      .row-warning{background:rgba(217,119,6,0.18)!important;}
      .row-good{background:rgba(22,163,74,0.18)!important;}
      .delta-up{color:#b91c1c;font-weight:600;}
      .delta-down{color:#15803d;font-weight:600;}
      .delta-flat{color:#475569;opacity:.6;}
    `;
    document.head.appendChild(st);
  }
  // (fin estilos históricos)
  
  // Funciones auxiliares para históricos
  function obtenerColoresHTA(valorRaw){
    const valor = (valorRaw || '').trim().toLowerCase();
    if(/normotens[oa]/.test(valor)){
      return { bg:'rgba(34, 197, 94, 0.25)', color:'#0f172a' };
    }
    if(/hta\s*etapa\s*1/.test(valor) || /hta\s*etapa\s*i\b/.test(valor)){
      return { bg:'rgba(250, 204, 21, 0.35)', color:'#1f2937' };
    }
    if(/hta\s*etapa\s*2/.test(valor) || /hta\s*etapa\s*ii\b/.test(valor)){
      return { bg:'rgba(249, 115, 22, 0.35)', color:'#fff' };
    }
    if(/hta\s*etapa\s*3/.test(valor) || /hta\s*etapa\s*iii\b/.test(valor)){
      return { bg:'rgba(239, 68, 68, 0.35)', color:'#fff' };
    }
    return { bg:'', color:'' };
  }

  function obtenerColoresIMC(valorRaw){
    const valor = (valorRaw || '').trim().toLowerCase();
    if(/bajo\s*peso/.test(valor)){
      return { bg:'rgba(168, 85, 247, 0.28)', color:'#4c1d95' };
    }
    if(/\bnormal\b/.test(valor)){
      return { bg:'rgba(34, 197, 94, 0.25)', color:'#065f46' };
    }
    if(/sobrepeso/.test(valor)){
      return { bg:'rgba(250, 204, 21, 0.3)', color:'#92400e' };
    }
    if(/obesidad/.test(valor)){
      return { bg:'rgba(239, 68, 68, 0.32)', color:'#7f1d1d' };
    }
    return { bg:'', color:'' };
  }

  function colorearControles(){
    // Colorear filas según clasificaciones de riesgo
    document.querySelectorAll('#hist-control-tbody tr.ctl-row').forEach(tr=>{
      tr.style.backgroundColor = '';
  const htaCell = tr.querySelector('[data-hta]');
  const paCell = tr.querySelector('[data-psis]');
  const imcCell = tr.querySelector('[data-imc]');
  const imcClasCell = imcCell?.nextElementSibling || null;
      if(!htaCell){
        if(paCell){
          paCell.style.backgroundColor='';
          paCell.style.color='';
          paCell.style.borderRadius='';
          paCell.style.fontWeight='';
        }
        return;
      }

      const htaAttr = htaCell.getAttribute('data-hta') || '';
      const { bg: htaBg, color: htaColor } = obtenerColoresHTA(htaAttr);

      htaCell.style.backgroundColor = htaBg;
      htaCell.style.color = htaColor || '';
      htaCell.style.borderRadius = htaBg ? '4px' : '';
      htaCell.style.fontWeight = htaBg ? '600' : '';

      if(paCell){
        paCell.style.backgroundColor = htaBg;
        paCell.style.color = htaColor || '';
        paCell.style.borderRadius = htaBg ? '4px' : '';
        paCell.style.fontWeight = htaBg ? '600' : '';
      }

      if(imcCell){
        const clasText = imcClasCell?.textContent || '';
        const { bg: imcBg, color: imcColor } = obtenerColoresIMC(clasText);

        [imcCell, imcClasCell].forEach(cell => {
          if(!cell) return;
          cell.style.backgroundColor = imcBg;
          cell.style.color = imcColor || '';
          cell.style.borderRadius = imcBg ? '4px' : '';
          cell.style.fontWeight = imcBg ? '600' : '';
        });
      }
    });
  }
  
  // === Helpers puros para cálculo de tendencias ===
  function num(v){ if (v == null) return null; const n = parseFloat(v); return Number.isNaN(n) ? null : n; }
  function delta(a,b){ const na=num(a), nb=num(b); return (na==null || nb==null) ? null : (na - nb); }

  // Tabla de métricas (misma semántica)
  const _METRICAS = [
    { key:'presion_sistolica',  thr:5,   tip:false, lab:'PS' },
    { key:'presion_diastolica', thr:5,   tip:false, lab:'PD' },
    { key:'imc',                thr:0.5, tip:true  },
    { key:'hba1c',              thr:0.3, tip:true  },
    { key:'peso',               thr:1,   tip:true  },
    { key:'cc',                 thr:1,   tip:true  },
  ];

  // Puro: genera el array de spans para una fila
  function buildPartes(actual, prev){
    const partes = [];
    for (const m of _METRICAS){
      const d = delta(actual[m.key], prev[m.key]);
      if (d === null) continue;
      if (Math.abs(d) >= m.thr) partes.push(arrowHTML(d, m.thr, !!m.tip, m.lab));
    }
    return partes;
  }

  // MISMA FIRMA
  function calcularTendenciasControles(rows){
    const trs = document.querySelectorAll('#hist-control-tbody tr.ctl-row');
    const last = rows.length - 1;

    for (let i = 0; i < rows.length; i++){
      if (i === last) break; // último no tiene anterior
      const tr = trs[i];
      if (!tr) continue;

      const deltaCell = tr.querySelector('[data-delta]');
      if (!deltaCell) continue;

      const partes = buildPartes(rows[i], rows[i+1]);
      deltaCell.innerHTML = partes.join(' ');
    }
  }
  
  function arrowHTML(delta, umbral, conTooltip, label) {
    if(Math.abs(delta) < umbral) return `<span class="delta-flat">—</span>`;
    const dir = delta > 0 ? 'up' : 'down';
    const color = delta > 0 ? '#dc2626' : '#16a34a';
    const arrow = delta > 0 ? '↗' : '↘';
    const tooltip = conTooltip ? ` title="Δ ${delta > 0 ? '+' : ''}${delta.toFixed(1)}"` : '';
    const labelTxt = label ? `<sub>${label}</sub>` : '';
    return `<span class="delta-${dir}" style="color:${color};"${tooltip}>${arrow}${labelTxt}</span>`;
  }
  
  function formatearFechaCorta(valor){
    if(!valor) return '—';

    const pad = (n)=>String(n).padStart(2,'0');
    const render = (dateObj)=>`${pad(dateObj.getDate())}/${pad(dateObj.getMonth()+1)}/${dateObj.getFullYear()}`;

    if(valor instanceof Date && !Number.isNaN(valor.getTime())){
      return render(valor);
    }

    const txt = valor.toString().trim();
    if(!txt) return '—';

    const parsed = Date.parse(txt);
    if(!Number.isNaN(parsed)){
      return render(new Date(parsed));
    }

    const isoMatch = txt.match(/(\d{4})-(\d{2})-(\d{2})/);
    if(isoMatch){
      const [,y,m,d] = isoMatch;
      return `${d}/${m}/${y}`;
    }

    const slashMatch = txt.match(/(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/);
    if(slashMatch){
      const [,d,m,y] = slashMatch.map((v,i)=> i===0||i===1 ? pad(Number(v)) : v);
      return `${d}/${m}/${y}`;
    }

    const rfcMatch = txt.match(/^(?:[a-zA-ZñÑáéíóúü]{3,}),?\s*(\d{1,2})\s+([a-zA-ZñÑáéíóúü]{3,})\s+(\d{4})/);
    if(rfcMatch){
      const [,dia,mesTxt,anio] = rfcMatch;
      const meses = {
        ene:'01', feb:'02', mar:'03', abr:'04', may:'05', jun:'06', jul:'07', ago:'08', sep:'09', set:'09', oct:'10', nov:'11', dic:'12',
        jan:'01', febr:'02', apr:'04', jun:'06', jul:'07', aug:'08', dec:'12',
        janv:'01', fev:'02', marz:'03', sept:'09'
      };
      const clave = mesTxt.toLowerCase().slice(0,3);
      const mesNum = meses[clave] || meses[mesTxt.toLowerCase()] || '01';
      return `${pad(Number(dia))}/${mesNum}/${anio}`;
    }

    return txt;
  }

  function normalizarSexo(valor){
    const txt = (valor || '').toString().trim().toLowerCase();
    if(!txt || txt === '—' || txt === '-') return '';
    if(txt.startsWith('f')) return 'f';
    if(txt.startsWith('m')) return 'm';
    return txt;
  }

  function obtenerSexoUsuario(){
    let sexo = normalizarSexo(window.__usuarioSexo);
    if(sexo) return sexo;

    const sexoSpan = document.querySelector('[data-f="sexo"]');
    if(sexoSpan){
      sexo = normalizarSexo(sexoSpan.textContent);
      if(sexo){
        window.__usuarioSexo = sexo;
        return sexo;
      }
    }

    const sexoInput = document.getElementById('sexo');
    if(sexoInput){
      sexo = normalizarSexo(sexoInput.value || sexoInput.textContent);
      if(sexo){
        window.__usuarioSexo = sexo;
        return sexo;
      }
    }

    return '';
  }

  function usuarioTieneDiabetes(){
    if(typeof window.__usuarioTieneDiabetes === 'boolean'){
      return window.__usuarioTieneDiabetes;
    }
    const patologias = window.__usuarioPatologiasResumen;
    if(Array.isArray(patologias)){
      const tiene = patologias.some(p => {
        const nombre = (p.nombre || '').toLowerCase();
        const cie10 = (p.cie10 || p.codigo || '').toLowerCase();
        return nombre.includes('diabet') || /^e1[0-4]/.test(cie10);
      });
      window.__usuarioTieneDiabetes = tiene;
      return tiene;
    }
    return false;
  }

  function valorNumerico(raw){
    if(raw === null || raw === undefined) return null;
    const txt = raw.toString().replace(',', '.').trim();
    if(!txt) return null;
    const val = Number(txt);
    return Number.isFinite(val) ? val : null;
  }

  function filaLabTieneDatos(row){
    if(!row || typeof row !== 'object') return false;
    const campos = ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','erc','rac','microalbuminuria','microalbuminuria_val','tsh'];
    for(const campo of campos){
      if(!(campo in row)) continue;
      const val = row[campo];
      if(val === null || val === undefined) continue;
      if(typeof val === 'boolean') return true;
      if(typeof val === 'number' && !Number.isNaN(val)) return true;
      if(typeof val === 'string'){
        const txt = val.trim();
        if(!txt) continue;
        const lower = txt.toLowerCase();
        if(lower === '-' || lower === '—' || lower === 'no') continue;
        return true;
      }
      return true;
    }
    if(typeof row.microalbuminuria_positiva === 'boolean') return true;
    return false;
  }

  if(!document.getElementById('css-colores-labs')){
    const st = document.createElement('style');
    st.id = 'css-colores-labs';
    st.textContent = `
      #hist-labs-tbody td.lab-estado-danger{background:#f87171 !important;color:#450a0a !important;font-weight:600;box-shadow:0 0 0 1px rgba(248,113,113,0.7) inset,0 0 6px rgba(248,113,113,0.4);} 
      #hist-labs-tbody td.lab-estado-warning{background:#fbbf24 !important;color:#422006 !important;font-weight:600;box-shadow:0 0 0 1px rgba(251,191,36,0.65) inset,0 0 6px rgba(251,191,36,0.35);} 
      #hist-labs-tbody td.lab-estado-success{background:#34d399 !important;color:#064e3b !important;font-weight:600;box-shadow:0 0 0 1px rgba(52,211,153,0.55) inset,0 0 6px rgba(34,197,94,0.3);} 
      #hist-labs-tbody td.lab-estado-info{background:#60a5fa !important;color:#1e3a8a !important;font-weight:600;box-shadow:0 0 0 1px rgba(96,165,250,0.55) inset,0 0 6px rgba(96,165,250,0.28);} 
      #hist-labs-tbody tr.lab-row-danger{background:rgba(248,113,113,0.22) !important;}
      #hist-labs-tbody tr.lab-row-warning{background:rgba(251,191,36,0.22) !important;}
      #hist-labs-tbody tr.lab-row-success{background:rgba(34,197,94,0.18) !important;}
    `;
    document.head.appendChild(st);
  }

  const CLASES_LAB_ESTADO = ['lab-estado-danger','lab-estado-warning','lab-estado-success','lab-estado-info'];
  const CLASES_LAB_FILA = ['lab-row-danger','lab-row-warning','lab-row-success'];

  const ESTILOS_LAB_CELDA = {
    danger:  { bg:'rgba(248, 113, 113, 0.55)', color:'#450a0a', bold:true, shadow:'0 0 0 1px rgba(248,113,113,0.7)' },
    warning: { bg:'rgba(251, 191, 36, 0.55)', color:'#422006', bold:true, shadow:'0 0 0 1px rgba(251,191,36,0.65)' },
    success: { bg:'rgba(34, 197, 94, 0.45)',  color:'#064e3b', bold:true, shadow:'0 0 0 1px rgba(34,197,94,0.6)' },
    info:    { bg:'rgba(59, 130, 246, 0.4)',  color:'#1e3a8a', bold:true, shadow:'0 0 0 1px rgba(59,130,246,0.55)' }
  };

  const ESTILOS_LAB_FILA = {
    danger:  'rgba(248, 113, 113, 0.22)',
    warning: 'rgba(251, 191, 36, 0.22)',
    success: 'rgba(34, 197, 94, 0.18)'
  };

  const PRIORIDAD_SEVERIDAD = { danger:3, warning:2, success:1 };

  function limpiarEstiloCelda(cell){
    if(!cell) return;
    cell.style.removeProperty('background-color');
    cell.style.removeProperty('color');
    cell.style.removeProperty('font-weight');
    cell.style.removeProperty('border-radius');
    cell.style.removeProperty('box-shadow');
    if(cell.classList){
      cell.classList.remove(...CLASES_LAB_ESTADO);
    }
  }

  function aplicarEstiloCelda(cell, estado){
    if(!cell){
      return 'neutral';
    }
    limpiarEstiloCelda(cell);
    if(!estado || estado === 'neutral'){
      return 'neutral';
    }
    const estilo = ESTILOS_LAB_CELDA[estado];
    if(!estilo){
      return 'neutral';
    }
    if(cell.classList){
      cell.classList.add(`lab-estado-${estado}`);
    }
    cell.style.setProperty('background-color', estilo.bg, 'important');
    cell.style.setProperty('color', estilo.color, 'important');
    if(estilo.shadow){
      cell.style.setProperty('box-shadow', estilo.shadow, 'important');
    } else {
      cell.style.removeProperty('box-shadow');
    }

    if(estilo.bold){
      cell.style.setProperty('font-weight', '600', 'important');
    } else {
      cell.style.removeProperty('font-weight');
    }
    cell.style.borderRadius = '4px';
    return estado;
  }

  // Render histórico de controles con posibilidad de filtrar por meses
  function aplicarFiltrosYRenderControl(meses){
    console.log('[RENDER-CONTROL] aplicarFiltrosYRenderControl llamado con meses:', meses);
    console.log('[RENDER-CONTROL] _histControlRaw disponible:', _histControlRaw ? _histControlRaw.length : 'undefined');
    console.log('[RENDER-CONTROL] _histControlRaw primer elemento:', _histControlRaw?.[0]);
    
    const tbody = document.getElementById('hist-control-tbody');
    if(!tbody) {
      console.log('Error: no se encontró tbody hist-control-tbody');
      return;
    }
    
    let rows = [..._histControlRaw];
    console.log('[RENDER-CONTROL] Filas iniciales:', rows.length);
    console.log('[RENDER-CONTROL] Primera fila de datos:', rows[0]);
    
    if(meses){
      const corte = new Date(); corte.setMonth(corte.getMonth()-meses);
      console.log('[RENDER-CONTROL] Fecha de corte para', meses, 'meses:', corte);
      console.log('[RENDER-CONTROL] Primera fecha ejemplo:', rows[0]?.fecha, '=> Date:', new Date(rows[0]?.fecha));
      rows = rows.filter(r=> {
        if (!r.fecha) return false;
        const fechaRow = new Date(r.fecha);
        const incluir = fechaRow >= corte;
        if (!incluir) console.log('[RENDER-CONTROL] Filtrada:', r.fecha, fechaRow, '<', corte);
        return incluir;
      });
      console.log('[RENDER-CONTROL] Filas después del filtro de', meses, 'meses:', rows.length);
    }
    
    if(!rows.length){ 
      tbody.innerHTML='<tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; 
      console.log('No hay filas para mostrar');
      return; 
    }
    
    console.log('Generando HTML para', rows.length, 'filas');
    tbody.innerHTML = rows.map((c,idx)=>{
      const fechaFmt = formatearFechaCorta(c.fecha);
      return `<tr class="ctl-row" data-index="${idx}" style="border-top:1px solid #e2e8f0;">
          <td style="padding:4px;">${fechaFmt}</td>
          <td style="padding:4px;" data-psis="${c.presion_sistolica??''}" data-pdia="${c.presion_diastolica??''}">${c.presion_sistolica??'—'}/${c.presion_diastolica??'—'}</td>
          <td style="padding:4px;" data-imc="${c.imc??''}">${c.imc??'—'}</td>
          <td style="padding:4px;">${c.imc_clasificacion||'—'}</td>
          <td style="padding:4px;" data-hta="${c.hta_clasificacion||''}">${c.hta_clasificacion||'—'}</td>
          <td style="padding:4px;">${c.peso??'—'}</td>
          <td style="padding:4px;">${c.talla??'—'}</td>
          <td style="padding:4px;">${c.cc??'—'}</td>
          <td style="padding:4px;">${c.hgt??'—'}</td>
          <td style="padding:4px;" data-hba1c="${c.hba1c??''}">${c.hba1c??'—'}</td>
          <td style="padding:4px;" data-delta="1"></td>
        </tr>`;}).join('');
    
    console.log('HTML generado e insertado. Aplicando colores y tendencias...');
    colorearControles();
    calcularTendenciasControles(rows);
    console.log('aplicarFiltrosYRenderControl completado');
  }

  // Render histórico de labs (tabla amplia) reutilizando _histLabsRaw
  function aplicarFiltrosYRenderLabs(meses){
    const tbody = document.getElementById('hist-labs-tbody');
    if(!tbody) return;
    let rows = [..._histLabsRaw];
    if(meses){
      const corte = new Date(); corte.setMonth(corte.getMonth()-meses);
      rows = rows.filter(r=> (r.examen_fecha||r.fecha_realizacion) && new Date(r.examen_fecha||r.fecha_realizacion) >= corte);
    }
    if(!rows.length){ tbody.innerHTML='<tr><td colspan="13" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; return; }
    function fmt(v){
      if(v===null || v===undefined || v==='') return '—';
      const asNum = Number(v);
      if(Number.isFinite(asNum)){
        return Math.abs(asNum) >= 100 ? asNum.toFixed(0) : asNum.toString();
      }
      return v;
    }
    tbody.innerHTML = rows.map((r,idx)=>{
      const fecha = r.examen_fecha || r.fecha_realizacion || r.fecha || '';
      const fechaFmt = formatearFechaCorta(fecha);
      const microAttrRaw = r.microalbuminuria_positiva;
      const microBase = r.microalbuminuria;
      const microVal = r.microalbuminuria_val;
      let microAttr = '';
      if(typeof microAttrRaw === 'boolean'){
        microAttr = microAttrRaw ? 'true' : 'false';
      } else if(microBase != null){
        microAttr = microBase;
      }
      let microTexto = '—';
      if(typeof microAttrRaw === 'boolean'){
        microTexto = microAttrRaw ? 'Positiva' : 'Negativa';
      } else if(typeof microBase === 'string' && microBase.trim()){
        microTexto = microBase.trim();
      } else if(Number.isFinite(Number(microBase))){
        microTexto = fmt(microBase);
      }
      if(microVal != null && microVal !== ''){
        const valFmt = fmt(microVal);
        microTexto = microTexto === '—' ? valFmt : `${microTexto} ${valFmt}`.trim();
      }
      return `<tr class="lab-row" data-index="${idx}" style="border-top:1px solid #e2e8f0;">
        <td style="padding:4px;">${fechaFmt}</td>
        <td style="padding:4px;" data-glicemia="${r.glicemia??''}">${fmt(r.glicemia)}</td>
        <td style="padding:4px;" data-hba1c="${r.hba1c??''}">${fmt(r.hba1c)}</td>
        <td style="padding:4px;" data-ldl="${r.ldl??''}">${fmt(r.ldl)}</td>
        <td style="padding:4px;" data-hdl="${r.hdl??''}">${fmt(r.hdl)}</td>
        <td style="padding:4px;" data-col="${r.col??''}">${fmt(r.col)}</td>
        <td style="padding:4px;" data-tag="${r.tag??''}">${fmt(r.tag)}</td>
        <td style="padding:4px;" data-creatinemia="${r.creatinemia??''}">${fmt(r.creatinemia)}</td>
        <td style="padding:4px;" data-vfg="${r.vfg??''}">${fmt(r.vfg)}</td>
        <td style="padding:4px;" data-rac="${r.rac??''}">${fmt(r.rac)}</td>
        <td style="padding:4px;" data-micro="${microAttr}">${microTexto}</td>
        <td style="padding:4px;" data-tsh="${r.tsh??''}">${fmt(r.tsh)}</td>
        <td style="padding:4px;" data-delta="1"></td>
      </tr>`;}).join('');
    colorearLabs();
    calcularTendenciasLabs(rows);
  }
  
  function colorearLabs(){
    const diab = usuarioTieneDiabetes();
    const sexo = obtenerSexoUsuario();
    document.querySelectorAll('#hist-labs-tbody tr.lab-row').forEach(tr=>{
      let severidadFila = '';

      const actualizarSeveridad = (estado)=>{
        if(!PRIORIDAD_SEVERIDAD[estado]) return;
        if(!severidadFila || PRIORIDAD_SEVERIDAD[estado] > PRIORIDAD_SEVERIDAD[severidadFila]){
          severidadFila = estado;
        }
      };

      const asignar = (cell, estado)=>{
        const aplicado = aplicarEstiloCelda(cell, estado);
        actualizarSeveridad(aplicado);
      };

      const glicemiaCell = tr.querySelector('[data-glicemia]');
      if(glicemiaCell){
        const val = valorNumerico(glicemiaCell.getAttribute('data-glicemia'));
        let estado = null;
        if(val !== null){
          if(val < 70){
            estado = 'danger';
          } else if(diab){
            if(val >= 180) estado = 'danger';
            else if(val >= 130) estado = 'warning';
            else if(val <= 120) estado = 'success';
          } else {
            if(val >= 140) estado = 'danger';
            else if(val >= 100) estado = 'warning';
            else if(val <= 110) estado = 'success';
          }
        }
        asignar(glicemiaCell, estado);
      }

      const hba1cCell = tr.querySelector('[data-hba1c]');
      if(hba1cCell){
        const val = valorNumerico(hba1cCell.getAttribute('data-hba1c'));
        let estado = null;
        if(val !== null){
          if(val >= 9) estado = 'danger';
          else if(val >= 7) estado = 'warning';
          else if(val >= 5.7) estado = 'success';
        }
        asignar(hba1cCell, estado);
      }

      const ldlCell = tr.querySelector('[data-ldl]');
      if(ldlCell){
        const val = valorNumerico(ldlCell.getAttribute('data-ldl'));
        let estado = null;
        if(val !== null){
          if(val >= 160) estado = 'danger';
          else if(val >= 130) estado = 'warning';
          else if(val <= 100) estado = 'success';
        }
        asignar(ldlCell, estado);
      }

      const hdlCell = tr.querySelector('[data-hdl]');
      if(hdlCell){
        const val = valorNumerico(hdlCell.getAttribute('data-hdl'));
        let estado = null;
        if(val !== null){
          const limiteBajo = sexo === 'f' ? 50 : (sexo === 'm' ? 40 : 45);
          if(val < limiteBajo) estado = 'danger';
          else if(val >= 60) estado = 'success';
        }
        asignar(hdlCell, estado);
      }

      const colCell = tr.querySelector('[data-col]');
      if(colCell){
        const val = valorNumerico(colCell.getAttribute('data-col'));
        let estado = null;
        if(val !== null){
          if(val >= 240) estado = 'danger';
          else if(val >= 200) estado = 'warning';
          else if(val < 200) estado = 'success';
        }
        asignar(colCell, estado);
      }

      const tagCell = tr.querySelector('[data-tag]');
      if(tagCell){
        const val = valorNumerico(tagCell.getAttribute('data-tag'));
        let estado = null;
        if(val !== null){
          if(val >= 200) estado = 'danger';
          else if(val >= 150) estado = 'warning';
          else if(val < 150) estado = 'success';
        }
        asignar(tagCell, estado);
      }

      const creaCell = tr.querySelector('[data-creatinemia]');
      if(creaCell){
        const val = valorNumerico(creaCell.getAttribute('data-creatinemia'));
        let estado = null;
        if(val !== null){
          const limite = sexo === 'f' ? 1.1 : (sexo === 'm' ? 1.3 : 1.2);
          if(val >= limite + 0.3) estado = 'danger';
          else if(val > limite) estado = 'warning';
          else if(val <= limite) estado = 'success';
        }
        asignar(creaCell, estado);
      }

      const vfgCell = tr.querySelector('[data-vfg]');
      if(vfgCell){
        const val = valorNumerico(vfgCell.getAttribute('data-vfg'));
        let estado = null;
        if(val !== null){
          if(val < 30) estado = 'danger';
          else if(val < 60) estado = 'warning';
          else if(val >= 60) estado = 'success';
        }
        asignar(vfgCell, estado);
      }

      const racCell = tr.querySelector('[data-rac]');
      if(racCell){
        const val = valorNumerico(racCell.getAttribute('data-rac'));
        let estado = null;
        if(val !== null){
          if(val >= 300) estado = 'danger';
          else if(val >= 30) estado = 'warning';
          else if(val > 0) estado = 'success';
        }
        asignar(racCell, estado);
      }

      const microCell = tr.querySelector('[data-micro]');
      if(microCell){
        const attr = (microCell.getAttribute('data-micro') || '').toString().toLowerCase();
        const txt = microCell.textContent.toLowerCase();
        let estado = null;
        if(attr === 'true' || attr === '1' || /positiva|sí|si/.test(txt)){
          estado = 'danger';
        } else if(/negativa/.test(txt) || attr === 'false'){
          estado = 'success';
        }
        asignar(microCell, estado);
      }

      const tshCell = tr.querySelector('[data-tsh]');
      if(tshCell){
        const val = valorNumerico(tshCell.getAttribute('data-tsh'));
        let estado = null;
        if(val !== null){
          if(val >= 10 || val < 0.1) estado = 'danger';
          else if(val >= 4.5 || val < 0.4) estado = 'warning';
        }
        asignar(tshCell, estado);
      }

      tr.classList.remove(...CLASES_LAB_FILA);
      if(severidadFila && CLASES_LAB_FILA.includes(`lab-row-${severidadFila}`)){
        tr.classList.add(`lab-row-${severidadFila}`);
      }
      if(severidadFila){
        const bg = ESTILOS_LAB_FILA[severidadFila] || '';
        if(bg){
          tr.style.setProperty('background-color', bg, 'important');
        } else {
          tr.style.removeProperty('background-color');
        }
      } else {
        tr.style.removeProperty('background-color');
      }
    });
  }
  
  function calcularTendenciasLabs(rows){
    const trs = document.querySelectorAll('#hist-labs-tbody tr.lab-row');
    rows.forEach((r,i)=>{
      if(i===rows.length-1) return;
      const prev = rows[i+1];
      const deltaLdl = (r.ldl!=null && prev.ldl!=null)? (parseFloat(r.ldl)-parseFloat(prev.ldl)) : null;
      const deltaHba = (r.hba1c!=null && prev.hba1c!=null)? (parseFloat(r.hba1c)-parseFloat(prev.hba1c)) : null;
      const cell = trs[i].querySelector('[data-delta]');
      if(!cell) return;
      let partes=[];
      if(deltaLdl!==null && Math.abs(deltaLdl)>=10) partes.push(arrowHTML(deltaLdl, 10, true));
      if(deltaHba!==null && Math.abs(deltaHba)>=0.3) partes.push(arrowHTML(deltaHba, 0.3, true));
      cell.innerHTML = partes.join(' ');
    });
  }
(async function initRiesgo(){
  const cont = document.getElementById('contenedor-patologias');
  if(!cont) return;
  let catalogo = [];
  let seleccion = new Set();
  let patologiasCargadasUsuario = new Set();
  let usuarioLimpioSeleccion = false; // Rastrear si el usuario limpió intencionalmente
  const buscador = document.getElementById('buscador-patologia');
  const btnCalc = document.getElementById('btn-calcular-riesgo');
  const btnAplicar = document.getElementById('btn-aplicar-riesgo');
  const btnGuardarPats = document.getElementById('btn-guardar-patologias');
  const btnSelectFiltradas = document.getElementById('btn-select-filtradas');
  const btnClearSel = document.getElementById('btn-clear-seleccion');
  const contadorSel = document.getElementById('contador-seleccion');
  const estadoPats = document.getElementById('estado-patologias');
  const riesgoSug = document.getElementById('riesgo-sugerido');
  const riesgoApl = document.getElementById('riesgo-aplicado');
  const riesgoRaz = document.getElementById('riesgo-razones');
  
  // Exponer referencias globales para uso externo (IA, etc.)
  window._riesgoSeleccion = seleccion;
  window._riesgoCatalogo = catalogo;
  window._riesgoRender = () => render();
  
  // Función global para limpiar selección al cargar nuevo usuario
  window._limpiarSeleccionRiesgo = () => {
    console.log('[🔎 Riesgo] Limpiando selección de patologías');
    seleccion.clear();
    usuarioLimpioSeleccion = false;
    render();
    actualizarBotones();
  };
  
  // Exponer función eliminarYRecalcular globalmente para botones onclick
  window.eliminarYRecalcular = null; // Se asignará después de la definición

  function setEstado(msg,tipo='info'){
    estadoPats.textContent = msg||'';
    estadoPats.style.color = tipo==='error' ? '#b91c1c' : '#334155';
  }

  function actualizarBotones(){
    const selCount = seleccion.size;
    if(contadorSel) contadorSel.textContent = selCount ? `${selCount} seleccionada${selCount>1?'s':''}` : '';
    if(btnCalc) btnCalc.disabled = selCount === 0;
    if(btnAplicar) btnAplicar.disabled = selCount === 0;
    if(btnGuardarPats) btnGuardarPats.disabled = selCount === 0;
    if(btnClearSel) btnClearSel.disabled = selCount === 0;
  }

  // --- Persistencia automática de categoría calculada ---
  let categoriaAutoSaveTimer = null;
  let ultimaFirmaPersistida = null;

  function persistirCategoriaCalculada(categoriaCalculada, puntajeTotal) {
    const categoriaLimpia = (categoriaCalculada || "").toString().trim().toUpperCase();
    const runInput = document.getElementById('run');
    const runVal = runInput?.value?.trim();
    const programaActual = (window.programaSeleccionado || 'ECICEP').toString().trim().toUpperCase();

    if (!runVal) {
      console.warn('[🔒 Categoria] RUN vacío: se omite guardado automático');
      return;
    }

    if (!categoriaLimpia || categoriaLimpia === '—' || categoriaLimpia === '-') {
      return;
    }

    // En modo CARDIO se delega al guardado manual (cambia a categoría fija)
    if (programaActual === 'CARDIO') {
      return;
    }

    // Solo persistir categorías válidas ECICEP (G0-G3)
    if (!['G0', 'G1', 'G2', 'G3'].includes(categoriaLimpia)) {
      console.warn('[🔒 Categoria] Categoría fuera de rango ECICEP:', categoriaLimpia);
      return;
    }

    const firma = `${runVal}|${categoriaLimpia}`;
    if (ultimaFirmaPersistida === firma) {
      return;
    }

    if (categoriaAutoSaveTimer) {
      clearTimeout(categoriaAutoSaveTimer);
    }

    categoriaAutoSaveTimer = setTimeout(async () => {
      try {
        console.log(`[🔒 Categoria] Guardando categoría ${categoriaLimpia} para ${runVal}`);
        const resp = await authFetch(`/api/usuarios/${encodeURIComponent(runVal)}/categoria`, {
          method: 'POST',
          body: JSON.stringify({
            categoria: categoriaLimpia,
            fuente: 'auto_calculo',
            puntaje: puntajeTotal
          })
        });
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data && data.ok) {
          ultimaFirmaPersistida = firma;
          window.__ultimaCategoriaGuardada = categoriaLimpia;
          console.log(`[🔒 Categoria] Categoría ${categoriaLimpia} guardada correctamente`);
        } else {
          console.warn('[🔒 Categoria] Error al guardar categoría', data || resp.status);
        }
      } catch (error) {
        console.warn('[🔒 Categoria] Excepción guardando categoría', error);
      }
    }, 750);
  }

  // =====================================================================
  // FUNCIÓN DE CÁLCULO DE RIESGO ECICEP (Reutilizable)
  // =====================================================================
  function calcularRiesgoECICEP() {
    console.log('[🔎 Riesgo ECICEP] ═══════════════════════════════════════');
    console.log('[🔎 Riesgo ECICEP] INICIANDO CÁLCULO DE RIESGO');
    
    // USAR PATOLOGÍAS DEL USUARIO GUARDADAS (no checkboxes temporales)
    // Estas patologías se cargan desde la BD y se almacenan en window._patologiasUsuarioBD
    let patologiasParaCalcular = window._patologiasUsuarioBD || [];
    
    console.log('[🔎 Riesgo ECICEP] Patologías del usuario (desde BD):', patologiasParaCalcular.length);
    console.log('[🔎 Riesgo ECICEP] window._patologiasUsuarioBD completo:', JSON.stringify(window._patologiasUsuarioBD, null, 2));
    
    if (patologiasParaCalcular.length === 0) {
      console.warn('[🔎 Riesgo ECICEP] No hay patologías guardadas del usuario');
      return { categoriaCalculada: 'G0', puntajeTotal: 0, descripcionCategoria: 'Sin riesgo' };
    }
    
    // =====================================================================
    // TABLA OFICIAL COMPLETA DE PONDERACIONES ECICEP
    // Basada en documento oficial "PROCESO DE ESTRATIFICACIÓN EN PERSONAS DE 15 Y MÁS AÑOS"
    // =====================================================================
    
    // ⚠️ PATOLOGÍAS CRÍTICAS - SOLO ESTAS VALEN 2 PUNTOS ⚠️
    const patologiasCriticas = {
      // 1. Demencia (2 pts)
      'F00': 2, 'F000': 2, 'F001': 2, 'F002': 2, 'F009': 2,
      'F01': 2, 'F010': 2, 'F011': 2, 'F012': 2, 'F013': 2, 'F018': 2, 'F019': 2,
      'F02': 2, 'F020': 2, 'F021': 2, 'F022': 2, 'F023': 2, 'F024': 2, 'F028': 2,
      'F03': 2,
      
      // 2. Depresión grave / grave con ideación suicida / refractaria / con psicosis (2 pts)
      'F332': 2, 'F333': 2,
      
      // 3. Diabetes mellitus (2 pts) - TODOS LOS TIPOS
      'E10': 2, 'E100': 2, 'E101': 2, 'E102': 2, 'E103': 2, 'E104': 2, 'E105': 2, 'E106': 2, 'E107': 2, 'E108': 2, 'E109': 2,
      'E11': 2, 'E110': 2, 'E111': 2, 'E112': 2, 'E113': 2, 'E114': 2, 'E115': 2, 'E116': 2, 'E117': 2, 'E118': 2, 'E119': 2,
      'E12': 2, 'E120': 2, 'E121': 2, 'E122': 2, 'E123': 2, 'E124': 2, 'E125': 2, 'E126': 2, 'E127': 2, 'E128': 2, 'E129': 2,
      'E13': 2, 'E130': 2, 'E131': 2, 'E132': 2, 'E133': 2, 'E134': 2, 'E135': 2, 'E136': 2, 'E137': 2, 'E138': 2, 'E139': 2,
      'E14': 2, 'E140': 2, 'E141': 2, 'E142': 2, 'E143': 2, 'E144': 2, 'E145': 2, 'E146': 2, 'E147': 2, 'E148': 2, 'E149': 2,
      
      // 4. Enfermedad cerebrovascular / ACV / AVE (2 pts)
      'G46': 2, 'G460': 2, 'G461': 2, 'G462': 2, 'G463': 2, 'G464': 2, 'G465': 2, 'G466': 2, 'G467': 2, 'G468': 2,
      'I64': 2,
      'I67': 2, 'I670': 2, 'I671': 2, 'I672': 2, 'I673': 2, 'I674': 2, 'I675': 2, 'I676': 2, 'I677': 2, 'I678': 2, 'I679': 2,
      'I68': 2, 'I680': 2, 'I681': 2, 'I682': 2, 'I688': 2,
      
      // 5. Enfermedad renal crónica avanzada (2 pts) - SOLO estadios 4, 5, 6
      'N184': 2, 'N185': 2, 'N186': 2,
      
      // 6. Enfermedades cardiovasculares / IAM / cardiopatía isquémica (2 pts)
      'I20': 2, 'I200': 2, 'I201': 2, 'I208': 2, 'I209': 2,
      'I21': 2, 'I210': 2, 'I211': 2, 'I212': 2, 'I213': 2, 'I214': 2, 'I215': 2, 'I216': 2, 'I217': 2, 'I218': 2, 'I219': 2,
      'I22': 2, 'I220': 2, 'I221': 2, 'I228': 2, 'I229': 2,
      'I25': 2, 'I250': 2, 'I251': 2, 'I252': 2, 'I253': 2, 'I254': 2, 'I255': 2, 'I256': 2, 'I257': 2, 'I258': 2, 'I259': 2,
      'I51': 2, 'I510': 2, 'I514': 2, 'I515': 2, 'I516': 2, 'I517': 2, 'I518': 2, 'I519': 2,
      'I52': 2, 'I520': 2, 'I521': 2, 'I528': 2,
      
      // 7. Esquizofrenia y trastornos psicóticos relacionados (2 pts)
      'F20': 2, 'F200': 2, 'F201': 2, 'F202': 2, 'F203': 2, 'F204': 2, 'F205': 2, 'F206': 2, 'F207': 2, 'F208': 2, 'F209': 2,
      'F21': 2,
      'F22': 2, 'F220': 2, 'F228': 2, 'F229': 2,
      'F23': 2, 'F230': 2, 'F231': 2, 'F232': 2, 'F233': 2, 'F238': 2, 'F239': 2,
      
      // 8. Función limitada / discapacidad / dependencia (2 pts)
      'R26': 2, 'R260': 2, 'R261': 2, 'R262': 2, 'R268': 2,
      'Z74': 2, 'Z740': 2, 'Z741': 2, 'Z742': 2, 'Z743': 2, 'Z748': 2, 'Z749': 2,
      'Z99': 2, 'Z990': 2, 'Z991': 2, 'Z992': 2, 'Z993': 2, 'Z998': 2, 'Z999': 2
    };
      
      // ✅ TODAS LAS DEMÁS PATOLOGÍAS VALEN 1 PUNTO
      const patologiasStandard = {
        // Consumo perjudicial/dependiente de alcohol (1 pt)
        'F10': 1, 'F100': 1, 'F101': 1, 'F102': 1, 'F103': 1, 'F104': 1, 'F105': 1, 'F106': 1, 'F107': 1, 'F108': 1, 'F109': 1,
        'Y91': 1, 'Y912': 1, 'Y913': 1, 'Y919': 1,
        'Z71': 1, 'Z714': 1, 'Z716': 1,
        'Z72': 1, 'Z720': 1, 'Z721': 1,
        
        // Tabaquismo (1 pt)
        'F17': 1, 'F170': 1, 'F171': 1, 'F172': 1, 'F173': 1, 'F174': 1, 'F175': 1, 'F176': 1, 'F177': 1, 'F178': 1, 'F179': 1,
        'T65': 1, 'T652': 1,
        
        // Consumo perjudicial/dependiente de drogas (1 pt)
        'F11': 1, 'F110': 1, 'F111': 1, 'F112': 1, 'F113': 1, 'F114': 1, 'F115': 1, 'F116': 1, 'F117': 1, 'F118': 1, 'F119': 1,
        'F12': 1, 'F120': 1, 'F121': 1, 'F122': 1, 'F123': 1, 'F124': 1, 'F125': 1, 'F126': 1, 'F127': 1, 'F128': 1, 'F129': 1,
        'F13': 1, 'F130': 1, 'F131': 1, 'F132': 1, 'F133': 1, 'F134': 1, 'F135': 1, 'F136': 1, 'F137': 1, 'F138': 1, 'F139': 1,
        'F14': 1, 'F140': 1, 'F141': 1, 'F142': 1, 'F143': 1, 'F144': 1, 'F145': 1, 'F146': 1, 'F147': 1, 'F148': 1, 'F149': 1,
        'F15': 1, 'F150': 1, 'F151': 1, 'F152': 1, 'F153': 1, 'F154': 1, 'F155': 1, 'F156': 1, 'F157': 1, 'F158': 1, 'F159': 1,
        'F16': 1, 'F160': 1, 'F161': 1, 'F162': 1, 'F163': 1, 'F164': 1, 'F165': 1, 'F166': 1, 'F167': 1, 'F168': 1, 'F169': 1,
        'F18': 1, 'F180': 1, 'F181': 1, 'F182': 1, 'F183': 1, 'F184': 1, 'F185': 1, 'F186': 1, 'F187': 1, 'F188': 1, 'F189': 1,
        'F19': 1, 'F190': 1, 'F191': 1, 'F192': 1, 'F193': 1, 'F194': 1, 'F195': 1, 'F196': 1, 'F197': 1, 'F198': 1, 'F199': 1,
        
        // Anemia crónica (1 pt)
        'D50': 1,
        'D51': 1, 'D510': 1, 'D511': 1, 'D512': 1, 'D513': 1, 'D518': 1, 'D519': 1,
        'D52': 1, 'D520': 1, 'D521': 1, 'D528': 1, 'D529': 1,
        'D53': 1, 'D530': 1, 'D531': 1, 'D532': 1, 'D538': 1, 'D539': 1,
        'D55': 1, 'D550': 1, 'D551': 1, 'D552': 1, 'D553': 1, 'D558': 1, 'D559': 1,
        'D56': 1, 'D560': 1, 'D561': 1, 'D562': 1, 'D563': 1, 'D564': 1, 'D568': 1, 'D569': 1,
        'D57': 1, 'D570': 1, 'D571': 1, 'D572': 1, 'D573': 1, 'D578': 1,
        'D58': 1, 'D580': 1, 'D581': 1, 'D582': 1, 'D588': 1, 'D589': 1,
        'D59': 1, 'D590': 1, 'D591': 1, 'D592': 1, 'D593': 1, 'D594': 1, 'D595': 1, 'D596': 1, 'D598': 1, 'D599': 1,
        'D60': 1, 'D600': 1, 'D601': 1, 'D608': 1, 'D609': 1,
        'D61': 1, 'D610': 1, 'D611': 1, 'D612': 1, 'D613': 1, 'D618': 1, 'D619': 1,
        'D62': 1,
        'D63': 1, 'D630': 1, 'D638': 1,
        'D64': 1, 'D640': 1, 'D641': 1, 'D642': 1, 'D643': 1, 'D644': 1, 'D648': 1, 'D649': 1,
        
        // Trastornos alimentarios (1 pt)
        'F50': 1, 'F500': 1, 'F501': 1, 'F502': 1, 'F503': 1, 'F504': 1, 'F505': 1, 'F508': 1, 'F509': 1,
        
        // Artritis REUMATOIDEA (1 pt)
        'M05': 1, 'M050': 1, 'M051': 1, 'M052': 1, 'M053': 1, 'M058': 1, 'M059': 1,
        'M06': 1, 'M060': 1, 'M061': 1, 'M062': 1, 'M063': 1, 'M064': 1, 'M068': 1, 'M069': 1,
        
        // Artrosis de rodilla, cadera u otro tipo (1 pt)
        'M15': 1, 'M150': 1, 'M151': 1, 'M152': 1, 'M153': 1, 'M154': 1, 'M158': 1, 'M159': 1,
        'M16': 1, 'M160': 1, 'M161': 1, 'M162': 1, 'M163': 1, 'M164': 1, 'M165': 1, 'M166': 1, 'M167': 1, 'M169': 1,
        'M17': 1, 'M170': 1, 'M171': 1, 'M172': 1, 'M173': 1, 'M174': 1, 'M175': 1, 'M179': 1,
        'M18': 1, 'M180': 1, 'M181': 1, 'M182': 1, 'M183': 1, 'M184': 1, 'M185': 1, 'M189': 1,
        'M19': 1, 'M190': 1, 'M191': 1, 'M192': 1, 'M199': 1,
        
        // Asma (1 pt)
        'J45': 1, 'J450': 1, 'J451': 1, 'J458': 1, 'J459': 1,
        'J46': 1,
        
        // Catarata/Retinopatía (1 pt)
        'H25': 1, 'H250': 1, 'H251': 1, 'H252': 1, 'H258': 1, 'H259': 1,
        'H26': 1, 'H260': 1, 'H261': 1, 'H262': 1, 'H263': 1,
        
        // Alzheimer y otras demencias (1 pt) - NO CONFUNDIR con Demencia (2 pts) que es F00-F03
        'G30': 1, 'G300': 1, 'G301': 1, 'G308': 1, 'G309': 1,
        
        // Dependencia del oxígeno (1 pt) - NOTA: Z99 también está en dependencia (2 pts), prioridad a 2 pts
        
        // Discapacidad visual bilateral (1 pt)
        'H54': 1, 'H540': 1, 'H541': 1, 'H542': 1, 'H543': 1, 'H544': 1, 'H545': 1, 'H546': 1, 'H547': 1,
        
        // Dislipidemias (1 pt)
        'E78': 1, 'E780': 1, 'E781': 1, 'E782': 1, 'E783': 1, 'E784': 1, 'E785': 1, 'E786': 1, 'E788': 1, 'E789': 1,
        
        // TIA / Isquemia cerebral transitoria (1 pt) - NO confundir con ACV (2 pts)
        'G45': 1, 'G450': 1, 'G451': 1, 'G452': 1, 'G453': 1, 'G454': 1, 'G458': 1, 'G459': 1,
        
        // #14: Discapacidad visual bilateral (1 pt)
        'H54': 1, 'H540': 1, 'H541': 1, 'H542': 1, 'H543': 1, 'H544': 1, 'H545': 1, 'H546': 1, 'H547': 1,
        
        // #15: Discapacidad auditiva (1 pt) - similar a #43 Presbiacusia
        
        // #16: Dislipidemias (1 pt)
        'E78': 1, 'E780': 1, 'E781': 1, 'E782': 1, 'E783': 1, 'E784': 1, 'E785': 1, 'E786': 1, 'E788': 1, 'E789': 1,
        
        // #18: Isquemia cerebral transitoria (TIA) (1 pt) - Ya incluido en críticas si es G45
        
        // #19: Enfermedad hepática (1 pt)
        'B18': 1, 'B180': 1, 'B181': 1, 'B182': 1, 'B188': 1, 'B189': 1,
        'K70': 1, 'K700': 1, 'K701': 1, 'K702': 1, 'K703': 1, 'K704': 1, 'K709': 1,
        'K71': 1, 'K710': 1, 'K711': 1, 'K712': 1, 'K713': 1, 'K714': 1, 'K715': 1, 'K716': 1, 'K717': 1, 'K718': 1, 'K719': 1,
        'K72': 1, 'K721': 1,
        'K73': 1, 'K730': 1, 'K731': 1, 'K732': 1, 'K738': 1, 'K739': 1,
        'K74': 1, 'K740': 1, 'K741': 1, 'K742': 1, 'K743': 1, 'K744': 1, 'K745': 1, 'K746': 1,
        
        // #20: Enfermedad pulmonar obstructiva crónica (EPOC) (1 pt)
        'J41': 1, 'J410': 1, 'J411': 1, 'J418': 1,
        'J42': 1,
        'J43': 1, 'J431': 1, 'J432': 1, 'J438': 1, 'J439': 1,
        'J44': 1, 'J440': 1, 'J441': 1, 'J448': 1, 'J449': 1,
        
        // #21: Enfermedad renal crónica (1 pt) - SOLO estadios 1-3a
        'N15': 1, 'N150': 1, 'N151': 1, 'N158': 1, 'N159': 1,
        'N18': 1, 'N180': 1, 'N181': 1, 'N182': 1, 'N183': 1, 'N189': 1,
        'N19': 1, 'N190': 1, 'N191': 1, 'N198': 1, 'N199': 1,
        
        // #24: Enteritis crónica/colitis ulcerosa/Crohn (1 pt)
        'K50': 1, 'K500': 1, 'K501': 1, 'K509': 1, 'K508': 1,
        'K51': 1, 'K510': 1, 'K511': 1, 'K518': 1, 'K519': 1, 'K512': 1, 'K513': 1, 'K528': 1, 'K529': 1,
        'K52': 1, 'K520': 1, 'K521': 1, 'K522': 1, 'K523': 1, 'K528': 1, 'K529': 1,
        
        // #25: Epilepsia (1 pt)
        'G40': 1, 'G400': 1, 'G401': 1, 'G402': 1, 'G403': 1, 'G404': 1, 'G406': 1, 'G408': 1, 'G409': 1, 'G407': 1,
        
        // #26: Esclerosis múltiple (1 pt)
        'G35': 1,
        
        // #28: Fibrilación auricular/flutter (1 pt)
        'I48': 1, 'I480': 1, 'I481': 1, 'I482': 1, 'I483': 1, 'I484': 1, 'I489': 1,
        
        // #30: Glaucoma (1 pt)
        'H40': 1, 'H401': 1, 'H402': 1, 'H403': 1, 'H404': 1, 'H405': 1, 'H406': 1, 'H408': 1, 'H409': 1,
        'H42': 1, 'H420': 1, 'H428': 1,
        
        // #31: Hiperuricemia (1 pt)
        'M10': 1,
        
        // #32: Hipertensión (1 pt) - TODOS los códigos
        'I10': 1, 'I100': 1, 'I109': 1,
        'I11': 1, 'I110': 1, 'I119': 1,
        'I12': 1, 'I120': 1, 'I129': 1,
        'I13': 1, 'I130': 1, 'I131': 1, 'I132': 1, 'I139': 1,
        
        // Insuficiencia cardíaca (1 pt) - NO confundir con IAM/cardiopatía isquémica (2 pts)
        'I50': 1, 'I500': 1, 'I501': 1, 'I509': 1,
        
        // Hipertrofia prostática benigna (1 pt)
        'N40': 1,
        
        // #34: Trastornos tiroideos (1 pt)
        'E01': 1, 'E010': 1, 'E011': 1, 'E012': 1,
        'E02': 1,
        'E03': 1, 'E030': 1, 'E031': 1, 'E032': 1, 'E033': 1, 'E034': 1, 'E035': 1, 'E038': 1, 'E039': 1,
        'E05': 1, 'E050': 1, 'E051': 1, 'E052': 1, 'E053': 1, 'E054': 1, 'E055': 1, 'E058': 1, 'E059': 1,
        
        // #35: Infección por VIH/SIDA (1 pt)
        'B21': 1, 'B210': 1, 'B211': 1, 'B212': 1, 'B213': 1, 'B217': 1, 'B218': 1, 'B219': 1,
        'B22': 1, 'B220': 1, 'B221': 1, 'B222': 1, 'B227': 1,
        'B23': 1, 'B230': 1, 'B231': 1, 'B232': 1, 'B238': 1,
        'B24': 1,
        
        // #37: Lupus (1 pt)
        'L93': 1, 'L930': 1, 'L931': 1, 'L932': 1,
        'M32': 1, 'M320': 1, 'M321': 1, 'M328': 1, 'M329': 1,
        
        // #38: Malignidad/Neoplasia/Tumor maligno/Cáncer (1 pt)
        'C': 1, // Todos los C00-C97
        'D48': 1,
        
        // #39: Maltrato físico/psicológico/violencia/abuso sexual (1 pt)
        'T74': 1, 'T740': 1, 'T741': 1, 'T742': 1, 'T743': 1, 'T748': 1, 'T749': 1,
        'Y07': 1, 'Y070': 1, 'Y071': 1, 'Y072': 1, 'Y073': 1, 'Y078': 1, 'Y079': 1,
        
        // #40: Dolor neuropático/fibromialgia (1 pt)
        'G50': 1, 'G500': 1, 'G501': 1, 'G508': 1, 'G509': 1,
        'M79': 1, 'M797': 1,
        
        // #41: Obesidad (1 pt)
        'E66': 1, 'E660': 1, 'E661': 1, 'E662': 1, 'E669': 1, 'E668': 1,
        
        // #42: Parkinsonismo (1 pt)
        'G20': 1,
        'G21': 1, 'G211': 1,
        'G22': 1,
        'G23': 1, 'G230': 1, 'G231': 1, 'G232': 1, 'G238': 1, 'G239': 1,
        'G24': 1, 'G240': 1, 'G241': 1, 'G242': 1, 'G244': 1, 'G245': 1, 'G248': 1, 'G249': 1,
        'G25': 1, 'G252': 1, 'G253': 1, 'G254': 1, 'G255': 1,
        'G26': 1,
        
        // #43: Presbiacusia/Hipoacusia/Sordera (1 pt)
        'H90': 1, 'H900': 1, 'H901': 1, 'H902': 1, 'H903': 1, 'H904': 1, 'H905': 1, 'H906': 1, 'H907': 1, 'H908': 1,
        'H91': 1, 'H910': 1, 'H911': 1, 'H912': 1, 'H918': 1, 'H919': 1, 'H913': 1,
        
        // #44: Trastornos de la coagulación (1 pt)
        'D68': 1, 'D680': 1, 'D681': 1, 'D682': 1, 'D684': 1, 'D688': 1, 'D689': 1,
        'D69': 1, 'D690': 1, 'D692': 1, 'D694': 1, 'D696': 1, 'D698': 1, 'D699': 1,
        'D75': 1, 'D750': 1, 'D758': 1, 'D759': 1,
        'D77': 1,
        
        // #45: Retraso mental (1 pt)
        'F70': 1, 'F700': 1, 'F701': 1, 'F708': 1, 'F709': 1,
        'F71': 1, 'F710': 1, 'F711': 1, 'F718': 1, 'F719': 1,
        'F72': 1, 'F720': 1, 'F721': 1, 'F728': 1, 'F729': 1,
        'F73': 1, 'F730': 1, 'F731': 1, 'F738': 1, 'F739': 1,
        'F78': 1, 'F780': 1, 'F781': 1, 'F788': 1, 'F789': 1,
        'F79': 1, 'F790': 1, 'F791': 1, 'F798': 1, 'F799': 1,
        
        // #46: Arritmia cardíaca/Taquicardia paroxística (1 pt)
        'I47': 1, 'I470': 1, 'I471': 1, 'I472': 1, 'I479': 1,
        'I49': 1, 'I490': 1, 'I498': 1, 'I499': 1,
        
        // #47: Trastorno Ansioso (1 pt)
        'F40': 1, 'F400': 1, 'F401': 1, 'F402': 1, 'F408': 1, 'F409': 1,
        'F41': 1, 'F410': 1, 'F411': 1, 'F412': 1, 'F413': 1, 'F418': 1, 'F419': 1,
        'F42': 1, 'F422': 1, 'F429': 1, 'F428': 1,
        
        // #48: Trastorno de la personalidad (1 pt)
        'F60': 1, 'F600': 1, 'F601': 1, 'F602': 1, 'F603': 1, 'F604': 1, 'F605': 1, 'F606': 1, 'F607': 1, 'F608': 1, 'F609': 1,
        'F61': 1,
        'F62': 1, 'F620': 1, 'F621': 1, 'F628': 1, 'F629': 1,
        'F68': 1, 'F680': 1,
        'F69': 1,
        
        // Trastornos del sueño (1 pt)
        'F51': 1, 'F510': 1, 'F511': 1, 'F512': 1, 'F514': 1, 'F519': 1, 'F518': 1,
        'G47': 1, 'G473': 1, 'G474': 1, 'G478': 1, 'G479': 1,
        
        // Trastornos depresivos LEVES/MODERADOS (1 pt) - NO incluye F33.2 y F33.3 que son 2 pts
        'F31': 1, 'F310': 1, 'F311': 1, 'F312': 1, 'F313': 1, 'F314': 1, 'F315': 1, 'F316': 1, 'F317': 1, 'F318': 1, 'F319': 1,
        'F32': 1, 'F320': 1, 'F321': 1, 'F322': 1, 'F323': 1, 'F328': 1, 'F329': 1,
        'F33': 1, 'F330': 1, 'F331': 1, 'F334': 1, 'F338': 1, 'F339': 1, // F33.2 y F33.3 NO están aquí (son 2 pts)
        'F34': 1, 'F340': 1, 'F341': 1, 'F348': 1, 'F349': 1,
        'F63': 1, 'F630': 1, 'F632': 1, 'F638': 1, 'F639': 1,
        'F66': 1, 'F661': 1, 'F662': 1, 'F668': 1, 'F669': 1,
        
        // #51: Tuberculosis (1 pt)
        'A15': 1, 'A150': 1, 'A151': 1, 'A152': 1, 'A153': 1, 'A154': 1, 'A155': 1, 'A157': 1, 'A158': 1, 'A159': 1, 'A156': 1,
        'A17': 1, 'A170': 1, 'A171': 1, 'A178': 1, 'A179': 1,
        'A18': 1, 'A180': 1, 'A181': 1, 'A182': 1, 'A183': 1, 'A184': 1, 'A185': 1, 'A186': 1, 'A187': 1, 'A188': 1,
        'A19': 1, 'A190': 1, 'A191': 1, 'A192': 1, 'A198': 1, 'A199': 1,
        
        // #52: Úlcera crónica de la piel (1 pt)
        'I83': 1, 'I830': 1, 'I831': 1, 'I832': 1, 'I839': 1,
        'L97': 1,
        'L98': 1, 'L984': 1
      };
      
      // =====================================================================
      // CÁLCULO DE PUNTAJE TOTAL
      // =====================================================================
      
      let puntajeTotal = 0;
      let detallePatologias = [];
      let tieneCriticas = false;
      
      for (const pat of patologiasParaCalcular) {
        // Acceso robusto a propiedades (puede venir como cie10/CIE10/codigo_cie10)
        const cie10Raw = pat.cie10 || pat.CIE10 || pat.codigo_cie10 || '';
        const nombrePat = pat.nombre || pat.NOMBRE || pat.nombre_patologia || 'Sin nombre';
        
        const cie10Normalizado = cie10Raw.replace(/\./g, '').toUpperCase();
        const cie10Base = cie10Normalizado.substring(0, 3); // Primeros 3 caracteres (ej: I50, E11, N18)
        
        console.log(`[🔎 ECICEP] Analizando: ${cie10Raw} → Base: ${cie10Base} → Nombre: ${nombrePat}`);
        console.log(`[🔎 ECICEP] Objeto completo:`, pat);
        
        // Buscar en patologías críticas (2 puntos)
        let puntos = 0;
        let categoria = '';
        
        if (patologiasCriticas[cie10Base] || patologiasCriticas[cie10Normalizado]) {
          puntos = 2;
          categoria = '⚠️ CRÍTICA';
          tieneCriticas = true;
          console.log(`  ✅ CRÍTICA: ${cie10Base} = 2 puntos`);
        }
        // Buscar en patologías estándar (1 punto)
        else if (patologiasStandard[cie10Base] || patologiasStandard[cie10Normalizado]) {
          puntos = 1;
          categoria = 'Moderada';
          console.log(`  ✅ MODERADA: ${cie10Base} = 1 punto`);
        }
        // Patologías no catalogadas NO CUENTAN (0 puntos)
        else {
          puntos = 0;
          categoria = 'No catalogada';
          console.log(`  ⚠️ NO CATALOGADA: ${cie10Base} = 0 puntos (no suma al total)`);
        }
        
        // Solo agregar al total y al detalle si tiene puntos
        if (puntos > 0) {
          puntajeTotal += puntos;
          detallePatologias.push(`• ${cie10Raw}: ${nombrePat} [${puntos} pt${puntos !== 1 ? 's' : ''} - ${categoria}]`);
        } else {
          console.log(`  ⏭️ Omitida del cálculo (no catalogada)`);
        }
      }
      
      console.log(`[🔎 ECICEP] Puntaje total: ${puntajeTotal} puntos`);
      console.log(`[🔎 ECICEP] Tiene patologías críticas (2 pts): ${tieneCriticas}`);
      console.log(`[🔎 ECICEP] Detalle patologías catalogadas (${detallePatologias.length}):`, detallePatologias);
      
      // Advertencia si no hay patologías catalogadas
      if (detallePatologias.length === 0 && patologiasParaCalcular.length > 0) {
        console.warn(`⚠️ [🔎 ECICEP] ADVERTENCIA: El usuario tiene ${patologiasParaCalcular.length} patologías pero NINGUNA está en el catálogo ECICEP`);
        console.warn(`⚠️ [🔎 ECICEP] Patologías del usuario:`, patologiasParaCalcular.map(p => {
          const cie10Raw = p.cie10 || p.CIE10 || p.codigo_cie10 || '';
          const nombrePat = p.nombre || p.NOMBRE || p.nombre_patologia || 'Sin nombre';
          return `${cie10Raw} - ${nombrePat}`;
        }));
      }
      
      // =====================================================================
      // CLASIFICACIÓN SEGÚN PUNTAJE (Algoritmo oficial ECICEP)
      // =====================================================================
      
      let categoriaCalculada = 'G0';
      let descripcionCategoria = '';
      
      console.log('[🔎 ECICEP] Aplicando clasificación...');
      
      if (puntajeTotal === 0) {
        categoriaCalculada = 'G0';
        descripcionCategoria = detallePatologias.length === 0 && patologiasParaCalcular.length > 0 
          ? 'Patologías no catalogadas en ECICEP' 
          : 'Sin riesgo';
        console.log('  → G0: Puntaje = 0');
      } else if (puntajeTotal === 1) {
        categoriaCalculada = 'G1';
        descripcionCategoria = 'Riesgo BAJO (1 condición)';
        console.log('  → G1: Puntaje = 1');
      } else if (puntajeTotal >= 2 && puntajeTotal <= 4) {
        categoriaCalculada = 'G2';
        descripcionCategoria = 'Riesgo MODERADO (2-4 puntos)';
        console.log(`  → G2: Puntaje entre 2 y 4 (actual: ${puntajeTotal})`);
      } else if (puntajeTotal >= 5) {
        categoriaCalculada = 'G3';
        descripcionCategoria = 'Riesgo ALTO (5+ puntos)';
        console.log(`  → G3: Puntaje >= 5 (actual: ${puntajeTotal})`);
      }
      
      // Regla especial: Si tiene al menos UNA patología crítica (2 pts), mínimo G2
      if (tieneCriticas && categoriaCalculada === 'G1') {
        categoriaCalculada = 'G2';
        descripcionCategoria = 'Riesgo MODERADO (por patología crítica)';
      }
      
      console.log(`[🔎 ECICEP] Categoría calculada: ${categoriaCalculada} - ${descripcionCategoria}`);
      
      // =====================================================================
      // ACTUALIZAR UI CON RESULTADO
      // =====================================================================
      
      // Mostrar en badge "Actual:"
      const badgeActual = document.getElementById('riesgo-actual');
      if (badgeActual) {
        badgeActual.textContent = categoriaCalculada;
        badgeActual.className = 'badge-riesgo';
        
        // Aplicar colores según categoría
        if (categoriaCalculada === 'G3') {
          badgeActual.classList.add('badge-g3');
        } else if (categoriaCalculada === 'G2') {
          badgeActual.classList.add('badge-g2');
        } else if (categoriaCalculada === 'G1') {
          badgeActual.classList.add('badge-g1');
        } else {
          badgeActual.classList.add('badge-neutro');
        }
      }
      
      // Mostrar en badge "Calculado:"
      const badgeCalculado = document.getElementById('riesgo-calculado');
      if (badgeCalculado) {
        badgeCalculado.textContent = categoriaCalculada;
        badgeCalculado.className = 'badge-riesgo';
        
        // Aplicar colores según categoría
        if (categoriaCalculada === 'G3') {
          badgeCalculado.classList.add('badge-g3');
        } else if (categoriaCalculada === 'G2') {
          badgeCalculado.classList.add('badge-g2');
        } else if (categoriaCalculada === 'G1') {
          badgeCalculado.classList.add('badge-g1');
        } else {
          badgeCalculado.classList.add('badge-neutro');
        }
      }
      
      // Actualizar puntos de riesgo
      const puntosRiesgo = document.getElementById('puntos-riesgo');
      if (puntosRiesgo) {
        puntosRiesgo.innerHTML = `<strong>Puntos: ${puntajeTotal.toFixed(1)}</strong> (${patologiasParaCalcular.length} patología${patologiasParaCalcular.length !== 1 ? 's' : ''})`;
      }
      
      // Actualizar detalle de cálculo
      const detalleCalculo = document.getElementById('detalle-calculo');
      if (detalleCalculo) {
        detalleCalculo.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px; color: ${
            categoriaCalculada === 'G3' ? '#b91c1c' : 
            categoriaCalculada === 'G2' ? '#d97706' : 
            categoriaCalculada === 'G1' ? '#15803d' : '#64748b'
          }; font-size: 0.85rem;">
            ${categoriaCalculada}: ${descripcionCategoria}
          </div>
          <div style="font-size: 0.7rem; line-height: 1.5; max-height: 200px; overflow-y: auto;">
            ${detallePatologias.join('<br>')}
          </div>
        `;
      }
      
      // Actualizar badge principal de riesgo en resumen
      if (typeof window.actualizarBadgeRiesgo === 'function') {
        window.actualizarBadgeRiesgo(categoriaCalculada);
        console.log('[🔎 ECICEP] Badge principal actualizado');
      }
      
      // Actualizar input categoria en formulario principal
      const inputCategoria = document.getElementById('categoria');
      if (inputCategoria) {
        inputCategoria.value = categoriaCalculada;
      }
      
      // Actualizar [data-f="categoria_nombre"] en resumen
      const categoriaResumen = document.querySelector('[data-f="categoria_nombre"]');
      if (categoriaResumen) {
        categoriaResumen.textContent = categoriaCalculada;
      }
      
      // Mostrar mensaje de estado
      setEstado(`✅ ${categoriaCalculada}: ${descripcionCategoria} (${puntajeTotal.toFixed(1)} puntos)`, 'info');
      
      // Notificación visual flotante
      const notif = document.createElement('div');
      notif.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 4px;">✅ Cálculo Completado</div>
        <div>${categoriaCalculada}: ${descripcionCategoria}</div>
        <div style="font-size: 0.75rem; opacity: 0.9; margin-top: 4px;">
          ${puntajeTotal.toFixed(1)} puntos · ${patologiasParaCalcular.length} patología${patologiasParaCalcular.length !== 1 ? 's' : ''}
        </div>
      `;
      notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${categoriaCalculada === 'G3' ? '#dc2626' : categoriaCalculada === 'G2' ? '#f59e0b' : '#10b981'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 0.85rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        line-height: 1.4;
        max-width: 300px;
      `;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 4500);
      
      console.log('[🔎 ECICEP] ═══════════════════════════════════════');
      console.log('[🔎 ECICEP] RESULTADO FINAL');
      console.log('[🔎 ECICEP] Categoría:', categoriaCalculada);
      console.log('[🔎 ECICEP] Puntaje:', puntajeTotal);
      console.log('[🔎 ECICEP] Descripción:', descripcionCategoria);
      console.log('[🔎 ECICEP] ═══════════════════════════════════════');
      
    // Guardar automáticamente la categoría calculada en el backend
    persistirCategoriaCalculada(categoriaCalculada, puntajeTotal);
      
      // Retornar resultado del cálculo
      return { categoriaCalculada, puntajeTotal, descripcionCategoria, detallePatologias, patologiasSeleccionadas: patologiasParaCalcular };
  }
  
  // Exponer función globalmente
  window.calcularRiesgoECICEP = calcularRiesgoECICEP;
  
  // Event listener para el botón calcular
  if (btnCalc) {
    btnCalc.addEventListener('click', () => {
      if (seleccion.size === 0) {
        alert('Debe seleccionar al menos una patología para calcular el riesgo');
        return;
      }
      calcularRiesgoECICEP();
    });
  }

  function render(){
    const q = (buscador.value||'').toLowerCase();
    cont.innerHTML='';
    
    // Filtrar patologías
    let filtrados = catalogo.filter(p=> 
      !q || 
      p.nombre.toLowerCase().includes(q) || 
      (p.cie10 && p.cie10.toLowerCase().includes(q))
    );
    
    if(!filtrados.length){ 
      cont.innerHTML = `
        <div style="
          text-align: center; 
          padding: 20px; 
          color: #6b7280; 
          font-style: italic;
          border: 2px dashed #e5e7eb;
          border-radius: 8px;
          background: #f9fafb;
        ">
          ${q ? `No se encontraron patologías que coincidan con "${q}"` : 'Sin patologías disponibles'}
        </div>
      `; 
      return;
    }
    
    // Mostrar contador de resultados si hay filtro
    if (q) {
      const contadorDiv = document.createElement('div');
      contadorDiv.style.cssText = `
        font-size: 0.7rem;
        color: #6b7280;
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 4px;
        margin-bottom: 8px;
        text-align: center;
      `;
      contadorDiv.textContent = `${filtrados.length} patología${filtrados.length !== 1 ? 's' : ''} encontrada${filtrados.length !== 1 ? 's' : ''}`;
      cont.appendChild(contadorDiv);
    }
    
    // Limitar resultados para rendimiento
    const maxResultados = 200;
    const mostrar = filtrados.slice(0, maxResultados);
    
    mostrar.forEach((p, index) => {
      const wrap = document.createElement('label');
      wrap.className = 'pat-row';
      
      const estaSel = seleccion.has(p.id);
      const yaExiste = patologiasCargadasUsuario.has(p.id);
      
      wrap.style.cssText = `
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 2px;
        border: 1px solid ${estaSel ? '#10b981' : yaExiste ? '#0ea5e9' : '#e5e7eb'};
        background: ${estaSel ? 'rgba(16, 185, 129, 0.1)' : yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff'};
        transition: all 0.2s ease;
        font-size: 0.75rem;
      `;
      
      // Resaltar términos de búsqueda
      let nombreDisplay = p.nombre;
      let cie10Display = p.cie10 || '';
      
      if (q) {
        const regex = new RegExp(`(${q})`, 'gi');
        nombreDisplay = nombreDisplay.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px; border-radius: 2px;">$1</mark>');
        cie10Display = cie10Display.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px; border-radius: 2px;">$1</mark>');
      }
      
      wrap.innerHTML = `
        <input type="checkbox" data-id="${p.id}" style="margin: 0; transform: scale(1.1);">
        <div style="flex: 1; line-height: 1.3;">
          <div style="color: #1f2937; font-weight: 500;">
            ${nombreDisplay}
          </div>
          ${cie10Display ? `<div style="color: #6b7280; font-size: 0.65rem; margin-top: 2px;">
            <strong>CIE-10:</strong> ${cie10Display}
          </div>` : ''}
        </div>
        ${yaExiste ? '<span style="background: #0ea5e9; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px;">YA TIENE</span>' : ''}
      `;
      
      const cb = wrap.querySelector('input');
      cb.checked = estaSel;
      
      // Eventos
      wrap.addEventListener('mouseover', () => {
        if (!estaSel) {
          wrap.style.background = '#f9fafb';
          wrap.style.borderColor = '#d1d5db';
        }
      });
      
      wrap.addEventListener('mouseout', () => {
        wrap.style.background = estaSel ? 'rgba(16, 185, 129, 0.1)' : yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff';
        wrap.style.borderColor = estaSel ? '#10b981' : yaExiste ? '#0ea5e9' : '#e5e7eb';
      });
      
      cb.addEventListener('change', () => {
        if(cb.checked) {
          seleccion.add(p.id);
          console.log(`✅ [CHECKBOX] Patología agregada: ${p.cie10} - ${p.nombre}`);
          
          // Actualizar estilo visual del wrapper SIN redibujar todo
          wrap.style.borderColor = '#10b981';
          wrap.style.background = 'rgba(16, 185, 129, 0.1)';
        } else {
          seleccion.delete(p.id);
          console.log(`➖ [CHECKBOX] Patología removida: ${p.cie10} - ${p.nombre}`);
          
          // Restaurar estilo visual del wrapper SIN redibujar todo
          const yaExiste = patologiasCargadasUsuario.has(p.id);
          wrap.style.borderColor = yaExiste ? '#0ea5e9' : '#e5e7eb';
          wrap.style.background = yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff';
        }
        
        actualizarBotones();
        actualizarPatologiasSeleccionadas();
        // ❌ NO LLAMAR render() aquí - causa que se redibujen TODOS los checkboxes
        
        // Recalcular riesgo automáticamente cuando cambia la selección
        // Solo si ya hay un usuario cargado
        const runInput = document.getElementById('run');
        if (runInput && runInput.value) {
          setTimeout(() => {
            console.log('🔧 [CHECKBOX] Recalculando riesgo automáticamente...');
            if (typeof window.calcularRiesgoECICEP === 'function') {
              const resultado = window.calcularRiesgoECICEP();
              console.log('✅ [CHECKBOX] Cálculo completado:', resultado);
            } else {
              console.warn('⚠️ [CHECKBOX] Función calcularRiesgoECICEP no disponible');
            }
          }, 300);
        }
      });
      
      wrap.addEventListener('click', (e) => {
        if (e.target !== cb) {
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        }
      });
      
      cont.appendChild(wrap);
    });
    
    // Mostrar mensaje si hay más resultados
    if (filtrados.length > maxResultados) {
      const masResultados = document.createElement('div');
      masResultados.style.cssText = `
        text-align: center;
        padding: 8px;
        color: #f59e0b;
        font-size: 0.7rem;
        background: #fffbeb;
        border-radius: 4px;
        margin-top: 4px;
      `;
      masResultados.textContent = `⚠️ Mostrando ${maxResultados} de ${filtrados.length} resultados. Refine su búsqueda para ver más.`;
      cont.appendChild(masResultados);
    }
    
    actualizarBotones();
  }
  
  // Nueva función para actualizar el panel de patologías seleccionadas
  function actualizarPatologiasSeleccionadas() {
    const panel = document.getElementById('patologias-seleccionadas');
    if (!panel) return;
    
    if (seleccion.size === 0) {
      panel.innerHTML = '<div style="opacity:.6;text-align:center;padding:10px;">Ninguna patología seleccionada</div>';
      // Actualizar estado visual del resumen
      actualizarEstadoPatologiasResumen();
      return;
    }
    
    const seleccionadas = Array.from(seleccion).map(id => 
      catalogo.find(p => p.id === id)
    ).filter(Boolean);
    
    panel.innerHTML = seleccionadas.map(p => `
      <div style="
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 4px;
        padding: 4px 8px;
        margin: 2px 0;
        font-size: 0.65rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <span><strong>${p.cie10}</strong> - ${p.nombre}</span>
        <button onclick="eliminarYRecalcular(${p.id}, this.parentElement);" 
                style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:0.8rem;">×</button>
      </div>
    `).join('');
    
    // Actualizar estado visual del resumen
    actualizarEstadoPatologiasResumen();
  }
  
  // Nueva función para eliminar patología y recalcular riesgo automáticamente
  function eliminarYRecalcular(patologiaId, elemento) {
    console.log('🗑️ [ELIMINAR-PAT] Eliminando patología ID:', patologiaId);
    
    // Eliminar del DOM
    if (elemento) {
      elemento.remove();
    }
    
    // Eliminar de la selección
    seleccion.delete(patologiaId);
    
    // Desmarcar el checkbox correspondiente en el checklist
    const contenedorPats = document.getElementById('contenedor-patologias');
    if (contenedorPats) {
      const checkbox = contenedorPats.querySelector(`input[type="checkbox"][data-id="${patologiaId}"]`);
      if (checkbox) {
        checkbox.checked = false;
        
        // Actualizar estilo visual del wrapper
        const wrapper = checkbox.closest('.pat-row');
        if (wrapper) {
          const yaExiste = patologiasCargadasUsuario.has(patologiaId);
          wrapper.style.borderColor = yaExiste ? '#0ea5e9' : '#e5e7eb';
          wrapper.style.background = yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff';
        }
      }
    }
    
    // Actualizar botones y UI
    actualizarBotones();
    actualizarPatologiasSeleccionadas();
    // ❌ NO LLAMAR render() aquí - causa que se redibujen TODOS los checkboxes
    
    // Recalcular riesgo automáticamente después de eliminar
    setTimeout(() => {
      console.log('🔧 [ELIMINAR-PAT] Recalculando riesgo después de eliminar patología...');
      if (typeof window.calcularRiesgoECICEP === 'function') {
        const resultado = window.calcularRiesgoECICEP();
        console.log('✅ [ELIMINAR-PAT] Cálculo completado:', resultado);
      } else {
        console.warn('⚠️ [ELIMINAR-PAT] Función calcularRiesgoECICEP no disponible');
      }
    }, 300);
  }
  
  // Nueva función para sincronizar estado visual entre resumen y checklist
  function actualizarEstadoPatologiasResumen() {
    const listaResumen = document.getElementById('lista-patologias');
    if (!listaResumen) return;
    
    const items = listaResumen.querySelectorAll('li');
    items.forEach(li => {
      const texto = li.textContent;
      // Extraer código CIE10 del texto (formato: "E11.9 - Diabetes mellitus")
      const match = texto.match(/^([A-Z]\d+(\.\d+)?)\s*-/i);
      if (!match) return;
      
      const codigoResumen = match[1].toUpperCase();
      
      // Verificar si esta patología está marcada en el checklist
      let estaMarcada = false;
      const contenedorPats = document.getElementById('contenedor-patologias');
      if (contenedorPats) {
        const checkboxes = contenedorPats.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
          const label = cb.closest('label');
          if (!label) return;
          
          const cie10Div = label.querySelector('div div[style*="font-size: 0.65rem"]');
          if (cie10Div) {
            const textoCompleto = cie10Div.textContent;
            const matchCb = textoCompleto.match(/CIE-10:\s*([A-Z]\d+(\.\d+)?)/i);
            if (matchCb) {
              const codigoCb = matchCb[1].toUpperCase();
              if (codigoCb === codigoResumen || codigoCb.startsWith(codigoResumen) || codigoResumen.startsWith(codigoCb)) {
                estaMarcada = true;
              }
            }
          }
        });
      }
      
      // Aplicar estilo visual según estado
      if (estaMarcada) {
        li.style.fontWeight = 'bold';
        li.style.textDecoration = 'underline';
        li.title = '✓ Marcada en cálculo de riesgo - Click para desmarcar';
      } else {
        li.style.fontWeight = 'normal';
        li.style.textDecoration = 'none';
        li.title = 'Click para marcar en cálculo de riesgo';
      }
    });
  }
  btnGuardarPats.addEventListener('click', async ()=>{
    const runVal = document.getElementById('run').value;
    if(!runVal || !seleccion.size){ return; }
    
    setEstado('Agregando patologías...'); 
    btnGuardarPats.disabled = true;
    
    // Convertir IDs de patologías a códigos CIE10
    const cie10Codes = Array.from(seleccion).map(id => {
      const pat = catalogo.find(p => p.id === id);
      return pat ? pat.cie10 : null;
    }).filter(Boolean);
    
    if (cie10Codes.length === 0) {
      setEstado('No se encontraron códigos CIE10 válidos', 'error');
      btnGuardarPats.disabled = false;
      return;
    }
    
    let intentos = 0;
    const maxIntentos = 3;
    
    while (intentos < maxIntentos) {
      try {
        const r = await authFetch(`/api/agregar_patologias/${runVal}`, {
          method: 'POST',
          body: JSON.stringify({cie10_codes: cie10Codes})
        });
        
        if (r.status === 404) {
          setEstado('Usuario no encontrado', 'error');
          break;
        }
        
        if (r.status === 429) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Rate limit - Reintentando (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 2000 * intentos));
            continue;
          } else {
            setEstado('Servidor ocupado - Intente más tarde', 'error');
            break;
          }
        }
        
        if (r.status >= 500) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Error servidor - Reintentando (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
            continue;
          } else {
            setEstado('Error del servidor - Intente más tarde', 'error');
            break;
          }
        }
        
        const d = await r.json();
        if (d.success) { 
          setEstado('✅ Patologías agregadas exitosamente'); 
          patologiasCargadasUsuario = new Set(seleccion); 
          
          // NO limpiar selección - mantener marcadas para calcular riesgo
          // seleccion.clear(); 
          
          // Recargar TODAS las patologías del usuario desde el servidor
          console.log('🔄 [Patologías] Recargando todas las patologías del usuario...');
          
          try {
            const respPats = await authFetch(`/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`);
            if (respPats.ok) {
              const dataPats = await respPats.json();
              if (dataPats.ok && dataPats.patologias) {
                console.log(`✅ [Patologías] ${dataPats.patologias.length} patologías cargadas del usuario`);
                
                // Marcar todas las patologías del usuario en el checklist
                seleccion.clear(); // Primero limpiar
                dataPats.patologias.forEach(p => {
                  // Buscar la patología en el catálogo por CIE10 o nombre
                  const patEnCatalogo = catalogo.find(pc => 
                    pc.cie10 === p.cie10 || 
                    pc.id === p.patologia_id ||
                    pc.nombre.toLowerCase() === p.nombre.toLowerCase()
                  );
                  
                  if (patEnCatalogo) {
                    seleccion.add(patEnCatalogo.id);
                    console.log(`✅ Marcada: ${p.cie10} - ${p.nombre}`);
                  }
                });
                
                console.log(`✅ [Patologías] ${seleccion.size} patologías marcadas en checklist`);
                patologiasCargadasUsuario = new Set(seleccion);
                
                // ✅ ACTUALIZAR PATOLOGÍAS PARA CÁLCULO DE RIESGO
                window._patologiasUsuarioBD = dataPats.patologias || [];
                console.log(`✅ [Patologías] window._patologiasUsuarioBD actualizado con ${window._patologiasUsuarioBD.length} patologías`);
              }
            }
          } catch (e) {
            console.warn('Error recargando patologías del usuario:', e);
          }
          
          render(); 
          actualizarBotones();
          
          // Recargar datos del usuario para actualizar pestañas condicionales
          try {
            const respUser = await authFetch(`/api/tarjeton/${runVal}`);
            if (respUser.ok) {
              const userData = await authFetch.json();
              if (userData && userData.ok) {
                // Actualizar pestaña diabetes basada en nuevas patologías
                mostrarOcultarDiabetes(userData.patologias_resumen);
                // Actualizar sección IECA/ARA II basada en nuevas patologías
                mostrarOcultarIecaAra(userData.patologias_resumen);
                // Actualizar sección Estatinas basada en nuevas patologías
                mostrarOcultarEstatinas(userData.patologias_resumen);
                // Actualizar sección Antiagregantes basada en nuevas patologías
                mostrarOcultarAntiagregantes(userData.patologias_resumen);
                console.log('🔧 [DEBUG] Pestañas y secciones actualizadas después de guardar patologías');
              }
            }
          } catch (e) {
            console.log('🔧 [DEBUG] Error actualizando pestañas después de guardar patologías:', e);
          }
          
          // Mensaje informativo
          const mensajeDiv = document.createElement('div');
          mensajeDiv.textContent = `✅ Patologías guardadas. Total: ${seleccion.size} patologías marcadas. Calculando riesgo...`;
          mensajeDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#10b981;color:white;padding:12px 24px;border-radius:8px;z-index:10000;font-size:0.85rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
          document.body.appendChild(mensajeDiv);
          setTimeout(() => mensajeDiv.remove(), 3500);
          
          // Calcular riesgo automáticamente después de guardar patologías
          setTimeout(() => {
            console.log('🔧 [GUARDAR-PATS] Activando cálculo automático de riesgo...');
            if (typeof window.calcularRiesgoECICEP === 'function') {
              const resultado = window.calcularRiesgoECICEP();
              console.log('✅ [GUARDAR-PATS] Cálculo completado:', resultado);
            } else {
              console.warn('⚠️ [GUARDAR-PATS] Función calcularRiesgoECICEP no disponible');
            }
          }, 1500);
          
        } else {
          setEstado('Error agregando patologías: ' + (d.error || 'Error desconocido'), 'error');
        }
        break; // Salir del bucle si llegamos aquí
        
      } catch (e) { 
        intentos++;
        if (intentos < maxIntentos) {
          setEstado(`Error conexión - Reintentando (${intentos}/${maxIntentos})...`);
          await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
        } else {
          setEstado('Error de conexión - Verifique su red', 'error');
        }
      }
    }
    
    btnGuardarPats.disabled = false;
  });
  btnSelectFiltradas.addEventListener('click', ()=>{
    const q = (buscador.value||'').toLowerCase();
    catalogo.forEach(p=>{
      if(!q || p.nombre.toLowerCase().includes(q) || p.cie10.toLowerCase().includes(q)){
        seleccion.add(p.id);
      }
    });
    render();
  });
  btnClearSel.addEventListener('click', ()=>{
    seleccion.clear();
    usuarioLimpioSeleccion = true; // El usuario limpió intencionalmente
    console.log('🧹 Usuario limpió selección - próximo guardado será en modo REEMPLAZAR');
    render();
  });
  
  // Mejorar botón "Aplicar al Usuario"
  if (btnAplicar) {
    btnAplicar.addEventListener('click', async () => {
      const runInput = document.getElementById('run');
      const runVal = runInput ? runInput.value.trim() : '';
      
      if (!runVal) {
        setEstado('Error: RUN requerido para aplicar patologías', 'error');
        return;
      }
      
      if (seleccion.size === 0) {
        setEstado('Error: Seleccione al menos una patología', 'error');
        return;
      }
      
      // Confirmar aplicación
      const patologiasTexto = Array.from(seleccion).map(id => {
        const pat = catalogo.find(p => p.id === id);
        return pat ? `${pat.cie10} - ${pat.nombre}` : `ID: ${id}`;
      }).join('\n');
      
      const confirmar = confirm(`¿Confirma aplicar las siguientes patologías al usuario ${runVal}?\n\n${patologiasTexto}`);
      if (!confirmar) return;
      
      setEstado('Aplicando patologías al usuario...'); 
      btnAplicar.disabled = true;
      
      let intentos = 0;
      const maxIntentos = 3;
      
      while (intentos < maxIntentos) {
        try {
          // Determinar el modo basado en si el usuario limpió intencionalmente
          const modo = usuarioLimpioSeleccion ? 'reemplazar' : 'agregar';
          console.log(`💾 Guardando patologías en modo: ${modo.toUpperCase()}`);
          
          const r = await authFetch('/api/tarjeton/patologias', {
            method: 'POST',
            body: JSON.stringify({
              run: runVal, 
              patologia_ids: [...seleccion],
              modo: modo
            })
          });
          
          if (r.status === 404) {
            setEstado(`Error: Usuario ${runVal} no encontrado`, 'error');
            break;
          }
          
          if (r.status === 429) {
            intentos++;
            if (intentos < maxIntentos) {
              setEstado(`Rate limit - Reintentando aplicación (${intentos}/${maxIntentos})...`);
              await new Promise(resolve => setTimeout(resolve, 2000 * intentos));
              continue;
            } else {
              setEstado('Servidor ocupado - Intente aplicar más tarde', 'error');
              break;
            }
          }
          
          if (r.status >= 500) {
            intentos++;
            if (intentos < maxIntentos) {
              setEstado(`Error servidor - Reintentando aplicación (${intentos}/${maxIntentos})...`);
              await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
              continue;
            } else {
              setEstado('Error del servidor - Intente aplicar más tarde', 'error');
              break;
            }
          }
          
          const d = await r.json();
          
          if (d.ok) {
            setEstado(`✅ Patologías aplicadas exitosamente (${d.total || seleccion.size}) - Modo: ${d.modo || 'desconocido'}`);
            patologiasCargadasUsuario = new Set(seleccion);
            
            // Resetear la bandera después de un guardado exitoso
            usuarioLimpioSeleccion = false;
            
            // Actualizar interfaz
            render();
            actualizarPatologiasSeleccionadas();
            
            // Recargar datos del usuario si es posible
            if (typeof sincronizarPatologiasUsuario === 'function') {
              setTimeout(() => sincronizarPatologiasUsuario(runVal), 1000);
            }
          } else {
            setEstado(`Error aplicando patologías: ${d.error || 'Error desconocido'}`, 'error');
          }
          break; // Salir del bucle si llegamos aquí
          
        } catch (error) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Error conexión - Reintentando aplicación (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
          } else {
            console.error('Error aplicando patologías:', error);
            setEstado('Error de conexión - Verifique su red', 'error');
          }
        }
      }
      
      btnAplicar.disabled = false;
    });
  }
  // Mejorar buscador con sugerencias
  buscador.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    // Render normal
    render();
    
    // Agregar sugerencias rápidas si el query es corto
    if (query.length >= 2 && query.length <= 4) {
      const sugerencias = catalogo
        .filter(p => p.cie10 && p.cie10.toLowerCase().startsWith(query))
        .slice(0, 5);
        
      if (sugerencias.length > 0) {
        const estadoPats = document.getElementById('estado-patologias');
        if (estadoPats) {
          const sugerenciasTexto = sugerencias.map(p => `${p.cie10}: ${p.nombre.substring(0, 30)}...`).join(' | ');
          estadoPats.innerHTML = `💡 Sugerencias: <span style="font-size:0.65rem;">${sugerenciasTexto}</span>`;
          estadoPats.style.color = '#6b7280';
        }
      }
    }
  });
  
  // Agregar sugerencias rápidas comunes
  const sugerenciasComunes = [
    { texto: 'HTA', query: 'I10' },
    { texto: 'DM2', query: 'E11' },
    { texto: 'Dislipidemia', query: 'E78' },
    { texto: 'ERC', query: 'N18' },
    { texto: 'Cardiopatía', query: 'I25' }
  ];
  
  // Crear botones de sugerencias
  const sugerenciasDiv = document.createElement('div');
  sugerenciasDiv.style.cssText = 'display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap;';
  sugerenciasDiv.innerHTML = sugerenciasComunes.map(s => 
    `<button onclick="document.getElementById('buscador-patologia').value='${s.query}'; document.getElementById('buscador-patologia').dispatchEvent(new Event('input'));" 
     style="font-size:0.65rem; padding:2px 6px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:3px; cursor:pointer; color:#374151;">
     ${s.texto}
     </button>`
  ).join('');
  
  buscador.parentNode.insertBefore(sugerenciasDiv, buscador.nextSibling);
  
  async function cargarCatalogo(){
    setEstado('Cargando catálogo de patologías...');
    
    try{
      // Intentar múltiples endpoints para cargar patologías
      const endpoints = ['/api/patologias_catalogo', '/api/patologias', '/api/cie10'];
      let r, d;
      
      for (const endpoint of endpoints) {
        try {
          r = await authFetch(endpoint);
          if (r.ok) {
            d = await r.json();
            if (d.ok && (d.patologias || d.data)) {
              catalogo = d.patologias || d.data || [];
              console.log(`[🔎 ECICEP] Catálogo cargado desde ${endpoint}: ${catalogo.length} patologías`);
              break;
            }
          }
        } catch (endpointError) {
          console.log(`[🔎 ECICEP] Error en endpoint ${endpoint}:`, endpointError);
          continue;
        }
      }
      
      // Si no se pudo cargar desde ningún endpoint, usar catálogo extendido offline
      if (!catalogo || catalogo.length === 0) {
        console.log('[🔎 ECICEP] Usando catálogo offline extendido');
        catalogo = [
          {id: 1, cie10: 'I10', nombre: 'Hipertensión arterial esencial'},
          {id: 2, cie10: 'E11', nombre: 'Diabetes mellitus tipo 2'},
          {id: 3, cie10: 'E78', nombre: 'Trastorno del metabolismo de las lipoproteínas'},
          {id: 4, cie10: 'N18', nombre: 'Enfermedad renal crónica'},
          {id: 5, cie10: 'I25', nombre: 'Enfermedad isquémica crónica del corazón'},
          {id: 6, cie10: 'E10', nombre: 'Diabetes mellitus tipo 1'},
          {id: 7, cie10: 'I50', nombre: 'Insuficiencia cardíaca'},
          {id: 8, cie10: 'J44', nombre: 'Enfermedad pulmonar obstructiva crónica'},
          {id: 9, cie10: 'M79', nombre: 'Trastornos de los tejidos blandos'},
          {id: 10, cie10: 'F32', nombre: 'Episodio depresivo'},
          {id: 11, cie10: 'I11', nombre: 'Enfermedad cardíaca hipertensiva'},
          {id: 12, cie10: 'I12', nombre: 'Enfermedad renal hipertensiva'},
          {id: 13, cie10: 'G93', nombre: 'Otros trastornos del encéfalo'},
          {id: 14, cie10: 'K29', nombre: 'Gastritis y duodenitis'},
          {id: 15, cie10: 'M17', nombre: 'Gonartrosis'},
        ];
        setEstado(`Catálogo offline cargado (${catalogo.length} patologías principales)`);
      } else {
        setEstado(`Catálogo online cargado (${catalogo.length} patologías)`);
      }
      
      // Actualizar referencia global al catálogo
      window._riesgoCatalogo = catalogo;
      
      render();
      
    } catch(e) {
      console.error('[🔎 ECICEP] Error crítico cargando catálogo:', e);
      setEstado('Error cargando patologías - usando modo básico', 'error');
      catalogo = [
        {id: 1, cie10: 'I10', nombre: 'Hipertensión arterial esencial'},
        {id: 2, cie10: 'E11', nombre: 'Diabetes mellitus tipo 2'},
        {id: 3, cie10: 'E78', nombre: 'Dislipidemia'}
      ];
      render();
    }
  }
  
  await cargarCatalogo();
  
  async function sincronizarUsuario(runVal){
    if(!runVal) return;
    try{
      const r = await authFetch(`/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`);
      if(!r.ok) return;
      const d = await r.json();
      if(d.ok && d.patologias){
        patologiasCargadasUsuario = new Set(d.patologias.map(p => p.id));
        render();
      }
    }catch(e){
      console.warn('Error sincronizarUsuario:', e);
    }
  }
  
  // Sincronizar cuando pierde foco RUN
  document.getElementById('run').addEventListener('blur',()=> sincronizarUsuario(document.getElementById('run').value));
  
  // Asignar función global después de la definición
  if (typeof eliminarYRecalcular === 'function') {
    window.eliminarYRecalcular = eliminarYRecalcular;
  }
})();

// Función global para sincronizar patologías del usuario (llamada desde recargaTodo)
async function sincronizarPatologiasUsuario(runVal) {
  if (!runVal) return 0;

  const ahora = Date.now();
  if (window.__sincronizarPatologiasBloqueadoHasta && ahora < window.__sincronizarPatologiasBloqueadoHasta) {
    console.warn('[🔎 Patologías] Rate limit activo, omitiendo sincronización');
    alert('⚠️ Demasiadas solicitudes. Espere un momento e intente nuevamente.');
    window.__sincronizarPatologiasUltimo = { run: runVal, timestamp: ahora, result: 0 };
    return 0;
  }

  if (window.__sincronizarPatologiasEnCurso) {
    console.warn('[🔎 Patologías] Sincronización ya en curso, evitando llamada duplicada');
    window.__sincronizarPatologiasUltimo = { run: runVal, timestamp: ahora, result: 0 };
    return 0;
  }

  const ultimoSync = window.__sincronizarPatologiasUltimo;
  if (ultimoSync && ultimoSync.run === runVal && (ahora - ultimoSync.timestamp) < 1200) {
    return ultimoSync.result ?? 0;
  }

  window.__sincronizarPatologiasEnCurso = true;
  const registrarResultado = (valor) => {
    window.__sincronizarPatologiasUltimo = { run: runVal, timestamp: Date.now(), result: valor };
    return valor;
  };

  console.log('[🔎 Patologías] Sincronizando patologías para usuario:', runVal);
  
  try {
    // Intentar múltiples endpoints para cargar patologías del usuario
    const endpoints = [
      `/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`,
      `/api/usuarios/${encodeURIComponent(runVal)}/patologias`,
      `/api/patologias/usuario/${encodeURIComponent(runVal)}`
    ];
    
    let patologiasUsuario = [];
    
    for (const endpoint of endpoints) {
      try {
        const r = await authFetch(endpoint);

        if (r.status === 429) {
          const retryAfterHeader = r.headers.get('Retry-After');
          const retrySeconds = retryAfterHeader ? parseInt(retryAfterHeader, 10) : NaN;
          const esperaMs = Number.isFinite(retrySeconds) ? retrySeconds * 1000 : 5000;
          window.__sincronizarPatologiasBloqueadoHasta = Date.now() + esperaMs;
          console.warn(`[🔎 Patologías] API respondió 429 en ${endpoint}. Bloqueando solicitudes por ${esperaMs}ms`);
          alert('⚠️ Demasiadas solicitudes. Espere un momento e intente nuevamente.');
          return registrarResultado(0);
        }

        if (r.ok) {
          const d = await r.json();
          if (d.ok && (d.patologias || d.data)) {
            patologiasUsuario = d.patologias || d.data || [];
            console.log(`[🔎 Patologías] Patologías del usuario cargadas desde ${endpoint}: ${patologiasUsuario.length}`);
            break;
          }
        } else {
          console.warn(`[🔎 Patologías] Endpoint ${endpoint} respondió ${r.status}`);
        }
      } catch (endpointError) {
        console.log(`[🔎 Patologías] Error en endpoint ${endpoint}:`, endpointError);
      }
      await new Promise(resolve => setTimeout(resolve, 150));
    }
    
    // ✅ GUARDAR PATOLOGÍAS DEL USUARIO PARA CÁLCULO DE RIESGO
    // Estas son las patologías reales guardadas en la BD, no checkboxes temporales
    window._patologiasUsuarioBD = patologiasUsuario;
    console.log('[🔎 Patologías] Patologías guardadas en window._patologiasUsuarioBD:', patologiasUsuario.length);
    
    // Actualizar el sistema de patologías si existe
    const cont = document.getElementById('contenedor-patologias');
    if (cont && patologiasUsuario.length > 0) {
      console.log('[🔎 Patologías] Marcando patologías del usuario en checklist...');
      console.log('[🔎 Patologías] Patologías del usuario:', patologiasUsuario);
      
      // Acceder al catálogo global o al local del módulo
      const catalogoDisponible = window._riesgoCatalogo || [];
      console.log('[🔎 Patologías] Catálogo disponible:', catalogoDisponible.length, 'patologías');
      
      // Limpiar selección actual
      if (window._riesgoSeleccion instanceof Set) {
        window._riesgoSeleccion.clear();
        console.log('[🔎 Patologías] Selección limpiada');
      }
      
      // Marcar patologías del usuario
      const checkboxes = cont.querySelectorAll('input[type="checkbox"]');
      console.log('[🔎 Patologías] Total checkboxes encontrados:', checkboxes.length);
      
      let patologiasMarcadas = 0;
      
      checkboxes.forEach(checkbox => {
        const patId = parseInt(checkbox.dataset.id);
        
        // Buscar la patología en el catálogo
        const patCatalogo = catalogoDisponible.find(pc => pc.id === patId);
        
        if (!patCatalogo) {
          return; // Si no está en el catálogo, continuar
        }
        
        // Verificar si el usuario tiene esta patología
        const tienePatologia = patologiasUsuario.some(p => {
          // Buscar por ID de patología
          if (p.id === patId || p.patologia_id === patId) {
            console.log(`✅ Match por ID: ${patId}`);
            return true;
          }
          
          // Buscar por código CIE10
          if (p.cie10 && patCatalogo.cie10) {
            const cie10Usuario = p.cie10.toUpperCase().replace(/\./g, ''); // Quitar puntos
            const cie10Catalogo = patCatalogo.cie10.toUpperCase().replace(/\./g, '');
            
            // ✅ MATCH EXACTO únicamente
            // No usar startsWith para evitar falsos positivos (M15 != M16)
            if (cie10Usuario === cie10Catalogo) {
              console.log(`✅ Match exacto CIE10: ${p.cie10} = ${patCatalogo.cie10}`);
              return true;
            }
            
            // ✅ MATCH POR PREFIJO: Solo si el código del usuario es más específico
            // Ej: Usuario tiene "E119" (Diabetes tipo 2 con complicación no especificada)
            //     Catálogo tiene "E11" (Diabetes tipo 2)
            // E119.startsWith(E11) = true ✅
            // Pero NO: M16.startsWith(M15) = false ✅
            if (cie10Usuario.length > cie10Catalogo.length && 
                cie10Usuario.startsWith(cie10Catalogo)) {
              console.log(`✅ Match por prefijo CIE10: ${p.cie10} comienza con ${patCatalogo.cie10}`);
              return true;
            }
          }
          
          // Buscar por nombre (normalizado)
          if (p.nombre && patCatalogo.nombre) {
            const nombreUsuario = p.nombre.toLowerCase().trim();
            const nombreCatalogo = patCatalogo.nombre.toLowerCase().trim();
            
            if (nombreUsuario === nombreCatalogo || 
                nombreUsuario.includes(nombreCatalogo) ||
                nombreCatalogo.includes(nombreUsuario)) {
              console.log(`✅ Match por nombre: ${p.nombre} ≈ ${patCatalogo.nombre}`);
              return true;
            }
          }
          
          return false;
        });
        
        if (tienePatologia) {
          // MARCAR EL CHECKBOX
          checkbox.checked = true;
          
          // Agregar al Set de selección
          if (window._riesgoSeleccion instanceof Set) {
            window._riesgoSeleccion.add(patId);
          }
          
          patologiasMarcadas++;
          console.log(`✅ [Patologías] Marcada checkbox ID=${patId}: ${patCatalogo.cie10} - ${patCatalogo.nombre}`);
          
          // Actualizar estilo visual del wrapper
          const wrapper = checkbox.closest('.pat-row');
          if (wrapper) {
            wrapper.style.borderColor = '#10b981';
            wrapper.style.background = 'rgba(16, 185, 129, 0.1)';
            
            // Agregar indicador visual "YA TIENE"
            if (!wrapper.querySelector('.ya-tiene-indicator')) {
              const indicator = document.createElement('span');
              indicator.className = 'ya-tiene-indicator';
              indicator.style.cssText = 'background: #0ea5e9; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; margin-left: auto;';
              indicator.textContent = 'YA TIENE';
              wrapper.appendChild(indicator);
            }
          }
        }
      });
      
      console.log(`✅ [Patologías] ${patologiasMarcadas} de ${patologiasUsuario.length} patologías marcadas en checklist`);
      console.log(`✅ [Patologías] Set de selección tiene ${window._riesgoSeleccion?.size || 0} elementos`);
      
      // Forzar actualización del render si existe la función
      if (typeof window._riesgoRender === 'function') {
        console.log('[🔎 Patologías] Forzando re-render...');
        window._riesgoRender();
      }
      
      // Actualizar estado
      const estadoPats = document.getElementById('estado-patologias');
      if (estadoPats) {
        estadoPats.textContent = `✅ ${patologiasMarcadas} patología${patologiasMarcadas !== 1 ? 's' : ''} del usuario marcada${patologiasMarcadas !== 1 ? 's' : ''} para cálculo`;
        estadoPats.style.color = '#059669';
      }
      
      // Resetear bandera al cargar patologías del usuario
      usuarioLimpioSeleccion = false;
      
      // ✅ CALCULAR RIESGO ECICEP AUTOMÁTICAMENTE DESPUÉS DE CARGAR PATOLOGÍAS
      if (typeof window.calcularRiesgoECICEP === 'function') {
        console.log('[🔎 Patologías] Calculando riesgo ECICEP automáticamente...');
        setTimeout(() => {
          const resultado = window.calcularRiesgoECICEP();
          console.log('[🔎 Patologías] Riesgo calculado:', resultado);
        }, 500); // Esperar 500ms para asegurar que todo esté cargado
      }
      
      window.__sincronizarPatologiasBloqueadoHasta = undefined;
      return registrarResultado(patologiasMarcadas); // Retornar cantidad de patologías marcadas
    }
    
    console.warn('[⚠️ Patologías] No se encontró contenedor o no hay patologías del usuario');
    
    // ✅ CALCULAR RIESGO INCLUSO SIN PATOLOGÍAS (G0)
    if (typeof window.calcularRiesgoECICEP === 'function') {
      setTimeout(() => {
        window.calcularRiesgoECICEP();
      }, 500);
    }
    
    window.__sincronizarPatologiasBloqueadoHasta = undefined;
    return registrarResultado(0);
    
  } catch (error) {
    console.warn('[🔎 Patologías] Error sincronizando patologías del usuario:', error);
    
    const estadoPats = document.getElementById('estado-patologias');
    if (estadoPats) {
      estadoPats.textContent = '⚠️ No se pudieron cargar las patologías del usuario';
      estadoPats.style.color = '#f59e0b';
    }
    window.__sincronizarPatologiasBloqueadoHasta = undefined;
    return registrarResultado(0);
  } finally {
    window.__sincronizarPatologiasEnCurso = false;
  }
}

// Deduplicar por seguridad: dejar un solo #identificacion-section
(function dedupIdent() {
  const ids = document.querySelectorAll('#identificacion-section');
  if (ids.length > 1) {
    ids.forEach((el, i) => { if (i > 0) el.parentNode.removeChild(el); });
    console.warn('[Tarjetón] Secciones de Identificación duplicadas: normalizadas a 1.');
  }
})();

// === SISTEMA DE MONITOREO DE CONECTIVIDAD ===
(function initConnectivityMonitor() {
  let ultimoEstadoConectividad = 'desconocido';
  let contadorErrores = 0;
  let ultimaPruebaExitosa = Date.now();
  
  // Función para mostrar indicador de conectividad
  function actualizarIndicadorConectividad(estado, detalles = '') {
    const indicadores = [
      document.getElementById('estado-patologias'),
      document.querySelector('.estado-run'),
      document.querySelector('.lblEstado')
    ].filter(Boolean);
    
    if (estado !== ultimoEstadoConectividad) {
      console.log(`[🌐 Conectividad] Cambio de estado: ${ultimoEstadoConectividad} → ${estado}`, detalles);
      ultimoEstadoConectividad = estado;
    }
    
    indicadores.forEach(el => {
      if (!el) return;
      
      let icono = '🌐';
      let color = '#6b7280';
      let mensaje = '';
      
      switch (estado) {
        case 'online':
          icono = '🟢';
          color = '#059669';
          mensaje = detalles || 'Conectado';
          contadorErrores = 0;
          ultimaPruebaExitosa = Date.now();
          break;
        case 'error-temporal':
          icono = '🟡';
          color = '#f59e0b';
          mensaje = detalles || 'Conexión intermitente';
          contadorErrores++;
          break;
        case 'error-servidor':
          icono = '🔴';
          color = '#dc2626';
          mensaje = detalles || 'Error del servidor';
          contadorErrores++;
          break;
        case 'offline':
          icono = '⚫';
          color = '#6b7280';
          mensaje = detalles || 'Sin conexión';
          contadorErrores++;
          break;
      }
      
      // Agregar indicador si no existe
      let indicador = el.querySelector('.conectividad-indicator');
      if (!indicador) {
        indicador = document.createElement('span');
        indicador.className = 'conectividad-indicator';
        indicador.style.cssText = 'margin-left: 8px; font-size: 0.7rem; font-weight: normal;';
        el.appendChild(indicador);
      }
      
      indicador.textContent = `${icono} ${mensaje}`;
      indicador.style.color = color;
      
      // Agregar tiempo desde última conexión exitosa si hay problemas
      if (estado !== 'online' && ultimaPruebaExitosa) {
        const tiempoDesconectado = Math.floor((Date.now() - ultimaPruebaExitosa) / 1000);
        if (tiempoDesconectado > 30) {
          indicador.textContent += ` (${tiempoDesconectado}s)`;
        }
      }
    });
  }
  
  // Interceptar fetch para monitorear conectividad
  const originalAuthFetch = window.authFetch;
  if (originalAuthFetch) {
    window.authFetch = async function(...args) {
      try {
        const response = await originalAuthFetch(...args);
        
        if (response.ok) {
          actualizarIndicadorConectividad('online', 'API disponible');
        } else if (response.status === 429) {
          actualizarIndicadorConectividad('error-temporal', 'Rate limit');
        } else if (response.status >= 500) {
          actualizarIndicadorConectividad('error-servidor', `Error ${response.status}`);
        } else if (response.status === 404) {
          // 404 no es necesariamente un problema de conectividad
          actualizarIndicadorConectividad('online', 'API disponible');
        }
        
        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          actualizarIndicadorConectividad('error-temporal', 'Timeout');
        } else if (error.message.includes('fetch')) {
          actualizarIndicadorConectividad('offline', 'Sin conexión');
        } else {
          actualizarIndicadorConectividad('error-temporal', 'Error de red');
        }
        throw error;
      }
    };
  }
  
  // Prueba periódica de conectividad (cada 30 segundos si hay errores)
  setInterval(async () => {
    if (contadorErrores > 0 || (Date.now() - ultimaPruebaExitosa) > 60000) {
      try {
        const response = await fetch('/api/health', { 
          method: 'HEAD',
          signal: AbortSignal.timeout(5000)
        });
        
        if (response.ok) {
          actualizarIndicadorConectividad('online', 'Conexión restaurada');
        }
      } catch (error) {
        // Mantener el estado actual, no cambiar por la prueba fallida
        if (ultimoEstadoConectividad === 'online') {
          actualizarIndicadorConectividad('error-temporal', 'Verificando conexión...');
        }
      }
    }
  }, 30000);
  
  // Estado inicial
  actualizarIndicadorConectividad('online', 'Iniciando...');
})();

// === SISTEMA DE CÁLCULO DINÁMICO DE RIESGO ECICEP ===

// === FUNCIONES USO DE INSULINA ===
async function guardarInsulina() {
    try {
        const enTratamiento = document.querySelector('input[name="enTratamientoInsulina"]:checked');
        const fechaInsulina = document.getElementById('fechaInsulina');
        if (!enTratamiento) {
            alert('Por favor seleccione si está en tratamiento con insulina');
            return;
        }
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        const enTratamientoBool = enTratamiento.value === 'si';
        const data = {
            run: runField.value.trim(),
            en_tratamiento: enTratamientoBool,
            fecha_evaluacion: fechaInsulina.value || new Date().toISOString().split('T')[0]
        };
        console.log('[💉 Insulina] Guardando:', data);
        const response = await fetch('/api/insulina-historial', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok && result.ok) {
            alert('Registro de insulina guardado exitosamente');
            cargarHistorialInsulina(runField.value.trim());
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('[💉 Insulina] Error guardando:', error);
        alert('Error al guardar el registro de insulina: ' + error.message);
    }
}

function limpiarFormularioInsulina() {
    const form = document.getElementById('insulinaForm');
    if (form) form.reset();
    const fechaInsulina = document.getElementById('fechaInsulina');
    if (fechaInsulina) fechaInsulina.value = new Date().toISOString().split('T')[0];
    console.log('[💉 Insulina] Formulario limpiado');
}

async function cargarHistorialInsulina(run) {
    try {
        if (!run) return;
        const response = await authFetch(`/api/insulina-historial/${run}?limit=10`);
        const result = await response.json();
        const historialDiv = document.getElementById('historialInsulina');
        const listaDiv = document.getElementById('listHistorialInsulina');
        if (!historialDiv || !listaDiv) return;
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            const historialHTML = result.historial.map(item => {
                const fecha = new Date(item.fecha_evaluacion).toLocaleDateString('es-CL');
                const estadoColor = item.en_tratamiento ? '#2563eb' : '#16a34a';
                const estadoBg = item.en_tratamiento ? '#dbeafe' : '#dcfce7';
                const estadoTexto = item.en_tratamiento ? 'EN TRATAMIENTO' : 'SIN INSULINA';
                return `<div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <div style="flex:1;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                            <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">${estadoTexto}</span>
                        </div>
                    </div>
                    <div style="font-size:0.65rem;color:#9ca3af;">${item.funcionario || 'Sistema'}</div>
                </div>`;
            }).join('');
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de insulina</div>';
        }
    } catch (error) {
        console.error('[💉 Insulina] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialInsulina');
        if (historialDiv) historialDiv.style.display = 'none';
    }
}

async function cargarUltimaInsulina(run) {
    try {
        if (!run) return;
        const response = await authFetch(`/api/insulina-historial/${run}/ultima`);
        const result = await response.json();
        if (response.ok && result.ok && result.registro) {
            const registro = result.registro;
            const insulinaSi = document.querySelector('input[name="enTratamientoInsulina"][value="si"]');
            const insulinaNo = document.querySelector('input[name="enTratamientoInsulina"][value="no"]');
            const fechaInsulina = document.getElementById('fechaInsulina');
            if (registro.en_tratamiento) {
                if (insulinaSi) insulinaSi.checked = true;
            } else {
                if (insulinaNo) insulinaNo.checked = true;
            }
            if (fechaInsulina) fechaInsulina.value = registro.fecha_evaluacion || new Date().toISOString().split('T')[0];
        }
        await cargarHistorialInsulina(run);
    } catch (error) {
        console.error('[💉 Insulina] Error cargando última evaluación:', error);
    }
}

// === FUNCIONES ATENCIÓN PODÓLOGA ===

// Función para guardar atención podológica
async function guardarPodologia() {
    try {
        // Obtener los valores del formulario
        const atencionPodologa = document.querySelector('input[name="atencionPodologa"]:checked');
        const fechaPodologia = document.getElementById('fechaPodologia');
        
        // Validar campos requeridos
        if (!atencionPodologa) {
            alert('Por favor seleccione si tiene atención podológica vigente');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        const atencionVigenteBool = atencionPodologa.value === 'si';
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            atencion_vigente: atencionVigenteBool,
            fecha: fechaPodologia.value || new Date().toISOString().split('T')[0]
        };
        
        console.log('[🦶 Podología] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/podologia-historial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Atención podológica guardada exitosamente');
            // Recargar historial
            cargarHistorialPodologia(runField.value.trim());
            console.log('[🦶 Podología] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[🦶 Podología] Error guardando:', error);
        alert('Error al guardar la atención podológica: ' + error.message);
    }
}

// Función para guardar hipoglicemia
async function guardarHipoglicemias() {
    try {
        // Obtener los valores del formulario
        const hipoglicemiaSi = document.querySelector('input[name="hipoglicemiasRecurrentes"][value="si"]');
        const hipoglicemiaNo = document.querySelector('input[name="hipoglicemiasRecurrentes"][value="no"]');
        const fechaHipoglicemia = document.getElementById('fechaHipoglicemias');
        const recurrenteCheckbox = document.querySelector('input[name="hipoglicemiasRecurrentes"]:checked');
        
        // Validar que se haya seleccionado una opción
        const tieneHipoglicemia = hipoglicemiaSi && hipoglicemiaSi.checked;
        const noTieneHipoglicemia = hipoglicemiaNo && hipoglicemiaNo.checked;
        
        if (!tieneHipoglicemia && !noTieneHipoglicemia) {
            alert('Por favor seleccione si tiene hipoglicemias o no');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        // Solo guardar si tiene hipoglicemias
        if (!tieneHipoglicemia) {
            alert('No se guardará registro ya que no tiene hipoglicemias');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            fecha: fechaHipoglicemia ? fechaHipoglicemia.value : new Date().toISOString().split('T')[0],
            recurrente: recurrenteCheckbox ? recurrenteCheckbox.checked : false
        };
        
        console.log('[🩸 Hipoglicemias] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/hipoglicemias-historial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Hipoglicemia guardada exitosamente');
            // Recargar historial
            cargarHistorialHipoglicemias(runField.value.trim());
            console.log('[🩸 Hipoglicemias] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[🩸 Hipoglicemias] Error guardando:', error);
        alert('Error al guardar la hipoglicemia: ' + error.message);
    }
}

// Función para guardar amputación
async function guardarAmputacion() {
    try {
        // Obtener los valores del formulario
        const amputacionSi = document.querySelector('input[name="tieneAmputacion"][value="si"]');
        const amputacionNo = document.querySelector('input[name="tieneAmputacion"][value="no"]');
        const fechaAmputacion = document.getElementById('fechaAmputacion');
        const tipoAmputacion = document.getElementById('tipoAmputacion');
        
        // Validar que se haya seleccionado una opción
        const tieneAmputacion = amputacionSi && amputacionSi.checked;
        const noTieneAmputacion = amputacionNo && amputacionNo.checked;
        
        if (!tieneAmputacion && !noTieneAmputacion) {
            alert('Por favor seleccione si tiene amputación o no');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        // Solo guardar si tiene amputación
        if (!tieneAmputacion) {
            alert('No se guardará registro ya que no tiene amputación');
            return;
        }
        
        // Validar fecha si tiene amputación
        if (!fechaAmputacion || !fechaAmputacion.value) {
            alert('Debe ingresar la fecha de la amputación');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            fecha_amputacion: fechaAmputacion.value,
            tipo_amputacion: tipoAmputacion ? tipoAmputacion.value : '',
            amputacion: true
        };
        
        console.log('[🦵 Amputación] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/examenes-piedm/amputacion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Amputación guardada exitosamente');
            // Recargar historial
            cargarHistorialAmputacion(runField.value.trim());
            console.log('[🦵 Amputación] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[🦵 Amputación] Error guardando:', error);
        alert('Error al guardar la amputación: ' + error.message);
    }
}

// Función para limpiar formulario de podología
function limpiarFormularioPodologia() {
    const form = document.getElementById('podologiaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaPodologia = document.getElementById('fechaPodologia');
    if (fechaPodologia) {
        fechaPodologia.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[🦶 Podología] Formulario limpiado');
}

// Función para limpiar formulario de hipoglicemias
function limpiarFormularioHipoglicemias() {
    const form = document.getElementById('hipoglicemiasForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaHipoglicemias = document.getElementById('fechaHipoglicemias');
    if (fechaHipoglicemias) {
        fechaHipoglicemias.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[🩸 Hipoglicemias] Formulario limpiado');
}

// Función para limpiar formulario de amputación
function limpiarFormularioAmputacion() {
    const form = document.getElementById('amputacionForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaAmputacion = document.getElementById('fechaAmputacion');
    if (fechaAmputacion) {
        fechaAmputacion.value = '';
    }
    
    console.log('[🦵 Amputación] Formulario limpiado');
}

// ======= FUNCIONES EVALUACIÓN ADULTO MAYOR =======

// Función para calcular clasificación TUG automáticamente
function calcularClasificacionTUG() {
    const tugSegundos = document.getElementById('tugSegundos');
    const tugClasificacion = document.getElementById('tugClasificacion');
    
    if (tugSegundos && tugClasificacion && tugSegundos.value) {
        const segundos = parseFloat(tugSegundos.value);
        let clasificacion = '';
        
        if (segundos <= 10) {
            clasificacion = 'Bajo riesgo de caídas';
        } else if (segundos >= 11 && segundos <= 19) {
            clasificacion = 'Riesgo leve/intermedio';
        } else if (segundos >= 20) {
            clasificacion = 'Alto riesgo de caídas';
        }
        
        tugClasificacion.value = clasificacion;
    }
}

// Función para calcular clasificación Unipodal automáticamente
function calcularClasificacionUnipodal() {
    const pieDerecho = document.getElementById('unipodalPieDerecho');
    const pieIzquierdo = document.getElementById('unipodalPieIzquierdo');
    const clasificacion = document.getElementById('unipodalClasificacion');
    
    if (pieDerecho && pieIzquierdo && clasificacion) {
        const derecho = parseFloat(pieDerecho.value) || 0;
        const izquierdo = parseFloat(pieIzquierdo.value) || 0;
        
        // Usar el menor tiempo como referencia
        const menorTiempo = Math.min(derecho, izquierdo);
        let resultado = '';
        
        if (menorTiempo < 5) {
            resultado = 'Alto riesgo de caídas';
        } else if (menorTiempo >= 5 && menorTiempo <= 30) {
            resultado = 'Riesgo intermedio';
        } else if (menorTiempo > 30) {
            resultado = 'Bajo riesgo de caídas';
        }
        
        clasificacion.value = resultado;
    }
}

// Función para guardar evaluación de adulto mayor
async function guardarEvaluacionAdultoMayor() {
  try {
    // Obtener valores del formulario
    const fechaEvaluacion = document.getElementById('fechaEvaluacionAM');
    const funcionalidad = document.getElementById('funcionalidadAM');
    const tugSegundos = document.getElementById('tugSegundos');
    const tugClasificacion = document.getElementById('tugClasificacion');
    const unipodalDerecho = document.getElementById('unipodalPieDerecho');
    const unipodalIzquierdo = document.getElementById('unipodalPieIzquierdo');
    const unipodalClasificacion = document.getElementById('unipodalClasificacion');
    const observaciones = document.getElementById('observacionesAM');

    // Validaciones
    if (!fechaEvaluacion || !fechaEvaluacion.value) {
      alert('Debe ingresar la fecha de evaluación');
      return;
    }

    if (!funcionalidad || !funcionalidad.value) {
      alert('Debe seleccionar el nivel de funcionalidad');
      return;
    }

    // Obtener el RUN actual
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN válido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inválido, verifique el dígito verificador');
      return;
    }

    const resultadoMap = {
      autovalente: 'Autovalente',
      autovalente_con_riesgo: 'Autovalente con Riesgo',
      riesgo_dependencia: 'Riesgo de Dependencia',
      dependencia_leve: 'Dependencia Leve',
      dependencia_moderada: 'Dependencia Moderada',
      dependencia_total: 'Dependencia Total'
    };

    const resultadoClave = funcionalidad.value;
    const resultadoNormalizado = resultadoMap[resultadoClave] || resultadoClave;

    // Preparar datos
    const data = {
      run: runNormalizado,
      usuario_id: runNormalizado,
      fecha_aplicacion: fechaEvaluacion.value,
      resultado: resultadoNormalizado,
      tug_seg: tugSegundos && tugSegundos.value ? parseFloat(tugSegundos.value) : null,
      tug_clasificacion: tugClasificacion ? tugClasificacion.value : null,
      unipodal_seg_pie_der: unipodalDerecho && unipodalDerecho.value ? parseFloat(unipodalDerecho.value) : null,
      unipodal_seg_pie_izq: unipodalIzquierdo && unipodalIzquierdo.value ? parseFloat(unipodalIzquierdo.value) : null,
      unipodal_clasificacion: unipodalClasificacion ? unipodalClasificacion.value : null,
      observaciones: observaciones ? observaciones.value : null
    };

    console.log('[👴 Adulto Mayor] Guardando evaluación:', data);

    // Enviar al servidor
    const response = await authFetch('/api/examenes/adulto_mayor', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    const result = await response.json();

    if (response.ok && result.ok) {
      alert('Evaluación de adulto mayor guardada exitosamente');
      // Recargar historial
      window._runActivo = runNormalizado;
      cargarHistorialAdultoMayor(runNormalizado);
      console.log('[👴 Adulto Mayor] Guardado exitoso:', result);
    } else {
      throw new Error(result.error || 'Error desconocido');
    }
  } catch (error) {
    console.error('[👴 Adulto Mayor] Error guardando:', error);
    alert('Error al guardar la evaluación: ' + error.message);
  }
}

// Función para limpiar formulario de adulto mayor
function limpiarFormularioAdultoMayor() {
    const form = document.getElementById('adultoMayorForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaEvaluacion = document.getElementById('fechaEvaluacionAM');
    if (fechaEvaluacion) {
        fechaEvaluacion.value = new Date().toISOString().split('T')[0];
    }
    
    // Limpiar campos calculados
    const tugClasificacion = document.getElementById('tugClasificacion');
    const unipodalClasificacion = document.getElementById('unipodalClasificacion');
    
    if (tugClasificacion) tugClasificacion.value = '';
    if (unipodalClasificacion) unipodalClasificacion.value = '';
    
    console.log('[👴 Adulto Mayor] Formulario limpiado');
}

// Función para cargar historial de evaluaciones de adulto mayor
async function cargarHistorialAdultoMayor(run) {
    try {
        if (!run) return;
        
        console.log('[👴 Adulto Mayor] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialAdultoMayor');
        const listaDiv = document.getElementById('listHistorialAdultoMayor');
        
        if (!historialDiv || !listaDiv) {
            console.error('[👴 Adulto Mayor] No se encontraron elementos del historial');
            return;
        }
        
        const response = await authFetch(`/api/examenes/adulto_mayor/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[👴 Adulto Mayor] Respuesta del historial:', result);
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(evaluacion => {
                    let fecha = 'Sin fecha';
                    if (evaluacion.fecha_aplicacion) {
                        fecha = new Date(evaluacion.fecha_aplicacion).toLocaleDateString('es-CL');
                    }
                    
                    // Mapear resultado a texto legible
                    const resultadosMap = {
                        'autovalente': 'Autovalente',
                        'autovalente_con_riesgo': 'Autovalente con Riesgo',
                        'riesgo_dependencia': 'Riesgo de Dependencia',
                        'dependencia_leve': 'Dependencia Leve',
                        'dependencia_moderada': 'Dependencia Moderada',
                        'dependencia_total': 'Dependencia Total'
                    };
                    
                    const resultado = resultadosMap[evaluacion.resultado] || evaluacion.resultado;
                    
                    // Color según nivel de funcionalidad
                    let estadoColor = '#16a34a';
                    let estadoBg = '#dcfce7';
                    
                    if (evaluacion.resultado.includes('dependencia')) {
                        estadoColor = '#dc2626';
                        estadoBg = '#fecaca';
                    } else if (evaluacion.resultado.includes('riesgo')) {
                        estadoColor = '#f59e0b';
                        estadoBg = '#fef3c7';
                    }
                    
                    return `<div style="padding:12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            ${evaluacion.tug_seg ? `<div style="font-size:0.7rem;color:#6b7280;">TUG: ${evaluacion.tug_seg}s</div>` : ''}
                        </div>
                        <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${resultado}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay evaluaciones registradas</div>';
            }
        } else {
            console.error('[👴 Adulto Mayor] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[👴 Adulto Mayor] Error cargando historial:', error);
    }
}

// Función para cargar historial de atención podológica
async function cargarHistorialPodologia(run) {
    try {
        if (!run) return;
        
        console.log('[🦶 Podología] Cargando historial para:', run);
        
        const response = await authFetch(`/api/diabetes/podologia/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialPodologia');
        const listaDiv = document.getElementById('listHistorialPodologia');
        
        if (!historialDiv || !listaDiv) {
            console.error('[🦶 Podología] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[🦶 Podología] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(atencion => {
                const fecha = new Date(atencion.fecha).toLocaleDateString('es-CL');
                const estadoColor = atencion.atencion_vigente ? '#059669' : '#6b7280';
                const estadoBg = atencion.atencion_vigente ? '#d1fae5' : '#f3f4f6';
                const estadoTexto = atencion.atencion_vigente ? 'ATENCIÓN VIGENTE' : 'SIN ATENCIÓN';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${atencion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[🦶 Podología] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de atención podológica</div>';
            console.log('[🦶 Podología] Sin historial para este usuario');
        }
    } catch (error) {
        console.error('[🦶 Podología] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialPodologia');
        if (historialDiv) {
            historialDiv.style.display = 'none';
        }
    }
}

// Función para cargar última atención podológica
async function cargarUltimaPodologia(run) {
    try {
        if (!run) return;
        
        console.log('[🦶 Podología] Cargando última atención para:', run);
        
        const response = await authFetch(`/api/podologia-historial/${run}/ultima`);
        const result = await response.json();
        
        if (response.ok && result.ok && result.atencion) {
            const atencion = result.atencion;
            
            // Cargar valores en el formulario
            const podologiaSi = document.querySelector('input[name="atencionPodologa"][value="si"]');
            const podologiaNo = document.querySelector('input[name="atencionPodologa"][value="no"]');
            const fechaPodologia = document.getElementById('fechaPodologia');
            
            if (atencion.atencion_vigente) {
                if (podologiaSi) podologiaSi.checked = true;
            } else {
                if (podologiaNo) podologiaNo.checked = true;
            }
            
            if (fechaPodologia) {
                fechaPodologia.value = atencion.fecha || new Date().toISOString().split('T')[0];
            }
            
            console.log('[🦶 Podología] Última atención cargada:', atencion);
        } else {
            console.log('[🦶 Podología] No hay atenciones previas para este usuario');
        }
        
        // Cargar historial
        await cargarHistorialPodologia(run);
        
    } catch (error) {
        console.error('[🦶 Podología] Error cargando última atención:', error);
    }
}

// === FUNCIONES FONDO DE OJOS ===

// Función para guardar fondo de ojos
async function guardarFondoOjos() {
    try {
        // Obtener los valores del formulario
        const fondoOjos = document.querySelector('input[name="fondoOjos"]:checked');
        const fechaFondoOjos = document.getElementById('fechaFondoOjos');
        
        // Validar campos requeridos
        if (!fondoOjos) {
            alert('Por favor seleccione si se realizó fondo de ojos');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        const fondoOjosBool = fondoOjos.value === 'si';
        
        // Si se realizó, la fecha es obligatoria
        if (fondoOjosBool && (!fechaFondoOjos.value || fechaFondoOjos.value.trim() === '')) {
            alert('Por favor ingrese la fecha del fondo de ojos');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            fondo_de_ojos: fondoOjosBool,
            fondo_de_ojos_fecha: fondoOjosBool ? fechaFondoOjos.value : null,
            examen_fecha: new Date().toISOString().split('T')[0]
        };
        
        console.log('[👁️ Fondo de Ojos] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/examenes/fondo-ojos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Fondo de ojos guardado exitosamente');
            // Recargar historial
            cargarHistorialFondoOjos(runField.value.trim());
            console.log('[👁️ Fondo de Ojos] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[👁️ Fondo de Ojos] Error guardando:', error);
        alert('Error al guardar el fondo de ojos: ' + error.message);
    }
}

// Función para limpiar formulario de fondo de ojos
function limpiarFormularioFondoOjos() {
    const form = document.getElementById('fondoOjosForm');
    if (form) {
        form.reset();
    }
    
    // Limpiar fecha
    const fechaFondoOjos = document.getElementById('fechaFondoOjos');
    if (fechaFondoOjos) {
        fechaFondoOjos.value = '';
    }
    
    console.log('[👁️ Fondo de Ojos] Formulario limpiado');
}

// Función para cargar historial de fondo de ojos
async function cargarHistorialFondoOjos(run) {
    try {
        if (!run) return;
        
        console.log('[👁️ Fondo de Ojos] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialFondoOjos');
        const listaDiv = document.getElementById('listHistorialFondoOjos');
        
        if (!historialDiv || !listaDiv) {
            console.error('[👁️ Fondo de Ojos] No se encontraron elementos del historial');
            return;
        }
        
        const response = await authFetch(`/api/examenes/fondo_ojos/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[👁️ Fondo de Ojos] Respuesta del historial:', result);
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(item => {
                    let fecha = 'Sin fecha';
                    if (item.fecha) {
                        fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                    }
                    
                    if (fecha === 'Invalid Date') {
                        fecha = 'Sin fecha';
                    }
                    
                    // Usar el campo 'resultado' que viene del backend
                    const resultado = item.resultado || 'SIN RESULTADO';
                    const estadoColor = resultado.toLowerCase().includes('realizado') || resultado.toLowerCase().includes('normal') ? '#059669' : '#dc2626';
                    const estadoBg = resultado.toLowerCase().includes('realizado') || resultado.toLowerCase().includes('normal') ? '#d1fae5' : '#fef2f2';
                    const estadoTexto = resultado.toUpperCase();
                    
                    return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                        <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de fondo de ojos</div>';
            }
        } else {
            console.error('[👁️ Fondo de Ojos] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    } catch (error) {
        console.log('[👁️ Fondo de Ojos] Historial no disponible');
        const historialDiv = document.getElementById('historialFondoOjos');
        if (historialDiv) {
            historialDiv.style.display = 'none';
        }
    }
}

// === Helpers para cargarUltimoFondoOjos ===
function _bySel(sel) { return document.querySelector(sel); }
function _byId(id) { return document.getElementById(id); }
function _setCheckedIf(el) { if (el) el.checked = true; }
function _setValueIf(el, v) { if (el && v != null) el.value = v; }

function _markRadioFondoSi() { _setCheckedIf(_bySel('input[name="fondoOjos"][value="SI"]')); }
function _markRadioFondoNo() { _setCheckedIf(_bySel('input[name="fondoOjos"][value="NO"]')); }

// Función para cargar último fondo de ojos
async function cargarUltimoFondoOjos(run) {
    try {
        if (!run) return;
        
        console.log('[👁️ Fondo de Ojos] Cargando último examen para:', run);
        
        const response = await authFetch(`/api/examenes/fondo_ojos/${encodeURIComponent(run)}`);
        
        if (!response.ok) {
            console.log('[👁️ Fondo de Ojos] No hay datos disponibles (status:', response.status + ')');
            return;
        }
        
        const result = await response.json();
        
        if (response.ok && result.ok && result.data) {
            const data = result.data;
            const fechaFondoOjos = _byId('fechaFondoOjos');
            
            if (data.fondo_de_ojos === "SI") {
                _markRadioFondoSi();
                if (data.fecha) _setValueIf(fechaFondoOjos, data.fecha);
            } else if (data.fondo_de_ojos === "NO") {
                _markRadioFondoNo();
                if (data.fecha) _setValueIf(fechaFondoOjos, data.fecha);
            }
            
            console.log('[👁️ Fondo de Ojos] Último examen cargado:', data);
        } else {
            console.log('[👁️ Fondo de Ojos] No hay exámenes previos para este usuario');
        }
        
        // Cargar historial
        await cargarHistorialFondoOjos(run);
        
    } catch (error) {
        console.log('[👁️ Fondo de Ojos] Función ejecutada (sin datos disponibles)');
    }
}

// Función para cargar historial de curaciones
async function cargarHistorialCuraciones(run) {
    try {
        if (!run) return;
        
        console.log('[🩹 Curaciones] Cargando historial para:', run);
        
        const response = await authFetch(`/api/examenes/curaciones_piedm/historial/${encodeURIComponent(run)}`);
        
        const historialDiv = document.getElementById('historialCuraciones');
        const listaDiv = document.getElementById('listHistorialCuraciones');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok) {
            const result = await response.json();
            console.log('[🩹 Curaciones] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(curacion => {
                    const fecha = new Date(curacion.fecha).toLocaleDateString('es-CL');
                    const estadoColor = curacion.en_curacion ? '#059669' : '#dc2626';
                    const estadoBg = curacion.en_curacion ? '#d1fae5' : '#fef2f2';
                    const estadoTexto = curacion.en_curacion ? 'EN CURACIÓN' : 'SIN CURACIÓN';
                    
                    return `<div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                            <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                ${estadoTexto}
                            </span>
                        </div>
                        ${curacion.tipo ? `<div style="font-size:0.7rem;color:#6b7280;">Tipo: ${curacion.tipo}</div>` : ''}
                        ${curacion.funcionario ? `<div style="font-size:0.65rem;color:#9ca3af;margin-top:4px;">Por: ${curacion.funcionario}</div>` : ''}
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de curaciones</div>';
            }
        } else {
            console.error('[🩹 Curaciones] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    } catch (error) {
        console.error('[🩹 Curaciones] Error cargando historial:', error);
    }
}

// Función para cargar historial de EKG
async function cargarHistorialEkg(run) {
    try {
        if (!run) return;
        
        console.log('[⚡ EKG] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialEkg');
        const listaDiv = document.getElementById('listHistorialEkg');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/ekg/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[⚡ EKG] Respuesta del historial:', result);
            
            if (result.success && result.found && result.data) {
                historialDiv.style.display = 'block';
                
                const ekg = result.data;
                let fecha = 'Sin fecha';
                if (ekg.fecha_ekg) {
                    fecha = new Date(ekg.fecha_ekg).toLocaleDateString('es-CL');
                } else if (ekg.fecha) {
                    fecha = new Date(ekg.fecha).toLocaleDateString('es-CL');
                }
                
                if (fecha === 'Invalid Date') {
                    fecha = 'Sin fecha';
                }
                
                const historialHTML = `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                    <span style="background:#e0f2fe;color:#0284c7;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">EKG</span>
                </div>`;
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de EKG</div>';
            }
        } else {
            console.error('[⚡ EKG] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial EKG</div>';
        }
        
    } catch (error) {
        console.error('[⚡ EKG] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialEkg');
        const listaDiv = document.getElementById('listHistorialEkg');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    }
}

// Función para cargar historial de hipoglicemias
async function cargarHistorialHipoglicemias(run) {
    try {
        if (!run) return;
        
        console.log('[🩸 Hipoglicemias] Cargando historial para:', run);
        
        const response = await authFetch(`/api/diabetes/hipoglicemias/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialHipoglicemias');
        const listaDiv = document.getElementById('listHistorialHipoglicemias');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(hipoglicemia => {
                const fecha = new Date(hipoglicemia.fecha).toLocaleDateString('es-CL');
                const estadoColor = hipoglicemia.recurrente ? '#dc2626' : '#059669';
                const estadoBg = hipoglicemia.recurrente ? '#fef2f2' : '#d1fae5';
                const estadoTexto = hipoglicemia.recurrente ? 'PRESENTA' : 'NO PRESENTA';
                
                return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                    <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                </div>`;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de hipoglicemias</div>';
        }
    } catch (error) {
        console.error('[🩸 Hipoglicemias] Error cargando historial:', error);
    }
}

// Función para cargar historial de amputación
async function cargarHistorialAmputacion(run) {
    try {
        if (!run) return;
        
        console.log('[🦿 Amputación] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialAmputacion');
        const listaDiv = document.getElementById('listHistorialAmputacion');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/pie_dm/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[🦿 Amputación] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                // Filtrar solo registros con amputación
                const amputaciones = result.data.filter(item => item.amputacion === true);
                
                if (amputaciones.length > 0) {
                    historialDiv.style.display = 'block';
                    
                    const historialHTML = amputaciones.map(item => {
                        let fecha = 'Sin fecha';
                        if (item.fecha_amputacion) {
                            fecha = new Date(item.fecha_amputacion).toLocaleDateString('es-CL');
                        } else if (item.fecha_realizacion) {
                            fecha = new Date(item.fecha_realizacion).toLocaleDateString('es-CL');
                        } else if (item.fecha) {
                            fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                        }
                        
                        if (fecha === 'Invalid Date') {
                            fecha = 'Sin fecha';
                        }
                        
                        const estadoColor = '#dc2626';
                        const estadoBg = '#fef2f2';
                        const estadoTexto = 'AMPUTACIÓN';
                        
                        return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                        </div>`;
                    }).join('');
                    
                    listaDiv.innerHTML = historialHTML;
                } else {
                    historialDiv.style.display = 'block';
                    listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de amputación</div>';
                }
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de amputación</div>';
            }
        } else {
            console.error('[🦿 Amputación] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
        
    } catch (error) {
        console.error('[🦿 Amputación] Error cargando historial:', error);
    }
}

// Función para cargar historial de pie diabético
async function cargarHistorialPieDiabetico(run) {
    try {
        if (!run) return;
        
        console.log('[🦶 Pie Diabético] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialPieDiabetico');
        const listaDiv = document.getElementById('listHistorialPieDiabetico');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/pie_dm/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[🦶 Pie Diabético] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(item => {
                    // Manejar múltiples formatos de fecha
                    let fecha = 'Sin fecha';
                    if (item.fecha_realizacion) {
                        fecha = new Date(item.fecha_realizacion).toLocaleDateString('es-CL');
                    } else if (item.fecha) {
                        fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                    }
                    
                    // Si la fecha es inválida, usar la fecha actual como fallback
                    if (fecha === 'Invalid Date') {
                        fecha = 'Sin fecha';
                    }
                    
                    const riesgoColor = item.riesgo_nivel === 'Alto' ? '#dc2626' : item.riesgo_nivel === 'Medio' ? '#f59e0b' : '#16a34a';
                    const riesgoBg = item.riesgo_nivel === 'Alto' ? '#fecaca' : item.riesgo_nivel === 'Medio' ? '#fef3c7' : '#dcfce7';
                    const riesgo = item.riesgo_nivel || item.riesgo || 'N/A';
                    
                    return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                        <span style="background:${riesgoBg};color:${riesgoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${riesgo}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay evaluaciones de pie diabético registradas</div>';
            }
        } else {
            console.error('[🦶 Pie Diabético] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
        
    } catch (error) {
        console.error('[🦶 Pie Diabético] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialPieDiabetico');
        const listaDiv = document.getElementById('listHistorialPieDiabetico');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    }
}

// ================= FUNCIONES DE FÁRMACOS =================

// Función para guardar IECA/ARA II
async function guardarIecaAra() {
  try {
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN válido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inválido, verifique el dígito verificador');
      return;
    }

    const tipoIecaAraRaw = document.getElementById('tipoIecaAra').value;
    const fechaIecaAra = document.getElementById('fechaIecaAra').value;

    if (!tipoIecaAraRaw || !fechaIecaAra) {
      alert('Debe completar todos los campos');
      return;
    }

    const tipoNormalizado = tipoIecaAraRaw.trim().toUpperCase();
    if (tipoNormalizado === 'NO') {
      alert('Para registrar ausencia de IECA/ARA II deja el campo sin selección o elimina el registro previo.');
      return;
    }
    if (!tipoNormalizado) {
      alert('Seleccione un tipo válido de IECA/ARA II');
      return;
    }

    const payload = {
      run: runNormalizado,
      fecha: fechaIecaAra,
      tipo: tipoNormalizado,
      tipo_medicacion: tipoNormalizado
    };

    console.log('[💊 IECA/ARA II] Guardando:', payload);

    const response = await authFetch('/api/medicacion/ieca_ara', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (response.ok && (result.success || result.ok)) {
      console.log('[💊 IECA/ARA II] Guardado exitosamente');
      alert('IECA/ARA II guardado exitosamente');
      limpiarFormularioIecaAra();
      window._runActivo = runNormalizado;
      await cargarHistorialIecaAra(runNormalizado);
    } else {
      console.error('[💊 IECA/ARA II] Error al guardar:', result.error);
      const mensaje = result.error || result.message || 'Error desconocido';
      alert('Error al guardar: ' + mensaje);
    }
  } catch (error) {
    console.error('[💊 IECA/ARA II] Error:', error);
    alert('Error de conexión');
  }
}

// Función para limpiar formulario IECA/ARA II
function limpiarFormularioIecaAra() {
    document.getElementById('tipoIecaAra').value = '';
    document.getElementById('fechaIecaAra').value = '';
    console.log('[💊 IECA/ARA II] Formulario limpiado');
}

// Función para cargar historial IECA/ARA II
async function cargarHistorialIecaAra(run) {
    try {
        if (!run) return;
        
        console.log('[💊 IECA/ARA II] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/ieca_ara/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
    const historial = Array.isArray(result.historial)
      ? result.historial
      : Array.isArray(result.data)
        ? result.data
        : [];
        
        const historialDiv = document.getElementById('historialIecaAra');
        const listaDiv = document.getElementById('listHistorialIecaAra');
        
        if (!historialDiv || !listaDiv) return;
        
    if (response.ok && (result.success || result.ok) && historial.length > 0) {
            historialDiv.style.display = 'block';
            
      const historialHTML = historial.map(medicacion => {
        const fecha = medicacion.fecha ? new Date(medicacion.fecha).toLocaleDateString('es-CL') : 'Sin fecha';
        const tipoRaw = (medicacion.tipo_medicacion ?? medicacion.tipo ?? '').toString().toUpperCase();
        const enTratamiento = tipoRaw === 'IECA' || tipoRaw === 'ARA II';
        const estadoColor = enTratamiento ? '#059669' : '#dc2626';
        const estadoBg = enTratamiento ? '#d1fae5' : '#fef2f2';
        const estadoTexto = enTratamiento ? tipoRaw : 'NO REGISTRA';
        const funcionario = medicacion.funcionario || medicacion.creado_por || 'Sistema';

        return `
          <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                  ${estadoTexto}
                </span>
              </div>
            </div>
            <div style="font-size:0.65rem;color:#9ca3af;">
              ${funcionario}
            </div>
          </div>
        `;
      }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de IECA/ARA II</div>';
        }
    } catch (error) {
        console.error('[💊 IECA/ARA II] Error cargando historial:', error);
    }
}

// Función para guardar estatinas
async function guardarEstatinas() {
  try {
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN válido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inválido, verifique el dígito verificador');
      return;
    }

    const recibeEstatinas = document.querySelector('input[name="recibeEstatinas"]:checked')?.value;
    const fechaEstatinas = document.getElementById('fechaEstatinas').value;

    if (!recibeEstatinas || !fechaEstatinas) {
      alert('Debe completar todos los campos');
      return;
    }

    const payload = {
      run: runNormalizado,
      en_tratamiento: recibeEstatinas === 'si',
      fecha: fechaEstatinas
    };

    console.log('[💊 Estatinas] Guardando:', payload);

    const response = await authFetch('/api/medicacion/estatinas', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (response.ok && result.ok) {
      console.log('[💊 Estatinas] Guardado exitosamente');
      alert('Estatinas guardado exitosamente');
      limpiarFormularioEstatinas();
      window._runActivo = runNormalizado;
      await cargarHistorialEstatinas(runNormalizado);
    } else {
      console.error('[💊 Estatinas] Error al guardar:', result.error);
      alert('Error al guardar: ' + (result.error || 'Error desconocido'));
    }
  } catch (error) {
    console.error('[💊 Estatinas] Error:', error);
    alert('Error de conexión');
  }
}

// Función para limpiar formulario estatinas
function limpiarFormularioEstatinas() {
    document.querySelectorAll('input[name="recibeEstatinas"]').forEach(radio => radio.checked = false);
    document.getElementById('fechaEstatinas').value = '';
    console.log('[💊 Estatinas] Formulario limpiado');
}

// Función para cargar historial estatinas
async function cargarHistorialEstatinas(run) {
    try {
        if (!run) return;
        
        console.log('[💊 Estatinas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/estatinas/${run}?limit=10`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialEstatinas');
        const listaDiv = document.getElementById('listHistorialEstatinas');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(medicacion => {
                const fecha = new Date(medicacion.fecha).toLocaleDateString('es-CL');
                const estadoColor = medicacion.en_tratamiento ? '#059669' : '#dc2626';
                const estadoBg = medicacion.en_tratamiento ? '#d1fae5' : '#fef2f2';
                const estadoTexto = medicacion.en_tratamiento ? 'SÍ RECIBE' : 'NO RECIBE';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${medicacion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de estatinas</div>';
        }
    } catch (error) {
        console.error('[💊 Estatinas] Error cargando historial:', error);
    }
}

// Función para guardar antiagregantes
async function guardarAntiagregantes() {
  try {
    const runRaw = obtenerRunActivo();
    if (!runRaw) {
      alert('Debe seleccionar un RUN válido antes de guardar');
      return;
    }

    const runNormalizado = formatearRunParaEnvio(runRaw);
    if (!runNormalizado) {
      alert('RUN inválido, verifique el dígito verificador');
      return;
    }

    const recibeAntiagregantes = document.querySelector('input[name="recibeAntiagregantes"]:checked')?.value;
    const fechaAntiagregantes = document.getElementById('fechaAntiagregantes').value;

    if (!recibeAntiagregantes || !fechaAntiagregantes) {
      alert('Debe completar todos los campos');
      return;
    }

    const payload = {
      run: runNormalizado,
      en_tratamiento: recibeAntiagregantes === 'si',
      fecha: fechaAntiagregantes
    };

    console.log('[💊 Antiagregantes] Guardando:', payload);

    const response = await authFetch('/api/medicacion/antiagregantes', {
      method: 'POST',
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (response.ok && result.ok) {
      console.log('[💊 Antiagregantes] Guardado exitosamente');
      alert('Antiagregante plaquetario guardado exitosamente');
      limpiarFormularioAntiagregantes();
      window._runActivo = runNormalizado;
      await cargarHistorialAntiagregantes(runNormalizado);
    } else {
      console.error('[💊 Antiagregantes] Error al guardar:', result.error);
      alert('Error al guardar: ' + (result.error || 'Error desconocido'));
    }
  } catch (error) {
    console.error('[💊 Antiagregantes] Error:', error);
    alert('Error de conexión');
  }
}

// Función para limpiar formulario antiagregantes
function limpiarFormularioAntiagregantes() {
    document.querySelectorAll('input[name="recibeAntiagregantes"]').forEach(radio => radio.checked = false);
    document.getElementById('fechaAntiagregantes').value = '';
    console.log('[💊 Antiagregantes] Formulario limpiado');
}

// Función para cargar historial antiagregantes
async function cargarHistorialAntiagregantes(run) {
    try {
        if (!run) return;
        
        console.log('[💊 Antiagregantes] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/antiagregantes/${run}?limit=10`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialAntiagregantes');
        const listaDiv = document.getElementById('listHistorialAntiagregantes');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(medicacion => {
                const fecha = new Date(medicacion.fecha).toLocaleDateString('es-CL');
                const estadoColor = medicacion.en_tratamiento ? '#059669' : '#dc2626';
                const estadoBg = medicacion.en_tratamiento ? '#d1fae5' : '#fef2f2';
                const estadoTexto = medicacion.en_tratamiento ? 'SÍ RECIBE' : 'NO RECIBE';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${medicacion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de antiagregantes</div>';
        }
    } catch (error) {
        console.error('[💊 Antiagregantes] Error cargando historial:', error);
    }
}

// ================= FUNCIONES DE COMORBILIDAD/SECUELAS =================

// Función para analizar comorbilidades y secuelas
async function analizarComorbilidades(run) {
    try {
        if (!run) return;
        
        console.log('[📊 Comorbilidad] Analizando diagnósticos para:', run);
        console.log('[📊 Comorbilidad] Timestamp:', new Date().toISOString());
        
        const estadoDiv = document.getElementById('comorbilidadEstado');
        const diagnosticosDiv = document.getElementById('diagnosticosDetectados');
        const sinDiagnosticosDiv = document.getElementById('sinDiagnosticos');
        
        if (!estadoDiv || !diagnosticosDiv || !sinDiagnosticosDiv) return;
        
        // Mostrar estado de carga
        estadoDiv.style.display = 'block';
        estadoDiv.innerHTML = '<span>🔍 Analizando patologías...</span>';
        diagnosticosDiv.style.display = 'none';
        sinDiagnosticosDiv.style.display = 'none';
        
        // Obtener patologías del usuario
        const response = await authFetch(`/api/usuario/${encodeURIComponent(run)}/patologias`);
        if (!response.ok) {
            estadoDiv.innerHTML = '<span style="color:#dc2626;">❌ Error al obtener patologías</span>';
            return;
        }
        
        const result = await response.json();
        console.log('[📊 Comorbilidad] Respuesta API:', result);
        
        if (!result.patologias || result.patologias.length === 0) {
            estadoDiv.innerHTML = '<span style="color:#6b7280;">ℹ️ Sin patologías registradas</span>';
            return;
        }
        
        const patologias = result.patologias;
        console.log('[📊 Comorbilidad] Patologías encontradas:', patologias.length);
        console.log('[📊 Comorbilidad] Muestra de patologías:', patologias.slice(0, 3));
        
        // Verificar si tiene diabetes  
        const tieneDiabetes = patologias.some(p => 
            (p.nombre && /diab/i.test(p.nombre)) || 
            (p.cie10 && /E1[0-4]/i.test(p.cie10))
        );
        
        if (!tieneDiabetes) {
            estadoDiv.innerHTML = '<span style="color:#6b7280;">ℹ️ Análisis requiere diagnóstico de diabetes</span>';
            return;
        }
        
        let diagnosticosEncontrados = 0;
        
        // Resetear todos los diagnósticos
        document.getElementById('diagnosticoTabaquismo').style.display = 'none';
        document.getElementById('diagnosticoErcLeve').style.display = 'none';
        document.getElementById('diagnosticoErcAvanzada').style.display = 'none';
        document.getElementById('diagnosticoAcv').style.display = 'none';
        document.getElementById('diagnosticoIam').style.display = 'none';
        document.getElementById('diagnosticoInsulina').style.display = 'none';
        document.getElementById('recomendacionIecaAra').style.display = 'none';
        
        // 1. Detectar Tabaquismo (F17, T65.2, Z71.6, Z72.0)
        const tieneTabaquismo = patologias.some(p => 
            (p.cie10 && (/F17/i.test(p.cie10) || 
            /T65\.2/i.test(p.cie10) || 
            /Z71\.6/i.test(p.cie10) || 
            /Z72\.0/i.test(p.cie10))) ||
            (p.nombre && /tabaco|tabaquismo|fumar|fumador/i.test(p.nombre))
        );
        
        if (tieneTabaquismo) {
            document.getElementById('diagnosticoTabaquismo').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[📊 Comorbilidad] Detectado: Tabaquismo');
        }
        
        // 2. Detectar ERC Leve-Moderada (N18.1, N18.2, N18.3, N18.9, N19)
        const tieneErcLeve = patologias.some(p => 
            (p.cie10 && (/N18\.[123]/i.test(p.cie10) || 
            /N18\.9/i.test(p.cie10) || 
            /N19/i.test(p.cie10))) ||
            (p.nombre && /renal.*crónica/i.test(p.nombre) && !/estadio.*[45]/i.test(p.nombre))
        );
        
        // 3. Detectar ERC Avanzada (N18.4, N18.5, N18.6)
        const tieneErcAvanzada = patologias.some(p => 
            (p.cie10 && /N18\.[456]/i.test(p.cie10)) ||
            (p.nombre && ((/renal.*crónica/i.test(p.nombre) && /estadio.*[45]/i.test(p.nombre)) ||
            /diálisis/i.test(p.nombre)))
        );
        
        if (tieneErcAvanzada) {
            document.getElementById('diagnosticoErcAvanzada').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[📊 Comorbilidad] Detectado: ERC Avanzada');
        } else if (tieneErcLeve) {
            document.getElementById('diagnosticoErcLeve').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[📊 Comorbilidad] Detectado: ERC Leve-Moderada');
        }
        
        // 4. Detectar ACV/AVE (G46, I64, I67, I68)
        const tieneAcv = patologias.some(p => 
            (p.cie10 && (/G46/i.test(p.cie10) || 
            /I64/i.test(p.cie10) || 
            /I67/i.test(p.cie10) || 
            /I68/i.test(p.cie10))) ||
            (p.nombre && /cerebrovascular|acv|ave|accidente.*cerebral|ictus/i.test(p.nombre))
        );
        
        if (tieneAcv) {
            document.getElementById('diagnosticoAcv').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[📊 Comorbilidad] Detectado: ACV/AVE');
        }
        
        // 5. Detectar IAM (I21)
        const tieneIam = patologias.some(p => 
            (p.cie10 && /I21/i.test(p.cie10)) ||
            (p.nombre && /infarto.*miocardio|iam/i.test(p.nombre))
        );
        
        if (tieneIam) {
            document.getElementById('diagnosticoIam').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[📊 Comorbilidad] Detectado: IAM');
        }
        
        // 6. Verificar uso de insulina
        await verificarUsoInsulina(run);
        
        // 7. Verificar recomendación IECA/ARA II para ERC + DM
        if (tieneErcLeve || tieneErcAvanzada) {
            await verificarRecomendacionIecaAra(run);
        }
        
        // Mostrar resultados
        estadoDiv.style.display = 'none';
        
        if (diagnosticosEncontrados > 0) {
            diagnosticosDiv.style.display = 'block';
            sinDiagnosticosDiv.style.display = 'none';
        } else {
            diagnosticosDiv.style.display = 'none';
            sinDiagnosticosDiv.style.display = 'block';
        }
        
        console.log('[📊 Comorbilidad] Análisis completado. Diagnósticos encontrados:', diagnosticosEncontrados);
        
    } catch (error) {
        console.error('[📊 Comorbilidad] Error en análisis:', error);
        const estadoDiv = document.getElementById('comorbilidadEstado');
        if (estadoDiv) {
            estadoDiv.innerHTML = '<span style="color:#dc2626;">❌ Error en análisis</span>';
        }
    }
}

// Función para verificar uso de insulina
async function verificarUsoInsulina(run) {
    try {
    const response = await authFetch(`/api/insulina-historial/${run}/ultima`);
    if (response.ok) {
      const result = await response.json();
      const registro = result && result.ok ? result.registro || result.insulina : null;
      if (registro && registro.en_tratamiento) {
        document.getElementById('diagnosticoInsulina').style.display = 'block';
        console.log('[📊 Comorbilidad] Detectado: Uso de Insulina');
      }
    }
    } catch (error) {
        console.log('[📊 Comorbilidad] No se pudo verificar uso de insulina');
    }
}

// Función para verificar recomendación IECA/ARA II
async function verificarRecomendacionIecaAra(run) {
    try {
        const response = await authFetch(`/api/medicacion/ieca_ara/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            // Si no tiene IECA/ARA II o el último registro es "NO", mostrar recomendación
            if (!result.ok || !result.historial || result.historial.length === 0 || 
                (result.historial[0] && !result.historial[0].en_tratamiento)) {
                document.getElementById('recomendacionIecaAra').style.display = 'block';
                console.log('[📊 Comorbilidad] Recomendación: IECA/ARA II para nefroprotección');
            }
        }
    } catch (error) {
        console.log('[📊 Comorbilidad] No se pudo verificar IECA/ARA II');
    }
}

// Función principal para recargar todos los datos después de buscar usuario
async function recargaTodo(runVal){
    console.log('🔄 [SISTEMA] *** RECARGA TODO EJECUTANDOSE *** para usuario:', runVal);
    
    // Verificar sesión antes de proceder
    const sesionActiva = await verificarSesion();
    if (!sesionActiva) {
        console.log('⚠️ [SISTEMA] Sesión no activa - algunas funciones pueden no estar disponibles');
    }
    
    // Crear un contador de errores para mostrar estado general
    window._errorCount = 0;
    window._totalCalls = 24; // Incrementado por las funciones de historial + fármacos + comorbilidad
    
    // Función helper para manejar errores silenciosamente
    const safeCall = async (fn, name) => {
        try {
            console.log(`🔄 [${name}] Iniciando...`);
            if (typeof fn === 'function') {
                await fn(runVal);
                console.log(`✅ [${name}] Completado exitosamente`);
            } else {
                window._errorCount++;
                console.error(`❌ [${name}] Función no definida`);
            }
        } catch (error) {
            window._errorCount++;
            console.error(`❌ [${name}] Error:`, error.message, error);
        }
    };
    
    console.log('🔄 [SISTEMA] Iniciando carga de historiales de evaluación diabetes para:', runVal);
    
    Promise.all([
        safeCall(cargarUltimoControl, 'Control'),
        safeCall(cargarLabs, 'Laboratorio'),
        safeCall(cargarHistoricoControl, 'Hist.Control'),
        safeCall(cargarHistoricoLabs, 'Hist.Labs'),
        safeCall(cargarHistoricoAcuerdos, 'Acuerdos'),
        safeCall(sincronizarPatologiasUsuario, 'Patologías'),
        safeCall(cargarUltimoExamenPieDiabetico, 'PieDiabético'),
        safeCall(cargarUltimaCuracion, 'Curaciones'),
        safeCall(cargarUltimaHipoglicemia, 'Hipoglicemias'),
        safeCall(cargarUltimaAmputacion, 'Amputación'),
        safeCall(cargarUltimaInsulina, 'Insulina'),
        safeCall(cargarUltimaPodologia, 'Podología'),
        safeCall(cargarUltimoFondoOjos, 'FondoOjos'),
        // Funciones de historial - ACTUALIZADAS
        safeCall(cargarHistorialPieDiabetico, 'Hist.PieDiabético'),
        safeCall(cargarHistorialCuraciones, 'Hist.Curaciones'),
        safeCall(cargarHistorialEkg, 'Hist.EKG'),
        safeCall(cargarHistorialHipoglicemias, 'Hist.Hipoglicemias'),
        safeCall(cargarHistorialAmputacion, 'Hist.Amputación'),
        safeCall(cargarHistorialInsulina, 'Hist.Insulina'),
        safeCall(cargarHistorialPodologia, 'Hist.Podología'),
        safeCall(cargarHistorialFondoOjos, 'Hist.FondoOjos'),
        // Funciones de historial de fármacos
        safeCall(cargarHistorialIecaAra, 'Hist.IECA/ARA II'),
        safeCall(cargarHistorialEstatinas, 'Hist.Estatinas'),
        safeCall(cargarHistorialAntiagregantes, 'Hist.Antiagregantes'),
        // Análisis de comorbilidades y secuelas
        safeCall(analizarComorbilidades, 'Comorbilidad/Secuelas')
    ]).then(() => {
        const available = window._totalCalls - window._errorCount;
        console.log(`✅ [SISTEMA] *** RECARGA TODO COMPLETADA *** : ${available}/${window._totalCalls} módulos disponibles`);
        
        if (window._errorCount > 6) {
            console.log('ℹ️ [SISTEMA] Algunos módulos no están disponibles - esto es normal');
        }
    });
}

// Hacer recargaTodo global para debugging
window.recargaTodo = recargaTodo;

// ================= FUNCIÓN DE PRUEBA DE HISTORIALES =================

async function probarHistorialesDiabetes(run = '10.000.141-1') {
    console.log('🧪 [PRUEBA] Probando todos los historiales de diabetes para:', run);
    
    const funciones = [
        { func: cargarHistorialPieDiabetico, nombre: '🦶 Pie Diabético' },
        { func: cargarHistorialCuraciones, nombre: '🩹 Curaciones' },
        { func: cargarHistorialEkg, nombre: '⚡ EKG' },
        { func: cargarHistorialHipoglicemias, nombre: '🩸 Hipoglicemias' },
        { func: cargarHistorialAmputacion, nombre: '🦿 Amputación' },
        { func: cargarHistorialInsulina, nombre: '💉 Insulina' },
        { func: cargarHistorialPodologia, nombre: '🦶 Podología' },
        { func: cargarHistorialFondoOjos, nombre: '👁️ Fondo de Ojos' }
    ];
    
    for (const { func, nombre } of funciones) {
        try {
            console.log(`🧪 [PRUEBA] Probando ${nombre}...`);
            await func(run);
            console.log(`✅ [PRUEBA] ${nombre} - Completado`);
        } catch (error) {
            console.error(`❌ [PRUEBA] ${nombre} - Error:`, error);
        }
    }
    
    console.log('🧪 [PRUEBA] Prueba de historiales completada');
}

// Disponible globalmente para pruebas manuales
window.probarHistorialesDiabetes = probarHistorialesDiabetes;

// Exponer funciones de historial globalmente para debug y uso manual
window.cargarHistorialPieDiabetico = cargarHistorialPieDiabetico;
window.cargarHistorialCuraciones = cargarHistorialCuraciones;
window.cargarHistorialHipoglicemias = cargarHistorialHipoglicemias;  
window.cargarHistorialFondoOjos = cargarHistorialFondoOjos;
window.cargarHistorialAmputacion = cargarHistorialAmputacion;
window.cargarHistorialInsulina = cargarHistorialInsulina;
window.cargarHistorialPodologia = cargarHistorialPodologia;
window.cargarHistorialEkg = cargarHistorialEkg;

// Exponer funciones de guardado globalmente para botones onclick
window.guardarPodologia = guardarPodologia;
window.guardarHipoglicemias = guardarHipoglicemias;
window.guardarAmputacion = guardarAmputacion;

// Exponer funciones de limpiar globalmente para botones onclick
window.limpiarFormularioHipoglicemias = limpiarFormularioHipoglicemias;
window.limpiarFormularioAmputacion = limpiarFormularioAmputacion;

// ======= FUNCIONES ACTIVIDAD FÍSICA =======

// Función para guardar actividad física
async function guardarActividadFisica() {
    try {
        // Obtener RUN del paciente
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('No hay RUN seleccionado');
            return;
        }

        // Obtener valores del formulario
        const actividadRadios = document.querySelectorAll('input[name="actividadFisica"]:checked');
        const fechaInput = document.getElementById('fechaActividadFisica');

        // Validaciones
        if (actividadRadios.length === 0) {
            alert('Por favor seleccione si realiza actividad física');
            return;
        }

        if (!fechaInput || !fechaInput.value) {
            alert('Por favor ingrese la fecha de evaluación');
            return;
        }

        const actividadValue = actividadRadios[0].value;
        const activo = actividadValue === 'si';

        console.log('[🏃‍♂️ Actividad Física] Guardando:', {
            run: runField.value.trim(),
            activo: activo,
            fecha: fechaInput.value
        });

        // Preparar datos para enviar
        const data = {
            run: runField.value.trim(),
            activo: activo,
            fecha: fechaInput.value
        };

        // Enviar datos al servidor
        const response = await authFetch('/api/actividad_fisica/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            alert('Actividad física guardada exitosamente');
            // Recargar historial
            cargarHistorialActividadFisica(runField.value.trim());
            console.log('[🏃‍♂️ Actividad Física] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }

    } catch (error) {
        console.error('[🏃‍♂️ Actividad Física] Error guardando:', error);
        alert('Error al guardar la actividad física: ' + error.message);
    }
}

// Función para limpiar formulario de actividad física
function limpiarFormularioActividadFisica() {
    const form = document.getElementById('actividadFisicaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaInput = document.getElementById('fechaActividadFisica');
    if (fechaInput) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[🏃‍♂️ Actividad Física] Formulario limpiado');
}

// Función para cargar historial de actividad física
async function cargarHistorialActividadFisica(run) {
    try {
        if (!run) return;
        
        console.log('[🏃‍♂️ Actividad Física] Cargando historial para:', run);
        
        const response = await authFetch(`/api/actividad_fisica/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialActividadFisica');
        const listaDiv = document.getElementById('listHistorialActividadFisica');
        
        if (!historialDiv || !listaDiv) {
            console.error('[🏃‍♂️ Actividad Física] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[🏃‍♂️ Actividad Física] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(registro => {
                const fecha = new Date(registro.fecha).toLocaleDateString('es-CL');
                const estadoColor = registro.activo ? '#059669' : '#dc2626';
                const estadoBg = registro.activo ? '#d1fae5' : '#fecaca';
                const estadoTexto = registro.activo ? 'SÍ ACTIVO' : 'NO ACTIVO';
                const icono = registro.activo ? '🏃‍♂️' : '❌';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:1rem;">${icono}</span>
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${registro.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[🏃‍♂️ Actividad Física] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#6b7280;font-size:0.8rem;">
                    <span style="font-size:1.5rem;display:block;margin-bottom:8px;">🏃‍♂️</span>
                    Sin registros de actividad física
                </div>
            `;
            console.log('[🏃‍♂️ Actividad Física] Sin historial disponible');
        }
        
    } catch (error) {
        console.error('[🏃‍♂️ Actividad Física] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialActividadFisica');
        const listaDiv = document.getElementById('listHistorialActividadFisica');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#ef4444;font-size:0.8rem;">
                    Error al cargar el historial
                </div>
            `;
        }
    }
}

// Exponer funciones de actividad física globalmente
window.guardarActividadFisica = guardarActividadFisica;
window.limpiarFormularioActividadFisica = limpiarFormularioActividadFisica;
window.cargarHistorialActividadFisica = cargarHistorialActividadFisica;

// ======= FUNCIONES MASAMA =======

// Función para guardar MasAma
async function guardarMasAma() {
    try {
        // Obtener RUN del paciente
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('No hay RUN seleccionado');
            return;
        }

        // Obtener valores del formulario
        const masAmaRadios = document.querySelectorAll('input[name="masAma"]:checked');
        const fechaInput = document.getElementById('fechaMasAma');

        // Validaciones
        if (masAmaRadios.length === 0) {
            alert('Por favor seleccione el resultado de MasAma');
            return;
        }

        if (!fechaInput || !fechaInput.value) {
            alert('Por favor ingrese la fecha de evaluación');
            return;
        }

        const masAmaValue = masAmaRadios[0].value;
        const masama = masAmaValue === 'si';

        console.log('[🔍 MasAma] Guardando:', {
            usuario_id: runField.value.trim(),
            masama: masama,
            fecha: fechaInput.value
        });

        // Preparar datos para enviar
        const data = {
            usuario_id: runField.value.trim(),
            masama: masama,
            fecha: fechaInput.value
        };

        // Enviar datos al servidor
        const response = await authFetch('/api/masama/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            alert('MasAma guardado exitosamente');
            // Recargar historial
            cargarHistorialMasAma(runField.value.trim());
            console.log('[🔍 MasAma] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }

    } catch (error) {
        console.error('[🔍 MasAma] Error guardando:', error);
        alert('Error al guardar MasAma: ' + error.message);
    }
}

// Función para limpiar formulario de MasAma
function limpiarFormularioMasAma() {
    const form = document.getElementById('masAmaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaInput = document.getElementById('fechaMasAma');
    if (fechaInput) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[🔍 MasAma] Formulario limpiado');
}

// Función para cargar historial de MasAma
async function cargarHistorialMasAma(run) {
    try {
        if (!run) return;
        
        console.log('[🔍 MasAma] Cargando historial para:', run);
        
        const response = await authFetch(`/api/masama/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialMasAma');
        const listaDiv = document.getElementById('listHistorialMasAma');
        
        if (!historialDiv || !listaDiv) {
            console.error('[🔍 MasAma] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[🔍 MasAma] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(registro => {
                const fecha = new Date(registro.fecha).toLocaleDateString('es-CL');
                const estadoColor = registro.masama ? '#dc2626' : '#059669';
                const estadoBg = registro.masama ? '#fecaca' : '#d1fae5';
                const estadoTexto = registro.masama ? 'POSITIVO' : 'NEGATIVO';
                const icono = registro.masama ? '⚠️' : '✅';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:1rem;">${icono}</span>
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${registro.created_at ? new Date(registro.created_at).toLocaleDateString('es-CL') : 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[🔍 MasAma] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#6b7280;font-size:0.8rem;">
                    <span style="font-size:1.5rem;display:block;margin-bottom:8px;">🔍</span>
                    Sin registros de MasAma
                </div>
            `;
            console.log('[🔍 MasAma] Sin historial disponible');
        }
        
    } catch (error) {
        console.error('[🔍 MasAma] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialMasAma');
        const listaDiv = document.getElementById('listHistorialMasAma');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#ef4444;font-size:0.8rem;">
                    Error al cargar el historial
                </div>
            `;
        }
    }
}

// Exponer funciones de MasAma globalmente
window.guardarMasAma = guardarMasAma;
window.limpiarFormularioMasAma = limpiarFormularioMasAma;
window.cargarHistorialMasAma = cargarHistorialMasAma;

// Exponer funciones de adulto mayor globalmente
window.guardarEvaluacionAdultoMayor = guardarEvaluacionAdultoMayor;
window.limpiarFormularioAdultoMayor = limpiarFormularioAdultoMayor;
window.cargarHistorialAdultoMayor = cargarHistorialAdultoMayor;

// ========================= FUNCIONES DE SCREENING ===============================

// Función para guardar vacuna (influenza o covid)
async function guardarVacuna(tipo) {
    try {
        // Obtener valores del formulario
        const fechaInput = document.getElementById(`fecha${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        const estadoInput = document.getElementById(`estado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha de vacunación');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar el estado de la vacuna');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        const fecha = new Date(fechaInput.value);
        const anio = fecha.getFullYear();
        
        // Preparar datos
        const data = {
            tipo: tipo,
            estado: estadoInput.value,
            fecha: fechaInput.value,
            anio: anio
        };
        
        console.log(`[💉 Vacuna ${tipo}] Guardando:`, data);
        
        // Enviar al servidor
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(runField.value.trim())}/vacunas`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert(`Vacuna ${tipo} guardada exitosamente`);
            // Recargar historial
            cargarHistorialVacunas(runField.value.trim());
            console.log(`[💉 Vacuna ${tipo}] Guardado exitoso:`, result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error(`[💉 Vacuna ${tipo}] Error guardando:`, error);
        alert(`Error al guardar la vacuna ${tipo}: ` + error.message);
    }
}

// Función para cargar historial de vacunas
async function cargarHistorialVacunas(run) {
    try {
        if (!run) return;
        
        console.log('[💉 Vacunas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[💉 Vacunas] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialVacunas');
            const listaDiv = document.getElementById('listaHistorialVacunas');
            
            if (!historialDiv || !listaDiv) {
                console.error('[💉 Vacunas] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(vacuna => `
                    <div style="padding:8px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;font-size:0.8rem;">
                        <div><strong>${vacuna.tipo.toUpperCase()}</strong></div>
                        <div>${vacuna.fecha ? new Date(vacuna.fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            vacuna.estado === 'SI' ? 'background:#dcfce7;color:#166534;' :
                            vacuna.estado === 'NO' ? 'background:#fef2f2;color:#dc2626;' :
                            'background:#fef3c7;color:#d97706;'
                        }">${vacuna.estado}</span></div>
                        <div style="color:#6b7280;">${vacuna.anio}</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay vacunas registradas</div>';
            }
        } else {
            console.error('[💉 Vacunas] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[💉 Vacunas] Error cargando historial:', error);
    }
}

// Función para guardar PAP
async function guardarPAP() {
    try {
        const fechaInput = document.getElementById('fechaPAP');
        const estadoInput = document.getElementById('estadoPAP');
        const resultadoInput = document.getElementById('resultadoPAP');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha del PAP');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar si se realizó el PAP');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            pap_fecha: fechaInput.value,
            pap: estadoInput.value === 'true',
            pap_resultado: resultadoInput.value || null
        };
        
        console.log('[👩‍⚕️ PAP] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/pap', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('PAP guardado exitosamente');
            // Recargar historial
            cargarHistorialPAP(runField.value.trim());
            console.log('[👩‍⚕️ PAP] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[👩‍⚕️ PAP] Error guardando:', error);
        alert('Error al guardar el PAP: ' + error.message);
    }
}

// Función para cargar historial de PAP
async function cargarHistorialPAP(run) {
    try {
        if (!run) return;
        
        console.log('[👩‍⚕️ PAP] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/pap/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[👩‍⚕️ PAP] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialPAP');
            const listaDiv = document.getElementById('listaHistorialPAP');
            
            if (!historialDiv || !listaDiv) {
                console.error('[👩‍⚕️ PAP] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(pap => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 2fr;gap:8px;align-items:center;">
                        <div>${pap.pap_fecha ? new Date(pap.pap_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            pap.pap ? 'background:#dcfce7;color:#166534;' : 'background:#fef2f2;color:#dc2626;'
                        }">${pap.pap ? 'Realizado' : 'No realizado'}</span></div>
                        <div style="font-size:0.75rem;color:#6b7280;">${pap.pap_resultado || 'Sin resultado'}</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay PAPs registrados</div>';
            }
        } else {
            console.error('[👩‍⚕️ PAP] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[👩‍⚕️ PAP] Error cargando historial:', error);
    }
}

// Función para guardar Mamografía
async function guardarMamografia() {
    try {
        const fechaInput = document.getElementById('fechaMamografia');
        const estadoInput = document.getElementById('estadoMamografia');
        const biradesInput = document.getElementById('biradsMamografia');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha de la mamografía');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar si se realizó la mamografía');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            mamografia_fecha: fechaInput.value,
            mamografia: estadoInput.value === 'true',
            mamografia_birads: biradesInput.value ? parseInt(biradesInput.value) : null
        };
        
        console.log('[🩻 Mamografía] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/mamografia', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('Mamografía guardada exitosamente');
            // Recargar historial
            cargarHistorialMamografia(runField.value.trim());
            console.log('[🩻 Mamografía] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[🩻 Mamografía] Error guardando:', error);
        alert('Error al guardar la mamografía: ' + error.message);
    }
}

// Función para cargar historial de Mamografía
async function cargarHistorialMamografia(run) {
    try {
        if (!run) return;
        
        console.log('[🩻 Mamografía] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/mamografia/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[🩻 Mamografía] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialMamografia');
            const listaDiv = document.getElementById('listaHistorialMamografia');
            
            if (!historialDiv || !listaDiv) {
                console.error('[🩻 Mamografía] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(mamografia => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center;">
                        <div>${mamografia.mamografia_fecha ? new Date(mamografia.mamografia_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            mamografia.mamografia ? 'background:#dcfce7;color:#166534;' : 'background:#fef2f2;color:#dc2626;'
                        }">${mamografia.mamografia ? 'Realizada' : 'No realizada'}</span></div>
                        <div style="font-size:0.75rem;color:#6b7280;">${
                            mamografia.mamografia_birads !== null ? `BI-RADS ${mamografia.mamografia_birads}` : 'Sin BI-RADS'
                        }</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay mamografías registradas</div>';
            }
        } else {
            console.error('[🩻 Mamografía] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[🩻 Mamografía] Error cargando historial:', error);
    }
}

// Función para guardar PSA
async function guardarPSA() {
    try {
        const fechaInput = document.getElementById('fechaPSA');
        const valorInput = document.getElementById('valorPSA');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha del PSA');
            return;
        }
        
        if (!valorInput || !valorInput.value) {
            alert('Debe ingresar el valor del PSA');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN válido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            examen_fecha: fechaInput.value,
            psa_valor: parseFloat(valorInput.value)
        };
        
        console.log('[👨‍⚕️ PSA] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/psa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('PSA guardado exitosamente');
            // Recargar historial
            cargarHistorialPSA(runField.value.trim());
            console.log('[👨‍⚕️ PSA] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[👨‍⚕️ PSA] Error guardando:', error);
        alert('Error al guardar el PSA: ' + error.message);
    }
}

// Función para cargar historial de PSA
async function cargarHistorialPSA(run) {
    try {
        if (!run) return;
        
        console.log('[👨‍⚕️ PSA] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/psa/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[👨‍⚕️ PSA] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialPSA');
            const listaDiv = document.getElementById('listaHistorialPSA');
            
            if (!historialDiv || !listaDiv) {
                console.error('[👨‍⚕️ PSA] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(psa => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center;">
                        <div>${psa.examen_fecha ? new Date(psa.examen_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div style="font-weight:600;color:#1e293b;">${psa.psa_valor} ng/mL</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay PSAs registrados</div>';
            }
        } else {
            console.error('[👨‍⚕️ PSA] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[👨‍⚕️ PSA] Error cargando historial:', error);
    }
}

// Función para cargar datos de screening según el género y edad
async function cargarDatosScreening(run, sexo, edad) {
    if (!run) return;
    
    console.log('[🔍 Screening] Cargando datos para:', run, 'Sexo:', sexo, 'Edad:', edad);
    
    // Mostrar/ocultar secciones según género y edad
    const seccionPAP = document.getElementById('seccionPAP');
    const seccionMamografia = document.getElementById('seccionMamografia');
    const seccionPSA = document.getElementById('seccionPSA');
    
    if (seccionPAP && seccionMamografia && seccionPSA) {
        // PAP: Mujeres 25-64 años
        if (sexo === 'F' && edad >= 25 && edad <= 64) {
            seccionPAP.style.display = 'block';
        } else {
            seccionPAP.style.display = 'none';
        }
        
        // Mamografía: Mujeres 50-69 años
        if (sexo === 'F' && edad >= 50 && edad <= 69) {
            seccionMamografia.style.display = 'block';
        } else {
            seccionMamografia.style.display = 'none';
        }
        
        // PSA: Hombres ≥50 años
        if (sexo === 'M' && edad >= 50) {
            seccionPSA.style.display = 'block';
        } else {
            seccionPSA.style.display = 'none';
        }
    }
    
    // Cargar datos de screening generales
    try {
        const response = await authFetch(`/api/screening/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.screening) {
                console.log('[🔍 Screening] Datos cargados:', result.screening);
                mostrarDatosScreeningActuales(result.screening);
            }
        }
    } catch (error) {
        console.error('[� Medicación - Screening] Error cargando datos generales:', error);
    }
    
    // Cargar historial de vacunas (aplica a todos)
    cargarHistorialVacunas(run);
}

// === Helpers para screening (sin efectos externos salvo DOM específico) ===
function byId(id) {
    return document.getElementById(id);
}

function setValueIf(el, value) {
    if (el && value != null) el.value = String(value);
}

function setBooleanString(el, condition) {
    if (el) el.value = condition ? 'true' : 'false';
}

/**
 * Garantiza un único .estado-actual dentro de un contenedor por id
 * y luego asigna su innerHTML. No altera el orden de efectos de la sección.
 */
function upsertEstadoActual(containerId, html) {
    const cont = byId(containerId);
    if (!cont) return;
    let estadoDiv = cont.querySelector('.estado-actual');
    if (!estadoDiv) {
        estadoDiv = document.createElement('div');
        estadoDiv.className = 'estado-actual';
        cont.appendChild(estadoDiv);
    }
    estadoDiv.innerHTML = html;
}

// Función para mostrar datos actuales de screening (MISMA FIRMA, MISMO ORDEN)
function mostrarDatosScreeningActuales(screening) {
    if (!screening || typeof screening !== 'object') return;

    // ===== PAP =====
    if (screening.pap) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaPAP'), screening.pap.fecha);

        const papOk = screening.pap.estado === 'al_dia' || screening.pap.estado === 'realizado';
        setBooleanString(byId('estadoPAP'), papOk);

        setValueIf(byId('resultadoPAP'), screening.pap.resultado);

        // 2) Estado en interfaz (mismo estilo y en el mismo punto de la sección)
        const papHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>Último PAP:</strong> ${screening.pap.fecha} - Estado: ${screening.pap.estado}
            </div>`;
        upsertEstadoActual('seccionPAP', papHTML);
    }

    // ===== MAMOGRAFÍA =====
    if (screening.mamografia) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaMamografia'), screening.mamografia.fecha);

        const mamOk = screening.mamografia.estado === 'realizada';
        setBooleanString(byId('estadoMamografia'), mamOk);

        // birads solo si !== undefined (conserva el comportamiento exacto)
        if (screening.mamografia.birads !== undefined) {
            setValueIf(byId('biradsMamografia'), screening.mamografia.birads);
        }

        // 2) Estado en interfaz
        const mamHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>Última Mamografía:</strong> ${screening.mamografia.fecha} - Estado: ${screening.mamografia.estado}
            </div>`;
        upsertEstadoActual('seccionMamografia', mamHTML);
    }

    // ===== PSA =====
    if (screening.psa) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaPSA'), screening.psa.fecha);
        setValueIf(byId('valorPSA'), screening.psa.psa_valor);
        // (No hay bloque visual/estado-actual para PSA en el código original)
        
        // Mostrar estado en la interfaz
        const seccionPSA = document.getElementById('seccionPSA');
        if (seccionPSA) {
            const estadoHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>Último PSA:</strong> ${screening.psa.fecha} - Valor: ${screening.psa.psa_valor} ng/mL
            </div>`;
            
            let estadoDiv = seccionPSA.querySelector('.estado-actual');
            if (!estadoDiv) {
                estadoDiv = document.createElement('div');
                estadoDiv.className = 'estado-actual';
                seccionPSA.appendChild(estadoDiv);
            }
            estadoDiv.innerHTML = estadoHTML;
        }
    }
}

// Función para cargar datos de screening en Adulto Mayor según el género y edad
async function cargarDatosScreeningAM(run, sexo, edad) {
    if (!run) return;
    
    console.log('[👴 Adulto Mayor - Screening] Cargando datos para:', run, 'Sexo:', sexo, 'Edad:', edad);
  let sexoNorm = '';
  try {
    const raw = (sexo ?? '').toString().trim().toLowerCase();
    if (raw) {
      if (['m', 'masculino', 'hombre', 'male', 'varón', 'varon'].includes(raw)) {
        sexoNorm = 'M';
      } else if (['f', 'femenino', 'mujer', 'female'].includes(raw)) {
        sexoNorm = 'F';
      } else if (raw.length === 1) {
        sexoNorm = raw.toUpperCase();
      }
    }
  } catch (err) {
    console.warn('[DEBUG-SCREENING] No se pudo normalizar sexo:', err);
    sexoNorm = '';
  }
  const edadNum = Number.parseInt(edad, 10);
  const edadValida = Number.isFinite(edadNum) ? edadNum : NaN;

  console.log('[DEBUG-SCREENING] Sexo normalizado:', sexoNorm, 'Edad numérica:', edadValida);
    console.log('[DEBUG-SCREENING] Valores recibidos:', {
        run: run,
    sexo: sexo,
    sexoNormalizado: sexoNorm,
    sexoTipo: typeof sexo,
    edad: edad,
    edadTipo: typeof edad,
    edadEsNumero: Number.isFinite(edadValida)
    });
    
    // Mostrar/ocultar secciones según género y edad
    const seccionPAPAM = document.getElementById('seccionPAPAM');
    const seccionMamografiaAM = document.getElementById('seccionMamografiaAM');
    const seccionPSAAM = document.getElementById('seccionPSAAM');
    
    console.log('[DEBUG-SCREENING] Elementos de sección:', {
        PAP: !!seccionPAPAM,
        Mamografia: !!seccionMamografiaAM,
        PSA: !!seccionPSAAM
    });
    
    if (seccionPAPAM && seccionMamografiaAM && seccionPSAAM) {
        // PAP: Mujeres 25-64 años
    const mostrarPAP = sexoNorm === 'F' && edadValida >= 25 && edadValida <= 64;
        console.log('[DEBUG-SCREENING] PAP - Condiciones:', {
      sexo: sexo,
      sexoNorm,
      sexoEsF: sexoNorm === 'F',
      edad: edad,
      edadNum: edadValida,
      edadEntre25y64: edadValida >= 25 && edadValida <= 64,
            mostrar: mostrarPAP
        });
        if (mostrarPAP) {
            seccionPAPAM.style.display = 'block';
        } else {
            seccionPAPAM.style.display = 'none';
        }
        
        // Mamografía: Mujeres 50-69 años
    const mostrarMamo = sexoNorm === 'F' && edadValida >= 50 && edadValida <= 69;
        console.log('[DEBUG-SCREENING] Mamografía - Condiciones:', {
      sexo: sexo,
      sexoNorm,
      sexoEsF: sexoNorm === 'F',
      edad: edad,
      edadNum: edadValida,
      edadEntre50y69: edadValida >= 50 && edadValida <= 69,
            mostrar: mostrarMamo
        });
        if (mostrarMamo) {
            seccionMamografiaAM.style.display = 'block';
        } else {
            seccionMamografiaAM.style.display = 'none';
        }
        
        // PSA: Hombres ≥50 años
    const mostrarPSA = sexoNorm === 'M' && edadValida >= 50;
        console.log('[DEBUG-SCREENING] PSA - Condiciones:', {
      sexo: sexo,
      sexoNorm,
      sexoEsM: sexoNorm === 'M',
      edad: edad,
      edadNum: edadValida,
      edadMayor50: edadValida >= 50,
            mostrar: mostrarPSA
        });
        if (mostrarPSA) {
            seccionPSAAM.style.display = 'block';
        } else {
            seccionPSAAM.style.display = 'none';
        }
    }
    
    // Cargar datos de screening generales
    try {
        const response = await authFetch(`/api/screening/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.screening) {
                console.log('[👴 Adulto Mayor - Screening] Datos cargados:', result.screening);
                mostrarDatosScreeningActualesAM(result.screening);
            }
        }
    } catch (error) {
        console.error('[👴 Adulto Mayor - Screening] Error cargando datos generales:', error);
    }
    
    // Cargar historial de vacunas (aplica a todos)
  cargarHistorialVacunasAM(run);
}

// Función para mostrar datos actuales de screening en Adulto Mayor (MISMA FIRMA, MISMO ORDEN)
function mostrarDatosScreeningActualesAM(screening) {
    if (!screening || typeof screening !== 'object') return;

    // ===== PAP =====
    if (screening.pap) {
        setValueIf(byId('fechaPAPAM'), screening.pap.fecha);

        const papOk = screening.pap.estado === 'al_dia' || screening.pap.estado === 'realizado';
        setBooleanString(byId('estadoPAPAM'), papOk);

        setValueIf(byId('resultadoPAPAM'), screening.pap.resultado);

        // Calcular vigencia (3 años)
        const fechaPAP = new Date(screening.pap.fecha);
        const hoy = new Date();
        const diffAnios = (hoy - fechaPAP) / (1000 * 60 * 60 * 24 * 365.25);
        const vigente = diffAnios <= 3;
        
        let estadoVigencia = '';
        let colorVigencia = '#10b981'; // verde por defecto
        let bgVigencia = '#d1fae5';
        
        if (vigente) {
            estadoVigencia = '✅ Vigente';
        } else {
            estadoVigencia = '⚠️ Vencido (más de 3 años)';
            colorVigencia = '#ef4444'; // rojo
            bgVigencia = '#fee2e2';
        }

        const papHTML = `<div style="margin-top:8px;padding:8px;background:${bgVigencia};border-radius:4px;font-size:0.8rem;border-left:3px solid ${colorVigencia};">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>Último PAP:</strong> ${screening.pap.fecha} - Estado: ${screening.pap.estado}
                </div>
                <div style="font-weight:600;color:${colorVigencia};">
                    ${estadoVigencia}
                </div>
            </div>
            ${!vigente ? '<div style="margin-top:4px;font-size:0.75rem;color:#991b1b;">⚠️ Requiere actualización</div>' : ''}
        </div>`;
        upsertEstadoActual('seccionPAPAM', papHTML);
    }

    // ===== MAMOGRAFÍA =====
    if (screening.mamografia) {
        setValueIf(byId('fechaMamografiaAM'), screening.mamografia.fecha);

        const mamOk = screening.mamografia.estado === 'realizada';
        setBooleanString(byId('estadoMamografiaAM'), mamOk);

        if (screening.mamografia.birads !== undefined) {
            const elBirads = byId('biradsMamografiaAM');
            if (elBirads) elBirads.value = String(screening.mamografia.birads);
        }

        // Calcular vigencia (2 años)
        const fechaMamo = new Date(screening.mamografia.fecha);
        const hoy = new Date();
        const diffAniosMamo = (hoy - fechaMamo) / (1000 * 60 * 60 * 24 * 365.25);
        const vigenteMamo = diffAniosMamo <= 2;
        
        let estadoVigenciaMamo = '';
        let colorVigenciaMamo = '#10b981';
        let bgVigenciaMamo = '#d1fae5';
        
        if (vigenteMamo) {
            estadoVigenciaMamo = '✅ Vigente';
        } else {
            estadoVigenciaMamo = '⚠️ Vencido (más de 2 años)';
            colorVigenciaMamo = '#ef4444';
            bgVigenciaMamo = '#fee2e2';
        }

        const mamHTML = `<div style="margin-top:8px;padding:8px;background:${bgVigenciaMamo};border-radius:4px;font-size:0.8rem;border-left:3px solid ${colorVigenciaMamo};">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>Última Mamografía:</strong> ${screening.mamografia.fecha} - Estado: ${screening.mamografia.estado}
                </div>
                <div style="font-weight:600;color:${colorVigenciaMamo};">
                    ${estadoVigenciaMamo}
                </div>
            </div>
            ${!vigenteMamo ? '<div style="margin-top:4px;font-size:0.75rem;color:#991b1b;">⚠️ Requiere actualización</div>' : ''}
        </div>`;
        upsertEstadoActual('seccionMamografiaAM', mamHTML);
    }

    // ===== PSA =====
    if (screening.psa) {
        setValueIf(byId('fechaPSAAM'), screening.psa.fecha);
        // Mantener semántica original: solo asigna si psa_valor es truthy (0 se omite)
        setValueIf(byId('valorPSAAM'), screening.psa.psa_valor);

        // Calcular vigencia (1 año)
        const fechaPSA = new Date(screening.psa.fecha);
        const hoy = new Date();
        const diffAniosPSA = (hoy - fechaPSA) / (1000 * 60 * 60 * 24 * 365.25);
        const vigentePSA = diffAniosPSA <= 1;
        
        let estadoVigenciaPSA = '';
        let colorVigenciaPSA = '#10b981';
        let bgVigenciaPSA = '#d1fae5';
        
        if (vigentePSA) {
            estadoVigenciaPSA = '✅ Vigente';
        } else {
            estadoVigenciaPSA = '⚠️ Vencido (más de 1 año)';
            colorVigenciaPSA = '#ef4444';
            bgVigenciaPSA = '#fee2e2';
        }

        const psaHTML = `<div style="margin-top:8px;padding:8px;background:${bgVigenciaPSA};border-radius:4px;font-size:0.8rem;border-left:3px solid ${colorVigenciaPSA};">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>Último PSA:</strong> ${screening.psa.fecha} - Valor: ${screening.psa.psa_valor} ng/mL
                </div>
                <div style="font-weight:600;color:${colorVigenciaPSA};">
                    ${estadoVigenciaPSA}
                </div>
            </div>
            ${!vigentePSA ? '<div style="margin-top:4px;font-size:0.75rem;color:#991b1b;">⚠️ Requiere actualización</div>' : ''}
        </div>`;
        upsertEstadoActual('seccionPSAAM', psaHTML);
    }
}

// Función para cargar historial de vacunas en Adulto Mayor
async function cargarHistorialVacunasAM(run) {
    try {
        if (!run) return;
        
        console.log('[👴 Adulto Mayor - Vacunas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`);
        if (!response.ok) {
            console.log('[👴 Adulto Mayor - Vacunas] No hay historial disponible');
            return;
        }
        
        const result = await response.json();
        const historialDiv = document.getElementById('historialVacunasAM');
        const listaDiv = document.getElementById('listaHistorialVacunasAM');
        
        if (!historialDiv || !listaDiv) return;
        
        if (result && result.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.map(vacuna => {
                const fecha = new Date(vacuna.fecha).toLocaleDateString('es-CL');
                const tipoDisplay = vacuna.tipo === 'influenza' ? 'Influenza' : 'COVID';
                const estadoColor = vacuna.estado === 'SI' ? '#10b981' : vacuna.estado === 'NO' ? '#ef4444' : '#f59e0b';
                const estadoBg = vacuna.estado === 'SI' ? '#d1fae5' : vacuna.estado === 'NO' ? '#fef2f2' : '#fef3c7';
                
                return `
                    <div style="padding:6px 8px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">
                                <span style="font-size:0.7rem;font-weight:600;color:#1f2937;">${tipoDisplay}</span>
                                <span style="font-size:0.65rem;color:#6b7280;">${fecha}</span>
                            </div>
                        </div>
                        <span style="background:${estadoBg};color:${estadoColor};padding:1px 4px;border-radius:2px;font-size:0.6rem;font-weight:600;">
                            ${vacuna.estado}
                        </span>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.7rem;">No hay historial de vacunas</div>';
        }
    } catch (error) {
        console.error('[👴 Adulto Mayor - Vacunas] Error cargando historial:', error);
    }
}

// Exponer funciones globalmente
window.guardarVacuna = guardarVacuna;
window.cargarHistorialVacunas = cargarHistorialVacunas;
window.guardarPAP = guardarPAP;
window.cargarHistorialPAP = cargarHistorialPAP;
window.guardarMamografia = guardarMamografia;
window.cargarHistorialMamografia = cargarHistorialMamografia;
window.guardarPSA = guardarPSA;
window.cargarHistorialPSA = cargarHistorialPSA;
window.cargarDatosScreening = cargarDatosScreening;
window.cargarDatosScreeningAM = cargarDatosScreeningAM;
window.cargarHistorialVacunasAM = cargarHistorialVacunasAM;
window.calcularClasificacionTUG = calcularClasificacionTUG;
window.calcularClasificacionUnipodal = calcularClasificacionUnipodal;

})(); // Cierre de la función anónima principal

// ========== FUNCIONES DE DEBUG GLOBALES ==========

// Función de diagnóstico mejorada
window.diagnosticarHistoriales = function(run = '10.000.141-1') {
    console.log('🔍 [DIAGNÓSTICO] Iniciando diagnóstico de historiales...');
    
    const elementos = [
        'historialPieDiabetico',
        'historialCuraciones', 
        'historialEkg',
        'historialHipoglicemias',
        'historialAmputacion',
        'historialInsulina',
        'historialPodologia',
        'historialFondoOjos'
    ];
    
    console.log('📋 [DOM] Verificando elementos del DOM...');
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        console.log(`${elemento ? '✅' : '❌'} ${id}: ${elemento ? 'Encontrado' : 'NO ENCONTRADO'}`);
    });
    
    console.log('🔍 [DIAGNÓSTICO] Diagnóstico completado - Revisa los resultados arriba');
};

// Función simplificada para probar endpoints directamente
window.probarEndpoint = async function(endpoint, nombre) {
    console.log(`🧪 [ENDPOINT] Probando ${nombre}: ${endpoint}`);
    try {
        const response = await fetch(endpoint, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token') || 'NO_TOKEN'}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log(`✅ [${nombre}] Status: ${response.status}`, data);
        } else {
            console.log(`❌ [${nombre}] Status: ${response.status}`, await response.text());
        }
    } catch (error) {
        console.error(`❌ [${nombre}] Error:`, error);
    }
};

// Función para probar todos los endpoints de diabetes
window.probarEndpointsDiabetes = async function(run = '10.000.141-1') {
    console.log('🚀 [ENDPOINTS] Probando todos los endpoints de diabetes...');
    
    const endpoints = [
        [`/api/examenes/pie_dm/historial/${run}`, 'Pie Diabético'],
        [`/api/examenes/curaciones_piedm/historial/${run}`, 'Curaciones'],
        [`/api/examenes/ekg/${run}`, 'EKG'],
        [`/api/diabetes/hipoglicemias/historial/${run}`, 'Hipoglicemias'],
        [`/api/examenes/fondo_ojos/historial/${run}`, 'Fondo de Ojos'],
        [`/api/diabetes/podologia/historial/${run}`, 'Podología']
    ];
    
    for (const [endpoint, nombre] of endpoints) {
        await probarEndpoint(`http://127.0.0.1:8000${endpoint}`, nombre);
        await new Promise(resolve => setTimeout(resolve, 500)); // Pausa de 500ms entre requests
    }
    
    console.log('✅ [ENDPOINTS] Prueba de endpoints completada');
};

// Inicializar fechas al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar fecha de actividad física
    const fechaActividadFisica = document.getElementById('fechaActividadFisica');
    if (fechaActividadFisica) {
        fechaActividadFisica.value = new Date().toISOString().split('T')[0];
    }
    
    // Inicializar fecha de MasAma
    const fechaMasAma = document.getElementById('fechaMasAma');
    if (fechaMasAma) {
        fechaMasAma.value = new Date().toISOString().split('T')[0];
    }

    // ============ CARGA AUTOMÁTICA DESDE PÁGINA DETALLE ============
    // Nota: Este código se movió al final del script para asegurar que todas las funciones estén disponibles

    // ---- FIX MANDRAKEBOT: Timing correcto del DOM ----
    console.log('🤖 Inicializando MandrakeBot con DOM listo...');
    
    // 1) Referencias únicas
    const btnMandrakeBot = document.getElementById('btn-mandrake-bot');
    const chatOverlay     = document.getElementById('mandrake-chat-overlay');
    const chatClose       = document.getElementById('mandrake-chat-close');
    const chatMessages    = document.getElementById('mandrake-chat-messages');
    const chatInput       = document.getElementById('mandrake-chat-input');
    const chatSend        = document.getElementById('mandrake-chat-send');

    if (!btnMandrakeBot || !chatOverlay) {
        console.error('❌ MandrakeBot button/overlay not found; verifica IDs y orden de carga');
        console.log('Elementos encontrados:', {
            btnMandrakeBot: !!btnMandrakeBot,
            chatOverlay: !!chatOverlay,
            chatClose: !!chatClose,
            chatMessages: !!chatMessages,
            chatInput: !!chatInput,
            chatSend: !!chatSend
        });
        return;
    }

    console.log('✅ MandrakeBot elementos encontrados correctamente');

    // 2) Abrir/cerrar
    const open = () => {
        console.log('🤖 Abriendo MandrakeBot...');
        chatOverlay.style.display = 'flex';
        chatInput?.focus();
        
        // Mensaje de bienvenida si es la primera vez
        if (chatMessages && chatMessages.children.length === 1) {
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'mandrake-message system';
            welcomeMsg.innerHTML = '¡Hola! 👋<br><br>Escribe "<strong>demo</strong>" para ver autocompletado o haz consultas médicas.<br><br>Ejemplos:<br>• "Paciente diabético de 60 años"<br>• "Síntomas de hipertensión"<br>• "demo" para datos de prueba';
            chatMessages.appendChild(welcomeMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    };
    
    const close = () => {
        console.log('🤖 Cerrando MandrakeBot...');
        chatOverlay.style.display = 'none';
    };

    // 3) Listeners (una sola vez)
    btnMandrakeBot.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('🤖 Click en botón MandrakeBot');
        open();
    });
    
    chatClose?.addEventListener('click', close);
    
    chatOverlay.addEventListener('click', (e) => { 
        if (e.target === chatOverlay) close(); 
    });
    
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
            e.preventDefault(); 
            (chatOverlay.style.display === 'flex' ? close() : open());
        }
        if (e.key === 'Escape' && chatOverlay.style.display === 'flex') close();
    });

    // 4) Enviar mensaje mejorado con autollenado inmediato
    
    // Función auxiliar para mostrar alertas visuales
    function showAlert(message, type) {
        // Crear elemento de alerta
        const alert = document.createElement('div');
        alert.className = `mandrake-alert mandrake-alert-${type}`;
        alert.innerHTML = message;
        
        // Estilos dinámicos
        const alertStyles = {
            success: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;',
            warning: 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;',
            error: 'background: #f8d7da; color: #721c24; border: 1px solid #f1b0b7;'
        };
        
        alert.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            ${alertStyles[type] || alertStyles.success}
        `;
        
        // Agregar animación CSS si no existe
        if (!document.getElementById('mandrake-alert-styles')) {
            const style = document.createElement('style');
            style.id = 'mandrake-alert-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(alert);
        
        // Auto-remover después de 4 segundos
        setTimeout(() => {
            alert.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        }, 4000);
        
        // Permitir cerrar con click
        alert.addEventListener('click', () => {
            alert.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        });
    }
    
    // Función para minimizar MandrakeBot
    function minimizeMandrakeBot() {
        const chatOverlay = document.getElementById('mandrake-chat-overlay');
        const chatNotification = document.createElement('div');
        
        if (!chatOverlay) return;
        
        // Ocultar el chat overlay
        chatOverlay.style.display = 'none';
        
        // Mostrar notificación de minimización
        chatNotification.className = 'mandrake-minimize-notification';
        chatNotification.innerHTML = `
            <div style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                z-index: 1001;
                font-size: 14px;
                animation: slideInUp 0.3s ease-out;
                cursor: pointer;
                user-select: none;
            " onclick="this.remove()">
                🤖 MandrakeBot minimizado. Revisa los campos destacados.
                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                    Click para cerrar esta notificación
                </div>
            </div>
        `;
        
        // Agregar animación CSS si no existe
        if (!document.getElementById('mandrake-minimize-styles')) {
            const style = document.createElement('style');
            style.id = 'mandrake-minimize-styles';
            style.textContent = `
                @keyframes slideInUp {
                    from { transform: translateY(100%); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(chatNotification);
        
        // Auto-remover la notificación después de 8 segundos
        setTimeout(() => {
            if (chatNotification.parentNode) {
                chatNotification.style.transition = 'all 0.3s ease-out';
                chatNotification.style.transform = 'translateY(100%)';
                chatNotification.style.opacity = '0';
                setTimeout(() => {
                    if (chatNotification.parentNode) {
                        chatNotification.parentNode.removeChild(chatNotification);
                    }
                }, 300);
            }
        }, 8000);
        
        console.log('🤖 MandrakeBot minimizado - usuario puede revisar formulario');
    }
    
    chatSend?.addEventListener('click', sendMandrakeMessage);
    chatInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            sendMandrakeMessage(); 
        }
    });

    // 5) Respaldo global (si mantienes onclick="openMandrakeBot()")
    window.openMandrakeBot = open;
    
    console.log('🤖 MandrakeBot inicializado correctamente!');
});

</script>

<!-- Chat MandrakeBot -->
<div id="mandrake-chat-overlay">
  <div id="mandrake-chat-container">
    <div id="mandrake-chat-header">
      <div>
        <h3 style="margin:0;font-size:18px;font-weight:600;">🤖 MandrakeBot</h3>
        <p style="margin:0;font-size:12px;opacity:0.9;">Asistente médico inteligente</p>
      </div>
      <button id="mandrake-chat-close">&times;</button>
    </div>
    
    <div id="mandrake-chat-messages">
      <div class="mandrake-message bot">
        ¡Hola! Soy MandrakeBot, tu asistente médico inteligente. 👋<br><br>
        Puedo ayudarte con:
        <ul style="margin:8px 0;padding-left:20px;">
          <li>Autocompletar formularios médicos</li>
          <li>Sugerir diagnósticos basados en síntomas</li>
          <li>Validar datos clínicos</li>
          <li>Interpretar resultados de exámenes</li>
          <li>Recordar protocolos médicos</li>
        </ul>
        ¿En qué puedo ayudarte hoy?
      </div>
    </div>
    
    <div id="mandrake-chat-input-container">
      <input type="text" id="mandrake-chat-input" placeholder="Escribe tu consulta médica..." maxlength="500">
      <button id="mandrake-chat-send">Enviar</button>
    </div>
  </div>
</div>

<!-- Mandrake API disponible globalmente -->
<script>
// ---- MANDRAKE API: Sistema de autocompletado de formularios ----
(function () {
  const FIELD_MAP = {
    run:              ['#run'],
    nombre:           ['#nombre'],
    sexo:             ['#sexo'],
    fecha_nacimiento: ['#fecha_nacimiento'],
    edad:             ['#edad'],
    direccion:        ['#direccion'],
    telefono:         ['#telefono'],
    nivel_educacion:  ['#nivel_educacion'],
    origen_etnico:    ['#origen_etnico'],
    sector_id:        ['#sector_id'],
    categoria:        ['#categoria']
  };

  const _pad2 = n => String(n).padStart(2, '0');
  const _toISO = v => {
    if (!v) return '';
    const s = String(v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})$/);
    if (!m) return s;
    return `${m[3]}-${_pad2(m[2])}-${_pad2(m[1])}`;
  };
  
  const _calcEdad = iso => {
    try {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(+d)) return '';
      const t = new Date();
      let e = t.getFullYear() - d.getFullYear();
      const m = t.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && t.getDate() < d.getDate())) e--;
      return e >= 0 ? String(e) : '';
    } catch { return ''; }
  };

  function setValue(selArr, value) {
    selArr.forEach(sel => {
      const el = document.querySelector(sel);
      if (!el) return;
      if (el.type === 'date') {
        const iso = _toISO(value);
        if (iso) el.value = iso;
      } else if (el.tagName === 'SELECT') {
        el.value = value ?? '';
      } else if (el.hasAttribute('readonly')) {
        el.value = value ?? '';
      } else {
        el.value = value ?? '';
      }
    });
  }

  // Sistema de destacado de campos modificados
  const highlightedFields = new Set();
  const highlightedTabs = new Set();

  function highlightField(selector) {
    const el = (typeof selector==='string')? document.querySelector(selector) : selector;
    if(!el) return;
    el.classList.add('mandrake-modified');
    if(typeof selector==='string') highlightedFields.add(selector);
    const tab = el.closest('[data-panel]');
    if(tab){ const tabName = tab.getAttribute('data-panel'); highlightTab(tabName); }
  }
  function highlightTab(tabName) {
    const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
    if (tabButton && !tabButton.classList.contains('mandrake-tab-modified')) {
      tabButton.classList.add('mandrake-tab-modified');
      highlightedTabs.add(tabName);
      
      // Agregar indicador visual en la pestaña
      if (!tabButton.querySelector('.mandrake-indicator')) {
        const indicator = document.createElement('span');
        indicator.className = 'mandrake-indicator';
        indicator.innerHTML = '●';
        indicator.title = 'Modificado por MandrakeBot';
        tabButton.appendChild(indicator);
      }
    }
  }

  function clearHighlights() {
    // Limpiar campos
    highlightedFields.forEach(selector => {
      const el = document.querySelector(selector);
      if (el) el.classList.remove('mandrake-modified');
    });
    highlightedFields.clear();

    // Limpiar pestañas
    highlightedTabs.forEach(tabName => {
      const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
      if (tabButton) {
        tabButton.classList.remove('mandrake-tab-modified');
        const indicator = tabButton.querySelector('.mandrake-indicator');
        if (indicator) indicator.remove();
      }
    });
    highlightedTabs.clear();
  }


  // API pública
  window.Mandrake = {
    apply(raw, { autoEdad = true } = {}) {
      const data = typeof raw === 'string' ? JSON.parse(raw) : (raw || {});
      if (data.fecha_nacimiento) {
        data.fecha_nacimiento = _toISO(data.fecha_nacimiento);
      }
      if (autoEdad && !data.edad && data.fecha_nacimiento) {
        data.edad = _calcEdad(data.fecha_nacimiento);
      }
      
      // Contar campos que realmente van a cambiar
      let fieldsToModify = 0;
      Object.entries(FIELD_MAP).forEach(([k, sels]) => {
        if (data[k] !== undefined && data[k] !== null && data[k] !== '') {
          sels.forEach(sel => {
            const el = document.querySelector(sel);
            if (el && (el.value || '') !== (data[k] || '')) {
              fieldsToModify++;
            }
          });
        }
      });

      // Aplicar cambios
      Object.entries(FIELD_MAP).forEach(([k, sels]) => {
        if (data[k] !== undefined && data[k] !== null && data[k] !== '') {
          setValue(sels, data[k]);
        }
      });

      // Mostrar notificación de revisión si se modificaron campos
      if (fieldsToModify > 0) {
        showReviewNotification(fieldsToModify);
      }
      
      // Actualizar resumen visual
      const spRun = document.querySelector('[data-f="run"]');
      if (spRun && data.run) spRun.textContent = data.run;
      const spNom = document.querySelector('[data-f="nombre_completo"]');
      if (spNom && (data.nombre || data.nombre_completo)) {
        spNom.textContent = data.nombre || data.nombre_completo;
      }
      const spFn = document.querySelector('[data-f="fecha_nacimiento"]');
      if (spFn && data.fecha_nacimiento) spFn.textContent = data.fecha_nacimiento;
      const spEdad = document.querySelector('[data-f="edad"]');
      if (spEdad && data.edad) spEdad.textContent = data.edad;
      const spSexo = document.querySelector('[data-f="sexo"]');
      if (spSexo && data.sexo) spSexo.textContent = data.sexo;

      try {
        window.renderMandrakeSummary && window.renderMandrakeSummary(data, { source: 'mandrake.apply' });
      } catch (err) {
        console.warn('Mandrake summary render failed', err);
      }

      console.log('🤖 Mandrake.apply() ejecutado:', data);
      return data;
    }
  };
  
  window.MandrakeApply = (data) => window.Mandrake.apply(data);
})();
</script>

<!-- MandrakePaste: Parser de textos clínicos -->
<script>
(function(){
  // ============ Helpers de normalización ============
  const _pad2 = n => String(n).padStart(2,'0');
  const _toISO = (s) => {
    if(!s) return '';
    s = String(s).trim();
    // YYYY-MM-DD
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // dd-mm-aaaa | dd/mm/aaaa | dd.mm.aaaa
    const m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
    if(!m) return '';
    const y = m[3].length===2 ? ('20'+m[3]) : m[3];
    return `${y}-${_pad2(m[2])}-${_pad2(m[1])}`;
  };
  const _sanitizeRun = s => (s||'').replace(/[.\s-]/g,'').toUpperCase();
  const _onlyDigits = s => (s||'').replace(/[^\d]/g,'');
  const _num = (s) => {
    if(s==null) return null;
    let t = String(s).trim();
    if(!t) return null;
    if(/,\d{1,3}$/.test(t)){
      t = t.replace(/\./g,'').replace(',', '.');
    } else {
      t = t
        .replace(/\s+/g,'')
        .replace(/(\d)[\.·](?=\d{3}(?:[^0-9]|$))/g,'$1')
        .replace(/,(?=\d{3}(?:[^0-9]|$))/g,'');
    }
    const v = parseFloat(t);
    return Number.isFinite(v)? v : null;
  };
  const _pickLineOrNext = (text, pattern) => {
    const re = pattern instanceof RegExp ? pattern : new RegExp(pattern, 'i');
    const lines = String(text||'').split(/\r?\n/);
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      if(!re.test(line)) continue;
      const colonMatch = line.match(/:\s*(.+)$/);
      if(colonMatch && colonMatch[1].trim()) return colonMatch[1].trim();
      const stripped = line.replace(re,'').replace(/^[\s:.-]+/,'').trim();
      if(stripped) return stripped;
      for(let j=i+1;j<lines.length;j++){
        const candidate = lines[j].trim();
        if(candidate) return candidate;
      }
    }
    return null;
  };
  const _calcEdad = (y, m, d) => {
    try{
      const dob = new Date(Number(y), Number(m)-1, Number(d));
      if(isNaN(+dob)) return null;
      const t = new Date();
      let e = t.getFullYear()-dob.getFullYear();
      const mm = t.getMonth()-dob.getMonth();
      if(mm<0 || (mm===0 && t.getDate()<dob.getDate())) e--;
      return e;
    }catch{ return null; }
  };
  
  const SECTION_RULES = [
    { key:'motivo_consulta', re:/^Motivo(?:\s+de)?\s+consulta\b/i },
    { key:'enfermedad_actual', re:/^(?:Anamnesis|Enfermedad\s+actual|Historia\s+actual|Historial\s+de\s+la\s+enfermedad|Motivo\s+de\s+consulta\s+detallado)\b/i },
    { key:'estudios_relevantes', re:/^(?:Estudios|Ex[áa]menes|Resultados|Laboratorios?|Imagen(?:es)?|Examenes\s+complementarios)\b/i },
    { key:'condiciones_riesgos', re:/^(?:Condiciones|Factores\s+de\s+riesgo|Antecedentes|Riesgos\s+asociados|Comorbilidades)\b/i },
    { key:'indicaciones', re:/^(?:Indicaciones|Plan\s+de\s+cuidado|Plan\s+de\s+tratamiento|Conducta|Manejo)\b/i },
    { key:'funcionalidad', re:/^(?:Funcionalidad|Evaluaci[oó]n\s+funcional|Barthel|Lawton|Katz|EFAM|EMPAM|Autovalencia)\b/i },
    { key:'actividades_programadas', re:/^(?:Actividades|Derivaciones|Seguimiento|Tareas|Pr[oó]ximos\s+controles)\b/i },
    { key:'formularios_realizados', re:/^(?:Formularios|Cuestionarios|Escalas|Instrumentos)\b/i },
    { key:'empam', re:/^(?:EMPAM|EFAM|Aplicaci[oó]n\s+EMPAM|Aplicaci[oó]n\s+EFAM)\b/i },
    { key:'atencion_familiar', re:/^Atenci[oó]n\s+Familiar\b/i }
  ];

  const SECTION_STOP_RX = /^(?:Diagn[oó]sticos?|Cierre\s+diagn[oó]stico|Resumen\s+diagn[oó]stico)\b/i;

  function _matchSection(line){
    if(!line) return null;
    const cleaned = line.replace(/[:：\-]+$/,'').trim();
    return SECTION_RULES.find(rule => rule.re.test(cleaned)) || null;
  }

  function _extractSections(text){
    const sections = {};
    if(!text) return sections;
    const lines = String(text).split(/\r?\n/);
    let current = null;
    for(const rawLine of lines){
      const trimmed = rawLine.trim();
      if(!trimmed) continue;
      if(SECTION_STOP_RX.test(trimmed)){
        current = null;
        continue;
      }
      const match = _matchSection(trimmed);
      if(match){
        current = match.key;
        if(!sections[current]) sections[current] = [];
        let remainder = '';
        const colonParts = trimmed.split(/:\s*/);
        if(colonParts.length>1){
          remainder = colonParts.slice(1).join(': ').trim();
        } else {
          remainder = trimmed.replace(match.re,'').trim();
        }
        if(remainder) sections[current].push(remainder);
        continue;
      }
      if(current){
        sections[current].push(trimmed);
      }
    }
    Object.keys(sections).forEach(key => {
      const joined = sections[key].join('\n').trim();
      if(joined) sections[key] = joined; else delete sections[key];
    });
    return sections;
  }

  function _splitListBlock(text){
    if(!text) return [];
    return String(text)
      .split(/\r?\n+/)
      .map(line => line.replace(/^(?:[\d]+(?:[\.\)]|\s)|[-•*])\s*/,'').trim())
      .filter(Boolean);
  }

  function _parseEmpamBlock(text){
    if(!text) return null;
    const base = String(text);
    const empam = { texto: base.trim() };
    const puntaje = base.match(/Puntaj[eé]\s*[:=]\s*(\d{1,3})/i);
    if(puntaje) empam.puntaje = Number(puntaje[1]);
    const clas = base.match(/Clasificaci[oó]n\s*[:=]\s*([^\n]+)/i);
    if(clas) empam.clasificacion = clas[1].trim();
    const sub = base.match(/Sub[áa]reas?\s*[:=]\s*([^\n]+)/i);
    if(sub) empam.subareas = sub[1].trim();
    const resumen = base.match(/Resumen\s*[:=]\s*([^\n]+)/i);
    if(resumen) empam.resumen = resumen[1].trim();
    return empam;
  }
  
  // ============ Extractores (regex robustos para español clínico) ============
  const RX = {
    rut: /R\.?U\.?T\.?\s*:\s*([0-9.\-Kk]+)/i,
    nombre: /Nombre\s*:\s*(?:\([^)]+\)\s*)?([A-Za-zÁÉÍÓÚÑÜäëïöüáéíóúñü'´` ]{3,})/i,
    edad_det: /Edad\s*:\s*(\d{1,3})\s*años(?:\s*(\d{1,2})\s*mes(?:es)?)?(?:\s*(\d{1,2})\s*d[ií]as?)?/i,
    fecha_hora: /Fecha\s*y\s*Hora\s*de\s*atenci[oó]n\s*:\s*([0-9\/\-.]{8,10})\s+([0-9:]{4,5})/i,
    funcionario: /Funcionario(?:\(s\)\s*que\s*participa\(n\))?\s*:\s*([^\n]+)/i,
    profesion: /Profes[ií]o[nm]\s*:\s*([^\n]+)/i,
    establecimiento: /Establecimiento\s*:\s*([^\n]+)/i,
    procedencia: /Procedencia\s*:\s*([^\n]+)/i,
    tipo_consulta: /Tipo\s+de\s+consulta\s*:\s*([^\n]+)/i,
    pa: /Presi[oó]n\s*Arterial\s*\(mmHg\)\s*:\s*(\d{2,3})\s*\/\s*(\d{2,3})/i,
    pulso: /Pulso.*?:\s*(\d{2,3})\b/i,
    hgt: /Hemoglucotest.*?:\s*([0-9.,]+)\b/i,
    peso: /Peso\s*\(Kg\)\s*:\s*([0-9.,]+)\b/i,
    talla: /Talla\s*\(cm\)\s*:\s*([0-9.,]+)\b/i,
    imc: /I\.?M\.?C\.?(?:\s*\*?)?\s*:\s*([0-9.,]+)\b/i,
    cc: /Circunferencia\s*de\s*Cintura.*?:\s*([0-9.,]+)\b/i,
    hba1c: /Hb?a1c?\s*[:=]?\s*([0-9.,]+)\b/i,
  ldl: /\b(?:LDL|C(?:olesterol)?\s*LDL)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  glicemia: /\b(?:glic(?:emia)?|glucosa|gpa)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  hdl: /\b(?:HDL(?:-C)?|C(?:olesterol)?\s*HDL)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  col_total: /\b(?:Col(?:esterol)?\s*(?:Total|Tot)|C\/T|CT)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  trigliceridos: /\b(?:Triglic[ée]ridos?|TAG|TG\b)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  creatinina: /\b(?:Creatin(?:ina|emia|inemia)|Cr(?:s|e)?|CrS)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  sodio: /\b(?:Sodio|Na(?:\s*seric[oa])?)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  potasio: /\b(?:Potasio|K(?:\s*seric[oa])?)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  cloro: /\b(?:Clor[oa]?|Cloruro|Cl)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  uremia: /\b(?:Uremia|Urea)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  bun: /\bNitr[oó]geno\s+Ureico\b[^0-9]{0,8}([0-9.,]+)\b/i,
  vfg: /\b(?:VFG|TFG|eGFR|TFGe)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  rac: /\b(?:RAC|Í?NDICE\s*MAU\s*\/?\s*CREA(?:U)?|MAU\s*\/?\s*CREA(?:U)?)\b[^0-9]{0,10}([0-9.,]+)\b/i,
  microalbuminuria: /\b(?:Micro(?:albuminuria|alb)|MAU)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  hematocrito: /\b(?:Hematocrito|Hto\.?|HCT)\b[^0-9]{0,6}([0-9.,]+)\b/i,
  hemoglobina: /\b(?:Hemoglobina(?:\s+Total)?|Hb\s*(?!a1c|A1c))\b[^0-9]{0,6}([0-9.,]+)\b/i,
  leucocitos: /\b(?:Leucocitos|Leu(?:cocitos)?|Rct(?:o)?\.?\s*de\s*Leucocitos)\b[^0-9]{0,10}([0-9.,]+)\b/i,
  plaquetas: /\b(?:Plaquetas|Plaq\.?|Rct(?:o)?\.?\s*de\s*Plaquetas)\b[^0-9]{0,10}([0-9.,]+)\b/i,
  vcm: /\bVCM\b[^0-9]{0,6}([0-9.,]+)\b/i,
  hcm: /\bHCM\b[^0-9]{0,6}([0-9.,]+)\b/i,
    tsh: /\bTSH\b[^0-9]{0,5}([0-9.,]+)\b/i,
    fecha_examen: /(?:Fecha\s*(?:de\s*)?(?:examen|toma|muestra)|Examen\s*fecha)\s*[:=]?\s*([0-9\/\.\-]{8,10})/i,
    // bloque diagnósticos: desde "Diagnóstico(s)" hasta el siguiente encabezado relevante
    diagBlock: /Diagn[oó]sticos?[\s\S]{0,6}\n([\s\S]*?)(?:\n\s*(?:Actividades|Indicaciones|Funcionalidad|Formularios|Principales|Atenciones?|Examen(?:es)?|Condiciones)\b)/i
  };

  const PROFESION_CANON_DIRECT = {
    'medico': 'medico',
    'medica': 'medico',
    'medico a': 'medico',
    'medico tratante': 'medico',
    'doctor': 'medico',
    'doctora': 'medico',
    'dr': 'medico',
    'dra': 'medico',
    'enfermera': 'enfermero',
    'enfermero': 'enfermero',
    'enfermero a': 'enfermero',
    'enfermeria': 'enfermero',
    'tens': 'enfermero',
    'tec enf': 'enfermero',
    'tecnico en enfermeria': 'enfermero',
    'tecnica en enfermeria': 'enfermero',
    'nutricionista': 'nutricionista',
    'nutricionista a': 'nutricionista',
    'trabajador social': 'asistente social',
    'trabajadora social': 'asistente social',
    'asistente social': 'asistente social',
    'politaco': 'politaco',
    'politaca': 'politaco',
    'visita': 'VDI',
    'visita domiciliaria': 'VDI',
    'visita domiciliaria integral': 'VDI',
    'visita domiciliaria programada': 'VDI',
    'vdi': 'VDI'
  };

  const PROFESION_CANON_HEURISTICS = [
    { re: /^medic[oa]\b/, value: 'medico' },
    { re: /^drs?\b/, value: 'medico' },
    { re: /^doctora?\b/, value: 'medico' },
    { re: /^enfermer[oa]\b/, value: 'enfermero' },
    { re: /^tec(?:nico|nica)?\s+en\s+enfermer/, value: 'enfermero' },
    { re: /^nutricionist[ao]\b/, value: 'nutricionista' },
    { re: /^asistente\s+social\b/, value: 'asistente social' },
    { re: /^trabajador(?:a)?\s+social\b/, value: 'asistente social' },
    { re: /^politac[oa]\b/, value: 'politaco' },
    { re: /^visita(?:\s+domiciliaria(?:\s+integral)?)?$/, value: 'VDI' },
    { re: /^vdi\b/, value: 'VDI' }
  ];

  function normalizeProfesionValue(value, { allowHeuristics = true } = {}) {
    if(value==null) return null;
    const original = String(value).trim();
    if(!original) return null;
    const base = original
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g,' ')
      .trim();
    if(!base) return null;
    const compact = base.replace(/\s+/g,'');
    const direct = PROFESION_CANON_DIRECT[base] ?? PROFESION_CANON_DIRECT[compact];
    if(direct) return direct;
    if(!allowHeuristics) return null;
    for(const rule of PROFESION_CANON_HEURISTICS){
      if(rule.re.test(base)) return rule.value;
    }
    return null;
  }

  // Conversión aproximada de mmol/L a mg/dL para algunos analitos comunes
  function _convertIfMmol(label, value, originalText){
    // Detecta si en el contexto cercano aparece 'mmol' y no 'mg'
    if(value==null) return value;
    const txt = originalText || '';
    // ventana: 40 caracteres alrededor del número (simple)
    // si el bloque contiene 'mmol' y no contiene 'mg/dl' asumimos mmol/L
    const mmol = /mmol/i.test(txt);
    const hasMg = /mg\s*\/\s*d?l/i.test(txt);
    if(!mmol || hasMg) return value; // ya está en mg/dL o no hay marca mmol
    // factores (mg/dL = mmol/L * factor)
    const FACTORS = { glicemia:18, glic:18, glucosa:18, hba1c:1, ldl:38.67, hdl:38.67, col:38.67, col_total:38.67, trigliceridos:88.5, tag:88.5 };
    const f = FACTORS[label];
    if(!f) return value; // sin factor definido
    return +(value * f).toFixed(1);
  }

  function _cleanNombre(n){
    if(!n) return '';
    // remueve alias iniciales: "(Patricio) Patricio Pino Reyes" -> "Patricio Pino Reyes"
    return String(n).replace(/^\([^)]*\)\s*/,'').replace(/\s{2,}/g,' ').trim();
  }

  function _pick(text, rx, idx=1){ const m = text.match(rx); return m? m[idx] : null; }

  function parseClinicalFreeText(text){
    const t = String(text||'');
    const out = {};
    const sections = _extractSections(t);
    if(Object.keys(sections).length){
      const anamCanon = normalizeProfesionValue(sections.enfermedad_actual, { allowHeuristics: false });
      if(anamCanon) sections.enfermedad_actual = anamCanon;
      out.mandrake_sections = sections;
    }

    // RUN
    const rutRaw = _pick(t, RX.rut);
    if(rutRaw){
      const compact = _sanitizeRun(rutRaw);
      if(/^\d{7,9}[0-9K]$/i.test(compact)){
        out.run = compact.slice(0, -1) + '-' + compact.slice(-1);
      }else{
        // si no calza, al menos guarda compactado sin guión
        out.run = compact;
      }
    }

    // Nombre
    const nombre = _cleanNombre(_pick(t, RX.nombre));
    if(nombre) out.nombre = nombre;

    // Edad
    const em = t.match(RX.edad_det);
    if(em){
      const a = _num(em[1]), me = _num(em[2]), d = _num(em[3]);
      // si no hay fecha de nacimiento, al menos setear edad numérica
      if(a!=null) out.edad = String(a);
      const det = {};
      if(a!=null) det.years = a;
      if(me!=null) det.months = me;
      if(d!=null) det.days = d;
      if(Object.keys(det).length) out.edad_detallada = det;
    }

    // Fecha/Hora de atención
    const fhm = t.match(RX.fecha_hora);
    if(fhm){
      const fISO = _toISO(fhm[1]);
      if(fISO) out.fecha_atencion = fISO;
      out.hora_atencion = fhm[2];
    }

    let funcionario = _pick(t, RX.funcionario);
    if(!funcionario) funcionario = _pickLineOrNext(t, /Funcionario(?:\(s\)|\s*\(s\)\s*prestador\(es\))?/i);
    if(funcionario){
      const cleanedFuncionario = funcionario.replace(/\s{2,}/g,' ').trim();
  const profGuess = cleanedFuncionario.match(/\b(M[eé]dico(?:a)?|Enfermer[oa](?:\(a\))?|Kinesi[oó]log[oa]|Nutricionist[ao]|Trabajador(?:a)?\s+Social|Asistente\s+Social|Psic[oó]log[oa]|Matron[ao]|Fonoaudi[oó]log[oa]|TENS?|Tec\.\s*Enf\.?|Qu[ií]mico\s+Farmac[eé]utico|Politac[oa]|VDI|Visita(?:\s+Domiciliaria(?:\s+Integral)?)?|Dr\.?|Dra\.?)\b/i);
      if(profGuess){
        const rawProf = profGuess[0].replace(/\s+/g,' ').trim();
        const canonProf = normalizeProfesionValue(rawProf) || rawProf;
        if(!out.profesion) out.profesion = canonProf;
        const nameOnly = cleanedFuncionario.replace(profGuess[0], '').trim().replace(/[,-]$/, '').trim();
        out.funcionario = nameOnly || cleanedFuncionario;
      } else {
        out.funcionario = cleanedFuncionario;
      }
    }

    let profesion = _pick(t, RX.profesion);
    if(!profesion) profesion = _pickLineOrNext(t, /Profes[ií]o[nm]/i);
    if(profesion) out.profesion = (out.profesion || profesion.trim());

    if(out.profesion){
      const profCanon = normalizeProfesionValue(out.profesion) || out.profesion.trim();
      out.profesion = profCanon;
    }

    let establecimiento = _pick(t, RX.establecimiento);
    if(!establecimiento) establecimiento = _pickLineOrNext(t, /Establecimiento/i);
    if(establecimiento) out.establecimiento = establecimiento.trim();

    let procedencia = _pick(t, RX.procedencia);
    if(!procedencia) procedencia = _pickLineOrNext(t, /Procedencia/i);
    if(procedencia) out.procedencia = procedencia.trim();

    let tipoConsulta = _pick(t, RX.tipo_consulta);
    if(!tipoConsulta) tipoConsulta = _pickLineOrNext(t, /Tipo\s+de\s+consulta/i);
    if(tipoConsulta) out.tipo_consulta = tipoConsulta.trim();

    // Signos vitales / antropometría
    const pa = t.match(RX.pa);
    if(pa){ out.presion_sistolica = _num(pa[1]); out.presion_diastolica = _num(pa[2]); }
    const pulso = _pick(t, RX.pulso);
    if(pulso) out.pulso = _num(pulso);
    const hgt = _pick(t, RX.hgt);
    if(hgt) out.hgt = _num(hgt);
    const peso = _pick(t, RX.peso);
    if(peso!=null) out.peso = _num(peso);
    const talla = _pick(t, RX.talla);
    if(talla!=null) out.talla = _num(talla);
    const imc = _pick(t, RX.imc);
    if(imc!=null) out.imc = _num(imc);
    const cc = _pick(t, RX.cc);
    if(cc!=null) out.cc = _num(cc);

    // Labs ampliados
  const hba = _pick(t, RX.hba1c); if(hba!=null) out.hba1c = _convertIfMmol('hba1c', _num(hba), hba);
  const ldl = _pick(t, RX.ldl); if(ldl!=null) out.ldl = _convertIfMmol('ldl', _num(ldl), ldl);
  const glic = _pick(t, RX.glicemia); if(glic!=null) out.glicemia = _convertIfMmol('glicemia', _num(glic), glic);
  const hdl = _pick(t, RX.hdl); if(hdl!=null) out.hdl = _convertIfMmol('hdl', _num(hdl), hdl);
  const col = _pick(t, RX.col_total); if(col!=null) out.col = _convertIfMmol('col', _num(col), col);
  const tag = _pick(t, RX.trigliceridos); if(tag!=null) out.tag = _convertIfMmol('tag', _num(tag), tag);
  const crea = _pick(t, RX.creatinina); if(crea!=null) out.creatinemia = _num(crea);
  const sodio = _pick(t, RX.sodio); if(sodio!=null) out.sodio = _num(sodio);
  const potasio = _pick(t, RX.potasio); if(potasio!=null) out.potasio = _num(potasio);
  const cloro = _pick(t, RX.cloro); if(cloro!=null) out.cloro = _num(cloro);
  const uremia = _pick(t, RX.uremia); if(uremia!=null) out.uremia = _num(uremia);
  const bun = _pick(t, RX.bun); if(bun!=null) out.nitrogeno_ureico = _num(bun);
  const hematocrito = _pick(t, RX.hematocrito); if(hematocrito!=null) out.hematocrito = _num(hematocrito);
  const hemoglobina = _pick(t, RX.hemoglobina); if(hemoglobina!=null) out.hemoglobina = _num(hemoglobina);
  const leucocitos = _pick(t, RX.leucocitos); if(leucocitos!=null) out.leucocitos = _num(leucocitos);
  const plaquetas = _pick(t, RX.plaquetas); if(plaquetas!=null) out.plaquetas = _num(plaquetas);
  const vcm = _pick(t, RX.vcm); if(vcm!=null) out.vcm = _num(vcm);
  const hcm = _pick(t, RX.hcm); if(hcm!=null) out.hcm = _num(hcm);
  const vfg = _pick(t, RX.vfg); if(vfg!=null) out.vfg = _num(vfg);
  const rac = _pick(t, RX.rac); if(rac!=null) out.rac = _num(rac);
  const micro = _pick(t, RX.microalbuminuria); if(micro!=null) out.microalbuminuria_val = _num(micro);
  const tsh = _pick(t, RX.tsh); if(tsh!=null) out.tsh = _num(tsh);
    const fex = _pick(t, RX.fecha_examen); if(fex){ const isoF = _toISO(fex); if(isoF) out.examen_fecha = isoF; }
    if(!out.examen_fecha && out.fecha_atencion){ out.examen_fecha = out.fecha_atencion; }

    // Construir labs[] si hay al menos un valor
    const labFields = [
      'glicemia','hba1c','ldl','hdl','col','tag','creatinemia',
      'sodio','potasio','cloro','uremia','nitrogeno_ureico','vfg','rac',
      'microalbuminuria_val','tsh','hematocrito','hemoglobina','leucocitos',
      'plaquetas','vcm','hcm'
    ];
    const hasLab = labFields.some(k=> out[k]!=null);
    if(hasLab){
      const labObj = { examen_fecha: out.examen_fecha };
      labFields.forEach(k=>{ if(out[k]!=null) labObj[k]=out[k]; });
      out.labs = [labObj];
    }

    // Diagnósticos (lista textual)
    const db = t.match(RX.diagBlock);
    if(db){
      const raw = db[1] || '';
      const normalizedRaw = raw
        .replace(/\)\s+(?=[A-ZÁÉÍÓÚÑ])/g, ')\n')
        .replace(/\b(Repetida|Confirmada|Sospecha|Nueva)\)\s+(?=[A-ZÁÉÍÓÚÑ])/gi, '$1)\n');
      const lines = normalizedRaw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const dx = [];
      const dxDet = [];
      for(const ln of lines){
        if(!ln) continue;
        const cleaned = ln
          .replace(/\(?(Confirmada|Repetida|Nueva|Sospecha|AUGE|GES|Cr[oó]nica|Aguda|Control)\)?/ig,'')
          .replace(/\s{2,}/g,' ')
          .replace(/^[\-\d\.\)]\s*/,'')
          .trim();
        if(!cleaned) continue;
        const detalle = { descripcion: cleaned };
        const codeMatch = ln.match(/\b([A-TV-Z][0-9]{2}(?:\.[0-9A-Z]{1,2})?)\b/);
        if(codeMatch) detalle.codigo = codeMatch[1].toUpperCase();
        const estadoMatch = ln.match(/\b(Confirmada|Sospecha|Repetida|Nueva|Control|Cr[oó]nica|Aguda|GES|AUGE)\b/i);
        if(estadoMatch) detalle.estado = estadoMatch[1];
        dxDet.push(detalle);

        const fragments = cleaned.split(/\s{2,}(?=[A-ZÁÉÍÓÚÑ])/).map(f=>f.trim()).filter(Boolean);
        if(fragments.length){
          fragments.forEach(fragment=>{ if(!dx.includes(fragment)) dx.push(fragment); });
        } else if(!dx.includes(cleaned)){
          dx.push(cleaned);
        }
      }
      if(dx.length) out.diagnosticos = dx;
      if(dxDet.some(item => item.codigo || item.descripcion)) out.diagnosticos_detallados = dxDet;
    }

    if(sections.actividades_programadas){
      const acts = _splitListBlock(sections.actividades_programadas);
      if(acts.length) out.actividades_programadas = acts;
    }

    if(sections.formularios_realizados){
      const forms = _splitListBlock(sections.formularios_realizados);
      if(forms.length) out.formularios_realizados = forms;
    }

    if(!out.empam && sections.empam){
      const empamParsed = _parseEmpamBlock(sections.empam);
      if(empamParsed) out.empam = empamParsed;
    }

    if(!out.empam && sections.funcionalidad && /\b(EFAM|EMPAM)\b/i.test(sections.funcionalidad)){
      const empamAlt = _parseEmpamBlock(sections.funcionalidad);
      if(empamAlt) out.empam = empamAlt;
    }

    // Campos del front que probablemente quieres llenar HOY
    // (ajusta a tus IDs/FIELD_MAP reales)
    const payload = {
      run: out.run,
      nombre: out.nombre,
      // fecha_nacimiento: (no viene en el texto; la edad ya va calculada arriba si aparece DOB)
      edad: (out.edad!=null ? String(out.edad) : undefined),
      edad_detallada: out.edad_detallada,

      // vitals / control
      presion_sistolica: out.presion_sistolica,
      presion_diastolica: out.presion_diastolica,
      hgt: out.hgt,
      peso: out.peso,
      talla: out.talla != null ? (out.talla / 100).toFixed(2) : undefined, // convertir cm a metros
      imc: out.imc,
      cc: out.cc,
      hba1c: out.hba1c,
      ldl: out.ldl,
      glicemia: out.glicemia,
      hdl: out.hdl,
      col: out.col,
      tag: out.tag,
      creatinemia: out.creatinemia,
      vfg: out.vfg,
      rac: out.rac,
      microalbuminuria_val: out.microalbuminuria_val,
      tsh: out.tsh,
      examen_fecha: out.examen_fecha,

      labs: out.labs,

      // metadatos útiles
      fecha_atencion: out.fecha_atencion,
      hora_atencion: out.hora_atencion,
      funcionario: out.funcionario,
      profesion: out.profesion,
      establecimiento: out.establecimiento,
      procedencia: out.procedencia,
      tipo_consulta: out.tipo_consulta,
      diagnosticos: out.diagnosticos,
      diagnosticos_detallados: out.diagnosticos_detallados,
      actividades_programadas: out.actividades_programadas,
      formularios_realizados: out.formularios_realizados,
      atencion_familiar: sections.atencion_familiar,
      empam: out.empam
    };

    if(out.mandrake_sections) payload.mandrake_sections = out.mandrake_sections;

    const mandrakeMeta = {
      fecha_atencion: out.fecha_atencion,
      hora_atencion: out.hora_atencion,
      funcionario: out.funcionario,
      profesion: out.profesion,
      establecimiento: out.establecimiento,
      procedencia: out.procedencia,
      tipo_consulta: out.tipo_consulta,
      edad_detallada: out.edad_detallada
    };
    Object.keys(mandrakeMeta).forEach(k=> (mandrakeMeta[k]==null || mandrakeMeta[k]==='') && delete mandrakeMeta[k]);
    if(Object.keys(mandrakeMeta).length) payload.mandrake_meta = mandrakeMeta;

    // elimina undefined para no contaminar la aplicación
    Object.keys(payload).forEach(k=> (payload[k]===undefined || payload[k]===null) && delete payload[k]);
    return payload;
  }

  // ============ Integración con Mandrake ============
  // Requiere que Mandrake.apply ya esté cargado en la página
  async function pegarYAutollenarDesdeTexto(texto, {overwrite=false} = {}){
    const parsed = parseClinicalFreeText(texto);
    // Mapea a tus inputs. Si ya definiste FIELD_MAP, esto bastará:
    if(window.Mandrake && typeof window.Mandrake.apply === 'function'){
      window.Mandrake.apply(parsed, {overwrite});
    }
    return parsed;
  }

  // ============ API global ============
  window.MandrakePaste = {
    parse: parseClinicalFreeText,
    applyFromText: pegarYAutollenarDesdeTexto
  };

  // (opcional) botón que pide pegar desde el portapapeles
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btn-pegar-texto-clinico');
    if(btn && navigator.clipboard){
      btn.addEventListener('click', async ()=>{
        try{
          const txt = await navigator.clipboard.readText();
          const out = await pegarYAutollenarDesdeTexto(txt, {overwrite:false});
          console.log('[MandrakePaste] parsed:', out);
          alert('Texto pegado y aplicado al formulario ✅');
        }catch(e){
          console.warn('No se pudo leer portapapeles:', e);
          alert('No pude leer el portapapeles. Pega el texto manualmente en un cuadro y te lo proceso.');
        }
      });
    }
  });
})();
</script>

<!-- Parser duplicado removido: unificado al MandrakePaste principal -->

<script>
// === Botón Guardar Todo (control + labs + acuerdos si hay datos) ===
(()=>{
  const btn = document.getElementById('btn-save-all');
  if(!btn) return;
  btn.addEventListener('click', async ()=>{
    if(btn.disabled) return;
    const original = btn.innerHTML;
    const run = document.getElementById('run')?.value?.trim();
    if(!run){ alert('RUN vacío. Busca un usuario primero.'); return; }
    btn.disabled = true; btn.innerHTML = '💾 Guardando...';
    const tareas = [];
    // --- Control ---
    try {
      const f = document.getElementById('form-control-nuevo');
      if(f){
        const fd = new FormData(f);
        const payloadControl = { run };
        ['fecha','profesional','peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{
          const v = fd.get(k); if(v!==null && v!=='') payloadControl[k]=v;
        });
        // Sólo enviar si hay al menos 1 valor numérico
        if(Object.keys(payloadControl).some(k=>k!=='run' && k!=='fecha')){
          tareas.push(fetch('/api/control/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadControl)}));
        }
      }
    } catch(e){ console.warn('Control no guardado', e); }
    // --- Labs ---
    try {
      const lf = document.getElementById('form-lab-nuevo');
      if(lf){
        const fd = new FormData(lf);
        const payloadLab = { run };
        ['examen_fecha','glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'].forEach(k=>{
          const v = fd.get(k); if(v!==null && v!=='') payloadLab[k]=v;
        });
        if(Object.keys(payloadLab).some(k=>k!=='run' && (k!=='examen_fecha'))){
          tareas.push(fetch('/api/labs/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadLab)}));
        }
      }
    } catch(e){ console.warn('Labs no guardado', e); }
    // --- Acuerdos (si hay un texto nuevo sin enviar) ---
    try {
      const fa = document.getElementById('form-acuerdo-nuevo');
      if(fa){
        const fd = new FormData(fa);
        const acuerdos = fd.get('acuerdos')?.trim();
        const cumplimiento = fd.get('cumplimiento')?.trim();
        if(acuerdos && cumplimiento){
          const payloadA = {
            usuario_id: run,
            acuerdos,
            cumplimiento,
            observaciones: fd.get('observaciones')?.trim() || null,
            funcionario: fd.get('funcionario')?.trim() || null,
            fecha_creacion: fd.get('fecha') || null
          };
          tareas.push(fetch('/api/acuerdos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadA)}));
        }
      }
    } catch(e){ console.warn('Acuerdos no guardado', e); }

    // --- Guardar categoría / riesgo (estado programa) ---
    try {
      // Determinar categoría a guardar
      let categoriaGuardar = null;
      const prog = window.programaSeleccionado || 'ECICEP';
      if(prog === 'CARDIO') {
        categoriaGuardar = 'CARDIO';
      } else {
        const elCalc = document.getElementById('riesgo-calculado');
        const elAct = document.getElementById('riesgo-actual');
        const txtCalc = (elCalc?.textContent || '').trim();
        const txtAct = (elAct?.textContent || '').trim();
        if(txtCalc && txtCalc !== '—') categoriaGuardar = txtCalc;
        else if(txtAct && txtAct !== '—') categoriaGuardar = txtAct;
      }
      if(categoriaGuardar && categoriaGuardar !== '—'){
        tareas.push(fetch(`/api/usuarios/${encodeURIComponent(run)}/categoria`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ categoria: categoriaGuardar })
        }));
        // Guardar también programa_modo para auditoría
        tareas.push(fetch(`/api/usuarios/${encodeURIComponent(run)}/programa_modo`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ programa: (window.programaSeleccionado||'ECICEP') })
        }));
        // Preparar mensaje confirmación luego
        window.__ultimaCategoriaGuardada = categoriaGuardar;
      }
    } catch(e){ console.warn('Categoría/riesgo no guardado', e); }

    let ok=0, fail=0;
    try {
      const results = await Promise.allSettled(tareas);
      for(const r of results){
        if(r.status==='fulfilled'){
          try { const jr = await r.value.json(); if(jr.ok) ok++; else fail++; }
          catch{ fail++; }
        } else { fail++; }
      }
    } catch(e){ console.error('Error batch', e); }
    if(ok && window.__ultimaCategoriaGuardada){
      btn.innerHTML = `✅ Categoría ${window.__ultimaCategoriaGuardada} guardada (${ok})`;
    } else {
      btn.innerHTML = ok? `✅ Guardado (${ok})` : (fail? '⚠️ Revise errores' : '💾 Nada que guardar');
    }
    setTimeout(()=>{ btn.innerHTML = original; btn.disabled=false; }, 2500);
  });
})();

// ===== SISTEMA DE ALERTAS DE VIGENCIA =====
console.log('📋 [INIT] Cargando sistema de alertas de vigencia...');

let alertasCache = null;
let alertasReconocidas = false;

function detenerDestelloAlertas() {
  const chipV = document.getElementById('chip-alertas-vencidos');
  const chipF = document.getElementById('chip-alertas-faltantes');
  if (chipV) {
    chipV.classList.remove('blink-rojo');
  }
  if (chipF) {
    chipF.classList.remove('blink-amarillo');
  }
}

function actualizarIndicadoresAlertas(vencidos = 0, faltantes = 0, vigentes = null) {
  const chipV = document.getElementById('chip-alertas-vencidos');
  const chipF = document.getElementById('chip-alertas-faltantes');
  const chipOk = document.getElementById('chip-alertas-ok');

  if (!chipV || !chipF || !chipOk) {
    return;
  }

  const hayDatos = vigentes !== null || vencidos > 0 || faltantes > 0;
  if (!hayDatos) {
    chipV.classList.add('oculta');
    chipF.classList.add('oculta');
    chipOk.classList.add('oculta');
    return;
  }

  if (vencidos > 0) {
    chipV.classList.remove('oculta');
    const countV = chipV.querySelector('.count');
    if (countV) {
      countV.textContent = vencidos > 99 ? '99+' : vencidos;
    }
    if (!alertasReconocidas) {
      chipV.classList.add('blink-rojo');
    } else {
      chipV.classList.remove('blink-rojo');
    }
  } else {
    chipV.classList.add('oculta');
    chipV.classList.remove('blink-rojo');
  }

  if (faltantes > 0) {
    chipF.classList.remove('oculta');
    const countF = chipF.querySelector('.count');
    if (countF) {
      countF.textContent = faltantes > 99 ? '99+' : faltantes;
    }
    if (!alertasReconocidas) {
      chipF.classList.add('blink-amarillo');
    } else {
      chipF.classList.remove('blink-amarillo');
    }
  } else {
    chipF.classList.add('oculta');
    chipF.classList.remove('blink-amarillo');
  }

  if (vigentes !== null && vigentes > 0) {
    chipOk.classList.remove('oculta');
    const countOk = chipOk.querySelector('.count');
    if (countOk) {
      countOk.textContent = vigentes > 99 ? '99+' : Math.max(vigentes, 0);
    }
  } else {
    chipOk.classList.add('oculta');
  }
}

// Función para mostrar modal de alertas
async function mostrarAlertasVigencia() {
  const modal = document.getElementById('modal-alertas-vigencia');
  const contenido = document.getElementById('contenido-alertas');
  
  if (!modal) {
    console.error('❌ Modal de alertas no encontrado');
    return;
  }

  alertasReconocidas = true;
  detenerDestelloAlertas();
  
  // Mostrar modal
  modal.style.display = 'flex';
  
  // Obtener RUN del usuario actual
  const runInput = document.getElementById('run');
  const run = runInput?.value?.trim();
  
  if (!run) {
    contenido.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:16px;">⚠️</div>
        <div style="font-size:1.1rem;color:#dc2626;font-weight:600;">No hay usuario seleccionado</div>
        <div style="margin-top:8px;opacity:0.7;">Por favor, busque un usuario primero</div>
      </div>
    `;
    return;
  }
  
  // Mostrar loading
  contenido.innerHTML = `
    <div style="text-align:center;padding:40px;">
      <div style="font-size:3rem;margin-bottom:16px;">⏳</div>
      <div>Cargando alertas para usuario ${run}...</div>
    </div>
  `;
  
  try {
    // Llamar al endpoint de alertas
    const response = await fetch(`/api/vigencia/alertas/${encodeURIComponent(run)}`);
    
    if (!response.ok) {
      throw new Error(`Error ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Error desconocido');
    }
    
    alertasCache = data.alertas || [];
    renderizarAlertas(alertasCache);
    
  } catch (error) {
    console.error('❌ Error cargando alertas:', error);
    contenido.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:16px;">❌</div>
        <div style="font-size:1.1rem;color:#dc2626;font-weight:600;">Error cargando alertas</div>
        <div style="margin-top:8px;opacity:0.7;">${error.message}</div>
      </div>
    `;
  }
}

// Función para renderizar alertas
function renderizarAlertas(alertas) {
  const contenido = document.getElementById('contenido-alertas');
  
  if (!alertas || alertas.length === 0) {
    contenido.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:3rem;margin-bottom:16px;">✅</div>
        <div style="font-size:1.1rem;color:#059669;font-weight:600;">No hay alertas pendientes</div>
        <div style="margin-top:8px;opacity:0.7;">Todos los controles están al día</div>
      </div>
    `;
    return;
  }
  
  // Agrupar alertas por categoría
  const categorias = {};
  alertas.forEach(alerta => {
    if (!categorias[alerta.categoria]) {
      categorias[alerta.categoria] = [];
    }
    categorias[alerta.categoria].push(alerta);
  });
  
  // Contador de alertas pendientes
  const pendientes = alertas.filter(a => !a.vigente && a.detalle).length;
  const sinDatos = alertas.filter(a => !a.detalle).length;
  const vigentes = alertas.filter(a => a.vigente).length;

  actualizarIndicadoresAlertas(pendientes, sinDatos, vigentes);
  
  // Header con resumen
  let html = `
    <div style="background:#f8fafc;padding:16px;border-radius:8px;margin-bottom:24px;display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
      <div style="text-align:center;padding:12px 20px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="font-size:1.8rem;font-weight:bold;color:#059669;">${alertas.filter(a => a.vigente).length}</div>
        <div style="font-size:0.75rem;opacity:0.7;text-transform:uppercase;">Al día</div>
      </div>
      <div style="text-align:center;padding:12px 20px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="font-size:1.8rem;font-weight:bold;color:#dc2626;">${pendientes}</div>
        <div style="font-size:0.75rem;opacity:0.7;text-transform:uppercase;">Vencidos</div>
      </div>
      <div style="text-align:center;padding:12px 20px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <div style="font-size:1.8rem;font-weight:bold;color:#64748b;">${sinDatos}</div>
        <div style="font-size:0.75rem;opacity:0.7;text-transform:uppercase;">Sin datos</div>
      </div>
    </div>
  `;
  
  // Renderizar por categoría
  const iconosCategorias = {
    'Vacunas': '💉',
    'Screening': '🔎',
    'Diabetes': '🩺',
    'Cardiovascular': '❤️',
    'Adulto Mayor': '👴',
    'Actividad Física': '🚶',
    'Tratamientos': '💊'
  };
  
  Object.keys(categorias).sort().forEach(categoria => {
    const alertasCategoria = categorias[categoria];
    const icono = iconosCategorias[categoria] || '📋';
    
    html += `
      <div style="margin-bottom:24px;">
        <h3 style="margin:0 0 12px;font-size:1.1rem;color:#334155;display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:2px solid #e2e8f0;">
          ${icono} ${categoria}
          <span style="font-size:0.7rem;opacity:0.6;font-weight:normal;">(${alertasCategoria.length})</span>
        </h3>
        <div style="display:grid;gap:8px;">
    `;
    
    alertasCategoria.forEach(alerta => {
      const esVigente = alerta.vigente;
      const tieneDetalle = alerta.detalle && alerta.detalle !== 'Sin datos';
      
      let colorFondo, colorBorde, colorTexto, icono;
      
      if (!tieneDetalle) {
        colorFondo = '#f8fafc';
        colorBorde = '#cbd5e1';
        colorTexto = '#64748b';
        icono = '⚪';
      } else if (esVigente) {
        colorFondo = '#f0fdf4';
        colorBorde = '#86efac';
        colorTexto = '#059669';
        icono = '✅';
      } else {
        colorFondo = '#fef2f2';
        colorBorde = '#fca5a5';
        colorTexto = '#dc2626';
        icono = '⚠️';
      }
      
      html += `
        <div style="padding:12px;background:${colorFondo};border:1px solid ${colorBorde};border-radius:6px;display:flex;justify-content:space-between;align-items:center;gap:12px;">
          <div style="flex:1;">
            <div style="font-size:0.85rem;font-weight:600;color:#334155;margin-bottom:4px;">
              ${icono} ${alerta.descripcion}
            </div>
            <div style="font-size:0.7rem;opacity:0.7;margin-bottom:4px;">
              ${alerta.aplicable}
            </div>
            <div style="font-size:0.75rem;color:${colorTexto};font-weight:600;">
              ${tieneDetalle ? alerta.detalle : 'Sin datos registrados'}
            </div>
          </div>
          <div style="text-align:right;min-width:80px;">
            <div style="font-size:0.65rem;opacity:0.7;">Estado</div>
            <div style="font-size:1.2rem;">${alerta.estado}</div>
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  contenido.innerHTML = html;
}

// Función para cerrar modal
function cerrarModalAlertas() {
  const modal = document.getElementById('modal-alertas-vigencia');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Función para actualizar badge de alertas pendientes
// Cerrar modal al hacer clic fuera
document.addEventListener('click', function(e) {
  const modal = document.getElementById('modal-alertas-vigencia');
  if (modal && e.target === modal) {
    cerrarModalAlertas();
  }
});

// Cerrar modal con tecla Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    cerrarModalAlertas();
  }
});

// Cargar alertas automáticamente cuando se carga un usuario
window.addEventListener('usuario:cargado', function(e) {
  const detail = e?.detail || {};
  const run = (detail.run || '').trim();
  const alertasPre = Array.isArray(detail.alertas) ? detail.alertas : null;

  alertasReconocidas = false;
  actualizarIndicadoresAlertas(0, 0, null);

  if (alertasPre) {
    try {
      const pendientes = alertasPre.filter(a => !a.vigente && a.detalle).length;
      const sinDatos = alertasPre.filter(a => !a.detalle).length;
      const vigentes = alertasPre.filter(a => a.vigente).length;
      actualizarIndicadoresAlertas(pendientes, sinDatos, vigentes);
      return;
    } catch (err) {
      console.warn('Error procesando alertas precargadas:', err);
    }
  }

  if (!run) {
    return;
  }

  // Cargar alertas en background
  setTimeout(() => {
    fetch(`/api/vigencia/alertas/${encodeURIComponent(run)}`)
      .then(r => r.json())
      .then(data => {
        if (data.success && data.alertas) {
          const pendientes = data.alertas.filter(a => !a.vigente && a.detalle).length;
          const sinDatos = data.alertas.filter(a => !a.detalle).length;
          const vigentes = data.alertas.filter(a => a.vigente).length;
          actualizarIndicadoresAlertas(pendientes, sinDatos, vigentes);
        }
      })
      .catch(err => console.error('Error cargando alertas:', err));
  }, 1000);
});

console.log('✅ [INIT] Sistema de alertas de vigencia cargado');

// ===== FUNCIONES DE DIAGNOSTICO GLOBALES =====
console.log('🔧 [INIT] Cargando funciones de diagnóstico...');

window.testFecha = function() {
  console.log('🔧 [TEST-FECHA] Probando formateo de fecha...');
  const fecha = 'Thu, 12 Mar 1964 00:00:00 GMT';
  console.log('🔧 [TEST-FECHA] Fecha original:', fecha);
  const fechaFormateada = new Date(fecha).toLocaleDateString('es-CL');
  console.log('🔧 [TEST-FECHA] Fecha formateada:', fechaFormateada);
  return fechaFormateada;
};

window.testPoblarDirect = function() {
  console.log('🔧 [TEST-DIRECT] Test directo de poblar...');
  try {
    console.log('🔧 [TEST-DIRECT] Verificando función poblar:', typeof window.poblar);
    
    const testData = {
      usuario: {
        run: "10.000.141-1",
        nombre: "Patricio Pino Reyes", 
        fecha_nacimiento: "Thu, 12 Mar 1964 00:00:00 GMT",
        sexo: "masculino",
        sector_nombre: "VERDE"
      },
      edad: 61
    };
    
    if (typeof poblar === 'function') {
      console.log('🔧 [TEST-DIRECT] Ejecutando poblar...');
      poblar(testData);
      console.log('🔧 [TEST-DIRECT] Poblar ejecutado correctamente');
    } else {
      console.error('🔧 [TEST-DIRECT] Función poblar no encontrada');
    }
  } catch(error) {
    console.error('🔧 [TEST-DIRECT] Error:', error);
  }
  return 'Test completado';
};

console.log('🔧 [INIT] Funciones de diagnóstico cargadas');

// ============ FUNCIÓN DE DIAGNÓSTICO PARA PROBLEMAS DE BÚSQUEDA ============
window.diagnosticarBusqueda = function() {
    console.log('🔍 [DIAGNOSTICO] Iniciando diagnóstico de búsqueda...');
    
    // Verificar elementos del DOM
    const elementos = {
        'runSearch (#run-search)': document.getElementById('run-search'),
        'btnBuscar (#btn-buscar-run)': document.getElementById('btn-buscar-run'),
        'runForm (#run)': document.getElementById('run'),
        'helpSearch (#run-search-help)': document.getElementById('run-search-help')
    };
    
    console.log('🔍 [DIAGNOSTICO] Elementos del DOM:');
    Object.entries(elementos).forEach(([nombre, elemento]) => {
        console.log(`  ${nombre}: ${elemento ? '✅ Encontrado' : '❌ No encontrado'}`);
        if (elemento && elemento.value !== undefined) {
            console.log(`    Valor actual: "${elemento.value}"`);
        }
    });
    
    // Verificar funciones
    const funciones = {
        'buscarRun': typeof buscarRun,
        'trimRun': typeof trimRun,
        'validarRunCl': typeof validarRunCl,
        'marcarValidez': typeof marcarValidez
    };
    
    console.log('🔍 [DIAGNOSTICO] Funciones disponibles:');
    Object.entries(funciones).forEach(([nombre, tipo]) => {
        console.log(`  ${nombre}: ${tipo === 'function' ? '✅ Disponible' : `❌ ${tipo}`}`);
    });
    
    // Probar validación con RUN de ejemplo
    if (typeof validarRunCl === 'function') {
        const runTest = '12.345.678-9';
        console.log(`🔍 [DIAGNOSTICO] Probando validación con RUN: ${runTest}`);
        console.log(`  Resultado: ${validarRunCl(runTest)}`);
    }
    
    // Verificar event listeners
    const btnBuscar = document.getElementById('btn-buscar-run');
    if (btnBuscar) {
        console.log('🔍 [DIAGNOSTICO] Analizando botón de búsqueda...');
        console.log(`  Texto del botón: "${btnBuscar.textContent.trim()}"`);
        console.log(`  Disabled: ${btnBuscar.disabled}`);
        console.log(`  Visible: ${btnBuscar.offsetWidth > 0 && btnBuscar.offsetHeight > 0}`);
        console.log(`  Event listeners: ${btnBuscar.onclick ? 'onclick definido' : 'sin onclick'}`);
    }
    
    // Probar función buscarRun directamente
    if (typeof buscarRun === 'function') {
        console.log('🔍 [DIAGNOSTICO] Función buscarRun disponible');
        
        // Llenar campo con RUN de prueba
        const runInput = document.getElementById('run-search');
        if (runInput) {
            const runPrueba = '12.345.678-9';
            runInput.value = runPrueba;
            console.log(`🔍 [DIAGNOSTICO] Campo llenado con RUN de prueba: ${runPrueba}`);
            
            console.log('🔍 [DIAGNOSTICO] Ejecutando buscarRun() directamente...');
            try {
                buscarRun();
                console.log('  ✅ buscarRun() ejecutado sin errores sincronos');
            } catch (error) {
                console.error('  ❌ Error ejecutando buscarRun():', error);
            }
        }
    } else {
        console.error('🔍 [DIAGNOSTICO] ❌ Función buscarRun NO está disponible');
    }
    
    return 'Diagnóstico completado - revisa los logs arriba';
};

// ============ CARGA AUTOMÁTICA DESDE PÁGINA DETALLE ============
// Ejecutar después de que todas las funciones estén definidas
function cargarUsuarioDesdeURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const runParam = urlParams.get('run');
    const autoload = urlParams.get('autoload');
    
    if (runParam && autoload === 'true') {
        console.log('🏥 [AUTOLOAD] Detectado RUN desde página detalle:', runParam);
        
        // Limpiar parámetros de la URL sin recargar la página
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // Cargar el RUN en el campo de búsqueda
        const runInput = document.getElementById('run');
        const buscarRunInput = document.getElementById('buscar-run');
        
        if (runInput) {
            runInput.value = runParam;
            console.log('✅ [AUTOLOAD] RUN cargado en campo principal:', runParam);
        }
        
        if (buscarRunInput) {
            buscarRunInput.value = runParam;
            console.log('✅ [AUTOLOAD] RUN cargado en campo de búsqueda:', runParam);
        }
        
        // Verificar si hay datos en sessionStorage
        const runKey = runParam.replace(/[.-]/g, '');
        const datosGuardados = sessionStorage.getItem('usuario_precarga_' + runKey);
        
        if (datosGuardados) {
            try {
                const datos = JSON.parse(datosGuardados);
                console.log('📋 [AUTOLOAD] Datos de usuario encontrados en sessionStorage:', datos);
                
                // Mostrar mensaje de bienvenida
                if (datos.nombre) {
                    const mensaje = `🏥 Cargando datos de ${datos.nombre} (${runParam})...`;
                    console.log(mensaje);
                    
                    // Si hay un elemento de estado, mostrar el mensaje
                    const estadoElementos = [
                        document.querySelector('.estado-run'),
                        document.getElementById('estado-busqueda'),
                        document.querySelector('.lblEstado')
                    ].filter(Boolean);
                    
                    estadoElementos.forEach(el => {
                        if (el) {
                            el.textContent = mensaje;
                            el.style.color = '#059669';
                        }
                    });
                }
                
                // Limpiar datos temporales
                sessionStorage.removeItem('usuario_precarga_' + runKey);
            } catch (error) {
                console.warn('⚠️ [AUTOLOAD] Error procesando datos guardados:', error);
            }
        }
        
        // Buscar automáticamente después de un breve delay
        setTimeout(() => {
            if (typeof buscarRun === 'function') {
                console.log('🔍 [AUTOLOAD] Iniciando búsqueda automática...');
                buscarRun();
            } else {
                console.error('❌ [AUTOLOAD] Función buscarRun no disponible');
            }
        }, 200);
        
        return true;
    }
    
    return false;
}

// Ejecutar la carga automática al final del script
setTimeout(() => {
    const cargaAutomatica = cargarUsuarioDesdeURL();
    
    if (cargaAutomatica) {
        console.log('✅ [AUTOLOAD] Proceso de carga automática iniciado');
    } else {
        console.log('ℹ️ [AUTOLOAD] No se detectaron parámetros de carga automática');
    }
}, 100);

</script>

{% endblock %}
