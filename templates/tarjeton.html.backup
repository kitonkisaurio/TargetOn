{% extends 'base.html' %}
{% block title %}Tarjet√≥n Usuario{% endblock %}
{% block content %}
<header style="background:linear-gradient(135deg,#065f46,#047857,#059669);border-radius:18px;padding:34px 28px;margin-bottom:22px;position:relative;overflow:hidden;color:#fff;display:flex;align-items:center;justify-content:center;min-height:120px;">
  <div style="position:absolute;inset:0;pointer-events:none;background:radial-gradient(circle at 75% 25%,rgba(255,255,255,0.15),transparent 60%);"></div>
  <div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;width:100%;position:relative;z-index:1;">
    <div style="display:flex;align-items:center;justify-content:center;flex:1;gap:20px;">
  <img src="/static/logo_ecicep.jpg" alt="ECICEP" style="width:80px;height:80px;border-radius:50%;box-shadow:0 6px 16px rgba(0,0,0,.3);object-fit:cover;">
  <img src="/static/tarjeton.png" alt="Tarjet√≥n" style="height:180px;width:auto;object-fit:contain;border-radius:16px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.25),0 4px 6px -2px rgba(0,0,0,0.2);transition:transform .3s ease;filter:brightness(1.05) contrast(1.05);">
    </div>
    <div style="display:flex;gap:10px;position:absolute;right:0;">
      <button type="button" class="btn btn-outlined" id="btn-programa-cardio" title="Modo Cardiovascular">CARDIO</button>
      <button type="button" class="btn btn-verde" id="btn-programa-ecicep" title="Modo ECICEP integral">ECICEP</button>
    </div>
  </div>
</header>

<style>
  /* Estados de validaci√≥n RUN */
  .is-invalid { border-color:#dc2626 !important; outline-color:#dc2626 !important; }
  .is-valid { border-color:#16a34a !important; outline-color:#16a34a !important; }
  /* ===== Modo compacto ECICEP ===== */
  .ec-compact {
    --fs-xs: 12px;
    --fs-sm: 13px;
    --fs-base: 14px;
    --pad-sm: 6px;
    --pad-md: 10px;
    --gap-sm: 6px;
    --gap-md: 10px;
    --radius: 10px;
  }
  .ec-compact body,
  .ec-compact .card { font-size: var(--fs-base); }
  .ec-compact .card { padding: var(--pad-md); border-radius: var(--radius); }
  .ec-compact .mini-grid { display:grid !important; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)) !important; gap:var(--gap-md) !important; }
  .ec-compact label { font-size: var(--fs-sm); }
  .ec-compact input, .ec-compact select { padding:6px 8px; height:36px; }
  .ec-compact .btn { min-height:34px; padding:6px 10px; }
  .ec-compact .t-tab { padding:8px 10px; font-size:var(--fs-sm); }
  
  /* Estilos para las pesta√±as (tabs) */
  .t-tab {
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 10px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    margin: 0 2px;
    min-height: 44px;
    box-sizing: border-box;
  }
  
  .t-tab:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  
  .t-tab.active {
    background: #475569;
    color: white;
    border-color: #334155;
    box-shadow: 0 4px 8px rgba(71, 85, 105, 0.3);
    transform: translateY(-1px);
  }
  
  .t-tab.active:hover {
    background: #334155;
    transform: translateY(-1px);
  }
  
  /* Pesta√±a Adulto Mayor - oculta por defecto, se muestra via JavaScript seg√∫n edad */
  .t-tab[data-tab="funcionalidad"] {
    display: none;
  }
  
  /* Pesta√±a Evaluaci√≥n Diabetes - oculta por defecto, se muestra via JavaScript si tiene diabetes + ERC */
  .t-tab[data-tab="diabetes"] {
    display: none;
  }
  
  /* Responsivo para pesta√±as en pantallas peque√±as */
  @media (max-width: 768px) {
    .t-tab {
      padding: 8px 12px;
      font-size: 0.8rem;
      margin: 0 1px;
    }
  }

  
  .mini-btn {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    color: #64748b;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.65rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .mini-btn:hover {
    background: #e2e8f0;
    color: #374151;
  }
  
  .mini-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
  }
  
  /* Estilos para los nuevos botones */
  #btn-inicio { background:#2563eb; color:white; border:none; border-radius:6px; margin-left:8px; }
  #btn-inicio:hover { background:#1d4ed8; }
  
  #btn-limpiar { background:#f59e0b; color:white; border:none; border-radius:6px; margin-left:8px; }
  #btn-limpiar:hover { background:#d97706; }
  
  #btn-mandrake-bot { background:#10b981; color:white; border:none; border-radius:6px; margin-left:8px; font-weight:500; }
  #btn-mandrake-bot:hover { background:#059669; transform:scale(1.02); }
  #btn-mandrake-bot:active { transform:scale(0.98); }
  
  /* Chat MandrakeBot */
  #mandrake-chat-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
  }
  
  #mandrake-chat-container {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    height: 80%;
    max-height: 700px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  #mandrake-chat-header {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 16px 20px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  #mandrake-chat-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
  }
  
  #mandrake-chat-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  
  #mandrake-chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .mandrake-message {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 16px;
    line-height: 1.5;
    font-size: 14px;
  }
  
  .mandrake-message.user {
    align-self: flex-end;
    background: #2563eb;
    color: white;
  }
  
  .mandrake-message.bot {
    align-self: flex-start;
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #e5e7eb;
  }
  
  .mandrake-message.system {
    align-self: center;
    background: #fef3c7;
    color: #92400e;
    font-size: 12px;
    font-style: italic;
  }
  
  #mandrake-chat-input-container {
    padding: 16px 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    align-items: center;
  }
  
  #mandrake-chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #d1d5db;
    border-radius: 24px;
    font-size: 14px;
    outline: none;
  }
  
  #mandrake-chat-input:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
  }
  
  #mandrake-chat-send {
    background: #10b981;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 24px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
  }
  
  #mandrake-chat-send:hover {
    background: #059669;
    transform: scale(1.02);
  }
  
  #mandrake-chat-send:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }
  
  .mandrake-typing {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    background: #f3f4f6;
    border-radius: 16px;
    align-self: flex-start;
    max-width: 80%;
  }
  
  .mandrake-typing-dots {
    display: flex;
    gap: 4px;
  }
  
  .mandrake-typing-dot {
    width: 8px;
    height: 8px;
    background: #6b7280;
    border-radius: 50%;
    animation: mandrakePulse 1.4s infinite ease-in-out;
  }
  
  .mandrake-typing-dot:nth-child(1) { animation-delay: -0.32s; }
  .mandrake-typing-dot:nth-child(2) { animation-delay: -0.16s; }
  .mandrake-typing-dot:nth-child(3) { animation-delay: 0s; }
  
  @keyframes mandrakePulse {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
  .ec-compact #tabs-content { padding:6px 14px; }
  .ec-compact table th, .ec-compact table td { padding:4px 6px !important; font-size:12px !important; }
  .ec-compact #card-resumen { gap:10px; min-height:320px; }
  .zoom-hover, .btn:hover, button:hover, input:hover, select:hover, textarea:hover { transform:none !important; box-shadow:none !important; }
  /* Reiterar estados RUN (ya definidos arriba) */
  :root { --resumen-w:320px; }
  #layout-tarjeton-grid { grid-template-columns:1fr; }
  #layout-tarjeton-grid.no-resumen { grid-template-columns:1fr !important; }
  #layout-tarjeton-grid.solo-resumen { grid-template-columns:var(--resumen-w) minmax(0,1fr) !important; }
  #layout-tarjeton-grid.resumen-colapsado { grid-template-columns:46px minmax(0,1fr) !important; }
  /* El resumen ahora ocupa todo el ancho disponible (igual a Identificaci√≥n) */
  #card-resumen { width:100%; }
  #card-resumen.expandido { width:100%; min-height:460px; }
  @media (max-width: 1200px){ :root { --resumen-w:300px; } }
  @media (max-width: 1050px){ #layout-tarjeton-grid.solo-resumen { grid-template-columns:1fr !important; } #card-resumen { width:100%; } }
  @media (min-width:1600px){ :root { --resumen-w:360px; } }
  /* Toolbar RUN fija (sticky) en la parte superior al hacer scroll) */
  #toolbar-buscar-run {
    position:sticky;
    top:8px; /* separacion del borde superior */
    z-index:60;
    background:#f8fafc;
    padding:8px 10px;
    border:1px solid #e2e8f0;
    border-radius:12px;
    box-shadow:0 2px 4px rgba(0,0,0,0.05);
  }
  /* Evitar que elementos flex internos colapsen alturas al sticky */
  #toolbar-buscar-run > * { margin-top:0 !important; }
  /* Colores patolog√≠as clave */
  #lista-patologias li.pat-hta{background:#b91c1c;color:#fff;padding:2px 6px;border-radius:4px;margin:2px 0;font-weight:600;}
  #lista-patologias li.pat-dislip{background:#facc15;color:#422006;padding:2px 6px;border-radius:4px;margin:2px 0;font-weight:600;}
  #lista-patologias li.pat-diabetes{background:#16a34a;color:#fff;padding:2px 6px;border-radius:4px;margin:2px 0;font-weight:600;}
  
  /* Evaluaci√≥n Diabetes - Grid responsivo */
  @media (max-width: 768px) {
    #evaluacion-diabetes div[style*="grid-template-columns:1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
  
  /* F√°rmacos - Grid responsivo */
  @media (max-width: 768px) {
    #farmacos div[style*="grid-template-columns:1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }
  
  /* === MandrakeBot - Sistema de destacado de campos === */
  .mandrake-modified {
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)) !important;
    border: 2px solid #10b981 !important;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
    transition: all 0.3s ease !important;
    animation: mandrake-highlight 1s ease-out !important;
  }
  
  .mandrake-tab-modified {
    background: linear-gradient(135deg, #10b981, #059669) !important;
    color: white !important;
    position: relative !important;
    animation: mandrake-tab-pulse 2s infinite !important;
  }
  
  .mandrake-indicator {
    position: absolute !important;
    top: -2px !important;
    right: -2px !important;
    width: 8px !important;
    height: 8px !important;
    background: #dc2626 !important;
    border-radius: 50% !important;
    animation: mandrake-pulse 1.5s infinite !important;
  }
  
  @keyframes mandrake-highlight {
    0% { 
      background: rgba(16, 185, 129, 0.3);
      transform: scale(1.02);
    }
    100% { 
      background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
      transform: scale(1);
    }
  }
  
  @keyframes mandrake-tab-pulse {
    0%, 100% { 
      box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
    }
    50% { 
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.1);
    }
  }
  
  @keyframes mandrake-pulse {
    0%, 100% { 
      opacity: 1; 
      transform: scale(1);
    }
    50% { 
      opacity: 0.5; 
      transform: scale(1.2);
    }
  }
</style>

<div id="layout-tarjeton-grid" style="display:flex;flex-direction:column;gap:18px;align-items:stretch;">
  <!-- Toolbar Buscar RUN -->
  <div id="toolbar-buscar-run" style="display:flex;gap:8px;align-items:end;flex-wrap:wrap;position:sticky;top:8px;z-index:60;background:#f8fafc;padding:8px 10px;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,0.05);">
      <label style="display:flex;flex-direction:column;gap:4px;">
        <span style="font-size:.75rem;font-weight:600;letter-spacing:.3px;">RUN a buscar</span>
        <input type="text" id="run-search" placeholder="00.000.000-0" maxlength="13" style="min-width:220px;" />
        <small id="run-search-help" style="display:none;color:#b91c1c;">RUN inv√°lido</small>
      </label>
      <button type="button" id="btn-buscar-run" class="btn btn-verde" style="position:relative;">
        <span class="lbl">Buscar RUN</span>
        <span class="spinner" style="display:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
          <span style="width:14px;height:14px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;display:inline-block;animation:spin .7s linear infinite;"></span>
        </span>
      </button>
      <button type="button" id="btn-nuevo-usuario" class="btn btn-outlined">Nuevo usuario</button>
      <button type="button" id="btn-inicio" class="btn btn-primary" onclick="window.location.href='/'">Inicio</button>
      <button type="button" id="btn-limpiar" class="btn btn-warning">Limpiar</button>
      <button type="button" id="btn-mandrake-bot" class="btn btn-success" onclick="openMandrakeBot()">ü§ñMandrakeBot</button>
      <button type="button" id="btn-ai-autocomplete" class="btn btn-amarillo" style="background:#9333ea;color:#fff;border:none;" title="Extraer datos desde texto libre">‚ö° Autocompletar IA</button>
      <button type="button" id="btn-save-all" class="btn" title="Guardar todo" style="background:#0f766e;color:#fff;display:flex;align-items:center;gap:4px;">
        üíæ <span style="font-size:.65rem;font-weight:600;letter-spacing:.5px;">Guardar</span>
      </button>
      <details style="margin-left:auto;">
        <summary style="cursor:pointer;font-size:.7rem;">Pegar texto cl√≠nico</summary>
        <textarea id="ai-texto-clinico" placeholder="Pega aqu√≠ texto cl√≠nico libre para extraer datos (RUN, nombre, labs, patolog√≠as...)" style="width:520px;max-width:100%;height:120px;margin-top:6px;font-size:.7rem;padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;resize:vertical;"></textarea>
        <div id="ai-autocomplete-status" style="font-size:.65rem;margin-top:4px;color:#334155;display:none;"></div>
      </details>
      <style>@keyframes spin{to{transform:rotate(360deg);}}</style>
  </div>
  <!-- Bloque adicional simple para IA (versi√≥n solicitada) -->
  <div class="card" style="padding:12px;display:flex;flex-direction:column;gap:8px;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <strong style="font-size:.8rem;letter-spacing:.5px;">Autocompletar Tarjet√≥n (Modo Simple)</strong>
      <button id="btn-ai-fill" type="button" class="btn" style="background:#2563eb;color:#fff;">Autocompletar con IA</button>
    </div>
    <textarea id="ai-texto" placeholder="Pega aqu√≠ la nota cl√≠nica para autocompletar‚Ä¶" style="width:100%;min-height:90px;font-size:.75rem;padding:8px;border:1px solid #cbd5e1;border-radius:8px;resize:vertical;"></textarea>
    <small style="opacity:.7;font-size:.6rem;">Usa texto resumido (&lt;=6000 chars). Este modo no guarda datos autom√°ticamente.</small>
    <div id="ai-fill-status" style="display:none;font-size:.65rem;"></div>
  </div>
  <!-- Resumen siempre visible debajo del toolbar -->
  <aside id="card-resumen" class="card" style="padding:16px;flex-direction:column;gap:14px;min-height:220px;display:flex;position:relative;">
    <h3 style="margin:0;font-size:1.05rem;display:flex;align-items:center;gap:6px;">ü©∫ Resumen</h3>
    <button type="button" id="btn-editar-ident" class="btn btn-amarillo" style="align-self:flex-start;margin-bottom:4px;padding:4px 10px;font-size:.65rem;letter-spacing:.5px;">Editar identificaci√≥n</button>
    <div class="resumen-body" style="display:flex;flex-direction:column;gap:10px;">
      <div id="resumen-ident" style="font-size:.82rem;line-height:1.35;display:grid;gap:4px;">
      <div><strong>RUN:</strong> <span data-f="run">‚Äî</span></div>
      <div><strong>Nombre:</strong> <span data-f="nombre_completo">‚Äî</span></div>
      <div><strong>Fecha Nacimiento:</strong> <span data-f="fecha_nacimiento">‚Äî</span></div>
    <div><strong>Edad:</strong> <span data-f="edad">‚Äî</span></div>
      <div><strong>Sexo:</strong> <span data-f="sexo">‚Äî</span></div>
  <div><strong>Sector:</strong> <span data-f="sector_nombre">‚Äî</span></div>
  <div><strong>Categor√≠a:</strong> <span data-f="categoria_nombre" class="categoria-riesgo">‚Äî</span></div>
      <div><strong>Tel√©fono:</strong> <span data-f="telefono">‚Äî</span></div>
      </div>
      
      <!-- Secci√≥n resumen-general para compatibilidad con el c√≥digo de riesgo -->
      <div id="resumen-general" style="display:none;">
        <span class="categoria-riesgo">‚Äî</span>
      </div>
      <hr style="margin:4px 0 0 0;">
      <div>
      <h4 style="margin:4px 0 6px;font-size:.85rem;letter-spacing:.5px;text-transform:uppercase;color:#065f46;">Patolog√≠as</h4>
      <ul id="lista-patologias" style="margin:0;padding-left:18px;font-size:.75rem;max-height:160px;overflow:auto;">
        <li style="opacity:.6;">Sin datos</li>
      </ul>
      </div>
      <div style="margin-top:auto;padding-top:6px;border-top:1px solid #e2e8f0;">
      <h4 style="margin:0 0 4px;font-size:.78rem;text-transform:uppercase;letter-spacing:.5px;color:#065f46;">Acuerdo reciente</h4>
      <div id="acuerdo-reciente" style="font-size:.7rem;line-height:1.3;opacity:.85;">‚Äî</div>
      </div>
    </div>
  </aside>

  <!-- Identificaci√≥n + Tabs -->
  <div style="display:flex;flex-direction:column;gap:18px;">
    <form id="form-tarjeton" autocomplete="off" novalidate class="card" style="gap:16px;">
      <fieldset id="identificacion-section" style="display:none; border:1px solid var(--gris-borde,#cbd5e1); border-radius:10px; padding:16px;">
        <legend style="padding:0 8px; font-weight:600; display:flex; align-items:center; gap:8px;">Identificaci√≥n
          <span id="badge-nuevo-usuario" style="display:none; font-size:.65rem; background:#0f766e; color:#ecfdf5; padding:2px 6px; border-radius:6px; letter-spacing:.5px; font-weight:500;">Usuario nuevo</span>
        </legend>
  <div class="mini-grid" style="--cols:6; display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:18px;">
          <label>RUN
            <input type="text" name="run" id="run" maxlength="13" placeholder="00.000.000-0" required>
          </label>
          <label>Nombre
            <input type="text" name="nombre" id="nombre" required>
          </label>
          <label>Sexo
            <select name="sexo" id="sexo" required>
              <option value="">-- Seleccione --</option>
              <option value="masculino">Masculino</option>
              <option value="femenino">Femenino</option>
            </select>
          </label>
          <label>Fecha nacimiento
            <input type="date" name="fecha_nacimiento" id="fecha_nacimiento" required>
          </label>
          <label>Edad (a√±os)
            <input type="number" id="edad" name="edad" readonly placeholder="0">
          </label>
          <label>Direcci√≥n
            <input type="text" name="direccion" id="direccion">
          </label>
          <label>Tel√©fono
            <input type="text" name="telefono" id="telefono" placeholder="+569...">
          </label>
          <label>Nivel educaci√≥n
            <select name="nivel_educacion" id="nivel_educacion">
              <option value="">-- Seleccione --</option>
              <option value="Analfabeto">Analfabeto</option>
              <option value="B√°sica incompleta">B√°sica incompleta</option>
              <option value="B√°sica Completa">B√°sica Completa</option>
              <option value="Media incompleta">Media incompleta</option>
              <option value="Media completa">Media completa</option>
              <option value="Universitaria incompleta">Universitaria incompleta</option>
              <option value="Universitaria completa">Universitaria completa</option>
            </select>
          </label>
          <label>Origen √©tnico
            <select name="origen_etnico" id="origen_etnico">
              <option value="">-- Seleccione --</option>
              <option value="Chileno">üá®üá± Chileno</option>
              <option value="Mapuche">Mapuche</option>
              <option value="Extranjero">Extranjero</option>
            </select>
          </label>
          <label>Sector
            <select name="sector_id" id="sector_id" data-load="sectores">
              <option value="">-- Sector --</option>
            </select>
          </label>
          <label>Categor√≠a/Riesgo
            <input type="text" name="categoria" id="categoria" placeholder="‚Äî" readonly>
          </label>
        </div>
      </fieldset>
      <div style="display:flex; gap:12px;">
        <button type="submit" class="btn btn-verde">Guardar</button>
        <button type="reset" class="btn btn-outlined" id="btn-reset">Limpiar</button>
      </div>
    </form>

    <!-- C√°lculo din√°mico de riesgo ECICEP -->
    <section class="card" id="riesgo-dinamico" style="padding:16px;">
      <h3 style="margin:0 0 12px;font-size:1rem;display:flex;align-items:center;gap:6px;">üîé C√°lculo din√°mico de riesgo ECICEP y ingreso de patolog√≠as</h3>
      
      <!-- Selector de Programa -->
      <div style="display:flex;gap:8px;margin-bottom:16px;align-items:center;">
        <span style="font-size:.7rem;font-weight:600;opacity:.75;">PROGRAMA:</span>
        <button type="button" id="btn-programa-ecicep-riesgo" class="btn btn-verde" style="font-size:.7rem;">ECICEP</button>
        <button type="button" id="btn-programa-cardio-riesgo" class="btn btn-outlined" style="font-size:.7rem;">CARDIO</button>
      </div>
      
      <div style="display:flex;flex-wrap:wrap;gap:14px;align-items:flex-start;">
        <!-- Panel de Patolog√≠as -->
        <div style="flex:1 1 320px;min-width:300px;">
          <label style="display:block;font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;font-weight:600;opacity:.75;">Buscar patolog√≠a</label>
          <input type="text" id="buscador-patologia" placeholder="Nombre o CIE10" style="width:100%;margin-bottom:8px;padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
          <div id="contenedor-patologias" style="max-height:240px;overflow:auto;border:1px solid #e2e8f0;border-radius:8px;padding:8px;font-size:.7rem;display:grid;gap:4px;background:#f9fafb;">
            <div style="opacity:.6;text-align:center;padding:20px;">Cargando cat√°logo...</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center;">
            <button type="button" id="btn-guardar-patologias" class="btn btn-verde" disabled style="font-size:.7rem;">Guardar selecci√≥n</button>
            <button type="button" id="btn-select-filtradas" class="btn btn-outlined" disabled style="font-size:.7rem;">Seleccionar filtradas</button>
            <button type="button" id="btn-clear-seleccion" class="btn btn-outlined" disabled style="font-size:.7rem;">Limpiar</button>
            <span id="contador-seleccion" style="font-size:.65rem;opacity:.75;">0 seleccionadas</span>
          </div>
          <div id="estado-patologias" style="font-size:.65rem;margin-top:4px;padding:4px;"></div>
        </div>
        
        <!-- Panel de C√°lculo -->
        <div style="flex:1 1 300px;min-width:280px;display:flex;flex-direction:column;gap:12px;">
          <!-- Patolog√≠as Seleccionadas -->
          <div>
            <span style="font-size:.7rem;text-transform:uppercase;font-weight:600;opacity:.75;">Patolog√≠as Seleccionadas</span>
            <div id="patologias-seleccionadas" style="max-height:120px;overflow:auto;border:1px solid #e2e8f0;border-radius:6px;padding:6px;margin-top:4px;font-size:.65rem;background:#fff;">
              <div style="opacity:.6;text-align:center;padding:10px;">Ninguna patolog√≠a seleccionada</div>
            </div>
          </div>
          
          <!-- Resultado de Riesgo -->
          <div>
            <span style="font-size:.7rem;text-transform:uppercase;font-weight:600;opacity:.75;">C√°lculo de Riesgo</span>
            <div style="display:flex;gap:8px;margin-top:6px;align-items:center;flex-wrap:wrap;">
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:.65rem;opacity:.75;">Actual:</span>
                <div id="riesgo-actual" class="badge-riesgo badge-neutro" title="Categor√≠a actual del usuario">‚Äî</div>
              </div>
              <div style="display:flex;align-items:center;gap:6px;">
                <span style="font-size:.65rem;opacity:.75;">Calculado:</span>
                <div id="riesgo-calculado" class="badge-riesgo badge-neutro" title="Resultado del c√°lculo">‚Äî</div>
              </div>
            </div>
            <div id="puntos-riesgo" style="font-size:.65rem;margin-top:4px;opacity:.75;">Puntos: 0</div>
            <div id="detalle-calculo" style="font-size:.6rem;line-height:1.3;margin-top:6px;padding:6px;background:#f9fafb;border-radius:4px;opacity:.85;">
              Seleccione patolog√≠as para calcular el riesgo
            </div>
          </div>
          
          <!-- Botones de Acci√≥n -->
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" id="btn-calcular-riesgo" class="btn btn-outlined" disabled style="font-size:.7rem;">üßÆ Calcular Riesgo</button>
            <button type="button" id="btn-aplicar-riesgo" class="btn btn-verde" disabled style="font-size:.7rem;">‚úÖ Aplicar al Usuario</button>
          </div>
          
          <!-- Leyenda -->
          <div style="margin-top:8px;font-size:.6rem;line-height:1.4;padding:8px;background:#f1f5f9;border-radius:6px;">
            <strong>Leyenda ECICEP:</strong><br>
            <span class="badge-riesgo badge-g1" style="margin:2px;">G1</span> 1 punto o condici√≥n<br>
            <span class="badge-riesgo badge-g2" style="margin:2px;">G2</span> 2-4 puntos o condiciones<br>
            <span class="badge-riesgo badge-g3" style="margin:2px;">G3</span> 5+ puntos o condiciones
          </div>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="card" style="padding:0;overflow:hidden;">
      <nav style="display:flex;flex-wrap:wrap;gap:2px;padding:6px 8px;background:#f1f5f9;border-bottom:1px solid #e2e8f0;">
        {% set tabs = [
          ('control','üìä Control'),
          ('examenes','üß™ Ex√°menes'),
          ('acuerdos','üëçüèº Acuerdos'),
          ('funcionalidad','üë¥ Adulto Mayor'),
          ('diabetes','üíâEvaluaci√≥n Diabetesü¶∂üèª'),
          ('adulto_mayor','üîé Screening'),
          ('farmacos','üíä F√°rmacos'),

        ] %}
        {% for key,label in tabs %}
          <button type="button" class="t-tab" data-tab="{{ key }}">{{ label }}</button>
        {% endfor %}
      </nav>
      <div id="tabs-content" style="padding:8px 18px;min-height:180px;font-size:.9rem;">
        <div data-panel="control">
          <div style="display:grid;gap:12px;">
            <form id="form-control-nuevo" style="display:grid;gap:8px;padding:8px;border:1px solid #e2e8f0;border-radius:8px;background:#f8fafc;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));align-items:end;">
              <div style="grid-column:1 / -1;font-size:.65rem;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:#334155;">Nuevo control</div>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Fecha
                <input type="date" name="fecha" style="padding:4px;font-size:.7rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Profesional
                <input type="text" name="profesional" placeholder="Nombre" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Peso (kg)
                <input type="number" step="0.1" name="peso" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">Talla (cm)
                <input id="input-talla" type="number" step="0.1" name="talla" style="padding:4px;font-size:.7rem;"/>
              </label>
              <div style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">
                <span style="font-weight:600;">IMC</span>
                <div id="imc-control" style="padding:4px;font-size:.75rem;background:#fff;border:1px solid #cbd5e1;border-radius:4px;min-height:28px;display:flex;align-items:center;gap:6px;">
                  <span data-f="imc">‚Äî</span>
                  <span id="imc-clasif" style="font-size:.6rem;padding:2px 6px;border-radius:12px;background:#e2e8f0;color:#334155;display:none;"></span>
                </div>
              </div>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">PSIS
                <input type="number" name="presion_sistolica" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">PDIA
                <input type="number" name="presion_diastolica" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">CC (cm)
                <input type="number" step="0.1" name="cc" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">HGT
                <input type="number" step="0.1" name="hgt" style="padding:4px;font-size:.7rem;"/>
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;font-size:.6rem;">HbA1c (%)
                <input type="number" step="0.1" name="hba1c" style="padding:4px;font-size:.7rem;"/>
              </label>
              <div style="display:flex;gap:6px;align-items:center;">
                <button type="submit" class="btn btn-verde" style="font-size:.65rem;padding:6px 10px;">Guardar</button>
                <span id="estado-control" style="font-size:.6rem;opacity:.8;"></span>
              </div>
            </form>
            <div id="panel-control" style="font-size:.75rem;line-height:1.4;display:grid;gap:4px;">
              <div style="opacity:.6;">Seleccione RUN para mostrar √∫ltimo control.</div>
            </div>
            <div id="historico-control" class="hist-section" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" data-toggle="hist-control">
                <h4 style="margin:0;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">Hist√≥rico controles</h4>
                <span style="font-size:.65rem;opacity:.7;" data-icon="hist-control">‚ñº</span>
              </div>
              <div data-body="hist-control" style="display:none;margin-top:6px;">
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;align-items:center;">
                  <div style="display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-filtro-control="all">Todos</button>
                    <button type="button" class="mini-btn" data-filtro-control="12m">12m</button>
                    <button type="button" class="mini-btn" data-filtro-control="6m">6m</button>
                  </div>
                  <div style="margin-left:auto;display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-export="controls" title="Exportar controles">‚¨áÔ∏è XLSX</button>
                  </div>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:.62rem;">
                  <thead>
                    <tr style="background:#f1f5f9;">
                      <th style="padding:4px;">Fecha</th><th style="padding:4px;">PSIS/PDIA</th><th style="padding:4px;">IMC</th><th style="padding:4px;">Clas IMC</th><th style="padding:4px;">HTA</th><th style="padding:4px;">Peso</th><th style="padding:4px;">Talla</th><th style="padding:4px;">CC</th><th style="padding:4px;">HGT</th><th style="padding:4px;">HbA1c</th><th style="padding:4px;">Œî</th>
                    </tr>
                  </thead>
                  <tbody id="hist-control-tbody"><tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div data-panel="examenes" hidden>
          <div id="panel-examenes" style="font-size:.72rem;line-height:1.3;display:flex;flex-direction:column;gap:6px;">
            <div style="opacity:.6;">Seleccione RUN para mostrar √∫ltimos ex√°menes de laboratorio.</div>
            <form id="form-lab-nuevo" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px;align-items:end;background:#f8fafc;padding:8px;border:1px solid #e2e8f0;border-radius:8px;font-size:.6rem;">
              <div style="grid-column:1/-1;font-size:.6rem;font-weight:600;opacity:.8;">Nuevo laboratorio r√°pido</div>
              <label style="display:flex;flex-direction:column;gap:2px;">Fecha
                <input type="date" name="examen_fecha" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">Glicemia
                <input type="number" step="0.1" name="glicemia" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">HbA1c
                <input type="number" step="0.1" name="hba1c" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">LDL
                <input type="number" step="0.1" name="ldl" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">HDL
                <input type="number" step="0.1" name="hdl" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">Col
                <input type="number" step="0.1" name="col" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">TAG
                <input type="number" step="0.1" name="tag" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">Creat
                <input type="number" step="0.01" name="creatinemia" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">VFG
                <input type="number" step="1" name="vfg" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">RAC
                <input type="number" step="0.1" name="rac" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">MicroAlb
                <input type="number" step="0.1" name="microalbuminuria_val" style="padding:4px;font-size:.65rem;" />
              </label>
              <label style="display:flex;flex-direction:column;gap:2px;">TSH
                <input type="number" step="0.01" name="tsh" style="padding:4px;font-size:.65rem;" />
              </label>
              <div style="display:flex;gap:6px;align-items:center;">
                <button type="submit" class="btn btn-verde" style="font-size:.6rem;padding:6px 10px;">Guardar</button>
                <span id="estado-lab" style="font-size:.55rem;opacity:.85;"></span>
              </div>
            </form>
            <div id="examenes-tabla-wrapper" style="overflow-x:auto;">
              <table id="tabla-labs" style="border-collapse:collapse;min-width:620px;display:none;">
                <thead>
                  <tr style="background:#f1f5f9;">
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Par√°metro</th>
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Valor</th>
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Fecha</th>
                    <th style="padding:4px 8px;text-align:left;font-weight:600;font-size:.65rem;">Anotaciones</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="historico-labs" class="hist-section" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" data-toggle="hist-labs">
                <h4 style="margin:0;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">Hist√≥rico laboratorios</h4>
                <span style="font-size:.65rem;opacity:.7;" data-icon="hist-labs">‚ñº</span>
              </div>
              <div data-body="hist-labs" style="display:none;margin-top:6px;overflow-x:auto;">
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;align-items:center;">
                  <div style="display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-filtro-labs="all">Todos</button>
                    <button type="button" class="mini-btn" data-filtro-labs="12m">12m</button>
                    <button type="button" class="mini-btn" data-filtro-labs="6m">6m</button>
                  </div>
                  <div style="margin-left:auto;display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-export="labs" title="Exportar labs">‚¨áÔ∏è XLSX</button>
                  </div>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:.6rem;min-width:820px;">
                  <thead>
                    <tr style="background:#f1f5f9;">
                      <th style="padding:4px;">Fecha</th><th style="padding:4px;">Glic</th><th style="padding:4px;">HbA1c</th><th style="padding:4px;">LDL</th><th style="padding:4px;">HDL</th><th style="padding:4px;">Col</th><th style="padding:4px;">TAG</th><th style="padding:4px;">Creat</th><th style="padding:4px;">VFG</th><th style="padding:4px;">ERC</th><th style="padding:4px;">RAC</th><th style="padding:4px;">MicroAlb</th><th style="padding:4px;">TSH</th><th style="padding:4px;">Œî</th>
                    </tr>
                  </thead>
                  <tbody id="hist-labs-tbody"><tr><td colspan="14" style="padding:6px;opacity:.6;">Sin datos</td></tr></tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
        <div data-panel="acuerdos" hidden>
          <div id="panel-acuerdos" style="font-size:.7rem;display:grid;gap:6px;">
            <div id="acuerdo-ultimo" style="padding:6px;border:1px solid #e2e8f0;border-radius:6px;font-size:.68rem;">Sin datos</div>
            
            <!-- Formulario Nuevo Acuerdo -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:12px;background:#f8fafc;">
              <h4 style="margin:0 0 8px;font-size:.75rem;color:#374151;text-transform:uppercase;letter-spacing:.5px;">üìù Nuevo Acuerdo</h4>
              <form id="form-acuerdo-nuevo" style="display:grid;gap:8px;">
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;">
                  <label style="font-size:.7rem;font-weight:500;">Fecha:</label>
                  <input type="date" name="fecha" id="acuerdo_fecha" style="padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;" value="">
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;">
                  <label style="font-size:.7rem;font-weight:500;">Acuerdos:</label>
                  <textarea name="acuerdos" placeholder="Descripci√≥n de los acuerdos establecidos..." 
                    style="padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;min-height:60px;resize:vertical;"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;">
                  <label style="font-size:.7rem;font-weight:500;">Cumplimiento:</label>
                  <select name="cumplimiento" style="padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;">
                    <option value="">-- Seleccionar --</option>
                    <option value="pendiente">Pendiente</option>
                    <option value="cumple">Cumple</option>
                    <option value="cumple parcial">Cumple Parcial</option>
                    <option value="no cumple">No Cumple</option>
                    <option value="inicio de acuerdos consensuados">Inicio de Acuerdos Consensuados</option>
                  </select>
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:start;">
                  <label style="font-size:.7rem;font-weight:500;">Observaciones:</label>
                  <textarea name="observaciones" placeholder="Observaciones adicionales (opcional)..." 
                    style="padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;min-height:40px;resize:vertical;"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center;">
                  <label style="font-size:.7rem;font-weight:500;">Profesional:</label>
                  <input type="text" name="funcionario" placeholder="Nombre del profesional" 
                    style="padding:4px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;">
                </div>
                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:4px;">
                  <button type="button" onclick="document.getElementById('form-acuerdo-nuevo').reset()" 
                    style="padding:6px 12px;background:#6b7280;color:white;border:none;border-radius:4px;font-size:.7rem;cursor:pointer;">
                    Limpiar
                  </button>
                  <button type="submit" 
                    style="padding:6px 12px;background:#059669;color:white;border:none;border-radius:4px;font-size:.7rem;cursor:pointer;">
                    Guardar
                  </button>
                </div>
                <div id="estado-acuerdo" style="font-size:.65rem;margin-top:4px;"></div>
              </form>
            </div>
            
            <div id="historico-acuerdos" class="hist-section" style="border:1px solid #e2e8f0;border-radius:8px;padding:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;" data-toggle="hist-acuerdos">
                <h4 style="margin:0;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;">Hist√≥rico acuerdos</h4>
                <span style="font-size:.65rem;opacity:.7;" data-icon="hist-acuerdos">‚ñº</span>
              </div>
              <div data-body="hist-acuerdos" style="display:none;margin-top:6px;">
                <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;align-items:center;">
                  <div style="margin-left:auto;display:flex;gap:4px;">
                    <button type="button" class="mini-btn" data-export="acuerdos" title="Exportar acuerdos">‚¨áÔ∏è XLSX</button>
                  </div>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:.62rem;">
                  <thead>
                    <tr style="background:#f1f5f9;">
                      <th style="padding:4px;">Fecha</th><th style="padding:4px;">Acuerdos</th><th style="padding:4px;">Cumpl.</th><th style="padding:4px;">Obs</th>
                    </tr>
                  </thead>
                  <tbody id="hist-acuerdos-tbody"><tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div data-panel="funcionalidad" hidden>
          <!-- Contenido de Evaluaci√≥n Adulto Mayor -->
          <h3 style="margin:0 0 12px;font-size:1rem;display:flex;align-items:center;gap:6px;">üë¥ Evaluaci√≥n Adulto Mayor</h3>
          
          <!-- Formulario de Evaluaci√≥n Adulto Mayor -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
            <form id="adultoMayorForm" style="display:grid;gap:16px;">
              
              <!-- Primera fila: Fecha y Funcionalidad -->
              <div style="display:grid;grid-template-columns:1fr 2fr;gap:16px;">
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    üìÖ Fecha de Evaluaci√≥n
                  </label>
                  <input type="date" id="fechaEvaluacionAM" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:.85rem;" required>
                </div>
                
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    üèÉ Funcionalidad
                  </label>
                  <select id="funcionalidadAM" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:.85rem;" required>
                    <option value="">Seleccionar...</option>
                    <option value="autovalente">Autovalente</option>
                    <option value="autovalente_con_riesgo">Autovalente con Riesgo</option>
                    <option value="riesgo_dependencia">Riesgo de Dependencia</option>
                    <option value="dependencia_leve">Dependencia Leve</option>
                    <option value="dependencia_moderada">Dependencia Moderada</option>
                    <option value="dependencia_total">Dependencia Total</option>
                  </select>
                </div>
              </div>
              
              <!-- Segunda fila: Test TUG -->
              <div style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;background:#ffffff;">
                <h5 style="margin:0 0 12px;font-size:.85rem;color:#374151;font-weight:600;">‚è±Ô∏è Test TUG (Tiempo de apoyo en un pie)</h5>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Tiempo (segundos)
                    </label>
                    <input type="number" id="tugSegundos" step="0.01" min="0" max="999" 
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;"
                           placeholder="Ej: 12.5">
                  </div>
                  
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Clasificaci√≥n
                    </label>
                    <input type="text" id="tugClasificacion" readonly 
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;background:#f9fafb;color:#6b7280;">
                  </div>
                </div>
                
                <!-- Tabla de interpretaci√≥n TUG -->
                <div style="margin-top:12px;font-size:.7rem;">
                  <strong>üìä Interpretaci√≥n:</strong>
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:6px;text-align:center;">
                    <div style="padding:4px;background:#dcfce7;border-radius:4px;">‚â§ 10s: <strong>Bajo riesgo</strong></div>
                    <div style="padding:4px;background:#fef3c7;border-radius:4px;">11-19s: <strong>Riesgo leve</strong></div>
                    <div style="padding:4px;background:#fecaca;border-radius:4px;">‚â• 20s: <strong>Alto riesgo</strong></div>
                  </div>
                </div>
              </div>
              
              <!-- Tercera fila: Test Unipodal -->
              <div style="border:1px solid #e5e7eb;border-radius:8px;padding:12px;background:#ffffff;">
                <h5 style="margin:0 0 12px;font-size:.85rem;color:#374151;font-weight:600;">ü¶∂ Test Estaci√≥n Unipodal</h5>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ü¶∂ Pie Derecho (seg)
                    </label>
                    <input type="number" id="unipodalPieDerecho" step="0.01" min="0" max="999"
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;"
                           placeholder="Ej: 25.0">
                  </div>
                  
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ü¶∂ Pie Izquierdo (seg)
                    </label>
                    <input type="number" id="unipodalPieIzquierdo" step="0.01" min="0" max="999"
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;"
                           placeholder="Ej: 28.0">
                  </div>
                  
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Clasificaci√≥n
                    </label>
                    <input type="text" id="unipodalClasificacion" readonly
                           style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;background:#f9fafb;color:#6b7280;">
                  </div>
                </div>
                
                <!-- Tabla de interpretaci√≥n Unipodal -->
                <div style="margin-top:12px;font-size:.7rem;">
                  <strong>üìä Interpretaci√≥n:</strong>
                  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:6px;text-align:center;">
                    <div style="padding:4px;background:#fecaca;border-radius:4px;">&lt; 5s: <strong>Alto riesgo</strong></div>
                    <div style="padding:4px;background:#fef3c7;border-radius:4px;">5-30s: <strong>Riesgo intermedio</strong></div>
                    <div style="padding:4px;background:#dcfce7;border-radius:4px;">‚â• 30s: <strong>Bajo riesgo</strong></div>
                  </div>
                </div>
              </div>
              
              <!-- Campo de observaciones -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  üìù Observaciones
                </label>
                <textarea id="observacionesAM" rows="3" 
                          style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;resize:vertical;"
                          placeholder="Observaciones adicionales sobre la evaluaci√≥n..."></textarea>
              </div>
              
              <!-- Botones de acci√≥n -->
              <div style="display:flex;gap:12px;margin-top:8px;">
                <button type="button" onclick="guardarEvaluacionAdultoMayor()" class="btn" 
                        style="background:#059669;color:white;border:1px solid #047857;padding:10px 16px;font-size:.85rem;">
                  üíæ Guardar Evaluaci√≥n
                </button>
                <button type="button" onclick="limpiarFormularioAdultoMayor()" class="btn btn-outlined" 
                        style="padding:10px 16px;font-size:.85rem;">
                  üßπ Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de evaluaciones -->
            <div id="historialAdultoMayor" style="margin-top:20px;display:none;">
              <h5 style="margin:0 0 12px;font-size:.85rem;color:#374151;font-weight:600;">
                üìã Historial de Evaluaciones
              </h5>
              <div id="listHistorialAdultoMayor" style="max-height:300px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- El historial se carga din√°micamente aqu√≠ -->
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n de Actividad F√≠sica -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;margin-top:20px;">
            <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
              üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica
            </h4>
            
            <form id="actividadFisicaForm" style="display:grid;gap:12px;">
              <!-- ¬øRealiza actividad f√≠sica? -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  ¬øRealiza actividad f√≠sica?
                </label>
                <div style="display:flex;gap:12px;">
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="actividadFisica" value="si" required>
                    S√≠
                  </label>
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="actividadFisica" value="no" required>
                    No
                  </label>
                </div>
              </div>
              
              <!-- Fecha de evaluaci√≥n -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  Fecha de evaluaci√≥n
                </label>
                <input type="date" id="fechaActividadFisica" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
              </div>
              
              <!-- Botones de acci√≥n -->
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="guardarActividadFisica()" class="btn" style="font-size:.75rem;background:#16a34a;color:white;border:1px solid #15803d;padding:6px 12px;">
                  üíæ Guardar
                </button>
                <button type="button" onclick="limpiarFormularioActividadFisica()" class="btn btn-outlined" style="font-size:.75rem;">
                  Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de actividad f√≠sica -->
            <div id="historialActividadFisica" style="margin-top:16px;display:none;">
              <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üìã Historial de Actividad F√≠sica
              </h5>
              <div id="listHistorialActividadFisica" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- Se carga din√°micamente -->
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n de MasAma -->
          <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;margin-top:20px;">
            <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
              üîç MasAma
            </h4>
            
            <form id="masAmaForm" style="display:grid;gap:12px;">
              <!-- ¬øMasAma positivo? -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  ¬øMasAma positivo?
                </label>
                <div style="display:flex;gap:12px;">
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="masAma" value="si" required>
                    S√≠
                  </label>
                  <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                    <input type="radio" name="masAma" value="no" required>
                    No
                  </label>
                </div>
              </div>
              
              <!-- Fecha de evaluaci√≥n -->
              <div>
                <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                  Fecha de evaluaci√≥n
                </label>
                <input type="date" id="fechaMasAma" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
              </div>
              
              <!-- Botones de acci√≥n -->
              <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="guardarMasAma()" class="btn" style="font-size:.75rem;background:#3b82f6;color:white;border:1px solid #2563eb;padding:6px 12px;">
                  üíæ Guardar
                </button>
                <button type="button" onclick="limpiarFormularioMasAma()" class="btn btn-outlined" style="font-size:.75rem;">
                  Limpiar
                </button>
              </div>
            </form>
            
            <!-- Historial de MasAma -->
            <div id="historialMasAma" style="margin-top:16px;display:none;">
              <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üìã Historial de MasAma
              </h5>
              <div id="listHistorialMasAma" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                <!-- Se carga din√°micamente -->
              </div>
            </div>
          </div>
        </div>
        </div>
        <div data-panel="diabetes" hidden>
          <!-- Contenido completo de Evaluaci√≥n Diabetes -->
          <h3 style="margin:0 0 12px;font-size:1rem;display:flex;align-items:center;gap:6px;">ü©∫ Evaluaci√≥n Diabetes</h3>
          
          <!-- Primera fila: Evaluaci√≥n Pie Diab√©tico + Comorbilidad/Secuelas -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <!-- Tarjeta de Evaluaci√≥n Pie Diab√©tico -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü¶∂ Evaluaci√≥n Pie Diab√©tico
              </h4>
            
              <form id="evaluacionPieDiabeticoForm" style="display:grid;gap:12px;">
                <!-- ¬øTiene amputaci√≥n o √∫lcera activa? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene amputaci√≥n o √∫lcera activa?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ulceraPieOAmputacion" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ulceraPieOAmputacion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¬øSensibilidad protectora alterada? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSensibilidad protectora alterada?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="sensibilidadProtectora" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="sensibilidadProtectora" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¬øEnfermedad arterial perif√©rica? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øEnfermedad arterial perif√©rica?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="EAP" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="EAP" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- ¬øTiene deformidad? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene deformidad?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="DEF" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="DEF" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluaci√≥n
                  </label>
                  <input type="date" id="fechaEvaluacionPieDiabetico" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="evaluarRiesgoPieDiabetico()" class="btn btn-azul" style="font-size:.75rem;">
                    Evaluar Riesgo
                  </button>
                  <button type="button" id="btnGuardarPieDiabetico" onclick="guardarEvaluacionPieDiabetico()" class="btn" style="font-size:.75rem;display:none;background:#16a34a;color:white;border:1px solid #15803d;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioPieDiabetico()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
                
                <!-- Resultado -->
                <div id="resultadoPieDiabetico" class="espacioresultado" style="margin-top:12px;padding:12px;border-radius:6px;background:#f1f5f9;border:1px solid #cbd5e1;display:none;">
                  <div class="resultado-contenido" style="font-size:.8rem;line-height:1.4;"></div>
                </div>
              </form>
              
              <!-- Historial de evaluaciones -->
              <div id="historialPieDiabetico" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Evaluaciones
                </h5>
                <div id="listHistorialPieDiabetico" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Comorbilidad/Secuelas -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üìä Comorbilidad / Secuelas
              </h4>
              
              <!-- Panel de diagn√≥sticos detectados -->
              <div id="comorbilidadPanel" style="display:grid;gap:12px;">
                <!-- Estado de carga -->
                <div id="comorbilidadEstado" style="padding:8px;text-align:center;color:#6b7280;font-size:0.75rem;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb;">
                  <span>Analizando diagn√≥sticos...</span>
                </div>
                
                <!-- Contenedor de diagn√≥sticos -->
                <div id="diagnosticosDetectados" style="display:none;">
                  <!-- Diagn√≥sticos se cargan din√°micamente aqu√≠ -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Segunda fila: Curaciones + EKG -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
            <!-- Tarjeta de Curaciones Pie Diab√©tico -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü©π Curaciones Pie Diab√©tico
              </h4>
              
              <form id="curacionesPieDiabeticoForm" style="display:grid;gap:12px;">
                <!-- ¬øSe encuentra en curaciones? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSe encuentra en curaciones?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="enCuracion" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="enCuracion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Tipo de curaci√≥n (solo si est√° en curaciones) -->
                <div id="tipoCuracionContainer" style="display:none;">
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Tipo de curaci√≥n
                  </label>
                  <select id="tipoCuracion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                    <option value="">-- Seleccione tipo --</option>
                    <option value="Curaci√≥n Convencional">Curaci√≥n Convencional</option>
                    <option value="Curaci√≥n Avanzada">Curaci√≥n Avanzada</option>
                    <option value="Con ayuda t√©cnica de descarga">Con ayuda t√©cnica de descarga</option>
                  </select>
                </div>
                
                <!-- Fecha -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha
                  </label>
                  <input type="date" id="fechaCuracion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarCuracion()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioCuraciones()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de curaciones -->
              <div id="historialCuraciones" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Curaciones
                </h5>
                <div id="listHistorialCuraciones" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de EKG -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ‚ö° Electrocardiograma (EKG)
              </h4>
              
              <form id="ekgForm" style="display:grid;gap:12px;">
                <!-- ¬øSe realiz√≥ EKG? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSe realiz√≥ EKG?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ekgRealizado" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="ekgRealizado" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha del EKG -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha del EKG
                  </label>
                  <input type="date" id="fechaEkg" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarEkg()" class="btn" style="font-size:.75rem;background:#7c3aed;color:white;border:1px solid #6d28d9;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioEkg()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de EKG -->
              <div id="historialEkg" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de EKG
                </h5>
                <div id="listHistorialEkg" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tercera fila: Hipoglicemias + Amputaci√≥n -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
            <!-- Tarjeta de Hipoglicemias Recurrentes -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü©∏ Hipoglicemias Recurrentes
              </h4>
              
              <form id="hipoglicemiasForm" style="display:grid;gap:12px;">
                <!-- ¬øPresenta hipoglicemias recurrentes? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øPresenta hipoglicemias recurrentes?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="hipoglicemiasRecurrentes" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="hipoglicemiasRecurrentes" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluaci√≥n
                  </label>
                  <input type="date" id="fechaHipoglicemias" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarHipoglicemias()" class="btn" style="font-size:.75rem;background:#dc2626;color:white;border:1px solid #b91c1c;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioHipoglicemias()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de hipoglicemias -->
              <div id="historialHipoglicemias" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Hipoglicemias
                </h5>
                <div id="listHistorialHipoglicemias" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Amputaci√≥n -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü¶ø Amputaci√≥n
              </h4>
              
              <form id="amputacionForm" style="display:grid;gap:12px;">
                <!-- ¬øTiene amputaci√≥n? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene amputaci√≥n?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="tieneAmputacion" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="tieneAmputacion" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de amputaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de amputaci√≥n
                  </label>
                  <input type="date" id="fechaAmputacion" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarAmputacion()" class="btn" style="font-size:.75rem;background:#f59e0b;color:white;border:1px solid #d97706;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioAmputacion()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de amputaci√≥n -->
              <div id="historialAmputacion" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Amputaci√≥n
                </h5>
                <div id="listHistorialAmputacion" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Cuarta fila: Atenci√≥n Pod√≥loga + Fondo de Ojos -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
            <!-- Tarjeta de Atenci√≥n Pod√≥loga -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü¶∂ Atenci√≥n Pod√≥loga
              </h4>
              
              <form id="podologiaForm" style="display:grid;gap:12px;">
                <!-- ¬øTiene atenci√≥n podol√≥gica vigente? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øTiene atenci√≥n podol√≥gica vigente?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="atencionPodologa" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="atencionPodologa" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha de evaluaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha de evaluaci√≥n
                  </label>
                  <input type="date" id="fechaPodologia" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarPodologia()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioPodologia()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de atenci√≥n podol√≥gica -->
              <div id="historialPodologia" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Atenci√≥n Podol√≥gica
                </h5>
                <div id="listHistorialPodologia" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Tarjeta de Fondo de Ojos -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                üëÅÔ∏è Fondo de Ojos
              </h4>
              
              <form id="fondoOjosForm" style="display:grid;gap:12px;">
                <!-- ¬øSe realiz√≥ fondo de ojos? -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    ¬øSe realiz√≥ fondo de ojos?
                  </label>
                  <div style="display:flex;gap:12px;">
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="fondoOjos" value="si" required>
                      S√≠
                    </label>
                    <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                      <input type="radio" name="fondoOjos" value="no" required>
                      No
                    </label>
                  </div>
                </div>
                
                <!-- Fecha del fondo de ojos -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha del fondo de ojos
                  </label>
                  <input type="date" id="fechaFondoOjos" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarFondoOjos()" class="btn" style="font-size:.75rem;background:#9333ea;color:white;border:1px solid #7c2d12;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioFondoOjos()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de fondo de ojos -->
              <div id="historialFondoOjos" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de Fondo de Ojos
                </h5>
                <div id="listHistorialFondoOjos" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <div data-panel="farmacos" hidden>
          <!-- Contenido de f√°rmacos -->
          <h3 style="margin:0 0 8px;font-size:1rem;display:flex;align-items:center;gap:6px;">üíä F√°rmacos</h3>
          <!-- Grid de f√°rmacos en filas -->
          <div style="display:grid;gap:16px;">
            
            <!-- Primera fila: IECA/ARA II -->
            <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
              <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                ü©∫ IECA / ARA II
                <span style="cursor:help;color:#6b7280;font-size:1rem;" title="Los IECA (Inhibidores de la Enzima Convertidora de Angiotensina) y los ARA II (Antagonistas del Receptor de Angiotensina II) son dos grupos de medicamentos que act√∫an sobre el sistema renina-angiotensina-aldosterona, fundamentales en el manejo de la hipertensi√≥n arterial, la insuficiencia card√≠aca, la nefroprotecci√≥n en diabetes/ERCT y la prevenci√≥n cardiovascular.

Aunque ambos reducen la acci√≥n de la angiotensina II (potente vasoconstrictor), lo hacen por mecanismos distintos:
‚Ä¢ ü©∫ IECA: bloquean la conversi√≥n de angiotensina I en angiotensina II.
‚Ä¢ ü©∫ ARA II: bloquean directamente el receptor AT1 de la angiotensina II.

üß™ Lista de medicamentos m√°s usados

ü©π IECA (Inhibidores de la ECA)
‚Ä¢ Enalapril (Enalapril¬Æ, Renitec¬Æ) - Muy utilizado en HTA y falla card√≠aca
‚Ä¢ Captopril (Capoten¬Æ) - Acci√≥n corta; √∫til en urgencias hipertensivas orales
‚Ä¢ Lisinopril (Zestril¬Æ, Prinivil¬Æ) - Alta duraci√≥n, uso diario
‚Ä¢ Ramipril (Tritace¬Æ) - Cardioprotector y nefroprotector
‚Ä¢ Perindopril (Coversyl¬Æ) - Muy usado en prevenci√≥n secundaria CV

üíä ARA II (Antagonistas del receptor de angiotensina II)
‚Ä¢ Losart√°n (Cozaar¬Æ) - Muy usado en HTA y nefroprotecci√≥n diab√©tica
‚Ä¢ Valsart√°n (Diovan¬Æ) - Cardioprotector post-IAM
‚Ä¢ Candesart√°n (Atacand¬Æ) - Alta potencia y duraci√≥n
‚Ä¢ Irbesart√°n (Aprovel¬Æ) - Excelente opci√≥n renal y CV
‚Ä¢ Olmesart√°n (Benicar¬Æ) - Larga acci√≥n, buen control 24 h

üß† Perlas cl√≠nicas:
‚Ä¢ Nunca se combinan IECA y ARA II juntos salvo indicaciones muy espec√≠ficas
‚Ä¢ En diab√©ticos con microalbuminuria o ERC, IECA o ARA II son primera l√≠nea
‚Ä¢ En insuficiencia card√≠aca con FEVI reducida, suelen ser parte del esquema base">‚ÑπÔ∏è</span>
              </h4>
              
              <form id="iecaAraForm" style="display:grid;gap:12px;">
                <!-- Tipo de medicaci√≥n -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Tipo de medicaci√≥n
                  </label>
                  <select id="tipoIecaAra" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;" required>
                    <option value="">-- Seleccione --</option>
                    <option value="NO">NO</option>
                    <option value="IECA">IECA</option>
                    <option value="ARA II">ARA II</option>
                  </select>
                </div>
                
                <!-- Fecha -->
                <div>
                  <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                    Fecha
                  </label>
                  <input type="date" id="fechaIecaAra" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                </div>
                
                <!-- Botones de acci√≥n -->
                <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                  <button type="button" onclick="guardarIecaAra()" class="btn" style="font-size:.75rem;background:#059669;color:white;border:1px solid #047857;padding:6px 12px;">
                    üíæ Guardar
                  </button>
                  <button type="button" onclick="limpiarFormularioIecaAra()" class="btn btn-outlined" style="font-size:.75rem;">
                    Limpiar
                  </button>
                </div>
              </form>
              
              <!-- Historial de IECA/ARA II -->
              <div id="historialIecaAra" style="margin-top:16px;display:none;">
                <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üìã Historial de IECA/ARA II
                </h5>
                <div id="listHistorialIecaAra" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </div>
            
            <!-- Segunda fila: Estatinas + Antiagregante plaquetario -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
              <!-- Tarjeta de Estatinas -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
                <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  üß™ Estatinas
                </h4>
                
                <form id="estatinasForm" style="display:grid;gap:12px;">
                  <!-- ¬øRecibe estatinas? -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ¬øRecibe estatinas?
                    </label>
                    <div style="display:flex;gap:12px;">
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeEstatinas" value="si" required>
                        S√≠
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeEstatinas" value="no" required>
                        No
                      </label>
                    </div>
                  </div>
                  
                  <!-- Fecha -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Fecha
                    </label>
                    <input type="date" id="fechaEstatinas" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                  </div>
                  
                  <!-- Botones de acci√≥n -->
                  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                    <button type="button" onclick="guardarEstatinas()" class="btn" style="font-size:.75rem;background:#7c3aed;color:white;border:1px solid #6d28d9;padding:6px 12px;">
                      üíæ Guardar
                    </button>
                    <button type="button" onclick="limpiarFormularioEstatinas()" class="btn btn-outlined" style="font-size:.75rem;">
                      Limpiar
                    </button>
                  </div>
                </form>
                
                <!-- Historial de estatinas -->
                <div id="historialEstatinas" style="margin-top:16px;display:none;">
                  <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                    üìã Historial de Estatinas
                  </h5>
                  <div id="listHistorialEstatinas" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
              
              <!-- Tarjeta de Antiagregante plaquetario -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f9fafb;">
                <h4 style="margin:0 0 16px;font-size:.9rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                  ü©∏ Antiagregante Plaquetario
                </h4>
                
                <form id="antiagregantesForm" style="display:grid;gap:12px;">
                  <!-- ¬øRecibe antiagregantes? -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      ¬øRecibe antiagregante plaquetario?
                    </label>
                    <div style="display:flex;gap:12px;">
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeAntiagregantes" value="si" required>
                        S√≠
                      </label>
                      <label style="display:flex;align-items:center;gap:4px;font-size:.75rem;">
                        <input type="radio" name="recibeAntiagregantes" value="no" required>
                        No
                      </label>
                    </div>
                  </div>
                  
                  <!-- Fecha -->
                  <div>
                    <label style="display:block;font-size:.75rem;font-weight:600;margin-bottom:6px;">
                      Fecha
                    </label>
                    <input type="date" id="fechaAntiagregantes" style="width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:.75rem;">
                  </div>
                  
                  <!-- Botones de acci√≥n -->
                  <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
                    <button type="button" onclick="guardarAntiagregantes()" class="btn" style="font-size:.75rem;background:#dc2626;color:white;border:1px solid #b91c1c;padding:6px 12px;">
                      üíæ Guardar
                    </button>
                    <button type="button" onclick="limpiarFormularioAntiagregantes()" class="btn btn-outlined" style="font-size:.75rem;">
                      Limpiar
                    </button>
                  </div>
                </form>
                
                <!-- Historial de antiagregantes -->
                <div id="historialAntiagregantes" style="margin-top:16px;display:none;">
                  <h5 style="margin:0 0 8px;font-size:.8rem;color:#065f46;display:flex;align-items:center;gap:6px;">
                    üìã Historial de Antiagregantes
                  </h5>
                  <div id="listHistorialAntiagregantes" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:#fff;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div data-panel="adulto_mayor" hidden>
          <!-- Panel de Screening dentro de Evaluaci√≥n Adulto Mayor -->
          <div style="display:grid;gap:20px;">
            
            <!-- Secci√≥n Vacunas -->
            <section class="card" style="padding:16px;">
              <h3 style="margin:0 0 16px;font-size:1rem;display:flex;align-items:center;gap:6px;">
                üíâ Vacunas
              </h3>
              
              <!-- Vacuna Influenza -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;background:#f9fafb;">
                <h4 style="margin:0 0 12px;font-size:.9rem;color:#1e293b;">ü¶† Vacuna Influenza</h4>
                <form id="formVacunaInfluenzaAM" style="display:grid;gap:12px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaInfluenzaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Estado:</label>
                  <select id="estadoInfluenzaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="SI">S√≠</option>
                    <option value="NO">No</option>
                    <option value="RECHAZA">Rechaza</option>
                  </select>
                  
                  <button type="button" onclick="guardarVacuna('influenza')" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar Influenza
                  </button>
                </form>
              </div>
              
              <!-- Vacuna COVID -->
              <div style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;background:#f9fafb;">
                <h4 style="margin:0 0 12px;font-size:.9rem;color:#1e293b;">ü¶† Vacuna COVID</h4>
                <form id="formVacunaCovidAM" style="display:grid;gap:12px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaCovidAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Estado:</label>
                  <select id="estadoCovidAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="SI">S√≠</option>
                    <option value="NO">No</option>
                    <option value="RECHAZA">Rechaza</option>
                  </select>
                  
                  <button type="button" onclick="guardarVacuna('covid')" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar COVID
                  </button>
                </form>
              </div>
              
              <!-- Historial de Vacunas -->
              <div id="historialVacunasAM" style="display:none;margin-top:16px;">
                <h4 style="margin:0 0 8px;font-size:.9rem;color:#1e293b;">üìã Historial de Vacunaci√≥n</h4>
                <div id="listaHistorialVacunasAM" style="max-height:200px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:8px;background:white;">
                  <!-- Se carga din√°micamente -->
                </div>
              </div>
            </section>
            
            <!-- Secci√≥n Screening por G√©nero -->
            <section class="card" style="padding:16px;">
              <h3 style="margin:0 0 16px;font-size:1rem;display:flex;align-items:center;gap:6px;">
                üîç Screening por G√©nero
              </h3>
              
              <!-- PAP (Mujeres 25-64 a√±os) -->
              <div id="seccionPAPAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;background:#fef7f7;">
                <h4 style="margin:0 0 12px;font-size:.9rem;color:#1e293b;">üë©‚Äç‚öïÔ∏è PAP (Mujeres 25-64 a√±os)</h4>
                <form id="formPAPAM" style="display:grid;gap:12px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaPAPAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Realizado:</label>
                  <select id="estadoPAPAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="true">S√≠</option>
                    <option value="false">No</option>
                  </select>
                  
                  <label style="font-size:.85rem;font-weight:600;">Resultado:</label>
                  <input type="text" id="resultadoPAPAM" placeholder="Resultado del PAP" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <button type="button" onclick="guardarPAP()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar PAP
                  </button>
                </form>
                
                <!-- Historial PAP -->
                <div id="historialPAPAM" style="display:none;margin-top:12px;">
                  <h5 style="margin:0 0 6px;font-size:.8rem;color:#374151;">Historial PAP</h5>
                  <div id="listaHistorialPAPAM" style="max-height:150px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.8rem;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
              
              <!-- Mamograf√≠a (Mujeres 50-69 a√±os) -->
              <div id="seccionMamografiaAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px;background:#fef7f7;">
                <h4 style="margin:0 0 12px;font-size:.9rem;color:#1e293b;">ü©ª Mamograf√≠a (Mujeres 50-69 a√±os)</h4>
                <form id="formMamografiaAM" style="display:grid;gap:12px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Realizada:</label>
                  <select id="estadoMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="true">S√≠</option>
                    <option value="false">No</option>
                  </select>
                  
                  <label style="font-size:.85rem;font-weight:600;">BI-RADS:</label>
                  <select id="biradsMamografiaAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                    <option value="">Seleccionar...</option>
                    <option value="0">0 - Incompleta</option>
                    <option value="1">1 - Negativa</option>
                    <option value="2">2 - Benigna</option>
                    <option value="3">3 - Probablemente benigna</option>
                    <option value="4">4 - Sospechosa</option>
                    <option value="5">5 - Altamente sugestiva</option>
                    <option value="6">6 - Malignidad conocida</option>
                  </select>
                  
                  <button type="button" onclick="guardarMamografia()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar Mamograf√≠a
                  </button>
                </form>
                
                <!-- Historial Mamograf√≠a -->
                <div id="historialMamografiaAM" style="display:none;margin-top:12px;">
                  <h5 style="margin:0 0 6px;font-size:.8rem;color:#374151;">Historial Mamograf√≠a</h5>
                  <div id="listaHistorialMamografiaAM" style="max-height:150px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.8rem;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
              
              <!-- PSA (Hombres ‚â•50 a√±os) -->
              <div id="seccionPSAAM" style="border:1px solid #e2e8f0;border-radius:8px;padding:16px;background:#f0f9ff;">
                <h4 style="margin:0 0 12px;font-size:.9rem;color:#1e293b;">üë®‚Äç‚öïÔ∏è PSA (Hombres ‚â•50 a√±os)</h4>
                <form id="formPSAAM" style="display:grid;gap:12px;grid-template-columns:auto 1fr 1fr auto;align-items:center;">
                  <label style="font-size:.85rem;font-weight:600;">Fecha:</label>
                  <input type="date" id="fechaPSAAM" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <label style="font-size:.85rem;font-weight:600;">Valor PSA:</label>
                  <input type="number" id="valorPSAAM" placeholder="ng/mL" step="0.01" min="0" style="padding:6px;border:1px solid #d1d5db;border-radius:4px;">
                  
                  <button type="button" onclick="guardarPSA()" class="btn" style="grid-column:1/-1;justify-self:start;padding:8px 16px;">
                    Guardar PSA
                  </button>
                </form>
                
                <!-- Historial PSA -->
                <div id="historialPSAAM" style="display:none;margin-top:12px;">
                  <h5 style="margin:0 0 6px;font-size:.8rem;color:#374151;">Historial PSA</h5>
                  <div id="listaHistorialPSAAM" style="max-height:150px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:4px;padding:6px;background:white;font-size:.8rem;">
                    <!-- Se carga din√°micamente -->
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<script id="riesgo-cv-script">
(function(){
  const fechaInput = document.getElementById('riesgo_cv_fecha');
  const nivelSelect = document.getElementById('riesgo_cv_nivel');
  const btnGuardar = document.getElementById('btn-guardar-riesgo-cv');
  const estado = document.getElementById('estado-riesgo-cv');
  const spanUltimo = document.getElementById('ultimo-riesgo-cv');
  const spanUltimoFecha = document.getElementById('ultimo-riesgo-cv-fecha');
  const resumenCategoria = document.querySelector('#resumen-ident .categoria-riesgo');

  function hoyISO(){
    const d=new Date();
    return d.toISOString().slice(0,10);
  }
  if (fechaInput && !fechaInput.value) fechaInput.value = hoyISO();

  async function cargarRiesgoCV(run){
    if(!run){return;}
    try{
      estado.textContent='Cargando‚Ä¶';
      const r = await fetch(`/api/riesgo-cv/ultimo?run=${encodeURIComponent(run)}`);
      if(!r.ok){throw new Error('HTTP '+r.status);}    
      const data = await r.json();
      if(data && data.riesgo){
        spanUltimo.textContent = (data.riesgo || '‚Äî').toUpperCase();
        spanUltimoFecha.textContent = data.fecha || '‚Äî';
        if(!nivelSelect.value){ nivelSelect.value = data.riesgo; }
        if(!fechaInput.value && data.fecha){ fechaInput.value = data.fecha; }
      } else {
        spanUltimo.textContent='‚Äî'; spanUltimoFecha.textContent='‚Äî';
      }
      estado.textContent='';
    }catch(e){
      console.error('Error cargando riesgo CV', e); estado.textContent='Error cargando';
    }
  }

  async function guardarRiesgo(){
    const run = (document.getElementById('run')?.value || '').trim();
    const fecha = fechaInput.value;
    const riesgo = nivelSelect.value;
    if(!run || !fecha || !riesgo){ estado.textContent='Completar campos'; return; }
    estado.textContent='Guardando‚Ä¶';
    try{
      const resp = await fetch('/api/riesgo-cv/crear', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({run, fecha, riesgo})
      });
      const data = await resp.json();
      if(!resp.ok || data.success===false){ throw new Error(data.error||'Error'); }
      estado.textContent='Guardado';
      spanUltimo.textContent = riesgo.toUpperCase();
      spanUltimoFecha.textContent = fecha;
      // Actualiza resumen si alto/moderado/bajo
      if(resumenCategoria && resumenCategoria.textContent && resumenCategoria.textContent !== '‚Äî'){
        resumenCategoria.setAttribute('data-riesgo-cv', riesgo);
      }
      setTimeout(()=>{ estado.textContent=''; }, 2000);
    }catch(e){
      console.error('Error guardando riesgo CV', e); estado.textContent='Error';
    }
  }

  btnGuardar?.addEventListener('click', guardarRiesgo);

  // Hook en flujo existente de autocompletarIdentificacion
  const originalAuto = window.autocompletarIdentificacion;
  window.autocompletarIdentificacion = function(u, selSector){
    try { originalAuto && originalAuto(u, selSector); } catch(_e){}
    const run = u?.run || u?.usuario_run || document.getElementById('run')?.value;
    if(run){ cargarRiesgoCV(run); }
  };

  // Exponer funci√≥n manual
  window.cargarRiesgoCV = cargarRiesgoCV;
})();
</script>
<script>
// === IA UNIFICADA TARJET√ìN ===
(function(){
  const btnFull = document.getElementById('btn-ai-autocomplete');
  const btnSimple = document.getElementById('btn-ai-fill');
  const areaFull = document.getElementById('ai-texto-clinico');
  const areaSimple = document.getElementById('ai-texto');
  const statusFull = document.getElementById('ai-autocomplete-status');
  const statusSimple = document.getElementById('ai-fill-status');

  // Toast ligero
  function showToast(msg){
    let t = document.getElementById('ai-toast');
    if(!t){
      t = document.createElement('div');
      t.id='ai-toast';
      t.style.cssText='position:fixed;bottom:18px;right:18px;background:#065f46;color:#fff;padding:10px 14px;border-radius:8px;font-size:.75rem;z-index:9999;box-shadow:0 4px 10px rgba(0,0,0,.15);opacity:0;transition:opacity .25s;';
      document.body.appendChild(t);
    }
    t.textContent=msg; t.style.opacity='1';
    setTimeout(()=>{ t.style.opacity='0'; }, 2500);
  }

  function setStatus(el,msg,kind='info'){
    if(!el) return;
    el.style.display='block';
    const colors={info:'#334155',ok:'#065f46',error:'#b91c1c'};
    el.style.color=colors[kind]||colors.info; el.textContent=msg;
  }

  function highlightField(el, changedTabs){
    if(!el) return;
    el.classList.add('mandrake-modified');
    const node = el.closest('[data-tab-panel]');
    if(node){ changedTabs.add(node.getAttribute('data-tab-panel')); }
  }

  function markTabs(changedTabs){
    if(!changedTabs.size) return;
    document.querySelectorAll('.t-tab').forEach(tabBtn=>{
      const key = tabBtn.getAttribute('data-tab');
      if(changedTabs.has(key) && !tabBtn.querySelector('.mandrake-indicator')){
        const dot=document.createElement('span');
        dot.className='mandrake-indicator';
        tabBtn.style.position='relative';
        tabBtn.appendChild(dot);
        tabBtn.classList.add('mandrake-tab-modified');
      }
    });
  }

  // Exponer global para evitar ReferenceError en cargas tempranas
  window.computeIMC = function computeIMC(){
    const peso = parseFloat(document.querySelector('#form-control-nuevo [name="peso"]')?.value||'');
    const talla = parseFloat(document.querySelector('#form-control-nuevo [name="talla"]')?.value||'');
    if(peso>0 && talla>0){
      const imc = peso / Math.pow(talla/100,2);
      const span = document.querySelector('[data-f="imc"]');
      if(span){ span.textContent = imc.toFixed(1); }
      const clas = (imc<18.5)?'Bajo peso':(imc<25)?'Normal':(imc<30)?'Sobrepeso':(imc<35)?'Obesidad I':(imc<40)?'Obesidad II':'Obesidad III';
      const badge=document.getElementById('imc-clasif');
      if(badge){ badge.textContent=clas; badge.style.display='inline-block'; badge.style.background = imc>=30? '#b91c1c' : (imc>=25? '#f59e0b':'#0d9488'); badge.style.color='#fff'; }
    }
  }

  function fillFirstLab(firstLab, changedTabs){
    if(!firstLab) return;
    const root=document.getElementById('form-lab-nuevo');
    if(!root) return;
    const set=(name,val)=>{ if(val!==undefined && val!==null && val!==''){ const el=root.querySelector(`[name="${name}"]`); if(el){ const prev=el.value; el.value=val; if(prev!==String(val)) highlightField(el, changedTabs);} } };
    set('examen_fecha', firstLab.examen_fecha);
    ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'].forEach(k=>set(k, firstLab[k]));
  }

  function applyCanonical(d){
    const changedTabs = new Set();
    // Identificaci√≥n b√°sica
    const mapBasic = { run:'run', nombre:'nombre', fecha_nacimiento:'fecha_nacimiento', sexo:'sexo' };
    Object.entries(mapBasic).forEach(([k,id])=>{ const el=document.getElementById(id); if(el && d[k]){ const prev=el.value; el.value=d[k]; if(prev!==d[k]) highlightField(el, changedTabs);} });
    // Control (con conversi√≥n de talla si viene en metros <3)
    const controlMap={ peso:'peso', talla:'talla', presion_sistolica:'presion_sistolica', presion_diastolica:'presion_diastolica', cc:'cc', hgt:'hgt', hba1c:'hba1c' };
    Object.entries(controlMap).forEach(([k,n])=>{
      if(d[k]!=null){
        const el=document.querySelector(`#form-control-nuevo [name="${n}"]`);
        if(el){
          let val=d[k];
          if(n==='talla' && val!=='' && val!=null){
            const num=parseFloat(String(val).replace(',','.'));
            if(!isNaN(num) && num>0 && num<3){ val=(num*100).toFixed(2); }
          }
          const prev=el.value; el.value=val; if(prev!==String(val)) highlightField(el, changedTabs);
        }
      }
    });
    // Fecha control: usar fecha_atencion si viene y campo vac√≠o
    if(d.fecha_atencion){ const fCtl=document.querySelector('#form-control-nuevo [name="fecha"]'); if(fCtl && !fCtl.value){ try { const iso=d.fecha_atencion.length===10? d.fecha_atencion : d.fecha_atencion.split('T')[0]; if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(iso)){ const prev=fCtl.value; fCtl.value=iso; if(prev!==iso) highlightField(fCtl, changedTabs);} } catch(_){} } }
    // Tamizajes
    const dateMap={ fondo_ojo_fecha:'fechaFondoOjos', pie_dm_fecha:'fechaPieDM', podologia_fecha:'fechaPodologia', ekg_fecha:'fechaEkg', mamografia_fecha:'fechaMamografiaAM', psa_fecha:'fechaPSAAM' };
    Object.entries(dateMap).forEach(([k,id])=>{ if(d[k]){ const el=document.getElementById(id); if(el){ const prev=el.value; el.value=d[k]; if(prev!==d[k]) highlightField(el, changedTabs);} } });
    if(d.psa_valor!=null){ const el=document.getElementById('valorPSAAM'); if(el){ const prev=el.value; el.value=d.psa_valor; if(prev!==String(d.psa_valor)) highlightField(el, changedTabs);} }
    if(d.mamografia_birads){ const el=document.getElementById('biradsMamografiaAM'); if(el){ const prev=el.value; el.value=d.mamografia_birads; if(prev!==d.mamografia_birads) highlightField(el, changedTabs);} }
    if(typeof d.mamografia_realizada==='boolean'){ const el=document.getElementById('estadoMamografiaAM'); if(el){ const prev=el.value; el.value=d.mamografia_realizada?'true':'false'; if(prev!==el.value) highlightField(el, changedTabs);} }
    // Patolog√≠as (mostrar lista + preseleccionar en panel riesgo)
    if(Array.isArray(d.patologias)){
      const ul=document.getElementById('lista-patologias');
      if(ul){ ul.innerHTML=''; if(!d.patologias.length){ ul.innerHTML='<li style="opacity:.6;">Sin datos</li>'; } else { d.patologias.forEach(p=>{ const li=document.createElement('li'); li.textContent=p; ul.appendChild(li);}); } highlightField(ul, changedTabs);} 
      try {
        if(window._riesgoCatalogo && Array.isArray(window._riesgoCatalogo)){
          const norm=s=>String(s||'').toLowerCase();
          const encontrados=new Set();
          d.patologias.forEach(txt=>{
            const t=norm(txt);
            const hit=window._riesgoCatalogo.find(p=> norm(p.nombre)===t || norm(p.nombre).includes(t) || t.includes(norm(p.nombre)) || (p.cie10 && t.includes(p.cie10.toLowerCase())));
            if(hit){ encontrados.add(hit.id); }
          });
          if(encontrados.size){
            if(window._riesgoSeleccion instanceof Set){ encontrados.forEach(id=>window._riesgoSeleccion.add(id)); }
            if(typeof window._riesgoRender==='function'){ window._riesgoRender(); }
            const estado=document.getElementById('estado-patologias'); if(estado){ estado.textContent='Patolog√≠as detectadas v√≠a IA preseleccionadas ('+encontrados.size+')'; estado.style.color='#0369a1'; }
          }
        }
      } catch(_e){}
    }
    // Labs first
    if(Array.isArray(d.labs) && d.labs.length){ fillFirstLab(d.labs[0], changedTabs); }
    // IMC
  window.computeIMC && window.computeIMC();
    // Tabs
    markTabs(changedTabs);
    // Minimizar bot
    try { const overlay=document.getElementById('mandrake-chat-overlay'); if(overlay && overlay.style.display!=='none'){ overlay.style.display='none'; } } catch(_e){}
  }

  async function runAI(source){
    const isFull = source==='full';
    const btn = isFull? btnFull : btnSimple;
    const area = isFull? areaFull : areaSimple;
    const statusEl = isFull? statusFull : statusSimple;
    if(!btn || !area) return;
    const raw = (area.value||'').trim();
    if(!raw){ alert('Pega el texto cl√≠nico primero.'); return; }
    const prev=btn.textContent; btn.disabled=true; btn.textContent='Procesando‚Ä¶'; setStatus(statusEl,'Llamando IA‚Ä¶');
    try {
      const resp = await fetch('/api/ai/tarjeton-fill',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({texto:raw})});
      const j = await resp.json();
      if(!j.ok){ setStatus(statusEl,'Error: '+(j.error||resp.status),'error'); btn.textContent=prev; btn.disabled=false; return; }
      setStatus(statusEl,'Aplicando datos ('+j.mode+')','ok');
      (function ensureLabsArray(d){
        if(!d) return;
        if(Array.isArray(d.labs)) return; // ya viene bien
        const keys=['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'];
        const has = keys.some(k=> d[k]!=null && d[k]!=='' );
        if(has){
          const labObj={};
          keys.forEach(k=>{ if(d[k]!=null && d[k]!=='' ) labObj[k]=d[k]; });
          labObj.examen_fecha = d.examen_fecha || d.fecha_atencion || d.fecha_examen;
          d.labs=[labObj];
        }
      })(j.data||{});
      applyCanonical(j.data||{});
      // Autosave r√°pido (no bloqueante)
      try {
        const runVal = document.getElementById('run')?.value?.trim();
        if(runVal){
          const ctlRoot = document.getElementById('form-control-nuevo');
            const takeNum = (name)=>{ const el=ctlRoot?.querySelector(`[name="${name}"]`); if(!el) return undefined; const v=el.value.trim(); if(!v) return undefined; const n=parseFloat(v.replace(',','.')); return isNaN(n)? undefined : n; };
            const payloadControl = {
              run: runVal,
              peso: takeNum('peso'),
              talla: takeNum('talla'),
              presion_sistolica: takeNum('presion_sistolica'),
              presion_diastolica: takeNum('presion_diastolica'),
              cc: takeNum('cc'),
              hgt: takeNum('hgt'),
              hba1c: takeNum('hba1c')
            };
            const hasControl = Object.values(payloadControl).some(v=>typeof v==='number');
            const labRoot = document.getElementById('form-lab-nuevo');
            const labTake = (name)=>{ const el=labRoot?.querySelector(`[name="${name}"]`); if(!el) return undefined; const v=el.value.trim(); if(!v) return undefined; const n=parseFloat(v.replace(',','.')); return isNaN(n)? undefined : n; };
            const payloadLab = {
              run: runVal,
              examen_fecha: labRoot?.querySelector('[name="examen_fecha"]')?.value || undefined,
              glicemia: labTake('glicemia'),
              hba1c: labTake('hba1c'),
              ldl: labTake('ldl'),
              hdl: labTake('hdl'),
              col: labTake('col'),
              tag: labTake('tag'),
              creatinemia: labTake('creatinemia'),
              vfg: labTake('vfg'),
              rac: labTake('rac'),
              microalbuminuria_val: labTake('microalbuminuria_val'),
              tsh: labTake('tsh')
            };
            const hasLabs = Object.entries(payloadLab).some(([k,v])=>['run','examen_fecha'].indexOf(k)===-1 && typeof v==='number');
            const ops = [];
            if(hasControl){ ops.push(fetch('/api/control/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadControl)})); }
            if(hasLabs){ ops.push(fetch('/api/labs/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadLab)})); }
            if(ops.length){ Promise.allSettled(ops).then(rs=>{ const ok=rs.filter(r=>r.status==='fulfilled').length; if(ok){ showToast('Guardado r√°pido ('+ok+')'); } }).catch(()=>{}); }
        }
      } catch(_e) {}
      btn.textContent='‚úÖ IA aplicado';
      showToast('Autocompletado aplicado');
      setTimeout(()=>{ btn.textContent=prev; btn.disabled=false; },2000);
    } catch(e){ console.error(e); setStatus(statusEl,'Excepci√≥n: '+e,'error'); btn.textContent=prev; btn.disabled=false; }
  }

  if(btnFull){ btnFull.addEventListener('click', ()=>runAI('full')); }
  if(btnSimple){ btnSimple.addEventListener('click', ()=>runAI('simple')); }
})();
</script>





<script>
(function(){
  // === Helpers puros ===
  const buildDefaultOptions = (options = {}) => ({
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json',
      ...(options.headers || {}),
    },
  });

  const logByStatus = (response, url) => {
    // Mismo orden y mensajes que el original
    if (response.status === 403) {
      console.log(`[API] Sin autorizaci√≥n: ${url} (posible problema de autenticaci√≥n)`);
    } else if (response.status >= 500) {
      console.log(`[API] Error del servidor: ${url} (${response.status})`);
    } else if (response.status === 404) {
      console.log(`[API] Endpoint no encontrado: ${url}`);
    }
  };

  // Helper para fetch con autenticaci√≥n y manejo de errores mejorado
  const authFetch = async (url, options = {}) => {
    const defaultOptions = buildDefaultOptions(options);
    
    // Agregar timeout por defecto
    const timeoutMs = options.timeout || 10000; // 10 segundos
    const maxRetries = options.retries || 1;
    
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        // Crear AbortController para timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
        
        const fetchOptions = { 
          ...defaultOptions, 
          ...options, 
          signal: controller.signal 
        };
        
        console.log(`[API] Intento ${attempt + 1}/${maxRetries + 1} - ${url}`);
        
        const response = await fetch(url, fetchOptions);
        clearTimeout(timeoutId);

        // Logs de estado
        logByStatus(response, url);

        return response;
        
      } catch (error) {
        if (attempt === maxRetries) {
          // √öltimo intento fallido
          if (error.name === 'AbortError') {
            console.log(`[API] Timeout (${timeoutMs}ms): ${url}`);
            const timeoutError = new Error(`Timeout despu√©s de ${timeoutMs}ms`);
            timeoutError.name = 'TimeoutError';
            throw timeoutError;
          } else {
            console.log(`[API] Error final de conexi√≥n: ${url}`, error.message);
            throw error;
          }
        } else {
          // Reintento
          console.log(`[API] Error en intento ${attempt + 1}, reintentando: ${url}`, error.message);
          await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1))); // Backoff exponencial
        }
      }
    }
  };

  // Funci√≥n para verificar si la sesi√≥n est√° activa
  const verificarSesion = async () => {
    try {
      const response = await authFetch('/api/sesion/check');
      return response.ok;
    } catch (error) {
      console.log('[SESI√ìN] Error verificando sesi√≥n:', error.message);
      return false;
    }
  };

  // (Bloque de protecci√≥n de visibilidad eliminado seg√∫n nueva especificaci√≥n)

  // Programa seleccionado
  const btnCardio = document.getElementById('btn-programa-cardio');
  const btnEcicep = document.getElementById('btn-programa-ecicep');
  function setPrograma(p){
    window.programaSeleccionado = p; 
    btnCardio.classList.toggle('btn-verde', p==='CARDIO');
    btnEcicep.classList.toggle('btn-verde', p==='ECICEP');
    btnCardio.classList.toggle('btn-outlined', p!=='CARDIO');
    btnEcicep.classList.toggle('btn-outlined', p!=='ECICEP');
    console.log('[PROGRAMA]', p);
    document.dispatchEvent(new CustomEvent('programa:cambio',{detail:{programa:p}}));
    // Si volvemos a ECICEP y existe hook de rec√°lculo din√°mico, ejecutarlo
    if(p==='ECICEP' && typeof window.__recalcularRiesgoECICEP==='function'){
      try { window.__recalcularRiesgoECICEP(); } catch(e){ console.warn('Recalc riesgo ECICEP fallo', e); }
    }
  }
  btnCardio.addEventListener('click', ()=> setPrograma('CARDIO'));
  btnEcicep.addEventListener('click', ()=> setPrograma('ECICEP'));
  setPrograma('ECICEP');

  // C√°lculo de edad
  const fecha = document.getElementById('fecha_nacimiento');
  const edad = document.getElementById('edad');
  function calcEdad(){
    if(!fecha.value){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    const fn = new Date(fecha.value);
    if(isNaN(fn.getTime())){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    const hoy = new Date();
    let e = hoy.getFullYear()-fn.getFullYear();
    const mDiff = hoy.getMonth()-fn.getMonth();
    if (mDiff<0 || (mDiff===0 && hoy.getDate()<fn.getDate())) e--;
    if (e<0 || e>120){ edad.value=''; mostrarOcultarAdultoMayor(''); return; }
    edad.value = e;
    
    // Actualizar visibilidad de pesta√±a Adulto Mayor
    if (typeof mostrarOcultarAdultoMayor === 'function') {
      mostrarOcultarAdultoMayor(e);
    }
  }
  fecha.addEventListener('change', calcEdad);
  fecha.addEventListener('input', calcEdad);

  // RUN auto focus
  const run = document.getElementById('run');
  if(run){ run.focus(); }

  // Reset limpia edad
  document.getElementById('btn-reset').addEventListener('click',()=>{ setTimeout(()=>{ edad.value=''; },0); });

  // Tabs
  const tabs = document.querySelectorAll('.t-tab');
  const panels = document.querySelectorAll('[data-panel]');
  function activarTab(k){
    tabs.forEach(b=>{
      if(b.dataset.tab===k){
        b.classList.add('active');
      } else {
        b.classList.remove('active');
      }
    });
    panels.forEach(p=>{ p.hidden = p.getAttribute('data-panel')!==k; });
    localStorage.setItem('tarjeton.tab', k);
    
    // Cargar historial espec√≠fico del tab si hay usuario activo
    const runField = document.getElementById('run');
    if (runField && runField.value.trim()) {
      if (k === 'adulto_mayor') {
        cargarHistorialAdultoMayor(runField.value.trim());
        // Obtener datos del usuario para filtrar por g√©nero y edad para screening
        const sexoSpan = document.querySelector('[data-f="sexo"]');
        const edadSpan = document.querySelector('[data-f="edad"]');
        const sexo = sexoSpan ? sexoSpan.textContent.trim() : '';
        const edad = edadSpan ? parseInt(edadSpan.textContent.trim()) : 0;
        cargarDatosScreeningAM(runField.value.trim(), sexo, edad);
      } else if (k === 'funcionalidad') {
        cargarHistorialAdultoMayor(runField.value.trim());
        cargarHistorialActividadFisica(runField.value.trim());
        cargarHistorialMasAma(runField.value.trim());
      }
    }
  }
  tabs.forEach(b=> b.addEventListener('click', ()=> activarTab(b.dataset.tab)));
  activarTab(localStorage.getItem('tarjeton.tab')||'control');

  // (cargarDatos eliminado: ahora toda la carga se centraliza en buscarRun/recargaTodo)

  // ===== Helpers para poblar =====
  function byIdPoblar(id) { return document.getElementById(id); }
  function ensure(v) { return (v ?? '‚Äî'); }
  function setText(el, v) { if (el) el.textContent = v; }

  /**
   * Asigna value si el valor es distinto de undefined/null/''
   * y emite el mismo log "Asignado <id>: <val>" que el c√≥digo original.
   * Mantiene el orden de logs/efectos al ser llamado en la misma secuencia.
   */
  function setValueIfPresent(id, value) {
    const el = byIdPoblar(id);
    if (el && value !== undefined && value !== null && value !== '') {
      el.value = value;
      console.log(`Asignado ${id}: ${value}`);
    }
  }

  function clasificarPatologia(nombreRaw, cie10Raw) {
    const nombre = (nombreRaw || '').toLowerCase();
    const codigo = (cie10Raw || '').toUpperCase();

    // HTA: por nombre, por I10‚ÄìI13.*, o exactamente I23.2
    if (/hipertens/i.test(nombre) || /^(I10|I11|I12|I13)(\.|$)/i.test(codigo) || /^I23\.2$/i.test(codigo)) {
      return 'pat-hta';
    }
    // Dislipidemia: por nombre o E78.*
    if (/dislipid/i.test(nombre) || /^E78(\.|$)/i.test(codigo)) {
      return 'pat-dislip';
    }
    // Diabetes: por nombre o E10‚ÄìE14.*
    if (/diab/i.test(nombre) || /^E1[0-4](\.|$)/i.test(codigo)) {
      return 'pat-diabetes';
    }
    return '';
  }

  function renderPatologias(ul, pats) {
    if (!ul) return;
    ul.innerHTML = '';
    if (!Array.isArray(pats) || pats.length === 0) {
      ul.innerHTML = '<li style="opacity:.6;">Sin datos</li>';
      return;
    }
    pats.forEach(p => {
      const li = document.createElement('li');
      const codigo = (p.cie10 || '').toUpperCase();
      const nombre = (p.nombre || '');
      li.className = clasificarPatologia(nombre, codigo);
      li.textContent = (codigo ? (codigo + ' - ') : '') + nombre;
      ul.appendChild(li);
    });
  }

  function autocompletarIdentificacion(u, selSector) {
    const formTar = byIdPoblar('form-tarjeton');
    if (!(formTar && u && u.run)) return;

    console.log('Autocompletando formulario con usuario:', u);

    // Mantener exactamente el mismo orden de asignaciones y logs
    setValueIfPresent('run', u.run);
    setValueIfPresent('nombre', u.nombre_completo || u.nombre);
    setValueIfPresent('fecha_nacimiento', u.fecha_nacimiento);
    setValueIfPresent('sexo', u.sexo);
    if (selSector && u.sector_id) selSector.value = u.sector_id; // no log aqu√≠ en el original
    setValueIfPresent('telefono', u.telefono);
    setValueIfPresent('direccion', u.direccion);

    // Resetear flag como en el original
    window._identEditadoManualmente = false;
  }

  // ===== MISMA FIRMA P√öBLICA =====
  function poblar(data) {
    console.log('üîß [DEBUG-POBLAR] *** FUNCION POBLAR EJECUTADA ***', data);
    const u = (data && data.usuario) || {};

    // Mostrar resumen y ocultar badge nuevo si existe usuario
    const cardResumenAuto = byIdPoblar('card-resumen');
    if (cardResumenAuto) { cardResumenAuto.style.display = 'flex'; }
    if (u && u.run) {
      const badgeNuevo = byIdPoblar('badge-nuevo-usuario');
      if (badgeNuevo) badgeNuevo.style.display = 'none';
    }

    // Mapa de campos para [data-f]
    const fechaNacFormateada = u.fecha_nacimiento ? new Date(u.fecha_nacimiento).toLocaleDateString('es-CL') : '‚Äî';
    console.log('üîß [DEBUG-POBLAR] Fecha nacimiento original:', u.fecha_nacimiento);
    console.log('üîß [DEBUG-POBLAR] Fecha formateada:', fechaNacFormateada);
    console.log('üîß [DEBUG-POBLAR] Edad del data:', data?.edad);
    
    const map = {
      run: ensure(u.run),
      nombre_completo: ensure(u.nombre_completo || u.nombre),
      fecha_nacimiento: fechaNacFormateada,
      edad: ensure(data?.edad),
      sexo: ensure(u.sexo),
      sector_nombre: ensure(u.sector_nombre),
      categoria_nombre: ensure(u.categoria_nombre || u.categoria_ecicep_effectiva),
      telefono: ensure(u.telefono)
    };

    // Volcar [data-f] manteniendo el mismo comportamiento
    console.log('üîß [DEBUG-POBLAR] Elementos data-f encontrados:', document.querySelectorAll('[data-f]').length);
    document.querySelectorAll('[data-f]').forEach(sp => {
      const valor = map[sp.dataset.f] ?? '‚Äî';
      console.log('üîß [DEBUG-POBLAR] Asignando', sp.dataset.f, '=', valor);
      setText(sp, valor);
    });

    // Badge riesgo/categor√≠a (misma posici√≥n en el flujo)
    try {
      if (window.actualizarBadgeRiesgo && typeof window.actualizarBadgeRiesgo === 'function') {
        window.actualizarBadgeRiesgo(map.categoria_nombre);
      }
    } catch(e) {
      console.warn('actualizarBadgeRiesgo no disponible:', e.message);
    }

    // Patolog√≠as
    renderPatologias(byIdPoblar('lista-patologias'), data?.patologias_resumen || []);

    // Acuerdo reciente
    const ac = byIdPoblar('acuerdo-reciente');
    if (ac) {
      if (data?.acuerdo_reciente) {
        const ar = data.acuerdo_reciente;
        ac.textContent = `${ar.fecha_creacion || ''}: ${ar.acuerdos || ''} (${ar.cumplimiento || ''})`;
      } else {
        ac.textContent = '‚Äî';
      }
    }

    // Set select de sector y categor√≠a input (antes del autocompletado, como en el original)
    const selSector = byIdPoblar('sector_id');
    if (selSector && u.sector_id) {
      selSector.value = u.sector_id;
    }
    const cat = byIdPoblar('categoria');
    if (cat) { cat.value = map.categoria_nombre; }

    // Autocompletar identificaci√≥n (manteniendo logs y orden)
    autocompletarIdentificacion(u, selSector);
    
    // Mostrar/ocultar pesta√±a Adulto Mayor basada en la edad
    mostrarOcultarAdultoMayor(data?.edad);
    
    // Mostrar/ocultar pesta√±a Evaluaci√≥n Diabetes basada en patolog√≠as
    mostrarOcultarDiabetes(data?.patologias_resumen);
    
    console.log('üîß [DEBUG-POBLAR] *** POBLAR COMPLETADO ***');
    
    // Verificaci√≥n adicional para pesta√±as condicionales despu√©s de un breve delay
    setTimeout(() => {
      console.log('üîß [DEBUG] Verificaci√≥n post-poblar de pesta√±as condicionales');
      mostrarOcultarAdultoMayor(data?.edad);
      mostrarOcultarDiabetes(data?.patologias_resumen);
    }, 100);
  }

  // Funci√≥n para mostrar/ocultar pesta√±a Adulto Mayor basada en la edad
  function mostrarOcultarAdultoMayor(edad) {
    console.log('üîß [DEBUG] Verificando edad para Adulto Mayor:', edad, typeof edad);
    
    // Buscar la pesta√±a de "Adulto Mayor" (funcionalidad)
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    const panelAdultoMayor = document.querySelector('[data-panel="funcionalidad"]');
    
    if (tabAdultoMayor) {
      const edadNumerica = parseInt(edad);
      console.log('üîß [DEBUG] Edad num√©rica calculada:', edadNumerica, 'Es v√°lida:', !isNaN(edadNumerica));
      
      if (!isNaN(edadNumerica) && edadNumerica >= 65) {
        // Mostrar pesta√±a para usuarios de 65 a√±os o m√°s
        tabAdultoMayor.style.display = 'block';
        console.log('üîß [DEBUG] ‚úÖ Mostrando pesta√±a Adulto Mayor para edad:', edadNumerica);
      } else {
        // Ocultar pesta√±a para usuarios menores de 65 a√±os o edad inv√°lida
        tabAdultoMayor.style.display = 'none';
        console.log('üîß [DEBUG] ‚ùå Ocultando pesta√±a Adulto Mayor para edad:', edadNumerica);
        
        // Si la pesta√±a activa es "funcionalidad", cambiar a "control"
        if (tabAdultoMayor.classList.contains('active') || tabAdultoMayor.classList.contains('t-tab-active')) {
          const tabControl = document.querySelector('[data-tab="control"]');
          if (tabControl) {
            tabControl.click();
            console.log('üîß [DEBUG] Cambiando a pesta√±a Control porque Adulto Mayor estaba activa');
          }
        }
      }
      
      // Verificaci√≥n adicional despu√©s del cambio
      const displayFinal = getComputedStyle(tabAdultoMayor).display;
      console.log('üîß [DEBUG] Display final de pesta√±a Adulto Mayor:', displayFinal);
    } else {
      console.warn('üîß [DEBUG] ‚ö†Ô∏è No se encontr√≥ la pesta√±a Adulto Mayor');
    }
  }

  // Funci√≥n para mostrar/ocultar pesta√±a Evaluaci√≥n Diabetes basada en si tiene diabetes + ERC
  function mostrarOcultarDiabetes(patologias_resumen) {
    console.log('üîß [DEBUG] Verificando patolog√≠as para Evaluaci√≥n Diabetes (requiere diabetes + ERC):', patologias_resumen);
    
    // Buscar la pesta√±a de "Evaluaci√≥n Diabetes"
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    const panelDiabetes = document.querySelector('[data-panel="diabetes"]');
    
    if (tabDiabetes) {
      let tieneDiabetes = false;
      let tieneERC = false;
      
      // Verificar si tiene diabetes Y ERC en las patolog√≠as
      if (patologias_resumen && Array.isArray(patologias_resumen)) {
        // Verificar diabetes
        tieneDiabetes = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          // Buscar t√©rminos relacionados con diabetes
          return nombre.includes('diabetes') || cie10.includes('e10') || cie10.includes('e11') || 
                 cie10.includes('e12') || cie10.includes('e13') || cie10.includes('e14');
        });
        
        // Verificar enfermedad renal cr√≥nica (ERC)
        tieneERC = patologias_resumen.some(patologia => {
          const nombre = patologia.nombre ? patologia.nombre.toLowerCase() : '';
          const cie10 = patologia.cie10 ? patologia.cie10.toLowerCase() : '';
          // Buscar t√©rminos relacionados con ERC
          return nombre.includes('renal cronica') || nombre.includes('renal cr√≥nica') || 
                 nombre.includes('erc') || nombre.includes('insuficiencia renal') ||
                 nombre.includes('nefropat√≠a') || nombre.includes('nefropatia') ||
                 // C√≥digos CIE10 para ERC (N18 - Enfermedad renal cr√≥nica)
                 cie10.includes('n18') || cie10.includes('n180') || cie10.includes('n181') ||
                 cie10.includes('n182') || cie10.includes('n183') || cie10.includes('n184') ||
                 cie10.includes('n185') || cie10.includes('n186') || cie10.includes('n189');
        });
      }
      
      console.log('üîß [DEBUG] Diabetes:', tieneDiabetes, '- ERC:', tieneERC);
      
      if (tieneDiabetes && tieneERC) {
        // Mostrar pesta√±a para usuarios con diabetes Y ERC
        tabDiabetes.style.display = 'block';
        console.log('üîß [DEBUG] Mostrando pesta√±a Evaluaci√≥n Diabetes - usuario tiene diabetes + ERC');
      } else {
        // Ocultar pesta√±a para usuarios sin diabetes o sin ERC
        tabDiabetes.style.display = 'none';
        const razon = !tieneDiabetes ? 'sin diabetes' : 'sin ERC';
        console.log(`üîß [DEBUG] Ocultando pesta√±a Evaluaci√≥n Diabetes - usuario ${razon}`);
        
        // Si la pesta√±a activa es "diabetes", cambiar a "control"
        if (tabDiabetes.classList.contains('active') || tabDiabetes.classList.contains('t-tab-active')) {
          const tabControl = document.querySelector('[data-tab="control"]');
          if (tabControl) {
            tabControl.click();
            console.log('üîß [DEBUG] Cambiando a pesta√±a Control porque Evaluaci√≥n Diabetes estaba activa');
          }
        }
      }
    } else {
      console.warn('üîß [DEBUG] No se encontr√≥ la pesta√±a Evaluaci√≥n Diabetes');
    }
  }

  // Funci√≥n de diagn√≥stico simple
  window.testSimple = function() {
    console.log('üîß [TEST-SIMPLE] Funci√≥n test disponible');
  };
  
  // Funci√≥n de test para verificar detecci√≥n de diabetes + ERC
  window.testDiabetesERC = function() {
    console.log('üîß [TEST-DIABETES-ERC] Probando detecci√≥n...');
    
    // Caso 1: Solo diabetes
    const soloD = [{nombre: 'Diabetes mellitus tipo 2', cie10: 'E11'}];
    console.log('Test 1 - Solo diabetes:', soloD);
    mostrarOcultarDiabetes(soloD);
    
    // Caso 2: Solo ERC  
    const soloE = [{nombre: 'Enfermedad renal cr√≥nica', cie10: 'N18.6'}];
    console.log('Test 2 - Solo ERC:', soloE);
    mostrarOcultarDiabetes(soloE);
    
    // Caso 3: Diabetes + ERC (deber√≠a mostrar)
    const ambas = [
      {nombre: 'Diabetes mellitus tipo 2', cie10: 'E11'},
      {nombre: 'Enfermedad renal cr√≥nica', cie10: 'N18.6'}
    ];
    console.log('Test 3 - Diabetes + ERC:', ambas);
    mostrarOcultarDiabetes(ambas);
  };
  
  // Funci√≥n de diagn√≥stico para pesta√±as
  window.diagnosticarPestanas = function() {
    console.log('üîß [DIAGNOSTICO] Verificando estado de pesta√±as...');
    
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    const edadSpan = document.querySelector('[data-f="edad"]');
    
    console.log('Pesta√±a Adulto Mayor encontrada:', !!tabAdultoMayor);
    console.log('Pesta√±a Diabetes encontrada:', !!tabDiabetes);
    
    if (tabAdultoMayor) {
      console.log('Adulto Mayor display:', getComputedStyle(tabAdultoMayor).display);
      console.log('Adulto Mayor style.display:', tabAdultoMayor.style.display);
    }
    
    if (tabDiabetes) {
      console.log('Diabetes display:', getComputedStyle(tabDiabetes).display);
      console.log('Diabetes style.display:', tabDiabetes.style.display);
    }
    
    if (edadSpan) {
      const edad = edadSpan.textContent.trim();
      console.log('Edad actual del usuario:', edad);
      
      // Forzar verificaci√≥n de edad
      console.log('Ejecutando mostrarOcultarAdultoMayor con edad:', edad);
      mostrarOcultarAdultoMayor(edad);
    } else {
      console.log('No se encontr√≥ span de edad');
    }
  };
    return 'OK';
  };

  // Funci√≥n de test de poblar con manejo de errores
  window.testPoblar = function() {
    console.log('üîß [TEST] Iniciando test de poblar...');
    try {
      const testData = {
        usuario: {
          run: "10.000.141-1",
          nombre: "Patricio Pino Reyes", 
          fecha_nacimiento: "Thu, 12 Mar 1964 00:00:00 GMT",
          sexo: "masculino",
          sector_nombre: "VERDE"
        },
        edad: 61
      };
      console.log('üîß [TEST] Datos de prueba creados:', testData);
      
      if (typeof poblar === 'function') {
        console.log('üîß [TEST] Funci√≥n poblar encontrada, ejecutando...');
        poblar(testData);
        console.log('üîß [TEST] Funci√≥n poblar ejecutada');
      } else {
        console.error('üîß [TEST] ERROR: funci√≥n poblar no encontrada');
      }
    } catch(error) {
      console.error('üîß [TEST] ERROR en testPoblar:', error);
    }
    console.log('üîß [TEST] Test completado');
    return 'Test ejecutado';
  };

  // Test de fecha espec√≠fico
  window.testFecha = function() {
    console.log('üîß [TEST-FECHA] Probando formateo de fecha...');
    const fecha = 'Thu, 12 Mar 1964 00:00:00 GMT';
    console.log('üîß [TEST-FECHA] Fecha original:', fecha);
    const fechaFormateada = new Date(fecha).toLocaleDateString('es-CL');
    console.log('üîß [TEST-FECHA] Fecha formateada:', fechaFormateada);
    return fechaFormateada;
  };
  // Fuerza estado inicial: s√≥lo toolbar visible
  (function hardStart(){
    const ident = document.getElementById('identificacion-section');
    const cardResumen = document.getElementById('card-resumen');
    if (ident) ident.style.display='none';
    if (cardResumen) cardResumen.style.display='none';
    
    // Asegurar que la pesta√±a Adulto Mayor est√© oculta inicialmente
    const tabAdultoMayor = document.querySelector('[data-tab="funcionalidad"]');
    if (tabAdultoMayor) {
      tabAdultoMayor.style.display = 'none';
      console.log('üîß [INIT] Pesta√±a Adulto Mayor oculta al iniciar');
    }
    
    // Asegurar que la pesta√±a Evaluaci√≥n Diabetes est√© oculta inicialmente
    const tabDiabetes = document.querySelector('[data-tab="diabetes"]');
    if (tabDiabetes) {
      tabDiabetes.style.display = 'none';
      console.log('üîß [INIT] Pesta√±a Evaluaci√≥n Diabetes oculta al iniciar (requiere diabetes + ERC)');
    }
    
    // Verificaci√≥n peri√≥dica de pesta√±as para casos donde se cargan datos despu√©s
    setTimeout(() => {
      console.log('üîß [INIT] Verificaci√≥n de pesta√±as condicionales despu√©s de inicializaci√≥n');
      
      // Verificar si hay edad cargada
      const edadSpan = document.querySelector('[data-f="edad"]');
      if (edadSpan && edadSpan.textContent.trim()) {
        const edad = edadSpan.textContent.trim();
        console.log('üîß [INIT] Edad encontrada en DOM:', edad);
        mostrarOcultarAdultoMayor(edad);
      }
      
      // Verificar pesta√±as y forzar estado correcto
      const tabAM = document.querySelector('[data-tab="funcionalidad"]');
      const tabD = document.querySelector('[data-tab="diabetes"]');
      
      if (tabAM && !tabAM.style.display) {
        console.log('üîß [INIT] Forzando ocultamiento de pesta√±a Adulto Mayor sin display definido');
        tabAM.style.display = 'none';
      }
      
      if (tabD && !tabD.style.display) {
        console.log('üîß [INIT] Forzando ocultamiento de pesta√±a Diabetes sin display definido');
        tabD.style.display = 'none';
      }
    }, 500);
  })();

  // --- NUEVO FLUJO BUSCAR RUN ---
  (function(){
    const ident = document.getElementById('identificacion-section');
    const formTarjeton = document.getElementById('form-tarjeton');
    const cardResumen = document.getElementById('card-resumen');
    const layoutGrid = document.getElementById('layout-tarjeton-grid');
    const runSearch = document.getElementById('run-search');
    const btnBuscar = document.getElementById('btn-buscar-run');
    const helpSearch = document.getElementById('run-search-help');
    const runForm = document.getElementById('run');
    const btnEditarIdent = document.getElementById('btn-editar-ident');
    window._identEditadoManualmente = false;

    // Funcionalidad de colapso removida - resumen siempre visible

    // Marcar edici√≥n manual en cualquier cambio de inputs clave
    ['run','nombre','fecha_nacimiento','sexo','telefono','direccion','sector_id'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){ el.addEventListener('input', ()=>{ window._identEditadoManualmente = true; }); }
    });

    if(btnEditarIdent){
      btnEditarIdent.addEventListener('click', ()=>{
        if(cardResumen) cardResumen.style.display='none';
        if(ident) ident.style.display='block';
        layoutGrid?.classList.add('no-resumen');
        layoutGrid?.classList.remove('solo-resumen');
        // No reseteamos banderas aqu√≠: se asume usuario quiere preservar cambios
      });
    }

    function mostrarIdentificacionNuevo(runPrefill){
      if (runPrefill && runForm){ runForm.value = runPrefill; }
      if (cardResumen) cardResumen.style.display = 'none';
      if (ident) ident.style.display = 'block';
      layoutGrid?.classList.add('no-resumen');
      const badgeNuevo = document.getElementById('badge-nuevo-usuario');
      if(badgeNuevo) badgeNuevo.style.display='inline-block';
    }
    // Resumen siempre visible: se eliminan mostrarResumen/ocultarTodoMenosToolbar.

    function normalizarRun(v){ return (v||'').toString().replace(/[.\-]/g,'').toUpperCase(); }
    function validarRunCl(v){
      const s = normalizarRun(v);
      if (s.length < 2) return false;
      const cuerpo = s.slice(0,-1); const dv = s.slice(-1);
      if(!/^\d+$/.test(cuerpo)) return false;
      let suma=0, mul=2;
      for(let i=cuerpo.length-1;i>=0;i--){
        suma += parseInt(cuerpo[i],10)*mul;
        mul = (mul===7)?2:(mul+1);
      }
      const res = 11 - (suma % 11);
      const dvCalc = res===11? '0' : (res===10? 'K' : String(res));
      return dvCalc === dv;
    }

    // ==== Helpers de UI/valores (sin efectos secundarios extra√±os) ====
    function trimRun() {
      const vSearch = (runSearch?.value || '').trim();
      if (vSearch) return vSearch;
      const runField = document.getElementById('run');
      return (runField?.value || '').trim();
    }

    function isOkData(resp, data) {
      return resp.ok && data && data.ok && (data.usuario || data.patologias_resumen || data.edad !== undefined);
    }

    function marcarValidez(ok){
      runSearch.classList.toggle('is-invalid', !ok);
      runSearch.classList.toggle('is-valid', !!ok);
      helpSearch.style.display = ok ? 'none' : 'block';
    }

    // Listener mejorado con autocompletado
    runSearch?.addEventListener('input', ()=>{
      const ok = validarRunCl(runSearch.value);
      marcarValidez(ok);
      
      // Sincronizar con campo RUN del formulario
      if (runForm && runSearch.value) {
        runForm.value = runSearch.value;
      }
    });

    // Sincronizaci√≥n bidireccional: si se escribe en el formulario, actualizar b√∫squeda
    runForm?.addEventListener('input', ()=>{
      if (runSearch && runForm.value) {
        runSearch.value = runForm.value;
        const ok = validarRunCl(runForm.value);
        marcarValidez(ok);
      }
    });

    async function buscarRun(){
      console.log('üîç [BUSCAR_RUN] =============================================');
      console.log('üîç [BUSCAR_RUN] Funci√≥n buscarRun() ejecutada');
      console.log('üîç [BUSCAR_RUN] Timestamp:', new Date().toISOString());
      
      try {
        console.log('üîç [BUSCAR_RUN] Paso 1: Obteniendo RUN con trimRun()...');
        const val = trimRun();
        console.log('üîç [BUSCAR_RUN] RUN obtenido:', `"${val}"`);
        
        if (!val) {
          console.error('‚ùå [BUSCAR_RUN] Campo RUN est√° vac√≠o');
          alert('Por favor, ingrese un RUN para buscar');
          const runInput = document.getElementById('run-search');
          if (runInput) runInput.focus();
          return;
        }

        console.log('üîç [BUSCAR_RUN] Paso 2: Validando RUN...');
        console.log('üîç [BUSCAR_RUN] Funci√≥n validarRunCl disponible:', typeof validarRunCl);
        const esValido = validarRunCl(val);
        console.log('üîç [BUSCAR_RUN] RUN v√°lido:', esValido);
        
        if(!esValido){
          marcarValidez(false);
          console.error('‚ùå [BUSCAR_RUN] RUN inv√°lido, deteniendo');
          alert('RUN inv√°lido. Formato esperado: 12.345.678-9');
          return;
        }
        
        console.log('üîç [BUSCAR_RUN] Paso 3: Marcando como v√°lido...');
        marcarValidez(true);

      // === Helpers para b√∫squeda ===
      const createLoadingManager = () => {
        const btnLbl = btnBuscar.querySelector('.lbl');
        const spinWrap = btnBuscar.querySelector('.spinner');
        
        return (on) => {
          if(on){
            btnBuscar.disabled = true;
            btnLbl.style.opacity = '0';
            spinWrap.style.display = 'flex';
          } else {
            btnBuscar.disabled = false;
            btnLbl.style.opacity = '1';
            spinWrap.style.display = 'none';
          }
        };
      };

      // === Helpers puros para buscarRun ===
      const parseJsonOrText = async (r) => {
        try{
          const data = await r.json();
          console.log('üîç [DEBUG] Respuesta JSON parseada:', data);
          return data;
        } catch(jsonError){
          console.error('üîç [DEBUG] Error parseando JSON:', jsonError);
          const textResponse = await r.text();
          console.log('üîç [DEBUG] Respuesta como texto:', textResponse);
          return { ok: false, error: 'JSON_PARSE_ERROR' };
        }
      };

      const aplicarUIUsuarioExistente = async (val, data) => {
        console.log('Aplicando UI para usuario existente:', data?.usuario?.nombre);
        if (typeof poblar === 'function') poblar(data);

        // Ocultar identificaci√≥n si estaba abierta
        if (ident) ident.style.display = 'none';

        // Asegurar resumen visible + ajustar layout
        if (cardResumen){
          cardResumen.style.display = 'flex';
          cardResumen.classList.remove('expandido');
        }
        layoutGrid?.classList.remove('no-resumen');
        layoutGrid?.classList.add('solo-resumen');

        // Acceso seguro evitando TDZ (ReferenceError) si recargaTodo a√∫n no est√° inicializada
        try {
          if (window.recargaTodo instanceof Function) {
            await window.recargaTodo(val);
          }
        } catch(_tdzErr) {
          console.warn('[RUN] recargaTodo no disponible todav√≠a, se omiti√≥ la recarga inicial');
        }
        

      };

      const flujoUsuarioNoExistente = (val) => {
        // Crear di√°logo de confirmaci√≥n mejorado
        const dialogHTML = `
          <div id="confirm-nuevo-usuario" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
          ">
            <div style="
              background: white;
              border-radius: 12px;
              padding: 24px;
              box-shadow: 0 20px 60px rgba(0,0,0,0.3);
              max-width: 400px;
              width: 90%;
              text-align: center;
            ">
              <div style="
                width: 60px;
                height: 60px;
                background: linear-gradient(135deg, #f59e0b, #d97706);
                border-radius: 50%;
                margin: 0 auto 16px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
              ">‚ö†Ô∏è</div>
              
              <h3 style="margin: 0 0 12px; color: #1f2937;">Usuario No Encontrado</h3>
              
              <p style="margin: 0 0 20px; color: #6b7280; line-height: 1.5;">
                El RUN <strong>${val}</strong> es v√°lido pero no existe en el sistema.
                <br><br>
                ¬øDeseas ingresar un nuevo usuario?
              </p>
              
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="btn-confirm-si" style="
                  background: #059669;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#047857'" onmouseout="this.style.background='#059669'">
                  ‚úÖ S√≠, Ingresar Usuario
                </button>
                
                <button id="btn-confirmar-no" style="
                  background: #6b7280;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 6px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.2s;
                " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                  ‚ùå No, Cancelar
                </button>
              </div>
            </div>
          </div>
        `;
        
        // Agregar animaci√≥n CSS si no existe
        if (!document.getElementById('confirm-dialog-styles')) {
          const style = document.createElement('style');
          style.id = 'confirm-dialog-styles';
          style.textContent = `
            @keyframes fadeIn {
              from { opacity: 0; transform: scale(0.9); }
              to { opacity: 1; transform: scale(1); }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.insertAdjacentHTML('beforeend', dialogHTML);
        
        const dialog = document.getElementById('confirm-nuevo-usuario');
        const btnSi = document.getElementById('btn-confirm-si');
        const btnNo = document.getElementById('btn-confirmar-no');
        
        btnSi.addEventListener('click', () => {
          dialog.remove();
          mostrarIdentificacionNuevo(val);
          const badgeNuevo = document.getElementById('badge-nuevo-usuario');
          if(badgeNuevo) badgeNuevo.style.display='inline-block';
          window._identEditadoManualmente = false;
          
          // Mostrar mensaje de ayuda para patolog√≠as
          setTimeout(() => {
            const estadoPats = document.getElementById('estado-patologias');
            if (estadoPats) {
              estadoPats.textContent = 'üí° Tip: Busca y selecciona patolog√≠as para el nuevo usuario';
              estadoPats.style.color = '#059669';
            }
          }, 500);
        });
        
        btnNo.addEventListener('click', () => {
          dialog.remove();
          if (ident) ident.style.display = 'none';
          if (cardResumen) cardResumen.style.display = 'none';
        });
        
        // Cerrar con Escape
        document.addEventListener('keydown', function handleEscape(e) {
          if (e.key === 'Escape') {
            dialog.remove();
            document.removeEventListener('keydown', handleEscape);
          }
        });
      };

      console.log('üîç [BUSCAR_RUN] Paso 4: Configurando loading manager...');
      const setLoading = createLoadingManager();
      console.log('üîç [BUSCAR_RUN] Loading manager creado:', typeof setLoading);
      
      console.log('üîç [BUSCAR_RUN] Paso 5: Activando loading...');
      setLoading(true);

      const url = `/api/tarjeton/${encodeURIComponent(val)}`;
      console.log('üîç [BUSCAR_RUN] Paso 6: URL generada para API:', url);
      console.log('üîç [BUSCAR_RUN] RUN codificado:', encodeURIComponent(val));
      
      console.log('üîç [BUSCAR_RUN] Paso 7: Iniciando petici√≥n HTTP con authFetch...');
      console.log('üîç [BUSCAR_RUN] Funci√≥n authFetch disponible:', typeof authFetch);

      try{
        const r = await authFetch(url);
        console.log('üîç [DEBUG] Response status:', r.status, r.ok);

        // Manejo espec√≠fico de errores HTTP
        if (r.status === 404) {
          console.log('üîç [DEBUG] Usuario no encontrado (404)');
          flujoUsuarioNoExistente(val);
          setLoading(false);
          return;
        }
        
        if (r.status === 429) {
          console.warn('üîç [DEBUG] L√≠mite de solicitudes excedido (429)');
          alert('‚ö†Ô∏è Demasiadas solicitudes. Espere un momento e intente nuevamente.');
          setLoading(false);
          return;
        }
        
        if (r.status >= 500) {
          console.error('üîç [DEBUG] Error del servidor:', r.status);
          alert('‚ùå Error del servidor. El sistema puede estar experimentando problemas.\n\nInt√©ntelo nuevamente en unos momentos.');
          setLoading(false);
          return;
        }

        const data = await parseJsonOrText(r);

        if (isOkData(r, data)){
          await aplicarUIUsuarioExistente(val, data);
          setLoading(false);
          return;
        }
        
        // Si llegamos aqu√≠, no hay datos v√°lidos pero tampoco error HTTP
        console.log('üîç [DEBUG] Sin datos v√°lidos, tratando como usuario no existente');
        flujoUsuarioNoExistente(val);
        
      } catch(e){
        console.error('‚ùå [BUSCAR_RUN] Error cr√≠tico capturado en buscarRun()');
        console.error('‚ùå [BUSCAR_RUN] Error completo:', e);
        console.error('‚ùå [BUSCAR_RUN] Tipo de error:', e.name);
        console.error('‚ùå [BUSCAR_RUN] Mensaje:', e.message);
        console.error('‚ùå [BUSCAR_RUN] Stack trace:', e.stack);
        
        // Manejo m√°s espec√≠fico de errores de red
        if (e.name === 'TypeError' && e.message.includes('fetch')) {
          console.error('‚ùå [BUSCAR_RUN] Error de red/fetch detectado');
          alert('‚ùå Error de conexi√≥n. Verifique su conexi√≥n a internet e intente nuevamente.');
        } else if (e.message.includes('JSON')) {
          console.error('‚ùå [BUSCAR_RUN] Error de parsing JSON detectado');
          alert('‚ö†Ô∏è Error procesando respuesta del servidor. El formato de datos no es v√°lido.');
        } else {
          console.error('‚ùå [BUSCAR_RUN] Error gen√©rico/desconocido');
          alert('‚ùå Error inesperado consultando el RUN.\n\nDetalles: ' + e.message + '\n\nInt√©ntelo nuevamente.');
        }
      } finally {
        console.log('üîç [BUSCAR_RUN] Finally block ejecutado');
        setLoading(false);
        console.log('üîç [BUSCAR_RUN] =============================================');
      }
    } catch (outerError) {
      console.error('‚ùå [BUSCAR_RUN] Error en el try/catch principal:', outerError);
      console.error('‚ùå [BUSCAR_RUN] Stack trace outer:', outerError.stack);
      alert('Error cr√≠tico en la funci√≥n de b√∫squeda: ' + outerError.message);
    }
    }

    // === Configuraci√≥n de event listeners ===
    const setupBuscarEventListeners = () => {
      // Debug: verificar que los elementos existen
      console.log('btnBuscar encontrado:', !!btnBuscar);
      console.log('runSearch encontrado:', !!runSearch);
      
      btnBuscar?.addEventListener('click', function() {
        console.log('üîç [DEBUG] Click en bot√≥n buscar detectado');
        buscarRun();
      });
      
      runSearch?.addEventListener('keydown', e=>{ 
        if(e.key==='Enter'){ 
          e.preventDefault(); 
          buscarRun(); 
        }
      });
      
      // Debug adicional: verificar si el evento se registr√≥
      if (btnBuscar) {
        console.log('Event listener agregado al bot√≥n de b√∫squeda');
      } else {
        console.error('No se encontr√≥ el bot√≥n btn-buscar-run');
      }

      // Listener Enter directo sobre el campo principal #run
      if (runForm){
        runForm.addEventListener('keydown', (e)=>{
          if(e.key==='Enter'){
            e.preventDefault();
            // Sincronizar visualmente ambos campos antes de buscar
            if(runSearch && runForm.value.trim()){
              runSearch.value = runForm.value.trim();
            }
            buscarRun();
          }
        });
      }

      // Blur listener para runForm con b√∫squeda autom√°tica mejorada
      if (runForm){
        runForm.addEventListener('blur', ()=>{
          const v = runForm.value.trim();
          if(!v) return; 
          runSearch.value = v; 
          
          // Buscar autom√°ticamente si el RUN es v√°lido
          if (validarRunCl(v)) {
            buscarRun();
          }
        });
        
        // Tambi√©n buscar autom√°ticamente cuando se termine de escribir un RUN v√°lido
        let timeoutId;
        runForm.addEventListener('input', () => {
          clearTimeout(timeoutId);
          const v = runForm.value.trim();
          
          if (v && validarRunCl(v)) {
            // Esperar 1 segundo despu√©s de dejar de escribir
            timeoutId = setTimeout(() => {
              runSearch.value = v;
              buscarRun();
            }, 1000);
          }
        });
      }
    };

    setupBuscarEventListeners();
    // Bot√≥n nuevo usuario fuerza formulario vac√≠o
    const btnNuevo = document.getElementById('btn-nuevo-usuario');
    btnNuevo?.addEventListener('click', ()=>{
      if(formTarjeton){ formTarjeton.reset(); }
      if(runForm){ runForm.value=''; }
      if(cardResumen){ cardResumen.style.display='none'; cardResumen.classList.remove('expandido'); }
      if(ident){ ident.style.display='block'; }
      layoutGrid?.classList.add('no-resumen');
      layoutGrid?.classList.remove('solo-resumen');
      const nombre=document.getElementById('nombre');
      setTimeout(()=> nombre&&nombre.focus(),0);
      const badgeNuevo = document.getElementById('badge-nuevo-usuario');
      if(badgeNuevo) badgeNuevo.style.display='inline-block';
    });

    // Bot√≥n limpiar - limpia todo el formulario
    const btnLimpiar = document.getElementById('btn-limpiar');
    btnLimpiar?.addEventListener('click', ()=>{
      if(confirm('¬øEst√°s seguro de que deseas limpiar todo el formulario?')) {
        if(formTarjeton){ formTarjeton.reset(); }
        if(runForm){ runForm.value=''; }
        if(cardResumen){ cardResumen.style.display='none'; cardResumen.classList.remove('expandido'); }
        if(ident){ ident.style.display='block'; }
        layoutGrid?.classList.add('no-resumen');
        layoutGrid?.classList.remove('solo-resumen');
        
        // Limpiar campos espec√≠ficos que podr√≠an no limpiarse con reset()
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          if(input.type === 'checkbox' || input.type === 'radio') {
            input.checked = false;
          } else {
            input.value = '';
          }
        });
        
        const nombre=document.getElementById('nombre');
        setTimeout(()=> nombre&&nombre.focus(),0);
        
        console.log('Formulario limpiado completamente');
      }
    });

    // Bot√≥n MandrakeBot - abrir chat
    const btnMandrakeBot = document.getElementById('btn-mandrake-bot');
    const chatOverlay = document.getElementById('mandrake-chat-overlay'); 
    const chatClose = document.getElementById('mandrake-chat-close');
    const chatMessages = document.getElementById('mandrake-chat-messages');
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    // Debug: verificar que los elementos existen
    console.log('MandrakeBot elements:', {
      btnMandrakeBot: !!btnMandrakeBot,
      chatOverlay: !!chatOverlay,
      chatClose: !!chatClose,
      chatMessages: !!chatMessages,
      chatInput: !!chatInput,
      chatSend: !!chatSend
    });
    
    let isMandrakeActive = false;
    
    // Funci√≥n para agregar mensaje al chat
    function addChatMessage(content, type = 'bot', isHtml = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `mandrake-message ${type}`;
      
      if (isHtml) {
        messageDiv.innerHTML = content;
      } else {
        messageDiv.textContent = content;
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return messageDiv;
    }
    
    // Funci√≥n para mostrar indicador de escritura
    function showTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'mandrake-typing';
      typingDiv.innerHTML = `
        <span style="font-size:12px;">MandrakeBot est√° escribiendo</span>
        <div class="mandrake-typing-dots">
          <div class="mandrake-typing-dot"></div>
          <div class="mandrake-typing-dot"></div>
          <div class="mandrake-typing-dot"></div>
        </div>
      `;
      chatMessages.appendChild(typingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return typingDiv;
    }
    
    // Funci√≥n para llamar a la IA
    async function callMandrakeAI(userMessage) {
      try {
        const response = await fetch('/api/ai/fill-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            text: userMessage,
            instruction: `Eres MandrakeBot, un asistente m√©dico inteligente especializado en ECICEP. 
                         Responde de manera profesional, emp√°tica y √∫til. 
                         Si la consulta es m√©dica, proporciona informaci√≥n educativa pero recuerda que no reemplazas el criterio m√©dico profesional.
                         Si pueden ayudar con el formulario actual, ofrece autocompletarlo.
                         Mant√©n respuestas concisas pero completas.`,
            schema: {
              type: "object",
              properties: {
                response: {
                  type: "string",
                  description: "Respuesta del asistente m√©dico"
                },
                suggestions: {
                  type: "array",
                  items: { type: "string" },
                  description: "Sugerencias de seguimiento opcional"
                },
                form_help: {
                  type: "boolean", 
                  description: "Si puede ayudar con el formulario actual"
                }
              }
            }
          })
        });
        
        const result = await response.json();
        
        if (result.ok && result.data) {
          return {
            response: result.data.response || 'Lo siento, no pude procesar tu consulta.',
            suggestions: result.data.suggestions || [],
            form_help: result.data.form_help || false
          };
        } else {
          throw new Error(result._error || 'Error en la respuesta de IA');
        }
      } catch (error) {
        console.error('Error llamando a MandrakeBot:', error);
        return {
          response: 'Lo siento, hay un problema de conexi√≥n. Por favor intenta nuevamente.',
          suggestions: [],
          form_help: false
        };
      }
    }
    
    // Funci√≥n para enviar mensaje
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Agregar mensaje del usuario
      addChatMessage(message, 'user');
      chatInput.value = '';
      chatSend.disabled = true;
      
      // Mostrar indicador de escritura
      const typingIndicator = showTypingIndicator();
      
      // Llamar a la IA
      const aiResponse = await callMandrakeAI(message);
      
      // Remover indicador de escritura
      typingIndicator.remove();
      
      // Agregar respuesta del bot
      let botMessage = aiResponse.response;
      
      // Agregar sugerencias si las hay
      if (aiResponse.suggestions && aiResponse.suggestions.length > 0) {
        botMessage += '\n\nüí° Sugerencias:\n' + aiResponse.suggestions.map(s => `‚Ä¢ ${s}`).join('\n');
      }
      
      // Agregar ayuda con formulario si corresponde
      if (aiResponse.form_help) {
        botMessage += '\n\nüìù ¬øTe gustar√≠a que te ayude a completar alg√∫n campo del formulario actual?';
      }
      
      addChatMessage(botMessage, 'bot');
      chatSend.disabled = false;
      chatInput.focus();
    }
    
    // Event listeners del chat
    if (btnMandrakeBot) {
      btnMandrakeBot.addEventListener('click', () => {
        console.log('MandrakeBot button clicked!');
        if (!chatOverlay) {
          console.error('Chat overlay not found!');
          return;
        }
        chatOverlay.style.display = 'flex';
        isMandrakeActive = true;
        if (chatInput) chatInput.focus();
      
      // Mensaje de bienvenida contextual
      if (chatMessages.children.length === 1) { // Solo mensaje inicial
        const runValue = document.getElementById('run')?.value || '';
        if (runValue) {
          addChatMessage(`Veo que est√°s trabajando con el RUN ${runValue}. ¬øEn qu√© puedo ayudarte con este paciente?`, 'system');
        }
      }
    });
    
    chatClose?.addEventListener('click', () => {
      chatOverlay.style.display = 'none';
      isMandrakeActive = false;
    });
    
    chatOverlay?.addEventListener('click', (e) => {
      if (e.target === chatOverlay) {
        chatOverlay.style.display = 'none';
        isMandrakeActive = false;
      }
    });
    
    chatSend?.addEventListener('click', sendMessage);
    
    chatInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    // Atajos de teclado
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + M para abrir/cerrar MandrakeBot
      if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        if (isMandrakeActive) {
          chatOverlay.style.display = 'none';
          isMandrakeActive = false;
        } else {
          btnMandrakeBot?.click();
        }
      }
      
      // Escape para cerrar chat
      if (e.key === 'Escape' && isMandrakeActive) {
        chatOverlay.style.display = 'none';
        isMandrakeActive = false;
      }
    });
    } else {
      console.error('MandrakeBot button not found!');
    }

  })();
  // (Listeners antiguos de cargarDatos y debounce eliminados)

  // Funci√≥n global para abrir MandrakeBot (respaldo)
  function openMandrakeBot() {
    console.log('openMandrakeBot() called');
    const chatOverlay = document.getElementById('mandrake-chat-overlay');
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatClose = document.getElementById('mandrake-chat-close');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    if (chatOverlay) {
      chatOverlay.style.display = 'flex';
      if (chatInput) chatInput.focus();
      
      // Configurar event listeners si no est√°n configurados
      if (chatClose && !chatClose.onclick) {
        chatClose.onclick = () => {
          chatOverlay.style.display = 'none';
        };
      }
      
      if (chatSend && !chatSend.onclick) {
        chatSend.onclick = () => {
          sendMandrakeMessage();
        };
      }
      
      if (chatInput && !chatInput.onkeypress) {
        chatInput.onkeypress = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMandrakeMessage();
          }
        };
      }
      
      // Event listener para cerrar con click fuera
      chatOverlay.onclick = (e) => {
        if (e.target === chatOverlay) {
          chatOverlay.style.display = 'none';
        }
      };
      
      // Mensaje de bienvenida contextual
      const chatMessages = document.getElementById('mandrake-chat-messages');
      if (chatMessages && chatMessages.children.length === 1) {
        const runValue = document.getElementById('run')?.value || '';
        if (runValue) {
          const systemMsg = document.createElement('div');
          systemMsg.className = 'mandrake-message system';
          systemMsg.textContent = `Veo que est√°s trabajando con el RUN ${runValue}. ¬øEn qu√© puedo ayudarte con este paciente?`;
          chatMessages.appendChild(systemMsg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }
    } else {
      console.error('Chat overlay not found!');
    }
  }
  
  // Funci√≥n para enviar mensaje
  async function sendMandrakeMessage() {
    const chatInput = document.getElementById('mandrake-chat-input');
    const chatMessages = document.getElementById('mandrake-chat-messages');
    const chatSend = document.getElementById('mandrake-chat-send');
    
    const message = chatInput.value.trim();
    if (!message) return;
    
    // Agregar mensaje del usuario
    const userMsg = document.createElement('div');
    userMsg.className = 'mandrake-message user';
    userMsg.textContent = message;
    chatMessages.appendChild(userMsg);
    
    chatInput.value = '';
    chatSend.disabled = true;
    
    // Mostrar indicador de escritura
    const typingDiv = document.createElement('div');
    typingDiv.className = 'mandrake-typing';
    typingDiv.innerHTML = `
      <span style="font-size:12px;">MandrakeBot est√° escribiendo</span>
      <div class="mandrake-typing-dots">
        <div class="mandrake-typing-dot"></div>
        <div class="mandrake-typing-dot"></div>
        <div class="mandrake-typing-dot"></div>
      </div>
    `;
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    try {
      // Llamar a la IA
      const response = await fetch('/api/ai/fill-form', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          text: message,
          instruction: `Eres MandrakeBot, un asistente m√©dico inteligente especializado en ECICEP. 
                       Responde de manera profesional, emp√°tica y √∫til. 
                       Si la consulta es m√©dica, proporciona informaci√≥n educativa pero recuerda que no reemplazas el criterio m√©dico profesional.
                       Si pueden ayudar con el formulario actual, ofrece autocompletarlo.
                       Mant√©n respuestas concisas pero completas.`,
          schema: {
            type: "object",
            properties: {
              response: {
                type: "string",
                description: "Respuesta del asistente m√©dico"
              }
            }
          }
        })
      });
      
      const result = await response.json();
      
      // Remover indicador de escritura
      typingDiv.remove();
      
      // Agregar respuesta del bot
      const botMsg = document.createElement('div');
      botMsg.className = 'mandrake-message bot';
      botMsg.textContent = result.ok && result.data ? 
        result.data.response || 'Lo siento, no pude procesar tu consulta.' :
        'Lo siento, hay un problema de conexi√≥n. Por favor intenta nuevamente.';
      
      chatMessages.appendChild(botMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
    } catch (error) {
      console.error('Error llamando a MandrakeBot:', error);
      typingDiv.remove();
      
      const errorMsg = document.createElement('div');
      errorMsg.className = 'mandrake-message bot';
      errorMsg.textContent = 'Lo siento, hay un problema de conexi√≥n. Por favor intenta nuevamente.';
      chatMessages.appendChild(errorMsg);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    chatSend.disabled = false;
    chatInput.focus();
  }

  async function cargarUltimoControl(runVal){
    if(!runVal) return;
    const limpio = runVal.replace(/[^0-9kK]/g,'');
    if(limpio.length < 7) return;
    try{
      const r = await authFetch(`/api/control/ultimo/${encodeURIComponent(runVal)}`);
      const d = await r.json();
      const panel = document.getElementById('panel-control');
      if(!panel) return;
      const ok = (typeof d.ok !== 'undefined') ? d.ok : (typeof d.success !== 'undefined' ? d.success : !!d.control);
      if(!ok){ panel.innerHTML='<div style="color:#b91c1c">Error cargando control</div>'; console.warn('Ultimo control respuesta inesperada', d); return; }
      if(!d.control){ panel.innerHTML='<div style="opacity:.6;">Sin control registrado.</div>'; return; }
      const c = d.control;
      panel.innerHTML = `
        <div><strong>Fecha:</strong> ${c.fecha || '‚Äî'} <strong style="margin-left:8px;">Profesional:</strong> ${c.profesional||'‚Äî'}</div>
        <div><strong>Peso:</strong> ${c.peso??'‚Äî'} kg <strong style="margin-left:8px;">Talla:</strong> ${c.talla??'‚Äî'} <strong style="margin-left:8px;">IMC:</strong> ${c.imc??'‚Äî'} <span class="badge-riesgo" style="background:#334155;color:#fff;">${c.imc_clasificacion||'‚Äî'}</span></div>
        <div><strong>PA:</strong> ${c.presion_sistolica??'‚Äî'}/${c.presion_diastolica??'‚Äî'} mmHg <span class="badge-riesgo" style="background:#64748b;color:#fff;">${c.hta_clasificacion||'‚Äî'}</span></div>
        <div><strong>CC:</strong> ${c.cc??'‚Äî'} <strong style="margin-left:8px;">HGT:</strong> ${c.hgt??'‚Äî'} <strong style="margin-left:8px;">HbA1c:</strong> ${c.hba1c??'‚Äî'}</div>
      `;
    }catch(e){ console.warn('Error control', e); }
  }
  // recargaTodo movido al final despu√©s de todas las definiciones de funciones
  // (Listeners vinculados a recargaTodo en input RUN eliminados; flujo centralizado en toolbar)

  // Cargar √∫ltimo examen pie diab√©tico
  async function cargarUltimoExamenPieDiabetico(runVal){
    try {
      // Por ahora solo log, ya que no hay endpoint espec√≠fico disponible
      console.log('[ü¶∂ Pie Diab√©tico] Funci√≥n de carga llamada para:', runVal);
      // TODO: Implementar cuando est√© disponible el endpoint /api/examenes-piedm/ultimo/
    } catch(e) {
      console.warn('[ü¶∂ Pie Diab√©tico] Error cargando √∫ltimo examen pie diab√©tico:', e);
    }
  }

  // Cargar √∫ltima curaci√≥n
  async function cargarUltimaCuracion(runVal){
    try {
      const r = await authFetch(`/api/curaciones-piedm/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[ü©π Curaciones] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de curaciones
        const curacion = data.data;
        console.log('[ü©π Curaciones] √öltima curaci√≥n cargada:', curacion);
        
        // Actualizar formulario si existe
        const tipoSelect = document.getElementById('tipoCuracion');
        const fechaInput = document.getElementById('fechaCuracion');
        
        if (tipoSelect && curacion.tipo_curacion) {
          tipoSelect.value = curacion.tipo_curacion;
        }
        if (fechaInput && curacion.fecha) {
          fechaInput.value = curacion.fecha;
        }
      } else {
        console.log('[ü©π Curaciones] No hay datos de curaciones para este usuario');
      }
    } catch(e) {
      console.log('[ü©π Curaciones] Funci√≥n ejecutada (sin datos disponibles)');
    }
  }

  // Cargar √∫ltima hipoglicemia
  async function cargarUltimaHipoglicemia(runVal){
    try {
      const r = await authFetch(`/api/diabetes/hipoglicemias/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[ü©∏ Hipoglicemias] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de hipoglicemias
        const hipoglicemia = data.data;
        console.log('[ü©∏ Hipoglicemias] √öltima hipoglicemia cargada:', hipoglicemia);
        
        // Actualizar formulario si existe
        const siRadio = document.getElementById('hipoglicemiasSi');
        const noRadio = document.getElementById('hipoglicemiasNo');
        const fechaInput = document.getElementById('fechaHipoglicemias');
        
        if (hipoglicemia.recurrente === true && siRadio) {
          siRadio.checked = true;
        } else if (hipoglicemia.recurrente === false && noRadio) {
          noRadio.checked = true;
        }
        
        if (fechaInput && hipoglicemia.fecha) {
          fechaInput.value = hipoglicemia.fecha;
        }
      } else {
        console.log('[ü©∏ Hipoglicemias] No hay datos de hipoglicemias para este usuario');
      }
    } catch(e) {
      console.log('[ü©∏ Hipoglicemias] Funci√≥n ejecutada (sin datos disponibles)');
    }
  }

  // Cargar √∫ltima amputaci√≥n
  async function cargarUltimaAmputacion(runVal){
    try {
      const r = await authFetch(`/api/examenes/pie_dm/${encodeURIComponent(runVal)}`);
      if(!r.ok) {
        console.log('[ü¶ø Amputaci√≥n] No hay datos disponibles (status:', r.status + ')');
        return;
      }
      const data = await r.json();
      if(data.ok && data.data) {
        // Cargar datos en el formulario de amputaci√≥n
        const amputacion = data.data;
        console.log('[ü¶ø Amputaci√≥n] √öltima amputaci√≥n cargada:', amputacion);
        
        // Actualizar formulario si existe
        const fechaInput = document.getElementById('fechaAmputacion');
        
        if (fechaInput && amputacion.fecha_amputacion) {
          fechaInput.value = amputacion.fecha_amputacion;
        }
      } else {
        console.log('[ü¶ø Amputaci√≥n] No hay datos de amputaci√≥n para este usuario');
      }
    } catch(e) {
      console.log('[ü¶ø Amputaci√≥n] Funci√≥n ejecutada (sin datos disponibles)');
    }
  }

  // Cargar sectores
  async function cargarSectores(){
    try{
      const r = await authFetch('/api/sectores');
      if(!r.ok) return; const d = await r.json(); if(!d.ok) return;
      const sel = document.getElementById('sector_id');
      if(!sel) return; const cur = sel.value;
      sel.innerHTML = '<option value="">-- Sector --</option>' + d.sectores.map(s=>`<option value="${s.id}">${s.nombre}</option>`).join('');
      if(cur) sel.value = cur; // mantener si ya hab√≠a
    }catch(e){ console.warn('No se pudieron cargar sectores', e); }
  }
  cargarSectores();

  // Formulario nuevo control
  const formControl = document.getElementById('form-control-nuevo');
  if(formControl){
    const tallaInput = formControl.querySelector('#input-talla');
    const pesoInput = formControl.querySelector('[name="peso"]');
    function normalizarTalla(){
      if(!tallaInput) return; const raw=tallaInput.value.trim(); if(!raw) return; let num=parseFloat(raw.replace(',','.'));
      if(isNaN(num)) return; if(num>0 && num<3){ num = num*100; tallaInput.value = num.toFixed(2); }
  window.computeIMC && window.computeIMC();
    }
    if(tallaInput){ tallaInput.addEventListener('blur', normalizarTalla); tallaInput.addEventListener('change', normalizarTalla); }
    if(pesoInput){ pesoInput.addEventListener('blur', computeIMC); pesoInput.addEventListener('change', computeIMC); }
    formControl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const estado = document.getElementById('estado-control');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal){ estado.textContent='RUN requerido'; estado.style.color='#b91c1c'; return; }
      estado.textContent='Guardando...'; estado.style.color='#334155';
      const fd = new FormData(formControl);
      const payload = { run: runVal };
      ['fecha','profesional','peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{
        const v = fd.get(k);
        if(v!==null && v!=='' ) payload[k]=v;
      });
      try{
        const r = await authFetch('/api/control',{method:'POST',body:JSON.stringify(payload)});
        const d = await r.json();
        if(!r.ok || !d.ok){ estado.textContent='Error'; estado.style.color='#b91c1c'; return; }
        estado.textContent='Guardado ‚úî'; estado.style.color='#065f46';
        // limpiar campos excepto fecha/profesional
        ['peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{ formControl.querySelector(`[name="${k}"]`).value=''; });
        cargarUltimoControl(runVal);
      }catch(err){ estado.textContent='Error red'; estado.style.color='#b91c1c'; }
    });
  }

  // Formulario nuevo acuerdo
  const formAcuerdo = document.getElementById('form-acuerdo-nuevo');
  if(formAcuerdo){
    // Establecer fecha actual por defecto
    const fechaInput = document.getElementById('acuerdo_fecha');
    if(fechaInput && !fechaInput.value){
      const hoy = new Date();
      fechaInput.value = hoy.toISOString().split('T')[0];
    }
    
    formAcuerdo.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const estado = document.getElementById('estado-acuerdo');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal){ 
        estado.textContent='RUN requerido'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      
      const fd = new FormData(formAcuerdo);
      const acuerdos = fd.get('acuerdos')?.trim();
      const cumplimiento = fd.get('cumplimiento')?.trim();
      
      if(!acuerdos){ 
        estado.textContent='Acuerdos requeridos'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      if(!cumplimiento){ 
        estado.textContent='Cumplimiento requerido'; 
        estado.style.color='#b91c1c'; 
        return; 
      }
      
      estado.textContent='Guardando...'; 
      estado.style.color='#334155';
      
      const payload = {
        usuario_id: runVal,
        acuerdos: acuerdos,
        cumplimiento: cumplimiento,
        observaciones: fd.get('observaciones')?.trim() || null,
        funcionario: fd.get('funcionario')?.trim() || null,
        fecha_creacion: fd.get('fecha') || null
      };
      
      try{
        const r = await fetch('/api/acuerdos',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        const d = await r.json();
        if(!r.ok || !d.ok){ 
          estado.textContent='Error: ' + (d.error || 'Desconocido'); 
          estado.style.color='#b91c1c'; 
          return; 
        }
        estado.textContent='Guardado ‚úî'; 
        estado.style.color='#065f46';
        
        // Limpiar formulario excepto fecha y profesional
        ['acuerdos','observaciones'].forEach(k=>{ 
          const el = formAcuerdo.querySelector(`[name="${k}"]`); 
          if(el) el.value=''; 
        });
        formAcuerdo.querySelector('[name="cumplimiento"]').value = '';
        
        // Recargar hist√≥rico de acuerdos
        cargarHistoricoAcuerdos(runVal);
        
        setTimeout(()=>{
          estado.textContent = '';
        }, 3000);
        
      }catch(err){ 
        console.error('Error guardando acuerdo:', err);
        estado.textContent='Error de red'; 
        estado.style.color='#b91c1c'; 
      }
    });
  }

  // ================= LABS =================
  async function cargarLabs(runVal){
    if(!runVal) return;
    const limpio = runVal.replace(/[^0-9kK]/g,'');
    if(limpio.length < 7) return;
    const cont = document.getElementById('panel-examenes');
    const tabla = document.getElementById('tabla-labs');
    const tbody = tabla.querySelector('tbody');
    if(cont){ cont.querySelector('div[style*="opacity"]')?.remove(); }
    try{
      const r = await authFetch(`/api/examenes/labs/${encodeURIComponent(runVal)}`);
      const j = await r.json();
      if(!r.ok || !j.ok){
        tbody.innerHTML = `<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error obteniendo labs (${j.error||r.status})</td></tr>`;
        tabla.style.display='table';
        return;
      }
      const labs = j.labs || {};
      const orden = [
        ['glicemia','Glicemia'],
        ['hba1c','HbA1c'],
        ['ldl','LDL'],
        ['hdl','HDL'],
        ['col','Col Total'],
        ['tag','Triglic√©ridos'],
        ['creatinemia','Creatinina'],
        ['vfg','VFG'],
        ['rac','RAC'],
        ['microalbuminuria','Microalbuminuria'],
        ['tsh','TSH'],
        ['rpr','RPR'],
        ['baciloscopia','Baciloscopia'],
        ['tos','Tos']
      ];
      const rows = [];
      orden.forEach(([k,label])=>{
        if(!labs[k]) return; // s√≥lo mostrar presentes
        const reg = labs[k] || {};
        let valorTxt = '';
        if(k==='microalbuminuria'){
          // Puede venir valor, valor_cuant, positiva
            if(reg.valor_cuant!=null) valorTxt = reg.valor_cuant;
            else if(reg.valor!=null) valorTxt = reg.valor;
            if(reg.positiva===true) valorTxt = (valorTxt? valorTxt+' / ' : '') + 'Positiva';
            else if(reg.positiva===false) valorTxt = (valorTxt? valorTxt+' / ' : '') + 'Negativa';
        } else if(reg.valor!=null){
          valorTxt = reg.valor;
        }
        const anot = [];
        if(reg.alerta) anot.push(reg.alerta);
        if(k==='vfg' && reg.erc_estadio) anot.push(reg.erc_estadio);
        const fecha = reg.fecha || '';
        rows.push(`<tr><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${label}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${valorTxt||'‚Äî'}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${fecha||'‚Äî'}</td><td style="padding:4px 6px;border-top:1px solid #e2e8f0;">${anot.join(' ‚Ä¢ ')}</td></tr>`);
      });
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos de laboratorio</td></tr>';
      } else {
        tbody.innerHTML = rows.join('');
      }
      tabla.style.display='table';
      // Cargar hist√≥rico en paralelo (no bloquear)
      cargarHistoricoLabs(runVal);
    }catch(e){
      console.error('[üìä Labs] Error', e);
      tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error de red labs</td></tr>';
      tabla.style.display='table';
    }
  }

  async function cargarHistoricoLabs(runVal){
    try{
      console.log('[HIST-LABS] Iniciando carga para RUN:', runVal);
      const r = await authFetch(`/api/examenes/labs/historico/${encodeURIComponent(runVal)}?limit=60`);
      console.log('[HIST-LABS] Response status:', r.status, r.ok);
      const j = await r.json();
      console.log('[HIST-LABS] Response data:', j);
      if(!r.ok || !j.ok){ 
        console.warn('[HIST-LABS] Response not OK:', r.ok, j.ok);
        return; 
      }
      const rawData = j.historico || j.registros || j.data || [];
      console.log('[HIST-LABS] Raw data length:', rawData.length);
      _histLabsRaw = rawData.map(x=>({
        fecha: x.examen_fecha || x.fecha || null,
        glicemia: x.glicemia,
        hba1c: x.hba1c,
        ldl: x.ldl,
        hdl: x.hdl,
        col: x.col,
        tag: x.tag,
        creatinemia: x.creatinemia,
        vfg: x.vfg,
        erc: x.erc_estadio,
        rac: x.rac,
        microalbuminuria: (x.microalbuminuria_val!=null? x.microalbuminuria_val : (x.microalbuminuria? 'Pos':'Neg')),
        tsh: x.tsh
      }));
      console.log('[HIST-LABS] Processed data length:', _histLabsRaw.length);
      renderHistoricoLabs('all');
      console.log('[HIST-LABS] Render completed');
    }catch(e){ 
      console.error('[HIST-LABS] Error:', e); 
      const tbody = document.getElementById('hist-labs-tbody');
      if(tbody) {
        tbody.innerHTML='<tr><td colspan="14" style="padding:6px;color:#b91c1c;">Error cargando hist√≥rico: ' + e.message + '</td></tr>';
      }
    }
  }

  function renderHistoricoLabs(scope){
    const tbody = document.getElementById('hist-labs-tbody');
    if(!tbody) return;
    let data = _histLabsRaw.slice();
    if(scope==='12m' || scope==='6m'){
      const meses = scope==='12m'?12:6;
      const hoy = new Date();
      data = data.filter(r=>{
        if(!r.fecha) return false;
        const d = new Date(r.fecha);
        const diffM = (hoy.getFullYear()-d.getFullYear())*12 + (hoy.getMonth()-d.getMonth());
        return diffM <= meses;
      });
    }
    if(!data.length){
      tbody.innerHTML = '<tr><td colspan="14" style="padding:6px;opacity:.6;">Sin datos</td></tr>';
      return;
    }
    // Delta simple: diferencia de HbA1c respecto registro previo
    let prevHba1c = null;
    const rows = data.map(r=>{
      let delta = '';
      if(r.hba1c!=null){
        if(prevHba1c!=null){
          const d = (parseFloat(r.hba1c) - parseFloat(prevHba1c));
            if(!isNaN(d) && d!==0) delta = (d>0? '+':'') + d.toFixed(1);
        }
        prevHba1c = r.hba1c;
      }
      return `<tr>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.fecha||'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.glicemia??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.hba1c??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.ldl??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.hdl??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.col??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.tag??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.creatinemia??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.vfg??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.erc||'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.rac??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.microalbuminuria??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${r.tsh??'‚Äî'}</td>
        <td style="padding:4px;border-top:1px solid #e2e8f0;">${delta||''}</td>
      </tr>`;
    });
    tbody.innerHTML = rows.join('');
  }

  // Listeners filtros historico labs (solo una vez)
  document.querySelectorAll('[data-filtro-labs]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-filtro-labs');
      renderHistoricoLabs(key);
    }, { once:false });
  });

  // ================= HIST√ìRICOS =================
  // Toggles gen√©ricos
  document.querySelectorAll('[data-toggle]').forEach(tg=>{
    tg.addEventListener('click', ()=>{
      const key = tg.getAttribute('data-toggle');
      const body = document.querySelector(`[data-body="${key}"]`);
      const icon = document.querySelector(`[data-icon="${key}"]`);
      if(!body) return;
      const visible = body.style.display!=='none';
      body.style.display = visible? 'none':'block';
      if(icon) icon.textContent = visible? '‚ñº':'‚ñ≤';
    });
  });

  // Arrays originales para filtros y tendencias
  let _histControlRaw = [];
  let _histLabsRaw = [];
  
  // Funci√≥n global de debug para verificar datos desde consola
  window.debugHistoricos = function() {
    console.log('=== DEBUG HIST√ìRICOS ===');
    console.log('_histControlRaw:', _histControlRaw?.length || 'undefined', _histControlRaw);
    console.log('_histLabsRaw:', _histLabsRaw?.length || 'undefined', _histLabsRaw);
    
    const tbody = document.getElementById('hist-control-tbody');
    if (tbody) {
      console.log('hist-control-tbody existe, contenido:', tbody.innerHTML.substring(0, 300));
    } else {
      console.log('hist-control-tbody NO encontrado');
    }
    
    const tbodyLabs = document.getElementById('hist-labs-tbody');
    if (tbodyLabs) {
      console.log('hist-labs-tbody existe, contenido:', tbodyLabs.innerHTML.substring(0, 300));
    } else {
      console.log('hist-labs-tbody NO encontrado');
    }
  };

  // Funci√≥n de test para forzar carga de hist√≥ricos
  window.testCargarHistoricos = function() {
    console.log('=== TEST FORZAR CARGA HIST√ìRICOS ===');
    const runField = document.getElementById('run');
    const runVal = runField?.value?.trim();
    console.log('RUN detectado:', runVal);
    
    if (runVal) {
      console.log('Ejecutando cargarHistoricoControl...');
      cargarHistoricoControl(runVal);
      
      console.log('Ejecutando cargarHistoricoLabs...');
      cargarHistoricoLabs(runVal);
      
      console.log('Ejecutando cargarHistoricoAcuerdos...');
      cargarHistoricoAcuerdos(runVal);
    } else {
      console.log('No hay RUN disponible');
    }
  };
  
  // Funci√≥n para verificar el estado general del sistema
  window.estadoSistema = function() {
    console.log('=== ESTADO DEL SISTEMA ===');
    const runField = document.getElementById('run');
    const runVal = runField?.value?.trim();
    console.log('Campo RUN:', runField ? 'EXISTE' : 'NO EXISTE');
    console.log('Valor RUN:', runVal || 'VAC√çO');
    
    console.log('Funciones disponibles:');
    console.log('- cargarHistoricoControl:', typeof cargarHistoricoControl);
    console.log('- cargarHistoricoLabs:', typeof cargarHistoricoLabs);
    console.log('- cargarHistoricoAcuerdos:', typeof cargarHistoricoAcuerdos);
    console.log('- recargaTodo:', typeof window.recargaTodo);
    
    console.log('Elementos DOM:');
    console.log('- hist-control-tbody:', document.getElementById('hist-control-tbody') ? 'EXISTE' : 'NO EXISTE');
    console.log('- hist-labs-tbody:', document.getElementById('hist-labs-tbody') ? 'EXISTE' : 'NO EXISTE');
  };

  async function cargarHistoricoControl(runVal){
    const tbody = document.getElementById('hist-control-tbody');
    if(!tbody) {
      console.error('[HIST-CONTROL] No se encontr√≥ tbody con id hist-control-tbody');
      return;
    }
    if(!runVal){ tbody.innerHTML='<tr><td colspan="10" style="padding:6px;opacity:.6;">‚Äî</td></tr>'; return; }
    try{
      console.log('[HIST-CONTROL] Cargando hist√≥rico control para RUN:', runVal);
      const r = await authFetch(`/api/control/historico/${encodeURIComponent(runVal)}?limit=12`);
      console.log('Response status hist√≥rico control:', r.status, r.ok);
      console.log('Response headers:', [...r.headers.entries()]);
      const responseText = await r.text();
      console.log('Response text raw:', responseText);
      let d;
      try {
        d = JSON.parse(responseText);
        console.log('JSON parseado correctamente:', d);
      } catch (parseError) {
        console.error('Error parsing JSON:', parseError);
        console.log('Contenido no es JSON v√°lido:', responseText.substring(0, 200));
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error: respuesta no es JSON v√°lido</td></tr>';
        return;
      }
      
      // Manejo m√°s flexible de la respuesta
      let ok = false;
      let controles = [];
      
      if (d.ok !== undefined) {
        ok = d.ok;
        controles = d.controles || d.data || [];
      } else if (d.success !== undefined) {
        ok = d.success;
        controles = d.controles || d.data || [];
      } else if (Array.isArray(d.controles)) {
        ok = true;
        controles = d.controles;
      } else if (Array.isArray(d.data)) {
        ok = true;
        controles = d.data;
      } else if (Array.isArray(d)) {
        // Si la respuesta es directamente un array
        ok = true;
        controles = d;
      }
      
      console.log('Procesado - ok:', ok, 'controles:', controles.length);
      
      if (!ok) {
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error: respuesta inv√°lida del servidor</td></tr>';
        return;
      }
      
      _histControlRaw = controles;
      console.log('[HIST-CONTROL] _histControlRaw asignado, longitud:', _histControlRaw.length);
      console.log('[HIST-CONTROL] Primer elemento:', _histControlRaw[0]);
      
      if(!_histControlRaw.length){ 
        tbody.innerHTML='<tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; 
        console.log('[HIST-CONTROL] No hay datos de control para mostrar');
        return; 
      }
      
      console.log('[HIST-CONTROL] Llamando aplicarFiltrosYRenderControl con', _histControlRaw.length, 'registros');
      
      // Test immediato para verificar que los datos est√°n disponibles
      setTimeout(() => {
        console.log('[HIST-CONTROL-TEST] Verificando datos despu√©s de 100ms');
        console.log('[HIST-CONTROL-TEST] _histControlRaw length:', _histControlRaw?.length);
        const tbody = document.getElementById('hist-control-tbody');
        if (tbody) {
          console.log('[HIST-CONTROL-TEST] tbody innerHTML length:', tbody.innerHTML.length);
          console.log('[HIST-CONTROL-TEST] tbody innerHTML preview:', tbody.innerHTML.substring(0, 200));
        }
      }, 100);
      
      aplicarFiltrosYRenderControl();
    }catch(e){ 
      console.error('Error cargando hist√≥rico control:', e);
      tbody.innerHTML='<tr><td colspan="11" style="padding:6px;color:#b91c1c;">Error red: ' + e.message + '</td></tr>'; 
    }
  }



  async function cargarHistoricoAcuerdos(runVal){
    const tbody = document.getElementById('hist-acuerdos-tbody');
    const ult = document.getElementById('acuerdo-ultimo');
    if(!tbody) return;
    if(!runVal){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;opacity:.6;">‚Äî</td></tr>'; ult.textContent='Sin datos'; return; }
    try{
      const r = await authFetch(`/api/acuerdos/historico/${encodeURIComponent(runVal)}?limit=8`);
      const d = await r.json();
      const ok = (typeof d.ok !== 'undefined') ? d.ok : (typeof d.success !== 'undefined' ? d.success : Array.isArray(d.acuerdos));
      if(!ok){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error</td></tr>'; ult.textContent='Error'; return; }
      const rows = d.acuerdos || d.data || [];
      if(!rows.length){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; ult.textContent='Sin datos'; return; }
      const primero = rows[0];
      ult.textContent = `${primero.fecha_creacion || ''}: ${primero.acuerdos || ''} (${primero.cumplimiento || ''})`;
      tbody.innerHTML = rows.map(a=>{
        return `<tr style=\"border-top:1px solid #e2e8f0;\">\n          <td style=\"padding:4px;\">${a.fecha_creacion||''}</td>\n          <td style=\"padding:4px;\">${(a.acuerdos||'').toString().slice(0,60)}</td>\n          <td style=\"padding:4px;\">${a.cumplimiento||'‚Äî'}</td>\n          <td style=\"padding:4px;\">${(a.observaciones||'').toString().slice(0,40)}</td>\n        </tr>`;
      }).join('');
    }catch(e){ tbody.innerHTML='<tr><td colspan="4" style="padding:6px;color:#b91c1c;">Error red</td></tr>'; ult.textContent='Error'; }
  }

  function mostrarEstado(msg, tipo='info'){
    let box = document.getElementById('estado-guardar');
    if(!box){
      box = document.createElement('div');
      box.id='estado-guardar';
      box.style.fontSize='.75rem';
      box.style.marginTop='4px';
      document.getElementById('form-tarjeton').appendChild(box);
    }
    const colores = {info:'#334155',ok:'#065f46',error:'#b91c1c'};
    box.style.color = colores[tipo]||colores.info;
    box.textContent = msg;
  }

  async function guardar(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const payload = {
      run: fd.get('run')?.trim(),
      nombre: fd.get('nombre')?.trim() || null,
      fecha_nacimiento: fd.get('fecha_nacimiento') || null,
      sexo: fd.get('sexo')||null,
      direccion: fd.get('direccion')||null,
      telefono: fd.get('telefono')||null,
      sector_id: fd.get('sector_id') || null
    };
    if(!payload.run){ mostrarEstado('RUN requerido','error'); return; }
    mostrarEstado('Guardando...');
    try{
      const r = await authFetch('/api/tarjeton',{method:'POST',body:JSON.stringify(payload)});
      const data = await r.json().catch(()=>({ok:false,error:'RESPUESTA_INVALIDA'}));
      if(!r.ok || !data.ok){
        mostrarEstado('Error guardando: '+(data.error||r.status),'error');
        return;
      }
      mostrarEstado('Guardado ‚úî','ok');
      poblar(data); // refrescar
    }catch(err){
      console.error(err);
      mostrarEstado('Error de red','error');
    }
  }
  document.getElementById('form-tarjeton').addEventListener('submit', guardar);

  // Event listeners para evaluaci√≥n adulto mayor
  const tugSegundos = document.getElementById('tugSegundos');
  const unipodalDerecho = document.getElementById('unipodalPieDerecho');
  const unipodalIzquierdo = document.getElementById('unipodalPieIzquierdo');
  
  if (tugSegundos) {
    tugSegundos.addEventListener('input', calcularClasificacionTUG);
  }
  
  if (unipodalDerecho || unipodalIzquierdo) {
    unipodalDerecho?.addEventListener('input', calcularClasificacionUnipodal);
    unipodalIzquierdo?.addEventListener('input', calcularClasificacionUnipodal);
  }

  // Delegaci√≥n para filtros
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-filtro-control]');
    if(b){
      const v = b.getAttribute('data-filtro-control');
      aplicarFiltrosYRenderControl(v==='6m'?6: v==='12m'?12: null);
    }
    const b2 = e.target.closest('[data-filtro-labs]');
    if(b2){
      const v = b2.getAttribute('data-filtro-labs');
      aplicarFiltrosYRenderLabs(v==='6m'?6: v==='12m'?12: null);
    }
    const exp = e.target.closest('[data-export]');
    if(exp){
      const tipo = exp.getAttribute('data-export');
      const runVal = document.getElementById('run').value.trim();
      if(!runVal) return;
      window.location = `/api/export/historico/${encodeURIComponent(runVal)}?tipo=${tipo}&formato=xlsx`;
    }
  });

  function claseRiesgo(nombre){
    if(!nombre) return 'badge-neutro';
    const n = nombre.toString().toLowerCase();
    // Mapeo expl√≠cito G1/G2/G3 solicitado: G1 verde, G2 amarillo, G3 rojo
    if(/^g1\b/.test(n)) return 'badge-g1';
    if(/^g2\b/.test(n)) return 'badge-g2';
    if(/^g3\b/.test(n)) return 'badge-g3';
    if(/alto/.test(n)) return 'badge-alto';
    if(/moderado|medio/.test(n)) return 'badge-medio';
    if(/bajo|leve/.test(n)) return 'badge-bajo';
    return 'badge-neutro';
  }
  let modoCardio = false; // Si est√° activo, badge en color plomo (neutro)
  function actualizarBadgeRiesgo(texto){
    let badge = document.getElementById('badge-riesgo');
    if(!badge){
      const contResumen = document.querySelector('#resumen-ident');
      badge = document.createElement('div');
      badge.id='badge-riesgo';
      badge.style.marginTop='6px';
      contResumen.appendChild(badge);
    }
    if(modoCardio){
      // En modo CARDIO siempre plomo independientemente de G1/G2/G3
      badge.className = 'badge-riesgo badge-neutro';
      badge.textContent = texto || '‚Äî';
    } else {
      badge.className = 'badge-riesgo '+claseRiesgo(texto);
      badge.textContent = texto || '‚Äî';
    }
    const inputCat = document.getElementById('categoria');
    if(inputCat) inputCat.value = texto || '‚Äî';
  }

  // Estilos b√°sicos badges inyectados si no existen
  if(!document.getElementById('css-badges-riesgo')){
    const style = document.createElement('style');
    style.id='css-badges-riesgo';
    style.textContent = `
      .badge-riesgo{display:inline-block;padding:4px 8px;font-size:.65rem;font-weight:600;letter-spacing:.5px;border-radius:14px;background:#e2e8f0;color:#334155;text-transform:uppercase;}
      .badge-riesgo.badge-alto{background:#b91c1c;color:#fff;}
      .badge-riesgo.badge-medio{background:#d97706;color:#fff;}
      .badge-riesgo.badge-bajo{background:#15803d;color:#fff;}
      .badge-riesgo.badge-neutro{background:#64748b;color:#fff;}
      /* Nuevos estilos para categor√≠as renales G1/G2/G3 */
      .badge-riesgo.badge-g1{background:#16a34a;color:#fff;}
      .badge-riesgo.badge-g2{background:#facc15;color:#422006;}
      .badge-riesgo.badge-g3{background:#dc2626;color:#fff;}
      .badge-riesgo.badge-g3{background:#b91c1c;color:#fff;}
    `;
    document.head.appendChild(style);
  }

  // Hacer funci√≥n disponible globalmente
  window.actualizarBadgeRiesgo = actualizarBadgeRiesgo;

  // Integrar con selecci√≥n de programa ya existente: escuchamos evento programa:cambio
  document.addEventListener('programa:cambio', (e)=>{
    modoCardio = (e.detail?.programa === 'CARDIO');
    actualizarBadgeRiesgo(document.querySelector('[data-f="categoria_nombre"]').textContent);
  });

  // Estilos alertas hist√≥ricos
  if(!document.getElementById('css-alertas-hist')){
    const st = document.createElement('style');
    st.id='css-alertas-hist';
    st.textContent = `
      .row-danger{background:rgba(185,28,28,0.18)!important;}
      .row-warning{background:rgba(217,119,6,0.18)!important;}
      .row-good{background:rgba(22,163,74,0.18)!important;}
      .delta-up{color:#b91c1c;font-weight:600;}
      .delta-down{color:#15803d;font-weight:600;}
      .delta-flat{color:#475569;opacity:.6;}
    `;
    document.head.appendChild(st);
  }
  // (fin estilos hist√≥ricos)
  
  // Funciones auxiliares para hist√≥ricos
  function colorearControles(){
    // Colorear filas seg√∫n clasificaciones de riesgo
    document.querySelectorAll('#hist-control-tbody tr.ctl-row').forEach(tr=>{
      const imc = tr.querySelector('[data-imc]')?.getAttribute('data-imc');
      const hta = tr.querySelector('[data-hta]')?.getAttribute('data-hta');
      if(imc && parseFloat(imc) >= 30) tr.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
      else if(hta && /alto/i.test(hta)) tr.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
    });
  }
  
  // === Helpers puros para c√°lculo de tendencias ===
  function num(v){ if (v == null) return null; const n = parseFloat(v); return Number.isNaN(n) ? null : n; }
  function delta(a,b){ const na=num(a), nb=num(b); return (na==null || nb==null) ? null : (na - nb); }

  // Tabla de m√©tricas (misma sem√°ntica)
  const _METRICAS = [
    { key:'presion_sistolica',  thr:5,   tip:false, lab:'PS' },
    { key:'presion_diastolica', thr:5,   tip:false, lab:'PD' },
    { key:'imc',                thr:0.5, tip:true  },
    { key:'hba1c',              thr:0.3, tip:true  },
    { key:'peso',               thr:1,   tip:true  },
    { key:'cc',                 thr:1,   tip:true  },
  ];

  // Puro: genera el array de spans para una fila
  function buildPartes(actual, prev){
    const partes = [];
    for (const m of _METRICAS){
      const d = delta(actual[m.key], prev[m.key]);
      if (d === null) continue;
      if (Math.abs(d) >= m.thr) partes.push(arrowHTML(d, m.thr, !!m.tip, m.lab));
    }
    return partes;
  }

  // MISMA FIRMA
  function calcularTendenciasControles(rows){
    const trs = document.querySelectorAll('#hist-control-tbody tr.ctl-row');
    const last = rows.length - 1;

    for (let i = 0; i < rows.length; i++){
      if (i === last) break; // √∫ltimo no tiene anterior
      const tr = trs[i];
      if (!tr) continue;

      const deltaCell = tr.querySelector('[data-delta]');
      if (!deltaCell) continue;

      const partes = buildPartes(rows[i], rows[i+1]);
      deltaCell.innerHTML = partes.join(' ');
    }
  }
  
  function arrowHTML(delta, umbral, conTooltip, label) {
    if(Math.abs(delta) < umbral) return `<span class="delta-flat">‚Äî</span>`;
    const dir = delta > 0 ? 'up' : 'down';
    const color = delta > 0 ? '#dc2626' : '#16a34a';
    const arrow = delta > 0 ? '‚Üó' : '‚Üò';
    const tooltip = conTooltip ? ` title="Œî ${delta > 0 ? '+' : ''}${delta.toFixed(1)}"` : '';
    const labelTxt = label ? `<sub>${label}</sub>` : '';
    return `<span class="delta-${dir}" style="color:${color};"${tooltip}>${arrow}${labelTxt}</span>`;
  }
  
  // Render hist√≥rico de controles con posibilidad de filtrar por meses
  function aplicarFiltrosYRenderControl(meses){
    console.log('[RENDER-CONTROL] aplicarFiltrosYRenderControl llamado con meses:', meses);
    console.log('[RENDER-CONTROL] _histControlRaw disponible:', _histControlRaw ? _histControlRaw.length : 'undefined');
    console.log('[RENDER-CONTROL] _histControlRaw primer elemento:', _histControlRaw?.[0]);
    
    const tbody = document.getElementById('hist-control-tbody');
    if(!tbody) {
      console.log('Error: no se encontr√≥ tbody hist-control-tbody');
      return;
    }
    
    let rows = [..._histControlRaw];
    console.log('[RENDER-CONTROL] Filas iniciales:', rows.length);
    console.log('[RENDER-CONTROL] Primera fila de datos:', rows[0]);
    
    if(meses){
      const corte = new Date(); corte.setMonth(corte.getMonth()-meses);
      console.log('[RENDER-CONTROL] Fecha de corte para', meses, 'meses:', corte);
      console.log('[RENDER-CONTROL] Primera fecha ejemplo:', rows[0]?.fecha, '=> Date:', new Date(rows[0]?.fecha));
      rows = rows.filter(r=> {
        if (!r.fecha) return false;
        const fechaRow = new Date(r.fecha);
        const incluir = fechaRow >= corte;
        if (!incluir) console.log('[RENDER-CONTROL] Filtrada:', r.fecha, fechaRow, '<', corte);
        return incluir;
      });
      console.log('[RENDER-CONTROL] Filas despu√©s del filtro de', meses, 'meses:', rows.length);
    }
    
    if(!rows.length){ 
      tbody.innerHTML='<tr><td colspan="11" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; 
      console.log('No hay filas para mostrar');
      return; 
    }
    
    console.log('Generando HTML para', rows.length, 'filas');
    tbody.innerHTML = rows.map((c,idx)=>{
      return `<tr class=\"ctl-row\" data-index=\"${idx}\" style=\"border-top:1px solid #e2e8f0;\">\n          <td style=\"padding:4px;\">${c.fecha||''}</td>\n          <td style=\"padding:4px;\" data-psis=\"${c.presion_sistolica??''}\" data-pdia=\"${c.presion_diastolica??''}\">${c.presion_sistolica??'‚Äî'}/${c.presion_diastolica??'‚Äî'}</td>\n          <td style=\"padding:4px;\" data-imc=\"${c.imc??''}\">${c.imc??'‚Äî'}</td>\n          <td style=\"padding:4px;\">${c.imc_clasificacion||'‚Äî'}</td>\n          <td style=\"padding:4px;\" data-hta=\"${c.hta_clasificacion||''}\">${c.hta_clasificacion||'‚Äî'}</td>\n          <td style=\"padding:4px;\">${c.peso??'‚Äî'}</td>\n          <td style=\"padding:4px;\">${c.talla??'‚Äî'}</td>\n          <td style=\"padding:4px;\">${c.cc??'‚Äî'}</td>\n          <td style=\"padding:4px;\">${c.hgt??'‚Äî'}</td>\n          <td style=\"padding:4px;\" data-hba1c=\"${c.hba1c??''}\">${c.hba1c??'‚Äî'}</td>\n          <td style=\"padding:4px;\" data-delta=\"1\"></td>\n        </tr>`;}).join('');
    
    console.log('HTML generado e insertado. Aplicando colores y tendencias...');
    colorearControles();
    calcularTendenciasControles(rows);
    console.log('aplicarFiltrosYRenderControl completado');
  }

  // Render hist√≥rico de labs (tabla amplia) reutilizando _histLabsRaw
  function aplicarFiltrosYRenderLabs(meses){
    const tbody = document.getElementById('hist-labs-tbody');
    if(!tbody) return;
    let rows = [..._histLabsRaw];
    if(meses){
      const corte = new Date(); corte.setMonth(corte.getMonth()-meses);
      rows = rows.filter(r=> (r.examen_fecha||r.fecha_realizacion) && new Date(r.examen_fecha||r.fecha_realizacion) >= corte);
    }
    if(!rows.length){ tbody.innerHTML='<tr><td colspan="13" style="padding:6px;opacity:.6;">Sin datos</td></tr>'; return; }
    function fmt(v){ return (v===null||v===undefined||v==='')? '‚Äî' : (isFinite(v)? (Math.abs(v)>=100? Number(v).toFixed(0): v): v); }
    tbody.innerHTML = rows.map((r,idx)=>{
      const fecha = r.examen_fecha || r.fecha_realizacion || '';
      return `<tr class=\"lab-row\" data-index=\"${idx}\" style=\"border-top:1px solid #e2e8f0;\">\n        <td style=\"padding:4px;\">${fecha}</td>\n        <td style=\"padding:4px;\" data-glicemia=\"${r.glicemia??''}\">${fmt(r.glicemia)}</td>\n        <td style=\"padding:4px;\" data-hba1c=\"${r.hba1c??''}\">${fmt(r.hba1c)}</td>\n        <td style=\"padding:4px;\" data-ldl=\"${r.ldl??''}\">${fmt(r.ldl)}</td>\n        <td style=\"padding:4px;\" data-hdl=\"${r.hdl??''}\">${fmt(r.hdl)}</td>\n        <td style=\"padding:4px;\" data-col=\"${r.col??''}\">${fmt(r.col)}</td>\n        <td style=\"padding:4px;\" data-tag=\"${r.tag??''}\">${fmt(r.tag)}</td>\n        <td style=\"padding:4px;\" data-creatinemia=\"${r.creatinemia??''}\">${fmt(r.creatinemia)}</td>\n        <td style=\"padding:4px;\" data-vfg=\"${r.vfg??''}\">${fmt(r.vfg)}</td>\n        <td style="padding:4px;" data-rac="${r.rac??''}">${fmt(r.rac)}</td>\n        <td style="padding:4px;" data-micro="${r.microalbuminuria??''}">${(r.microalbuminuria_positiva? 'Positiva': (r.microalbuminuria? 'S√≠':'No')) + (r.microalbuminuria_val? ' '+fmt(r.microalbuminuria_val):'')}</td>\n        <td style="padding:4px;" data-tsh="${r.tsh??''}">${fmt(r.tsh)}</td>\n        <td style="padding:4px;" data-delta="1"></td>\n      </tr>`;}).join('');
    colorearLabs();
    calcularTendenciasLabs(rows);
  }
  
  function colorearLabs(){
    // Colorear filas seg√∫n valores de riesgo
    document.querySelectorAll('#hist-labs-tbody tr.lab-row').forEach(tr=>{
      const hba1c = tr.querySelector('[data-hba1c]')?.getAttribute('data-hba1c');
      const ldl = tr.querySelector('[data-ldl]')?.getAttribute('data-ldl');
      const vfg = tr.querySelector('[data-vfg]')?.getAttribute('data-vfg');
      
      if(hba1c && parseFloat(hba1c) >= 7) tr.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
      else if(ldl && parseFloat(ldl) >= 130) tr.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
      else if(vfg && parseFloat(vfg) < 60) tr.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
    });
  }
  
  function calcularTendenciasLabs(rows){
    const trs = document.querySelectorAll('#hist-labs-tbody tr.lab-row');
    rows.forEach((r,i)=>{
      if(i===rows.length-1) return;
      const prev = rows[i+1];
      const deltaLdl = (r.ldl!=null && prev.ldl!=null)? (parseFloat(r.ldl)-parseFloat(prev.ldl)) : null;
      const deltaHba = (r.hba1c!=null && prev.hba1c!=null)? (parseFloat(r.hba1c)-parseFloat(prev.hba1c)) : null;
      const cell = trs[i].querySelector('[data-delta]');
      if(!cell) return;
      let partes=[];
      if(deltaLdl!==null && Math.abs(deltaLdl)>=10) partes.push(arrowHTML(deltaLdl, 10, true));
      if(deltaHba!==null && Math.abs(deltaHba)>=0.3) partes.push(arrowHTML(deltaHba, 0.3, true));
      cell.innerHTML = partes.join(' ');
    });
  }
(async function initRiesgo(){
  const cont = document.getElementById('contenedor-patologias');
  if(!cont) return;
  let catalogo = [];
  let seleccion = new Set();
  let patologiasCargadasUsuario = new Set();
  const buscador = document.getElementById('buscador-patologia');
  const btnCalc = document.getElementById('btn-calcular-riesgo');
  const btnAplicar = document.getElementById('btn-aplicar-riesgo');
  const btnGuardarPats = document.getElementById('btn-guardar-patologias');
  const btnSelectFiltradas = document.getElementById('btn-select-filtradas');
  const btnClearSel = document.getElementById('btn-clear-seleccion');
  const contadorSel = document.getElementById('contador-seleccion');
  const estadoPats = document.getElementById('estado-patologias');
  const riesgoSug = document.getElementById('riesgo-sugerido');
  const riesgoApl = document.getElementById('riesgo-aplicado');
  const riesgoRaz = document.getElementById('riesgo-razones');

  function setEstado(msg,tipo='info'){
    estadoPats.textContent = msg||'';
    estadoPats.style.color = tipo==='error' ? '#b91c1c' : '#334155';
  }

  function actualizarBotones(){
    const selCount = seleccion.size;
    if(contadorSel) contadorSel.textContent = selCount ? `${selCount} seleccionada${selCount>1?'s':''}` : '';
    if(btnCalc) btnCalc.disabled = selCount === 0;
    if(btnAplicar) btnAplicar.disabled = selCount === 0;
    if(btnGuardarPats) btnGuardarPats.disabled = selCount === 0;
    if(btnClearSel) btnClearSel.disabled = selCount === 0;
  }

  function render(){
    const q = (buscador.value||'').toLowerCase();
    cont.innerHTML='';
    
    // Filtrar patolog√≠as
    let filtrados = catalogo.filter(p=> 
      !q || 
      p.nombre.toLowerCase().includes(q) || 
      (p.cie10 && p.cie10.toLowerCase().includes(q))
    );
    
    if(!filtrados.length){ 
      cont.innerHTML = `
        <div style="
          text-align: center; 
          padding: 20px; 
          color: #6b7280; 
          font-style: italic;
          border: 2px dashed #e5e7eb;
          border-radius: 8px;
          background: #f9fafb;
        ">
          ${q ? `No se encontraron patolog√≠as que coincidan con "${q}"` : 'Sin patolog√≠as disponibles'}
        </div>
      `; 
      return;
    }
    
    // Mostrar contador de resultados si hay filtro
    if (q) {
      const contadorDiv = document.createElement('div');
      contadorDiv.style.cssText = `
        font-size: 0.7rem;
        color: #6b7280;
        padding: 4px 8px;
        background: #f3f4f6;
        border-radius: 4px;
        margin-bottom: 8px;
        text-align: center;
      `;
      contadorDiv.textContent = `${filtrados.length} patolog√≠a${filtrados.length !== 1 ? 's' : ''} encontrada${filtrados.length !== 1 ? 's' : ''}`;
      cont.appendChild(contadorDiv);
    }
    
    // Limitar resultados para rendimiento
    const maxResultados = 200;
    const mostrar = filtrados.slice(0, maxResultados);
    
    mostrar.forEach((p, index) => {
      const wrap = document.createElement('label');
      wrap.className = 'pat-row';
      
      const estaSel = seleccion.has(p.id);
      const yaExiste = patologiasCargadasUsuario.has(p.id);
      
      wrap.style.cssText = `
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 2px;
        border: 1px solid ${estaSel ? '#10b981' : yaExiste ? '#0ea5e9' : '#e5e7eb'};
        background: ${estaSel ? 'rgba(16, 185, 129, 0.1)' : yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff'};
        transition: all 0.2s ease;
        font-size: 0.75rem;
      `;
      
      // Resaltar t√©rminos de b√∫squeda
      let nombreDisplay = p.nombre;
      let cie10Display = p.cie10 || '';
      
      if (q) {
        const regex = new RegExp(`(${q})`, 'gi');
        nombreDisplay = nombreDisplay.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px; border-radius: 2px;">$1</mark>');
        cie10Display = cie10Display.replace(regex, '<mark style="background: #fef3c7; padding: 1px 2px; border-radius: 2px;">$1</mark>');
      }
      
      wrap.innerHTML = `
        <input type="checkbox" data-id="${p.id}" style="margin: 0; transform: scale(1.1);">
        <div style="flex: 1; line-height: 1.3;">
          <div style="color: #1f2937; font-weight: 500;">
            ${nombreDisplay}
          </div>
          ${cie10Display ? `<div style="color: #6b7280; font-size: 0.65rem; margin-top: 2px;">
            <strong>CIE-10:</strong> ${cie10Display}
          </div>` : ''}
        </div>
        ${yaExiste ? '<span style="background: #0ea5e9; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px;">YA TIENE</span>' : ''}
      `;
      
      const cb = wrap.querySelector('input');
      cb.checked = estaSel;
      
      // Eventos
      wrap.addEventListener('mouseover', () => {
        if (!estaSel) {
          wrap.style.background = '#f9fafb';
          wrap.style.borderColor = '#d1d5db';
        }
      });
      
      wrap.addEventListener('mouseout', () => {
        wrap.style.background = estaSel ? 'rgba(16, 185, 129, 0.1)' : yaExiste ? 'rgba(14, 165, 233, 0.05)' : '#ffffff';
        wrap.style.borderColor = estaSel ? '#10b981' : yaExiste ? '#0ea5e9' : '#e5e7eb';
      });
      
      cb.addEventListener('change', () => {
        if(cb.checked) {
          seleccion.add(p.id);
        } else {
          seleccion.delete(p.id);
        }
        actualizarBotones();
        actualizarPatologiasSeleccionadas();
        render();
      });
      
      wrap.addEventListener('click', (e) => {
        if (e.target !== cb) {
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        }
      });
      
      cont.appendChild(wrap);
    });
    
    // Mostrar mensaje si hay m√°s resultados
    if (filtrados.length > maxResultados) {
      const masResultados = document.createElement('div');
      masResultados.style.cssText = `
        text-align: center;
        padding: 8px;
        color: #f59e0b;
        font-size: 0.7rem;
        background: #fffbeb;
        border-radius: 4px;
        margin-top: 4px;
      `;
      masResultados.textContent = `‚ö†Ô∏è Mostrando ${maxResultados} de ${filtrados.length} resultados. Refine su b√∫squeda para ver m√°s.`;
      cont.appendChild(masResultados);
    }
    
    actualizarBotones();
  }
  
  // Nueva funci√≥n para actualizar el panel de patolog√≠as seleccionadas
  function actualizarPatologiasSeleccionadas() {
    const panel = document.getElementById('patologias-seleccionadas');
    if (!panel) return;
    
    if (seleccion.size === 0) {
      panel.innerHTML = '<div style="opacity:.6;text-align:center;padding:10px;">Ninguna patolog√≠a seleccionada</div>';
      return;
    }
    
    const seleccionadas = Array.from(seleccion).map(id => 
      catalogo.find(p => p.id === id)
    ).filter(Boolean);
    
    panel.innerHTML = seleccionadas.map(p => `
      <div style="
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 4px;
        padding: 4px 8px;
        margin: 2px 0;
        font-size: 0.65rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <span><strong>${p.cie10}</strong> - ${p.nombre}</span>
        <button onclick="this.parentElement.remove(); seleccion.delete(${p.id}); actualizarBotones(); render();" 
                style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:0.8rem;">√ó</button>
      </div>
    `).join('');
  }
  btnGuardarPats.addEventListener('click', async ()=>{
    const runVal = document.getElementById('run').value;
    if(!runVal || !seleccion.size){ return; }
    
    setEstado('Agregando patolog√≠as...'); 
    btnGuardarPats.disabled = true;
    
    // Convertir IDs de patolog√≠as a c√≥digos CIE10
    const cie10Codes = Array.from(seleccion).map(id => {
      const pat = catalogo.find(p => p.id === id);
      return pat ? pat.cie10 : null;
    }).filter(Boolean);
    
    if (cie10Codes.length === 0) {
      setEstado('No se encontraron c√≥digos CIE10 v√°lidos', 'error');
      btnGuardarPats.disabled = false;
      return;
    }
    
    let intentos = 0;
    const maxIntentos = 3;
    
    while (intentos < maxIntentos) {
      try {
        const r = await authFetch(`/api/agregar_patologias/${runVal}`, {
          method: 'POST',
          body: JSON.stringify({cie10_codes: cie10Codes})
        });
        
        if (r.status === 404) {
          setEstado('Usuario no encontrado', 'error');
          break;
        }
        
        if (r.status === 429) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Rate limit - Reintentando (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 2000 * intentos));
            continue;
          } else {
            setEstado('Servidor ocupado - Intente m√°s tarde', 'error');
            break;
          }
        }
        
        if (r.status >= 500) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Error servidor - Reintentando (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
            continue;
          } else {
            setEstado('Error del servidor - Intente m√°s tarde', 'error');
            break;
          }
        }
        
        const d = await r.json();
        if (d.success) { 
          setEstado('Patolog√≠as agregadas exitosamente (se mantienen las anteriores)'); 
          patologiasCargadasUsuario = new Set(seleccion); 
          seleccion.clear(); // Limpiar selecci√≥n despu√©s de agregar
          render(); 
          
          // Recargar datos del usuario para actualizar pesta√±as condicionales
          try {
            const respUser = await authFetch(`/api/buscar_usuario/${runVal}`);
            if (respUser.ok) {
              const userData = await respUser.json();
              if (userData && userData.ok) {
                // Actualizar pesta√±a diabetes basada en nuevas patolog√≠as
                mostrarOcultarDiabetes(userData.patologias_resumen);
                console.log('üîß [DEBUG] Pesta√±as actualizadas despu√©s de guardar patolog√≠as');
              }
            }
          } catch (e) {
            console.log('üîß [DEBUG] Error actualizando pesta√±as despu√©s de guardar patolog√≠as:', e);
          }
        } else {
          setEstado('Error agregando patolog√≠as: ' + (d.error || 'Error desconocido'), 'error');
        }
        break; // Salir del bucle si llegamos aqu√≠
        
      } catch (e) { 
        intentos++;
        if (intentos < maxIntentos) {
          setEstado(`Error conexi√≥n - Reintentando (${intentos}/${maxIntentos})...`);
          await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
        } else {
          setEstado('Error de conexi√≥n - Verifique su red', 'error');
        }
      }
    }
    
    btnGuardarPats.disabled = false;
  });
  btnSelectFiltradas.addEventListener('click', ()=>{
    const q = (buscador.value||'').toLowerCase();
    catalogo.forEach(p=>{
      if(!q || p.nombre.toLowerCase().includes(q) || p.cie10.toLowerCase().includes(q)){
        seleccion.add(p.id);
      }
    });
    render();
  });
  btnClearSel.addEventListener('click', ()=>{
    seleccion.clear();
    render();
  });
  
  // Mejorar bot√≥n "Aplicar al Usuario"
  if (btnAplicar) {
    btnAplicar.addEventListener('click', async () => {
      const runInput = document.getElementById('run');
      const runVal = runInput ? runInput.value.trim() : '';
      
      if (!runVal) {
        setEstado('Error: RUN requerido para aplicar patolog√≠as', 'error');
        return;
      }
      
      if (seleccion.size === 0) {
        setEstado('Error: Seleccione al menos una patolog√≠a', 'error');
        return;
      }
      
      // Confirmar aplicaci√≥n
      const patologiasTexto = Array.from(seleccion).map(id => {
        const pat = catalogo.find(p => p.id === id);
        return pat ? `${pat.cie10} - ${pat.nombre}` : `ID: ${id}`;
      }).join('\n');
      
      const confirmar = confirm(`¬øConfirma aplicar las siguientes patolog√≠as al usuario ${runVal}?\n\n${patologiasTexto}`);
      if (!confirmar) return;
      
      setEstado('Aplicando patolog√≠as al usuario...'); 
      btnAplicar.disabled = true;
      
      let intentos = 0;
      const maxIntentos = 3;
      
      while (intentos < maxIntentos) {
        try {
          const r = await authFetch('/api/tarjeton/patologias', {
            method: 'POST',
            body: JSON.stringify({
              run: runVal, 
              patologia_ids: [...seleccion]
            })
          });
          
          if (r.status === 404) {
            setEstado(`Error: Usuario ${runVal} no encontrado`, 'error');
            break;
          }
          
          if (r.status === 429) {
            intentos++;
            if (intentos < maxIntentos) {
              setEstado(`Rate limit - Reintentando aplicaci√≥n (${intentos}/${maxIntentos})...`);
              await new Promise(resolve => setTimeout(resolve, 2000 * intentos));
              continue;
            } else {
              setEstado('Servidor ocupado - Intente aplicar m√°s tarde', 'error');
              break;
            }
          }
          
          if (r.status >= 500) {
            intentos++;
            if (intentos < maxIntentos) {
              setEstado(`Error servidor - Reintentando aplicaci√≥n (${intentos}/${maxIntentos})...`);
              await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
              continue;
            } else {
              setEstado('Error del servidor - Intente aplicar m√°s tarde', 'error');
              break;
            }
          }
          
          const d = await r.json();
          
          if (d.ok) {
            setEstado(`‚úÖ Patolog√≠as aplicadas exitosamente (${d.total || seleccion.size})`);
            patologiasCargadasUsuario = new Set(seleccion);
            
            // Actualizar interfaz
            render();
            actualizarPatologiasSeleccionadas();
            
            // Recargar datos del usuario si es posible
            if (typeof sincronizarPatologiasUsuario === 'function') {
              setTimeout(() => sincronizarPatologiasUsuario(runVal), 1000);
            }
          } else {
            setEstado(`Error aplicando patolog√≠as: ${d.error || 'Error desconocido'}`, 'error');
          }
          break; // Salir del bucle si llegamos aqu√≠
          
        } catch (error) {
          intentos++;
          if (intentos < maxIntentos) {
            setEstado(`Error conexi√≥n - Reintentando aplicaci√≥n (${intentos}/${maxIntentos})...`);
            await new Promise(resolve => setTimeout(resolve, 1000 * intentos));
          } else {
            console.error('Error aplicando patolog√≠as:', error);
            setEstado('Error de conexi√≥n - Verifique su red', 'error');
          }
        }
      }
      
      btnAplicar.disabled = false;
    });
  }
  // Mejorar buscador con sugerencias
  buscador.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    
    // Render normal
    render();
    
    // Agregar sugerencias r√°pidas si el query es corto
    if (query.length >= 2 && query.length <= 4) {
      const sugerencias = catalogo
        .filter(p => p.cie10 && p.cie10.toLowerCase().startsWith(query))
        .slice(0, 5);
        
      if (sugerencias.length > 0) {
        const estadoPats = document.getElementById('estado-patologias');
        if (estadoPats) {
          const sugerenciasTexto = sugerencias.map(p => `${p.cie10}: ${p.nombre.substring(0, 30)}...`).join(' | ');
          estadoPats.innerHTML = `üí° Sugerencias: <span style="font-size:0.65rem;">${sugerenciasTexto}</span>`;
          estadoPats.style.color = '#6b7280';
        }
      }
    }
  });
  
  // Agregar sugerencias r√°pidas comunes
  const sugerenciasComunes = [
    { texto: 'HTA', query: 'I10' },
    { texto: 'DM2', query: 'E11' },
    { texto: 'Dislipidemia', query: 'E78' },
    { texto: 'ERC', query: 'N18' },
    { texto: 'Cardiopat√≠a', query: 'I25' }
  ];
  
  // Crear botones de sugerencias
  const sugerenciasDiv = document.createElement('div');
  sugerenciasDiv.style.cssText = 'display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap;';
  sugerenciasDiv.innerHTML = sugerenciasComunes.map(s => 
    `<button onclick="document.getElementById('buscador-patologia').value='${s.query}'; document.getElementById('buscador-patologia').dispatchEvent(new Event('input'));" 
     style="font-size:0.65rem; padding:2px 6px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:3px; cursor:pointer; color:#374151;">
     ${s.texto}
     </button>`
  ).join('');
  
  buscador.parentNode.insertBefore(sugerenciasDiv, buscador.nextSibling);
  
  async function cargarCatalogo(){
    setEstado('Cargando cat√°logo de patolog√≠as...');
    
    try{
      // Intentar m√∫ltiples endpoints para cargar patolog√≠as
      const endpoints = ['/api/patologias_catalogo', '/api/patologias', '/api/cie10'];
      let r, d;
      
      for (const endpoint of endpoints) {
        try {
          r = await authFetch(endpoint);
          if (r.ok) {
            d = await r.json();
            if (d.ok && (d.patologias || d.data)) {
              catalogo = d.patologias || d.data || [];
              console.log(`[üîé ECICEP] Cat√°logo cargado desde ${endpoint}: ${catalogo.length} patolog√≠as`);
              break;
            }
          }
        } catch (endpointError) {
          console.log(`[üîé ECICEP] Error en endpoint ${endpoint}:`, endpointError);
          continue;
        }
      }
      
      // Si no se pudo cargar desde ning√∫n endpoint, usar cat√°logo extendido offline
      if (!catalogo || catalogo.length === 0) {
        console.log('[üîé ECICEP] Usando cat√°logo offline extendido');
        catalogo = [
          {id: 1, cie10: 'I10', nombre: 'Hipertensi√≥n arterial esencial'},
          {id: 2, cie10: 'E11', nombre: 'Diabetes mellitus tipo 2'},
          {id: 3, cie10: 'E78', nombre: 'Trastorno del metabolismo de las lipoprote√≠nas'},
          {id: 4, cie10: 'N18', nombre: 'Enfermedad renal cr√≥nica'},
          {id: 5, cie10: 'I25', nombre: 'Enfermedad isqu√©mica cr√≥nica del coraz√≥n'},
          {id: 6, cie10: 'E10', nombre: 'Diabetes mellitus tipo 1'},
          {id: 7, cie10: 'I50', nombre: 'Insuficiencia card√≠aca'},
          {id: 8, cie10: 'J44', nombre: 'Enfermedad pulmonar obstructiva cr√≥nica'},
          {id: 9, cie10: 'M79', nombre: 'Trastornos de los tejidos blandos'},
          {id: 10, cie10: 'F32', nombre: 'Episodio depresivo'},
          {id: 11, cie10: 'I11', nombre: 'Enfermedad card√≠aca hipertensiva'},
          {id: 12, cie10: 'I12', nombre: 'Enfermedad renal hipertensiva'},
          {id: 13, cie10: 'G93', nombre: 'Otros trastornos del enc√©falo'},
          {id: 14, cie10: 'K29', nombre: 'Gastritis y duodenitis'},
          {id: 15, cie10: 'M17', nombre: 'Gonartrosis'},
        ];
        setEstado(`Cat√°logo offline cargado (${catalogo.length} patolog√≠as principales)`);
      } else {
        setEstado(`Cat√°logo online cargado (${catalogo.length} patolog√≠as)`);
      }
      
      render();
      
    } catch(e) {
      console.error('[üîé ECICEP] Error cr√≠tico cargando cat√°logo:', e);
      setEstado('Error cargando patolog√≠as - usando modo b√°sico', 'error');
      catalogo = [
        {id: 1, cie10: 'I10', nombre: 'Hipertensi√≥n arterial esencial'},
        {id: 2, cie10: 'E11', nombre: 'Diabetes mellitus tipo 2'},
        {id: 3, cie10: 'E78', nombre: 'Dislipidemia'}
      ];
      render();
    }
  }
  
  await cargarCatalogo();
  
  async function sincronizarUsuario(runVal){
    if(!runVal) return;
    try{
      const r = await authFetch(`/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`);
      if(!r.ok) return;
      const d = await r.json();
      if(d.ok && d.patologias){
        patologiasCargadasUsuario = new Set(d.patologias.map(p => p.id));
        render();
      }
    }catch(e){
      console.warn('Error sincronizarUsuario:', e);
    }
  }
  
  // Sincronizar cuando pierde foco RUN
  document.getElementById('run').addEventListener('blur',()=> sincronizarUsuario(document.getElementById('run').value));
})();

// Funci√≥n global para sincronizar patolog√≠as del usuario (llamada desde recargaTodo)
async function sincronizarPatologiasUsuario(runVal) {
  if (!runVal) return;
  
  console.log('[üîé Patolog√≠as] Sincronizando patolog√≠as para usuario:', runVal);
  
  try {
    // Intentar m√∫ltiples endpoints para cargar patolog√≠as del usuario
    const endpoints = [
      `/api/tarjeton/patologias/usuario/${encodeURIComponent(runVal)}`,
      `/api/usuarios/${encodeURIComponent(runVal)}/patologias`,
      `/api/patologias/usuario/${encodeURIComponent(runVal)}`
    ];
    
    let patologiasUsuario = [];
    
    for (const endpoint of endpoints) {
      try {
        const r = await authFetch(endpoint);
        if (r.ok) {
          const d = await r.json();
          if (d.ok && (d.patologias || d.data)) {
            patologiasUsuario = d.patologias || d.data || [];
            console.log(`[üîé Patolog√≠as] Patolog√≠as del usuario cargadas desde ${endpoint}: ${patologiasUsuario.length}`);
            break;
          }
        }
      } catch (endpointError) {
        console.log(`[üîé Patolog√≠as] Error en endpoint ${endpoint}:`, endpointError);
        continue;
      }
    }
    
    // Actualizar el sistema de patolog√≠as si existe
    const cont = document.getElementById('contenedor-patologias');
    if (cont && patologiasUsuario.length > 0) {
      // Marcar patolog√≠as del usuario como ya existentes
      const checkboxes = cont.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        const patId = parseInt(checkbox.dataset.id);
        const tienePatologia = patologiasUsuario.some(p => p.id === patId || p.patologia_id === patId);
        
        if (tienePatologia) {
          const wrapper = checkbox.closest('.pat-row');
          if (wrapper) {
            wrapper.style.borderColor = '#0ea5e9';
            wrapper.style.background = 'rgba(14, 165, 233, 0.05)';
            
            // Agregar indicador visual
            if (!wrapper.querySelector('.ya-tiene-indicator')) {
              const indicator = document.createElement('span');
              indicator.className = 'ya-tiene-indicator';
              indicator.style.cssText = 'background: #0ea5e9; color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; margin-left: auto;';
              indicator.textContent = 'YA TIENE';
              wrapper.appendChild(indicator);
            }
          }
        }
      });
      
      // Actualizar estado
      const estadoPats = document.getElementById('estado-patologias');
      if (estadoPats) {
        estadoPats.textContent = `‚úÖ Usuario tiene ${patologiasUsuario.length} patolog√≠a${patologiasUsuario.length !== 1 ? 's' : ''} registrada${patologiasUsuario.length !== 1 ? 's' : ''}`;
        estadoPats.style.color = '#059669';
      }
    }
    
  } catch (error) {
    console.warn('[üîé Patolog√≠as] Error sincronizando patolog√≠as del usuario:', error);
    
    const estadoPats = document.getElementById('estado-patologias');
    if (estadoPats) {
      estadoPats.textContent = '‚ö†Ô∏è No se pudieron cargar las patolog√≠as del usuario';
      estadoPats.style.color = '#f59e0b';
    }
  }
}

// Deduplicar por seguridad: dejar un solo #identificacion-section
(function dedupIdent() {
  const ids = document.querySelectorAll('#identificacion-section');
  if (ids.length > 1) {
    ids.forEach((el, i) => { if (i > 0) el.parentNode.removeChild(el); });
    console.warn('[Tarjet√≥n] Secciones de Identificaci√≥n duplicadas: normalizadas a 1.');
  }
})();

// === SISTEMA DE MONITOREO DE CONECTIVIDAD ===
(function initConnectivityMonitor() {
  let ultimoEstadoConectividad = 'desconocido';
  let contadorErrores = 0;
  let ultimaPruebaExitosa = Date.now();
  
  // Funci√≥n para mostrar indicador de conectividad
  function actualizarIndicadorConectividad(estado, detalles = '') {
    const indicadores = [
      document.getElementById('estado-patologias'),
      document.querySelector('.estado-run'),
      document.querySelector('.lblEstado')
    ].filter(Boolean);
    
    if (estado !== ultimoEstadoConectividad) {
      console.log(`[üåê Conectividad] Cambio de estado: ${ultimoEstadoConectividad} ‚Üí ${estado}`, detalles);
      ultimoEstadoConectividad = estado;
    }
    
    indicadores.forEach(el => {
      if (!el) return;
      
      let icono = 'üåê';
      let color = '#6b7280';
      let mensaje = '';
      
      switch (estado) {
        case 'online':
          icono = 'üü¢';
          color = '#059669';
          mensaje = detalles || 'Conectado';
          contadorErrores = 0;
          ultimaPruebaExitosa = Date.now();
          break;
        case 'error-temporal':
          icono = 'üü°';
          color = '#f59e0b';
          mensaje = detalles || 'Conexi√≥n intermitente';
          contadorErrores++;
          break;
        case 'error-servidor':
          icono = 'üî¥';
          color = '#dc2626';
          mensaje = detalles || 'Error del servidor';
          contadorErrores++;
          break;
        case 'offline':
          icono = '‚ö´';
          color = '#6b7280';
          mensaje = detalles || 'Sin conexi√≥n';
          contadorErrores++;
          break;
      }
      
      // Agregar indicador si no existe
      let indicador = el.querySelector('.conectividad-indicator');
      if (!indicador) {
        indicador = document.createElement('span');
        indicador.className = 'conectividad-indicator';
        indicador.style.cssText = 'margin-left: 8px; font-size: 0.7rem; font-weight: normal;';
        el.appendChild(indicador);
      }
      
      indicador.textContent = `${icono} ${mensaje}`;
      indicador.style.color = color;
      
      // Agregar tiempo desde √∫ltima conexi√≥n exitosa si hay problemas
      if (estado !== 'online' && ultimaPruebaExitosa) {
        const tiempoDesconectado = Math.floor((Date.now() - ultimaPruebaExitosa) / 1000);
        if (tiempoDesconectado > 30) {
          indicador.textContent += ` (${tiempoDesconectado}s)`;
        }
      }
    });
  }
  
  // Interceptar fetch para monitorear conectividad
  const originalAuthFetch = window.authFetch;
  if (originalAuthFetch) {
    window.authFetch = async function(...args) {
      try {
        const response = await originalAuthFetch(...args);
        
        if (response.ok) {
          actualizarIndicadorConectividad('online', 'API disponible');
        } else if (response.status === 429) {
          actualizarIndicadorConectividad('error-temporal', 'Rate limit');
        } else if (response.status >= 500) {
          actualizarIndicadorConectividad('error-servidor', `Error ${response.status}`);
        } else if (response.status === 404) {
          // 404 no es necesariamente un problema de conectividad
          actualizarIndicadorConectividad('online', 'API disponible');
        }
        
        return response;
      } catch (error) {
        if (error.name === 'AbortError') {
          actualizarIndicadorConectividad('error-temporal', 'Timeout');
        } else if (error.message.includes('fetch')) {
          actualizarIndicadorConectividad('offline', 'Sin conexi√≥n');
        } else {
          actualizarIndicadorConectividad('error-temporal', 'Error de red');
        }
        throw error;
      }
    };
  }
  
  // Prueba peri√≥dica de conectividad (cada 30 segundos si hay errores)
  setInterval(async () => {
    if (contadorErrores > 0 || (Date.now() - ultimaPruebaExitosa) > 60000) {
      try {
        const response = await fetch('/api/health', { 
          method: 'HEAD',
          signal: AbortSignal.timeout(5000)
        });
        
        if (response.ok) {
          actualizarIndicadorConectividad('online', 'Conexi√≥n restaurada');
        }
      } catch (error) {
        // Mantener el estado actual, no cambiar por la prueba fallida
        if (ultimoEstadoConectividad === 'online') {
          actualizarIndicadorConectividad('error-temporal', 'Verificando conexi√≥n...');
        }
      }
    }
  }, 30000);
  
  // Estado inicial
  actualizarIndicadorConectividad('online', 'Iniciando...');
})();

// === SISTEMA DE C√ÅLCULO DIN√ÅMICO DE RIESGO ECICEP ===

// === FUNCIONES USO DE INSULINA ===
async function guardarInsulina() {
    try {
        const enTratamiento = document.querySelector('input[name="enTratamientoInsulina"]:checked');
        const fechaInsulina = document.getElementById('fechaInsulina');
        if (!enTratamiento) {
            alert('Por favor seleccione si est√° en tratamiento con insulina');
            return;
        }
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        const enTratamientoBool = enTratamiento.value === 'si';
        const data = {
            run: runField.value.trim(),
            en_tratamiento: enTratamientoBool,
            fecha_evaluacion: fechaInsulina.value || new Date().toISOString().split('T')[0]
        };
        console.log('[üíâ Insulina] Guardando:', data);
        const response = await fetch('/api/insulina-historial', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (response.ok && result.ok) {
            alert('Registro de insulina guardado exitosamente');
            cargarHistorialInsulina(runField.value.trim());
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('[üíâ Insulina] Error guardando:', error);
        alert('Error al guardar el registro de insulina: ' + error.message);
    }
}

function limpiarFormularioInsulina() {
    const form = document.getElementById('insulinaForm');
    if (form) form.reset();
    const fechaInsulina = document.getElementById('fechaInsulina');
    if (fechaInsulina) fechaInsulina.value = new Date().toISOString().split('T')[0];
    console.log('[üíâ Insulina] Formulario limpiado');
}

async function cargarHistorialInsulina(run) {
    try {
        if (!run) return;
        const response = await authFetch(`/api/insulina-historial/${run}?limit=10`);
        const result = await response.json();
        const historialDiv = document.getElementById('historialInsulina');
        const listaDiv = document.getElementById('listHistorialInsulina');
        if (!historialDiv || !listaDiv) return;
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            const historialHTML = result.historial.map(item => {
                const fecha = new Date(item.fecha_evaluacion).toLocaleDateString('es-CL');
                const estadoColor = item.en_tratamiento ? '#2563eb' : '#16a34a';
                const estadoBg = item.en_tratamiento ? '#dbeafe' : '#dcfce7';
                const estadoTexto = item.en_tratamiento ? 'EN TRATAMIENTO' : 'SIN INSULINA';
                return `<div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <div style="flex:1;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                            <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">${estadoTexto}</span>
                        </div>
                    </div>
                    <div style="font-size:0.65rem;color:#9ca3af;">${item.funcionario || 'Sistema'}</div>
                </div>`;
            }).join('');
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de insulina</div>';
        }
    } catch (error) {
        console.error('[üíâ Insulina] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialInsulina');
        if (historialDiv) historialDiv.style.display = 'none';
    }
}

async function cargarUltimaInsulina(run) {
    try {
        if (!run) return;
        const response = await authFetch(`/api/insulina-historial/${run}/ultima`);
        const result = await response.json();
        if (response.ok && result.ok && result.registro) {
            const registro = result.registro;
            const insulinaSi = document.querySelector('input[name="enTratamientoInsulina"][value="si"]');
            const insulinaNo = document.querySelector('input[name="enTratamientoInsulina"][value="no"]');
            const fechaInsulina = document.getElementById('fechaInsulina');
            if (registro.en_tratamiento) {
                if (insulinaSi) insulinaSi.checked = true;
            } else {
                if (insulinaNo) insulinaNo.checked = true;
            }
            if (fechaInsulina) fechaInsulina.value = registro.fecha_evaluacion || new Date().toISOString().split('T')[0];
        }
        await cargarHistorialInsulina(run);
    } catch (error) {
        console.error('[üíâ Insulina] Error cargando √∫ltima evaluaci√≥n:', error);
    }
}

// === FUNCIONES ATENCI√ìN POD√ìLOGA ===

// Funci√≥n para guardar atenci√≥n podol√≥gica
async function guardarPodologia() {
    try {
        // Obtener los valores del formulario
        const atencionPodologa = document.querySelector('input[name="atencionPodologa"]:checked');
        const fechaPodologia = document.getElementById('fechaPodologia');
        
        // Validar campos requeridos
        if (!atencionPodologa) {
            alert('Por favor seleccione si tiene atenci√≥n podol√≥gica vigente');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        const atencionVigenteBool = atencionPodologa.value === 'si';
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            atencion_vigente: atencionVigenteBool,
            fecha: fechaPodologia.value || new Date().toISOString().split('T')[0]
        };
        
        console.log('[ü¶∂ Podolog√≠a] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/podologia-historial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Atenci√≥n podol√≥gica guardada exitosamente');
            // Recargar historial
            cargarHistorialPodologia(runField.value.trim());
            console.log('[ü¶∂ Podolog√≠a] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[ü¶∂ Podolog√≠a] Error guardando:', error);
        alert('Error al guardar la atenci√≥n podol√≥gica: ' + error.message);
    }
}

// Funci√≥n para guardar hipoglicemia
async function guardarHipoglicemias() {
    try {
        // Obtener los valores del formulario
        const hipoglicemiaSi = document.querySelector('input[name="hipoglicemiasRecurrentes"][value="si"]');
        const hipoglicemiaNo = document.querySelector('input[name="hipoglicemiasRecurrentes"][value="no"]');
        const fechaHipoglicemia = document.getElementById('fechaHipoglicemias');
        const recurrenteCheckbox = document.querySelector('input[name="hipoglicemiasRecurrentes"]:checked');
        
        // Validar que se haya seleccionado una opci√≥n
        const tieneHipoglicemia = hipoglicemiaSi && hipoglicemiaSi.checked;
        const noTieneHipoglicemia = hipoglicemiaNo && hipoglicemiaNo.checked;
        
        if (!tieneHipoglicemia && !noTieneHipoglicemia) {
            alert('Por favor seleccione si tiene hipoglicemias o no');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Solo guardar si tiene hipoglicemias
        if (!tieneHipoglicemia) {
            alert('No se guardar√° registro ya que no tiene hipoglicemias');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            fecha: fechaHipoglicemia ? fechaHipoglicemia.value : new Date().toISOString().split('T')[0],
            recurrente: recurrenteCheckbox ? recurrenteCheckbox.checked : false
        };
        
        console.log('[ü©∏ Hipoglicemias] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/hipoglicemias-historial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Hipoglicemia guardada exitosamente');
            // Recargar historial
            cargarHistorialHipoglicemias(runField.value.trim());
            console.log('[ü©∏ Hipoglicemias] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[ü©∏ Hipoglicemias] Error guardando:', error);
        alert('Error al guardar la hipoglicemia: ' + error.message);
    }
}

// Funci√≥n para guardar amputaci√≥n
async function guardarAmputacion() {
    try {
        // Obtener los valores del formulario
        const amputacionSi = document.querySelector('input[name="tieneAmputacion"][value="si"]');
        const amputacionNo = document.querySelector('input[name="tieneAmputacion"][value="no"]');
        const fechaAmputacion = document.getElementById('fechaAmputacion');
        const tipoAmputacion = document.getElementById('tipoAmputacion');
        
        // Validar que se haya seleccionado una opci√≥n
        const tieneAmputacion = amputacionSi && amputacionSi.checked;
        const noTieneAmputacion = amputacionNo && amputacionNo.checked;
        
        if (!tieneAmputacion && !noTieneAmputacion) {
            alert('Por favor seleccione si tiene amputaci√≥n o no');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Solo guardar si tiene amputaci√≥n
        if (!tieneAmputacion) {
            alert('No se guardar√° registro ya que no tiene amputaci√≥n');
            return;
        }
        
        // Validar fecha si tiene amputaci√≥n
        if (!fechaAmputacion || !fechaAmputacion.value) {
            alert('Debe ingresar la fecha de la amputaci√≥n');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            fecha_amputacion: fechaAmputacion.value,
            tipo_amputacion: tipoAmputacion ? tipoAmputacion.value : '',
            amputacion: true
        };
        
        console.log('[ü¶µ Amputaci√≥n] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/examenes-piedm/amputacion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Amputaci√≥n guardada exitosamente');
            // Recargar historial
            cargarHistorialAmputacion(runField.value.trim());
            console.log('[ü¶µ Amputaci√≥n] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[ü¶µ Amputaci√≥n] Error guardando:', error);
        alert('Error al guardar la amputaci√≥n: ' + error.message);
    }
}

// Funci√≥n para limpiar formulario de podolog√≠a
function limpiarFormularioPodologia() {
    const form = document.getElementById('podologiaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaPodologia = document.getElementById('fechaPodologia');
    if (fechaPodologia) {
        fechaPodologia.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[ü¶∂ Podolog√≠a] Formulario limpiado');
}

// Funci√≥n para limpiar formulario de hipoglicemias
function limpiarFormularioHipoglicemias() {
    const form = document.getElementById('hipoglicemiasForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaHipoglicemias = document.getElementById('fechaHipoglicemias');
    if (fechaHipoglicemias) {
        fechaHipoglicemias.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[ü©∏ Hipoglicemias] Formulario limpiado');
}

// Funci√≥n para limpiar formulario de amputaci√≥n
function limpiarFormularioAmputacion() {
    const form = document.getElementById('amputacionForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha
    const fechaAmputacion = document.getElementById('fechaAmputacion');
    if (fechaAmputacion) {
        fechaAmputacion.value = '';
    }
    
    console.log('[ü¶µ Amputaci√≥n] Formulario limpiado');
}

// ======= FUNCIONES EVALUACI√ìN ADULTO MAYOR =======

// Funci√≥n para calcular clasificaci√≥n TUG autom√°ticamente
function calcularClasificacionTUG() {
    const tugSegundos = document.getElementById('tugSegundos');
    const tugClasificacion = document.getElementById('tugClasificacion');
    
    if (tugSegundos && tugClasificacion && tugSegundos.value) {
        const segundos = parseFloat(tugSegundos.value);
        let clasificacion = '';
        
        if (segundos <= 10) {
            clasificacion = 'Bajo riesgo de ca√≠das';
        } else if (segundos >= 11 && segundos <= 19) {
            clasificacion = 'Riesgo leve/intermedio';
        } else if (segundos >= 20) {
            clasificacion = 'Alto riesgo de ca√≠das';
        }
        
        tugClasificacion.value = clasificacion;
    }
}

// Funci√≥n para calcular clasificaci√≥n Unipodal autom√°ticamente
function calcularClasificacionUnipodal() {
    const pieDerecho = document.getElementById('unipodalPieDerecho');
    const pieIzquierdo = document.getElementById('unipodalPieIzquierdo');
    const clasificacion = document.getElementById('unipodalClasificacion');
    
    if (pieDerecho && pieIzquierdo && clasificacion) {
        const derecho = parseFloat(pieDerecho.value) || 0;
        const izquierdo = parseFloat(pieIzquierdo.value) || 0;
        
        // Usar el menor tiempo como referencia
        const menorTiempo = Math.min(derecho, izquierdo);
        let resultado = '';
        
        if (menorTiempo < 5) {
            resultado = 'Alto riesgo de ca√≠das';
        } else if (menorTiempo >= 5 && menorTiempo <= 30) {
            resultado = 'Riesgo intermedio';
        } else if (menorTiempo > 30) {
            resultado = 'Bajo riesgo de ca√≠das';
        }
        
        clasificacion.value = resultado;
    }
}

// Funci√≥n para guardar evaluaci√≥n de adulto mayor
async function guardarEvaluacionAdultoMayor() {
    try {
        // Obtener valores del formulario
        const fechaEvaluacion = document.getElementById('fechaEvaluacionAM');
        const funcionalidad = document.getElementById('funcionalidadAM');
        const tugSegundos = document.getElementById('tugSegundos');
        const tugClasificacion = document.getElementById('tugClasificacion');
        const unipodalDerecho = document.getElementById('unipodalPieDerecho');
        const unipodalIzquierdo = document.getElementById('unipodalPieIzquierdo');
        const unipodalClasificacion = document.getElementById('unipodalClasificacion');
        const observaciones = document.getElementById('observacionesAM');
        
        // Validaciones
        if (!fechaEvaluacion || !fechaEvaluacion.value) {
            alert('Debe ingresar la fecha de evaluaci√≥n');
            return;
        }
        
        if (!funcionalidad || !funcionalidad.value) {
            alert('Debe seleccionar el nivel de funcionalidad');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            usuario_id: runField.value.trim(),
            fecha_aplicacion: fechaEvaluacion.value,
            resultado: funcionalidad.value,
            tug_seg: tugSegundos && tugSegundos.value ? parseFloat(tugSegundos.value) : null,
            tug_clasificacion: tugClasificacion ? tugClasificacion.value : null,
            unipodal_seg_pie_der: unipodalDerecho && unipodalDerecho.value ? parseFloat(unipodalDerecho.value) : null,
            unipodal_seg_pie_izq: unipodalIzquierdo && unipodalIzquierdo.value ? parseFloat(unipodalIzquierdo.value) : null,
            unipodal_clasificacion: unipodalClasificacion ? unipodalClasificacion.value : null,
            observaciones: observaciones ? observaciones.value : null
        };
        
        console.log('[üë¥ Adulto Mayor] Guardando evaluaci√≥n:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/examenes/adulto_mayor', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Evaluaci√≥n de adulto mayor guardada exitosamente');
            // Recargar historial
            cargarHistorialAdultoMayor(runField.value.trim());
            console.log('[üë¥ Adulto Mayor] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[üë¥ Adulto Mayor] Error guardando:', error);
        alert('Error al guardar la evaluaci√≥n: ' + error.message);
    }
}

// Funci√≥n para limpiar formulario de adulto mayor
function limpiarFormularioAdultoMayor() {
    const form = document.getElementById('adultoMayorForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaEvaluacion = document.getElementById('fechaEvaluacionAM');
    if (fechaEvaluacion) {
        fechaEvaluacion.value = new Date().toISOString().split('T')[0];
    }
    
    // Limpiar campos calculados
    const tugClasificacion = document.getElementById('tugClasificacion');
    const unipodalClasificacion = document.getElementById('unipodalClasificacion');
    
    if (tugClasificacion) tugClasificacion.value = '';
    if (unipodalClasificacion) unipodalClasificacion.value = '';
    
    console.log('[üë¥ Adulto Mayor] Formulario limpiado');
}

// Funci√≥n para cargar historial de evaluaciones de adulto mayor
async function cargarHistorialAdultoMayor(run) {
    try {
        if (!run) return;
        
        console.log('[üë¥ Adulto Mayor] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialAdultoMayor');
        const listaDiv = document.getElementById('listHistorialAdultoMayor');
        
        if (!historialDiv || !listaDiv) {
            console.error('[üë¥ Adulto Mayor] No se encontraron elementos del historial');
            return;
        }
        
        const response = await authFetch(`/api/examenes/adulto_mayor/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üë¥ Adulto Mayor] Respuesta del historial:', result);
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(evaluacion => {
                    let fecha = 'Sin fecha';
                    if (evaluacion.fecha_aplicacion) {
                        fecha = new Date(evaluacion.fecha_aplicacion).toLocaleDateString('es-CL');
                    }
                    
                    // Mapear resultado a texto legible
                    const resultadosMap = {
                        'autovalente': 'Autovalente',
                        'autovalente_con_riesgo': 'Autovalente con Riesgo',
                        'riesgo_dependencia': 'Riesgo de Dependencia',
                        'dependencia_leve': 'Dependencia Leve',
                        'dependencia_moderada': 'Dependencia Moderada',
                        'dependencia_total': 'Dependencia Total'
                    };
                    
                    const resultado = resultadosMap[evaluacion.resultado] || evaluacion.resultado;
                    
                    // Color seg√∫n nivel de funcionalidad
                    let estadoColor = '#16a34a';
                    let estadoBg = '#dcfce7';
                    
                    if (evaluacion.resultado.includes('dependencia')) {
                        estadoColor = '#dc2626';
                        estadoBg = '#fecaca';
                    } else if (evaluacion.resultado.includes('riesgo')) {
                        estadoColor = '#f59e0b';
                        estadoBg = '#fef3c7';
                    }
                    
                    return `<div style="padding:12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            ${evaluacion.tug_seg ? `<div style="font-size:0.7rem;color:#6b7280;">TUG: ${evaluacion.tug_seg}s</div>` : ''}
                        </div>
                        <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${resultado}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay evaluaciones registradas</div>';
            }
        } else {
            console.error('[üë¥ Adulto Mayor] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üë¥ Adulto Mayor] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de atenci√≥n podol√≥gica
async function cargarHistorialPodologia(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶∂ Podolog√≠a] Cargando historial para:', run);
        
        const response = await authFetch(`/api/diabetes/podologia/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialPodologia');
        const listaDiv = document.getElementById('listHistorialPodologia');
        
        if (!historialDiv || !listaDiv) {
            console.error('[ü¶∂ Podolog√≠a] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[ü¶∂ Podolog√≠a] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(atencion => {
                const fecha = new Date(atencion.fecha).toLocaleDateString('es-CL');
                const estadoColor = atencion.atencion_vigente ? '#059669' : '#6b7280';
                const estadoBg = atencion.atencion_vigente ? '#d1fae5' : '#f3f4f6';
                const estadoTexto = atencion.atencion_vigente ? 'ATENCI√ìN VIGENTE' : 'SIN ATENCI√ìN';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${atencion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[ü¶∂ Podolog√≠a] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de atenci√≥n podol√≥gica</div>';
            console.log('[ü¶∂ Podolog√≠a] Sin historial para este usuario');
        }
    } catch (error) {
        console.error('[ü¶∂ Podolog√≠a] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialPodologia');
        if (historialDiv) {
            historialDiv.style.display = 'none';
        }
    }
}

// Funci√≥n para cargar √∫ltima atenci√≥n podol√≥gica
async function cargarUltimaPodologia(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶∂ Podolog√≠a] Cargando √∫ltima atenci√≥n para:', run);
        
        const response = await authFetch(`/api/podologia-historial/${run}/ultima`);
        const result = await response.json();
        
        if (response.ok && result.ok && result.atencion) {
            const atencion = result.atencion;
            
            // Cargar valores en el formulario
            const podologiaSi = document.querySelector('input[name="atencionPodologa"][value="si"]');
            const podologiaNo = document.querySelector('input[name="atencionPodologa"][value="no"]');
            const fechaPodologia = document.getElementById('fechaPodologia');
            
            if (atencion.atencion_vigente) {
                if (podologiaSi) podologiaSi.checked = true;
            } else {
                if (podologiaNo) podologiaNo.checked = true;
            }
            
            if (fechaPodologia) {
                fechaPodologia.value = atencion.fecha || new Date().toISOString().split('T')[0];
            }
            
            console.log('[ü¶∂ Podolog√≠a] √öltima atenci√≥n cargada:', atencion);
        } else {
            console.log('[ü¶∂ Podolog√≠a] No hay atenciones previas para este usuario');
        }
        
        // Cargar historial
        await cargarHistorialPodologia(run);
        
    } catch (error) {
        console.error('[ü¶∂ Podolog√≠a] Error cargando √∫ltima atenci√≥n:', error);
    }
}

// === FUNCIONES FONDO DE OJOS ===

// Funci√≥n para guardar fondo de ojos
async function guardarFondoOjos() {
    try {
        // Obtener los valores del formulario
        const fondoOjos = document.querySelector('input[name="fondoOjos"]:checked');
        const fechaFondoOjos = document.getElementById('fechaFondoOjos');
        
        // Validar campos requeridos
        if (!fondoOjos) {
            alert('Por favor seleccione si se realiz√≥ fondo de ojos');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        const fondoOjosBool = fondoOjos.value === 'si';
        
        // Si se realiz√≥, la fecha es obligatoria
        if (fondoOjosBool && (!fechaFondoOjos.value || fechaFondoOjos.value.trim() === '')) {
            alert('Por favor ingrese la fecha del fondo de ojos');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            fondo_de_ojos: fondoOjosBool,
            fondo_de_ojos_fecha: fondoOjosBool ? fechaFondoOjos.value : null,
            examen_fecha: new Date().toISOString().split('T')[0]
        };
        
        console.log('[üëÅÔ∏è Fondo de Ojos] Guardando:', data);
        
        // Enviar al servidor
        const response = await fetch('/api/examenes/fondo-ojos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.ok) {
            alert('Fondo de ojos guardado exitosamente');
            // Recargar historial
            cargarHistorialFondoOjos(runField.value.trim());
            console.log('[üëÅÔ∏è Fondo de Ojos] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[üëÅÔ∏è Fondo de Ojos] Error guardando:', error);
        alert('Error al guardar el fondo de ojos: ' + error.message);
    }
}

// Funci√≥n para limpiar formulario de fondo de ojos
function limpiarFormularioFondoOjos() {
    const form = document.getElementById('fondoOjosForm');
    if (form) {
        form.reset();
    }
    
    // Limpiar fecha
    const fechaFondoOjos = document.getElementById('fechaFondoOjos');
    if (fechaFondoOjos) {
        fechaFondoOjos.value = '';
    }
    
    console.log('[üëÅÔ∏è Fondo de Ojos] Formulario limpiado');
}

// Funci√≥n para cargar historial de fondo de ojos
async function cargarHistorialFondoOjos(run) {
    try {
        if (!run) return;
        
        console.log('[üëÅÔ∏è Fondo de Ojos] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialFondoOjos');
        const listaDiv = document.getElementById('listHistorialFondoOjos');
        
        if (!historialDiv || !listaDiv) {
            console.error('[üëÅÔ∏è Fondo de Ojos] No se encontraron elementos del historial');
            return;
        }
        
        const response = await authFetch(`/api/examenes/fondo_ojos/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üëÅÔ∏è Fondo de Ojos] Respuesta del historial:', result);
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(item => {
                    let fecha = 'Sin fecha';
                    if (item.fecha) {
                        fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                    }
                    
                    if (fecha === 'Invalid Date') {
                        fecha = 'Sin fecha';
                    }
                    
                    // Usar el campo 'resultado' que viene del backend
                    const resultado = item.resultado || 'SIN RESULTADO';
                    const estadoColor = resultado.toLowerCase().includes('realizado') || resultado.toLowerCase().includes('normal') ? '#059669' : '#dc2626';
                    const estadoBg = resultado.toLowerCase().includes('realizado') || resultado.toLowerCase().includes('normal') ? '#d1fae5' : '#fef2f2';
                    const estadoTexto = resultado.toUpperCase();
                    
                    return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                        <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de fondo de ojos</div>';
            }
        } else {
            console.error('[üëÅÔ∏è Fondo de Ojos] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    } catch (error) {
        console.log('[üëÅÔ∏è Fondo de Ojos] Historial no disponible');
        const historialDiv = document.getElementById('historialFondoOjos');
        if (historialDiv) {
            historialDiv.style.display = 'none';
        }
    }
}

// === Helpers para cargarUltimoFondoOjos ===
function _bySel(sel) { return document.querySelector(sel); }
function _byId(id) { return document.getElementById(id); }
function _setCheckedIf(el) { if (el) el.checked = true; }
function _setValueIf(el, v) { if (el && v != null) el.value = v; }

function _markRadioFondoSi() { _setCheckedIf(_bySel('input[name="fondoOjos"][value="SI"]')); }
function _markRadioFondoNo() { _setCheckedIf(_bySel('input[name="fondoOjos"][value="NO"]')); }

// Funci√≥n para cargar √∫ltimo fondo de ojos
async function cargarUltimoFondoOjos(run) {
    try {
        if (!run) return;
        
        console.log('[üëÅÔ∏è Fondo de Ojos] Cargando √∫ltimo examen para:', run);
        
        const response = await authFetch(`/api/examenes/fondo_ojos/${encodeURIComponent(run)}`);
        
        if (!response.ok) {
            console.log('[üëÅÔ∏è Fondo de Ojos] No hay datos disponibles (status:', response.status + ')');
            return;
        }
        
        const result = await response.json();
        
        if (response.ok && result.ok && result.data) {
            const data = result.data;
            const fechaFondoOjos = _byId('fechaFondoOjos');
            
            if (data.fondo_de_ojos === "SI") {
                _markRadioFondoSi();
                if (data.fecha) _setValueIf(fechaFondoOjos, data.fecha);
            } else if (data.fondo_de_ojos === "NO") {
                _markRadioFondoNo();
                if (data.fecha) _setValueIf(fechaFondoOjos, data.fecha);
            }
            
            console.log('[üëÅÔ∏è Fondo de Ojos] √öltimo examen cargado:', data);
        } else {
            console.log('[üëÅÔ∏è Fondo de Ojos] No hay ex√°menes previos para este usuario');
        }
        
        // Cargar historial
        await cargarHistorialFondoOjos(run);
        
    } catch (error) {
        console.log('[üëÅÔ∏è Fondo de Ojos] Funci√≥n ejecutada (sin datos disponibles)');
    }
}

// Funci√≥n para cargar historial de curaciones
async function cargarHistorialCuraciones(run) {
    try {
        if (!run) return;
        
        console.log('[ü©π Curaciones] Cargando historial para:', run);
        
        const response = await authFetch(`/api/examenes/curaciones_piedm/historial/${encodeURIComponent(run)}`);
        
        const historialDiv = document.getElementById('historialCuraciones');
        const listaDiv = document.getElementById('listHistorialCuraciones');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü©π Curaciones] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(curacion => {
                    const fecha = new Date(curacion.fecha).toLocaleDateString('es-CL');
                    const estadoColor = curacion.en_curacion ? '#059669' : '#dc2626';
                    const estadoBg = curacion.en_curacion ? '#d1fae5' : '#fef2f2';
                    const estadoTexto = curacion.en_curacion ? 'EN CURACI√ìN' : 'SIN CURACI√ìN';
                    
                    return `<div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                            <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                ${estadoTexto}
                            </span>
                        </div>
                        ${curacion.tipo ? `<div style="font-size:0.7rem;color:#6b7280;">Tipo: ${curacion.tipo}</div>` : ''}
                        ${curacion.funcionario ? `<div style="font-size:0.65rem;color:#9ca3af;margin-top:4px;">Por: ${curacion.funcionario}</div>` : ''}
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de curaciones</div>';
            }
        } else {
            console.error('[ü©π Curaciones] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    } catch (error) {
        console.error('[ü©π Curaciones] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de EKG
async function cargarHistorialEkg(run) {
    try {
        if (!run) return;
        
        console.log('[‚ö° EKG] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialEkg');
        const listaDiv = document.getElementById('listHistorialEkg');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/ekg/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[‚ö° EKG] Respuesta del historial:', result);
            
            if (result.success && result.found && result.data) {
                historialDiv.style.display = 'block';
                
                const ekg = result.data;
                let fecha = 'Sin fecha';
                if (ekg.fecha_ekg) {
                    fecha = new Date(ekg.fecha_ekg).toLocaleDateString('es-CL');
                } else if (ekg.fecha) {
                    fecha = new Date(ekg.fecha).toLocaleDateString('es-CL');
                }
                
                if (fecha === 'Invalid Date') {
                    fecha = 'Sin fecha';
                }
                
                const historialHTML = `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                    <span style="background:#e0f2fe;color:#0284c7;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">EKG</span>
                </div>`;
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de EKG</div>';
            }
        } else {
            console.error('[‚ö° EKG] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial EKG</div>';
        }
        
    } catch (error) {
        console.error('[‚ö° EKG] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialEkg');
        const listaDiv = document.getElementById('listHistorialEkg');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    }
}

// Funci√≥n para cargar historial de hipoglicemias
async function cargarHistorialHipoglicemias(run) {
    try {
        if (!run) return;
        
        console.log('[ü©∏ Hipoglicemias] Cargando historial para:', run);
        
        const response = await authFetch(`/api/diabetes/hipoglicemias/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialHipoglicemias');
        const listaDiv = document.getElementById('listHistorialHipoglicemias');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(hipoglicemia => {
                const fecha = new Date(hipoglicemia.fecha).toLocaleDateString('es-CL');
                const estadoColor = hipoglicemia.recurrente ? '#dc2626' : '#059669';
                const estadoBg = hipoglicemia.recurrente ? '#fef2f2' : '#d1fae5';
                const estadoTexto = hipoglicemia.recurrente ? 'PRESENTA' : 'NO PRESENTA';
                
                return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                    <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                </div>`;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de hipoglicemias</div>';
        }
    } catch (error) {
        console.error('[ü©∏ Hipoglicemias] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de amputaci√≥n
async function cargarHistorialAmputacion(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶ø Amputaci√≥n] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialAmputacion');
        const listaDiv = document.getElementById('listHistorialAmputacion');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/pie_dm/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü¶ø Amputaci√≥n] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                // Filtrar solo registros con amputaci√≥n
                const amputaciones = result.data.filter(item => item.amputacion === true);
                
                if (amputaciones.length > 0) {
                    historialDiv.style.display = 'block';
                    
                    const historialHTML = amputaciones.map(item => {
                        let fecha = 'Sin fecha';
                        if (item.fecha_amputacion) {
                            fecha = new Date(item.fecha_amputacion).toLocaleDateString('es-CL');
                        } else if (item.fecha_realizacion) {
                            fecha = new Date(item.fecha_realizacion).toLocaleDateString('es-CL');
                        } else if (item.fecha) {
                            fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                        }
                        
                        if (fecha === 'Invalid Date') {
                            fecha = 'Sin fecha';
                        }
                        
                        const estadoColor = '#dc2626';
                        const estadoBg = '#fef2f2';
                        const estadoTexto = 'AMPUTACI√ìN';
                        
                        return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                            <span style="background:${estadoBg};color:${estadoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${estadoTexto}</span>
                        </div>`;
                    }).join('');
                    
                    listaDiv.innerHTML = historialHTML;
                } else {
                    historialDiv.style.display = 'block';
                    listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de amputaci√≥n</div>';
                }
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de amputaci√≥n</div>';
            }
        } else {
            console.error('[ü¶ø Amputaci√≥n] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
        
    } catch (error) {
        console.error('[ü¶ø Amputaci√≥n] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar historial de pie diab√©tico
async function cargarHistorialPieDiabetico(run) {
    try {
        if (!run) return;
        
        console.log('[ü¶∂ Pie Diab√©tico] Cargando historial para:', run);
        
        const historialDiv = document.getElementById('historialPieDiabetico');
        const listaDiv = document.getElementById('listHistorialPieDiabetico');
        
        if (!historialDiv || !listaDiv) return;
        
        const response = await authFetch(`/api/examenes/pie_dm/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü¶∂ Pie Diab√©tico] Respuesta del historial:', result);
            
            if (result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                const historialHTML = result.data.map(item => {
                    // Manejar m√∫ltiples formatos de fecha
                    let fecha = 'Sin fecha';
                    if (item.fecha_realizacion) {
                        fecha = new Date(item.fecha_realizacion).toLocaleDateString('es-CL');
                    } else if (item.fecha) {
                        fecha = new Date(item.fecha).toLocaleDateString('es-CL');
                    }
                    
                    // Si la fecha es inv√°lida, usar la fecha actual como fallback
                    if (fecha === 'Invalid Date') {
                        fecha = 'Sin fecha';
                    }
                    
                    const riesgoColor = item.riesgo_nivel === 'Alto' ? '#dc2626' : item.riesgo_nivel === 'Medio' ? '#f59e0b' : '#16a34a';
                    const riesgoBg = item.riesgo_nivel === 'Alto' ? '#fecaca' : item.riesgo_nivel === 'Medio' ? '#fef3c7' : '#dcfce7';
                    const riesgo = item.riesgo_nivel || item.riesgo || 'N/A';
                    
                    return `<div style="padding:10px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:0.8rem;font-weight:600;color:#1f2937;">${fecha}</span>
                        <span style="background:${riesgoBg};color:${riesgoColor};padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">${riesgo}</span>
                    </div>`;
                }).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay evaluaciones de pie diab√©tico registradas</div>';
            }
        } else {
            console.error('[ü¶∂ Pie Diab√©tico] Error en respuesta:', response.status);
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
        
    } catch (error) {
        console.error('[ü¶∂ Pie Diab√©tico] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialPieDiabetico');
        const listaDiv = document.getElementById('listHistorialPieDiabetico');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#dc2626;font-size:0.75rem;">Error al cargar historial</div>';
        }
    }
}

// ================= FUNCIONES DE F√ÅRMACOS =================

// Funci√≥n para guardar IECA/ARA II
async function guardarIecaAra() {
    try {
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido');
            return;
        }

        const tipoIecaAra = document.getElementById('tipoIecaAra').value;
        const fechaIecaAra = document.getElementById('fechaIecaAra').value;

        if (!tipoIecaAra || !fechaIecaAra) {
            alert('Debe completar todos los campos');
            return;
        }

        const payload = {
            run: runField.value.trim(),
            tipo_medicacion: tipoIecaAra,
            en_tratamiento: tipoIecaAra !== 'NO',
            fecha: fechaIecaAra
        };

        console.log('[üíä IECA/ARA II] Guardando:', payload);

        const response = await authFetch('/api/medicacion/ieca_ara', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            console.log('[üíä IECA/ARA II] Guardado exitosamente');
            alert('IECA/ARA II guardado exitosamente');
            limpiarFormularioIecaAra();
            await cargarHistorialIecaAra(runField.value.trim());
        } else {
            console.error('[üíä IECA/ARA II] Error al guardar:', result.error);
            alert('Error al guardar: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('[üíä IECA/ARA II] Error:', error);
        alert('Error de conexi√≥n');
    }
}

// Funci√≥n para limpiar formulario IECA/ARA II
function limpiarFormularioIecaAra() {
    document.getElementById('tipoIecaAra').value = '';
    document.getElementById('fechaIecaAra').value = '';
    console.log('[üíä IECA/ARA II] Formulario limpiado');
}

// Funci√≥n para cargar historial IECA/ARA II
async function cargarHistorialIecaAra(run) {
    try {
        if (!run) return;
        
        console.log('[üíä IECA/ARA II] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/ieca_ara/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialIecaAra');
        const listaDiv = document.getElementById('listHistorialIecaAra');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(medicacion => {
                const fecha = new Date(medicacion.fecha).toLocaleDateString('es-CL');
                const estadoColor = medicacion.en_tratamiento ? '#059669' : '#dc2626';
                const estadoBg = medicacion.en_tratamiento ? '#d1fae5' : '#fef2f2';
                const estadoTexto = medicacion.en_tratamiento ? (medicacion.tipo_medicacion || 'EN TRATAMIENTO') : 'NO RECIBE';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${medicacion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de IECA/ARA II</div>';
        }
    } catch (error) {
        console.error('[üíä IECA/ARA II] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar estatinas
async function guardarEstatinas() {
    try {
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido');
            return;
        }

        const recibeEstatinas = document.querySelector('input[name="recibeEstatinas"]:checked')?.value;
        const fechaEstatinas = document.getElementById('fechaEstatinas').value;

        if (!recibeEstatinas || !fechaEstatinas) {
            alert('Debe completar todos los campos');
            return;
        }

        const payload = {
            run: runField.value.trim(),
            en_tratamiento: recibeEstatinas === 'si',
            fecha: fechaEstatinas
        };

        console.log('[üíä Estatinas] Guardando:', payload);

        const response = await authFetch('/api/medicacion/estatinas', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            console.log('[üíä Estatinas] Guardado exitosamente');
            alert('Estatinas guardado exitosamente');
            limpiarFormularioEstatinas();
            await cargarHistorialEstatinas(runField.value.trim());
        } else {
            console.error('[üíä Estatinas] Error al guardar:', result.error);
            alert('Error al guardar: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('[üíä Estatinas] Error:', error);
        alert('Error de conexi√≥n');
    }
}

// Funci√≥n para limpiar formulario estatinas
function limpiarFormularioEstatinas() {
    document.querySelectorAll('input[name="recibeEstatinas"]').forEach(radio => radio.checked = false);
    document.getElementById('fechaEstatinas').value = '';
    console.log('[üíä Estatinas] Formulario limpiado');
}

// Funci√≥n para cargar historial estatinas
async function cargarHistorialEstatinas(run) {
    try {
        if (!run) return;
        
        console.log('[üíä Estatinas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/estatinas/${run}?limit=10`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialEstatinas');
        const listaDiv = document.getElementById('listHistorialEstatinas');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(medicacion => {
                const fecha = new Date(medicacion.fecha).toLocaleDateString('es-CL');
                const estadoColor = medicacion.en_tratamiento ? '#059669' : '#dc2626';
                const estadoBg = medicacion.en_tratamiento ? '#d1fae5' : '#fef2f2';
                const estadoTexto = medicacion.en_tratamiento ? 'S√ç RECIBE' : 'NO RECIBE';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${medicacion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de estatinas</div>';
        }
    } catch (error) {
        console.error('[üíä Estatinas] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar antiagregantes
async function guardarAntiagregantes() {
    try {
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido');
            return;
        }

        const recibeAntiagregantes = document.querySelector('input[name="recibeAntiagregantes"]:checked')?.value;
        const fechaAntiagregantes = document.getElementById('fechaAntiagregantes').value;

        if (!recibeAntiagregantes || !fechaAntiagregantes) {
            alert('Debe completar todos los campos');
            return;
        }

        const payload = {
            run: runField.value.trim(),
            en_tratamiento: recibeAntiagregantes === 'si',
            fecha: fechaAntiagregantes
        };

        console.log('[üíä Antiagregantes] Guardando:', payload);

        const response = await authFetch('/api/medicacion/antiagregantes', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            console.log('[üíä Antiagregantes] Guardado exitosamente');
            alert('Antiagregante plaquetario guardado exitosamente');
            limpiarFormularioAntiagregantes();
            await cargarHistorialAntiagregantes(runField.value.trim());
        } else {
            console.error('[üíä Antiagregantes] Error al guardar:', result.error);
            alert('Error al guardar: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        console.error('[üíä Antiagregantes] Error:', error);
        alert('Error de conexi√≥n');
    }
}

// Funci√≥n para limpiar formulario antiagregantes
function limpiarFormularioAntiagregantes() {
    document.querySelectorAll('input[name="recibeAntiagregantes"]').forEach(radio => radio.checked = false);
    document.getElementById('fechaAntiagregantes').value = '';
    console.log('[üíä Antiagregantes] Formulario limpiado');
}

// Funci√≥n para cargar historial antiagregantes
async function cargarHistorialAntiagregantes(run) {
    try {
        if (!run) return;
        
        console.log('[üíä Antiagregantes] Cargando historial para:', run);
        
        const response = await authFetch(`/api/medicacion/antiagregantes/${run}?limit=10`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialAntiagregantes');
        const listaDiv = document.getElementById('listHistorialAntiagregantes');
        
        if (!historialDiv || !listaDiv) return;
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.historial.map(medicacion => {
                const fecha = new Date(medicacion.fecha).toLocaleDateString('es-CL');
                const estadoColor = medicacion.en_tratamiento ? '#059669' : '#dc2626';
                const estadoBg = medicacion.en_tratamiento ? '#d1fae5' : '#fef2f2';
                const estadoTexto = medicacion.en_tratamiento ? 'S√ç RECIBE' : 'NO RECIBE';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${medicacion.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay registros de antiagregantes</div>';
        }
    } catch (error) {
        console.error('[üíä Antiagregantes] Error cargando historial:', error);
    }
}

// ================= FUNCIONES DE COMORBILIDAD/SECUELAS =================

// Funci√≥n para analizar comorbilidades y secuelas
async function analizarComorbilidades(run) {
    try {
        if (!run) return;
        
        console.log('[üìä Comorbilidad] Analizando diagn√≥sticos para:', run);
        console.log('[üìä Comorbilidad] Timestamp:', new Date().toISOString());
        
        const estadoDiv = document.getElementById('comorbilidadEstado');
        const diagnosticosDiv = document.getElementById('diagnosticosDetectados');
        const sinDiagnosticosDiv = document.getElementById('sinDiagnosticos');
        
        if (!estadoDiv || !diagnosticosDiv || !sinDiagnosticosDiv) return;
        
        // Mostrar estado de carga
        estadoDiv.style.display = 'block';
        estadoDiv.innerHTML = '<span>üîç Analizando patolog√≠as...</span>';
        diagnosticosDiv.style.display = 'none';
        sinDiagnosticosDiv.style.display = 'none';
        
        // Obtener patolog√≠as del usuario
        const response = await authFetch(`/api/usuario/${encodeURIComponent(run)}/patologias`);
        if (!response.ok) {
            estadoDiv.innerHTML = '<span style="color:#dc2626;">‚ùå Error al obtener patolog√≠as</span>';
            return;
        }
        
        const result = await response.json();
        console.log('[üìä Comorbilidad] Respuesta API:', result);
        
        if (!result.patologias || result.patologias.length === 0) {
            estadoDiv.innerHTML = '<span style="color:#6b7280;">‚ÑπÔ∏è Sin patolog√≠as registradas</span>';
            return;
        }
        
        const patologias = result.patologias;
        console.log('[üìä Comorbilidad] Patolog√≠as encontradas:', patologias.length);
        console.log('[üìä Comorbilidad] Muestra de patolog√≠as:', patologias.slice(0, 3));
        
        // Verificar si tiene diabetes  
        const tieneDiabetes = patologias.some(p => 
            (p.nombre && /diab/i.test(p.nombre)) || 
            (p.cie10 && /E1[0-4]/i.test(p.cie10))
        );
        
        if (!tieneDiabetes) {
            estadoDiv.innerHTML = '<span style="color:#6b7280;">‚ÑπÔ∏è An√°lisis requiere diagn√≥stico de diabetes</span>';
            return;
        }
        
        let diagnosticosEncontrados = 0;
        
        // Resetear todos los diagn√≥sticos
        document.getElementById('diagnosticoTabaquismo').style.display = 'none';
        document.getElementById('diagnosticoErcLeve').style.display = 'none';
        document.getElementById('diagnosticoErcAvanzada').style.display = 'none';
        document.getElementById('diagnosticoAcv').style.display = 'none';
        document.getElementById('diagnosticoIam').style.display = 'none';
        document.getElementById('diagnosticoInsulina').style.display = 'none';
        document.getElementById('recomendacionIecaAra').style.display = 'none';
        
        // 1. Detectar Tabaquismo (F17, T65.2, Z71.6, Z72.0)
        const tieneTabaquismo = patologias.some(p => 
            (p.cie10 && (/F17/i.test(p.cie10) || 
            /T65\.2/i.test(p.cie10) || 
            /Z71\.6/i.test(p.cie10) || 
            /Z72\.0/i.test(p.cie10))) ||
            (p.nombre && /tabaco|tabaquismo|fumar|fumador/i.test(p.nombre))
        );
        
        if (tieneTabaquismo) {
            document.getElementById('diagnosticoTabaquismo').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: Tabaquismo');
        }
        
        // 2. Detectar ERC Leve-Moderada (N18.1, N18.2, N18.3, N18.9, N19)
        const tieneErcLeve = patologias.some(p => 
            (p.cie10 && (/N18\.[123]/i.test(p.cie10) || 
            /N18\.9/i.test(p.cie10) || 
            /N19/i.test(p.cie10))) ||
            (p.nombre && /renal.*cr√≥nica/i.test(p.nombre) && !/estadio.*[45]/i.test(p.nombre))
        );
        
        // 3. Detectar ERC Avanzada (N18.4, N18.5, N18.6)
        const tieneErcAvanzada = patologias.some(p => 
            (p.cie10 && /N18\.[456]/i.test(p.cie10)) ||
            (p.nombre && ((/renal.*cr√≥nica/i.test(p.nombre) && /estadio.*[45]/i.test(p.nombre)) ||
            /di√°lisis/i.test(p.nombre)))
        );
        
        if (tieneErcAvanzada) {
            document.getElementById('diagnosticoErcAvanzada').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: ERC Avanzada');
        } else if (tieneErcLeve) {
            document.getElementById('diagnosticoErcLeve').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: ERC Leve-Moderada');
        }
        
        // 4. Detectar ACV/AVE (G46, I64, I67, I68)
        const tieneAcv = patologias.some(p => 
            (p.cie10 && (/G46/i.test(p.cie10) || 
            /I64/i.test(p.cie10) || 
            /I67/i.test(p.cie10) || 
            /I68/i.test(p.cie10))) ||
            (p.nombre && /cerebrovascular|acv|ave|accidente.*cerebral|ictus/i.test(p.nombre))
        );
        
        if (tieneAcv) {
            document.getElementById('diagnosticoAcv').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: ACV/AVE');
        }
        
        // 5. Detectar IAM (I21)
        const tieneIam = patologias.some(p => 
            (p.cie10 && /I21/i.test(p.cie10)) ||
            (p.nombre && /infarto.*miocardio|iam/i.test(p.nombre))
        );
        
        if (tieneIam) {
            document.getElementById('diagnosticoIam').style.display = 'block';
            diagnosticosEncontrados++;
            console.log('[üìä Comorbilidad] Detectado: IAM');
        }
        
        // 6. Verificar uso de insulina
        await verificarUsoInsulina(run);
        
        // 7. Verificar recomendaci√≥n IECA/ARA II para ERC + DM
        if (tieneErcLeve || tieneErcAvanzada) {
            await verificarRecomendacionIecaAra(run);
        }
        
        // Mostrar resultados
        estadoDiv.style.display = 'none';
        
        if (diagnosticosEncontrados > 0) {
            diagnosticosDiv.style.display = 'block';
            sinDiagnosticosDiv.style.display = 'none';
        } else {
            diagnosticosDiv.style.display = 'none';
            sinDiagnosticosDiv.style.display = 'block';
        }
        
        console.log('[üìä Comorbilidad] An√°lisis completado. Diagn√≥sticos encontrados:', diagnosticosEncontrados);
        
    } catch (error) {
        console.error('[üìä Comorbilidad] Error en an√°lisis:', error);
        const estadoDiv = document.getElementById('comorbilidadEstado');
        if (estadoDiv) {
            estadoDiv.innerHTML = '<span style="color:#dc2626;">‚ùå Error en an√°lisis</span>';
        }
    }
}

// Funci√≥n para verificar uso de insulina
async function verificarUsoInsulina(run) {
    try {
        const response = await authFetch(`/api/insulina-historial/${run}/ultima`);
        if (response.ok) {
            const result = await response.json();
            if (result.ok && result.insulina && result.insulina.en_tratamiento) {
                document.getElementById('diagnosticoInsulina').style.display = 'block';
                console.log('[üìä Comorbilidad] Detectado: Uso de Insulina');
            }
        }
    } catch (error) {
        console.log('[üìä Comorbilidad] No se pudo verificar uso de insulina');
    }
}

// Funci√≥n para verificar recomendaci√≥n IECA/ARA II
async function verificarRecomendacionIecaAra(run) {
    try {
        const response = await authFetch(`/api/medicacion/ieca_ara/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            // Si no tiene IECA/ARA II o el √∫ltimo registro es "NO", mostrar recomendaci√≥n
            if (!result.ok || !result.historial || result.historial.length === 0 || 
                (result.historial[0] && !result.historial[0].en_tratamiento)) {
                document.getElementById('recomendacionIecaAra').style.display = 'block';
                console.log('[üìä Comorbilidad] Recomendaci√≥n: IECA/ARA II para nefroprotecci√≥n');
            }
        }
    } catch (error) {
        console.log('[üìä Comorbilidad] No se pudo verificar IECA/ARA II');
    }
}

// Funci√≥n principal para recargar todos los datos despu√©s de buscar usuario
async function recargaTodo(runVal){
    console.log('üîÑ [SISTEMA] *** RECARGA TODO EJECUTANDOSE *** para usuario:', runVal);
    
    // Verificar sesi√≥n antes de proceder
    const sesionActiva = await verificarSesion();
    if (!sesionActiva) {
        console.log('‚ö†Ô∏è [SISTEMA] Sesi√≥n no activa - algunas funciones pueden no estar disponibles');
    }
    
    // Crear un contador de errores para mostrar estado general
    window._errorCount = 0;
    window._totalCalls = 24; // Incrementado por las funciones de historial + f√°rmacos + comorbilidad
    
    // Funci√≥n helper para manejar errores silenciosamente
    const safeCall = async (fn, name) => {
        try {
            console.log(`üîÑ [${name}] Iniciando...`);
            if (typeof fn === 'function') {
                await fn(runVal);
                console.log(`‚úÖ [${name}] Completado exitosamente`);
            } else {
                window._errorCount++;
                console.error(`‚ùå [${name}] Funci√≥n no definida`);
            }
        } catch (error) {
            window._errorCount++;
            console.error(`‚ùå [${name}] Error:`, error.message, error);
        }
    };
    
    console.log('üîÑ [SISTEMA] Iniciando carga de historiales de evaluaci√≥n diabetes para:', runVal);
    
    Promise.all([
        safeCall(cargarUltimoControl, 'Control'),
        safeCall(cargarLabs, 'Laboratorio'),
        safeCall(cargarHistoricoControl, 'Hist.Control'),
        safeCall(cargarHistoricoLabs, 'Hist.Labs'),
        safeCall(cargarHistoricoAcuerdos, 'Acuerdos'),
        safeCall(sincronizarPatologiasUsuario, 'Patolog√≠as'),
        safeCall(cargarUltimoExamenPieDiabetico, 'PieDiab√©tico'),
        safeCall(cargarUltimaCuracion, 'Curaciones'),
        safeCall(cargarUltimaHipoglicemia, 'Hipoglicemias'),
        safeCall(cargarUltimaAmputacion, 'Amputaci√≥n'),
        safeCall(cargarUltimaInsulina, 'Insulina'),
        safeCall(cargarUltimaPodologia, 'Podolog√≠a'),
        safeCall(cargarUltimoFondoOjos, 'FondoOjos'),
        // Funciones de historial - ACTUALIZADAS
        safeCall(cargarHistorialPieDiabetico, 'Hist.PieDiab√©tico'),
        safeCall(cargarHistorialCuraciones, 'Hist.Curaciones'),
        safeCall(cargarHistorialEkg, 'Hist.EKG'),
        safeCall(cargarHistorialHipoglicemias, 'Hist.Hipoglicemias'),
        safeCall(cargarHistorialAmputacion, 'Hist.Amputaci√≥n'),
        safeCall(cargarHistorialInsulina, 'Hist.Insulina'),
        safeCall(cargarHistorialPodologia, 'Hist.Podolog√≠a'),
        safeCall(cargarHistorialFondoOjos, 'Hist.FondoOjos'),
        // Funciones de historial de f√°rmacos
        safeCall(cargarHistorialIecaAra, 'Hist.IECA/ARA II'),
        safeCall(cargarHistorialEstatinas, 'Hist.Estatinas'),
        safeCall(cargarHistorialAntiagregantes, 'Hist.Antiagregantes'),
        // An√°lisis de comorbilidades y secuelas
        safeCall(analizarComorbilidades, 'Comorbilidad/Secuelas')
    ]).then(() => {
        const available = window._totalCalls - window._errorCount;
        console.log(`‚úÖ [SISTEMA] *** RECARGA TODO COMPLETADA *** : ${available}/${window._totalCalls} m√≥dulos disponibles`);
        
        if (window._errorCount > 6) {
            console.log('‚ÑπÔ∏è [SISTEMA] Algunos m√≥dulos no est√°n disponibles - esto es normal');
        }
    });
}

// Hacer recargaTodo global para debugging
window.recargaTodo = recargaTodo;

// ================= FUNCI√ìN DE PRUEBA DE HISTORIALES =================

async function probarHistorialesDiabetes(run = '10.000.141-1') {
    console.log('üß™ [PRUEBA] Probando todos los historiales de diabetes para:', run);
    
    const funciones = [
        { func: cargarHistorialPieDiabetico, nombre: 'ü¶∂ Pie Diab√©tico' },
        { func: cargarHistorialCuraciones, nombre: 'ü©π Curaciones' },
        { func: cargarHistorialEkg, nombre: '‚ö° EKG' },
        { func: cargarHistorialHipoglicemias, nombre: 'ü©∏ Hipoglicemias' },
        { func: cargarHistorialAmputacion, nombre: 'ü¶ø Amputaci√≥n' },
        { func: cargarHistorialInsulina, nombre: 'üíâ Insulina' },
        { func: cargarHistorialPodologia, nombre: 'ü¶∂ Podolog√≠a' },
        { func: cargarHistorialFondoOjos, nombre: 'üëÅÔ∏è Fondo de Ojos' }
    ];
    
    for (const { func, nombre } of funciones) {
        try {
            console.log(`üß™ [PRUEBA] Probando ${nombre}...`);
            await func(run);
            console.log(`‚úÖ [PRUEBA] ${nombre} - Completado`);
        } catch (error) {
            console.error(`‚ùå [PRUEBA] ${nombre} - Error:`, error);
        }
    }
    
    console.log('üß™ [PRUEBA] Prueba de historiales completada');
}

// Disponible globalmente para pruebas manuales
window.probarHistorialesDiabetes = probarHistorialesDiabetes;

// Exponer funciones de historial globalmente para debug y uso manual
window.cargarHistorialPieDiabetico = cargarHistorialPieDiabetico;
window.cargarHistorialCuraciones = cargarHistorialCuraciones;
window.cargarHistorialHipoglicemias = cargarHistorialHipoglicemias;  
window.cargarHistorialFondoOjos = cargarHistorialFondoOjos;
window.cargarHistorialAmputacion = cargarHistorialAmputacion;
window.cargarHistorialInsulina = cargarHistorialInsulina;
window.cargarHistorialPodologia = cargarHistorialPodologia;
window.cargarHistorialEkg = cargarHistorialEkg;

// Exponer funciones de guardado globalmente para botones onclick
window.guardarPodologia = guardarPodologia;
window.guardarHipoglicemias = guardarHipoglicemias;
window.guardarAmputacion = guardarAmputacion;

// Exponer funciones de limpiar globalmente para botones onclick
window.limpiarFormularioHipoglicemias = limpiarFormularioHipoglicemias;
window.limpiarFormularioAmputacion = limpiarFormularioAmputacion;

// ======= FUNCIONES ACTIVIDAD F√çSICA =======

// Funci√≥n para guardar actividad f√≠sica
async function guardarActividadFisica() {
    try {
        // Obtener RUN del paciente
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('No hay RUN seleccionado');
            return;
        }

        // Obtener valores del formulario
        const actividadRadios = document.querySelectorAll('input[name="actividadFisica"]:checked');
        const fechaInput = document.getElementById('fechaActividadFisica');

        // Validaciones
        if (actividadRadios.length === 0) {
            alert('Por favor seleccione si realiza actividad f√≠sica');
            return;
        }

        if (!fechaInput || !fechaInput.value) {
            alert('Por favor ingrese la fecha de evaluaci√≥n');
            return;
        }

        const actividadValue = actividadRadios[0].value;
        const activo = actividadValue === 'si';

        console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Guardando:', {
            run: runField.value.trim(),
            activo: activo,
            fecha: fechaInput.value
        });

        // Preparar datos para enviar
        const data = {
            run: runField.value.trim(),
            activo: activo,
            fecha: fechaInput.value
        };

        // Enviar datos al servidor
        const response = await authFetch('/api/actividad_fisica/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            alert('Actividad f√≠sica guardada exitosamente');
            // Recargar historial
            cargarHistorialActividadFisica(runField.value.trim());
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }

    } catch (error) {
        console.error('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Error guardando:', error);
        alert('Error al guardar la actividad f√≠sica: ' + error.message);
    }
}

// Funci√≥n para limpiar formulario de actividad f√≠sica
function limpiarFormularioActividadFisica() {
    const form = document.getElementById('actividadFisicaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaInput = document.getElementById('fechaActividadFisica');
    if (fechaInput) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Formulario limpiado');
}

// Funci√≥n para cargar historial de actividad f√≠sica
async function cargarHistorialActividadFisica(run) {
    try {
        if (!run) return;
        
        console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Cargando historial para:', run);
        
        const response = await authFetch(`/api/actividad_fisica/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialActividadFisica');
        const listaDiv = document.getElementById('listHistorialActividadFisica');
        
        if (!historialDiv || !listaDiv) {
            console.error('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(registro => {
                const fecha = new Date(registro.fecha).toLocaleDateString('es-CL');
                const estadoColor = registro.activo ? '#059669' : '#dc2626';
                const estadoBg = registro.activo ? '#d1fae5' : '#fecaca';
                const estadoTexto = registro.activo ? 'S√ç ACTIVO' : 'NO ACTIVO';
                const icono = registro.activo ? 'üèÉ‚Äç‚ôÇÔ∏è' : '‚ùå';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:1rem;">${icono}</span>
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${registro.funcionario || 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#6b7280;font-size:0.8rem;">
                    <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üèÉ‚Äç‚ôÇÔ∏è</span>
                    Sin registros de actividad f√≠sica
                </div>
            `;
            console.log('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Sin historial disponible');
        }
        
    } catch (error) {
        console.error('[üèÉ‚Äç‚ôÇÔ∏è Actividad F√≠sica] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialActividadFisica');
        const listaDiv = document.getElementById('listHistorialActividadFisica');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#ef4444;font-size:0.8rem;">
                    Error al cargar el historial
                </div>
            `;
        }
    }
}

// Exponer funciones de actividad f√≠sica globalmente
window.guardarActividadFisica = guardarActividadFisica;
window.limpiarFormularioActividadFisica = limpiarFormularioActividadFisica;
window.cargarHistorialActividadFisica = cargarHistorialActividadFisica;

// ======= FUNCIONES MASAMA =======

// Funci√≥n para guardar MasAma
async function guardarMasAma() {
    try {
        // Obtener RUN del paciente
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('No hay RUN seleccionado');
            return;
        }

        // Obtener valores del formulario
        const masAmaRadios = document.querySelectorAll('input[name="masAma"]:checked');
        const fechaInput = document.getElementById('fechaMasAma');

        // Validaciones
        if (masAmaRadios.length === 0) {
            alert('Por favor seleccione el resultado de MasAma');
            return;
        }

        if (!fechaInput || !fechaInput.value) {
            alert('Por favor ingrese la fecha de evaluaci√≥n');
            return;
        }

        const masAmaValue = masAmaRadios[0].value;
        const masama = masAmaValue === 'si';

        console.log('[üîç MasAma] Guardando:', {
            usuario_id: runField.value.trim(),
            masama: masama,
            fecha: fechaInput.value
        });

        // Preparar datos para enviar
        const data = {
            usuario_id: runField.value.trim(),
            masama: masama,
            fecha: fechaInput.value
        };

        // Enviar datos al servidor
        const response = await authFetch('/api/masama/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok && result.ok) {
            alert('MasAma guardado exitosamente');
            // Recargar historial
            cargarHistorialMasAma(runField.value.trim());
            console.log('[üîç MasAma] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || 'Error desconocido');
        }

    } catch (error) {
        console.error('[üîç MasAma] Error guardando:', error);
        alert('Error al guardar MasAma: ' + error.message);
    }
}

// Funci√≥n para limpiar formulario de MasAma
function limpiarFormularioMasAma() {
    const form = document.getElementById('masAmaForm');
    if (form) {
        form.reset();
    }
    
    // Reinicializar fecha a hoy
    const fechaInput = document.getElementById('fechaMasAma');
    if (fechaInput) {
        fechaInput.value = new Date().toISOString().split('T')[0];
    }
    
    console.log('[üîç MasAma] Formulario limpiado');
}

// Funci√≥n para cargar historial de MasAma
async function cargarHistorialMasAma(run) {
    try {
        if (!run) return;
        
        console.log('[üîç MasAma] Cargando historial para:', run);
        
        const response = await authFetch(`/api/masama/historial/${encodeURIComponent(run)}`);
        const result = await response.json();
        
        const historialDiv = document.getElementById('historialMasAma');
        const listaDiv = document.getElementById('listHistorialMasAma');
        
        if (!historialDiv || !listaDiv) {
            console.error('[üîç MasAma] No se encontraron elementos del historial');
            return;
        }
        
        if (response.ok && result.ok && result.historial && result.historial.length > 0) {
            // Mostrar historial
            historialDiv.style.display = 'block';
            console.log('[üîç MasAma] Mostrando historial con', result.historial.length, 'registros');
            
            // Generar HTML del historial
            const historialHTML = result.historial.map(registro => {
                const fecha = new Date(registro.fecha).toLocaleDateString('es-CL');
                const estadoColor = registro.masama ? '#dc2626' : '#059669';
                const estadoBg = registro.masama ? '#fecaca' : '#d1fae5';
                const estadoTexto = registro.masama ? 'POSITIVO' : 'NEGATIVO';
                const icono = registro.masama ? '‚ö†Ô∏è' : '‚úÖ';
                
                return `
                    <div style="padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                                <span style="font-size:1rem;">${icono}</span>
                                <span style="font-size:0.75rem;font-weight:600;color:#1f2937;">${fecha}</span>
                                <span style="background:${estadoBg};color:${estadoColor};padding:2px 6px;border-radius:3px;font-size:0.7rem;font-weight:600;text-transform:uppercase;">
                                    ${estadoTexto}
                                </span>
                            </div>
                        </div>
                        <div style="font-size:0.65rem;color:#9ca3af;">
                            ${registro.created_at ? new Date(registro.created_at).toLocaleDateString('es-CL') : 'Sistema'}
                        </div>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
            
            console.log('[üîç MasAma] Historial cargado:', result.historial.length, 'registros');
        } else {
            // Sin historial pero mostrar mensaje
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#6b7280;font-size:0.8rem;">
                    <span style="font-size:1.5rem;display:block;margin-bottom:8px;">üîç</span>
                    Sin registros de MasAma
                </div>
            `;
            console.log('[üîç MasAma] Sin historial disponible');
        }
        
    } catch (error) {
        console.error('[üîç MasAma] Error cargando historial:', error);
        const historialDiv = document.getElementById('historialMasAma');
        const listaDiv = document.getElementById('listHistorialMasAma');
        if (historialDiv && listaDiv) {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = `
                <div style="padding:16px;text-align:center;color:#ef4444;font-size:0.8rem;">
                    Error al cargar el historial
                </div>
            `;
        }
    }
}

// Exponer funciones de MasAma globalmente
window.guardarMasAma = guardarMasAma;
window.limpiarFormularioMasAma = limpiarFormularioMasAma;
window.cargarHistorialMasAma = cargarHistorialMasAma;

// Exponer funciones de adulto mayor globalmente
window.guardarEvaluacionAdultoMayor = guardarEvaluacionAdultoMayor;
window.limpiarFormularioAdultoMayor = limpiarFormularioAdultoMayor;
window.cargarHistorialAdultoMayor = cargarHistorialAdultoMayor;

// ========================= FUNCIONES DE SCREENING ===============================

// Funci√≥n para guardar vacuna (influenza o covid)
async function guardarVacuna(tipo) {
    try {
        // Obtener valores del formulario
        const fechaInput = document.getElementById(`fecha${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        const estadoInput = document.getElementById(`estado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha de vacunaci√≥n');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar el estado de la vacuna');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        const fecha = new Date(fechaInput.value);
        const anio = fecha.getFullYear();
        
        // Preparar datos
        const data = {
            tipo: tipo,
            estado: estadoInput.value,
            fecha: fechaInput.value,
            anio: anio
        };
        
        console.log(`[üíâ Vacuna ${tipo}] Guardando:`, data);
        
        // Enviar al servidor
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(runField.value.trim())}/vacunas`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert(`Vacuna ${tipo} guardada exitosamente`);
            // Recargar historial
            cargarHistorialVacunas(runField.value.trim());
            console.log(`[üíâ Vacuna ${tipo}] Guardado exitoso:`, result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error(`[üíâ Vacuna ${tipo}] Error guardando:`, error);
        alert(`Error al guardar la vacuna ${tipo}: ` + error.message);
    }
}

// Funci√≥n para cargar historial de vacunas
async function cargarHistorialVacunas(run) {
    try {
        if (!run) return;
        
        console.log('[üíâ Vacunas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üíâ Vacunas] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialVacunas');
            const listaDiv = document.getElementById('listaHistorialVacunas');
            
            if (!historialDiv || !listaDiv) {
                console.error('[üíâ Vacunas] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(vacuna => `
                    <div style="padding:8px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;font-size:0.8rem;">
                        <div><strong>${vacuna.tipo.toUpperCase()}</strong></div>
                        <div>${vacuna.fecha ? new Date(vacuna.fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            vacuna.estado === 'SI' ? 'background:#dcfce7;color:#166534;' :
                            vacuna.estado === 'NO' ? 'background:#fef2f2;color:#dc2626;' :
                            'background:#fef3c7;color:#d97706;'
                        }">${vacuna.estado}</span></div>
                        <div style="color:#6b7280;">${vacuna.anio}</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:12px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay vacunas registradas</div>';
            }
        } else {
            console.error('[üíâ Vacunas] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üíâ Vacunas] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar PAP
async function guardarPAP() {
    try {
        const fechaInput = document.getElementById('fechaPAP');
        const estadoInput = document.getElementById('estadoPAP');
        const resultadoInput = document.getElementById('resultadoPAP');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha del PAP');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar si se realiz√≥ el PAP');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            pap_fecha: fechaInput.value,
            pap: estadoInput.value === 'true',
            pap_resultado: resultadoInput.value || null
        };
        
        console.log('[üë©‚Äç‚öïÔ∏è PAP] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/pap', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('PAP guardado exitosamente');
            // Recargar historial
            cargarHistorialPAP(runField.value.trim());
            console.log('[üë©‚Äç‚öïÔ∏è PAP] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[üë©‚Äç‚öïÔ∏è PAP] Error guardando:', error);
        alert('Error al guardar el PAP: ' + error.message);
    }
}

// Funci√≥n para cargar historial de PAP
async function cargarHistorialPAP(run) {
    try {
        if (!run) return;
        
        console.log('[üë©‚Äç‚öïÔ∏è PAP] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/pap/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üë©‚Äç‚öïÔ∏è PAP] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialPAP');
            const listaDiv = document.getElementById('listaHistorialPAP');
            
            if (!historialDiv || !listaDiv) {
                console.error('[üë©‚Äç‚öïÔ∏è PAP] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(pap => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 2fr;gap:8px;align-items:center;">
                        <div>${pap.pap_fecha ? new Date(pap.pap_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            pap.pap ? 'background:#dcfce7;color:#166534;' : 'background:#fef2f2;color:#dc2626;'
                        }">${pap.pap ? 'Realizado' : 'No realizado'}</span></div>
                        <div style="font-size:0.75rem;color:#6b7280;">${pap.pap_resultado || 'Sin resultado'}</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay PAPs registrados</div>';
            }
        } else {
            console.error('[üë©‚Äç‚öïÔ∏è PAP] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üë©‚Äç‚öïÔ∏è PAP] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar Mamograf√≠a
async function guardarMamografia() {
    try {
        const fechaInput = document.getElementById('fechaMamografia');
        const estadoInput = document.getElementById('estadoMamografia');
        const biradesInput = document.getElementById('biradsMamografia');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha de la mamograf√≠a');
            return;
        }
        
        if (!estadoInput || !estadoInput.value) {
            alert('Debe seleccionar si se realiz√≥ la mamograf√≠a');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            mamografia_fecha: fechaInput.value,
            mamografia: estadoInput.value === 'true',
            mamografia_birads: biradesInput.value ? parseInt(biradesInput.value) : null
        };
        
        console.log('[ü©ª Mamograf√≠a] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/mamografia', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('Mamograf√≠a guardada exitosamente');
            // Recargar historial
            cargarHistorialMamografia(runField.value.trim());
            console.log('[ü©ª Mamograf√≠a] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[ü©ª Mamograf√≠a] Error guardando:', error);
        alert('Error al guardar la mamograf√≠a: ' + error.message);
    }
}

// Funci√≥n para cargar historial de Mamograf√≠a
async function cargarHistorialMamografia(run) {
    try {
        if (!run) return;
        
        console.log('[ü©ª Mamograf√≠a] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/mamografia/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[ü©ª Mamograf√≠a] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialMamografia');
            const listaDiv = document.getElementById('listaHistorialMamografia');
            
            if (!historialDiv || !listaDiv) {
                console.error('[ü©ª Mamograf√≠a] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(mamografia => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;align-items:center;">
                        <div>${mamografia.mamografia_fecha ? new Date(mamografia.mamografia_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div><span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;${
                            mamografia.mamografia ? 'background:#dcfce7;color:#166534;' : 'background:#fef2f2;color:#dc2626;'
                        }">${mamografia.mamografia ? 'Realizada' : 'No realizada'}</span></div>
                        <div style="font-size:0.75rem;color:#6b7280;">${
                            mamografia.mamografia_birads !== null ? `BI-RADS ${mamografia.mamografia_birads}` : 'Sin BI-RADS'
                        }</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay mamograf√≠as registradas</div>';
            }
        } else {
            console.error('[ü©ª Mamograf√≠a] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[ü©ª Mamograf√≠a] Error cargando historial:', error);
    }
}

// Funci√≥n para guardar PSA
async function guardarPSA() {
    try {
        const fechaInput = document.getElementById('fechaPSA');
        const valorInput = document.getElementById('valorPSA');
        
        // Validaciones
        if (!fechaInput || !fechaInput.value) {
            alert('Debe ingresar la fecha del PSA');
            return;
        }
        
        if (!valorInput || !valorInput.value) {
            alert('Debe ingresar el valor del PSA');
            return;
        }
        
        // Obtener el RUN actual
        const runField = document.getElementById('run');
        if (!runField || !runField.value.trim()) {
            alert('Debe ingresar un RUN v√°lido antes de guardar');
            return;
        }
        
        // Preparar datos
        const data = {
            run: runField.value.trim(),
            examen_fecha: fechaInput.value,
            psa_valor: parseFloat(valorInput.value)
        };
        
        console.log('[üë®‚Äç‚öïÔ∏è PSA] Guardando:', data);
        
        // Enviar al servidor
        const response = await authFetch('/api/screening/psa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('PSA guardado exitosamente');
            // Recargar historial
            cargarHistorialPSA(runField.value.trim());
            console.log('[üë®‚Äç‚öïÔ∏è PSA] Guardado exitoso:', result);
        } else {
            throw new Error(result.error || result.message || 'Error desconocido');
        }
        
    } catch (error) {
        console.error('[üë®‚Äç‚öïÔ∏è PSA] Error guardando:', error);
        alert('Error al guardar el PSA: ' + error.message);
    }
}

// Funci√≥n para cargar historial de PSA
async function cargarHistorialPSA(run) {
    try {
        if (!run) return;
        
        console.log('[üë®‚Äç‚öïÔ∏è PSA] Cargando historial para:', run);
        
        const response = await authFetch(`/api/screening/psa/historial/${encodeURIComponent(run)}`);
        
        if (response.ok) {
            const result = await response.json();
            console.log('[üë®‚Äç‚öïÔ∏è PSA] Respuesta del historial:', result);
            
            const historialDiv = document.getElementById('historialPSA');
            const listaDiv = document.getElementById('listaHistorialPSA');
            
            if (!historialDiv || !listaDiv) {
                console.error('[üë®‚Äç‚öïÔ∏è PSA] No se encontraron elementos del historial');
                return;
            }
            
            if (result.success && result.data && result.data.length > 0) {
                historialDiv.style.display = 'block';
                
                // Generar HTML del historial
                const historialHTML = result.data.map(psa => `
                    <div style="padding:6px;border-bottom:1px solid #f1f5f9;display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:center;">
                        <div>${psa.examen_fecha ? new Date(psa.examen_fecha).toLocaleDateString('es-CL') : 'Sin fecha'}</div>
                        <div style="font-weight:600;color:#1e293b;">${psa.psa_valor} ng/mL</div>
                    </div>
                `).join('');
                
                listaDiv.innerHTML = historialHTML;
            } else {
                historialDiv.style.display = 'block';
                listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.75rem;">No hay PSAs registrados</div>';
            }
        } else {
            console.error('[üë®‚Äç‚öïÔ∏è PSA] Error en respuesta:', response.status);
        }
        
    } catch (error) {
        console.error('[üë®‚Äç‚öïÔ∏è PSA] Error cargando historial:', error);
    }
}

// Funci√≥n para cargar datos de screening seg√∫n el g√©nero y edad
async function cargarDatosScreening(run, sexo, edad) {
    if (!run) return;
    
    console.log('[üîç Screening] Cargando datos para:', run, 'Sexo:', sexo, 'Edad:', edad);
    
    // Mostrar/ocultar secciones seg√∫n g√©nero y edad
    const seccionPAP = document.getElementById('seccionPAP');
    const seccionMamografia = document.getElementById('seccionMamografia');
    const seccionPSA = document.getElementById('seccionPSA');
    
    if (seccionPAP && seccionMamografia && seccionPSA) {
        // PAP: Mujeres 25-64 a√±os
        if (sexo === 'F' && edad >= 25 && edad <= 64) {
            seccionPAP.style.display = 'block';
        } else {
            seccionPAP.style.display = 'none';
        }
        
        // Mamograf√≠a: Mujeres 50-69 a√±os
        if (sexo === 'F' && edad >= 50 && edad <= 69) {
            seccionMamografia.style.display = 'block';
        } else {
            seccionMamografia.style.display = 'none';
        }
        
        // PSA: Hombres ‚â•50 a√±os
        if (sexo === 'M' && edad >= 50) {
            seccionPSA.style.display = 'block';
        } else {
            seccionPSA.style.display = 'none';
        }
    }
    
    // Cargar datos de screening generales
    try {
        const response = await authFetch(`/api/screening/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.screening) {
                console.log('[üîç Screening] Datos cargados:', result.screening);
                mostrarDatosScreeningActuales(result.screening);
            }
        }
    } catch (error) {
        console.error('[ÔøΩ Medicaci√≥n - Screening] Error cargando datos generales:', error);
    }
    
    // Cargar historial de vacunas (aplica a todos)
    cargarHistorialVacunas(run);
}

// === Helpers para screening (sin efectos externos salvo DOM espec√≠fico) ===
function byId(id) {
    return document.getElementById(id);
}

function setValueIf(el, value) {
    if (el && value != null) el.value = String(value);
}

function setBooleanString(el, condition) {
    if (el) el.value = condition ? 'true' : 'false';
}

/**
 * Garantiza un √∫nico .estado-actual dentro de un contenedor por id
 * y luego asigna su innerHTML. No altera el orden de efectos de la secci√≥n.
 */
function upsertEstadoActual(containerId, html) {
    const cont = byId(containerId);
    if (!cont) return;
    let estadoDiv = cont.querySelector('.estado-actual');
    if (!estadoDiv) {
        estadoDiv = document.createElement('div');
        estadoDiv.className = 'estado-actual';
        cont.appendChild(estadoDiv);
    }
    estadoDiv.innerHTML = html;
}

// Funci√≥n para mostrar datos actuales de screening (MISMA FIRMA, MISMO ORDEN)
function mostrarDatosScreeningActuales(screening) {
    if (!screening || typeof screening !== 'object') return;

    // ===== PAP =====
    if (screening.pap) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaPAP'), screening.pap.fecha);

        const papOk = screening.pap.estado === 'al_dia' || screening.pap.estado === 'realizado';
        setBooleanString(byId('estadoPAP'), papOk);

        setValueIf(byId('resultadoPAP'), screening.pap.resultado);

        // 2) Estado en interfaz (mismo estilo y en el mismo punto de la secci√≥n)
        const papHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>√öltimo PAP:</strong> ${screening.pap.fecha} - Estado: ${screening.pap.estado}
            </div>`;
        upsertEstadoActual('seccionPAP', papHTML);
    }

    // ===== MAMOGRAF√çA =====
    if (screening.mamografia) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaMamografia'), screening.mamografia.fecha);

        const mamOk = screening.mamografia.estado === 'realizada';
        setBooleanString(byId('estadoMamografia'), mamOk);

        // birads solo si !== undefined (conserva el comportamiento exacto)
        if (screening.mamografia.birads !== undefined) {
            setValueIf(byId('biradsMamografia'), screening.mamografia.birads);
        }

        // 2) Estado en interfaz
        const mamHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>√öltima Mamograf√≠a:</strong> ${screening.mamografia.fecha} - Estado: ${screening.mamografia.estado}
            </div>`;
        upsertEstadoActual('seccionMamografia', mamHTML);
    }

    // ===== PSA =====
    if (screening.psa) {
        // 1) Asignaciones de inputs, en el mismo orden
        setValueIf(byId('fechaPSA'), screening.psa.fecha);
        setValueIf(byId('valorPSA'), screening.psa.psa_valor);
        // (No hay bloque visual/estado-actual para PSA en el c√≥digo original)
        
        // Mostrar estado en la interfaz
        const seccionPSA = document.getElementById('seccionPSA');
        if (seccionPSA) {
            const estadoHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
                <strong>√öltimo PSA:</strong> ${screening.psa.fecha} - Valor: ${screening.psa.psa_valor} ng/mL
            </div>`;
            
            let estadoDiv = seccionPSA.querySelector('.estado-actual');
            if (!estadoDiv) {
                estadoDiv = document.createElement('div');
                estadoDiv.className = 'estado-actual';
                seccionPSA.appendChild(estadoDiv);
            }
            estadoDiv.innerHTML = estadoHTML;
        }
    }
}

// Funci√≥n para cargar datos de screening en Adulto Mayor seg√∫n el g√©nero y edad
async function cargarDatosScreeningAM(run, sexo, edad) {
    if (!run) return;
    
    console.log('[üë¥ Adulto Mayor - Screening] Cargando datos para:', run, 'Sexo:', sexo, 'Edad:', edad);
    
    // Mostrar/ocultar secciones seg√∫n g√©nero y edad
    const seccionPAPAM = document.getElementById('seccionPAPAM');
    const seccionMamografiaAM = document.getElementById('seccionMamografiaAM');
    const seccionPSAAM = document.getElementById('seccionPSAAM');
    
    if (seccionPAPAM && seccionMamografiaAM && seccionPSAAM) {
        // PAP: Mujeres 25-64 a√±os
        if (sexo === 'F' && edad >= 25 && edad <= 64) {
            seccionPAPAM.style.display = 'block';
        } else {
            seccionPAPAM.style.display = 'none';
        }
        
        // Mamograf√≠a: Mujeres 50-69 a√±os
        if (sexo === 'F' && edad >= 50 && edad <= 69) {
            seccionMamografiaAM.style.display = 'block';
        } else {
            seccionMamografiaAM.style.display = 'none';
        }
        
        // PSA: Hombres ‚â•50 a√±os
        if (sexo === 'M' && edad >= 50) {
            seccionPSAAM.style.display = 'block';
        } else {
            seccionPSAAM.style.display = 'none';
        }
    }
    
    // Cargar datos de screening generales
    try {
        const response = await authFetch(`/api/screening/${encodeURIComponent(run)}`);
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.screening) {
                console.log('[üë¥ Adulto Mayor - Screening] Datos cargados:', result.screening);
                mostrarDatosScreeningActualesAM(result.screening);
            }
        }
    } catch (error) {
        console.error('[üë¥ Adulto Mayor - Screening] Error cargando datos generales:', error);
    }
    
    // Cargar historial de vacunas (aplica a todos)
    cargarHistorialVacunasAM(run);
}

// Funci√≥n para mostrar datos actuales de screening en Adulto Mayor (MISMA FIRMA, MISMO ORDEN)
function mostrarDatosScreeningActualesAM(screening) {
    if (!screening || typeof screening !== 'object') return;

    // ===== PAP =====
    if (screening.pap) {
        setValueIf(byId('fechaPAPAM'), screening.pap.fecha);

        const papOk = screening.pap.estado === 'al_dia' || screening.pap.estado === 'realizado';
        setBooleanString(byId('estadoPAPAM'), papOk);

        setValueIf(byId('resultadoPAPAM'), screening.pap.resultado);

        const papHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
            <strong>√öltimo PAP:</strong> ${screening.pap.fecha} - Estado: ${screening.pap.estado}
        </div>`;
        upsertEstadoActual('seccionPAPAM', papHTML);
    }

    // ===== MAMOGRAF√çA =====
    if (screening.mamografia) {
        setValueIf(byId('fechaMamografiaAM'), screening.mamografia.fecha);

        const mamOk = screening.mamografia.estado === 'realizada';
        setBooleanString(byId('estadoMamografiaAM'), mamOk);

        if (screening.mamografia.birads !== undefined) {
            const elBirads = byId('biradsMamografiaAM');
            if (elBirads) elBirads.value = String(screening.mamografia.birads);
        }

        const mamHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
            <strong>√öltima Mamograf√≠a:</strong> ${screening.mamografia.fecha} - Estado: ${screening.mamografia.estado}
        </div>`;
        upsertEstadoActual('seccionMamografiaAM', mamHTML);
    }

    // ===== PSA =====
    if (screening.psa) {
        setValueIf(byId('fechaPSAAM'), screening.psa.fecha);
        // Mantener sem√°ntica original: solo asigna si psa_valor es truthy (0 se omite)
        setValueIf(byId('valorPSAAM'), screening.psa.psa_valor);

        const psaHTML = `<div style="margin-top:8px;padding:6px;background:#f0f9ff;border-radius:4px;font-size:0.8rem;">
            <strong>√öltimo PSA:</strong> ${screening.psa.fecha} - Valor: ${screening.psa.psa_valor} ng/mL
        </div>`;
        upsertEstadoActual('seccionPSAAM', psaHTML);
    }
}

// Funci√≥n para cargar historial de vacunas en Adulto Mayor
async function cargarHistorialVacunasAM(run) {
    try {
        if (!run) return;
        
        console.log('[üë¥ Adulto Mayor - Vacunas] Cargando historial para:', run);
        
        const response = await authFetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`);
        if (!response.ok) {
            console.log('[üë¥ Adulto Mayor - Vacunas] No hay historial disponible');
            return;
        }
        
        const result = await response.json();
        const historialDiv = document.getElementById('historialVacunasAM');
        const listaDiv = document.getElementById('listaHistorialVacunasAM');
        
        if (!historialDiv || !listaDiv) return;
        
        if (result && result.length > 0) {
            historialDiv.style.display = 'block';
            
            const historialHTML = result.map(vacuna => {
                const fecha = new Date(vacuna.fecha).toLocaleDateString('es-CL');
                const tipoDisplay = vacuna.tipo === 'influenza' ? 'Influenza' : 'COVID';
                const estadoColor = vacuna.estado === 'SI' ? '#10b981' : vacuna.estado === 'NO' ? '#ef4444' : '#f59e0b';
                const estadoBg = vacuna.estado === 'SI' ? '#d1fae5' : vacuna.estado === 'NO' ? '#fef2f2' : '#fef3c7';
                
                return `
                    <div style="padding:6px 8px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">
                                <span style="font-size:0.7rem;font-weight:600;color:#1f2937;">${tipoDisplay}</span>
                                <span style="font-size:0.65rem;color:#6b7280;">${fecha}</span>
                            </div>
                        </div>
                        <span style="background:${estadoBg};color:${estadoColor};padding:1px 4px;border-radius:2px;font-size:0.6rem;font-weight:600;">
                            ${vacuna.estado}
                        </span>
                    </div>
                `;
            }).join('');
            
            listaDiv.innerHTML = historialHTML;
        } else {
            historialDiv.style.display = 'block';
            listaDiv.innerHTML = '<div style="padding:8px;text-align:center;color:#9ca3af;font-size:0.7rem;">No hay historial de vacunas</div>';
        }
    } catch (error) {
        console.error('[üë¥ Adulto Mayor - Vacunas] Error cargando historial:', error);
    }
}

// Exponer funciones globalmente
window.guardarVacuna = guardarVacuna;
window.cargarHistorialVacunas = cargarHistorialVacunas;
window.guardarPAP = guardarPAP;
window.cargarHistorialPAP = cargarHistorialPAP;
window.guardarMamografia = guardarMamografia;
window.cargarHistorialMamografia = cargarHistorialMamografia;
window.guardarPSA = guardarPSA;
window.cargarHistorialPSA = cargarHistorialPSA;
window.cargarDatosScreening = cargarDatosScreening;
window.cargarDatosScreeningAM = cargarDatosScreeningAM;
window.cargarHistorialVacunasAM = cargarHistorialVacunasAM;
window.calcularClasificacionTUG = calcularClasificacionTUG;
window.calcularClasificacionUnipodal = calcularClasificacionUnipodal;

})(); // Cierre de la funci√≥n an√≥nima principal

// ========== FUNCIONES DE DEBUG GLOBALES ==========

// Funci√≥n de diagn√≥stico mejorada
window.diagnosticarHistoriales = function(run = '10.000.141-1') {
    console.log('üîç [DIAGN√ìSTICO] Iniciando diagn√≥stico de historiales...');
    
    const elementos = [
        'historialPieDiabetico',
        'historialCuraciones', 
        'historialEkg',
        'historialHipoglicemias',
        'historialAmputacion',
        'historialInsulina',
        'historialPodologia',
        'historialFondoOjos'
    ];
    
    console.log('üìã [DOM] Verificando elementos del DOM...');
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        console.log(`${elemento ? '‚úÖ' : '‚ùå'} ${id}: ${elemento ? 'Encontrado' : 'NO ENCONTRADO'}`);
    });
    
    console.log('üîç [DIAGN√ìSTICO] Diagn√≥stico completado - Revisa los resultados arriba');
};

// Funci√≥n simplificada para probar endpoints directamente
window.probarEndpoint = async function(endpoint, nombre) {
    console.log(`üß™ [ENDPOINT] Probando ${nombre}: ${endpoint}`);
    try {
        const response = await fetch(endpoint, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token') || 'NO_TOKEN'}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log(`‚úÖ [${nombre}] Status: ${response.status}`, data);
        } else {
            console.log(`‚ùå [${nombre}] Status: ${response.status}`, await response.text());
        }
    } catch (error) {
        console.error(`‚ùå [${nombre}] Error:`, error);
    }
};

// Funci√≥n para probar todos los endpoints de diabetes
window.probarEndpointsDiabetes = async function(run = '10.000.141-1') {
    console.log('üöÄ [ENDPOINTS] Probando todos los endpoints de diabetes...');
    
    const endpoints = [
        [`/api/examenes/pie_dm/historial/${run}`, 'Pie Diab√©tico'],
        [`/api/examenes/curaciones_piedm/historial/${run}`, 'Curaciones'],
        [`/api/examenes/ekg/${run}`, 'EKG'],
        [`/api/diabetes/hipoglicemias/historial/${run}`, 'Hipoglicemias'],
        [`/api/examenes/fondo_ojos/historial/${run}`, 'Fondo de Ojos'],
        [`/api/diabetes/podologia/historial/${run}`, 'Podolog√≠a']
    ];
    
    for (const [endpoint, nombre] of endpoints) {
        await probarEndpoint(`http://127.0.0.1:8000${endpoint}`, nombre);
        await new Promise(resolve => setTimeout(resolve, 500)); // Pausa de 500ms entre requests
    }
    
    console.log('‚úÖ [ENDPOINTS] Prueba de endpoints completada');
};

// Inicializar fechas al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar fecha de actividad f√≠sica
    const fechaActividadFisica = document.getElementById('fechaActividadFisica');
    if (fechaActividadFisica) {
        fechaActividadFisica.value = new Date().toISOString().split('T')[0];
    }
    
    // Inicializar fecha de MasAma
    const fechaMasAma = document.getElementById('fechaMasAma');
    if (fechaMasAma) {
        fechaMasAma.value = new Date().toISOString().split('T')[0];
    }

    // ============ CARGA AUTOM√ÅTICA DESDE P√ÅGINA DETALLE ============
    // Nota: Este c√≥digo se movi√≥ al final del script para asegurar que todas las funciones est√©n disponibles

    // ---- FIX MANDRAKEBOT: Timing correcto del DOM ----
    console.log('ü§ñ Inicializando MandrakeBot con DOM listo...');
    
    // 1) Referencias √∫nicas
    const btnMandrakeBot = document.getElementById('btn-mandrake-bot');
    const chatOverlay     = document.getElementById('mandrake-chat-overlay');
    const chatClose       = document.getElementById('mandrake-chat-close');
    const chatMessages    = document.getElementById('mandrake-chat-messages');
    const chatInput       = document.getElementById('mandrake-chat-input');
    const chatSend        = document.getElementById('mandrake-chat-send');

    if (!btnMandrakeBot || !chatOverlay) {
        console.error('‚ùå MandrakeBot button/overlay not found; verifica IDs y orden de carga');
        console.log('Elementos encontrados:', {
            btnMandrakeBot: !!btnMandrakeBot,
            chatOverlay: !!chatOverlay,
            chatClose: !!chatClose,
            chatMessages: !!chatMessages,
            chatInput: !!chatInput,
            chatSend: !!chatSend
        });
        return;
    }

    console.log('‚úÖ MandrakeBot elementos encontrados correctamente');

    // 2) Abrir/cerrar
    const open = () => {
        console.log('ü§ñ Abriendo MandrakeBot...');
        chatOverlay.style.display = 'flex';
        chatInput?.focus();
        
        // Mensaje de bienvenida si es la primera vez
        if (chatMessages && chatMessages.children.length === 1) {
            const welcomeMsg = document.createElement('div');
            welcomeMsg.className = 'mandrake-message system';
            welcomeMsg.innerHTML = '¬°Hola! üëã<br><br>Escribe "<strong>demo</strong>" para ver autocompletado o haz consultas m√©dicas.<br><br>Ejemplos:<br>‚Ä¢ "Paciente diab√©tico de 60 a√±os"<br>‚Ä¢ "S√≠ntomas de hipertensi√≥n"<br>‚Ä¢ "demo" para datos de prueba';
            chatMessages.appendChild(welcomeMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    };
    
    const close = () => {
        console.log('ü§ñ Cerrando MandrakeBot...');
        chatOverlay.style.display = 'none';
    };

    // 3) Listeners (una sola vez)
    btnMandrakeBot.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('ü§ñ Click en bot√≥n MandrakeBot');
        open();
    });
    
    chatClose?.addEventListener('click', close);
    
    chatOverlay.addEventListener('click', (e) => { 
        if (e.target === chatOverlay) close(); 
    });
    
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
            e.preventDefault(); 
            (chatOverlay.style.display === 'flex' ? close() : open());
        }
        if (e.key === 'Escape' && chatOverlay.style.display === 'flex') close();
    });

    // 4) Enviar mensaje mejorado con autollenado inmediato
    
    // Funci√≥n auxiliar para mostrar alertas visuales
    function showAlert(message, type) {
        // Crear elemento de alerta
        const alert = document.createElement('div');
        alert.className = `mandrake-alert mandrake-alert-${type}`;
        alert.innerHTML = message;
        
        // Estilos din√°micos
        const alertStyles = {
            success: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;',
            warning: 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;',
            error: 'background: #f8d7da; color: #721c24; border: 1px solid #f1b0b7;'
        };
        
        alert.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            ${alertStyles[type] || alertStyles.success}
        `;
        
        // Agregar animaci√≥n CSS si no existe
        if (!document.getElementById('mandrake-alert-styles')) {
            const style = document.createElement('style');
            style.id = 'mandrake-alert-styles';
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(alert);
        
        // Auto-remover despu√©s de 4 segundos
        setTimeout(() => {
            alert.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        }, 4000);
        
        // Permitir cerrar con click
        alert.addEventListener('click', () => {
            alert.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        });
    }
    
    // Funci√≥n para minimizar MandrakeBot
    function minimizeMandrakeBot() {
        const chatOverlay = document.getElementById('mandrake-chat-overlay');
        const chatNotification = document.createElement('div');
        
        if (!chatOverlay) return;
        
        // Ocultar el chat overlay
        chatOverlay.style.display = 'none';
        
        // Mostrar notificaci√≥n de minimizaci√≥n
        chatNotification.className = 'mandrake-minimize-notification';
        chatNotification.innerHTML = `
            <div style="
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.2);
                z-index: 1001;
                font-size: 14px;
                animation: slideInUp 0.3s ease-out;
                cursor: pointer;
                user-select: none;
            " onclick="this.remove()">
                ü§ñ MandrakeBot minimizado. Revisa los campos destacados.
                <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                    Click para cerrar esta notificaci√≥n
                </div>
            </div>
        `;
        
        // Agregar animaci√≥n CSS si no existe
        if (!document.getElementById('mandrake-minimize-styles')) {
            const style = document.createElement('style');
            style.id = 'mandrake-minimize-styles';
            style.textContent = `
                @keyframes slideInUp {
                    from { transform: translateY(100%); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        document.body.appendChild(chatNotification);
        
        // Auto-remover la notificaci√≥n despu√©s de 8 segundos
        setTimeout(() => {
            if (chatNotification.parentNode) {
                chatNotification.style.transition = 'all 0.3s ease-out';
                chatNotification.style.transform = 'translateY(100%)';
                chatNotification.style.opacity = '0';
                setTimeout(() => {
                    if (chatNotification.parentNode) {
                        chatNotification.parentNode.removeChild(chatNotification);
                    }
                }, 300);
            }
        }, 8000);
        
        console.log('ü§ñ MandrakeBot minimizado - usuario puede revisar formulario');
    }
    
    chatSend?.addEventListener('click', sendMandrakeMessage);
    chatInput?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { 
            e.preventDefault(); 
            sendMandrakeMessage(); 
        }
    });

    // 5) Respaldo global (si mantienes onclick="openMandrakeBot()")
    window.openMandrakeBot = open;
    
    console.log('ü§ñ MandrakeBot inicializado correctamente!');
});

</script>

<!-- Chat MandrakeBot -->
<div id="mandrake-chat-overlay">
  <div id="mandrake-chat-container">
    <div id="mandrake-chat-header">
      <div>
        <h3 style="margin:0;font-size:18px;font-weight:600;">ü§ñ MandrakeBot</h3>
        <p style="margin:0;font-size:12px;opacity:0.9;">Asistente m√©dico inteligente</p>
      </div>
      <button id="mandrake-chat-close">&times;</button>
    </div>
    
    <div id="mandrake-chat-messages">
      <div class="mandrake-message bot">
        ¬°Hola! Soy MandrakeBot, tu asistente m√©dico inteligente. üëã<br><br>
        Puedo ayudarte con:
        <ul style="margin:8px 0;padding-left:20px;">
          <li>Autocompletar formularios m√©dicos</li>
          <li>Sugerir diagn√≥sticos basados en s√≠ntomas</li>
          <li>Validar datos cl√≠nicos</li>
          <li>Interpretar resultados de ex√°menes</li>
          <li>Recordar protocolos m√©dicos</li>
        </ul>
        ¬øEn qu√© puedo ayudarte hoy?
      </div>
    </div>
    
    <div id="mandrake-chat-input-container">
      <input type="text" id="mandrake-chat-input" placeholder="Escribe tu consulta m√©dica..." maxlength="500">
      <button id="mandrake-chat-send">Enviar</button>
    </div>
  </div>
</div>

<!-- Mandrake API disponible globalmente -->
<script>
// ---- MANDRAKE API: Sistema de autocompletado de formularios ----
(function () {
  const FIELD_MAP = {
    run:              ['#run'],
    nombre:           ['#nombre'],
    sexo:             ['#sexo'],
    fecha_nacimiento: ['#fecha_nacimiento'],
    edad:             ['#edad'],
    direccion:        ['#direccion'],
    telefono:         ['#telefono'],
    nivel_educacion:  ['#nivel_educacion'],
    origen_etnico:    ['#origen_etnico'],
    sector_id:        ['#sector_id'],
    categoria:        ['#categoria']
  };

  const _pad2 = n => String(n).padStart(2, '0');
  const _toISO = v => {
    if (!v) return '';
    const s = String(v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})$/);
    if (!m) return s;
    return `${m[3]}-${_pad2(m[2])}-${_pad2(m[1])}`;
  };
  
  const _calcEdad = iso => {
    try {
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(+d)) return '';
      const t = new Date();
      let e = t.getFullYear() - d.getFullYear();
      const m = t.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && t.getDate() < d.getDate())) e--;
      return e >= 0 ? String(e) : '';
    } catch { return ''; }
  };

  function setValue(selArr, value) {
    selArr.forEach(sel => {
      const el = document.querySelector(sel);
      if (!el) return;
      if (el.type === 'date') {
        const iso = _toISO(value);
        if (iso) el.value = iso;
      } else if (el.tagName === 'SELECT') {
        el.value = value ?? '';
      } else if (el.hasAttribute('readonly')) {
        el.value = value ?? '';
      } else {
        el.value = value ?? '';
      }
    });
  }

  // Sistema de destacado de campos modificados
  const highlightedFields = new Set();
  const highlightedTabs = new Set();

  function highlightField(selector) {
    const el = (typeof selector==='string')? document.querySelector(selector) : selector;
    if(!el) return;
    el.classList.add('mandrake-modified');
    if(typeof selector==='string') highlightedFields.add(selector);
    const tab = el.closest('[data-panel]');
    if(tab){ const tabName = tab.getAttribute('data-panel'); highlightTab(tabName); }
  }
  function highlightTab(tabName) {
    const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
    if (tabButton && !tabButton.classList.contains('mandrake-tab-modified')) {
      tabButton.classList.add('mandrake-tab-modified');
      highlightedTabs.add(tabName);
      
      // Agregar indicador visual en la pesta√±a
      if (!tabButton.querySelector('.mandrake-indicator')) {
        const indicator = document.createElement('span');
        indicator.className = 'mandrake-indicator';
        indicator.innerHTML = '‚óè';
        indicator.title = 'Modificado por MandrakeBot';
        tabButton.appendChild(indicator);
      }
    }
  }

  function clearHighlights() {
    // Limpiar campos
    highlightedFields.forEach(selector => {
      const el = document.querySelector(selector);
      if (el) el.classList.remove('mandrake-modified');
    });
    highlightedFields.clear();

    // Limpiar pesta√±as
    highlightedTabs.forEach(tabName => {
      const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
      if (tabButton) {
        tabButton.classList.remove('mandrake-tab-modified');
        const indicator = tabButton.querySelector('.mandrake-indicator');
        if (indicator) indicator.remove();
      }
    });
    highlightedTabs.clear();
  }


  // API p√∫blica
  window.Mandrake = {
    apply(raw, { autoEdad = true } = {}) {
      const data = typeof raw === 'string' ? JSON.parse(raw) : (raw || {});
      if (data.fecha_nacimiento) {
        data.fecha_nacimiento = _toISO(data.fecha_nacimiento);
      }
      if (autoEdad && !data.edad && data.fecha_nacimiento) {
        data.edad = _calcEdad(data.fecha_nacimiento);
      }
      
      // Contar campos que realmente van a cambiar
      let fieldsToModify = 0;
      Object.entries(FIELD_MAP).forEach(([k, sels]) => {
        if (data[k] !== undefined && data[k] !== null && data[k] !== '') {
          sels.forEach(sel => {
            const el = document.querySelector(sel);
            if (el && (el.value || '') !== (data[k] || '')) {
              fieldsToModify++;
            }
          });
        }
      });

      // Aplicar cambios
      Object.entries(FIELD_MAP).forEach(([k, sels]) => {
        if (data[k] !== undefined && data[k] !== null && data[k] !== '') {
          setValue(sels, data[k]);
        }
      });

      // Mostrar notificaci√≥n de revisi√≥n si se modificaron campos
      if (fieldsToModify > 0) {
        showReviewNotification(fieldsToModify);
      }
      
      // Actualizar resumen visual
      const spRun = document.querySelector('[data-f="run"]');
      if (spRun && data.run) spRun.textContent = data.run;
      const spNom = document.querySelector('[data-f="nombre_completo"]');
      if (spNom && (data.nombre || data.nombre_completo)) {
        spNom.textContent = data.nombre || data.nombre_completo;
      }
      const spFn = document.querySelector('[data-f="fecha_nacimiento"]');
      if (spFn && data.fecha_nacimiento) spFn.textContent = data.fecha_nacimiento;
      const spEdad = document.querySelector('[data-f="edad"]');
      if (spEdad && data.edad) spEdad.textContent = data.edad;
      const spSexo = document.querySelector('[data-f="sexo"]');
      if (spSexo && data.sexo) spSexo.textContent = data.sexo;

      console.log('ü§ñ Mandrake.apply() ejecutado:', data);
      return data;
    }
  };
  
  window.MandrakeApply = (data) => window.Mandrake.apply(data);
})();
</script>

<!-- MandrakePaste: Parser de textos cl√≠nicos -->
<script>
(function(){
  // ============ Helpers de normalizaci√≥n ============
  const _pad2 = n => String(n).padStart(2,'0');
  const _toISO = (s) => {
    if(!s) return '';
    s = String(s).trim();
    // YYYY-MM-DD
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // dd-mm-aaaa | dd/mm/aaaa | dd.mm.aaaa
    const m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{2,4})$/);
    if(!m) return '';
    const y = m[3].length===2 ? ('20'+m[3]) : m[3];
    return `${y}-${_pad2(m[2])}-${_pad2(m[1])}`;
  };
  const _sanitizeRun = s => (s||'').replace(/[.\s-]/g,'').toUpperCase();
  const _onlyDigits = s => (s||'').replace(/[^\d]/g,'');
  const _num = (s) => {
    if(s==null) return null;
    // aceptar 95.5 o 95,5
    const t = String(s).replace(/\./g,'').replace(',', '.'); // "1.234,5" -> "1234.5"
    const v = parseFloat(t);
    return Number.isFinite(v)? v : null;
  };
  const _calcEdad = (y, m, d) => {
    try{
      const dob = new Date(Number(y), Number(m)-1, Number(d));
      if(isNaN(+dob)) return null;
      const t = new Date();
      let e = t.getFullYear()-dob.getFullYear();
      const mm = t.getMonth()-dob.getMonth();
      if(mm<0 || (mm===0 && t.getDate()<dob.getDate())) e--;
      return e;
    }catch{ return null; }
  };
  
  // ============ Extractores (regex robustos para espa√±ol cl√≠nico) ============
  const RX = {
    rut: /R\.?U\.?T\.?\s*:\s*([0-9.\-Kk]+)/i,
    nombre: /Nombre\s*:\s*(?:\([^)]+\)\s*)?([A-Za-z√Å√â√ç√ì√ö√ë√ú√§√´√Ø√∂√º√°√©√≠√≥√∫√±√º'¬¥` ]{3,})/i,
    edad_det: /Edad\s*:\s*(\d{1,3})\s*a√±os(?:\s*(\d{1,2})\s*mes(?:es)?)?(?:\s*(\d{1,2})\s*d[i√≠]as?)?/i,
    fecha_hora: /Fecha\s*y\s*Hora\s*de\s*atenci[o√≥]n\s*:\s*([0-9\/\-.]{8,10})\s+([0-9:]{4,5})/i,
    pa: /Presi[o√≥]n\s*Arterial\s*\(mmHg\)\s*:\s*(\d{2,3})\s*\/\s*(\d{2,3})/i,
    pulso: /Pulso.*?:\s*(\d{2,3})\b/i,
    hgt: /Hemoglucotest.*?:\s*([0-9.,]+)\b/i,
    peso: /Peso\s*\(Kg\)\s*:\s*([0-9.,]+)\b/i,
    talla: /Talla\s*\(cm\)\s*:\s*([0-9.,]+)\b/i,
    imc: /I\.?M\.?C\.?(?:\s*\*?)?\s*:\s*([0-9.,]+)\b/i,
    cc: /Circunferencia\s*de\s*Cintura.*?:\s*([0-9.,]+)\b/i,
    hba1c: /Hb?a1c?\s*[:=]?\s*([0-9.,]+)\b/i,
    ldl: /\bLDL\s*[:=]?\s*([0-9.,]+)\b/i,
    glicemia: /\bglic(?:emia)?\s*[:=]?\s*([0-9.,]+)\b/i,
  hdl: /\bHDL(?:-C)?\s*[:=]?\s*([0-9.,]+)\b/i,
  col_total: /\b(?:Col(?:esterol)?\s*(?:Total|Tot)|C\/T)\b[^0-9]{0,5}([0-9.,]+)\b/i,
  trigliceridos: /\b(?:Triglic[√©e]ridos?|TAG)\b[^0-9]{0,5}([0-9.,]+)\b/i,
  creatinina: /\bCreatin(?:ina|emia|inemia)\b[^0-9]{0,5}([0-9.,]+)\b/i,
  vfg: /\b(?:VFG|TFG|eGFR)\b[^0-9]{0,5}([0-9.,]+)\b/i,
  rac: /\bRAC\b[^0-9]{0,5}([0-9.,]+)\b/i,
  microalbuminuria: /\bMicro(?:albuminuria|alb)\b[^0-9]{0,5}([0-9.,]+)\b/i,
  tsh: /\bTSH\b[^0-9]{0,5}([0-9.,]+)\b/i,
  fecha_examen: /(?:Fecha\s*(?:de\s*)?(?:examen|toma|muestra)|Examen\s*fecha)\s*[:=]?\s*([0-9\/.\-]{8,10})/i,
    // bloque diagn√≥sticos: desde "Diagn√≥stico(s)" hasta "Actividades/Indicaciones/Examen/Atenciones"
    diagBlock: /Diagn[o√≥]sticos?[\s\S]{0,6}\n([\s\S]*?)(?:\n\s*(Actividades|Indicaciones|Examen|Atenciones|Formularios)\b)/i
  };

  // Conversi√≥n aproximada de mmol/L a mg/dL para algunos analitos comunes
  function _convertIfMmol(label, value, originalText){
    // Detecta si en el contexto cercano aparece 'mmol' y no 'mg'
    if(value==null) return value;
    const txt = originalText || '';
    // ventana: 40 caracteres alrededor del n√∫mero (simple)
    // si el bloque contiene 'mmol' y no contiene 'mg/dl' asumimos mmol/L
    const mmol = /mmol/i.test(txt);
    const hasMg = /mg\s*\/\s*d?l/i.test(txt);
    if(!mmol || hasMg) return value; // ya est√° en mg/dL o no hay marca mmol
    // factores (mg/dL = mmol/L * factor)
    const FACTORS = { glicemia:18, glic:18, glucosa:18, hba1c:1, ldl:38.67, hdl:38.67, col:38.67, col_total:38.67, trigliceridos:88.5, tag:88.5 };
    const f = FACTORS[label];
    if(!f) return value; // sin factor definido
    return +(value * f).toFixed(1);
  }

  function _cleanNombre(n){
    if(!n) return '';
    // remueve alias iniciales: "(Patricio) Patricio Pino Reyes" -> "Patricio Pino Reyes"
    return String(n).replace(/^\([^)]*\)\s*/,'').replace(/\s{2,}/g,' ').trim();
  }

  function _pick(text, rx, idx=1){ const m = text.match(rx); return m? m[idx] : null; }

  function parseClinicalFreeText(text){
    const t = String(text||'');
    const out = {};

    // RUN
    const rutRaw = _pick(t, RX.rut);
    if(rutRaw){
      const compact = _sanitizeRun(rutRaw);
      if(/^\d{7,9}[0-9K]$/i.test(compact)){
        out.run = compact.slice(0, -1) + '-' + compact.slice(-1);
      }else{
        // si no calza, al menos guarda compactado sin gui√≥n
        out.run = compact;
      }
    }

    // Nombre
    const nombre = _cleanNombre(_pick(t, RX.nombre));
    if(nombre) out.nombre = nombre;

    // Edad
    const em = t.match(RX.edad_det);
    if(em){
      const a = _num(em[1]), me = _num(em[2]), d = _num(em[3]);
      // si no hay fecha de nacimiento, al menos setear edad num√©rica
      if(a!=null) out.edad = String(a);
    }

    // Fecha/Hora de atenci√≥n
    const fhm = t.match(RX.fecha_hora);
    if(fhm){
      const fISO = _toISO(fhm[1]);
      if(fISO) out.fecha_atencion = fISO;
      out.hora_atencion = fhm[2];
    }

    // Signos vitales / antropometr√≠a
    const pa = t.match(RX.pa);
    if(pa){ out.presion_sistolica = _num(pa[1]); out.presion_diastolica = _num(pa[2]); }
    const pulso = _pick(t, RX.pulso);
    if(pulso) out.pulso = _num(pulso);
    const hgt = _pick(t, RX.hgt);
    if(hgt) out.hgt = _num(hgt);
    const peso = _pick(t, RX.peso);
    if(peso!=null) out.peso = _num(peso);
    const talla = _pick(t, RX.talla);
    if(talla!=null) out.talla = _num(talla);
    const imc = _pick(t, RX.imc);
    if(imc!=null) out.imc = _num(imc);
    const cc = _pick(t, RX.cc);
    if(cc!=null) out.cc = _num(cc);

    // Labs ampliados
  const hba = _pick(t, RX.hba1c); if(hba!=null) out.hba1c = _convertIfMmol('hba1c', _num(hba), hba);
  const ldl = _pick(t, RX.ldl); if(ldl!=null) out.ldl = _convertIfMmol('ldl', _num(ldl), ldl);
  const glic = _pick(t, RX.glicemia); if(glic!=null) out.glicemia = _convertIfMmol('glicemia', _num(glic), glic);
  const hdl = _pick(t, RX.hdl); if(hdl!=null) out.hdl = _convertIfMmol('hdl', _num(hdl), hdl);
  const col = _pick(t, RX.col_total); if(col!=null) out.col = _convertIfMmol('col', _num(col), col);
  const tag = _pick(t, RX.trigliceridos); if(tag!=null) out.tag = _convertIfMmol('tag', _num(tag), tag);
    const crea = _pick(t, RX.creatinina); if(crea!=null) out.creatinemia = _num(crea);
    const vfg = _pick(t, RX.vfg); if(vfg!=null) out.vfg = _num(vfg);
    const rac = _pick(t, RX.rac); if(rac!=null) out.rac = _num(rac);
    const micro = _pick(t, RX.microalbuminuria); if(micro!=null) out.microalbuminuria_val = _num(micro);
    const tsh = _pick(t, RX.tsh); if(tsh!=null) out.tsh = _num(tsh);
    const fex = _pick(t, RX.fecha_examen); if(fex){ const isoF = _toISO(fex); if(isoF) out.examen_fecha = isoF; }
    if(!out.examen_fecha && out.fecha_atencion){ out.examen_fecha = out.fecha_atencion; }

    // Construir labs[] si hay al menos un valor
    const labFields = ['glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'];
    const hasLab = labFields.some(k=> out[k]!=null);
    if(hasLab){
      const labObj = { examen_fecha: out.examen_fecha };
      labFields.forEach(k=>{ if(out[k]!=null) labObj[k]=out[k]; });
      out.labs = [labObj];
    }

    // Diagn√≥sticos (lista textual)
    const db = t.match(RX.diagBlock);
    if(db){
      const raw = db[1] || '';
      // cada l√≠nea con diagn√≥stico; limpiamos par√©ntesis "(Confirmada)"
      const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const dx = [];
      for(const ln of lines){
        const s = ln.replace(/\(Confirmada|Repetida|Nueva|Sospecha|AUGE\)/ig,'')
                    .replace(/\s{2,}/g,' ')
                    .replace(/^[\-\d\.\)]\s*/,'')
                    .trim();
        if(s) dx.push(s);
      }
      if(dx.length) out.diagnosticos = dx;
    }

    // Campos del front que probablemente quieres llenar HOY
    // (ajusta a tus IDs/FIELD_MAP reales)
    const payload = {
      run: out.run,
      nombre: out.nombre,
      // fecha_nacimiento: (no viene en el texto; la edad ya va calculada arriba si aparece DOB)
      edad: (out.edad!=null ? String(out.edad) : undefined),

      // vitals / control
      presion_sistolica: out.presion_sistolica,
      presion_diastolica: out.presion_diastolica,
      hgt: out.hgt,
      peso: out.peso,
      talla: out.talla != null ? (out.talla / 100).toFixed(2) : undefined, // convertir cm a metros
      imc: out.imc,
      cc: out.cc,
      hba1c: out.hba1c,
      ldl: out.ldl,
      glicemia: out.glicemia,
  hdl: out.hdl,
  col: out.col,
  tag: out.tag,
  creatinemia: out.creatinemia,
  vfg: out.vfg,
  rac: out.rac,
  microalbuminuria_val: out.microalbuminuria_val,
  tsh: out.tsh,
  examen_fecha: out.examen_fecha,

  labs: out.labs,

      // metadatos √∫tiles
      fecha_atencion: out.fecha_atencion,
      hora_atencion: out.hora_atencion,
      diagnosticos: out.diagnosticos
    };

    // elimina undefined para no contaminar la aplicaci√≥n
    Object.keys(payload).forEach(k=> (payload[k]===undefined || payload[k]===null) && delete payload[k]);
    return payload;
  }

  // ============ Integraci√≥n con Mandrake ============
  // Requiere que Mandrake.apply ya est√© cargado en la p√°gina
  async function pegarYAutollenarDesdeTexto(texto, {overwrite=false} = {}){
    const parsed = parseClinicalFreeText(texto);
    // Mapea a tus inputs. Si ya definiste FIELD_MAP, esto bastar√°:
    if(window.Mandrake && typeof window.Mandrake.apply === 'function'){
      window.Mandrake.apply(parsed, {overwrite});
    }
    return parsed;
  }

  // ============ API global ============
  window.MandrakePaste = {
    parse: parseClinicalFreeText,
    applyFromText: pegarYAutollenarDesdeTexto
  };

  // (opcional) bot√≥n que pide pegar desde el portapapeles
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btn-pegar-texto-clinico');
    if(btn && navigator.clipboard){
      btn.addEventListener('click', async ()=>{
        try{
          const txt = await navigator.clipboard.readText();
          const out = await pegarYAutollenarDesdeTexto(txt, {overwrite:false});
          console.log('[MandrakePaste] parsed:', out);
          alert('Texto pegado y aplicado al formulario ‚úÖ');
        }catch(e){
          console.warn('No se pudo leer portapapeles:', e);
          alert('No pude leer el portapapeles. Pega el texto manualmente en un cuadro y te lo proceso.');
        }
      });
    }
  });
})();
</script>

<!-- Parser duplicado removido: unificado al MandrakePaste principal -->

<script>
// === Bot√≥n Guardar Todo (control + labs + acuerdos si hay datos) ===
(()=>{
  const btn = document.getElementById('btn-save-all');
  if(!btn) return;
  btn.addEventListener('click', async ()=>{
    if(btn.disabled) return;
    const original = btn.innerHTML;
    const run = document.getElementById('run')?.value?.trim();
    if(!run){ alert('RUN vac√≠o. Busca un usuario primero.'); return; }
    btn.disabled = true; btn.innerHTML = 'üíæ Guardando...';
    const tareas = [];
    // --- Control ---
    try {
      const f = document.getElementById('form-control-nuevo');
      if(f){
        const fd = new FormData(f);
        const payloadControl = { run };
        ['fecha','peso','talla','presion_sistolica','presion_diastolica','cc','hgt','hba1c'].forEach(k=>{
          const v = fd.get(k); if(v!==null && v!=='') payloadControl[k]=v;
        });
        // S√≥lo enviar si hay al menos 1 valor num√©rico
        if(Object.keys(payloadControl).some(k=>k!=='run' && k!=='fecha')){
          tareas.push(fetch('/api/control/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadControl)}));
        }
      }
    } catch(e){ console.warn('Control no guardado', e); }
    // --- Labs ---
    try {
      const lf = document.getElementById('form-lab-nuevo');
      if(lf){
        const fd = new FormData(lf);
        const payloadLab = { run };
        ['examen_fecha','glicemia','hba1c','ldl','hdl','col','tag','creatinemia','vfg','rac','microalbuminuria_val','tsh'].forEach(k=>{
          const v = fd.get(k); if(v!==null && v!=='') payloadLab[k]=v;
        });
        if(Object.keys(payloadLab).some(k=>k!=='run' && (k!=='examen_fecha'))){
          tareas.push(fetch('/api/labs/fast-save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadLab)}));
        }
      }
    } catch(e){ console.warn('Labs no guardado', e); }
    // --- Acuerdos (si hay un texto nuevo sin enviar) ---
    try {
      const fa = document.getElementById('form-acuerdo-nuevo');
      if(fa){
        const fd = new FormData(fa);
        const acuerdos = fd.get('acuerdos')?.trim();
        const cumplimiento = fd.get('cumplimiento')?.trim();
        if(acuerdos && cumplimiento){
          const payloadA = {
            usuario_id: run,
            acuerdos,
            cumplimiento,
            observaciones: fd.get('observaciones')?.trim() || null,
            funcionario: fd.get('funcionario')?.trim() || null,
            fecha_creacion: fd.get('fecha') || null
          };
          tareas.push(fetch('/api/acuerdos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payloadA)}));
        }
      }
    } catch(e){ console.warn('Acuerdos no guardado', e); }

    // --- Guardar categor√≠a / riesgo (estado programa) ---
    try {
      // Determinar categor√≠a a guardar
      let categoriaGuardar = null;
      const prog = window.programaSeleccionado || 'ECICEP';
      if(prog === 'CARDIO') {
        categoriaGuardar = 'CARDIO';
      } else {
        const elCalc = document.getElementById('riesgo-calculado');
        const elAct = document.getElementById('riesgo-actual');
        const txtCalc = (elCalc?.textContent || '').trim();
        const txtAct = (elAct?.textContent || '').trim();
        if(txtCalc && txtCalc !== '‚Äî') categoriaGuardar = txtCalc;
        else if(txtAct && txtAct !== '‚Äî') categoriaGuardar = txtAct;
      }
      if(categoriaGuardar && categoriaGuardar !== '‚Äî'){
        tareas.push(fetch(`/api/usuarios/${encodeURIComponent(run)}/categoria`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ categoria: categoriaGuardar })
        }));
        // Guardar tambi√©n programa_modo para auditor√≠a
        tareas.push(fetch(`/api/usuarios/${encodeURIComponent(run)}/programa_modo`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ programa: (window.programaSeleccionado||'ECICEP') })
        }));
        // Preparar mensaje confirmaci√≥n luego
        window.__ultimaCategoriaGuardada = categoriaGuardar;
      }
    } catch(e){ console.warn('Categor√≠a/riesgo no guardado', e); }

    let ok=0, fail=0;
    try {
      const results = await Promise.allSettled(tareas);
      for(const r of results){
        if(r.status==='fulfilled'){
          try { const jr = await r.value.json(); if(jr.ok) ok++; else fail++; }
          catch{ fail++; }
        } else { fail++; }
      }
    } catch(e){ console.error('Error batch', e); }
    if(ok && window.__ultimaCategoriaGuardada){
      btn.innerHTML = `‚úÖ Categor√≠a ${window.__ultimaCategoriaGuardada} guardada (${ok})`;
    } else {
      btn.innerHTML = ok? `‚úÖ Guardado (${ok})` : (fail? '‚ö†Ô∏è Revise errores' : 'üíæ Nada que guardar');
    }
    setTimeout(()=>{ btn.innerHTML = original; btn.disabled=false; }, 2500);
  });
})();

// ===== FUNCIONES DE DIAGNOSTICO GLOBALES =====
console.log('üîß [INIT] Cargando funciones de diagn√≥stico...');

window.testFecha = function() {
  console.log('üîß [TEST-FECHA] Probando formateo de fecha...');
  const fecha = 'Thu, 12 Mar 1964 00:00:00 GMT';
  console.log('üîß [TEST-FECHA] Fecha original:', fecha);
  const fechaFormateada = new Date(fecha).toLocaleDateString('es-CL');
  console.log('üîß [TEST-FECHA] Fecha formateada:', fechaFormateada);
  return fechaFormateada;
};

window.testPoblarDirect = function() {
  console.log('üîß [TEST-DIRECT] Test directo de poblar...');
  try {
    console.log('üîß [TEST-DIRECT] Verificando funci√≥n poblar:', typeof window.poblar);
    
    const testData = {
      usuario: {
        run: "10.000.141-1",
        nombre: "Patricio Pino Reyes", 
        fecha_nacimiento: "Thu, 12 Mar 1964 00:00:00 GMT",
        sexo: "masculino",
        sector_nombre: "VERDE"
      },
      edad: 61
    };
    
    if (typeof poblar === 'function') {
      console.log('üîß [TEST-DIRECT] Ejecutando poblar...');
      poblar(testData);
      console.log('üîß [TEST-DIRECT] Poblar ejecutado correctamente');
    } else {
      console.error('üîß [TEST-DIRECT] Funci√≥n poblar no encontrada');
    }
  } catch(error) {
    console.error('üîß [TEST-DIRECT] Error:', error);
  }
  return 'Test completado';
};

console.log('üîß [INIT] Funciones de diagn√≥stico cargadas');

// ============ FUNCI√ìN DE DIAGN√ìSTICO PARA PROBLEMAS DE B√öSQUEDA ============
window.diagnosticarBusqueda = function() {
    console.log('üîç [DIAGNOSTICO] Iniciando diagn√≥stico de b√∫squeda...');
    
    // Verificar elementos del DOM
    const elementos = {
        'runSearch (#run-search)': document.getElementById('run-search'),
        'btnBuscar (#btn-buscar-run)': document.getElementById('btn-buscar-run'),
        'runForm (#run)': document.getElementById('run'),
        'helpSearch (#run-search-help)': document.getElementById('run-search-help')
    };
    
    console.log('üîç [DIAGNOSTICO] Elementos del DOM:');
    Object.entries(elementos).forEach(([nombre, elemento]) => {
        console.log(`  ${nombre}: ${elemento ? '‚úÖ Encontrado' : '‚ùå No encontrado'}`);
        if (elemento && elemento.value !== undefined) {
            console.log(`    Valor actual: "${elemento.value}"`);
        }
    });
    
    // Verificar funciones
    const funciones = {
        'buscarRun': typeof buscarRun,
        'trimRun': typeof trimRun,
        'validarRunCl': typeof validarRunCl,
        'marcarValidez': typeof marcarValidez
    };
    
    console.log('üîç [DIAGNOSTICO] Funciones disponibles:');
    Object.entries(funciones).forEach(([nombre, tipo]) => {
        console.log(`  ${nombre}: ${tipo === 'function' ? '‚úÖ Disponible' : `‚ùå ${tipo}`}`);
    });
    
    // Probar validaci√≥n con RUN de ejemplo
    if (typeof validarRunCl === 'function') {
        const runTest = '12.345.678-9';
        console.log(`üîç [DIAGNOSTICO] Probando validaci√≥n con RUN: ${runTest}`);
        console.log(`  Resultado: ${validarRunCl(runTest)}`);
    }
    
    // Verificar event listeners
    const btnBuscar = document.getElementById('btn-buscar-run');
    if (btnBuscar) {
        console.log('üîç [DIAGNOSTICO] Analizando bot√≥n de b√∫squeda...');
        console.log(`  Texto del bot√≥n: "${btnBuscar.textContent.trim()}"`);
        console.log(`  Disabled: ${btnBuscar.disabled}`);
        console.log(`  Visible: ${btnBuscar.offsetWidth > 0 && btnBuscar.offsetHeight > 0}`);
        console.log(`  Event listeners: ${btnBuscar.onclick ? 'onclick definido' : 'sin onclick'}`);
    }
    
    // Probar funci√≥n buscarRun directamente
    if (typeof buscarRun === 'function') {
        console.log('üîç [DIAGNOSTICO] Funci√≥n buscarRun disponible');
        
        // Llenar campo con RUN de prueba
        const runInput = document.getElementById('run-search');
        if (runInput) {
            const runPrueba = '12.345.678-9';
            runInput.value = runPrueba;
            console.log(`üîç [DIAGNOSTICO] Campo llenado con RUN de prueba: ${runPrueba}`);
            
            console.log('üîç [DIAGNOSTICO] Ejecutando buscarRun() directamente...');
            try {
                buscarRun();
                console.log('  ‚úÖ buscarRun() ejecutado sin errores sincronos');
            } catch (error) {
                console.error('  ‚ùå Error ejecutando buscarRun():', error);
            }
        }
    } else {
        console.error('üîç [DIAGNOSTICO] ‚ùå Funci√≥n buscarRun NO est√° disponible');
    }
    
    return 'Diagn√≥stico completado - revisa los logs arriba';
};

// ============ CARGA AUTOM√ÅTICA DESDE P√ÅGINA DETALLE ============
// Ejecutar despu√©s de que todas las funciones est√©n definidas
function cargarUsuarioDesdeURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const runParam = urlParams.get('run');
    const autoload = urlParams.get('autoload');
    
    if (runParam && autoload === 'true') {
        console.log('üè• [AUTOLOAD] Detectado RUN desde p√°gina detalle:', runParam);
        
        // Limpiar par√°metros de la URL sin recargar la p√°gina
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
        
        // Cargar el RUN en el campo de b√∫squeda
        const runInput = document.getElementById('run');
        const buscarRunInput = document.getElementById('buscar-run');
        
        if (runInput) {
            runInput.value = runParam;
            console.log('‚úÖ [AUTOLOAD] RUN cargado en campo principal:', runParam);
        }
        
        if (buscarRunInput) {
            buscarRunInput.value = runParam;
            console.log('‚úÖ [AUTOLOAD] RUN cargado en campo de b√∫squeda:', runParam);
        }
        
        // Verificar si hay datos en sessionStorage
        const runKey = runParam.replace(/[.-]/g, '');
        const datosGuardados = sessionStorage.getItem('usuario_precarga_' + runKey);
        
        if (datosGuardados) {
            try {
                const datos = JSON.parse(datosGuardados);
                console.log('üìã [AUTOLOAD] Datos de usuario encontrados en sessionStorage:', datos);
                
                // Mostrar mensaje de bienvenida
                if (datos.nombre) {
                    const mensaje = `üè• Cargando datos de ${datos.nombre} (${runParam})...`;
                    console.log(mensaje);
                    
                    // Si hay un elemento de estado, mostrar el mensaje
                    const estadoElementos = [
                        document.querySelector('.estado-run'),
                        document.getElementById('estado-busqueda'),
                        document.querySelector('.lblEstado')
                    ].filter(Boolean);
                    
                    estadoElementos.forEach(el => {
                        if (el) {
                            el.textContent = mensaje;
                            el.style.color = '#059669';
                        }
                    });
                }
                
                // Limpiar datos temporales
                sessionStorage.removeItem('usuario_precarga_' + runKey);
            } catch (error) {
                console.warn('‚ö†Ô∏è [AUTOLOAD] Error procesando datos guardados:', error);
            }
        }
        
        // Buscar autom√°ticamente despu√©s de un breve delay
        setTimeout(() => {
            if (typeof buscarRun === 'function') {
                console.log('üîç [AUTOLOAD] Iniciando b√∫squeda autom√°tica...');
                buscarRun();
            } else {
                console.error('‚ùå [AUTOLOAD] Funci√≥n buscarRun no disponible');
            }
        }, 200);
        
        return true;
    }
    
    return false;
}

// Ejecutar la carga autom√°tica al final del script
setTimeout(() => {
    const cargaAutomatica = cargarUsuarioDesdeURL();
    
    if (cargaAutomatica) {
        console.log('‚úÖ [AUTOLOAD] Proceso de carga autom√°tica iniciado');
    } else {
        console.log('‚ÑπÔ∏è [AUTOLOAD] No se detectaron par√°metros de carga autom√°tica');
    }
}, 100);

</script>

{% endblock %}
