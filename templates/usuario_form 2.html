<!DOCTYPE html>
<html lang="es">
<head>
    <title>Formulario de Usuario - ECICEP</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" href="/static/favicon.ico" />

        <script id="server-state" type="application/json">{
            "has_error": {% if mensaje and ('Error' in mensaje or 'error' in mensaje or 'violates' in mensaje or 'constraint' in mensaje or 'null value' in mensaje or 'obligatorio' in mensaje or 'v√°lido' in mensaje or 'inv√°lido' in mensaje) %}true{% else %}false{% endif %},
            "mensaje": {% if mensaje %}{{ mensaje|tojson }}{% else %}null{% endif %},
            "ok": {{ 'true' if request.args.get('ok') else 'false' }}
        }</script>
        <script>
        // Debug mode - cambiar a false en producci√≥n
        const DEBUG_MODE = false;
        const debugLog = DEBUG_MODE ? console.log : () => {};
        const debugWarn = DEBUG_MODE ? console.warn : () => {};
        
        // ======= DECLARACIONES TEMPRANAS DE FUNCIONES CR√çTICAS =======
        // Declarar funciones como variables para evitar errores de hoisting
        let cargarTratamientoInsulinaDebounced = function(run, delay = 300) {
            console.log('‚ö†Ô∏è [TEMP] cargarTratamientoInsulinaDebounced llamada antes de definici√≥n completa');
        };
        
        let cargarAlertasVigenciaFlotante = function() {
            console.log('‚ö†Ô∏è [TEMP] cargarAlertasVigenciaFlotante llamada antes de definici√≥n completa');
        };
        
        // Asignar al window inmediatamente
        window.cargarTratamientoInsulinaDebounced = cargarTratamientoInsulinaDebounced;
        window.cargarAlertasVigenciaFlotante = cargarAlertasVigenciaFlotante;
        // ======= FIN DECLARACIONES TEMPRANAS =======
        
        (function(){
            
            // Cache de elementos DOM para optimizar consultas repetitivas
            const DOMCache = {
                elements: {},
                get(id) {
                    if (!this.elements[id]) {
                        this.elements[id] = document.getElementById(id);
                    }
                    return this.elements[id];
                },
                clear() {
                    this.elements = {};
                }
            };
            
            let state = { has_error:false, mensaje:null, ok:false };
            try {
                const el = DOMCache.get ? DOMCache.get('server-state') : document.getElementById('server-state');
                if (el) state = JSON.parse(el.textContent || '{}');
            } catch(e) { debugWarn('No se pudo parsear server-state:', e); }
            window.HAS_ERROR = !!state.has_error;
            window.MENSAJE_SERVER = state.mensaje || null;
            debugLog('üö® HAS_ERROR establecido a:', window.HAS_ERROR, 'Mensaje:', window.MENSAJE_SERVER);
            if (window.HAS_ERROR && window.MENSAJE_SERVER) {
                setTimeout(function(){
                    try {
                        alert('‚ö†Ô∏è Se encontr√≥ un problema:\n\n' + String(window.MENSAJE_SERVER) + '\n\n‚úÖ ¬°Tranquilo! Los datos del formulario se han preservado.\nüí° Corrige el error y vuelve a intentar.');
                    } catch(_) {}
                }, 500);
            }
        })();
        </script>
        
    <style>
        /* ===== VARIABLES CSS MODERNAS ===== */
        :root {
            /* Paleta principal */
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-200: #bfdbfe;
            --primary-300: #93c5fd;
            --primary-400: #60a5fa;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;

            /* Escala de grises */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;

            /* Colores sem√°nticos */
            --success-50: #ecfdf5;
            --success-500: #10b981;
            --success-600: #059669;

            --warning-50: #fffbeb;
            --warning-100: #fef3c7;
            --warning-500: #f59e0b;
            --warning-600: #d97706;

            --error-50: #fef2f2;
            --error-500: #ef4444;
            --error-600: #dc2626;

            --info-50: #eff6ff;
            --info-500: #3b82f6;
            --info-600: #2563eb;

            --danger-50: #fef2f2;
            --danger-500: #ef4444;
            
            /* Sombras modernas */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-base: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

            /* Espaciado consistente */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 0.75rem;
            --spacing-lg: 1rem;
            --spacing-xl: 1.25rem;
            --spacing-2xl: 1.5rem;
            --spacing-3xl: 2rem;
            --spacing-4xl: 2.5rem;

            /* Tipograf√≠a */
            --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace;

            --text-xs: 12px;
            --text-sm: 14px;
            --text-base: 16px;
            --text-lg: 18px;
            --text-xl: 20px;
            --text-2xl: 24px;
            --text-3xl: 30px;
            
            /* Transiciones */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Bordes */
            --border-color: var(--gray-200);
            --border-color-dark: var(--gray-300);
            --border-radius-sm: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;

            /* Z-index scale */
            --z-dropdown: 1000;
            --z-modal: 1050;
            --z-tooltip: 1100;
            
            /* Variables legacy para compatibilidad */
            --brand: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            --line: var(--border-color);
        }

        /* ===== RESET Y BASE MODERNO ===== */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html {
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        body {
            margin: 0;
            font-family: var(--font-sans);
            font-size: var(--text-sm);
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-800);
            background-color: var(--gray-50);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== CONTENEDOR PRINCIPAL MODERNO ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
            min-height: 100vh;
        }

        /* ===== ENCABEZADO PROFESIONAL ===== */
        .header {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            color: white;
            padding: var(--spacing-2xl) 0;
            margin: calc(-1 * var(--spacing-lg)) calc(-1 * var(--spacing-lg)) var(--spacing-xl) calc(-1 * var(--spacing-lg));
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="8" height="8" patternUnits="userSpaceOnUse"><path d="M 8 0 L 0 0 0 8" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }

        .header h1, .header h2 {
            margin: 0 0 var(--spacing-sm) 0;
            font-size: clamp(var(--text-xl), 4vw, var(--text-3xl));
            font-weight: 700;
            letter-spacing: -0.025em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header .subtitle {
            font-size: var(--text-base);
            opacity: 0.9;
            margin: 0;
            font-weight: 400;
        }

        /* ===== CARDS Y SECCIONES MODERNAS ===== */
        .card, fieldset {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: var(--border-width) solid var(--border-color);
            overflow: hidden;
            transition: var(--transition-base);
            margin-bottom: var(--spacing-lg);
        }

        .card:hover, fieldset:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        fieldset {
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, #ffffff 0%, var(--gray-50) 100%);
        }

        fieldset legend {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--gray-800);
            padding: 0 var(--spacing-md);
            margin-left: -var(--spacing-md);
        }

        .card-header {
            padding: var(--spacing-lg);
            border-bottom: var(--border-width) solid var(--border-color);
            background: linear-gradient(to right, var(--gray-50), var(--gray-100));
        }

        .card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-body {
            padding: var(--spacing-lg);
        }

        /* ===== GRID Y LAYOUT MODERNO ===== */
        .form-grid, .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        /* ===== FORMULARIOS MODERNOS ===== */
        label {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: var(--spacing-xs);
            letter-spacing: 0.025em;
        }

        input[type="text"], 
        input[type="date"], 
        input[type="number"], 
        input[type="email"],
        input[type="tel"],
        select, 
        textarea {
            width: 100%;
            padding: 12px var(--spacing-md);
            border: 1.5px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-family: inherit;
            color: var(--gray-800);
            background-color: white;
            transition: var(--transition-base);
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgb(59 130 246 / 0.1);
        }

        input:hover:not(:focus), select:hover:not(:focus), textarea:hover:not(:focus) {
            border-color: var(--gray-300);
        }

        input[readonly] {
            background-color: var(--gray-50);
            color: var(--gray-500);
            cursor: not-allowed;
        }

        /* ===== BOTONES MODERNOS ===== */
        .btn, .button, button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: 12px var(--spacing-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: var(--transition-base);
            text-decoration: none;
            white-space: nowrap;
            min-height: 44px;
            box-shadow: var(--shadow-xs);
        }

        .btn-primary, .button {
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
        }

        .btn-primary:hover, .button:hover {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .button.success {
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
        }

        .button.success:hover {
            background: linear-gradient(135deg, var(--success-600) 0%, #047857 100%);
        }

        /* ===== NAVEGACI√ìN Y TABS MODERNAS ===== */
        .tabs, .nav-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: var(--spacing-lg);
            background: white;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            overflow: hidden;
            box-shadow: var(--shadow-xs);
        }

        .tab, .nav-link {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            color: var(--gray-500);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-base);
            border-bottom: 3px solid transparent;
            font-size: var(--text-sm);
        }

        .tab:hover, .nav-link:hover {
            background: var(--gray-50);
            color: var(--gray-700);
        }

        .tab.active, .nav-link.active {
            color: var(--primary-600);
            border-bottom-color: var(--primary-600);
            background: var(--primary-50);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== MENSAJES Y ALERTAS MODERNAS ===== */
        .mensaje {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            font-weight: 500;
            border-left: 4px solid;
        }

        .mensaje.exito {
            background: var(--success-50);
            color: var(--success-600);
            border-left-color: var(--success-500);
        }

        .mensaje.error {
            background: var(--danger-50);
            color: var(--danger-600);
            border-left-color: var(--danger-500);
        }

        /* ===== EFECTOS VISUALES MODERNOS ===== */
        .zoom-hover {
            transition: var(--transition-base);
            cursor: pointer;
        }

        .zoom-hover:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        /* Efectos suaves para elementos interactivos */
        input:not([type="submit"]):not([type="button"]):not([type="reset"]):hover,
        select:hover,
        textarea:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-sm);
            z-index: 1;
            position: relative;
        }

        .btn:hover, button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* ===== RESPONSIVE MODERNO ===== */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }
            
            .header {
                margin: calc(-1 * var(--spacing-md)) calc(-1 * var(--spacing-md)) var(--spacing-lg) calc(-1 * var(--spacing-md));
                padding: var(--spacing-xl) 0;
            }
            
            .form-grid, .grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .card-body, fieldset {
                padding: var(--spacing-md);
            }
            
            .tabs, .nav-tabs {
                flex-wrap: wrap;
            }
            
            .tab, .nav-link {
                padding: var(--spacing-sm) var(--spacing-md);
                font-size: var(--text-xs);
            }
        }

        @media (max-width: 480px) {
            .header h1, .header h2 {
                font-size: var(--text-xl);
            }
            
            .btn, .button, button {
                padding: 10px var(--spacing-md);
                font-size: var(--text-xs);
            }
        }

        /* ===== NAVEGACI√ìN Y BREADCRUMBS ===== */
        .breadcrumb {
            display: flex;
            align-items: center;
            font-size: var(--text-sm);
        }

        .breadcrumb-link {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--gray-600);
            text-decoration: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            transition: var(--transition-base);
            font-weight: 500;
        }

        .breadcrumb-link:hover {
            color: var(--primary-600);
            background: var(--primary-50);
        }

        /* ===== HEADER MODERNO ===== */
        .header-modern {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
            color: white;
            margin: 0 calc(-1 * var(--spacing-lg)) var(--spacing-xl) calc(-1 * var(--spacing-lg));
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .header-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="header-grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23header-grid)"/></svg>');
        }

        .header-layout {
            display: grid;
            grid-template-columns: 200px 1fr 200px;
            align-items: center;
            gap: var(--spacing-lg);
            position: relative;
            z-index: 1;
            min-height: 200px;
            padding: var(--spacing-xl) 0;
        }

        .header-logo-left, .header-logo-right {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo-image {
            height: 120px;
            width: auto;
            max-width: 180px;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            transition: var(--transition-base);
        }

        .logo-image:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.15));
        }

        .header-center {
            text-align: center;
            position: relative;
        }

        .tarjeton-container {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }

        .tarjeton-image {
            width: 70%;
            max-width: 520px;
            min-width: 280px;
            height: auto;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
            transition: var(--transition-base);
        }

        .tarjeton-image:hover {
            transform: scale(1.02);
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.15));
        }

        .header-title {
            font-size: clamp(var(--text-xl), 4vw, var(--text-3xl));
            font-weight: 700;
            margin: 0 0 var(--spacing-sm) 0;
            letter-spacing: -0.025em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            font-size: var(--text-base);
            opacity: 0.9;
            margin: 0;
            font-weight: 400;
        }

        /* ===== RESPONSIVE HEADER ===== */
        @media (max-width: 1024px) {
            .header-layout {
                grid-template-columns: 150px 1fr 150px;
                gap: var(--spacing-md);
            }
            
            .logo-image {
                height: 100px;
                max-width: 140px;
            }
            
            .tarjeton-image {
                width: 80%;
                min-width: 240px;
            }
        }

        @media (max-width: 768px) {
            .header-layout {
                grid-template-columns: 1fr;
                gap: var(--spacing-lg);
                text-align: center;
                padding: var(--spacing-lg) 0;
            }
            
            .header-logo-left, .header-logo-right {
                order: 2;
                justify-content: space-around;
            }
            
            .header-center {
                order: 1;
            }
            
            .logo-image {
                height: 80px;
                max-width: 120px;
            }
            
            .tarjeton-image {
                width: 90%;
                min-width: 200px;
            }
            
            .header-title {
                font-size: var(--text-xl);
            }
        }

        @media (max-width: 480px) {
            .header-layout {
                grid-template-columns: 1fr;
                padding: var(--spacing-md) 0;
            }
            
            .header-logo-left, .header-logo-right {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .logo-image {
                height: 60px;
                max-width: 100px;
            }
            
            .tarjeton-image {
                width: 95%;
                min-width: 180px;
            }
        }

        /* ===== COMPATIBILIDAD CON ESTILOS EXISTENTES ===== */
        fieldset { 
            border: 1px solid var(--line); 
            border-radius: 12px; 
            margin: 24px 0; 
            padding: 24px; 
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        fieldset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Efecto zoom x2 en hover para elementos interactivos */
        .zoom-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .zoom-hover:hover {
            transform: scale(2);
            z-index: 1000;
            position: relative;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        /* Aplicar zoom a inputs, selects y buttons */
        input:not([type="submit"]):not([type="button"]):not([type="reset"]),
        select,
        textarea {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        
        input:not([type="submit"]):not([type="button"]):not([type="reset"]):hover,
        select:hover,
        textarea:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            z-index: 10;
            position: relative;
        }
        
        /* Zoom x2 para botones de acci√≥n */
        .btn, button {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .btn:hover, button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            z-index: 10;
            position: relative;
        }
        
        /* Zoom espec√≠fico para botones "Nuevo Registro" */
        button[id*="NuevoBtn"]:hover {
            transform: scale(1.2);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* Efectos de zoom para checkboxes y radios */
        input[type="checkbox"], input[type="radio"] {
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        
        input[type="checkbox"]:hover, input[type="radio"]:hover {
            transform: scale(1.3);
        }
        
        /* Zoom para labels de checkboxes y radios */
        label:has(input[type="checkbox"]), label:has(input[type="radio"]) {
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        label:has(input[type="checkbox"]):hover, label:has(input[type="radio"]):hover {
            transform: scale(1.05);
        }
        
        /* Mejora espec√≠fica para radio buttons en formularios diabetes */
        .radio-option {
            display: flex !important;
            align-items: center !important;
            gap: 4px !important;
            margin: 0 !important;
            font-size: 11px !important;
            cursor: pointer !important;
        }
        
        .radio-option input[type="radio"] {
            margin: 0 !important;
            vertical-align: middle !important;
        }
        
        .radio-container {
            display: flex !important;
            gap: 12px !important;
            align-items: center !important;
        }
        
        /* Zoom para el bot√≥n principal de guardado */
        #guardarBtn, input[type="submit"] {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        #guardarBtn:hover, input[type="submit"]:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        /* Zoom para el header y logos */
        .header img {
            transition: transform 0.3s ease;
        }
        
        .header img:hover {
            transform: scale(1.1);
        }
        
        /* Efectos especiales para el cuadro de riesgo flotante */
        #cuadro-riesgo-flotante {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        #cuadro-riesgo-flotante:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
        }
        
        legend { 
            font-weight: 700; 
            background: var(--brand);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 0 16px; 
            font-size: 1.1rem;
            display: flex;
            align-items: center;
        }
        label { 
            display: block; 
            margin: 8px 0 4px 0; 
            font-weight: 600; 
            font-size: 14px; 
            color: #374151;
        }
        input, select { 
            width: 100%; 
            padding: .5rem .6rem; 
            border: 1px solid #cbd5e1; 
            border-radius: .5rem; 
            background: #fff;
            font-size: 14px;
        }
        
        /* Anchos espec√≠ficos para campos optimizados - m√°s compactos */
    input[name="run"] { width: 180px !important; } /* Para 00.000.000-0 */
    /* Estados visuales de validaci√≥n del RUN */
    #run.run-valid { color: #16a34a; }
    #run.run-invalid { color: #dc2626; }
        input[name="fecha_nacimiento"] { width: 130px !important; } /* Para 20/08/2020 */
        input[name="edad"] { width: 80px !important; text-align: right; } /* Edad en a√±os */
        input[name="telefono"] { width: 140px !important; } /* M√°s compacto */
        input[name="fecha"] { width: 130px !important; } /* Para 00/00/0000 */
        input[name="presion_sistolica"] { width: 80px !important; } /* Para 123 */
        input[name="presion_diastolica"] { width: 80px !important; } /* Para 120 */
        input[name="hgt"] { width: 80px !important; } /* Para 000 */
        input[name="cc"] { width: 80px !important; } /* Para 123 */
        input[name="hba1c"] { width: 90px !important; } /* Para 10.0 */
        input[name="peso"] { width: 90px !important; } /* Para peso */
        input[name="talla"] { width: 90px !important; } /* Para talla */
        input[name="fecha_ingreso"] { width: 130px !important; } /* Para fecha */
        
        /* Contenedor para campos en l√≠nea - m√°s compacto */
        .campos-linea {
            display: flex;
            gap: 12px;
            align-items: end;
            flex-wrap: wrap;
        }
        .campos-linea label {
            margin-bottom: 0;
            flex: none;
        }
        /* Utilidad: ocupar 50% del ancho de la fila */
        .campos-linea label.half { flex: 1 1 50% !important; max-width: 50%; }
        
        /* Anchos espec√≠ficos para selects - m√°s compactos */
    select[name="sexo"] { width: 160px !important; } /* Para masculino/femenino */
        select[name="categoria_id"] { width: 90px !important; } /* Para G1, G2, G3 */
        select[name="sector_id"] { width: 160px !important; } /* Para sectores */
        select[name="profesional"] { width: 140px !important; } /* Para profesional */
        
        /* Botones compactos como en index.html */
        .btn{
            display:inline-block;border:1px solid var(--line);background:#fff;color:var(--ink);
            padding:.45rem .7rem;border-radius:.5rem;font-size:.9rem;cursor:pointer;text-decoration:none;
        }
        .btn:hover{filter:brightness(0.98)}
        .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
        .btn-primary:hover{background:var(--brand-600);border-color:var(--brand-600)}
        .btn-success{background:var(--success);border-color:var(--success);color:#fff}
        .btn-secondary{background:#6c757d;border-color:#6c757d;color:#fff}
        .btn-secondary:hover{background:#5a6268;border-color:#5a6268}
        /* Estado activo para los botones de Programa */
        .btn[data-active="true"]{
            background: var(--brand);
            color: #fff;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(13,110,253,0.15);
            font-weight: 700;
        }
        
        input:focus, select:focus {
            border-color: var(--brand);
            outline: none;
            box-shadow: 0 0 0 3px rgba(13,110,253,0.1);
        }
        input[type="submit"], button { 
            background: var(--brand); 
            color: white; 
            padding: .5rem .8rem; 
            border: none; 
            border-radius: .5rem; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            margin: 8px 6px 0 0; 
        }
        input[type="submit"]:hover, button:hover { 
            background: var(--brand-600); 
        }
        .mensaje { 
            padding: 12px; 
            border-radius: 6px;
            margin: 12px 0; 
            font-size: 14px; 
            font-weight: 500;
        }
        .mensaje.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .mensaje.exito { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        small { 
            color: var(--muted); 
            font-size: 12px; 
            font-weight: normal;
        }
        .volver { 
            display: inline-block; 
            margin: 16px 0; 
            background: var(--brand); 
            color: white !important; 
            text-decoration: none; 
            font-size: 14px; 
            font-weight: 600;
            padding: .5rem .8rem; 
            border-radius: .5rem; 
            transition: all 0.2s ease;
        }
        .volver:hover { 
            background: var(--brand-600); 
            text-decoration: none;
        }
        /* Paneles compactos para m√≥dulos nuevos */
        .mini-wrapper {
            margin:24px 0 0 0; 
            border:1px solid var(--line); 
            border-radius:12px; 
            background:#fff; 
            box-shadow:0 2px 8px rgba(0,0,0,.04);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        } 
        
        .mini-wrapper:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,.12);
            z-index: 5;
            position: relative;
        } 
        .mini-header {display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer; user-select:none; background:#f8fafc; border-bottom:1px solid var(--line);} 
    .imc-chip{padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; line-height:1;}
    .imc-morado{background:#f3e8ff; color:#6b21a8;}
    .imc-verde{background:#dcfce7; color:#166534;}
    .imc-amarillo{background:#fef9c3; color:#854d0e;}
    .imc-rojo{background:#fee2e2; color:#991b1b;}
        .mini-header h3{margin:0; font-size:16px; display:flex; align-items:center; gap:8px; font-weight:600; color:#0f172a;}
        .mini-panel{padding:14px 16px;}
        .mini-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;}
        .mini-field{background:#fff; border:1px solid #e2e8f0; padding:12px; border-radius:10px;}
        .mini-label{display:block; font-weight:600; font-size:12px; color:#334155; margin-bottom:6px; text-transform:uppercase; letter-spacing:.3px;}
        .mini-actions{margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;}
        .mini-status{font-size:12px; color:#475569; min-height:18px; margin-top:6px;}
        .mini-table{width:100%; border-collapse:collapse; font-size:12px;}
        .mini-table th,.mini-table td{border:1px solid #e5e7eb; padding:6px 8px; text-align:left;}
        .mini-table th{background:#f1f5f9; font-weight:600;}
        /* Screening */
        .screening-grid { display:flex; gap:16px; flex-wrap:wrap; }
        .screening-card { flex:1 1 280px; border:1px solid var(--line); border-radius:8px; padding:12px; background:#fafafa; position:relative; }
        .screening-card h4 { margin:0 0 6px 0; font-size:14px; color:#0d47a1; }
        .screening-card small.helper { display:block; font-size:10px; color:#555; margin-bottom:6px; }
        .hidden { display:none !important; }
        .badge-elig { position:absolute; top:6px; right:6px; background:#0d6efd; color:#fff; font-size:10px; padding:2px 6px; border-radius:12px; }
        .badge-noelig { position:absolute; top:6px; right:6px; background:#999; color:#fff; font-size:10px; padding:2px 6px; border-radius:12px; }
        .loading { 
            display: none; 
            color: var(--brand); 
            font-style: italic; 
            font-size: 14px; 
            font-weight: 500;
        }
        .encontrado { 
            background: #d1ecf1; 
            color: #0c5460;
            border: 1px solid #bee5eb; 
            padding: 8px; 
            border-radius: 6px; 
            margin: 8px 0; 
            font-size: 14px; 
            font-weight: 500;
        }
        .patologias-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--line);
            border-radius: 6px;
            padding: 12px;
            background: #f8f9fa;
        }
        .patologia-item {
            margin: 6px 0;
        }
        
        /* ===== BARRA LATERAL MODERNA DE ALERTAS ===== */
        .health-alerts-floating {
            position: fixed !important;
            top: 0 !important;
            right: -500px !important;
            width: 480px !important;
            /* Alto completo con unidades din√°micas para iOS/macOS */
            height: 100dvh !important;
            max-height: 100dvh !important;
            /* Layout en columna para que el contenido use el espacio restante */
            display: flex !important;
            flex-direction: column !important;
            background: rgba(255, 255, 255, 0.5) !important;
            box-shadow: var(--shadow-xl), -4px 0 16px rgba(0,0,0,0.1) !important;
            z-index: 99998 !important;
            border-left: 1px solid var(--border-color) !important;
            overflow: hidden !important;
            transition: var(--transition-base) !important;
            backdrop-filter: blur(20px) !important;
        }
        
        .health-alerts-floating.show {
            right: 0 !important;
        }
        
        /* Overlay moderno - SIN BLUR para poder leer formulario */
        .sidebar-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.1) !important;
            z-index: 99997 !important;
            opacity: 0 !important;
            transition: var(--transition-base) !important;
            /* backdrop-filter: blur(2px) !important; REMOVIDO PARA PODER LEER */
        }
        
        .sidebar-overlay.show {
            opacity: 1 !important;
        }
        
        /* Barra de t√≠tulo moderna */
        .alerts-titlebar {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%) !important;
            padding: var(--spacing-lg) var(--spacing-xl) !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            color: white !important;
            border-bottom: 1px solid rgba(255,255,255,0.1) !important;
            position: relative !important;
        }
        
        .alerts-titlebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="alerts-grid" width="16" height="16" patternUnits="userSpaceOnUse"><path d="M 16 0 L 0 0 0 16" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23alerts-grid)"/></svg>');
            pointer-events: none;
        }
        
        .alerts-title {
            display: flex !important;
            align-items: center !important;
            gap: var(--spacing-sm) !important;
            font-size: var(--text-lg) !important;
            font-weight: 600 !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .alerts-controls {
            display: flex !important;
            gap: var(--spacing-sm) !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .alert-btn {
            background: rgba(255,255,255,0.95) !important;
            border: 2px solid rgba(255,255,255,0.8) !important;
            color: var(--primary-600) !important;
            padding: var(--spacing-sm) var(--spacing-md) !important;
            border-radius: var(--radius-md) !important;
            cursor: pointer !important;
            transition: var(--transition-base) !important;
            font-size: var(--text-sm) !important;
            font-weight: 600 !important;
            min-width: 80px !important;
            text-align: center !important;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
            margin-left: 4px !important;
        }
        
        .alert-btn:hover {
            background: white !important;
            border-color: var(--primary-600) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
        }
        
        /* Tabs de alertas modernas */
        .alerts-tabs {
            background: var(--gray-50) !important;
            border-bottom: 1px solid var(--border-color) !important;
            display: flex !important;
            overflow-x: auto !important;
        }
        
        .alert-tab {
            padding: var(--spacing-md) var(--spacing-lg) !important;
            background: none !important;
            border: none !important;
            color: var(--gray-600) !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: var(--transition-base) !important;
            border-bottom: 3px solid transparent !important;
            font-size: var(--text-sm) !important;
            white-space: nowrap !important;
            min-width: max-content !important;
            /* EVITAR COMPORTAMIENTOS DE FORMULARIO */
            outline: none !important;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            pointer-events: auto !important;
            /* NO INHERIT FORM STYLES */
            box-shadow: none !important;
            text-decoration: none !important;
        }
        
        .alert-tab:hover {
            background: var(--gray-100) !important;
            color: var(--gray-800) !important;
            /* NO FOCUS OUTLINE */
            outline: none !important;
            box-shadow: none !important;
        }
        
        .alert-tab.active {
            color: var(--primary-600) !important;
            border-bottom-color: var(--primary-600) !important;
            background: white !important;
            /* NO FOCUS OUTLINE */
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* ASEGURAR QUE NO HAYA FOCUS VISIBLE EN TABS */
        .alert-tab:focus,
        .alert-tab:focus-visible,
        .alert-tab:active {
            outline: none !important;
            box-shadow: none !important;
            border: none !important;
            background: var(--gray-100) !important;
        }
        
        /* AISLAMIENTO COMPLETO DE FORMULARIOS */
        .alerts-tabs,
        .alerts-tabs * {
            /* NO PARTICIPAR EN FORM VALIDATION */
            pointer-events: auto !important;
            /* NO RECIBIR FOCUS DE FORMULARIO */
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            /* NO HEREDAR ESTILOS DE FORMULARIO */
            font-family: inherit !important;
            font-size: inherit !important;
            line-height: inherit !important;
        }
        
        /* ASEGURAR QUE DIVS NO SE COMPORTEN COMO BOTONES DE FORM */
        .alert-tab[role="button"] {
            display: inline-block !important;
            vertical-align: middle !important;
            text-align: center !important;
            border: none !important;
            background: none !important;
        }
        
        /* Contenido de alertas moderno */
        .alerts-content {
            padding: var(--spacing-lg) !important;
            /* Que el contenido ocupe el resto del alto del panel */
            flex: 1 1 auto !important;
            min-height: 0 !important; /* necesario para permitir scroll dentro de flex */
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch !important;
            overscroll-behavior: contain !important;
        }
        
        .alert-category {
            display: none !important;
        }
        
        .alert-category.active {
            display: block !important;
        }
        
        .alert-item {
            background: white !important;
            border: 1px solid var(--border-color) !important;
            border-radius: var(--radius-md) !important;
            padding: var(--spacing-md) !important;
            margin-bottom: var(--spacing-sm) !important;
            transition: var(--transition-base) !important;
            border-left: 4px solid var(--primary-500) !important;
        }
        
        .alert-item:hover {
            box-shadow: var(--shadow-sm) !important;
            transform: translateX(2px) !important;
        }
        
        .alert-item.warning {
            border-left-color: var(--warning-500) !important;
            background: var(--warning-50) !important;
        }
        
        .alert-item.danger {
            border-left-color: var(--danger-500) !important;
            background: var(--danger-50) !important;
        }
        
        .alert-item.success {
            border-left-color: var(--success-500) !important;
            background: var(--success-50) !important;
        }
        
        /* Bot√≥n de alertas moderno */
        #ver-alertas-btn {
            position: fixed !important;
            top: 120px !important;
            right: var(--spacing-lg) !important;
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%) !important;
            color: white !important;
            border: none !important;
            padding: var(--spacing-md) var(--spacing-lg) !important;
            border-radius: var(--radius-lg) !important;
            font-size: var(--text-sm) !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: var(--transition-base) !important;
            z-index: 1000 !important;
            box-shadow: var(--shadow-lg) !important;
            display: flex !important;
            align-items: center !important;
            gap: var(--spacing-sm) !important;
        }
        
        #ver-alertas-btn:hover {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-900) 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-xl) !important;
        }
        
        #ver-alertas-btn::before {
            content: 'üîî';
            font-size: 16px;
        }
        
        /* Responsive para panel de alertas */
        @media (max-width: 768px) {
            .health-alerts-floating {
                width: 100vw !important;
                right: -100vw !important;
            }
            
            .health-alerts-floating.show {
                right: 0 !important;
            }
            
            #ver-alertas-btn {
                top: var(--spacing-lg) !important;
                right: var(--spacing-md) !important;
                padding: var(--spacing-sm) var(--spacing-md) !important;
                font-size: var(--text-xs) !important;
            }
            
            .alerts-titlebar {
                padding: var(--spacing-md) var(--spacing-lg) !important;
            }
            
            .alerts-content {
                padding: var(--spacing-md) !important;
            }
        }
        
        /* Estados colapsados */
        .health-alerts-floating.collapsed {
            width: 60px !important;
            opacity: 0.8 !important;
        }
        
        .health-alerts-floating.collapsed .alerts-tabs,
        .health-alerts-floating.collapsed .alerts-content {
            display: none !important;
        }
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            /* ELIMINAR TRANSICIONES QUE CAUSAN PARPADEO */
            transition: none !important;
            animation: none !important;
        }
        
        .alert-btn:hover {
            background: rgba(255,255,255,0.3);
            transition: none !important;
        }
        
        .alerts-tabs {
            background: rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            overflow-x: auto;
            padding: 0 20px;
        }
        
        .alert-tab {
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            /* ELIMINAR TRANSICIONES QUE CAUSAN PARPADEO */
            transition: none !important;
            animation: none !important;
        }
        
        .alert-tab.active {
            color: white;
            border-bottom-color: #ffffff;
            background: rgba(255,255,255,0.1);
            transition: none !important;
        }
        
        .alerts-content {
            padding: 20px;
            /* Eliminar altura fija y usar flex + min-height:0 para scroll estable */
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background: rgba(255,255,255,0.05);
        }
        
        .alert-category {
            display: none;
        }
        
        .alert-category.active {
            display: block;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            background: #f8f9fa;
            font-size: 13px;
        }
        
        .alert-item.vigente {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .alert-item.vencido {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .alert-item.sin-registro {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .alert-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .alert-status-icon {
            font-size: 16px;
        }
        
        .alert-details {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        /* Estilos adicionales para loading y estados */
        .loading-alerts {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .alert-item.por-vencer {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        /* Responsive design para cuadro flotante - ESTABILIZADO */
        @media (max-width: 768px) {
            .health-alerts-floating {
                position: fixed !important;
                top: 10px !important;
                left: 10px !important;
                right: 10px !important;
                width: auto !important;
                max-width: none !important;
                height: 100dvh !important; /* asegurar alto completo en m√≥viles */
                max-height: 100dvh !important;
                /* Sin transiciones en responsive */
                transition: none !important;
                transform: none !important;
            }
        }
        
        /* Prevenir interferencias del mouse y estabilizar completamente */
        .health-alerts-floating * {
            /* Ning√∫n elemento hijo debe tener transiciones que causen parpadeo */
            transition: none !important;
        }
        
        .health-alerts-floating .alerts-titlebar,
        .health-alerts-floating .alerts-tabs,
        .health-alerts-floating .alerts-content {
            /* Estabilizar elementos internos */
            transform: none !important;
            transition: none !important;
        }
        
        /* Elementos estabilizados sin transiciones problem√°ticas */
        .alert-item {
            /* Transiciones m√≠nimas para evitar parpadeo */
            transition: box-shadow 0.1s ease !important;
        }
        
        .alert-item:hover {
            /* Eliminamos transform que puede causar saltos */
            transform: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        
        /* Cuadro flotante estabilizado - SIN animaciones que causen parpadeo */
        .health-alerts-floating {
            /* Eliminamos animation: slideInRight que causa inestabilidad */
            animation: none !important;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Animaci√≥n de pulso para bot√≥n flotante rojo */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
                transform: scale(1);
            }
        }
        
        /* Estilos del bot√≥n flotante rojo */
        #ver-alertas-btn:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%) !important;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6) !important;
            transform: scale(1.05) !important;
            animation: none !important;
        }
        
        #ver-alertas-btn:active {
            transform: scale(0.95) !important;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 6px;
            background: white;
            border: 1px solid #e1e5e9;
            transition: all 0.2s ease;
        }
        
        .alert-item:hover {
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .alert-item.vigente {
            border-left: 4px solid #22c55e;
            background: #f0fdf4;
        }
        
        .alert-item.vencido {
            border-left: 4px solid #f59e0b;
            background: #fffbeb;
        }
        
        .alert-item.critico {
            border-left: 4px solid #ef4444;
            background: #fef2f2;
        }
        
        .alert-label {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            flex: 1;
        }
        
        .loading-alerts {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-style: italic;
        }
            font-size: 14px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .patologia-item input[type="checkbox"] {
            width: auto;
            margin: 0;
            transform: scale(1.1);
            flex-shrink: 0;
            margin-top: 2px;
        }
        .patologia-label,
        .patologia-item label {
            flex: 1;
            cursor: pointer;
            line-height: 1.3;
            display: flex !important;
            flex-direction: column;
        }
        
        /* Estilos para botones de contraer/expandir - MODERNOS Y COMPACTOS */
        .categoria-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 8px 12px;
            margin: 4px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .categoria-header:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: var(--brand);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(13,110,253,0.15);
        }
        
        .categoria-toggle {
            background: var(--brand);
            border: none;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 50%;
            transition: all 0.2s ease;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .categoria-toggle:hover {
            background: var(--brand-600);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 2px 6px rgba(13,110,253,0.3);
        }
        
        /* Estilos para familias - ULTRA COMPACTOS */
        .familia-header {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 3px 6px;
            margin: 1px 0;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
            border-left: 2px solid var(--brand);
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 600;
            user-select: none;
            justify-content: space-between;
        }
        
        .familia-header:hover {
            background: rgba(13,110,253,0.08);
            transform: translateX(4px);
            box-shadow: 0 1px 3px rgba(13,110,253,0.15);
        }
        
        .familia-toggle {
            background: #6c757d;
            border: none;
            color: white;
            font-size: 9px;
            font-weight: bold;
            cursor: pointer;
            padding: 1px 3px;
            border-radius: 50%;
            transition: all 0.2s ease;
            min-width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .familia-toggle:hover {
            background: var(--brand);
            transform: scale(1.1);
        }
        
        .familia-content {
            transition: all 0.2s ease;
            overflow: hidden;
            margin-left: 12px;
            padding-left: 6px;
            border-left: 1px dashed #dee2e6;
        }
        
        .familia-content.collapsed {
            display: none;
            margin: 0;
            padding: 0;
        }
        
        .categoria-content {
            transition: all 0.3s ease;
            overflow: hidden;
            padding: 6px;
        }
        
        .categoria-content.collapsed {
            display: none;
        }

        /* Estilos para botones de control de categor√≠as - MODERNOS */
        .btn-categoria-control {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-600) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(13,110,253,0.2);
            margin: 0 4px;
        }
        
        .btn-categoria-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13,110,253,0.3);
        }

        .btn-categoria-control:active {
            transform: translateY(0);
        }
        
        .categoria-badge {
            background: linear-gradient(135deg, var(--brand) 0%, var(--brand-600) 100%);
            color: white;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .badge-puntos {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 8px;
            margin-left: 4px;
            font-weight: 600;
        }


        
        /* Alertas personalizadas transparentes */
        .alert-transparent {
            position: fixed;
            top: 120px;
            right: 24px;
            background: rgba(255, 243, 224, 0.95);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-left: 4px solid #f59e0b;
            color: #92400e;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
            z-index: 10000;
            max-width: 280px;
            backdrop-filter: blur(10px);
            transform: translateX(300px);
            transition: all 0.3s ease;
        }
        
        .alert-transparent.show {
            transform: translateX(0);
        }
        
        .alert-transparent .alert-icon {
            font-size: 16px;
            margin-right: 8px;
        }
        
        /* Forzar visibilidad de todas las categor√≠as */
        .categoria-seccion {
            display: block !important;
            margin-bottom: 8px;
        }
        
        /* Estilos para banners de categor√≠as espec√≠ficas con colores distintivos */
        .subcategoria-header {
            padding: 8px 12px;
            margin: 6px 0;
            font-weight: 600;
            font-size: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        .subcategoria-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Diabetes - Gradiente Azul/Verde */
        .banner-diabetes {
            background: linear-gradient(135deg, #e3f2fd 0%, #c8e6c9 100%);
            border-left: 4px solid #1976d2;
            color: #1565c0;
        }
        
        /* Trastornos Tiroideos - Gradiente P√∫rpura */
        .banner-tiroides {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 4px solid #7b1fa2;
            color: #6a1b9a;
        }
        
        /* Problemas Psicosociales (Z) - Gradiente Naranja */
        .banner-psicosocial {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            border-left: 4px solid #f57c00;
            color: #ef6c00;
        }
        
        /* Hep√°ticas - Gradiente Amarillo/Verde */
        .banner-hepaticas {
            background: linear-gradient(135deg, #fffde7 0%, #f0f4c3 100%);
            border-left: 4px solid #827717;
            color: #689f38;
        }
        
        /* Gastrointestinales - Gradiente Rosa */
        .banner-gastro {
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
            border-left: 4px solid #c2185b;
            color: #ad1457;
        }
        
        /* Respiratorias - Gradiente Celeste */
        .banner-respiratorias {
            background: linear-gradient(135deg, #e0f2f1 0%, #80cbc4 100%);
            border-left: 4px solid #00695c;
            color: #004d40;
        }
        
        /* Renales - Gradiente Azul Profundo */
        .banner-renales {
            background: linear-gradient(135deg, #e8eaf6 0%, #9fa8da 100%);
            border-left: 4px solid #303f9f;
            color: #283593;
        }
        
        /* Oftalmol√≥gicas - Gradiente Verde Esmeralda */
        .banner-oftalmo {
            background: linear-gradient(135deg, #e8f5e8 0%, #a5d6a7 100%);
            border-left: 4px solid #388e3c;
            color: #2e7d32;
        }
        
        /* Neoplasias/C√°ncer - Gradiente Rojo Fuerte */
        .banner-neoplasias {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #d32f2f;
            color: #c62828;
        }
        
        /* Maltrato/Violencia - Gradiente Rojo Oscuro */
        .banner-maltrato {
            background: linear-gradient(135deg, #fce4ec 0%, #e1bee7 100%);
            border-left: 4px solid #8e24aa;
            color: #7b1fa2;
        }
        
        /* Sangre/Coagulaci√≥n - Gradiente Granate */
        .banner-sangre {
            background: linear-gradient(135deg, #fff3e0 0%, #d7ccc8 100%);
            border-left: 4px solid #5d4037;
            color: #4e342e;
        }
        
        /* Discapacidad Intelectual - Gradiente √çndigo */
        .banner-discapacidad {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border-left: 4px solid #3f51b5;
            color: #303f9f;
        }
        
        /* Ansiedad/Personalidad - Gradiente Lime */
        .banner-ansiedad {
            background: linear-gradient(135deg, #f9fbe7 0%, #dcedc8 100%);
            border-left: 4px solid #689f38;
            color: #558b2f;
        }
        
        /* Sue√±o - Gradiente Violeta Profundo */
        .banner-sueno {
            background: linear-gradient(135deg, #ede7f6 0%, #d1c4e9 100%);
            border-left: 4px solid #673ab7;
            color: #512da8;
        }
        
        /* Anemias - Gradiente Rojo Suave */
        .banner-anemia {
            background: linear-gradient(135deg, #ffeaea 0%, #ffcdd2 100%);
            border-left: 4px solid #d32f2f;
            color: #c62828;
        }
        
        /* Intoxicaci√≥n Aguda - Gradiente Naranja Fuerte */
        .banner-intoxicacion {
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%);
            border-left: 4px solid #ff6f00;
            color: #e65100;
        }
        
        /* VIH/SIDA - Gradiente Rojo Intenso */
        .banner-vih {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 4px solid #e91e63;
            color: #c2185b;
        }
        
        /* Depresi√≥n - Gradiente Azul Gris√°ceo */
        .banner-depresion {
            background: linear-gradient(135deg, #eceff1 0%, #b0bec5 100%);
            border-left: 4px solid #455a64;
            color: #37474f;
        }

        /* Cerebrovascular - Gradiente Morado */
        .banner-cerebrovascular {
            background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 100%);
            border-left: 4px solid #8e24aa;
            color: #4a148c;
        }

        /* Psic√≥ticos - Gradiente P√∫rpura */
        .banner-psicoticos {
            background: linear-gradient(135deg, #f8bbd9 0%, #e1bee7 100%);
            border-left: 4px solid #ad1457;
            color: #880e4f;
        }

        /* Lupus - Gradiente Rojo Coral */
        .banner-lupus {
            background: linear-gradient(135deg, #ffcccb 0%, #ffa0a0 100%);
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        /* Parkinson - Gradiente Azul Neurol√≥gico */
        .banner-parkinson {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #1976d2;
            color: #0d47a1;
        }

        /* Discapacidad Intelectual - Gradiente Violeta */
        .banner-discapacidad {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 4px solid #7b1fa2;
            color: #4a148c;
        }

        .buttons-container {
            text-align: center;
            margin: 12px 0;
            padding: 8px;
            background: rgba(13,110,253,0.03);
            border-radius: 8px;
        }
        
        /* Estilos para resumen de patolog√≠as */
        .patologias-resumen {
            margin-top: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            min-height: 35px;
        }
        .patologias-titulo {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .pat-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .pat {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 500;
            border: 1px solid transparent;
            font-size: 11px;
        }
        .pat-diabetes {
            background: #dcfce7;
            color: #16a34a;
            border-color: #86efac;
        }
        .pat-hta {
            background: #fee2e2;
            color: #991b1b;
            border-color: #fca5a5;
        }
        .pat-dislipidemia {
            background: #fef3c7;
            color: #92400e;
            border-color: #fde68a;
        }
        .pat-empty {
            color: #6c757d;
            font-style: italic;
            font-size: 12px;
        }
        
        /* ==================== ESTILOS SEGUIMIENTO DIAB√âTICO ==================== */
        .seguimiento-lateral {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            z-index: 1000;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        .seguimiento-tab {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            padding: 12px 8px;
            border-radius: 12px 0 0 12px;
            cursor: pointer;
            box-shadow: -4px 0 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 50px;
            user-select: none;
        }
        
        .seguimiento-tab:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateX(-5px);
            box-shadow: -6px 0 20px rgba(0,0,0,0.25);
        }
        
        .seguimiento-icon {
            font-size: 20px;
            writing-mode: horizontal-tb;
        }
        
        .seguimiento-text {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            line-height: 1.2;
            writing-mode: horizontal-tb;
        }
        
        .seguimiento-indicator {
            font-size: 16px;
            writing-mode: horizontal-tb;
            animation: pulse 2s infinite;
        }
        
        .seguimiento-panel {
            position: absolute;
            top: 0;
            right: 100%;
            width: 450px;
            max-height: 80vh;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px 0 0 12px;
            box-shadow: -8px 0 32px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .seguimiento-panel.active {
            transform: translateX(0);
        }
        
        .seguimiento-header {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 16px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .seguimiento-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .seguimiento-close {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .seguimiento-close:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .seguimiento-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            max-height: calc(80vh - 140px);
        }
        
        .seguimiento-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fefefe;
            transition: all 0.2s ease;
        }
        
        .seguimiento-item:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateX(-2px);
        }
        
        .criterio-icon {
            font-size: 18px;
            min-width: 24px;
            text-align: center;
        }
        
        .criterio-text {
            flex: 1;
        }
        
        .criterio-text strong {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }
        
        .criterio-text small {
            display: block;
            font-size: 11px;
            color: #64748b;
            line-height: 1.3;
        }
        
        .criterio-status {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .seguimiento-footer {
            background: #f8fafc;
            padding: 12px 16px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .seguimiento-summary {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }
        
        .seguimiento-refresh {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .seguimiento-refresh:hover {
            background: #059669;
            transform: scale(1.05);
        }
        
        /* Estados de criterios */
        .seguimiento-item[data-estado="completo"] .criterio-icon {
            color: #16a34a;
        }
        
        .seguimiento-item[data-estado="completo"] .criterio-status {
            background: #dcfce7;
            color: #16a34a;
        }
        
        .seguimiento-item[data-estado="pendiente"] .criterio-icon {
            color: #dc2626;
        }
        
        .seguimiento-item[data-estado="pendiente"] .criterio-status {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .seguimiento-item[data-estado="parcial"] .criterio-icon {
            color: #d97706;
        }
        
        .seguimiento-item[data-estado="parcial"] .criterio-status {
            background: #fef3c7;
            color: #d97706;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Separadores de secciones */
        .seguimiento-separator {
            margin: 16px 0 12px 0;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }
        
        .seguimiento-separator span {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .seguimiento-section {
            margin-bottom: 8px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .seguimiento-panel {
                width: calc(100vw - 60px);
                max-width: 400px;
            }
        }
    </style>
    
</head>
<body>
    <div class="container">
        <!-- Enlace de navegaci√≥n moderno -->
        <nav class="breadcrumb" style="margin-bottom: var(--spacing-lg);">
            <a href="/" class="breadcrumb-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Volver al inicio
            </a>
        </nav>
        
        <div class="header-modern">
            <div class="header-content">
                <div class="header-layout">
                    <!-- Logo izquierdo -->
                    <div class="header-logo-left">
                        <img src="/static/logo_ecicep.jpg" alt="Logo ECICEP" class="logo-image">
                    </div>
                    
                    <!-- Contenido central con tarjet√≥n -->
                    <div class="header-center">
                        <div class="tarjeton-container">
                            <img src="/static/tarjeton.png" alt="Tarjet√≥n" class="tarjeton-image" />
                        </div>
                        <h1 class="header-title">Ingresar nuevo usuario y/o control</h1>
                        <p class="header-subtitle">Sistema ECICEP - Evaluaci√≥n Cardiovascular Integral</p>
                    </div>
                    
                    <!-- Logo derecho -->
                    <div class="header-logo-right">
                        <img src="/static/dbecicep.png" alt="DB ECICEP" class="logo-image">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cuadro de c√°lculo de riesgo ECICEP flotante -->
    <div id="cuadro-riesgo-flotante" style="position:fixed; top:24px; right:24px; z-index:9999; background:rgba(248,250,252,0.95); border:2px solid rgba(59,130,246,0.8); border-radius:12px; padding:8px 12px; box-shadow:0 6px 32px rgba(0,0,0,0.2); min-width:auto; max-width:140px; font-family: 'Segoe UI', system-ui, sans-serif; transition: all 0.3s ease; backdrop-filter: blur(10px);">
            <!-- Encabezado con bot√≥n de colapsar (vista expandida) -->
            <div id="encabezado-expandido" style="display: none; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <span style="font-size: 20px; font-weight: bold; color: #2563eb;">
                    <img src="/static/graficos/03885027K_imc.png" alt="Icono de c√°lculo IMC" style="height: 1.2em; vertical-align: middle; margin-right: 6px;"> 
                    C√°lculo de Riesgo ECICEP
                </span>
                <button id="btn-colapsar-cuadro" onclick="toggleCuadroRiesgo()" style="background: rgba(59,130,246,0.9); color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s ease;">
                    ‚ûñ
                </button>
            </div>
            
            <!-- Vista colapsada compacta (solo categor√≠a + bot√≥n) -->
            <div id="vista-colapsada-cuadro" style="display: flex; justify-content: space-between; align-items: center; margin: 0;">
                <span id="categoria-riesgo-mini" style="background: rgba(226,232,240,0.9); border-radius: 8px; padding: 6px 12px; font-weight: bold; font-size: 18px; display: inline-block;">G0</span>
                <button id="btn-expandir-cuadro" onclick="toggleCuadroRiesgo()" style="background: rgba(59,130,246,0.9); color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s ease; margin-left: 8px;">
                    ‚ûï
                </button>
            </div>
            
            <!-- Contenido principal (colapsable) -->
            <div id="contenido-cuadro-riesgo" style="display: none;">
                <div style="background: rgba(241,245,249,0.9); border-radius: 8px; padding: 12px; margin-bottom: 12px; text-align: center;">
                    <span style="font-size: 18px; font-weight: 600; color: #1e293b;">
                        Total de puntos: <span id="total-puntos" style="color: #2563eb; font-size: 20px; font-weight: bold;">0</span>
                    </span><br>
                    <span style="font-size: 16px; font-weight: 600; color: #475569;">
                        Categor√≠a: <span id="categoria-riesgo" style="background: rgba(226,232,240,0.9); border-radius: 6px; padding: 4px 10px; font-weight: bold; font-size: 16px;">G0</span>
                    </span>
                </div>
                
                <div style="font-size: 14px; line-height: 1.6; border-top: 1px solid rgba(226,232,240,0.7); padding-top: 12px;">
                    <div style="margin-bottom: 8px; padding: 6px 8px; border-radius: 6px; background: rgba(248,250,252,0.8);">
                        <span style="color: #64748b; font-weight: 600;">‚ö™Ô∏è 0 puntos = G0</span>
                        <span style="color: #64748b; margin-left: 8px;">(Sin Riesgo)</span>
                    </div>
                    <div style="margin-bottom: 8px; padding: 6px 8px; border-radius: 6px; background: rgba(240,253,244,0.8);">
                        <span style="color: #16a34a; font-weight: 600;">üü¢ 1 punto = G1</span>
                        <span style="color: #16a34a; margin-left: 8px;">(Riesgo Leve)</span>
                    </div>
                    <div style="margin-bottom: 8px; padding: 6px 8px; border-radius: 6px; background: rgba(255,251,235,0.8);">
                        <span style="color: #f59e0b; font-weight: 600;">üü° 2-4 puntos = G2</span>
                        <span style="color: #f59e0b; margin-left: 8px;">(Riesgo Moderado)</span>
                    </div>
                    <div style="padding: 6px 8px; border-radius: 6px; background: rgba(254,242,242,0.8);">
                        <span style="color: #dc2626; font-weight: 600;">üî¥ 5+ puntos = G3</span>
                        <span style="color: #dc2626; margin-left: 8px;">(Riesgo Alto)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Helpers comunes compartidos -->
        <script type="module" src="{{ url_for('static', filename='js/common.js') }}"></script>
        <script>
        // Enforce colapsado inmediato del cuadro de riesgo al cargar el DOM de este bloque
        (function(){
            try {
                const contenido = DOMCache.get('contenido-cuadro-riesgo');
                const vistaColapsada = DOMCache.get('vista-colapsada-cuadro');
                const encabezadoExpandido = DOMCache.get('encabezado-expandido');
                const cuadro = DOMCache.get('cuadro-riesgo-flotante');
                if (contenido && vistaColapsada && encabezadoExpandido && cuadro) {
                    // Estado colapsado por defecto
                    contenido.style.display = 'none';
                    encabezadoExpandido.style.display = 'none';
                    vistaColapsada.style.display = 'flex';
                    cuadro.style.minWidth = 'auto';
                    cuadro.style.maxWidth = '140px';
                    cuadro.style.padding = '8px 12px';
                    try { localStorage.setItem('cuadro_riesgo_colapsado', '1'); } catch(e) { /* ignore */ }

                    // Guard temporal anti-expansi√≥n durante la carga inicial (evita que otros scripts lo abran)
                    window._riesgoUserInteracted = false;
                    const enfForceCollapsed = () => {
                        if (window._riesgoUserInteracted) return; // no interferir despu√©s de interacci√≥n del usuario
                        contenido.style.display = 'none';
                        encabezadoExpandido.style.display = 'none';
                        vistaColapsada.style.display = 'flex';
                        cuadro.style.minWidth = 'auto';
                        cuadro.style.maxWidth = '140px';
                        cuadro.style.padding = '8px 12px';
                    };
                    const observer = new MutationObserver(() => enfForceCollapsed());
                    observer.observe(contenido, { attributes: true, attributeFilter: ['style'] });
                    observer.observe(encabezadoExpandido, { attributes: true, attributeFilter: ['style'] });
                    observer.observe(vistaColapsada, { attributes: true, attributeFilter: ['style'] });
                    // Cortar el guard tras unos segundos para no dejar un observer permanente
                    setTimeout(() => observer.disconnect(), 4000);
                    // Asegurar doble refuerzo al final del frame
                    requestAnimationFrame(enfForceCollapsed);
                }
            } catch(e) { /* noop */ }
    })();
    </script>

        {% if mensaje or request.args.get('ok') %}
            {% if mensaje and ('RUN inv√°lido' in mensaje or 'Error' in mensaje or 'violates' in mensaje or 'constraint' in mensaje or 'null value' in mensaje) %}
                <div class="mensaje error">
                    {{ mensaje }}
                    <br>
                    <small style="color: #666;">‚ÑπÔ∏è <strong>Importante:</strong> Los datos del formulario se han preservado para que puedas corregir el error.</small>
                    <div style="margin-top: 8px;">
                        <button id="btnLimpiarFormularioError" type="button" style="background:#f5f5f5;border:1px solid #ccc;border-radius:4px;padding:4px 8px;cursor:pointer;">üßπ Limpiar formulario</button>
                    </div>
                </div>
            {% else %}
                <div class="mensaje exito">{{ mensaje or '‚úÖ Usuario y control guardados correctamente.' }}</div>
            {% endif %}
        {% endif %}

        <!-- bloque legacy de HAS_ERROR con Jinja en JS eliminado; manejado por server-state JSON abajo -->

        <script>
        // Persistencia de formulario (versi√≥n consolidada).
        // Nota: Se dej√≥ un solo bloque (antes hab√≠a duplicados). Protegemos para no redefinir.
        (function(){
            if (window.__FormSnapshot && window.__FormSnapshot.__initialized) return;

            function serializeForm(form){
                const data = {};
                const els = form ? form.elements : [];
                for (let i = 0; i < els.length; i++){
                    const el = els[i];
                    if (!el || !el.name) continue;
                    const name = el.name;
                    const type = (el.type || '').toLowerCase();
                    if (type === 'checkbox'){
                        const original = alertas && typeof alertas === 'object' ? (alertas.screening || {}) : {};
                        console.log('ü©∫ Procesando screening (sin derivaciones):', original);

                        // Render (solo datos de backend, sin crear nuevos)
                        html = '<div style="padding:5px;font-size:11px;line-height:1.3">';
                        const entries = Object.entries(original);
                            el.checked = !!val;
                        }
                    } else if (type === 'radio'){
                        el.checked = (String(el.value) === String(val));
                                let icono = 'üìã';
                                let estado = datos.estado || 'Pendiente';

                                // Para vacunas: ‚úÖ vigente, ‚ö†Ô∏è no vigente
                                const tipoLower = (tipo||'').toLowerCase();
                                const esVacuna = tipoLower.includes('vacuna influenza') || tipoLower.includes('vacuna covid');
                                const tieneVigencia = (datos && typeof datos.vigente !== 'undefined');
                                if (esVacuna && tieneVigencia) {
                                    if (datos.vigente === true) { icono = '‚úÖ'; estado = `${estado} (Vigente)`; }
                                    else { icono = '‚ö†Ô∏è'; estado = `${estado} (No vigente)`; }
                                } else {
                                    // Default para otros screening con bandera vigente
                                    if (tieneVigencia) {
                                        if (datos.vigente === true) { icono = 'üü¢'; estado = `${estado} (Vigente)`; }
                                        else if (datos.vigente === false) { icono = 'üî¥'; estado = `${estado} (Vencido)`; }
                                        else { icono = '‚ö™'; estado = `${estado} (Sin datos)`; }
                                    } else {
                                        icono = '‚ö™';
                                        estado = `${estado} (Sin datos)`;
                                    }
                                }
                if (run) {
                    const keyRun = `usuarioFormSnapshot:${run}`;
                    sessionStorage.setItem(keyRun, JSON.stringify({ ts: Date.now(), data: snap }));
                }
            }

            function intentarRestaurarEnError(){
                if (!window.HAS_ERROR) return;
                const form = DOMCache.get('usuarioForm');
                if (!form) return;
                const run = (form.querySelector('#run')?.value || '').trim();
                const tryKeys = [];
                if (run) tryKeys.push(`usuarioFormSnapshot:${run}`);
                tryKeys.push('usuarioFormSnapshot');
                let chosen = null;
                for (const k of tryKeys){
                    const r = sessionStorage.getItem(k); if (!r) continue;
                    try { const p = JSON.parse(r); if (p && p.data){ if (!chosen || (p.ts||0) > (chosen.ts||0)) chosen = p; } } catch(_){}
                }
                if (!chosen){
                    try {
                        for (let i = 0; i < sessionStorage.length; i++){
                            const k = sessionStorage.key(i);
                            if (!k || !k.startsWith('usuarioFormSnapshot:')) continue;
                            const r = sessionStorage.getItem(k); if (!r) continue;
                            const p = JSON.parse(r);
                            if (p && p.data){ if (!chosen || (p.ts||0) > (chosen.ts||0)) chosen = p; }
                        }
                    } catch(_){ }
                }
                if (chosen && chosen.data){
                    restoreForm(form, chosen.data);
                    console.log('üß© Formulario restaurado desde snapshot (consolidado)');
                }
            }

            function limpiarSnapshotsSiOk(){
                const params = new URLSearchParams(window.location.search);
                if (params.get('ok') === '1'){
                    const form = document.getElementById('usuarioForm');
                    const run = form ? (form.querySelector('#run')?.value || '').trim() : '';
                    const keys = ['usuarioFormSnapshot'];
                    if (run) keys.push(`usuarioFormSnapshot:${run}`);
                    keys.forEach(k => { try { sessionStorage.removeItem(k); } catch(_){} });
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                const form = document.getElementById('usuarioForm');
                if (form){
                    form.addEventListener('submit', () => { try { guardarSnapshot(form); } catch(_){} });
                }
                intentarRestaurarEnError();
                limpiarSnapshotsSiOk();
            });

            window.__FormSnapshot = { serializeForm, restoreForm, __initialized: true };
        })();
        </script>

        <script>
        // Permitir al usuario limpiar manualmente el formulario y el snapshot tras un error
        document.addEventListener('DOMContentLoaded', function(){
            try {
                const btn = DOMCache.get('btnLimpiarFormularioError');
                if (!btn) return;
                btn.addEventListener('click', function(){
                    try {
                        // Borrar snapshots conocidos
                        const form = document.getElementById('usuarioForm');
                        const run = form ? (form.querySelector('#run')?.value || '').trim() : '';
                        const keys = ['usuarioFormSnapshot'];
                        if (run) keys.push(`usuarioFormSnapshot:${run}`);
                        // Borra tambi√©n cualquier snapshot namespaced restante
                        for (let i = sessionStorage.length - 1; i >= 0; i--) {
                            const k = sessionStorage.key(i);
                            if (k && k.startsWith('usuarioFormSnapshot:')) {
                                keys.push(k);
                            }
                        }
                        Array.from(new Set(keys)).forEach(k => { try { sessionStorage.removeItem(k); } catch(_){} });

                        // Limpiar visualmente el formulario si existe helper, si no, reset nativo
                        if (typeof limpiarFormulario === 'function') {
                            limpiarFormulario();
                        } else if (form) {
                            form.reset();
                        }
                        // Ocultar el banner de error
                        const banner = document.querySelector('.mensaje.error');
                        if (banner) banner.style.display = 'none';
                    } catch (e) { console.warn('No se pudo limpiar formulario:', e); }
                });
            } catch(_) {}
        });
        </script>

        <style>
        /* Radios segmentados ECICEP/Cardio */
    /* (eliminado UI de programa Cardio/ECICEP) */
        </style>

        <script>
        // Mostrar mini-baner local en secci√≥n Ex√°menes cuando se regresa de un guardado exitoso
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const params = new URLSearchParams(window.location.search);
                if (params.get('ok') === '1' && window.location.hash === '#tabla-examenes') {
                    const okDiv = DOMCache.get('examen-guardado-ok');
                    if (okDiv) {
                        okDiv.style.display = 'block';
                        setTimeout(() => { okDiv.style.display = 'none'; }, 4000);
                    }
                }
            } catch(e) { /* noop */ }
        });
        </script>

    <form id="usuarioForm" method="post" autocomplete="off">
            <!-- Campo oculto para identificar de forma expl√≠cita qu√© bot√≥n de submit fue usado -->
            <input type="hidden" name="submit_action" id="submit_action" value="">
            <!-- Preferencia UI: no corresponde a columna real; el backend debe ignorarlo -->
            <input type="hidden" name="pref_programa_ui" id="categoria_ecicep_effectiva" value="">
            <!-- Flags reales que viajan al backend -->
            <input type="hidden" id="en_programa_cv" name="en_programa_cv" value="false">
            <input type="hidden" id="ingreso_ecicep" name="ingreso_ecicep" value="true">
            <script>
                // Utilidad global para marcar la acci√≥n de env√≠o antes de que el formulario haga submit
                window.__setSubmitAction = function(action) {
                    try {
                        const hidden = DOMCache.get('submit_action');
                        if (hidden) hidden.value = action || '';
                    } catch (_) {}
                };
                
                // Funci√≥n para debug de valores del formulario
                window.__debugFormValues = function() {
                    try {
                        const categoria_id = document.getElementById('categoria_id')?.value;
                        const ingreso_ecicep = document.getElementById('ingreso_ecicep')?.value;
                        const en_programa_cv = document.getElementById('en_programa_cv')?.value;
                        const bypass_riesgo = window.__BYPASS_RIESGO__;
                        
                        debugLog('üöÄ [FORM DEBUG] Valores al enviar formulario:');
                        debugLog('üöÄ [FORM DEBUG] categoria_id:', categoria_id);
                        debugLog('üöÄ [FORM DEBUG] ingreso_ecicep:', ingreso_ecicep);
                        debugLog('üöÄ [FORM DEBUG] en_programa_cv:', en_programa_cv);
                        debugLog('üöÄ [FORM DEBUG] __BYPASS_RIESGO__:', bypass_riesgo);
                    } catch (e) {
                        console.error('üöÄ [FORM DEBUG] Error:', e);
                    }
                };
            </script>
            
            <script>
            // Funci√≥n global para debug de valores del formulario
            window.__debugFormValues = function() {
                try {
                    const categoria_id = document.getElementById('categoria_id')?.value;
                    const ingreso_ecicep = document.getElementById('ingreso_ecicep')?.value;
                    const en_programa_cv = document.getElementById('en_programa_cv')?.value;
                    const bypass_riesgo = window.__BYPASS_RIESGO__;
                    
                    debugLog('üöÄ [FORM DEBUG] Valores del formulario:');
                    debugLog('üöÄ [FORM DEBUG] categoria_id:', categoria_id);
                    debugLog('üöÄ [FORM DEBUG] ingreso_ecicep:', ingreso_ecicep);
                    debugLog('üöÄ [FORM DEBUG] en_programa_cv:', en_programa_cv);
                    debugLog('üöÄ [FORM DEBUG] __BYPASS_RIESGO__:', bypass_riesgo);
                    
                    return {
                        categoria_id: categoria_id,
                        ingreso_ecicep: ingreso_ecicep,
                        en_programa_cv: en_programa_cv,
                        bypass_riesgo: bypass_riesgo
                    };
                } catch (e) {
                    console.error('üöÄ [FORM DEBUG] Error:', e);
                    return null;
                }
            };
            
            // Funci√≥n simple para debug r√°pido
            window.debugForm = function() {
                const cat = document.getElementById('categoria_id');
                const ecicep = document.getElementById('ingreso_ecicep');
                const cv = document.getElementById('en_programa_cv');
                console.log('categoria_id:', cat ? cat.value : 'NO FOUND');
                console.log('ingreso_ecicep:', ecicep ? ecicep.value : 'NO FOUND');
                console.log('en_programa_cv:', cv ? cv.value : 'NO FOUND');
                console.log('__BYPASS_RIESGO__:', window.__BYPASS_RIESGO__);
            };
            </script>
            
            <!-- Usuario conectado -->
            <div style="display:flex; justify-content:flex-end; padding:8px 12px; margin-bottom:8px;">
                <span id="usuario-conectado-span" style="font-size:12px; color:#6b7280; background:#f9fafb; padding:4px 8px; border-radius:4px; border:1px solid #e5e7eb;">
                    üë§ <span id="funcionario-nombre">Cargando...</span>
                </span>
            </div>
            
            <!-- Acciones comunes + Programa (Cardio / ECICEP) -->
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px solid var(--line); border-radius:8px; background:#fff; margin-bottom:12px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <strong>Programa:</strong>
                    <div style="display:flex; gap:6px;">
                        <button type="button" class="btn" id="btn-programa-cardio" title="Fijar modo Cardio (omite c√°lculo de riesgo y muestra 'Cardio')">Cardio</button>
                        <button type="button" class="btn" id="btn-programa-ecicep" title="Fijar modo ECICEP (reactiva c√°lculo de riesgo)">ECICEP</button>
                        <!-- BOT√ìN VER ALERTAS REPOSICIONADO -->
<button type="button" id="ver-alertas-btn" 
        onclick="mostrarAlertas()"
        style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important; 
               color: white !important; 
               border: none !important; 
               border-radius: 6px !important; 
               padding: 8px 16px !important; 
               font-weight: bold !important; 
               font-size: 12px !important; 
               text-transform: uppercase !important; 
               letter-spacing: 0.5px !important;
               cursor: pointer !important; 
               box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3) !important; 
               transition: all 0.2s ease !important;">
    üö® Alertas
</button>
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button type="button" class="btn-secondary" id="btn-nuevo-usuario" title="Limpiar todo y comenzar un nuevo ingreso" onclick="nuevoUsuario()">üÜï Nuevo usuario</button>
                    <button type="button" class="btn" id="btn-limpiar-form" title="Limpiar campos (mantiene RUN)" onclick="limpiarFormulario(true)">üßπ Limpiar</button>
                </div>
            </div>

            <fieldset>
                <legend>Datos del usuario</legend>
                <div class="campos-linea">
                    <label>RUN: <input type="text" name="run" id="run" required maxlength="13" style="width:180px;" value="{{ (request.form.get('run') or (usuario.run if usuario and usuario.run else request.args.get('run'))) or '' }}"></label>
                    <button type="button" onclick="testAutocompletado()" style="margin-left:10px; padding:5px 10px; background:#0066cc; color:white; border:none; border-radius:3px; cursor:pointer;">üß™ Test Autocompletado</button>
                    <label class="half" style="min-width:260px;">Nombre: <input type="text" name="nombre" id="nombre" required></label>
                    <label>Sexo:
                        <select name="sexo" id="sexo" required style="min-width:180px;max-width:220px;">
                            <option value="">-- Seleccione sexo --</option>
                            <option value="masculino" {% if request.form.get('sexo') == 'masculino' %}selected{% endif %}>Masculino</option>
                            <option value="femenino" {% if request.form.get('sexo') == 'femenino' %}selected{% endif %}>Femenino</option>
                        </select>
                    </label>
                    <label>Fecha de nacimiento:
                        <input type="text" id="fecha_nacimiento_display" inputmode="numeric" placeholder="dd/mm/aaaa" autocomplete="off" required style="min-width:180px;max-width:220px;">
                        <input type="hidden" name="fecha_nacimiento" id="fecha_nacimiento">
                    </label>
                    <script>
                        // Helpers para fecha de nacimiento: visible dd/mm/aaaa + hidden ISO (yyyy-mm-dd)
                        (function(){
                            function pad(n){ return String(n).padStart(2, '0'); }
                            function formatearFechaDMY(v){
                                const d = v.replace(/\D/g, '').slice(0,8);
                                const p1 = d.slice(0,2), p2 = d.slice(2,4), p3 = d.slice(4,8);
                                if (d.length <= 2) return p1;
                                if (d.length <= 4) return `${p1}/${p2}`;
                                return `${p1}/${p2}/${p3}`;
                            }
                            function parseFechaDMY(s){
                                if (!s) return null;
                                const d = s.replace(/\D/g, '');
                                if (d.length !== 8) return null;
                                const dd = parseInt(d.slice(0,2), 10);
                                const mm = parseInt(d.slice(2,4), 10);
                                const yyyy = parseInt(d.slice(4,8), 10);
                                if (!yyyy || !mm || !dd) return null;
                                const date = new Date(yyyy, mm - 1, dd);
                                if (date.getFullYear() !== yyyy || (date.getMonth()+1) !== mm || date.getDate() !== dd) return null;
                                return date;
                            }
                            function toISO(date){
                                if (!(date instanceof Date) || isNaN(date)) return '';
                                const y = date.getFullYear();
                                const m = pad(date.getMonth()+1);
                                const d = pad(date.getDate());
                                return `${y}-${m}-${d}`;
                            }
                            function fromISO(iso){
                                if (!iso || typeof iso !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '';
                                const [y,m,d] = iso.split('-').map(Number);
                                if (!y || !m || !d) return '';
                                return `${pad(d)}/${pad(m)}/${y}`;
                            }
                            function calcularEdadDesdeISO(iso){
                                if (!iso) return '';
                                const parts = iso.split('-');
                                if (parts.length !== 3) return '';
                                const anio = parseInt(parts[0], 10);
                                const mes = parseInt(parts[1], 10) - 1;
                                const dia = parseInt(parts[2], 10);
                                const nacimiento = new Date(anio, mes, dia);
                                if (isNaN(nacimiento.getTime())) return '';
                                const hoy = new Date();
                                let edad = hoy.getFullYear() - nacimiento.getFullYear();
                                const m = hoy.getMonth() - nacimiento.getMonth();
                                if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
                                    edad--;
                                }
                                return edad >= 0 ? edad : '';
                            }
                            function dispatch(el, type){ try { el && el.dispatchEvent(new Event(type, { bubbles: true })); } catch(_){} }

                            function validarYSyncFecha(){
                                const disp = document.getElementById('fecha_nacimiento_display');
                                const hid = document.getElementById('fecha_nacimiento');
                                const edadField = document.getElementById('edad');
                                if (!disp || !hid) return;
                                // formateo visual
                                const prevSelStart = disp.selectionStart;
                                const prevLen = disp.value.length;
                                disp.value = formatearFechaDMY(disp.value);
                                // mantener cursor en posici√≥n razonable
                                const delta = disp.value.length - prevLen;
                                try { if (document.activeElement === disp && typeof prevSelStart === 'number') disp.setSelectionRange(prevSelStart + (delta > 0 ? 1 : 0), prevSelStart + (delta > 0 ? 1 : 0)); } catch(_){ }

                                const date = parseFechaDMY(disp.value);
                                if (date){
                                    const iso = toISO(date);
                                    hid.value = iso;
                                    // Actualizar edad inmediata para feedback
                                    if (edadField){
                                        const e = calcularEdadDesdeISO(iso);
                                        edadField.value = e === '' ? '' : e;
                                    }
                                    // Dejar que scripts existentes reaccionen
                                    dispatch(hid, 'input');
                                    dispatch(hid, 'change');
                                    // Validaci√≥n sem√°ntica adicional (rangos 15..112) delegada a validarFechaNacimiento si existe
                                    try { if (typeof validarFechaNacimiento === 'function') validarFechaNacimiento(); } catch(_){ }
                                    disp.setCustomValidity('');
                                } else {
                                    hid.value = '';
                                    // No bloquear mientras escribe; solo marcar inv√°lido si tiene 8 d√≠gitos pero la fecha es imposible
                                    const digits = disp.value.replace(/\D/g, '');
                                    if (digits.length === 8) {
                                        disp.setCustomValidity('Fecha inv√°lida');
                                    } else {
                                        disp.setCustomValidity('');
                                    }
                                }
                            }

                            document.addEventListener('DOMContentLoaded', function(){
                                const disp = document.getElementById('fecha_nacimiento_display');
                                const hid = document.getElementById('fecha_nacimiento');
                                if (!disp || !hid) return;
                                // Inicializar visible desde hidden si viene pre-rellenado
                                if (hid.value) {
                                    const dmy = fromISO(hid.value);
                                    if (dmy) disp.value = dmy;
                                }
                                disp.addEventListener('input', validarYSyncFecha);
                                disp.addEventListener('blur', function(){
                                    validarYSyncFecha();
                                    try { disp.reportValidity(); } catch(_){ }
                                });
                            });
                        })();
                    </script>
                    <script>
                        // Funciones auxiliares para conversi√≥n de fechas
                        window.convertirFechaParaDB = function(fechaDDMMYYYY) {
                            if (!fechaDDMMYYYY || fechaDDMMYYYY.length !== 10) return '';
                            const partes = fechaDDMMYYYY.split('/');
                            if (partes.length !== 3) return '';
                            const dd = partes[0].padStart(2, '0');
                            const mm = partes[1].padStart(2, '0');
                            const yyyy = partes[2];
                            if (dd.length !== 2 || mm.length !== 2 || yyyy.length !== 4) return '';
                            return `${yyyy}-${mm}-${dd}`;
                        };
                        
                        window.convertirFechaDesdeDB = function(fechaYYYYMMDD) {
                            if (!fechaYYYYMMDD || fechaYYYYMMDD.length < 10) return '';
                            const fechaISO = fechaYYYYMMDD.slice(0, 10); // Solo YYYY-MM-DD
                            const partes = fechaISO.split('-');
                            if (partes.length !== 3) return '';
                            const yyyy = partes[0];
                            const mm = partes[1];
                            const dd = partes[2];
                            return `${dd}/${mm}/${yyyy}`;
                        };
                    </script>
                    <script>
                        // Configurar autoformato para fecha_ingreso y fechas cardiovasculares
                        // Replicando exactamente el patr√≥n de fecha_nacimiento
                        (function(){
                            function formatearFechaOtros(v){
                                const d = v.replace(/\D/g, '').slice(0,8);
                                const p1 = d.slice(0,2), p2 = d.slice(2,4), p3 = d.slice(4,8);
                                if (d.length <= 2) return p1;
                                if (d.length <= 4) return `${p1}/${p2}`;
                                return `${p1}/${p2}/${p3}`;
                            }

                            function configurarCampoFecha(inputId) {
                                const input = document.getElementById(inputId);
                                if (!input) return;
                                
                                function formatearCampo() {
                                    const prevSelStart = input.selectionStart;
                                    const prevLen = input.value.length;
                                    input.value = formatearFechaOtros(input.value);
                                    // mantener cursor en posici√≥n razonable
                                    const delta = input.value.length - prevLen;
                                    try { 
                                        if (document.activeElement === input && typeof prevSelStart === 'number') 
                                            input.setSelectionRange(prevSelStart + (delta > 0 ? 1 : 0), prevSelStart + (delta > 0 ? 1 : 0)); 
                                    } catch(_){ }
                                }
                                
                                input.addEventListener('input', formatearCampo);
                                input.addEventListener('paste', () => setTimeout(formatearCampo, 0));
                            }

                            document.addEventListener('DOMContentLoaded', function(){
                                configurarCampoFecha('fecha_ingreso');
                                configurarCampoFecha('cvRiesgoFecha');
                                configurarCampoFecha('cvActFecha');
                                configurarCampoFecha('cvTabFecha');
                                configurarCampoFecha('cvHeartsFecha');
                                configurarCampoFecha('vac_influenza_fecha');
                                configurarCampoFecha('vac_covid_fecha');
                                configurarCampoFecha('ekg_fecha');
                                configurarCampoFecha('ekgFecha');
                                configurarCampoFecha('psaFecha');
                                configurarCampoFecha('amFechaAplicacion');
                                configurarCampoFecha('amMasamaFecha');
                                configurarCampoFecha('amMaltratoFecha');
                                configurarCampoFecha('fechaAmputacion');
                                configurarCampoFecha('fecha_acuerdo');
                            });
                        })();
                    </script>
                    <script>
                        // Agregar event listener para calcular edad autom√°ticamente
                        document.addEventListener('DOMContentLoaded', function() {
                            const fechaNacField = document.getElementById('fecha_nacimiento');
                            const edadField = document.getElementById('edad');
                            
                            if (fechaNacField && edadField) {
                                // Funci√≥n para calcular y establecer edad
                                function calcularYEstablecerEdad() {
                                    console.log('üéÇ [AUTO] Calculando edad autom√°ticamente...');
                                    const fechaValue = fechaNacField.value;
                                    
                                    if (fechaValue) {
                                        console.log('üéÇ [AUTO] Fecha encontrada:', fechaValue);
                                        const fechaNac = new Date(fechaValue);
                                        const hoy = new Date();
                                        let edad = hoy.getFullYear() - fechaNac.getFullYear();
                                        const mes = hoy.getMonth() - fechaNac.getMonth();
                                        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                                            edad--;
                                        }
                                        
                                        edadField.value = edad;
                                        console.log('üéÇ [AUTO] Edad establecida:', edad);
                                    }
                                }
                                
                                // Event listeners
                                fechaNacField.addEventListener('change', calcularYEstablecerEdad);
                                fechaNacField.addEventListener('input', calcularYEstablecerEdad);
                                // Nota: el campo hidden no recibir√° blur; lo manejar√° el display.
                                
                                // Verificar si ya hay fecha al cargar la p√°gina
                                setTimeout(() => {
                                    if (fechaNacField.value) {
                                        console.log('üéÇ [AUTO] Fecha detectada al cargar:', fechaNacField.value);
                                        calcularYEstablecerEdad();
                                    }
                                }, 1000);
                            }
                        });
                    </script>
                </div>
                
                <div id="loading" class="loading">Buscando usuario...</div>
                <div id="usuario-encontrado" class="encontrado" style="display: none;">
                    <strong>Usuario encontrado en la base de datos. Los campos se han completado autom√°ticamente.</strong>
                </div>
                <div id="usuario-nuevo" class="nuevo-usuario" style="display: none; background: #e8f5e8; border: 1px solid #28a745; border-radius: 6px; padding: 12px; margin: 8px 0; color: #155724;">
                    <strong>üÜï Usuario nuevo</strong>
                    <p style="margin: 4px 0 0 0; font-size: 13px;">El RUN no fue encontrado en la base de datos. Puedes completar los campos para crear un nuevo usuario.</p>
                </div>
                <label>Edad (a√±os): <input type="text" name="edad" id="edad" readonly placeholder="--"></label>
                <script>
                    // Calcula edad en a√±os (entero) desde una fecha AAAA-MM-DD
                    function calcularEdadDesde(fechaStr) {
                        if (!fechaStr) return '';
                        const parts = fechaStr.split('-');
                        if (parts.length !== 3) return '';
                        const anio = parseInt(parts[0], 10);
                        const mes = parseInt(parts[1], 10) - 1; // 0-11
                        const dia = parseInt(parts[2], 10);
                        const nacimiento = new Date(anio, mes, dia);
                        if (isNaN(nacimiento.getTime())) return '';
                        const hoy = new Date();
                        let edad = hoy.getFullYear() - nacimiento.getFullYear();
                        const m = hoy.getMonth() - nacimiento.getMonth();
                        if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
                            edad--;
                        }
                        return edad >= 0 ? edad : '';
                    }
                    
                    // Funci√≥n global para debug
                    window.debugCalcularEdad = function() {
                        console.log('üîß [DEBUG] Forzando c√°lculo de edad');
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        const inputEdad = document.getElementById('edad');
                        console.log('üîß [DEBUG] Fecha actual:', inputFecha ? inputFecha.value : 'NO ENCONTRADO');
                        console.log('üîß [DEBUG] Campo edad:', inputEdad ? 'ENCONTRADO' : 'NO ENCONTRADO');
                        if (inputFecha && inputEdad) {
                            actualizarEdad();
                        }
                        return { fecha: inputFecha?.value, edad: inputEdad?.value };
                    };

                    function actualizarEdad() {
                        console.log('üéÇ Funci√≥n actualizarEdad() llamada');
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        const inputEdad = document.getElementById('edad');
                        
                        console.log('üìÖ Campo fecha_nacimiento encontrado:', !!inputFecha);
                        console.log('üî¢ Campo edad encontrado:', !!inputEdad);
                        
                        if (!inputFecha || !inputEdad) {
                            console.log('‚ùå No se encontraron elementos fecha_nacimiento o edad');
                            return;
                        }
                        
                        const fechaValue = inputFecha.value;
                        console.log('üìÖ Valor fecha de nacimiento:', fechaValue);
                        
                        if (!fechaValue) {
                            console.log('‚ùå No hay fecha de nacimiento');
                            inputEdad.value = '';
                            return;
                        }
                        
                        // C√°lculo directo de edad
                        try {
                            const fechaNac = new Date(fechaValue);
                            const hoy = new Date();
                            let edad = hoy.getFullYear() - fechaNac.getFullYear();
                            const mes = hoy.getMonth() - fechaNac.getMonth();
                            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                                edad--;
                            }
                            
                            console.log('üéÇ Edad calculada directamente:', edad);
                            inputEdad.value = edad;
                            console.log('‚úÖ Edad establecida en el campo:', inputEdad.value);
                        } catch (error) {
                            console.error('‚ùå Error calculando edad:', error);
                            inputEdad.value = '';
                        }
                        
                        validarFechaNacimiento();
                        
                        // Reaplicar estilos de PA seg√∫n nueva edad
                        try {
                            const psis = document.querySelector('input[name="presion_sistolica"]');
                            if (psis && psis.value) { 
                                console.log('ü©∫ Actualizando validaci√≥n de presi√≥n arterial');
                                psis.dispatchEvent(new Event('input')); 
                            }
                        } catch (e) {
                            console.log('‚ö†Ô∏è Error actualizando presi√≥n arterial:', e);
                        }
                    }

                    // Establece din√°micamente min/max en fecha de nacimiento para edades 15..112
                    function actualizarRangoFechaNacimiento() {
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        if (!inputFecha) return;
                        const hoy = new Date();
                        const pad = (n) => String(n).padStart(2, '0');
                        const fmt = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
                        const minDate = new Date(hoy.getFullYear() - 112, hoy.getMonth(), hoy.getDate()); // edad m√°xima 112
                        const maxDate = new Date(hoy.getFullYear() - 15, hoy.getMonth(), hoy.getDate());  // edad m√≠nima 15
                        inputFecha.min = fmt(minDate);
                        inputFecha.max = fmt(maxDate);
                    }

                    // Valida rango de edad 15..112 y muestra mensaje nativo
                    function validarFechaNacimiento() {
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        if (!inputFecha || !inputFecha.value) { inputFecha && inputFecha.setCustomValidity(''); return; }
                        const edad = calcularEdadDesde(inputFecha.value);
                        const edadNum = parseInt(edad, 10);
                        if (isNaN(edadNum)) { inputFecha.setCustomValidity('Fecha inv√°lida'); return; }
                        if (edadNum < 15 || edadNum > 112) {
                            if (edadNum < 15) {
                                inputFecha.setCustomValidity('‚ö†Ô∏è ECICEP requiere usuarios de 15 a√±os o m√°s. Edad actual: ' + edadNum + ' a√±os.');
                            } else {
                                inputFecha.setCustomValidity('‚ö†Ô∏è Edad muy alta (' + edadNum + ' a√±os). Verifica que la fecha sea correcta.');
                            }
                        } else {
                            inputFecha.setCustomValidity('');
                        }
                    }

                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('üéØ [EDAD] DOM cargado, inicializando c√°lculo de edad');
                        
                        const inputFecha = document.getElementById('fecha_nacimiento');
                        const inputEdad = document.getElementById('edad');
                        
                        console.log('üéØ [EDAD] Input fecha encontrado:', !!inputFecha);
                        console.log('üéØ [EDAD] Input edad encontrado:', !!inputEdad);
                        
                        // Rango din√°mico seg√∫n la fecha actual
                        actualizarRangoFechaNacimiento();
                        if (inputFecha) {
                            // Variable para evitar alerts repetidos
                            let alertMostrado = false;
                            let ultimaEdadValidada = null;
                            
                            // Calcular al cargar si ya hay valor
                            if (inputFecha.value) { 
                                console.log('üéØ [EDAD] Valor inicial detectado, calculando edad');
                                actualizarEdad(); 
                            }
                            
                            // Recalcular al modificar
                            ['change','input','blur'].forEach(ev => inputFecha.addEventListener(ev, function(e){
                                console.log('üéØ [EDAD] Evento', e.type, 'disparado en fecha_nacimiento');
                                actualizarEdad();
                                validarFechaNacimiento(); // Actualizar validaci√≥n HTML5
                                
                                // Resetear flag de alert cuando el usuario est√° editando
                                } else if (tabId === 'screening' && alertas && alertas.screening) {
                                    console.log('ü©∫ Procesando screening (BD):', alertas.screening);
                                    html = '<div style="padding:5px;font-size:11px;line-height:1.3">';
                                    const entries = Object.entries(alertas.screening || {});
                                    for (const [tipo, datos] of entries) {
                                        let icono = 'üìã';
                                        let estado = datos.estado || 'Pendiente';
                                        if (datos.vigente === true) {
                                            icono = 'üü¢';
                                            estado = `${estado} (Vigente)`;
                                        } else if (datos.vigente === false) {
                                            icono = 'üî¥';
                                            estado = `${estado} (Vencido)`;
                                        } else {
                                            icono = '‚ö™';
                                            estado = `${estado} (Sin datos)`;
                                        }
                                        html += `<div style=\"margin:1px 0;padding:2px\">${icono} ${tipo}: ${estado}</div>`;
                                        if (datos.fecha_ultimo) {
                                            html += `<div style=\"margin-left:15px;font-size:10px;color:#888\">√öltimo: ${datos.fecha_ultimo}</div>`;
                                        }
                                        if (datos.proxima_fecha) {
                                            html += `<div style=\"margin-left:15px;font-size:10px;color:#666\">Pr√≥ximo: ${datos.proxima_fecha}</div>`;
                                        }
                                    }
                                    html += '</div>';
                                inputFecha.style.backgroundColor = '';
                                inputFecha.value = '';
                                document.getElementById('edad').value = '--';
                            });
                        }
                        
                        // Funciones para formateo de fechas manuales
                        function soloNumeros(e) {
                            const k = e.key;
                            if (k.length > 1) return true; // teclas especiales (Backspace, Arrow, etc.)
                            if (/[0-9\/]/.test(k)) return true; // permitir n√∫meros y barras
                            e.preventDefault();
                            return false;
                        }

                        function formatearFecha(input) {
                            if (!input) return;
                            
                            // Usar la misma l√≥gica exacta que formatearFechaDMY
                            const prevSelStart = input.selectionStart;
                            const prevLen = input.value.length;
                            
                            // Aplicar formateo
                            const d = input.value.replace(/\D/g, '').slice(0,8);
                            const p1 = d.slice(0,2), p2 = d.slice(2,4), p3 = d.slice(4,8);
                            let formatted = '';
                            if (d.length <= 2) {
                                formatted = p1;
                            } else if (d.length <= 4) {
                                formatted = `${p1}/${p2}`;
                            } else {
                                formatted = `${p1}/${p2}/${p3}`;
                            }
                            
                            // Actualizar valor
                            input.value = formatted;
                            
                            // Mantener cursor en posici√≥n razonable
                            const delta = formatted.length - prevLen;
                            try {
                                if (document.activeElement === input && typeof prevSelStart === 'number') {
                                    const newPos = prevSelStart + (delta > 0 ? 1 : 0);
                                    input.setSelectionRange(newPos, newPos);
                                }
                            } catch(_) { }
                        }

                        function validarFechaCompleta(input) {
                            const v = input.value.trim();
                            if (!v) return;
                            const regex = /^([0-3]\d)\/([0-1]\d)\/(\d{4})$/;
                            if (!regex.test(v)) {
                                input.style.borderColor = '#ef4444';
                                input.setCustomValidity('Formato incorrecto (dd/mm/aaaa)');
                            } else {
                                const [, d, m, y] = regex.exec(v);
                                const date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
                                if (date.getDate() != d || date.getMonth() != m - 1 || date.getFullYear() != y) {
                                    input.style.borderColor = '#ef4444';
                                    input.setCustomValidity('Fecha inv√°lida');
                                } else {
                                    input.style.borderColor = '';
                                    input.setCustomValidity('');
                                }
                            }
                        }

                        function convertirFechaParaDB(fechaDD_MM_YYYY) {
                            // Convierte de DD/MM/YYYY a YYYY-MM-DD para PostgreSQL
                            if (!fechaDD_MM_YYYY || fechaDD_MM_YYYY.length !== 10) return fechaDD_MM_YYYY;
                            const regex = /^([0-3]\d)\/([0-1]\d)\/(\d{4})$/;
                            const match = regex.exec(fechaDD_MM_YYYY);
                            if (!match) return fechaDD_MM_YYYY;
                            const [, d, m, y] = match;
                            return `${y}-${m}-${d}`;
                        }
                    });
                </script>
                <div class="campos-linea">
                    <label class="half">Direcci√≥n: <input type="text" name="direccion" id="direccion" style="width:100%;"></label>
                    <label>Tel√©fono: <input type="text" name="telefono" id="telefono" placeholder="Ej: +56912345678" style="min-width:200px;max-width:250px;"></label>
                    <label>Fecha de ingreso: <input type="text" name="fecha_ingreso" id="fecha_ingreso" style="min-width:200px;max-width:250px;" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric"></label>
                </div>

                <!-- Datos demogr√°ficos -->
                <div class="campos-linea">
                    <label class="half">Nivel educacional:
                        <select name="nivel_educacional" id="nivel_educacional" style="min-width:200px;">
                            <option value="">-- Seleccione --</option>
                            <option value="Analfabeto">Analfabeto</option>
                            <option value="B√°sica incompleta">B√°sica incompleta</option>
                            <option value="B√°sica completa">B√°sica Completa</option>
                            <option value="Media incompleta">Media incompleta</option>
                            <option value="Media completa">Media completa</option>
                            <option value="Universitaria incompleta">Universitaria incompleta</option>
                            <option value="Universitaria completa">Universitaria completa</option>
                        </select>
                    </label>
                    <label>Origen √©tnico:
                        <select name="origen_etnico" id="origen_etnico" style="min-width:160px;">
                            <option value="">-- Seleccione --</option>
                            <option value="Chileno">üá®üá± Chileno</option>
                            <option value="Mapuche">Mapuche</option>
                            <option value="Extranjero">Extranjero</option>
                        </select>
                    </label>
                    <label>Estado civil:
                        <select name="estado_civil" id="estado_civil" style="min-width:160px;">
                            <option value="">-- Seleccione --</option>
                            <option value="Soltero">Soltero</option>
                            <option value="Casado">Casado</option>
                            <option value="Convive">Convive</option>
                            <option value="Separado">Seprado</option>
                            <option value="Viudo">Viudo</option>
                        </select>
                    </label>
                </div>
                <small>Fecha de ingreso al sistema (se completa autom√°ticamente al guardar si no se especifica)</small>
                <div class="campos-linea">
                    <label>Categor√≠a:
                        <select name="categoria_id" id="categoria_id" style="min-width:150px;">
                            <option value="">-- Seleccione categor√≠a --</option>
                            <option value="0">G0</option>
                            {% for cat in categorias %}
                                <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                            {% endfor %}
                        </select>
                    </label>
                    <label>Sector:
                        <select name="sector_id" id="sector_id" style="min-width:180px;">
                            <option value="">-- Seleccione sector --</option>
                            {% for sec in sectores %}
                                <option value="{{ sec.id }}">{{ sec.nombre|upper }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
                
                <!-- T√≠tulo de patolog√≠as con bot√≥n de colapsar -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <label for="patologias-container" style="margin-bottom: 0; font-weight: 600; color: #374151;">Patolog√≠as (Sistema ECICEP 2025):</label>
                    <button type="button" id="btn-toggle-patologias" onclick="togglePatologiasContainer()" 
                            style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s;">
                        üëÅÔ∏è Mostrar Patolog√≠as
                    </button>
                </div>
                
                <!-- Resumen de patolog√≠as guardadas (desde usuario_patologias) -->
                <div id="patologias-container" class="patologias-resumen" style="margin: 8px 0 12px 0; border-top: 1px solid #e5e7eb; padding-top: 12px; position: relative;">
                    <div class="patologias-titulo" style="color: #059669; font-weight: 600;">Patolog√≠as Guardadas en BD:</div>
                    
                    <div id="patologias-guardadas" class="pat-badges" style="border: 1px solid #059669; border-radius: 4px; background: #ecfdf5; margin-right: 0; position: relative;">
                        <span class="pat-empty" style="color: #6b7280;">Sin patolog√≠as guardadas en base de datos</span>
                    </div>
                    <!-- Estado inline para guardado independiente de patolog√≠as -->
                    <div id="patologiasStatus" class="mini-status" style="margin-top:6px; min-height:18px; font-weight:500;"></div>
                    <div id="indicador-cambios-patologias" style="display:none; margin-top:4px; font-size:12px; color:#b45309; font-weight:500;">
                        ‚úèÔ∏è Cambios de selecci√≥n pendientes (no guardados todav√≠a)
                    </div>
                    
                    <!-- Botones de gesti√≥n de patolog√≠as -->
                    <div id="botones-gestion-patologias" style="margin-top: 8px; display: block; opacity: 0.5; pointer-events: none; padding: 10px; border: 2px solid #ccc; border-radius: 5px; background: #f9f9f9;">
                        <div style="margin-bottom: 4px;">
                            <small style="color: #6c757d;">üí° Los botones se habilitar√°n al ingresar un RUN v√°lido</small>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" id="btn-guardar-patologias" onclick="window.guardarPatologiasIndependiente()" 
                                    style="background: #198754; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500;" 
                                    title="Guardar solo las patolog√≠as seleccionadas" disabled>
                                üíæ Guardar Patolog√≠as
                            </button>
                            <button type="button" id="btn-modificar-patologias" onclick="window.modificarPatologias(event)" 
                                    style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500;" 
                                    disabled aria-disabled="true">
                                ‚úèÔ∏è Modificar Patolog√≠as
                            </button>
                        </div>
                    </div>
                </div>

                </div>
                
                <!-- OVERLAY PARA CERRAR BARRA LATERAL - Fondo transparente clickeable -->
                <div id="sidebar-overlay" 
                     class="sidebar-overlay" 
                     onclick="cerrarAlertas()" 
                     onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();cerrarAlertas();}" 
                     tabindex="0" 
                     role="button" 
                     style="display: none;" 
                     title="Presiona Enter o Espacio para cerrar alertas"
                     aria-label="Cerrar panel de alertas"></div>
                
                <script>
                
                // FUNCI√ìN SIMPLE PARA CERRAR ALERTAS - DEFINIDA INMEDIATAMENTE
                function cerrarAlertas() {
                    console.log('üîò cerrarAlertas() llamada');
                    const sidebar = document.getElementById('health-alerts-floating');
                    const overlay = document.getElementById('sidebar-overlay');
                    const btn = document.getElementById('ver-alertas-btn');
                    
                    if (sidebar && overlay) {
                        sidebar.classList.remove('show');
                        overlay.classList.remove('show');
                        sidebar.style.display = 'none';
                        overlay.style.display = 'none';
                        
                        if (btn) {
                            btn.innerHTML = 'üö® Alertas';
                        }
                        
                        console.log('‚úÖ Alertas cerradas correctamente');
                    } else {
                        console.error('‚ùå Error: elementos no encontrados');
                    }
                }
                
                // Hacer funci√≥n globalmente disponible inmediatamente
                window.cerrarAlertas = cerrarAlertas;
                
                // Eliminar cualquier bot√≥n flotante no deseado que pueda estar interfiriendo
                document.addEventListener('DOMContentLoaded', function() {
                    // Buscar y eliminar botones con clases problem√°ticas
                    const problematicSelectors = [
                        '#chkToggle', 
                        '.checklist-toggle', 
                        'button[title="Checklist"]',
                        'button[style*="position: fixed"][style*="right: 300px"]'
                    ];
                    
                    problematicSelectors.forEach(selector => {
                        const elements = document.querySelectorAll(selector);
                        elements.forEach(el => {
                            if (el && el.id !== 'ver-alertas-btn') {
                                el.remove();
                                console.log('Eliminado elemento interferente:', selector);
                            }
                        });
                    });
                    
                    // Asegurar que nuestro bot√≥n rojo sea visible
                    const redButton = document.getElementById('ver-alertas-btn');
                    if (redButton) {
                        redButton.style.display = 'block';
                        redButton.style.visibility = 'visible';
                        console.log('‚úÖ Bot√≥n rojo VER ALERTAS asegurado como visible');
                    }
                });
                </script>

                <!-- CUADRO FLOTANTE DE ALERTAS DE VIGENCIA -->
                <div id="health-alerts-floating" class="health-alerts-floating" style="display: none;">
                    <div class="alerts-titlebar">
                        <div class="alerts-title">
                            <i class="fas fa-bell"></i>
                            <span>Alertas de Vigencia</span>
                            <span id="alerts-count" class="badge badge-light" style="background: rgba(255,255,255,0.3); color: white; font-size: 10px;">-</span>
                        </div>
                        <div class="alerts-controls">
                            <button type="button" onclick="cerrarAlertas()" class="alert-btn" title="Cerrar panel">
                                <i class="fas fa-times"></i> Cerrar
                            </button>
                        </div>
                    </div>
                    
                    <div class="alerts-tabs">
                        <button type="button" class="alert-tab active" data-tab="examenes">Ex√°menes</button>
                        <button type="button" class="alert-tab" data-tab="screening">Screening</button>
                        <button type="button" class="alert-tab" data-tab="procedimientos">Procedimientos</button>
                        <button type="button" class="alert-tab" data-tab="tratamientos">Tratamientos</button>
                        <button type="button" class="alert-tab" data-tab="cardiovascular">Cardiovascular</button>
                    </div>
                    
                    <div class="alerts-content">
                        <div id="alert-examenes" class="alert-category active">
                            <div class="loading-alerts">
                                <i class="fas fa-spinner fa-spin"></i> Cargando ex√°menes...
                            </div>
                        </div>
                        <div id="alert-screening" class="alert-category">
                            <div class="loading-alerts">
                                <i class="fas fa-spinner fa-spin"></i> Cargando screening...
                            </div>
                        </div>
                        <div id="alert-procedimientos" class="alert-category">
                            <div class="loading-alerts">
                                <i class="fas fa-spinner fa-spin"></i> Cargando procedimientos...
                            </div>
                        </div>
                        <div id="alert-tratamientos" class="alert-category">
                            <div class="loading-alerts">
                                <i class="fas fa-spinner fa-spin"></i> Cargando tratamientos...
                            </div>
                        </div>
                        <div id="alert-cardiovascular" class="alert-category">
                            <div class="loading-alerts">
                                <i class="fas fa-spinner fa-spin"></i> Cargando riesgo cardiovascular...
                            </div>
                        </div>
                        
                        <!-- Mensaje de colapso -->
                        <div id="collapsed-message" style="display: none; text-align: center; padding: 20px; color: #6c757d;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px; color: #ffc107;"></i>
                            <div style="font-weight: 600;">¬°Revisar!</div>
                            <div style="font-size: 12px;">Hay alertas pendientes</div>
                        </div>
                    </div>
                </div>



                <!-- Contenedor de patolog√≠as - colapsado por defecto -->
                <div id="patologias-main-container" style="display: none; transition: all 0.3s ease;">
                    <div style="margin: 8px 0 12px 0; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" class="btn-categoria-control" onclick="expandirTodasFamilias()" style="background: #198754; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                            üìÇ Expandir Todas
                        </button>
                        <button type="button" class="btn-categoria-control" onclick="contraerTodasFamilias()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                            üìÅ Contraer Todas
                        </button>
                        <button type="button" class="btn-categoria-control" onclick="expandirSoloSeleccionadasFamilias()" style="background: #0d6efd; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: background 0.2s;">
                            ‚úÖ Expandir Solo Seleccionadas
                        </button>
                    </div>
<!-- === CONTENEDOR √öNICO DE PATOLOG√çAS === -->
<div class="patologias-ecicep-container" style="max-height: none; min-height: 600px; overflow-y: visible; border: 1.5px solid var(--line); border-radius: 10px; padding: 24px 18px 18px 18px; background: #f8f9fa; box-shadow: 0 2px 12px rgba(13,110,253,0.07);">
<!-- ===================== CATEGOR√çA 01: PATOLOG√çAS M√öSCULO-ESQUEL√âTICAS ===================== -->
<div class="categoria-seccion" id="cat-musculoesqueleticas" style="display:block;">
  <div class="categoria-header" 
       onclick="toggleCategoria('content-musculoesqueleticas')"
       onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleCategoria('content-musculoesqueleticas');}"
       tabindex="0"
       role="button"
       aria-expanded="false"
       aria-controls="content-musculoesqueleticas"
       title="Expandir/contraer secci√≥n de patolog√≠as m√∫sculo-esquel√©ticas">
    <h4>ü¶¥ PATOLOG√çAS M√öSCULO-ESQUEL√âTICAS
      <span class="categoria-badge" id="badge-musculoesqueleticas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-musculoesqueleticas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-musculoesqueleticas">

    <!-- ===== Familia: Artritis reumatoidea (1) ===== -->
    <div class="familia" data-familia-id="fam-artritis-reumatoidea" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-artritis-reumatoidea-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-artritis-reumatoidea-block', this)">+</button>
        Artritis reumatoidea <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-artritis-reumatoidea-block">

        <!-- M05 ‚Äî AR con factor reumatoide (seropositiva) -->
        <div class="subcategoria-header" style="background:#e7f0ff;padding:8px 12px;margin:6px 0;border-left:3px solid #0d6efd;font-weight:600;font-size:12px;">
          M05 ‚Äî Artritis reumatoide con factor reumatoide (seropositiva)
        </div>

        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M050" value="M05.0"><label for="M050"><strong>M05.0 ‚Äî S√≠ndrome de Felty</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M051" value="M05.1"><label for="M051"><strong>M05.1 ‚Äî Enfermedad pulmonar reumatoide con AR</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M052" value="M05.2"><label for="M052"><strong>M05.2 ‚Äî Vasculitis reumatoide con AR</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M053" value="M05.3"><label for="M053"><strong>M05.3 ‚Äî Cardiopat√≠a reumatoide con AR</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M058" value="M05.8"><label for="M058"><strong>M05.8 ‚Äî Otras AR con factor reumatoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M059" value="M05.9"><label for="M059"><strong>M05.9 ‚Äî AR con factor reumatoide, no especificada</strong></label></div>

        <!-- M06 ‚Äî Otras formas de AR (incluye seronegativa) -->
        <div class="subcategoria-header" style="background:#e7f0ff;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #0d6efd;font-weight:600;font-size:12px;">
          M06 ‚Äî Otras artritis reumatoides (incluye seronegativa)
        </div>

        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M060" value="M06.0"><label for="M060"><strong>M06.0 ‚Äî AR seronegativa (sin factor reumatoide)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M061" value="M06.1"><label for="M061"><strong>M06.1 ‚Äî Enfermedad de Still del adulto</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M062" value="M06.2"><label for="M062"><strong>M06.2 ‚Äî Bursitis reumatoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M063" value="M06.3"><label for="M063"><strong>M06.3 ‚Äî N√≥dulo reumatoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M064" value="M06.4"><label for="M064"><strong>M06.4 ‚Äî Poliartropat√≠a inflamatoria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M068" value="M06.8"><label for="M068"><strong>M06.8 ‚Äî Otras AR especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M069" value="M06.9"><label for="M069"><strong>M06.9 ‚Äî Artritis reumatoide, no especificada</strong></label></div>
      </div>
    </div>
    <!-- ===== FIN Familia: Artritis reumatoidea ===== -->

    <!-- ===== Familia: Artrosis de rodilla, cadera u otro tipo (1) ===== -->
    <div class="familia" data-familia-id="fam-artrosis" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-artrosis-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-artrosis-block', this)">+</button>
        Artrosis de rodilla, cadera u otro tipo <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-artrosis-block">

        <!-- M15 ‚Äî Poliartr(osis)/Poliosteoartritis -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:6px 0;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M15 ‚Äî Poliartr(osis) / Poliosteoartritis
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M150" value="M15.0"><label for="M150"><strong>M15.0 ‚Äî Artrosis generalizada primaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M151" value="M15.1"><label for="M151"><strong>M15.1 ‚Äî N√≥dulos de Heberden (con artropat√≠a)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M152" value="M15.2"><label for="M152"><strong>M15.2 ‚Äî N√≥dulos de Bouchard (con artropat√≠a)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M153" value="M15.3"><label for="M153"><strong>M15.3 ‚Äî Artritis m√∫ltiple secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M154" value="M15.4"><label for="M154"><strong>M15.4 ‚Äî (Osteo)artritis erosiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M158" value="M15.8"><label for="M158"><strong>M15.8 ‚Äî Otras poliosteoartritis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M159" value="M15.9"><label for="M159"><strong>M15.9 ‚Äî Poliosteoartritis, no especificada</strong></label></div>

        <!-- M16 ‚Äî Coxartrosis (cadera) -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M16 ‚Äî Artrosis de cadera (coxartrosis)
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M160" value="M16.0"><label for="M160"><strong>M16.0 ‚Äî Artrosis primaria bilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M161" value="M16.1"><label for="M161"><strong>M16.1 ‚Äî Artrosis primaria unilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M162" value="M16.2"><label for="M162"><strong>M16.2 ‚Äî Artrosis bilateral por displasia de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M163" value="M16.3"><label for="M163"><strong>M16.3 ‚Äî Artrosis unilateral por displasia de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M164" value="M16.4"><label for="M164"><strong>M16.4 ‚Äî Artrosis postraum√°tica bilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M165" value="M16.5"><label for="M165"><strong>M16.5 ‚Äî Artrosis postraum√°tica unilateral de cadera</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M166" value="M16.6"><label for="M166"><strong>M16.6 ‚Äî Otras artrosis secundarias de cadera, bilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M167" value="M16.7"><label for="M167"><strong>M16.7 ‚Äî Otras artrosis secundarias de cadera, unilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M169" value="M16.9"><label for="M169"><strong>M16.9 ‚Äî Artrosis de cadera, no especificada</strong></label></div>

        <!-- M17 ‚Äî Gonartrosis (rodilla) -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M17 ‚Äî Artrosis de rodilla (gonartrosis)
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M170" value="M17.0"><label for="M170"><strong>M17.0 ‚Äî Artrosis primaria bilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M171" value="M17.1"><label for="M171"><strong>M17.1 ‚Äî Artrosis primaria unilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M172" value="M17.2"><label for="M172"><strong>M17.2 ‚Äî Artrosis postraum√°tica bilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M173" value="M17.3"><label for="M173"><strong>M17.3 ‚Äî Artrosis postraum√°tica unilateral de rodilla</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M174" value="M17.4"><label for="M174"><strong>M17.4 ‚Äî Otras artrosis secundarias de rodilla, bilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M175" value="M17.5"><label for="M175"><strong>M17.5 ‚Äî Otras artrosis secundarias de rodilla, unilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M179" value="M17.9"><label for="M179"><strong>M17.9 ‚Äî Artrosis de rodilla, no especificada</strong></label></div>

        <!-- M18 ‚Äî Artrosis primera CMC -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M18 ‚Äî Artrosis de la primera articulaci√≥n carpometacarpiana (CMC)
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M180" value="M18.0"><label for="M180"><strong>M18.0 ‚Äî Artrosis primaria bilateral de las primeras CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M181" value="M18.1"><label for="M181"><strong>M18.1 ‚Äî Artrosis primaria unilateral de la primera CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M182" value="M18.2"><label for="M182"><strong>M18.2 ‚Äî Artrosis postraum√°tica bilateral de las primeras CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M183" value="M18.3"><label for="M183"><strong>M18.3 ‚Äî Artrosis postraum√°tica unilateral de la primera CMC</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M184" value="M18.4"><label for="M184"><strong>M18.4 ‚Äî Otras artrosis secundarias de las primeras CMC, bilaterales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M185" value="M18.5"><label for="M185"><strong>M18.5 ‚Äî Otras artrosis secundarias de la primera CMC, unilateral</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M189" value="M18.9"><label for="M189"><strong>M18.9 ‚Äî Artrosis de la primera CMC, no especificada</strong></label></div>

        <!-- M19 ‚Äî Otras / no especificadas -->
        <div class="subcategoria-header" style="background:#fff6e6;padding:8px 12px;margin:12px 0 6px;border-left:3px solid #ffb300;font-weight:600;font-size:12px;">
          M19 ‚Äî Otras artrosis y artrosis no especificadas
        </div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M190" value="M19.0"><label for="M190"><strong>M19.0 ‚Äî Artrosis primaria de otras articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M191" value="M19.1"><label for="M191"><strong>M19.1 ‚Äî Artrosis postraum√°tica de otras articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M192" value="M19.2"><label for="M192"><strong>M19.2 ‚Äî Artrosis secundaria de otras articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="M199" value="M19.9"><label for="M199"><strong>M19.9 ‚Äî Artrosis, no especificada</strong></label></div>

      </div>
    </div>
        <!-- ===== FIN Familia: Artrosis ===== -->

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion cat-musculoesqueleticas -->

        <!-- ===================== CATEGOR√çA 02: PATOLOG√çAS CARDIOVASCULARES ===================== -->
        <div class="categoria-seccion" id="cat-cardiovascular" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-cardiovascular')">
    <h4>‚ù§Ô∏è PATOLOG√çAS CARDIOVASCULARES
      <span class="categoria-badge" id="badge-cardiovascular">0</span>
      </h4>
    <button type="button" class="categoria-toggle" id="toggle-cardiovascular">+</button>
  </div>

    <div class="categoria-content collapsed" id="content-cardiovascular">

        <!-- ===== Familia: Hipertensi√≥n (1) ===== -->
        <div class="familia" data-familia-id="fam-hta" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hta-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hta-block', this)">+</button>
        Hipertensi√≥n <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-hta-block">
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I10" value="I10"><label for="I10"><strong>I10 ‚Äî Hipertensi√≥n esencial (primaria)</strong></label></div>

  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I110" value="I11.0"><label for="I110"><strong>I11.0 ‚Äî Cardiopat√≠a hipertensiva con insuficiencia cardiaca</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I119" value="I11.9"><label for="I119"><strong>I11.9 ‚Äî Cardiopat√≠a hipertensiva, no especificada</strong></label></div>

  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I120" value="I12.0"><label for="I120"><strong>I12.0 ‚Äî Enfermedad renal hipertensiva con insuficiencia renal</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I129" value="I12.9"><label for="I129"><strong>I12.9 ‚Äî Enfermedad renal hipertensiva, no especificada</strong></label></div>

  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I130" value="I13.0"><label for="I130"><strong>I13.0 ‚Äî Cardiopat√≠a y enfermedad renal hipertensivas con insuficiencia cardiaca</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I131" value="I13.1"><label for="I131"><strong>I13.1 ‚Äî Cardiopat√≠a y enfermedad renal hipertensivas con insuficiencia renal</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I132" value="I13.2"><label for="I132"><strong>I13.2 ‚Äî Cardiopat√≠a y enfermedad renal hipertensivas con insuficiencia cardiaca y renal</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I139" value="I13.9"><label for="I139"><strong>I13.9 ‚Äî Cardiopat√≠a y enfermedad renal hipertensivas, no especificadas</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Isquemia cerebral transitoria (TIA) (1) ===== -->
    <div class="familia" data-familia-id="fam-tia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tia-block', this)">+</button>
        Isquemia cerebral transitoria (TIA) <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-tia-block">
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G450" value="G45.0"><label for="G450"><strong>G45.0 ‚Äî S√≠ndrome de la arteria vertebrobasilar</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G451" value="G45.1"><label for="G451"><strong>G45.1 ‚Äî Infarto cerebral transitorio</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G452" value="G45.2"><label for="G452"><strong>G45.2 ‚Äî AIT por arteria carot√≠dea</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G453" value="G45.3"><label for="G453"><strong>G45.3 ‚Äî Amaurosis fugaz</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G454" value="G45.4"><label for="G454"><strong>G45.4 ‚Äî AIT de m√∫ltiples y bilaterales arterias</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G458" value="G45.8"><label for="G458"><strong>G45.8 ‚Äî Otros s√≠ndromes isqu√©micos transitorios</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G459" value="G45.9"><label for="G459"><strong>G45.9 ‚Äî AIT, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedad cerebrovascular / ACV / AVE (2) ===== -->
    <div class="familia" data-familia-id="fam-acv" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-acv-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-acv-block', this)">+</button>
        Enfermedad cerebrovascular / ACV / AVE <span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-acv-block">
        <!-- G46.0‚ÄìG46.8 -->
        <div class="subcategoria-header banner-cerebrovascular">G46.0 ‚Äî S√≠ndrome vascular cerebral en enfermedades cerebrovasculares, hemiplejia</div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G461" value="G46.1"><label for="G461"><strong>G46.1 ‚Äî S√≠ndrome de arteria cerebral anterior</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G462" value="G46.2"><label for="G462"><strong>G46.2 ‚Äî S√≠ndrome de arteria cerebral media</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G463" value="G46.3"><label for="G463"><strong>G46.3 ‚Äî S√≠ndrome de arteria cerebral posterior</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G464" value="G46.4"><label for="G464"><strong>G46.4 ‚Äî S√≠ndrome de arteria cerebelosa</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G465" value="G46.5"><label for="G465"><strong>G46.5 ‚Äî S√≠ndrome de tallo cerebral</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G466" value="G46.6"><label for="G466"><strong>G46.6 ‚Äî S√≠ndrome de arteria vertebral</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G467" value="G46.7"><label for="G467"><strong>G46.7 ‚Äî S√≠ndromes lacunares</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="G468" value="G46.8"><label for="G468"><strong>G46.8 ‚Äî Otros s√≠ndromes vasculares cerebrales</strong></label></div>

    <!-- I64 convertido a checklist -->
    <div class="subcategoria-header banner-cerebrovascular" style="display:flex;align-items:center;gap:8px;">
        <span>I64 ‚Äî Accidente cerebrovascular</span>
        <button type="button" class="familia-toggle" style="padding:0 6px;font-size:0.85em;" onclick="event.stopPropagation();toggleCollapse('i64-subopciones', this)">+</button>
    </div>
    <div id="i64-subopciones" class="collapsed" style="margin-left:18px;">
        <div class="patologia-item">
            <input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I64H" value="I64-H">
            <label for="I64H"><strong>I64 (H) ‚Äî Accidente cerebrovascular hemorr√°gico (clasificado cl√≠nicamente)</strong></label>
        </div>
        <div class="patologia-item">
            <input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I64I" value="I64-I">
            <label for="I64I"><strong>I64 (I) ‚Äî Accidente cerebrovascular isqu√©mico (clasificado cl√≠nicamente)</strong></label>
        </div>
        <div class="patologia-item">
            <input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I64N" value="I64">
            <label for="I64N"><strong>I64 ‚Äî Accidente cerebrovascular, no especificado como hemorr√°gico o isqu√©mico</strong></label>
        </div>
    </div>

  <!-- I67.0, I67.1, I67.2, I67.3, I67.4, I67.5, I67.7, I67.8, I67.9 -->
  <div class="subcategoria-header banner-cerebrovascular">I67.0 ‚Äî Dissecci√≥n de arterias cerebrales (y otras anomal√≠as vasculares)</div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I671" value="I67.1"><label for="I671"><strong>I67.1 ‚Äî Aneurisma cerebral, no rotura</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I672" value="I67.2"><label for="I672"><strong>I67.2 ‚Äî Aterosclerosis cerebral</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I673" value="I67.3"><label for="I673"><strong>I67.3 ‚Äî Leucoencefalopat√≠a vascular progresiva</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I674" value="I67.4"><label for="I674"><strong>I67.4 ‚Äî Encefalopat√≠a hipertensiva</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I675" value="I67.5"><label for="I675"><strong>I67.5 ‚Äî Oclusi√≥n y estenosis de arterias precerebrales, no especificadas</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I677" value="I67.7"><label for="I677"><strong>I67.7 ‚Äî Arteritis cerebral, no clasificada en otra parte</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I678" value="I67.8"><label for="I678"><strong>I67.8 ‚Äî Otras enfermedades cerebrovasculares especificadas</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I679" value="I67.9"><label for="I679"><strong>I67.9 ‚Äî Enfermedad cerebrovascular, no especificada</strong></label></div>

  <!-- I68.0, I68.1, I68.2, I68.8 -->
  <div class="subcategoria-header banner-cerebrovascular">I68.0 ‚Äî Trastornos cerebrovasculares en enfermedades infecciosas y parasitarias</div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I681" value="I68.1"><label for="I681"><strong>I68.1 ‚Äî Trastornos cerebrovasculares en enfermedades neopl√°sicas</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I682" value="I68.2"><label for="I682"><strong>I68.2 ‚Äî Trastornos cerebrovasculares en enfermedades sist√©micas del tejido conectivo</strong></label></div>
  <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I688" value="I68.8"><label for="I688"><strong>I68.8 ‚Äî Trastornos cerebrovasculares en otras enfermedades clasificadas en otra parte</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedades cardiovasculares / IAM / cardiopat√≠a isqu√©mica (2) ===== -->
    <div class="familia" data-familia-id="fam-iam-isco" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-iam-isco-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-iam-isco-block', this)">+</button>
        Enfermedades cardiovasculares / IAM / cardiopat√≠a isqu√©mica<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-iam-isco-block">
        <!-- I20.0, I20.1, I20.8, I20.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I200" value="I20.0"><label for="I200"><strong>I20.0 ‚Äî Angina inestable</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I201" value="I20.1"><label for="I201"><strong>I20.1 ‚Äî Angina pectoris con espasmo documentado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I208" value="I20.8"><label for="I208"><strong>I20.8 ‚Äî Otras formas de angina de pecho</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I209" value="I20.9"><label for="I209"><strong>I20.9 ‚Äî Angina de pecho, no especificada</strong></label></div>

        <!-- I21.0‚ÄìI21.4, I21.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I210" value="I21.0"><label for="I210"><strong>I21.0 ‚Äî Infarto agudo de miocardio de pared anterior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I211" value="I21.1"><label for="I211"><strong>I21.1 ‚Äî IAM de pared inferior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I212" value="I21.2"><label for="I212"><strong>I21.2 ‚Äî IAM de otras localizaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I213" value="I21.3"><label for="I213"><strong>I21.3 ‚Äî IAM no especificado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I214" value="I21.4"><label for="I214"><strong>I21.4 ‚Äî IAM subendoc√°rdico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I219" value="I21.9"><label for="I219"><strong>I21.9 ‚Äî IAM, no especificado</strong></label></div>

        <!-- I22.0, I22.1, I22.8, I22.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I220" value="I22.0"><label for="I220"><strong>I22.0 ‚Äî IAM subsecuente de pared anterior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I221" value="I22.1"><label for="I221"><strong>I22.1 ‚Äî IAM subsecuente de pared inferior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I228" value="I22.8"><label for="I228"><strong>I22.8 ‚Äî IAM subsecuente de otras localizaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I229" value="I22.9"><label for="I229"><strong>I22.9 ‚Äî IAM subsecuente, no especificado</strong></label></div>

        <!-- I25.0‚ÄìI25.6, I25.8, I25.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I250" value="I25.0"><label for="I250"><strong>I25.0 ‚Äî Enfermedad coronaria ateroscler√≥tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I251" value="I25.1"><label for="I251"><strong>I25.1 ‚Äî Enfermedad coronaria ateroscler√≥tica de vasos nativos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I252" value="I25.2"><label for="I252"><strong>I25.2 ‚Äî Infarto antiguo de miocardio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I253" value="I25.3"><label for="I253"><strong>I25.3 ‚Äî Aneurisma de coraz√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I254" value="I25.4"><label for="I254"><strong>I25.4 ‚Äî Complicaciones isqu√©micas cr√≥nicas del coraz√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I255" value="I25.5"><label for="I255"><strong>I25.5 ‚Äî Miocardiopat√≠a isqu√©mica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I256" value="I25.6"><label for="I256"><strong>I25.6 ‚Äî Isquemia silente del miocardio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I258" value="I25.8"><label for="I258"><strong>I25.8 ‚Äî Otras enfermedades isqu√©micas cr√≥nicas del coraz√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I259" value="I25.9"><label for="I259"><strong>I25.9 ‚Äî Enfermedad isqu√©mica cr√≥nica del coraz√≥n, no especificada</strong></label></div>

        <!-- I51.0, I51.4‚ÄìI51.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I510" value="I51.0"><label for="I510"><strong>I51.0 ‚Äî Defecto de pared cardiaca adquirido</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I514" value="I51.4"><label for="I514"><strong>I51.4 ‚Äî Miocarditis, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I515" value="I51.5"><label for="I515"><strong>I51.5 ‚Äî Degeneraci√≥n mioc√°rdica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I516" value="I51.6"><label for="I516"><strong>I51.6 ‚Äî Enfermedad cardiaca no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I517" value="I51.7"><label for="I517"><strong>I51.7 ‚Äî Cardiomegalia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I518" value="I51.8"><label for="I518"><strong>I51.8 ‚Äî Otras enfermedades del coraz√≥n especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I519" value="I51.9"><label for="I519"><strong>I51.9 ‚Äî Enfermedad del coraz√≥n, no especificada</strong></label></div>

        <!-- I52.0, I52.1, I52.8 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I520" value="I52.0"><label for="I520"><strong>I52.0 ‚Äî Trastornos cardiacos en enfermedades infecciosas y parasitarias clasificadas en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I521" value="I52.1"><label for="I521"><strong>I52.1 ‚Äî Trastornos cardiacos en otras enfermedades clasificadas en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I528" value="I52.8"><label for="I528"><strong>I52.8 ‚Äî Otros trastornos cardiacos en enfermedades clasificadas en otra parte</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Arritmia card√≠aca / Taquicardia parox√≠stica (1) ===== -->
    <div class="familia" data-familia-id="fam-taquiarritmia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-taquiarritmia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-taquiarritmia-block', this)">+</button>
        Arritmia card√≠aca / Taquicardia parox√≠stica<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-taquiarritmia-block">
        <!-- I47.x -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I470" value="I47.0"><label for="I470"><strong>I47.0 ‚Äî Taquicardia supraventricular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I471" value="I47.1"><label for="I471"><strong>I47.1 ‚Äî Taquicardia ventricular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I472" value="I47.2"><label for="I472"><strong>I47.2 ‚Äî Taquicardia parox√≠stica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I479" value="I47.9"><label for="I479"><strong>I47.9 ‚Äî Taquicardia parox√≠stica, no especificada</strong></label></div>

        <!-- I49.0, I49.8, I49.9 -->
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I490" value="I49.0"><label for="I490"><strong>I49.0 ‚Äî Fibrilaci√≥n y aleteo ventricular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I498" value="I49.8"><label for="I498"><strong>I49.8 ‚Äî Otras arritmias cardiacas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I499" value="I49.9"><label for="I499"><strong>I49.9 ‚Äî Arritmia cardiaca, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Fibrilaci√≥n auricular / flutter (1) ===== -->
    <div class="familia" data-familia-id="fam-fa-flutter" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-fa-flutter-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-fa-flutter-block', this)">+</button>
        Fibrilaci√≥n auricular / flutter<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-fa-flutter-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I480" value="I48.0"><label for="I480"><strong>I48.0 ‚Äî Fibrilaci√≥n auricular parox√≠stica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I481" value="I48.1"><label for="I481"><strong>I48.1 ‚Äî Fibrilaci√≥n auricular persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I482" value="I48.2"><label for="I482"><strong>I48.2 ‚Äî Fibrilaci√≥n auricular cr√≥nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I483" value="I48.3"><label for="I483"><strong>I48.3 ‚Äî Flutter auricular t√≠pico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I484" value="I48.4"><label for="I484"><strong>I48.4 ‚Äî Flutter auricular at√≠pico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I489" value="I48.9"><label for="I489"><strong>I48.9 ‚Äî Fibrilaci√≥n/Flutter auricular, no especificados</strong></label></div>
      </div>
    </div>

    

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

        <!-- ===================== CATEGOR√çA: ‚ù§Ô∏è‚Äçü©π INSUFICIENCIA CARDIACA ===================== -->
        <div class="categoria-seccion" id="cat-insuficiencia-cardiaca" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-insuficiencia-cardiaca')">
    <h4>‚ù§Ô∏è‚Äçü©π INSUFICIENCIA CARDIACA
      <span class="categoria-badge" id="badge-insuficiencia-cardiaca">0</span>
      </h4>
    <button type="button" class="categoria-toggle" id="toggle-insuficiencia-cardiaca">+</button>
  </div>

    <div class="categoria-content collapsed" id="content-insuficiencia-cardiaca">

    <!-- ===== Familia: Insuficiencia card√≠aca (1) ===== -->
    <div class="familia" data-familia-id="fam-ic" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-ic-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ic-block', this)">+</button>
        ‚ù§Ô∏è‚Äçü©π INSUFICIENCIA CARDIACA<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-ic-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I500" value="I50.0"><label for="I500"><strong>I50.0 ‚Äî Insuficiencia cardiaca congestiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I501" value="I50.1"><label for="I501"><strong>I50.1 ‚Äî Insuficiencia cardiaca izquierda</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="I509" value="I50.9"><label for="I509"><strong>I50.9 ‚Äî Insuficiencia cardiaca, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

  <!-- ===================== CATEGOR√çA 03: FUNCI√ìN LIMITADA / DISCAPACIDAD / DEPENDENCIA (2) ===================== -->
<div class="categoria-seccion" id="cat-discapacidad" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-discapacidad')">
    <h4>‚ôø FUNCI√ìN LIMITADA / DISCAPACIDAD / DEPENDENCIA
      <span class="categoria-badge" id="badge-discapacidad">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-discapacidad">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-discapacidad">

    <!-- ===== Familia: Trastornos de la marcha y movilidad (R26.x) (2) ===== -->
    <div class="familia" data-familia-id="fam-marcha" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-marcha-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-marcha-block', this)">+</button>
        Trastornos de la marcha y la movilidad (R26.x)<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-marcha-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R260" value="R26.0"><label for="R260"><strong>R26.0 ‚Äî Marcha at√°xica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R261" value="R26.1"><label for="R261"><strong>R26.1 ‚Äî Marcha paral√≠tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R262" value="R26.2"><label for="R262"><strong>R26.2 ‚Äî Dificultad para caminar, no clasificada en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="R268" value="R26.8"><label for="R268"><strong>R26.8 ‚Äî Otras anomal√≠as de la marcha y la movilidad</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dependencia de cuidados (Z74.x) (2) ===== -->
    <div class="familia" data-familia-id="fam-z74" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-z74-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-z74-block', this)">+</button>
        Problemas relacionados con la dependencia de cuidados (Z74.x)<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-z74-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z740" value="Z74.0"><label for="Z740"><strong>Z74.0 ‚Äî Dependencia por limitaci√≥n funcional</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z741" value="Z74.1"><label for="Z741"><strong>Z74.1 ‚Äî Necesidad de asistencia con el cuidado personal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z742" value="Z74.2"><label for="Z742"><strong>Z74.2 ‚Äî Dependencia de atenci√≥n domiciliaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z743" value="Z74.3"><label for="Z743"><strong>Z74.3 ‚Äî Necesidad de supervisi√≥n y asistencia continua</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z748" value="Z74.8"><label for="Z748"><strong>Z74.8 ‚Äî Otros problemas de dependencia del cuidado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z749" value="Z74.9"><label for="Z749"><strong>Z74.9 ‚Äî Problema de dependencia del cuidado, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dependencia de m√°quinas y dispositivos (Z99.x) (2) ===== -->
    <div class="familia" data-familia-id="fam-z99" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-z99-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-z99-block', this)">+</button>
        Dependencia de m√°quinas y dispositivos (Z99.x)<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-z99-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z990" value="Z99.0"><label for="Z990"><strong>Z99.0 ‚Äî Dependencia de respirador (ventilador)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z991" value="Z99.1"><label for="Z991"><strong>Z99.1 ‚Äî Dependencia de ox√≠geno suplementario</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z992" value="Z99.2"><label for="Z992"><strong>Z99.2 ‚Äî Dependencia de di√°lisis renal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z993" value="Z99.3"><label for="Z993"><strong>Z99.3 ‚Äî Dependencia de silla de ruedas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z998" value="Z99.8"><label for="Z998"><strong>Z99.8 ‚Äî Dependencia de otras m√°quinas/dispositivos especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="Z999" value="Z99.9"><label for="Z999"><strong>Z99.9 ‚Äî Dependencia de m√°quina/dispositivo, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->


<!-- ===================== CATEGOR√çA 04: PATOLOG√çAS DE SALUD MENTAL Y PSIQUIATR√çA ===================== -->
<div class="categoria-seccion" id="cat-salud-mental" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-salud-mental')">
    <h4>üß† PATOLOG√çAS DE SALUD MENTAL Y PSIQUIATR√çA
      <span class="categoria-badge" id="badge-salud-mental">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-salud-mental">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-salud-mental">

    <!-- ===== Familia: Consumo perjudicial o dependiente de alcohol (1) ===== -->
    <div class="familia" data-familia-id="fam-alcohol" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-alcohol-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-alcohol-block', this)">+</button>
        Consumo perjudicial o dependiente de alcohol<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-alcohol-block">
        <!-- F10.0‚ÄìF10.9 -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F100" value="F10.0"><label for="F100"><strong>F10.0 ‚Äî Intoxicaci√≥n aguda por alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F101" value="F10.1"><label for="F101"><strong>F10.1 ‚Äî Consumo perjudicial de alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F102" value="F10.2"><label for="F102"><strong>F10.2 ‚Äî S√≠ndrome de dependencia de alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F103" value="F10.3"><label for="F103"><strong>F10.3 ‚Äî Estado de abstinencia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F104" value="F10.4"><label for="F104"><strong>F10.4 ‚Äî Abstinencia con delirio (delirium tremens)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F105" value="F10.5"><label for="F105"><strong>F10.5 ‚Äî Trastorno psic√≥tico inducido por alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F106" value="F10.6"><label for="F106"><strong>F10.6 ‚Äî S√≠ndrome amn√©sico inducido por alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F107" value="F10.7"><label for="F107"><strong>F10.7 ‚Äî Trastornos residuales y de comienzo tard√≠o</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F108" value="F10.8"><label for="F108"><strong>F10.8 ‚Äî Otros trastornos debidos al alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F109" value="F10.9"><label for="F109"><strong>F10.9 ‚Äî Trastorno por alcohol, no especificado</strong></label></div>

        <!-- C√≥digos adicionales -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y912" value="Y91.2"><label for="Y912"><strong>Y91.2 ‚Äî Intoxicaci√≥n alcoh√≥lica: severa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y913" value="Y91.3"><label for="Y913"><strong>Y91.3 ‚Äî Intoxicaci√≥n alcoh√≥lica: muy severa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y919" value="Y91.9"><label for="Y919"><strong>Y91.9 ‚Äî Intoxicaci√≥n alcoh√≥lica: no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z714" value="Z71.4"><label for="Z714"><strong>Z71.4 ‚Äî Asesoramiento por consumo de alcohol</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z721" value="Z72.1"><label for="Z721"><strong>Z72.1 ‚Äî Consumo de alcohol</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Tabaquismo (1) ===== -->
    <div class="familia" data-familia-id="fam-tabaco" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tabaco-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tabaco-block', this)">+</button>
        Tabaquismo<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-tabaco-block">
        <!-- F17.0‚ÄìF17.9 -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F170" value="F17.0"><label for="F170"><strong>F17.0 ‚Äî Intoxicaci√≥n aguda por tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F171" value="F17.1"><label for="F171"><strong>F17.1 ‚Äî Consumo perjudicial de tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F172" value="F17.2"><label for="F172"><strong>F17.2 ‚Äî S√≠ndrome de dependencia de tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F173" value="F17.3"><label for="F173"><strong>F17.3 ‚Äî Estado de abstinencia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F174" value="F17.4"><label for="F174"><strong>F17.4 ‚Äî Abstinencia complicada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F175" value="F17.5"><label for="F175"><strong>F17.5 ‚Äî Trastorno psic√≥tico inducido por tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F176" value="F17.6"><label for="F176"><strong>F17.6 ‚Äî S√≠ndrome amn√©sico inducido por tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F177" value="F17.7"><label for="F177"><strong>F17.7 ‚Äî Trastornos residuales y de comienzo tard√≠o</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F178" value="F17.8"><label for="F178"><strong>F17.8 ‚Äî Otros trastornos debidos al tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F179" value="F17.9"><label for="F179"><strong>F17.9 ‚Äî Trastorno por tabaco, no especificado</strong></label></div>

        <!-- C√≥digos adicionales -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="T652" value="T65.2"><label for="T652"><strong>T65.2 ‚Äî Efecto t√≥xico de nicotina</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z716" value="Z71.6"><label for="Z716"><strong>Z71.6 ‚Äî Asesoramiento por consumo de tabaco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z720" value="Z72.0"><label for="Z720"><strong>Z72.0 ‚Äî Consumo de tabaco</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Consumo perjudicial o dependiente de drogas (1) ===== -->
    <div class="familia" data-familia-id="fam-drogas" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-drogas-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-drogas-block', this)">+</button>
        Consumo perjudicial o dependiente de droga (principal o policonsumo)<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-drogas-block">
        <!-- F11.0‚ÄìF11.9 Opioides -->
        <div class="subcategoria-header banner-intoxicacion">F11.0 ‚Äî Intoxicaci√≥n aguda por opioides</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F111" value="F11.1"><label for="F111"><strong>F11.1 ‚Äî Consumo perjudicial de opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F112" value="F11.2"><label for="F112"><strong>F11.2 ‚Äî S√≠ndrome de dependencia de opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F113" value="F11.3"><label for="F113"><strong>F11.3 ‚Äî Estado de abstinencia (opioides)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F114" value="F11.4"><label for="F114"><strong>F11.4 ‚Äî Abstinencia con delirio (opioides)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F115" value="F11.5"><label for="F115"><strong>F11.5 ‚Äî Trastorno psic√≥tico inducido por opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F116" value="F11.6"><label for="F116"><strong>F11.6 ‚Äî S√≠ndrome amn√©sico inducido por opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F117" value="F11.7"><label for="F117"><strong>F11.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (opioides)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F118" value="F11.8"><label for="F118"><strong>F11.8 ‚Äî Otros trastornos mentales y del comportamiento debidos a opioides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F119" value="F11.9"><label for="F119"><strong>F11.9 ‚Äî Trastorno por opioides, no especificado</strong></label></div>

        <!-- F12.0‚ÄìF12.9 Cannabis -->
        <div class="subcategoria-header banner-intoxicacion">F12.0 ‚Äî Intoxicaci√≥n aguda por cannabis</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F121" value="F12.1"><label for="F121"><strong>F12.1 ‚Äî Consumo perjudicial de cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F122" value="F12.2"><label for="F122"><strong>F12.2 ‚Äî S√≠ndrome de dependencia de cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F123" value="F12.3"><label for="F123"><strong>F12.3 ‚Äî Estado de abstinencia (cannabis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F124" value="F12.4"><label for="F124"><strong>F12.4 ‚Äî Abstinencia con delirio (cannabis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F125" value="F12.5"><label for="F125"><strong>F12.5 ‚Äî Trastorno psic√≥tico inducido por cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F126" value="F12.6"><label for="F126"><strong>F12.6 ‚Äî S√≠ndrome amn√©sico inducido por cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F127" value="F12.7"><label for="F127"><strong>F12.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (cannabis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F128" value="F12.8"><label for="F128"><strong>F12.8 ‚Äî Otros trastornos debidos a cannabis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F129" value="F12.9"><label for="F129"><strong>F12.9 ‚Äî Trastorno por cannabis, no especificado</strong></label></div>

        <!-- F13.0‚ÄìF13.9 Sedantes/hipn√≥ticos -->
        <div class="subcategoria-header banner-intoxicacion">F13.0 ‚Äî Intoxicaci√≥n aguda por sedantes/hipn√≥ticos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F131" value="F13.1"><label for="F131"><strong>F13.1 ‚Äî Consumo perjudicial de sedantes/hipn√≥ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F132" value="F13.2"><label for="F132"><strong>F13.2 ‚Äî Dependencia de sedantes/hipn√≥ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F133" value="F13.3"><label for="F133"><strong>F13.3 ‚Äî Abstinencia (sedantes/hipn√≥ticos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F134" value="F13.4"><label for="F134"><strong>F13.4 ‚Äî Abstinencia con delirio (sedantes/hipn√≥ticos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F135" value="F13.5"><label for="F135"><strong>F13.5 ‚Äî Trastorno psic√≥tico inducido por sedantes/hipn√≥ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F136" value="F13.6"><label for="F136"><strong>F13.6 ‚Äî S√≠ndrome amn√©sico inducido por sedantes/hipn√≥ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F137" value="F13.7"><label for="F137"><strong>F13.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (sedantes/hipn√≥ticos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F138" value="F13.8"><label for="F138"><strong>F13.8 ‚Äî Otros trastornos debidos a sedantes/hipn√≥ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F139" value="F13.9"><label for="F139"><strong>F13.9 ‚Äî Trastorno por sedantes/hipn√≥ticos, no especificado</strong></label></div>

        <!-- F14.0‚ÄìF14.9 Coca√≠na -->
        <div class="subcategoria-header banner-intoxicacion">F14.0 ‚Äî Intoxicaci√≥n aguda por coca√≠na</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F141" value="F14.1"><label for="F141"><strong>F14.1 ‚Äî Consumo perjudicial de coca√≠na</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F142" value="F14.2"><label for="F142"><strong>F14.2 ‚Äî Dependencia de coca√≠na</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F143" value="F14.3"><label for="F143"><strong>F14.3 ‚Äî Abstinencia (coca√≠na)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F144" value="F14.4"><label for="F144"><strong>F14.4 ‚Äî Abstinencia con delirio (coca√≠na)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F145" value="F14.5"><label for="F145"><strong>F14.5 ‚Äî Trastorno psic√≥tico inducido por coca√≠na</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F146" value="F14.6"><label for="F146"><strong>F14.6 ‚Äî S√≠ndrome amn√©sico inducido por coca√≠na</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F147" value="F14.7"><label for="F147"><strong>F14.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (coca√≠na)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F148" value="F14.8"><label for="F148"><strong>F14.8 ‚Äî Otros trastornos debidos a coca√≠na</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F149" value="F14.9"><label for="F149"><strong>F14.9 ‚Äî Trastorno por coca√≠na, no especificado</strong></label></div>

        <!-- F15.0‚ÄìF15.9 Estimulantes (incl. cafe√≠na) -->
        <div class="subcategoria-header banner-intoxicacion">F15.0 ‚Äî Intoxicaci√≥n aguda por otros estimulantes, incl. cafe√≠na</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F151" value="F15.1"><label for="F151"><strong>F15.1 ‚Äî Consumo perjudicial de otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F152" value="F15.2"><label for="F152"><strong>F15.2 ‚Äî Dependencia de otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F153" value="F15.3"><label for="F153"><strong>F15.3 ‚Äî Abstinencia (otros estimulantes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F154" value="F15.4"><label for="F154"><strong>F15.4 ‚Äî Abstinencia con delirio (otros estimulantes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F155" value="F15.5"><label for="F155"><strong>F15.5 ‚Äî Trastorno psic√≥tico inducido por otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F156" value="F15.6"><label for="F156"><strong>F15.6 ‚Äî S√≠ndrome amn√©sico inducido por otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F157" value="F15.7"><label for="F157"><strong>F15.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (otros estimulantes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F158" value="F15.8"><label for="F158"><strong>F15.8 ‚Äî Otros trastornos debidos a otros estimulantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F159" value="F15.9"><label for="F159"><strong>F15.9 ‚Äî Trastorno por otros estimulantes, no especificado</strong></label></div>

        <!-- F16.0‚ÄìF16.9 Alucin√≥genos -->
        <div class="subcategoria-header banner-intoxicacion">F16.0 ‚Äî Intoxicaci√≥n aguda por alucin√≥genos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F161" value="F16.1"><label for="F161"><strong>F16.1 ‚Äî Consumo perjudicial de alucin√≥genos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F162" value="F16.2"><label for="F162"><strong>F16.2 ‚Äî Dependencia de alucin√≥genos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F163" value="F16.3"><label for="F163"><strong>F16.3 ‚Äî Abstinencia (alucin√≥genos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F164" value="F16.4"><label for="F164"><strong>F16.4 ‚Äî Abstinencia con delirio (alucin√≥genos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F165" value="F16.5"><label for="F165"><strong>F16.5 ‚Äî Trastorno psic√≥tico inducido por alucin√≥genos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F166" value="F16.6"><label for="F166"><strong>F16.6 ‚Äî S√≠ndrome amn√©sico inducido por alucin√≥genos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F167" value="F16.7"><label for="F167"><strong>F16.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (alucin√≥genos)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F168" value="F16.8"><label for="F168"><strong>F16.8 ‚Äî Otros trastornos debidos a alucin√≥genos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F169" value="F16.9"><label for="F169"><strong>F16.9 ‚Äî Trastorno por alucin√≥genos, no especificado</strong></label></div>

        <!-- F18.0‚ÄìF18.9 Disolventes vol√°tiles -->
        <div class="subcategoria-header banner-intoxicacion">F18.0 ‚Äî Intoxicaci√≥n aguda por disolventes vol√°tiles</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F181" value="F18.1"><label for="F181"><strong>F18.1 ‚Äî Consumo perjudicial de disolventes vol√°tiles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F182" value="F18.2"><label for="F182"><strong>F18.2 ‚Äî Dependencia de disolventes vol√°tiles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F183" value="F18.3"><label for="F183"><strong>F18.3 ‚Äî Abstinencia (disolventes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F184" value="F18.4"><label for="F184"><strong>F18.4 ‚Äî Abstinencia con delirio (disolventes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F185" value="F18.5"><label for="F185"><strong>F18.5 ‚Äî Trastorno psic√≥tico inducido por disolventes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F186" value="F18.6"><label for="F186"><strong>F18.6 ‚Äî S√≠ndrome amn√©sico inducido por disolventes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F187" value="F18.7"><label for="F187"><strong>F18.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (disolventes)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F188" value="F18.8"><label for="F188"><strong>F18.8 ‚Äî Otros trastornos debidos a disolventes vol√°tiles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F189" value="F18.9"><label for="F189"><strong>F18.9 ‚Äî Trastorno por disolventes vol√°tiles, no especificado</strong></label></div>

        <!-- F19.0‚ÄìF19.9 M√∫ltiples drogas -->
        <div class="subcategoria-header banner-intoxicacion">F19.0 ‚Äî Intoxicaci√≥n aguda por m√∫ltiples drogas/otras sustancias</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F191" value="F19.1"><label for="F191"><strong>F19.1 ‚Äî Consumo perjudicial de m√∫ltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F192" value="F19.2"><label for="F192"><strong>F19.2 ‚Äî Dependencia de m√∫ltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F193" value="F19.3"><label for="F193"><strong>F19.3 ‚Äî Abstinencia (m√∫ltiples drogas)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F194" value="F19.4"><label for="F194"><strong>F19.4 ‚Äî Abstinencia con delirio (m√∫ltiples drogas)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F195" value="F19.5"><label for="F195"><strong>F19.5 ‚Äî Trastorno psic√≥tico inducido por m√∫ltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F196" value="F19.6"><label for="F196"><strong>F19.6 ‚Äî S√≠ndrome amn√©sico inducido por m√∫ltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F197" value="F19.7"><label for="F197"><strong>F19.7 ‚Äî Trastornos residuales y de comienzo tard√≠o (m√∫ltiples drogas)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F198" value="F19.8"><label for="F198"><strong>F19.8 ‚Äî Otros trastornos debidos a m√∫ltiples drogas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F199" value="F19.9"><label for="F199"><strong>F19.9 ‚Äî Trastorno por m√∫ltiples drogas, no especificado</strong></label></div>

        <!-- Z72.2 -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z722" value="Z72.2"><label for="Z722"><strong>Z72.2 ‚Äî Consumo de drogas</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastornos alimentarios (1) ===== -->
    <div class="familia" data-familia-id="fam-tca" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tca-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tca-block', this)">+</button>
        Trastornos alimentarios<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-tca-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F500" value="F50.0"><label for="F500"><strong>F50.0 ‚Äî Anorexia nerviosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F501" value="F50.1"><label for="F501"><strong>F50.1 ‚Äî Anorexia nerviosa at√≠pica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F502" value="F50.2"><label for="F502"><strong>F50.2 ‚Äî Bulimia nerviosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F503" value="F50.3"><label for="F503"><strong>F50.3 ‚Äî Bulimia nerviosa at√≠pica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F504" value="F50.4"><label for="F504"><strong>F50.4 ‚Äî Hiperfagia psic√≥gena</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F505" value="F50.5"><label for="F505"><strong>F50.5 ‚Äî V√≥mitos psic√≥genos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F508" value="F50.8"><label for="F508"><strong>F50.8 ‚Äî Otros trastornos de la alimentaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F509" value="F50.9"><label for="F509"><strong>F50.9 ‚Äî Trastorno de la alimentaci√≥n, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Depresi√≥n leve o moderada (1) ===== -->
    <div class="familia" data-familia-id="fam-depre-leve" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-depre-leve-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-depre-leve-block', this)">+</button>
        Depresi√≥n leve o moderada (Trastorno depresivo recurrente)<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-depre-leve-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F330" value="F33.0"><label for="F330"><strong>F33.0 ‚Äî Episodio actual leve</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F331" value="F33.1"><label for="F331"><strong>F33.1 ‚Äî Episodio actual moderado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F334" value="F33.4"><label for="F334"><strong>F33.4 ‚Äî En remisi√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F338" value="F33.8"><label for="F338"><strong>F33.8 ‚Äî Otros trastornos depresivos recurrentes especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F339" value="F33.9"><label for="F339"><strong>F33.9 ‚Äî Trastorno depresivo recurrente, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Depresi√≥n grave / con psicosis (2) ===== -->
    <div class="familia" data-familia-id="fam-depre-grave" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-depre-grave-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-depre-grave-block', this)">+</button>
        Depresi√≥n grave / grave con psicosis (Trastorno depresivo recurrente)<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-depre-grave-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F332" value="F33.2"><label for="F332"><strong>F33.2 ‚Äî Episodio actual grave sin s√≠ntomas psic√≥ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F333" value="F33.3"><label for="F333"><strong>F33.3 ‚Äî Episodio actual grave con s√≠ntomas psic√≥ticos</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Esquizofrenia y trastornos psic√≥ticos (2) ===== -->
    <div class="familia" data-familia-id="fam-esquizo" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-esquizo-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-esquizo-block', this)">+</button>
        Esquizofrenia y trastornos psic√≥ticos<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-esquizo-block">
        <!-- Esquizofrenia F20.0‚ÄìF20.9 -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F200" value="F20.0"><label for="F200"><strong>F20.0 ‚Äî Esquizofrenia paranoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F201" value="F20.1"><label for="F201"><strong>F20.1 ‚Äî Esquizofrenia hebefr√©nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F202" value="F20.2"><label for="F202"><strong>F20.2 ‚Äî Esquizofrenia catat√≥nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F203" value="F20.3"><label for="F203"><strong>F20.3 ‚Äî Esquizofrenia indiferenciada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F204" value="F20.4"><label for="F204"><strong>F20.4 ‚Äî Depresi√≥n post-esquizofr√©nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F205" value="F20.5"><label for="F205"><strong>F20.5 ‚Äî Esquizofrenia residual</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F206" value="F20.6"><label for="F206"><strong>F20.6 ‚Äî Esquizofrenia simple</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F208" value="F20.8"><label for="F208"><strong>F20.8 ‚Äî Otras esquizofrenias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F209" value="F20.9"><label for="F209"><strong>F20.9 ‚Äî Esquizofrenia, no especificada</strong></label></div>

        <!-- Trastornos delirantes F22.x -->
        <div class="subcategoria-header banner-psicoticos">F22 ‚Äî Trastornos delirantes</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F220" value="F22.0"><label for="F220"><strong>F22.0 ‚Äî Trastorno delirante persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F228" value="F22.8"><label for="F228"><strong>F22.8 ‚Äî Otros trastornos delirantes persistentes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F229" value="F22.9"><label for="F229"><strong>F22.9 ‚Äî Trastorno delirante persistente, no especificado</strong></label></div>

        <!-- F21 - Trastorno esquizot√≠pico -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F21" value="F21"><label for="F21"><strong>F21 ‚Äî Trastorno esquizot√≠pico</strong></label></div>

        <!-- Trastornos psic√≥ticos agudos y transitorios F23.x -->
        <div class="subcategoria-header banner-psicoticos">F23 ‚Äî Trastornos psic√≥ticos agudos y transitorios</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F230" value="F23.0"><label for="F230"><strong>F23.0 ‚Äî Psic√≥tico agudo polimorfo sin s√≠ntomas de esquizofrenia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F231" value="F23.1"><label for="F231"><strong>F23.1 ‚Äî Psic√≥tico agudo polimorfo con s√≠ntomas de esquizofrenia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F232" value="F23.2"><label for="F232"><strong>F23.2 ‚Äî Psic√≥tico agudo de tipo esquizofr√©nico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F233" value="F23.3"><label for="F233"><strong>F23.3 ‚Äî Otros psic√≥ticos agudos predominantemente delirantes</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F238" value="F23.8"><label for="F238"><strong>F23.8 ‚Äî Otros psic√≥ticos agudos y transitorios especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F239" value="F23.9"><label for="F239"><strong>F23.9 ‚Äî Psic√≥tico agudo y transitorio, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Retraso mental (1) ===== -->
    <div class="familia" data-familia-id="fam-retraso-mental" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-retraso-mental-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-retraso-mental-block', this)">+</button>
        Retraso mental<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-retraso-mental-block">
        <!-- F70.x ‚Äî Retraso mental leve -->
        <div class="subcategoria-header banner-discapacidad">F70 ‚Äî Retraso mental leve</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F700" name="patologia[]" value="F70.0" data-points="1"><label for="F700"><strong>F70.0 ‚Äî Leve, con m√≠nima o ninguna alteraci√≥n del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F701" name="patologia[]" value="F70.1" data-points="1"><label for="F701"><strong>F70.1 ‚Äî Leve, con alteraci√≥n significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F708" name="patologia[]" value="F70.8" data-points="1"><label for="F708"><strong>F70.8 ‚Äî Leve, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F709" name="patologia[]" value="F70.9" data-points="1"><label for="F709"><strong>F70.9 ‚Äî Leve, sin especificaci√≥n de alteraci√≥n del comportamiento</strong></label></div>

        <!-- F71.x ‚Äî Retraso mental moderado -->
        <div class="subcategoria-header banner-discapacidad">F71 ‚Äî Retraso mental moderado</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F710" name="patologia[]" value="F71.0" data-points="1"><label for="F710"><strong>F71.0 ‚Äî Moderado, con m√≠nima o ninguna alteraci√≥n del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F711" name="patologia[]" value="F71.1" data-points="1"><label for="F711"><strong>F71.1 ‚Äî Moderado, con alteraci√≥n significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F718" name="patologia[]" value="F71.8" data-points="1"><label for="F718"><strong>F71.8 ‚Äî Moderado, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F719" name="patologia[]" value="F71.9" data-points="1"><label for="F719"><strong>F71.9 ‚Äî Moderado, sin especificaci√≥n de alteraci√≥n del comportamiento</strong></label></div>

        <!-- F72.x ‚Äî Retraso mental grave -->
        <div class="subcategoria-header banner-discapacidad">F72 ‚Äî Retraso mental grave</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F720" name="patologia[]" value="F72.0" data-points="1"><label for="F720"><strong>F72.0 ‚Äî Grave, con m√≠nima o ninguna alteraci√≥n del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F721" name="patologia[]" value="F72.1" data-points="1"><label for="F721"><strong>F72.1 ‚Äî Grave, con alteraci√≥n significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F728" name="patologia[]" value="F72.8" data-points="1"><label for="F728"><strong>F72.8 ‚Äî Grave, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F729" name="patologia[]" value="F72.9" data-points="1"><label for="F729"><strong>F72.9 ‚Äî Grave, sin especificaci√≥n de alteraci√≥n del comportamiento</strong></label></div>

        <!-- F73.x ‚Äî Retraso mental profundo -->
        <div class="subcategoria-header banner-discapacidad">F73 ‚Äî Retraso mental profundo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F730" name="patologia[]" value="F73.0" data-points="1"><label for="F730"><strong>F73.0 ‚Äî Profundo, con m√≠nima o ninguna alteraci√≥n del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F731" name="patologia[]" value="F73.1" data-points="1"><label for="F731"><strong>F73.1 ‚Äî Profundo, con alteraci√≥n significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F738" name="patologia[]" value="F73.8" data-points="1"><label for="F738"><strong>F73.8 ‚Äî Profundo, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F739" name="patologia[]" value="F73.9" data-points="1"><label for="F739"><strong>F73.9 ‚Äî Profundo, sin especificaci√≥n de alteraci√≥n del comportamiento</strong></label></div>

        <!-- F78.x / F79.x -->
        <div class="subcategoria-header banner-discapacidad">F78 / F79 ‚Äî Otras formas y no especificado</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F780" name="patologia[]" value="F78.0" data-points="1"><label for="F780"><strong>F78.0 ‚Äî Otros retrasos mentales, con m√≠nima o ninguna alteraci√≥n del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F781" name="patologia[]" value="F78.1" data-points="1"><label for="F781"><strong>F78.1 ‚Äî Otros retrasos mentales, con alteraci√≥n significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F788" name="patologia[]" value="F78.8" data-points="1"><label for="F788"><strong>F78.8 ‚Äî Otros retrasos mentales con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F789" name="patologia[]" value="F78.9" data-points="1"><label for="F789"><strong>F78.9 ‚Äî Otros retrasos mentales, no especificados</strong></label></div>

        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F790" name="patologia[]" value="F79.0" data-points="1"><label for="F790"><strong>F79.0 ‚Äî Retraso mental no especificado, con m√≠nima o ninguna alteraci√≥n del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F791" name="patologia[]" value="F79.1" data-points="1"><label for="F791"><strong>F79.1 ‚Äî Retraso mental no especificado, con alteraci√≥n significativa del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F798" name="patologia[]" value="F79.8" data-points="1"><label for="F798"><strong>F79.8 ‚Äî Retraso mental no especificado, con otras alteraciones del comportamiento</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F799" name="patologia[]" value="F79.9" data-points="1"><label for="F799"><strong>F79.9 ‚Äî Retraso mental no especificado, sin menci√≥n de alteraci√≥n del comportamiento</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastorno ansioso (1) ===== -->
    <div class="familia" data-familia-id="fam-ansiedad" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-ansiedad-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ansiedad-block', this)">+</button>
        Trastorno ansioso<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-ansiedad-block">

        <!-- F40.x ‚Äî Trastornos f√≥bico-ansiosos -->
        <div class="subcategoria-header banner-ansiedad">F40 ‚Äî Trastornos f√≥bico-ansiosos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F400" name="patologia[]" value="F40.0" data-points="1"><label for="F400"><strong>F40.0 ‚Äî Agorafobia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F401" name="patologia[]" value="F40.1" data-points="1"><label for="F401"><strong>F40.1 ‚Äî Fobia social</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F402" name="patologia[]" value="F40.2" data-points="1"><label for="F402"><strong>F40.2 ‚Äî Fobias espec√≠ficas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F408" name="patologia[]" value="F40.8" data-points="1"><label for="F408"><strong>F40.8 ‚Äî Otros trastornos f√≥bico-ansiosos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F409" name="patologia[]" value="F40.9" data-points="1"><label for="F409"><strong>F40.9 ‚Äî Trastorno f√≥bico-ansioso, no especificado</strong></label></div>

        <!-- F41.x ‚Äî Otros trastornos de ansiedad -->
        <div class="subcategoria-header banner-ansiedad">F41 ‚Äî Otros trastornos de ansiedad</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F410" name="patologia[]" value="F41.0" data-points="1"><label for="F410"><strong>F41.0 ‚Äî Trastorno de p√°nico (ansiedad parox√≠stica epis√≥dica)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F411" name="patologia[]" value="F41.1" data-points="1"><label for="F411"><strong>F41.1 ‚Äî Trastorno de ansiedad generalizada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F412" name="patologia[]" value="F41.2" data-points="1"><label for="F412"><strong>F41.2 ‚Äî Trastorno mixto ansioso-depresivo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F413" name="patologia[]" value="F41.3" data-points="1"><label for="F413"><strong>F41.3 ‚Äî Otros trastornos mixtos de ansiedad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F418" name="patologia[]" value="F41.8" data-points="1"><label for="F418"><strong>F41.8 ‚Äî Otros trastornos de ansiedad especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F419" name="patologia[]" value="F41.9" data-points="1"><label for="F419"><strong>F41.9 ‚Äî Trastorno de ansiedad, no especificado</strong></label></div>

        <!-- F42.x (selecci√≥n solicitada) ‚Äî Trastorno obsesivo-compulsivo -->
        <div class="subcategoria-header banner-ansiedad">F42 ‚Äî Trastorno obsesivo-compulsivo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F422" name="patologia[]" value="F42.2" data-points="1"><label for="F422"><strong>F42.2 ‚Äî Pensamientos y actos obsesivos mixtos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F428" name="patologia[]" value="F42.8" data-points="1"><label for="F428"><strong>F42.8 ‚Äî Otros trastornos obsesivo-compulsivos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F429" name="patologia[]" value="F42.9" data-points="1"><label for="F429"><strong>F42.9 ‚Äî Trastorno obsesivo-compulsivo, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastorno de la personalidad (1) ===== -->
    <div class="familia" data-familia-id="fam-personalidad" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-personalidad-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-personalidad-block', this)">+</button>
        Trastorno de la personalidad<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-personalidad-block">
        <!-- F60.x ‚Äî Trastornos espec√≠ficos de la personalidad -->
        <div class="subcategoria-header banner-discapacidad">F60 ‚Äî Trastornos espec√≠ficos de la personalidad</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F600" name="patologia[]" value="F60.0" data-points="1"><label for="F600"><strong>F60.0 ‚Äî Personalidad paranoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F601" name="patologia[]" value="F60.1" data-points="1"><label for="F601"><strong>F60.1 ‚Äî Personalidad esquizoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F602" name="patologia[]" value="F60.2" data-points="1"><label for="F602"><strong>F60.2 ‚Äî Personalidad disocial (antisocial)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F603" name="patologia[]" value="F60.3" data-points="1"><label for="F603"><strong>F60.3 ‚Äî Personalidad emocionalmente inestable (incluye l√≠mite/impulsivo)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F604" name="patologia[]" value="F60.4" data-points="1"><label for="F604"><strong>F60.4 ‚Äî Personalidad histri√≥nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F605" name="patologia[]" value="F60.5" data-points="1"><label for="F605"><strong>F60.5 ‚Äî Personalidad ananc√°stica (obsesivo-compulsiva)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F606" name="patologia[]" value="F60.6" data-points="1"><label for="F606"><strong>F60.6 ‚Äî Personalidad ansiosa (evitativa)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F607" name="patologia[]" value="F60.7" data-points="1"><label for="F607"><strong>F60.7 ‚Äî Personalidad dependiente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F608" name="patologia[]" value="F60.8" data-points="1"><label for="F608"><strong>F60.8 ‚Äî Otros trastornos espec√≠ficos de la personalidad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F609" name="patologia[]" value="F60.9" data-points="1"><label for="F609"><strong>F60.9 ‚Äî Trastorno espec√≠fico de la personalidad, no especificado</strong></label></div>

        <!-- F61 / F62 / F68.0 / F69 -->
        <div class="subcategoria-header banner-discapacidad">Otros trastornos de la personalidad y del comportamiento del adulto</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F61" name="patologia[]" value="F61" data-points="1"><label for="F61"><strong>F61 ‚Äî Trastornos mixtos y otros trastornos de la personalidad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F620" name="patologia[]" value="F62.0" data-points="1"><label for="F620"><strong>F62.0 ‚Äî Cambios perdurables de la personalidad tras experiencia catastr√≥fica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F621" name="patologia[]" value="F62.1" data-points="1"><label for="F621"><strong>F62.1 ‚Äî Cambios perdurables de la personalidad tras enfermedad psiqui√°trica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F628" name="patologia[]" value="F62.8" data-points="1"><label for="F628"><strong>F62.8 ‚Äî Otros cambios perdurables de la personalidad</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F629" name="patologia[]" value="F62.9" data-points="1"><label for="F629"><strong>F62.9 ‚Äî Cambio perdurable de la personalidad, no especificado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F680" name="patologia[]" value="F68.0" data-points="1"><label for="F680"><strong>F68.0 ‚Äî Trastornos somatomorfos por factores psicol√≥gicos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F69" name="patologia[]" value="F69" data-points="1"><label for="F69"><strong>F69 ‚Äî Trastorno de la personalidad y del comportamiento del adulto, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastornos del sue√±o (1) ===== -->
    <div class="familia" data-familia-id="fam-sueno-mental" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-sueno-mental-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-sueno-mental-block', this)">+</button>
        Trastornos del sue√±o<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-sueno-mental-block">
        <!-- F51.x ‚Äî Trastornos no org√°nicos del sue√±o -->
        <div class="subcategoria-header banner-sueno">F51 ‚Äî Trastornos no org√°nicos del sue√±o</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F510-mental" name="patologia[]" value="F51.0" data-points="1"><label for="F510-mental"><strong>F51.0 ‚Äî Insomnio no org√°nico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F511-mental" name="patologia[]" value="F51.1" data-points="1"><label for="F511-mental"><strong>F51.1 ‚Äî Hipersomnia no org√°nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F512-mental" name="patologia[]" value="F51.2" data-points="1"><label for="F512-mental"><strong>F51.2 ‚Äî Alteraci√≥n del ritmo sue√±o-vigilia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F514-mental" name="patologia[]" value="F51.4" data-points="1"><label for="F514-mental"><strong>F51.4 ‚Äî Terrores nocturnos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F518-mental" name="patologia[]" value="F51.8" data-points="1"><label for="F518-mental"><strong>F51.8 ‚Äî Otros trastornos no org√°nicos del sue√±o</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="F519-mental" name="patologia[]" value="F51.9" data-points="1"><label for="F519-mental"><strong>F51.9 ‚Äî Trastorno no org√°nico del sue√±o, no especificado</strong></label></div>

        <!-- G47.x ‚Äî Otros trastornos del sue√±o -->
        <div class="subcategoria-header banner-sueno">G47 ‚Äî Otros trastornos del sue√±o</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G473-mental" name="patologia[]" value="G47.3" data-points="1"><label for="G473-mental"><strong>G47.3 ‚Äî Apnea del sue√±o</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G474-mental" name="patologia[]" value="G47.4" data-points="1"><label for="G474-mental"><strong>G47.4 ‚Äî Narcolepsia y cataplej√≠a</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G478-mental" name="patologia[]" value="G47.8" data-points="1"><label for="G478-mental"><strong>G47.8 ‚Äî Otros trastornos del sue√±o especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="G479-mental" name="patologia[]" value="G47.9" data-points="1"><label for="G479-mental"><strong>G47.9 ‚Äî Trastorno del sue√±o, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Otros trastornos de Salud Mental (1) ===== -->
    <div class="familia" data-familia-id="fam-otros-salud-mental" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-otros-salud-mental-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-otros-salud-mental-block', this)">+</button>
        Otros trastornos de Salud Mental<span class="badge-puntos">(1)</span>
      </div>

      <div class="familia-content collapsed" id="fam-otros-salud-mental-block">

        <!-- F31.x ‚Äî Trastorno afectivo bipolar -->
        <div class="subcategoria-header banner-depresion">F31 ‚Äî Trastorno afectivo bipolar</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F310" name="patologia[]" value="F31.0" data-points="1">
          <label for="F310"><strong>F31.0 ‚Äî Episodio actual hipoman√≠aco</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F311" name="patologia[]" value="F31.1" data-points="1">
          <label for="F311"><strong>F31.1 ‚Äî Episodio actual man√≠aco sin s√≠ntomas psic√≥ticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F312" name="patologia[]" value="F31.2" data-points="1">
          <label for="F312"><strong>F31.2 ‚Äî Episodio actual man√≠aco con s√≠ntomas psic√≥ticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F313" name="patologia[]" value="F31.3" data-points="1">
          <label for="F313"><strong>F31.3 ‚Äî Episodio actual depresivo leve o moderado</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F314" name="patologia[]" value="F31.4" data-points="1">
          <label for="F314"><strong>F31.4 ‚Äî Episodio actual depresivo grave sin s√≠ntomas psic√≥ticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F315" name="patologia[]" value="F31.5" data-points="1">
          <label for="F315"><strong>F31.5 ‚Äî Episodio actual depresivo grave con s√≠ntomas psic√≥ticos</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F316" name="patologia[]" value="F31.6" data-points="1">
          <label for="F316"><strong>F31.6 ‚Äî Episodio actual mixto</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F317" name="patologia[]" value="F31.7" data-points="1">
          <label for="F317"><strong>F31.7 ‚Äî Actualmente en remisi√≥n</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F318" name="patologia[]" value="F31.8" data-points="1">
          <label for="F318"><strong>F31.8 ‚Äî Otros trastornos bipolares especificados</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F319" name="patologia[]" value="F31.9" data-points="1">
          <label for="F319"><strong>F31.9 ‚Äî Trastorno afectivo bipolar, no especificado</strong></label>
        </div>

        <!-- F66.x ‚Äî Trastornos psicol√≥gicos y del comportamiento asociados al desarrollo sexual y la orientaci√≥n -->
        <div class="subcategoria-header banner-psicosocial">F66 ‚Äî Trastornos psicol√≥gicos asociados al desarrollo sexual y orientaci√≥n</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F661" name="patologia[]" value="F66.1" data-points="1">
          <label for="F661"><strong>F66.1 ‚Äî Orientaci√≥n sexual egodist√≥nica</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F662" name="patologia[]" value="F66.2" data-points="1">
          <label for="F662"><strong>F66.2 ‚Äî Trastorno de relaci√≥n sexual</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F668" name="patologia[]" value="F66.8" data-points="1">
          <label for="F668"><strong>F66.8 ‚Äî Otros trastornos especificados</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="F669" name="patologia[]" value="F66.9" data-points="1">
          <label for="F669"><strong>F66.9 ‚Äî Trastorno no especificado</strong></label>
        </div>

      </div>
    </div>

     

    </div> <!-- /categoria-content -->
  </div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 05: PATOLOG√çAS NEUROL√ìGICAS ===================== -->
<div class="categoria-seccion" id="cat-neurologicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-neurologicas')">
    <h4>üß© PATOLOG√çAS NEUROL√ìGICAS
      <span class="categoria-badge" id="badge-neurologicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-neurologicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-neurologicas">

    <!-- ===== Familia: Parkinsonismo (1) ===== -->
    <div class="familia" data-familia-id="fam-parkinsonismo" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-parkinsonismo-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-parkinsonismo-block', this)">+</button>
        Parkinsonismo<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-parkinsonismo-block">
        <!-- G20 ‚Äî Enfermedad de Parkinson -->
        <div class="subcategoria-header banner-parkinson">G20 ‚Äî Enfermedad de Parkinson</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G20" value="G20"><label for="G20"><strong>G20 ‚Äî Enfermedad de Parkinson</strong></label></div>

        <!-- Parkinsonismo secundario y en otras enfermedades -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G211" value="G21.1"><label for="G211"><strong>G21.1 ‚Äî Parkinsonismo secundario inducido por f√°rmacos (otros)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G22" value="G22"><label for="G22"><strong>G22 ‚Äî Parkinsonismo en enfermedades clasificadas en otra parte</strong></label></div>

        <!-- Otras enfermedades degenerativas de ganglios basales (G23.x) -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G230" value="G23.0"><label for="G230"><strong>G23.0 ‚Äî Otras enfermedades degenerativas de ganglios basales, forma especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G231" value="G23.1"><label for="G231"><strong>G23.1 ‚Äî Par√°lisis supranuclear progresiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G232" value="G23.2"><label for="G232"><strong>G23.2 ‚Äî Degeneraci√≥n estriatonigral</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G238" value="G23.8"><label for="G238"><strong>G23.8 ‚Äî Otras enfermedades degenerativas de ganglios basales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G239" value="G23.9"><label for="G239"><strong>G23.9 ‚Äî Enfermedad degenerativa de ganglios basales, no especificada</strong></label></div>

        <!-- Diston√≠as (G24.x) -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G240" value="G24.0"><label for="G240"><strong>G24.0 ‚Äî Diston√≠a de torsi√≥n de inicio en el adulto</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G241" value="G24.1"><label for="G241"><strong>G24.1 ‚Äî Diston√≠a familiar idiop√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G242" value="G24.2"><label for="G242"><strong>G24.2 ‚Äî Tort√≠colis espasm√≥dica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G244" value="G24.4"><label for="G244"><strong>G24.4 ‚Äî Diston√≠a oromandibular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G245" value="G24.5"><label for="G245"><strong>G24.5 ‚Äî Blefaroespasmo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G248" value="G24.8"><label for="G248"><strong>G24.8 ‚Äî Otras diston√≠as especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G249" value="G24.9"><label for="G249"><strong>G24.9 ‚Äî Diston√≠a, no especificada</strong></label></div>

        <!-- Otros trastornos del movimiento (G25.x seleccionados) -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G252" value="G25.2"><label for="G252"><strong>G25.2 ‚Äî Otros temblores especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G253" value="G25.3"><label for="G253"><strong>G25.3 ‚Äî Mioclon√≠as</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G254" value="G25.4"><label for="G254"><strong>G25.4 ‚Äî Coreas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G255" value="G25.5"><label for="G255"><strong>G25.5 ‚Äî Otros trastornos coreicos</strong></label></div>

        <!-- Trastornos extrapiramidales en otras enfermedades -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G26" value="G26"><label for="G26"><strong>G26 ‚Äî Trastornos extrapiramidales y del movimiento en enfermedades clasificadas en otra parte</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Demencia (2) ===== -->
    <div class="familia" data-familia-id="fam-demencia" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-demencia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-demencia-block', this)">+</button>
        Demencia<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-demencia-block">
        <!-- Demencia en enfermedad de Alzheimer (F00.x) -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F000" value="F00.0"><label for="F000"><strong>F00.0 ‚Äî Demencia en enfermedad de Alzheimer, inicio temprano</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F001" value="F00.1"><label for="F001"><strong>F00.1 ‚Äî Demencia en enfermedad de Alzheimer, inicio tard√≠o</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F002" value="F00.2"><label for="F002"><strong>F00.2 ‚Äî Demencia en enfermedad de Alzheimer, forma at√≠pica o mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F009" value="F00.9"><label for="F009"><strong>F00.9 ‚Äî Demencia en enfermedad de Alzheimer, no especificada</strong></label></div>

        <!-- Demencia vascular (F01.x) -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F010" value="F01.0"><label for="F010"><strong>F01.0 ‚Äî Demencia vascular de inicio agudo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F011" value="F01.1"><label for="F011"><strong>F01.1 ‚Äî Demencia por infartos m√∫ltiples</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F012" value="F01.2"><label for="F012"><strong>F01.2 ‚Äî Demencia vascular subcortical</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F013" value="F01.3"><label for="F013"><strong>F01.3 ‚Äî Demencia mixta, cortical y subcortical</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F018" value="F01.8"><label for="F018"><strong>F01.8 ‚Äî Otras demencias vasculares</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F019" value="F01.9"><label for="F019"><strong>F01.9 ‚Äî Demencia vascular, no especificada</strong></label></div>

        <!-- Demencia en otras enfermedades (F02.x) y no especificada (F03) -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F020" value="F02.0"><label for="F020"><strong>F02.0 ‚Äî Demencia en enfermedad de Pick</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F021" value="F02.1"><label for="F021"><strong>F02.1 ‚Äî Demencia en enfermedad de Creutzfeldt-Jakob</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F022" value="F02.2"><label for="F022"><strong>F02.2 ‚Äî Demencia en enfermedad de Huntington</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F023" value="F02.3"><label for="F023"><strong>F02.3 ‚Äî Demencia en enfermedad de Parkinson</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F024" value="F02.4"><label for="F024"><strong>F02.4 ‚Äî Demencia en infecci√≥n por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F028" value="F02.8"><label for="F028"><strong>F02.8 ‚Äî Demencia en otras enfermedades especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="F03" value="F03"><label for="F03"><strong>F03 ‚Äî Demencia, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dolor neurop√°tico / Fibromialgia (1) ===== -->
    <div class="familia" data-familia-id="fam-neuropatico" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-neuropatico-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-neuropatico-block', this)">+</button>
        Dolor neurop√°tico / Fibromialgia <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-neuropatico-block">
    
    <!-- G50.x ‚Äî Neuralgias del trig√©mino -->
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G500" name="patologia[]" value="G50.0" data-points="1">
      <label for="G500"><strong>G50.0</strong> ‚Äî Neuralgia del trig√©mino</label>
    </div>
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G501" name="patologia[]" value="G50.1" data-points="1">
      <label for="G501"><strong>G50.1</strong> ‚Äî Dolor facial at√≠pico</label>
    </div>
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G508" name="patologia[]" value="G50.8" data-points="1">
      <label for="G508"><strong>G50.8</strong> ‚Äî Otros trastornos de nervio trig√©mino</label>
    </div>
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="G509" name="patologia[]" value="G50.9" data-points="1">
      <label for="G509"><strong>G50.9</strong> ‚Äî Trastorno del trig√©mino, no especificado</label>
    </div>

    <!-- M79.7 ‚Äî Fibromialgia -->
    <div class="patologia-item">
      <input type="checkbox" class="patologia-checkbox" id="M797" name="patologia[]" value="M79.7" data-points="1">
      <label for="M797"><strong>M79.7</strong> ‚Äî Fibromialgia</label>
    </div>

  </div>
</div>

    <!-- ===== Familia: Esclerosis m√∫ltiple (1) ===== -->
    <div class="familia" data-familia-id="fam-em" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-em-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-em-block', this)">+</button>
        Esclerosis m√∫ltiple<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-em-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G35" value="G35"><label for="G35"><strong>G35 ‚Äî Esclerosis m√∫ltiple</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Epilepsia (1) ===== -->
    <div class="familia" data-familia-id="fam-epilepsia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-epilepsia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-epilepsia-block', this)">+</button>
        Epilepsia<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-epilepsia-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G400" value="G40.0"><label for="G400"><strong>G40.0 ‚Äî Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G401" value="G40.1"><label for="G401"><strong>G40.1 ‚Äî Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G402" value="G40.2"><label for="G402"><strong>G40.2 ‚Äî Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G403" value="G40.3"><label for="G403"><strong>G40.3 ‚Äî Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G404" value="G40.4"><label for="G404"><strong>G40.4 ‚Äî Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G406" value="G40.6"><label for="G406"><strong>G40.6 ‚Äî Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G407" value="G40.7"><label for="G407"><strong>G40.7 ‚Äî Epilepsia (subtipo CIE-10)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G408" value="G40.8"><label for="G408"><strong>G40.8 ‚Äî Otras epilepsias y s√≠ndromes epil√©pticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="G409" value="G40.9"><label for="G409"><strong>G40.9 ‚Äî Epilepsia, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 06: ANEMIA CR√ìNICA ===================== -->
<div class="categoria-seccion" id="cat-anemia" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-anemia')">
    <h4>ü©∏ ANEMIA CR√ìNICA
      <span class="categoria-badge" id="badge-anemia">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-anemia">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-anemia">

    <!-- ===== Familia: Anemia cr√≥nica (1) ===== -->
    <div class="familia" data-familia-id="fam-anemia-cronica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-anemia-cronica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-anemia-cronica-block', this)">+</button>
        Anemia cr√≥nica<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-anemia-cronica-block">

        <!-- D50 -->
        <div class="subcategoria-header banner-anemia">D50 ‚Äî Anemia por deficiencia de hierro</div>

        <!-- D51.x -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D510" value="D51.0"><label for="D510"><strong>D51.0 ‚Äî Anemia megalobl√°stica por deficiencia de vitamina B12 debida a d√©ficit de factor intr√≠nseco</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D511" value="D51.1"><label for="D511"><strong>D51.1 ‚Äî Anemia megalobl√°stica por deficiencia de vitamina B12 debida a malabsorci√≥n selectiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D512" value="D51.2"><label for="D512"><strong>D51.2 ‚Äî Deficiencia diet√©tica de vitamina B12</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D513" value="D51.3"><label for="D513"><strong>D51.3 ‚Äî Otras anemias megalobl√°sticas por deficiencia de vitamina B12</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D518" value="D51.8"><label for="D518"><strong>D51.8 ‚Äî Otras anemias por deficiencia de vitamina B12</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D519" value="D51.9"><label for="D519"><strong>D51.9 ‚Äî Anemia por deficiencia de vitamina B12, no especificada</strong></label></div>

        <!-- D52.x -->
        <div class="subcategoria-header banner-anemia">D52.0 ‚Äî Anemia megalobl√°stica por deficiencia de folato secundaria a dieta</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D521" value="D52.1"><label for="D521"><strong>D52.1 ‚Äî Anemia megalobl√°stica por deficiencia de folato debida a f√°rmacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D528" value="D52.8"><label for="D528"><strong>D52.8 ‚Äî Otras anemias megalobl√°sticas por deficiencia de folato</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D529" value="D52.9"><label for="D529"><strong>D52.9 ‚Äî Anemia megalobl√°stica por deficiencia de folato, no especificada</strong></label></div>

        <!-- D53.x -->
        <div class="subcategoria-header banner-anemia">D53.0 ‚Äî Anemia megalobl√°stica, no especificada</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D531" value="D53.1"><label for="D531"><strong>D53.1 ‚Äî Otras anemias megalobl√°sticas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D532" value="D53.2"><label for="D532"><strong>D53.2 ‚Äî Anemia por deficiencia de vitamina B6</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D538" value="D53.8"><label for="D538"><strong>D53.8 ‚Äî Otras anemias nutricionales especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D539" value="D53.9"><label for="D539"><strong>D53.9 ‚Äî Anemia nutricional, no especificada</strong></label></div>

        <!-- D55.x -->
        <div class="subcategoria-header banner-anemia">D55.0 ‚Äî Anemia debida a deficiencia de G6PD</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D551" value="D55.1"><label for="D551"><strong>D55.1 ‚Äî Anemia debida a otros trastornos enzim√°ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D552" value="D55.2"><label for="D552"><strong>D55.2 ‚Äî Anemia debida a trastornos del metabolismo de la glucosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D553" value="D55.3"><label for="D553"><strong>D55.3 ‚Äî Anemia debida a trastornos del metabolismo de nucle√≥tidos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D558" value="D55.8"><label for="D558"><strong>D55.8 ‚Äî Otras anemias debidas a trastornos enzim√°ticos especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D559" value="D55.9"><label for="D559"><strong>D55.9 ‚Äî Anemia debida a trastornos enzim√°ticos, no especificada</strong></label></div>

        <!-- D56.x -->
        <div class="subcategoria-header banner-anemia">D56.0 ‚Äî Talasemia alfa</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D561" value="D56.1"><label for="D561"><strong>D56.1 ‚Äî Talasemia beta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D562" value="D56.2"><label for="D562"><strong>D56.2 ‚Äî Talasemia delta-beta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D563" value="D56.3"><label for="D563"><strong>D56.3 ‚Äî Otras talasemias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D564" value="D56.4"><label for="D564"><strong>D56.4 ‚Äî Persistencia hereditaria de hemoglobina fetal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D568" value="D56.8"><label for="D568"><strong>D56.8 ‚Äî Otras talasemias especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D569" value="D56.9"><label for="D569"><strong>D56.9 ‚Äî Talasemia, no especificada</strong></label></div>

        <!-- D57.x -->
        <div class="subcategoria-header banner-anemia">D57.0 ‚Äî Anemia drepanoc√≠tica con crisis</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D571" value="D57.1"><label for="D571"><strong>D57.1 ‚Äî Anemia drepanoc√≠tica sin crisis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D572" value="D57.2"><label for="D572"><strong>D57.2 ‚Äî Trastornos de c√©lulas falciformes heterocigotos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D573" value="D57.3"><label for="D573"><strong>D57.3 ‚Äî Trastornos de c√©lulas falciformes heterocigotos dobles</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D578" value="D57.8"><label for="D578"><strong>D57.8 ‚Äî Otros trastornos de c√©lulas falciformes</strong></label></div>

        <!-- D58.x -->
        <div class="subcategoria-header banner-anemia">D58.0 ‚Äî Esferocitosis hereditaria</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D581" value="D58.1"><label for="D581"><strong>D58.1 ‚Äî Eliptocitosis hereditaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D582" value="D58.2"><label for="D582"><strong>D58.2 ‚Äî Estomatocitosis hereditaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D588" value="D58.8"><label for="D588"><strong>D58.8 ‚Äî Otros trastornos especificados de gl√≥bulos rojos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D589" value="D58.9"><label for="D589"><strong>D58.9 ‚Äî Trastorno de gl√≥bulos rojos, no especificado</strong></label></div>

        <!-- D59.x -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D590" value="D59.0"><label for="D590"><strong>D59.0 ‚Äî Anemia hemol√≠tica autoinmune con anticuerpo caliente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D591" value="D59.1"><label for="D591"><strong>D59.1 ‚Äî Anemia hemol√≠tica autoinmune con anticuerpo fr√≠o</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D592" value="D59.2"><label for="D592"><strong>D59.2 ‚Äî Anemia hemol√≠tica autoinmune mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D593" value="D59.3"><label for="D593"><strong>D59.3 ‚Äî Anemia hemol√≠tica autoinmune de otro tipo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D594" value="D59.4"><label for="D594"><strong>D59.4 ‚Äî Anemia hemol√≠tica inducida por f√°rmacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D595" value="D59.5"><label for="D595"><strong>D59.5 ‚Äî Anemia hemol√≠tica inducida por otras sustancias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D596" value="D59.6"><label for="D596"><strong>D59.6 ‚Äî Anemia hemol√≠tica debida a anticuerpos contra aloant√≠genos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D598" value="D59.8"><label for="D598"><strong>D59.8 ‚Äî Otras anemias hemol√≠ticas adquiridas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D599" value="D59.9"><label for="D599"><strong>D59.9 ‚Äî Anemia hemol√≠tica adquirida, no especificada</strong></label></div>

        <!-- D60.x -->
        <div class="subcategoria-header banner-anemia">D60 ‚Äî Aplasia pura adquirida de serie roja, tipo agudo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D601" value="D60.1"><label for="D601"><strong>D60.1 ‚Äî Aplasia pura adquirida de serie roja, tipo cr√≥nico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D608" value="D60.8"><label for="D608"><strong>D60.8 ‚Äî Otras aplasias puras adquiridas de serie roja</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D609" value="D60.9"><label for="D609"><strong>D60.9 ‚Äî Aplasia pura adquirida de serie roja, no especificada</strong></label></div>

        <!-- D61.x -->
        <div class="subcategoria-header banner-anemia">D61 ‚Äî Otras anemias apl√°sicas</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D611" value="D61.1"><label for="D611"><strong>D61.1 ‚Äî Anemia apl√°sica inducida por f√°rmacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D612" value="D61.2"><label for="D612"><strong>D61.2 ‚Äî Anemia apl√°sica inducida por radiaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D613" value="D61.3"><label for="D613"><strong>D61.3 ‚Äî Anemia apl√°sica secundaria a otra causa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D618" value="D61.8"><label for="D618"><strong>D61.8 ‚Äî Otras anemias apl√°sicas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D619" value="D61.9"><label for="D619"><strong>D61.9 ‚Äî Anemia apl√°sica, no especificada</strong></label></div>

        <!-- D62 -->
        <div class="subcategoria-header banner-anemia">D62 ‚Äî Anemia posthemorr√°gica aguda</div>

        <!-- D63.x -->
        <div class="subcategoria-header banner-anemia">D63.0 ‚Äî Anemia en enfermedad neopl√°sica</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D638" value="D63.8"><label for="D638"><strong>D63.8 ‚Äî Anemia en otras enfermedades cr√≥nicas clasificadas en otra parte</strong></label></div>

        <!-- D64.x -->
        <div class="subcategoria-header banner-anemia">D64 ‚Äî Otras anemias</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D641" value="D64.1"><label for="D641"><strong>D64.1 ‚Äî Anemia siderobl√°stica adquirida secundaria a drogas y toxinas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D642" value="D64.2"><label for="D642"><strong>D64.2 ‚Äî Anemia siderobl√°stica adquirida secundaria a otras causas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D643" value="D64.3"><label for="D643"><strong>D64.3 ‚Äî Anemia siderobl√°stica, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D644" value="D64.4"><label for="D644"><strong>D64.4 ‚Äî Anemia diseritropoy√©tica cong√©nita</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D648" value="D64.8"><label for="D648"><strong>D64.8 ‚Äî Otras anemias especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D649" value="D64.9"><label for="D649"><strong>D64.9 ‚Äî Anemia, no especificada</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->


        <!-- ===================== CATEGOR√çA 07: PATOLOG√çAS METAB√ìLICAS ===================== -->
<div class="categoria-seccion" id="cat-metabolicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-metabolicas')">
    <h4>üß™ PATOLOG√çAS METAB√ìLICAS
      <span class="categoria-badge" id="badge-metabolicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-metabolicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-metabolicas">

    <!-- ===== Familia: Diabetes mellitus (2) ===== -->
    <div class="familia" data-familia-id="fam-diabetes" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-diabetes-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-diabetes-block', this)">+</button>
        Diabetes mellitus<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-diabetes-block">

        <!-- E10.x ‚Äî Diabetes mellitus insulinodependiente (tipo 1) -->
        <div class="subcategoria-header banner-diabetes">E10 ‚Äî Diabetes mellitus insulinodependiente (tipo 1)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E100" value="E10.0"><label for="E100"><strong>E10.0 ‚Äî Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E101" value="E10.1"><label for="E101"><strong>E10.1 ‚Äî Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E102" value="E10.2"><label for="E102"><strong>E10.2 ‚Äî Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E103" value="E10.3"><label for="E103"><strong>E10.3 ‚Äî Con complicaciones oft√°lmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E104" value="E10.4"><label for="E104"><strong>E10.4 ‚Äî Con complicaciones neurol√≥gicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E105" value="E10.5"><label for="E105"><strong>E10.5 ‚Äî Con complicaciones circulatorias perif√©ricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E106" value="E10.6"><label for="E106"><strong>E10.6 ‚Äî Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E107" value="E10.7"><label for="E107"><strong>E10.7 ‚Äî Con m√∫ltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E108" value="E10.8"><label for="E108"><strong>E10.8 ‚Äî Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E109" value="E10.9"><label for="E109"><strong>E10.9 ‚Äî Sin complicaciones</strong></label></div>

        <!-- E11.x ‚Äî Diabetes mellitus no insulinodependiente (tipo 2) -->
        <div class="subcategoria-header banner-diabetes">E11 ‚Äî Diabetes mellitus no insulinodependiente (tipo 2)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E110" value="E11.0"><label for="E110"><strong>E11.0 ‚Äî Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E111" value="E11.1"><label for="E111"><strong>E11.1 ‚Äî Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E112" value="E11.2"><label for="E112"><strong>E11.2 ‚Äî Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E113" value="E11.3"><label for="E113"><strong>E11.3 ‚Äî Con complicaciones oft√°lmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E114" value="E11.4"><label for="E114"><strong>E11.4 ‚Äî Con complicaciones neurol√≥gicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E115" value="E11.5"><label for="E115"><strong>E11.5 ‚Äî Con complicaciones circulatorias perif√©ricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E116" value="E11.6"><label for="E116"><strong>E11.6 ‚Äî Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E117" value="E11.7"><label for="E117"><strong>E11.7 ‚Äî Con m√∫ltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E118" value="E11.8"><label for="E118"><strong>E11.8 ‚Äî Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E119" value="E11.9"><label for="E119"><strong>E11.9 ‚Äî Sin complicaciones</strong></label></div>

        <!-- E12.x ‚Äî Diabetes mellitus relacionada con malnutrici√≥n -->
        <div class="subcategoria-header banner-diabetes">E12 ‚Äî Diabetes mellitus relacionada con malnutrici√≥n</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E120" value="E12.0"><label for="E120"><strong>E12.0 ‚Äî Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E121" value="E12.1"><label for="E121"><strong>E12.1 ‚Äî Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E122" value="E12.2"><label for="E122"><strong>E12.2 ‚Äî Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E123" value="E12.3"><label for="E123"><strong>E12.3 ‚Äî Con complicaciones oft√°lmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E124" value="E12.4"><label for="E124"><strong>E12.4 ‚Äî Con complicaciones neurol√≥gicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E125" value="E12.5"><label for="E125"><strong>E12.5 ‚Äî Con complicaciones circulatorias perif√©ricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E126" value="E12.6"><label for="E126"><strong>E12.6 ‚Äî Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E127" value="E12.7"><label for="E127"><strong>E12.7 ‚Äî Con m√∫ltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E128" value="E12.8"><label for="E128"><strong>E12.8 ‚Äî Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E129" value="E12.9"><label for="E129"><strong>E12.9 ‚Äî Sin complicaciones</strong></label></div>

        <!-- E13.x ‚Äî Otras diabetes especificadas -->
        <div class="subcategoria-header banner-diabetes">E13 ‚Äî Otras formas de diabetes mellitus, especificadas</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E130" value="E13.0"><label for="E130"><strong>E13.0 ‚Äî Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E131" value="E13.1"><label for="E131"><strong>E13.1 ‚Äî Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E132" value="E13.2"><label for="E132"><strong>E13.2 ‚Äî Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E133" value="E13.3"><label for="E133"><strong>E13.3 ‚Äî Con complicaciones oft√°lmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E134" value="E13.4"><label for="E134"><strong>E13.4 ‚Äî Con complicaciones neurol√≥gicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E135" value="E13.5"><label for="E135"><strong>E13.5 ‚Äî Con complicaciones circulatorias perif√©ricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E136" value="E13.6"><label for="E136"><strong>E13.6 ‚Äî Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E137" value="E13.7"><label for="E137"><strong>E13.7 ‚Äî Con m√∫ltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E138" value="E13.8"><label for="E138"><strong>E13.8 ‚Äî Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E139" value="E13.9"><label for="E139"><strong>E13.9 ‚Äî Sin complicaciones</strong></label></div>

        <!-- E14.x ‚Äî Diabetes mellitus, no especificada -->
        <div class="subcategoria-header banner-diabetes">E14 ‚Äî Diabetes mellitus, no especificada</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E140" value="E14.0"><label for="E140"><strong>E14.0 ‚Äî Con coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E141" value="E14.1"><label for="E141"><strong>E14.1 ‚Äî Con cetoacidosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E142" value="E14.2"><label for="E142"><strong>E14.2 ‚Äî Con complicaciones renales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E143" value="E14.3"><label for="E143"><strong>E14.3 ‚Äî Con complicaciones oft√°lmicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E144" value="E14.4"><label for="E144"><strong>E14.4 ‚Äî Con complicaciones neurol√≥gicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E145" value="E14.5"><label for="E145"><strong>E14.5 ‚Äî Con complicaciones circulatorias perif√©ricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E146" value="E14.6"><label for="E146"><strong>E14.6 ‚Äî Con otras complicaciones especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E147" value="E14.7"><label for="E147"><strong>E14.7 ‚Äî Con m√∫ltiples complicaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E148" value="E14.8"><label for="E148"><strong>E14.8 ‚Äî Con complicaciones no especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E149" value="E14.9"><label for="E149"><strong>E14.9 ‚Äî Sin complicaciones</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Dislipidemias (1) ===== -->
    <div class="familia" data-familia-id="fam-dislipidemias" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-dislipidemias-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-dislipidemias-block', this)">+</button>
        Dislipidemias<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-dislipidemias-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E780" value="E78.0"><label for="E780"><strong>E78.0 ‚Äî Hipercolesterolemia pura</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E781" value="E78.1"><label for="E781"><strong>E78.1 ‚Äî Hipertrigliceridemia pura</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E782" value="E78.2"><label for="E782"><strong>E78.2 ‚Äî Hiperlipidemia mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E783" value="E78.3"><label for="E783"><strong>E78.3 ‚Äî Hiperquilomicronemia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E784" value="E78.4"><label for="E784"><strong>E78.4 ‚Äî Otras hiperlipidemias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E785" value="E78.5"><label for="E785"><strong>E78.5 ‚Äî Hiperlipidemia, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E786" value="E78.6"><label for="E786"><strong>E78.6 ‚Äî Deficiencia de lipoprote√≠nas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E788" value="E78.8"><label for="E788"><strong>E78.8 ‚Äî Otros trastornos del metabolismo de las lipoprote√≠nas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E789" value="E78.9"><label for="E789"><strong>E78.9 ‚Äî Trastorno del metabolismo de las lipoprote√≠nas, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Hiperuricemia / Gota (1) ===== -->
    <div class="familia" data-familia-id="fam-hiperuricemia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hiperuricemia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hiperuricemia-block', this)">+</button>
        Hiperuricemia / Gota<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-hiperuricemia-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M100" value="M10.0"><label for="M100"><strong>M10.0 ‚Äî Gota idiop√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M101" value="M10.1"><label for="M101"><strong>M10.1 ‚Äî Gota por plomo (saturnina)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M102" value="M10.2"><label for="M102"><strong>M10.2 ‚Äî Gota debida a insuficiencia renal</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M103" value="M10.3"><label for="M103"><strong>M10.3 ‚Äî Otras gota secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M104" value="M10.4"><label for="M104"><strong>M10.4 ‚Äî Gota tof√°cea (cr√≥nica)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M109" value="M10.9"><label for="M109"><strong>M10.9 ‚Äî Gota, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Trastornos tiroideos (1) ===== -->
    <div class="familia" data-familia-id="fam-tiroideos" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tiroideos-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tiroideos-block', this)">+</button>
        Trastornos tiroideos<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-tiroideos-block">

        <!-- E01.x ‚Äî Trastornos por deficiencia de yodo y bocio -->
        <div class="subcategoria-header banner-tiroides">E01 ‚Äî Trastornos tiroideos asociados a deficiencia de yodo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E010" value="E01.0"><label for="E010"><strong>E01.0 ‚Äî Bocio difuso por deficiencia de yodo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E011" value="E01.1"><label for="E011"><strong>E01.1 ‚Äî Bocio multinodular por deficiencia de yodo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E012" value="E01.2"><label for="E012"><strong>E01.2 ‚Äî Bocio no especificado por deficiencia de yodo</strong></label></div>

        <!-- E02 ‚Äî Hipotiroidismo subcl√≠nico por deficiencia de yodo -->
        <div class="subcategoria-header banner-tiroides">E02 ‚Äî Hipotiroidismo subcl√≠nico por deficiencia de yodo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E02" value="E02"><label for="E02"><strong>E02 ‚Äî Hipotiroidismo subcl√≠nico por deficiencia de yodo</strong></label></div>

        <!-- E03.x ‚Äî Otros hipotiroidismos -->
        <div class="subcategoria-header banner-tiroides">E03 ‚Äî Otros hipotiroidismos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E030" value="E03.0"><label for="E030"><strong>E03.0 ‚Äî Hipotiroidismo cong√©nito con bocio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E031" value="E03.1"><label for="E031"><strong>E03.1 ‚Äî Hipotiroidismo cong√©nito sin bocio</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E032" value="E03.2"><label for="E032"><strong>E03.2 ‚Äî Hipotiroidismo inducido por f√°rmacos y otras sustancias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E033" value="E03.3"><label for="E033"><strong>E03.3 ‚Äî Hipotiroidismo postinfeccioso</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E034" value="E03.4"><label for="E034"><strong>E03.4 ‚Äî Atrofia adquirida de la gl√°ndula tiroides</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E035" value="E03.5"><label for="E035"><strong>E03.5 ‚Äî Mixedema coma</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E038" value="E03.8"><label for="E038"><strong>E03.8 ‚Äî Otros hipotiroidismos especificados</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E039" value="E03.9"><label for="E039"><strong>E03.9 ‚Äî Hipotiroidismo, no especificado</strong></label></div>

        <!-- E05.x ‚Äî Tirotoxicosis (hipertiroidismo) -->
        <div class="subcategoria-header banner-tiroides">E05 ‚Äî Tirotoxicosis (hipertiroidismo)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E050" value="E05.0"><label for="E050"><strong>E05.0 ‚Äî Tirotoxicosis con bocio difuso (Graves)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E051" value="E05.1"><label for="E051"><strong>E05.1 ‚Äî Tirotoxicosis con bocio t√≥xico multinodular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E052" value="E05.2"><label for="E052"><strong>E05.2 ‚Äî Tirotoxicosis con bocio t√≥xico nodular √∫nico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E053" value="E05.3"><label for="E053"><strong>E05.3 ‚Äî Tirotoxicosis por tiroiditis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E054" value="E05.4"><label for="E054"><strong>E05.4 ‚Äî Tirotoxicosis facticia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E055" value="E05.5"><label for="E055"><strong>E05.5 ‚Äî Crisis tiro t√≥xica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E058" value="E05.8"><label for="E058"><strong>E05.8 ‚Äî Otras tirotoxicosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="E059" value="E05.9"><label for="E059"><strong>E05.9 ‚Äî Tirotoxicosis, no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Obesidad (1) ===== -->
    <div class="familia" data-familia-id="fam-obesidad" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-obesidad-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-obesidad-block', this)">+</button>
        Obesidad<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-obesidad-block">
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E660" value="E66.0"><label for="E660"><strong>E66.0 ‚Äî Obesidad debida a exceso de calor√≠as</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E661" value="E66.1"><label for="E661"><strong>E66.1 ‚Äî Obesidad inducida por f√°rmacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E662" value="E66.2"><label for="E662"><strong>E66.2 ‚Äî Obesidad con hipoventilaci√≥n alveolar (s√≠ndrome de Pickwick)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E668" value="E66.8"><label for="E668"><strong>E66.8 ‚Äî Otras obesidades</strong></label></div>
        <div class="patologia-item"><input type="checkbox" name="patologia[]" class="patologia-checkbox" id="E669" value="E66.9"><label for="E669"><strong>E66.9 ‚Äî Obesidad, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 08: DIFICULTADES SOCIOECON√ìMICAS O PSICOSOCIALES ===================== -->
<div class="categoria-seccion" id="cat-socioeconomicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-socioeconomicas')">
    <h4>‚öñÔ∏è DIFICULTADES SOCIOECON√ìMICAS O PSICOSOCIALES
      <span class="categoria-badge" id="badge-socioeconomicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-socioeconomicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-socioeconomicas">

    <!-- ===== Familia: Dificultades socioecon√≥micas o psicosociales (1) ===== -->
    <div class="familia" data-familia-id="fam-socioeconomicas" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-socioeconomicas-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-socioeconomicas-block', this)">+</button>
        Dificultades socioecon√≥micas o psicosociales<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-socioeconomicas-block">

        <!-- Z55.x ‚Äî Problemas relacionados con la educaci√≥n y la alfabetizaci√≥n -->
        <div class="subcategoria-header banner-psicosocial">Z55 ‚Äî Problemas relacionados con la educaci√≥n y la alfabetizaci√≥n</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z550" value="Z55.0"><label for="Z550"><strong>Z55.0 ‚Äî Analfabetismo e instrucci√≥n inadecuada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z558" value="Z55.8"><label for="Z558"><strong>Z55.8 ‚Äî Otros problemas de educaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z559" value="Z55.9"><label for="Z559"><strong>Z55.9 ‚Äî Problema de educaci√≥n, no especificado</strong></label></div>

        <!-- Z56.x ‚Äî Problemas relacionados con el empleo y el desempleo -->
        <div class="subcategoria-header banner-psicosocial">Z56 ‚Äî Problemas relacionados con el empleo y el desempleo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z560" value="Z56.0"><label for="Z560"><strong>Z56.0 ‚Äî Desempleo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z561" value="Z56.1"><label for="Z561"><strong>Z56.1 ‚Äî Cambio de trabajo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z566" value="Z56.6"><label for="Z566"><strong>Z56.6 ‚Äî Otras dificultades f√≠sicas y mentales relacionadas con el trabajo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z567" value="Z56.7"><label for="Z567"><strong>Z56.7 ‚Äî Insatisfacci√≥n en el trabajo</strong></label></div>

        <!-- Z57.x ‚Äî Exposici√≥n ocupacional a factores de riesgo -->
        <div class="subcategoria-header banner-psicosocial">Z57 ‚Äî Exposici√≥n ocupacional a factores de riesgo</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z570" value="Z57.0"><label for="Z570"><strong>Z57.0 ‚Äî Exposici√≥n ocupacional a ruido</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z571" value="Z57.1"><label for="Z571"><strong>Z57.1 ‚Äî Exposici√≥n ocupacional a radiaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z572" value="Z57.2"><label for="Z572"><strong>Z57.2 ‚Äî Exposici√≥n ocupacional a polvo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z573" value="Z57.3"><label for="Z573"><strong>Z57.3 ‚Äî Exposici√≥n ocupacional a humos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z574" value="Z57.4"><label for="Z574"><strong>Z57.4 ‚Äî Exposici√≥n ocupacional a gases</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z575" value="Z57.5"><label for="Z575"><strong>Z57.5 ‚Äî Exposici√≥n ocupacional a vapores</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z576" value="Z57.6"><label for="Z576"><strong>Z57.6 ‚Äî Exposici√≥n ocupacional a temperaturas extremas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z577" value="Z57.7"><label for="Z577"><strong>Z57.7 ‚Äî Exposici√≥n ocupacional a vibraci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z578" value="Z57.8"><label for="Z578"><strong>Z57.8 ‚Äî Exposici√≥n ocupacional a otros riesgos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z579" value="Z57.9"><label for="Z579"><strong>Z57.9 ‚Äî Exposici√≥n ocupacional a riesgo no especificado</strong></label></div>

        <!-- Z58.x ‚Äî Problemas relacionados con el entorno f√≠sico -->
        <div class="subcategoria-header banner-psicosocial">Z58 ‚Äî Problemas relacionados con el entorno f√≠sico</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z580" value="Z58.0"><label for="Z580"><strong>Z58.0 ‚Äî Exposici√≥n a contaminaci√≥n atmosf√©rica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z581" value="Z58.1"><label for="Z581"><strong>Z58.1 ‚Äî Exposici√≥n a contaminaci√≥n del agua</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z582" value="Z58.2"><label for="Z582"><strong>Z58.2 ‚Äî Exposici√≥n a contaminaci√≥n del suelo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z583" value="Z58.3"><label for="Z583"><strong>Z58.3 ‚Äî Exposici√≥n a contaminaci√≥n por radiaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z584" value="Z58.4"><label for="Z584"><strong>Z58.4 ‚Äî Exposici√≥n a contaminaci√≥n ac√∫stica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z585" value="Z58.5"><label for="Z585"><strong>Z58.5 ‚Äî Exposici√≥n a otras contaminaciones espec√≠ficas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z588" value="Z58.8"><label for="Z588"><strong>Z58.8 ‚Äî Otros problemas del entorno f√≠sico</strong></label></div>

        <!-- Z59.x ‚Äî Problemas relacionados con la vivienda y las condiciones econ√≥micas -->
        <div class="subcategoria-header banner-psicosocial">Z59 ‚Äî Problemas relacionados con la vivienda y las condiciones econ√≥micas</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z590" value="Z59.0"><label for="Z590"><strong>Z59.0 ‚Äî Falta de vivienda</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z591" value="Z59.1"><label for="Z591"><strong>Z59.1 ‚Äî Vivienda inadecuada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z594" value="Z59.4"><label for="Z594"><strong>Z59.4 ‚Äî Falta de recursos adecuados de alimentos seguros</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z595" value="Z59.5"><label for="Z595"><strong>Z59.5 ‚Äî Pobreza extrema</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z596" value="Z59.6"><label for="Z596"><strong>Z59.6 ‚Äî Baja renta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z597" value="Z59.7"><label for="Z597"><strong>Z59.7 ‚Äî Vivienda insegura</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z598" value="Z59.8"><label for="Z598"><strong>Z59.8 ‚Äî Otros problemas de vivienda y econ√≥micos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z599" value="Z59.9"><label for="Z599"><strong>Z59.9 ‚Äî Problemas de vivienda y econ√≥micos, no especificados</strong></label></div>

        <!-- Z60.x ‚Äî Problemas relacionados con el entorno social -->
        <div class="subcategoria-header banner-psicosocial">Z60 ‚Äî Problemas relacionados con el entorno social</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z605" value="Z60.5"><label for="Z605"><strong>Z60.5 ‚Äî Aislamiento social</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z608" value="Z60.8"><label for="Z608"><strong>Z60.8 ‚Äî Otros problemas relacionados con el entorno social</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z609" value="Z60.9"><label for="Z609"><strong>Z60.9 ‚Äî Problema relacionado con el entorno social, no especificado</strong></label></div>

        <!-- Z62.x / Z63.x ‚Äî Problemas relacionados con crianza y relaciones -->
        <div class="subcategoria-header banner-psicosocial">Z62 / Z63 ‚Äî Problemas relacionados con crianza y relaciones</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z625" value="Z62.5"><label for="Z625"><strong>Z62.5 ‚Äî Otras experiencias adversas en la ni√±ez</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z628" value="Z62.8"><label for="Z628"><strong>Z62.8 ‚Äî Otros problemas relacionados con crianza</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z629" value="Z62.9"><label for="Z629"><strong>Z62.9 ‚Äî Problemas relacionados con crianza, no especificado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z638" value="Z63.8"><label for="Z638"><strong>Z63.8 ‚Äî Otros problemas relacionados con la familia y el apoyo primario</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z639" value="Z63.9"><label for="Z639"><strong>Z63.9 ‚Äî Problema familiar no especificado</strong></label></div>

        <!-- Z65.x ‚Äî Otros problemas psicosociales -->
        <div class="subcategoria-header banner-psicosocial">Z65 ‚Äî Otros problemas psicosociales</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z658" value="Z65.8"><label for="Z658"><strong>Z65.8 ‚Äî Otros problemas especificados relacionados con circunstancias psicosociales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Z659" value="Z65.9"><label for="Z659"><strong>Z65.9 ‚Äî Problema psicosocial, no especificado</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 09: PATOLOG√çAS GASTROINTESTINALES ===================== -->
<div class="categoria-seccion" id="cat-gastrointestinales" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-gastrointestinales')">
    <h4>üçΩÔ∏è PATOLOG√çAS GASTROINTESTINALES
      <span class="categoria-badge" id="badge-gastrointestinales">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-gastrointestinales">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-gastrointestinales">

    <!-- ===== Familia: Enfermedad hep√°tica (1) ===== -->
    <div class="familia" data-familia-id="fam-enfermedad-hepatica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-enfermedad-hepatica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-enfermedad-hepatica-block', this)">+</button>
        Enfermedad hep√°tica<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-enfermedad-hepatica-block">

        <!-- B18.x ‚Äî Hepatitis viral cr√≥nica -->
        <div class="subcategoria-header banner-hepaticas">B18 ‚Äî Hepatitis viral cr√≥nica</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B180" value="B18.0"><label for="B180"><strong>B18.0 ‚Äî Hepatitis viral cr√≥nica B con agente delta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B181" value="B18.1"><label for="B181"><strong>B18.1 ‚Äî Hepatitis viral cr√≥nica B sin agente delta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B182" value="B18.2"><label for="B182"><strong>B18.2 ‚Äî Hepatitis viral cr√≥nica C</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B188" value="B18.8"><label for="B188"><strong>B18.8 ‚Äî Otras hepatitis virales cr√≥nicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B189" value="B18.9"><label for="B189"><strong>B18.9 ‚Äî Hepatitis viral cr√≥nica, no especificada</strong></label></div>

        <!-- K70.x ‚Äî Enfermedad hep√°tica alcoh√≥lica -->
        <div class="subcategoria-header banner-hepaticas">K70 ‚Äî Enfermedad hep√°tica alcoh√≥lica</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K700" value="K70.0"><label for="K700"><strong>K70.0 ‚Äî H√≠gado graso alcoh√≥lico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K701" value="K70.1"><label for="K701"><strong>K70.1 ‚Äî Hepatitis alcoh√≥lica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K702" value="K70.2"><label for="K702"><strong>K70.2 ‚Äî Fibrosis y esclerosis hep√°tica alcoh√≥lica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K703" value="K70.3"><label for="K703"><strong>K70.3 ‚Äî Cirrosis hep√°tica alcoh√≥lica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K704" value="K70.4"><label for="K704"><strong>K70.4 ‚Äî Insuficiencia hep√°tica alcoh√≥lica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K709" value="K70.9"><label for="K709"><strong>K70.9 ‚Äî Enfermedad hep√°tica alcoh√≥lica, no especificada</strong></label></div>

        <!-- K71.x ‚Äî Enfermedad t√≥xica del h√≠gado -->
        <div class="subcategoria-header banner-hepaticas">K71 ‚Äî Enfermedad t√≥xica del h√≠gado</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K710" value="K71.0"><label for="K710"><strong>K71.0 ‚Äî Con colestasis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K711" value="K71.1"><label for="K711"><strong>K71.1 ‚Äî Con necrosis hep√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K712" value="K71.2"><label for="K712"><strong>K71.2 ‚Äî Con hepatitis aguda</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K713" value="K71.3"><label for="K713"><strong>K71.3 ‚Äî Con hepatitis cr√≥nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K714" value="K71.4"><label for="K714"><strong>K71.4 ‚Äî Con fibrosis y cirrosis hep√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K715" value="K71.5"><label for="K715"><strong>K71.5 ‚Äî Con insuficiencia hep√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K716" value="K71.6"><label for="K716"><strong>K71.6 ‚Äî Con otros trastornos hep√°ticos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K717" value="K71.7"><label for="K717"><strong>K71.7 ‚Äî Con hepatomegalia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K718" value="K71.8"><label for="K718"><strong>K71.8 ‚Äî Otras enfermedades t√≥xicas del h√≠gado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K719" value="K71.9"><label for="K719"><strong>K71.9 ‚Äî Enfermedad t√≥xica del h√≠gado, no especificada</strong></label></div>

        <!-- K72.1 ‚Äî Insuficiencia hep√°tica cr√≥nica -->
        <div class="subcategoria-header banner-hepaticas">K72 ‚Äî Insuficiencia hep√°tica (no clasificada en otra parte)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K721" value="K72.1"><label for="K721"><strong>K72.1 ‚Äî Insuficiencia hep√°tica cr√≥nica</strong></label></div>

        <!-- K73.x ‚Äî Hepatitis cr√≥nica (no clasificada en otra parte) -->
        <div class="subcategoria-header banner-hepaticas">K73 ‚Äî Hepatitis cr√≥nica (no clasificada en otra parte)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K730" value="K73.0"><label for="K730"><strong>K73.0 ‚Äî Hepatitis cr√≥nica persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K731" value="K73.1"><label for="K731"><strong>K73.1 ‚Äî Hepatitis cr√≥nica lobular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K732" value="K73.2"><label for="K732"><strong>K73.2 ‚Äî Hepatitis cr√≥nica activa, no clasificada en otra parte</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K738" value="K73.8"><label for="K738"><strong>K73.8 ‚Äî Otras hepatitis cr√≥nicas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K739" value="K73.9"><label for="K739"><strong>K73.9 ‚Äî Hepatitis cr√≥nica, no especificada</strong></label></div>

        <!-- K74.0‚ÄìK74.5 ‚Äî Fibrosis y cirrosis del h√≠gado -->
        <div class="subcategoria-header banner-hepaticas">K74 ‚Äî Fibrosis y cirrosis del h√≠gado</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K740" value="K74.0"><label for="K740"><strong>K74.0 ‚Äî Fibrosis hep√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K741" value="K74.1"><label for="K741"><strong>K74.1 ‚Äî Esclerosis hep√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K742" value="K74.2"><label for="K742"><strong>K74.2 ‚Äî Fibrosis y esclerosis hep√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K743" value="K74.3"><label for="K743"><strong>K74.3 ‚Äî Cirrosis biliar primaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K744" value="K74.4"><label for="K744"><strong>K74.4 ‚Äî Cirrosis biliar secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K745" value="K74.5"><label for="K745"><strong>K74.5 ‚Äî Cirrosis biliar, no especificada</strong></label></div>

        <!-- K76.6 ‚Äî Hipertensi√≥n portal -->
        <div class="subcategoria-header banner-hepaticas">K76 ‚Äî Otros trastornos del h√≠gado</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K766" value="K76.6"><label for="K766"><strong>K76.6 ‚Äî Hipertensi√≥n portal</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enteritis cr√≥nica / colitis ulcerosa / Crohn (1) ===== -->
    <div class="familia" data-familia-id="fam-enteritis-cronica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-enteritis-cronica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-enteritis-cronica-block', this)">+</button>
        Enteritis cr√≥nica / colitis ulcerosa / Crohn<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-enteritis-cronica-block">

        <!-- K50.x ‚Äî Enfermedad de Crohn -->
        <div class="subcategoria-header banner-gastro">K50 ‚Äî Enfermedad de Crohn</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K500" value="K50.0"><label for="K500"><strong>K50.0 ‚Äî Enfermedad de Crohn del intestino delgado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K501" value="K50.1"><label for="K501"><strong>K50.1 ‚Äî Enfermedad de Crohn del intestino grueso</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K508" value="K50.8"><label for="K508"><strong>K50.8 ‚Äî Otras formas de enfermedad de Crohn</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K509" value="K50.9"><label for="K509"><strong>K50.9 ‚Äî Enfermedad de Crohn, no especificada</strong></label></div>

        <!-- K51.0‚ÄìK51.3 ‚Äî Colitis ulcerosa -->
        <div class="subcategoria-header banner-gastro">K51 ‚Äî Colitis ulcerosa</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K510" value="K51.0"><label for="K510"><strong>K51.0 ‚Äî Colitis ulcerosa (pancolitis)</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K511" value="K51.1"><label for="K511"><strong>K51.1 ‚Äî Proctitis ulcerosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K512" value="K51.2"><label for="K512"><strong>K51.2 ‚Äî Proctosigmoiditis ulcerosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K513" value="K51.3"><label for="K513"><strong>K51.3 ‚Äî Colitis ulcerosa distal (rectosigmoiditis)</strong></label></div>

        <!-- K52.0‚ÄìK52.3, K52.8‚ÄìK52.9 ‚Äî Gastroenteritis/colitis no infecciosas -->
        <div class="subcategoria-header banner-gastro">K52 ‚Äî Gastroenteritis y colitis no infecciosas</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K520" value="K52.0"><label for="K520"><strong>K52.0 ‚Äî Gastroenteritis y colitis no infecciosas debidas a radiaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K521" value="K52.1"><label for="K521"><strong>K52.1 ‚Äî Gastroenteritis y colitis t√≥xicas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K522" value="K52.2"><label for="K522"><strong>K52.2 ‚Äî Gastroenteritis y colitis al√©rgicas y diet√©ticas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K523" value="K52.3"><label for="K523"><strong>K52.3 ‚Äî Colitis inducida por f√°rmacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K528" value="K52.8"><label for="K528"><strong>K52.8 ‚Äî Otras gastroenteritis y colitis no infecciosas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="K529" value="K52.9"><label for="K529"><strong>K52.9 ‚Äî Gastroenteritis y colitis no infecciosas, no especificadas</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 10: PATOLOG√çAS PULMONARES ===================== -->
<div class="categoria-seccion" id="cat-pulmonares" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-pulmonares')">
    <h4>üå¨Ô∏è PATOLOG√çAS PULMONARES
      <span class="categoria-badge" id="badge-pulmonares">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-pulmonares">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-pulmonares">

    <!-- ===== Familia: Asma (1) ===== -->
    <div class="familia" data-familia-id="fam-asma" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-asma-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-asma-block', this)">+</button>
        Asma<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-asma-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J450" value="J45.0"><label for="J450"><strong>J45.0 ‚Äî Asma predominantemente al√©rgica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J451" value="J45.1"><label for="J451"><strong>J45.1 ‚Äî Asma no al√©rgica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J458" value="J45.8"><label for="J458"><strong>J45.8 ‚Äî Asma mixta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J459" value="J45.9"><label for="J459"><strong>J45.9 ‚Äî Asma no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J46" value="J46"><label for="J46"><strong>J46 ‚Äî Estado asm√°tico</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedad pulmonar obstructiva cr√≥nica (EPOC) (1) ===== -->
    <div class="familia" data-familia-id="fam-epoc" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-epoc-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-epoc-block', this)">+</button>
        Enfermedad pulmonar obstructiva cr√≥nica (EPOC)<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-epoc-block">

        <!-- J41.x ‚Äî Bronquitis cr√≥nica simple y mucopurulenta -->
        <div class="subcategoria-header banner-respiratorias">J41 ‚Äî Bronquitis cr√≥nica simple y mucopurulenta</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J410" value="J41.0"><label for="J410"><strong>J41.0 ‚Äî Bronquitis cr√≥nica simple</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J411" value="J41.1"><label for="J411"><strong>J41.1 ‚Äî Bronquitis cr√≥nica mucopurulenta</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J418" value="J41.8"><label for="J418"><strong>J41.8 ‚Äî Bronquitis cr√≥nica mixta simple y mucopurulenta</strong></label></div>

        <!-- J42 ‚Äî Bronquitis cr√≥nica no especificada -->
        <div class="subcategoria-header banner-respiratorias">J42 ‚Äî Bronquitis cr√≥nica no especificada</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J42" value="J42"><label for="J42"><strong>J42 ‚Äî Bronquitis cr√≥nica no especificada</strong></label></div>

        <!-- J43.x ‚Äî Enfisema -->
        <div class="subcategoria-header banner-respiratorias">J43 ‚Äî Enfisema</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J430" value="J43.0"><label for="J430"><strong>J43.0 ‚Äî Enfisema macrosc√≥pico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J431" value="J43.1"><label for="J431"><strong>J43.1 ‚Äî Enfisema panlobular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J432" value="J43.2"><label for="J432"><strong>J43.2 ‚Äî Enfisema centrolobular</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J438" value="J43.8"><label for="J438"><strong>J43.8 ‚Äî Otras formas de enfisema</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J439" value="J43.9"><label for="J439"><strong>J43.9 ‚Äî Enfisema, no especificado</strong></label></div>

        <!-- J44.x ‚Äî Otras enfermedades pulmonares obstructivas cr√≥nicas -->
        <div class="subcategoria-header banner-respiratorias">J44 ‚Äî Otras enfermedades pulmonares obstructivas cr√≥nicas</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J440" value="J44.0"><label for="J440"><strong>J44.0 ‚Äî EPOC con infecci√≥n respiratoria aguda inferior</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J441" value="J44.1"><label for="J441"><strong>J44.1 ‚Äî EPOC con exacerbaci√≥n aguda, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J448" value="J44.8"><label for="J448"><strong>J44.8 ‚Äî Otras EPOC especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="J449" value="J44.9"><label for="J449"><strong>J44.9 ‚Äî EPOC, no especificada</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 11: PATOLOG√çAS RENALES Y UROL√ìGICAS ===================== -->
<div class="categoria-seccion" id="cat-renales" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-renales')">
    <h4>üíß PATOLOG√çAS RENALES Y UROL√ìGICAS
      <span class="categoria-badge" id="badge-renales">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-renales">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-renales">

    <!-- ===== Familia: Enfermedad renal cr√≥nica (1) ===== -->
    <div class="familia" data-familia-id="fam-erc" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-erc-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-erc-block', this)">+</button>
        Enfermedad renal cr√≥nica<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-erc-block">

        <!-- N15.x -->
        <div class="subcategoria-header banner-renales">N15 ‚Äî Enfermedades t√∫bulo-intersticiales renales</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N150" value="N15.0"><label for="N150"><strong>N15.0 ‚Äî Absceso renal y perinefr√≠tico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N151" value="N15.1"><label for="N151"><strong>N15.1 ‚Äî Nefritis cr√≥nica intersticial</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N158" value="N15.8"><label for="N158"><strong>N15.8 ‚Äî Otras enfermedades renales intersticiales especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N159" value="N15.9"><label for="N159"><strong>N15.9 ‚Äî Enfermedad renal intersticial, no especificada</strong></label></div>

        <!-- N18.x -->
        <div class="subcategoria-header banner-renales">N18 ‚Äî Enfermedad renal cr√≥nica</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N181" value="N18.1"><label for="N181"><strong>N18.1 ‚Äî ERC estadio 1</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N182" value="N18.2"><label for="N182"><strong>N18.2 ‚Äî ERC estadio 2</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N183" value="N18.3"><label for="N183"><strong>N18.3 ‚Äî ERC estadio 3</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N189" value="N18.9"><label for="N189"><strong>N18.9 ‚Äî ERC no especificada</strong></label></div>

        <!-- N19 -->
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N19" value="N19"><label for="N19"><strong>N19 ‚Äî Insuficiencia renal no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Enfermedad renal cr√≥nica avanzada (2) ===== -->
    <div class="familia" data-familia-id="fam-erc-avanzada" data-points="2">
      <div class="familia-header" onclick="toggleFamilia('fam-erc-avanzada-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-erc-avanzada-block', this)">+</button>
        Enfermedad renal cr√≥nica avanzada<span class="badge-puntos">(2)</span>
      </div>
      <div class="familia-content collapsed" id="fam-erc-avanzada-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N184" value="N18.4"><label for="N184"><strong>N18.4 ‚Äî ERC estadio 4</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N185" value="N18.5"><label for="N185"><strong>N18.5 ‚Äî ERC estadio 5</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N186" value="N18.6"><label for="N186"><strong>N18.6 ‚Äî ERC en tratamiento de di√°lisis</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Hipertrofia prost√°tica benigna (1) ===== -->
    <div class="familia" data-familia-id="fam-hiperplasia-prostatica" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hiperplasia-prostatica-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hiperplasia-prostatica-block', this)">+</button>
        Hipertrofia prost√°tica benigna<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-hiperplasia-prostatica-block">
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="N40" value="N40"><label for="N40"><strong>N40 ‚Äî Hipertrofia prost√°tica benigna</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 12: PATOLOG√çAS OFTALMOL√ìGICAS ===================== -->
<div class="categoria-seccion" id="cat-oftalmologicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-oftalmologicas')">
    <h4>üëÅÔ∏è PATOLOG√çAS OFTALMOL√ìGICAS
      <span class="categoria-badge" id="badge-oftalmologicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-oftalmologicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-oftalmologicas">

   <!-- ===== Familia: Glaucoma (1) ===== -->
    <div class="familia" data-familia-id="fam-glaucoma" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-glaucoma-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-glaucoma-block', this)">+</button>
        Glaucoma <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-glaucoma-block">

    <!-- H40.x ‚Äî Glaucoma -->
    <div class="subcategoria-header banner-oftalmo">H40 ‚Äî Glaucoma</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H401" name="patologia[]" value="H40.1" data-points="1"><label for="H401"><strong>H40.1 ‚Äî Glaucoma primario de √°ngulo abierto</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H402" name="patologia[]" value="H40.2" data-points="1"><label for="H402"><strong>H40.2 ‚Äî Glaucoma primario de √°ngulo cerrado</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H403" name="patologia[]" value="H40.3" data-points="1"><label for="H403"><strong>H40.3 ‚Äî Glaucoma secundario a traumatismo ocular</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H404" name="patologia[]" value="H40.4" data-points="1"><label for="H404"><strong>H40.4 ‚Äî Glaucoma secundario a inflamaci√≥n ocular</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H405" name="patologia[]" value="H40.5" data-points="1"><label for="H405"><strong>H40.5 ‚Äî Glaucoma secundario a otros trastornos del ojo</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H406" name="patologia[]" value="H40.6" data-points="1"><label for="H406"><strong>H40.6 ‚Äî Glaucoma secundario a f√°rmacos</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H408" name="patologia[]" value="H40.8" data-points="1"><label for="H408"><strong>H40.8 ‚Äî Otros glaucomas</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H409" name="patologia[]" value="H40.9" data-points="1"><label for="H409"><strong>H40.9 ‚Äî Glaucoma, no especificado</strong></label></div>

    <!-- H42.x ‚Äî Glaucoma en enfermedades clasificadas en otra parte -->
    <div class="subcategoria-header banner-oftalmo">H42 ‚Äî Glaucoma en enfermedades clasificadas en otra parte</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H420" name="patologia[]" value="H42.0" data-points="1"><label for="H420"><strong>H42.0 ‚Äî En enfermedades endocrinas, nutricionales y metab√≥licas</strong></label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H428" name="patologia[]" value="H42.8" data-points="1"><label for="H428"><strong>H42.8 ‚Äî En otras enfermedades clasificadas en otra parte</strong></label></div>
  </div>
</div>

    <!-- ===== Familia: Catarata / Retinopat√≠a (1) ===== -->
    <div class="familia" data-familia-id="fam-catarata-retinopatia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-catarata-retinopatia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-catarata-retinopatia-block', this)">+</button>
        Catarata / Retinopat√≠a <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-catarata-retinopatia-block">

    <!-- H25 ‚Äî Catarata senil -->
    <div class="subcategoria-header banner-oftalmo">H25 ‚Äî Catarata senil</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H250" name="patologia[]" value="H25.0" data-points="1"><label for="H250"><strong>H25.0</strong>Catarata senil nuclear</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H251" name="patologia[]" value="H25.1" data-points="1"><label for="H251"><strong>H25.1</strong>Catarata senil cortical</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H252" name="patologia[]" value="H25.2" data-points="1"><label for="H252"><strong>H25.2</strong>Catarata senil subcapsular posterior</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H258" name="patologia[]" value="H25.8" data-points="1"><label for="H258"><strong>H25.8</strong>Otras cataratas seniles</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H259" name="patologia[]" value="H25.9" data-points="1"><label for="H259"><strong>H25.9</strong>Catarata senil, no especificada</label></div>

    <!-- H26 ‚Äî Otras cataratas -->
    <div class="subcategoria-header banner-oftalmo">H26 ‚Äî Otras cataratas</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H260" name="patologia[]" value="H26.0" data-points="1"><label for="H260"><strong>H26.0</strong>Catarata infantil, juvenil o presenil</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H261" name="patologia[]" value="H26.1" data-points="1"><label for="H261"><strong>H26.1</strong>Catarata traum√°tica</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H262" name="patologia[]" value="H26.2" data-points="1"><label for="H262"><strong>H26.2</strong>Catarata complicada</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H263" name="patologia[]" value="H26.3" data-points="1"><label for="H263"><strong>H26.3</strong>Catarata inducida por f√°rmacos</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H264" name="patologia[]" value="H26.4" data-points="1"><label for="H264"><strong>H26.4</strong>After-cataract/Opacificaci√≥n capsular</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H268" name="patologia[]" value="H26.8" data-points="1"><label for="H268"><strong>H26.8</strong>Otras cataratas especificadas</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H269" name="patologia[]" value="H26.9" data-points="1"><label for="H269"><strong>H26.9</strong>Catarata, no especificada</label></div>

    <!-- H28 ‚Äî Cambios del cristalino en enfermedades clasificadas en otra parte -->
    <div class="subcategoria-header">H28 ‚Äî Cambios del cristalino en otras enfermedades</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H280" name="patologia[]" value="H28.0" data-points="1"><label for="H280"><strong>H28.0</strong>Catarata en diabetes y otras enfermedades</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H281" name="patologia[]" value="H28.1" data-points="1"><label for="H281"><strong>H28.1</strong>Cambios del cristalino en otras enfermedades</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H282" name="patologia[]" value="H28.2" data-points="1"><label for="H282"><strong>H28.2</strong>Cambios del cristalino postradiaci√≥n</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H288" name="patologia[]" value="H28.8" data-points="1"><label for="H288"><strong>H28.8</strong>Otros cambios del cristalino</label></div>

    <!-- Q12 ‚Äî Anomal√≠as cong√©nitas del cristalino -->
    <div class="subcategoria-header banner-oftalmo">Q12 ‚Äî Anomal√≠as cong√©nitas del cristalino</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q120" name="patologia[]" value="Q12.0" data-points="1"><label for="Q120"><strong>Q12.0</strong>Afaquia cong√©nita</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q121" name="patologia[]" value="Q12.1" data-points="1"><label for="Q121"><strong>Q12.1</strong>Dislocaci√≥n cong√©nita del cristalino</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q122" name="patologia[]" value="Q12.2" data-points="1"><label for="Q122"><strong>Q12.2</strong>Esferofaquia cong√©nita</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q123" name="patologia[]" value="Q12.3" data-points="1"><label for="Q123"><strong>Q12.3</strong>Microfaquia cong√©nita</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q124" name="patologia[]" value="Q12.4" data-points="1"><label for="Q124"><strong>Q12.4</strong>Coloboma del cristalino</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q128" name="patologia[]" value="Q12.8" data-points="1"><label for="Q128"><strong>Q12.8</strong>Otras anomal√≠as cong√©nitas del cristalino</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="Q129" name="patologia[]" value="Q12.9" data-points="1"><label for="Q129"><strong>Q12.9</strong>Anomal√≠a cong√©nita del cristalino, no especificada</label></div>
  </div>
</div>

    <!-- ===== Familia: Ceguera (1) ===== -->
    <div class="familia" data-familia-id="fam-ceguera" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-ceguera-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ceguera-block', this)">+</button>
        Ceguera <span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-ceguera-block">

    <!-- H54 ‚Äî Ceguera y disminuci√≥n de la agudeza visual -->
    <div class="subcategoria-header banner-oftalmo">H54 ‚Äî Ceguera y disminuci√≥n de la agudeza visual</div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H540" name="patologia[]" value="H54.0" data-points="1"><label for="H540"><strong>H54.0</strong>Ceguera binocular</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H541" name="patologia[]" value="H54.1" data-points="1"><label for="H541"><strong>H54.1</strong>Ceguera monocular y visi√≥n reducida contralateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H542" name="patologia[]" value="H54.2" data-points="1"><label for="H542"><strong>H54.2</strong>Disminuci√≥n grave de la agudeza visual, bilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H543" name="patologia[]" value="H54.3" data-points="1"><label for="H543"><strong>H54.3</strong>Disminuci√≥n moderada de la agudeza visual, bilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H544" name="patologia[]" value="H54.4" data-points="1"><label for="H544"><strong>H54.4</strong>Disminuci√≥n leve de la agudeza visual, bilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H545" name="patologia[]" value="H54.5" data-points="1"><label for="H545"><strong>H54.5</strong>Disminuci√≥n no especificada de la agudeza visual</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H546" name="patologia[]" value="H54.6" data-points="1"><label for="H546"><strong>H54.6</strong>Ceguera unilateral</label></div>
    <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H547" name="patologia[]" value="H54.7" data-points="1"><label for="H547"><strong>H54.7</strong>Ceguera, no especificada</label></div>
  </div>
</div>

    <!-- ===== Familia: Presbiacusia / Hipoacusia / Sordera (1) ===== -->
    <div class="familia" data-familia-id="fam-hipoacusia" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-hipoacusia-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-hipoacusia-block', this)">+</button>
        Presbiacusia / Hipoacusia / Sordera<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-hipoacusia-block">
        
        <!-- H90.x ‚Äî Hipoacusia de transmisi√≥n y neurosensorial -->
        <div class="subcategoria-header">H90 ‚Äî Hipoacusia de transmisi√≥n y neurosensorial</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H900" name="patologia[]" value="H90.0" data-points="1"><label for="H900"><strong>H90.0</strong> ‚Äî Hipoacusia conductiva bilateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H901" name="patologia[]" value="H90.1" data-points="1"><label for="H901"><strong>H90.1</strong> ‚Äî Hipoacusia conductiva unilateral con audici√≥n irrestricta contralateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H902" name="patologia[]" value="H90.2" data-points="1"><label for="H902"><strong>H90.2</strong> ‚Äî Hipoacusia conductiva, no especificada</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H903" name="patologia[]" value="H90.3" data-points="1"><label for="H903"><strong>H90.3</strong> ‚Äî Hipoacusia neurosensorial bilateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H904" name="patologia[]" value="H90.4" data-points="1"><label for="H904"><strong>H90.4</strong> ‚Äî Hipoacusia neurosensorial unilateral con audici√≥n irrestricta contralateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H905" name="patologia[]" value="H90.5" data-points="1"><label for="H905"><strong>H90.5</strong> ‚Äî Hipoacusia neurosensorial, no especificada</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H906" name="patologia[]" value="H90.6" data-points="1"><label for="H906"><strong>H90.6</strong> ‚Äî Hipoacusia mixta bilateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H907" name="patologia[]" value="H90.7" data-points="1"><label for="H907"><strong>H90.7</strong> ‚Äî Hipoacusia mixta unilateral con audici√≥n irrestricta contralateral</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H908" name="patologia[]" value="H90.8" data-points="1"><label for="H908"><strong>H90.8</strong> ‚Äî Hipoacusia mixta, no especificada</label></div>

        <!-- H91.x ‚Äî Otras hipoacusias -->
        <div class="subcategoria-header">H91 ‚Äî Otras hipoacusias</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H910" name="patologia[]" value="H91.0" data-points="1"><label for="H910"><strong>H91.0</strong> ‚Äî Hipoacusia otot√≥xica</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H911" name="patologia[]" value="H91.1" data-points="1"><label for="H911"><strong>H91.1</strong> ‚Äî Presbiacusia</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H912" name="patologia[]" value="H91.2" data-points="1"><label for="H912"><strong>H91.2</strong> ‚Äî Hipoacusia s√∫bita idiop√°tica</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H918" name="patologia[]" value="H91.8" data-points="1"><label for="H918"><strong>H91.8</strong> ‚Äî Otras hipoacusias especificadas</label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="H919" name="patologia[]" value="H91.9" data-points="1"><label for="H919"><strong>H91.9</strong> ‚Äî Hipoacusia, no especificada</label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 13: PATOLOG√çAS INMUNOL√ìGICAS ===================== -->
<div class="categoria-seccion" id="cat-inmunologicas" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-inmunologicas')">
    <h4>üß¨ PATOLOG√çAS INMUNOL√ìGICAS
      <span class="categoria-badge" id="badge-inmunologicas">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-inmunologicas">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-inmunologicas">

    <!-- ===== Familia: Infecci√≥n por VIH / SIDA (1) ===== -->
    <div class="familia" data-familia-id="fam-vih" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-vih-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-vih-block', this)">+</button>
        Infecci√≥n por VIH / SIDA<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-vih-block">

        <!-- B21.x ‚Äî Enfermedad por VIH que resulta en enfermedades infecciosas y parasitarias -->
        <div class="subcategoria-header banner-vih">B21 ‚Äî Enfermedad por VIH que resulta en enfermedades infecciosas y parasitarias</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B210" value="B21.0"><label for="B210"><strong>B21.0 ‚Äî VIH con candidiasis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B211" value="B21.1"><label for="B211"><strong>B21.1 ‚Äî VIH con otras micosis</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B212" value="B21.2"><label for="B212"><strong>B21.2 ‚Äî VIH con enfermedades por otros agentes bacterianos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B213" value="B21.3"><label for="B213"><strong>B21.3 ‚Äî VIH con otras infecciones v√≠ricas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B217" value="B21.7"><label for="B217"><strong>B21.7 ‚Äî VIH con m√∫ltiples infecciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B218" value="B21.8"><label for="B218"><strong>B21.8 ‚Äî VIH con otras enfermedades infecciosas y parasitarias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B219" value="B21.9"><label for="B219"><strong>B21.9 ‚Äî VIH con enfermedad infecciosa o parasitaria no especificada</strong></label></div>

        <!-- B22.x ‚Äî Enfermedad por VIH con manifestaciones definitorias de SIDA -->
        <div class="subcategoria-header banner-vih">B22 ‚Äî Enfermedad por VIH con manifestaciones definitorias de SIDA</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B220" value="B22.0"><label for="B220"><strong>B22.0 ‚Äî Encefalopat√≠a por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B221" value="B22.1"><label for="B221"><strong>B22.1 ‚Äî Neumon√≠a intersticial linfoide debida a VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B222" value="B22.2"><label for="B222"><strong>B22.2 ‚Äî Caquexia por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B227" value="B22.7"><label for="B227"><strong>B22.7 ‚Äî Otras manifestaciones definitorias de SIDA</strong></label></div>

        <!-- B23.x ‚Äî Otras afecciones por VIH -->
        <div class="subcategoria-header banner-vih">B23 ‚Äî Otras afecciones por VIH</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B230" value="B23.0"><label for="B230"><strong>B23.0 ‚Äî S√≠ndrome agudo de infecci√≥n por VIH</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B231" value="B23.1"><label for="B231"><strong>B23.1 ‚Äî VIH con linfadenopat√≠a (generalizada) persistente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B232" value="B23.2"><label for="B232"><strong>B23.2 ‚Äî VIH con (presencia de) neoplasia maligna</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B238" value="B23.8"><label for="B238"><strong>B23.8 ‚Äî Otras afecciones especificadas de VIH</strong></label></div>

        <!-- B24 ‚Äî Enfermedad por VIH no especificada -->
        <div class="subcategoria-header">B24 ‚Äî Enfermedad por VIH no especificada</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="B24" value="B24"><label for="B24"><strong>B24 ‚Äî Enfermedad por VIH no especificada</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Lupus (1) ===== -->
    <div class="familia" data-familia-id="fam-lupus" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-lupus-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-lupus-block', this)">+</button>
        Lupus<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-lupus-block">

        <!-- L93.x ‚Äî Lupus eritematoso localizado (cut√°neo) -->
        <div class="subcategoria-header banner-lupus">L93 ‚Äî Lupus eritematoso localizado (cut√°neo)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="L930" value="L93.0"><label for="L930"><strong>L93.0 ‚Äî Lupus eritematoso discoide</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="L931" value="L93.1"><label for="L931"><strong>L93.1 ‚Äî Lupus eritematoso subagudo cut√°neo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="L932" value="L93.2"><label for="L932"><strong>L93.2 ‚Äî Otros lupus eritematosos cut√°neos y no especificado</strong></label></div>

        <!-- M32.x ‚Äî Lupus eritematoso sist√©mico -->
        <div class="subcategoria-header banner-lupus">M32 ‚Äî Lupus eritematoso sist√©mico</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M320" value="M32.0"><label for="M320"><strong>M32.0 ‚Äî Lupus eritematoso sist√©mico inducido por f√°rmacos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M321" value="M32.1"><label for="M321"><strong>M32.1 ‚Äî Lupus eritematoso sist√©mico con compromiso de otros √≥rganos y sistemas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M328" value="M32.8"><label for="M328"><strong>M32.8 ‚Äî Otros lupus eritematosos sist√©micos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="M329" value="M32.9"><label for="M329"><strong>M32.9 ‚Äî Lupus eritematoso sist√©mico, no especificado</strong></label></div>
      </div>
    </div>

    <!-- ===== Familia: Tuberculosis (1) ===== -->
    <div class="familia" data-familia-id="fam-tuberculosis" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-tuberculosis-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-tuberculosis-block', this)">+</button>
        Tuberculosis<span class="badge-puntos">(1)</span>
      </div>

      <div class="familia-content collapsed" id="fam-tuberculosis-block">

        <!-- A15.x ‚Äî Tuberculosis respiratoria, bacteriol√≥gicamente confirmada -->
        <div class="subcategoria-header banner-vih">A15 ‚Äî Tuberculosis respiratoria, confirmada</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A150" name="patologia[]" value="A15.0" data-points="1"><label for="A150"><strong>A15.0 ‚Äî Tuberculosis pulmonar con baciloscopia positiva</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A151" name="patologia[]" value="A15.1" data-points="1"><label for="A151"><strong>A15.1 ‚Äî Tuberculosis pulmonar con cultivo positivo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A152" name="patologia[]" value="A15.2" data-points="1"><label for="A152"><strong>A15.2 ‚Äî Tuberculosis pulmonar confirmada histol√≥gicamente</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A153" name="patologia[]" value="A15.3" data-points="1"><label for="A153"><strong>A15.3 ‚Äî Tuberculosis pulmonar confirmada por otros medios</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A154" name="patologia[]" value="A15.4" data-points="1"><label for="A154"><strong>A15.4 ‚Äî Tuberculosis de ganglios intrator√°cicos confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A155" name="patologia[]" value="A15.5" data-points="1"><label for="A155"><strong>A15.5 ‚Äî Tuberculosis de laringe, tr√°quea o bronquios confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A156" name="patologia[]" value="A15.6" data-points="1"><label for="A156"><strong>A15.6 ‚Äî Tuberculosis pleural confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A157" name="patologia[]" value="A15.7" data-points="1"><label for="A157"><strong>A15.7 ‚Äî Tuberculosis primaria confirmada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A158" name="patologia[]" value="A15.8" data-points="1"><label for="A158"><strong>A15.8 ‚Äî Otras tuberculosis respiratorias confirmadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A159" name="patologia[]" value="A15.9" data-points="1"><label for="A159"><strong>A15.9 ‚Äî Tuberculosis respiratoria no especificada confirmada</strong></label></div>

        <!-- A17.x ‚Äî Tuberculosis del sistema nervioso -->
        <div class="subcategoria-header banner-vih">A17 ‚Äî Tuberculosis del sistema nervioso</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A170" name="patologia[]" value="A17.0" data-points="1"><label for="A170"><strong>A17.0 ‚Äî Meningitis tuberculosa</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A171" name="patologia[]" value="A17.1" data-points="1"><label for="A171"><strong>A17.1 ‚Äî Tuberculoma men√≠ngeo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A178" name="patologia[]" value="A17.8" data-points="1"><label for="A178"><strong>A17.8 ‚Äî Otras tuberculosis del sistema nervioso</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A179" name="patologia[]" value="A17.9" data-points="1"><label for="A179"><strong>A17.9 ‚Äî Tuberculosis del sistema nervioso no especificada</strong></label></div>

        <!-- A18.x ‚Äî Tuberculosis de otros √≥rganos -->
        <div class="subcategoria-header banner-vih">A18 ‚Äî Tuberculosis de otros √≥rganos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A180" name="patologia[]" value="A18.0" data-points="1"><label for="A180"><strong>A18.0 ‚Äî Tuberculosis de huesos y articulaciones</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A181" name="patologia[]" value="A18.1" data-points="1"><label for="A181"><strong>A18.1 ‚Äî Tuberculosis genitourinaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A182" name="patologia[]" value="A18.2" data-points="1"><label for="A182"><strong>A18.2 ‚Äî Tuberculosis del intestino, peritoneo y ganglios mesent√©ricos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A183" name="patologia[]" value="A18.3" data-points="1"><label for="A183"><strong>A18.3 ‚Äî Tuberculosis de piel y tejido celular subcut√°neo</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A184" name="patologia[]" value="A18.4" data-points="1"><label for="A184"><strong>A18.4 ‚Äî Tuberculosis de ojos</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A185" name="patologia[]" value="A18.5" data-points="1"><label for="A185"><strong>A18.5 ‚Äî Tuberculosis de o√≠do</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A186" name="patologia[]" value="A18.6" data-points="1"><label for="A186"><strong>A18.6 ‚Äî Tuberculosis de gl√°ndulas suprarrenales</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A187" name="patologia[]" value="A18.7" data-points="1"><label for="A187"><strong>A18.7 ‚Äî Tuberculosis de h√≠gado</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A188" name="patologia[]" value="A18.8" data-points="1"><label for="A188"><strong>A18.8 ‚Äî Tuberculosis de otros √≥rganos especificados</strong></label></div>

        <!-- A19.x ‚Äî Tuberculosis miliar -->
        <div class="subcategoria-header banner-vih">A19 ‚Äî Tuberculosis miliar</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A190" name="patologia[]" value="A19.0" data-points="1"><label for="A190"><strong>A19.0 ‚Äî Tuberculosis miliar aguda de localizaci√≥n √∫nica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A191" name="patologia[]" value="A19.1" data-points="1"><label for="A191"><strong>A19.1 ‚Äî Tuberculosis miliar aguda de localizaciones m√∫ltiples</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A192" name="patologia[]" value="A19.2" data-points="1"><label for="A192"><strong>A19.2 ‚Äî Tuberculosis miliar aguda, no especificada</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A198" name="patologia[]" value="A19.8" data-points="1"><label for="A198"><strong>A19.8 ‚Äî Otras tuberculosis miliares especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" id="A199" name="patologia[]" value="A19.9" data-points="1"><label for="A199"><strong>A19.9 ‚Äî Tuberculosis miliar no especificada</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 14: NEOPLASIAS / C√ÅNCER ===================== -->
<div class="categoria-seccion" id="cat-neoplasias" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-neoplasias')">
    <h4>üß™ MALIGNIDAD / NEOPLASIA / TUMOR MALIGNO / C√ÅNCER
      <span class="categoria-badge" id="badge-neoplasias">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-neoplasias">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-neoplasias">

    <!-- ===== Familia: Tumores malignos (1) ===== -->
    <div class="familia" data-familia-id="fam-neoplasias" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-neoplasias-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-neoplasias-block', this)">+</button>
        Tumores malignos / c√°ncer<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-neoplasias-block">

        <!-- C00‚ÄìC97 ‚Äî Neoplasias malignas -->
        <div class="subcategoria-header banner-neoplasias">C00 ‚Äì C97 ‚Äî Neoplasias malignas (toda la letra C)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="C00-C97" value="C00-C97"><label for="C00-C97"><strong>C00 ‚Äì C97 ‚Äî Todas las neoplasias malignas (√≥rganos, tejidos y sistemas)</strong></label></div>

        <!-- D00‚ÄìD48 ‚Äî Tumores in situ, benignos e incertos -->
        <div class="subcategoria-header banner-neoplasias">D00 ‚Äì D48 ‚Äî Tumores in situ, benignos e incertos (hasta D48.9)</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D00-D48" value="D00-D48"><label for="D00-D48"><strong>D00 ‚Äì D48 ‚Äî Tumores in situ, benignos e incertos (incluye D48.0 ‚Äì D48.9)</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 15: MALTRATO / VIOLENCIA / ABUSO / SUICIDIO ===================== -->
<div class="categoria-seccion" id="cat-maltrato" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-maltrato')">
    <h4>üö® MALTRATO / VIOLENCIA / ABUSO / SUICIDIO
      <span class="categoria-badge" id="badge-maltrato">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-maltrato">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-maltrato">

    <!-- ===== Familia: Maltrato f√≠sico / psicol√≥gico / VIF / abuso sexual / suicidio (1) ===== -->
    <div class="familia" data-familia-id="fam-maltrato" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-maltrato-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-maltrato-block', this)">+</button>
        Maltrato f√≠sico / psicol√≥gico / VIF / abuso sexual / suicidio<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-maltrato-block">

        <!-- T74.x ‚Äî S√≠ndromes de maltrato -->
        <div class="subcategoria-header banner-maltrato">T74 ‚Äî S√≠ndromes de maltrato</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="T740" value="T74.0"><label for="T740"><strong>T74.0 ‚Äî S√≠ndrome de maltrato por negligencia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="T741" value="T74.1"><label for="T741"><strong>T74.1 ‚Äî S√≠ndrome de maltrato f√≠sico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="T742" value="T74.2"><label for="T742"><strong>T74.2 ‚Äî S√≠ndrome de maltrato sexual</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="T743" value="T74.3"><label for="T743"><strong>T74.3 ‚Äî S√≠ndrome de maltrato psicol√≥gico</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="T748" value="T74.8"><label for="T748"><strong>T74.8 ‚Äî Otros s√≠ndromes de maltrato</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="T749" value="T74.9"><label for="T749"><strong>T74.9 ‚Äî S√≠ndrome de maltrato no especificado</strong></label></div>

        <!-- Y07.x ‚Äî Perpetrador de maltrato -->
        <div class="subcategoria-header banner-maltrato">Y07 ‚Äî Perpetrador de maltrato</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y070" value="Y07.0"><label for="Y070"><strong>Y07.0 ‚Äî Perpetrador: c√≥nyuge o pareja</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y071" value="Y07.1"><label for="Y071"><strong>Y07.1 ‚Äî Perpetrador: padre o madre</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y072" value="Y07.2"><label for="Y072"><strong>Y07.2 ‚Äî Perpetrador: otro miembro de la familia</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y073" value="Y07.3"><label for="Y073"><strong>Y07.3 ‚Äî Perpetrador: conocido</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y078" value="Y07.8"><label for="Y078"><strong>Y07.8 ‚Äî Perpetrador: otras personas especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="Y079" value="Y07.9"><label for="Y079"><strong>Y07.9 ‚Äî Perpetrador: no especificado</strong></label></div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->
<!-- ===================== CATEGOR√çA 16: TRASTORNOS DE LA COAGULACI√ìN ===================== -->
<div class="categoria-seccion" id="cat-coagulacion" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-coagulacion')">
    <h4>ü©∏ TRASTORNOS DE LA COAGULACI√ìN
      <span class="categoria-badge" id="badge-coagulacion">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-coagulacion">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-coagulacion">

    <!-- ===== Familia: Trastornos de la coagulaci√≥n (1) ===== -->
    <div class="familia" data-familia-id="fam-coagulacion" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-coagulacion-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-coagulacion-block', this)">+</button>
        Trastornos de la coagulaci√≥n<span class="badge-puntos">(1)</span>
      </div>
      <div class="familia-content collapsed" id="fam-coagulacion-block">

        <!-- D68.x ‚Äî Otros defectos de la coagulaci√≥n -->
        <div class="subcategoria-header">D68 ‚Äî Otros defectos de la coagulaci√≥n</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D680" value="D68.0"><label for="D680"><strong>D68.0 ‚Äî Deficiencia hereditaria del factor VIII</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D681" value="D68.1"><label for="D681"><strong>D68.1 ‚Äî Deficiencia hereditaria del factor IX</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D682" value="D68.2"><label for="D682"><strong>D68.2 ‚Äî Deficiencia hereditaria de otros factores de la coagulaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D684" value="D68.4"><label for="D684"><strong>D68.4 ‚Äî Deficiencia adquirida de factores de la coagulaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D688" value="D68.8"><label for="D688"><strong>D68.8 ‚Äî Otros defectos especificados de la coagulaci√≥n</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D689" value="D68.9"><label for="D689"><strong>D68.9 ‚Äî Defecto de la coagulaci√≥n, no especificado</strong></label></div>

        <!-- D69.x ‚Äî P√∫rpura y otras afecciones hemorr√°gicas -->
        <div class="subcategoria-header">D69 ‚Äî P√∫rpura y otras afecciones hemorr√°gicas</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D691" value="D69.1"><label for="D691"><strong>D69.1 ‚Äî P√∫rpura al√©rgica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D692" value="D69.2"><label for="D692"><strong>D69.2 ‚Äî P√∫rpura trombocitop√©nica no primaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D693" value="D69.3"><label for="D693"><strong>D69.3 ‚Äî P√∫rpura trombocitop√©nica idiop√°tica</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D694" value="D69.4"><label for="D694"><strong>D69.4 ‚Äî Otras p√∫rpuras trombocitop√©nicas primarias</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D696" value="D69.6"><label for="D696"><strong>D69.6 ‚Äî Trombocitopenia secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D698" value="D69.8"><label for="D698"><strong>D69.8 ‚Äî Otras p√∫rpuras especificadas</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D699" value="D69.9"><label for="D699"><strong>D69.9 ‚Äî P√∫rpura, no especificada</strong></label></div>

        <!-- D75.x ‚Äî Otras enfermedades de la sangre -->
        <div class="subcategoria-header">D75 ‚Äî Otras enfermedades de la sangre y de los √≥rganos hematopoy√©ticos</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D750" value="D75.0"><label for="D750"><strong>D75.0 ‚Äî Eritrocitosis secundaria</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D758" value="D75.8"><label for="D758"><strong>D75.8 ‚Äî Otras enfermedades especificadas de la sangre</strong></label></div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D759" value="D75.9"><label for="D759"><strong>D75.9 ‚Äî Enfermedad de la sangre, no especificada</strong></label></div>

        <!-- D77 ‚Äî Otros trastornos de la sangre -->
        <div class="subcategoria-header">D77 ‚Äî Otros trastornos de la sangre</div>
        <div class="patologia-item"><input type="checkbox" class="patologia-checkbox" name="patologia[]" id="D77" value="D77"><label for="D77"><strong>D77 ‚Äî Otros trastornos de la sangre, no clasificados en otra parte</strong></label></div>
      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

<!-- ===================== CATEGOR√çA 17: ALTERACIONES DE LA CONTINUIDAD DE LA PIEL ===================== -->
<div class="categoria-seccion" id="cat-piel" style="display:block;">
  <div class="categoria-header" onclick="toggleCategoria('content-piel')">
    <h4>ü©π ALTERACIONES DE LA CONTINUIDAD DE LA PIEL
      <span class="categoria-badge" id="badge-piel">0</span>
    </h4>
    <button type="button" class="categoria-toggle" id="toggle-piel">+</button>
  </div>

  <div class="categoria-content collapsed" id="content-piel">

    <!-- ===== Familia: √ölcera cr√≥nica de la piel (1) ===== -->
    <div class="familia" data-familia-id="fam-ulcera-piel" data-points="1">
      <div class="familia-header" onclick="toggleFamilia('fam-ulcera-piel-block', this)">
        <button type="button" class="familia-toggle" onclick="event.stopPropagation(); toggleCollapse('fam-ulcera-piel-block', this)">+</button>
        √ölcera cr√≥nica de la piel<span class="badge-puntos">(1)</span>
      </div>

      <div class="familia-content collapsed" id="fam-ulcera-piel-block">
        
        <!-- I83.x ‚Äî V√°rices de miembros inferiores con √∫lcera -->
        <div class="subcategoria-header banner-sangre">I83 ‚Äî V√°rices de miembros inferiores con √∫lcera</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I830" name="patologia[]" value="I83.0" data-points="1">
          <label for="I830"><strong>I83.0 ‚Äî V√°rices de miembros inferiores con √∫lcera</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I831" name="patologia[]" value="I83.1" data-points="1">
          <label for="I831"><strong>I83.1 ‚Äî V√°rices de miembros inferiores con inflamaci√≥n</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I832" name="patologia[]" value="I83.2" data-points="1">
          <label for="I832"><strong>I83.2 ‚Äî V√°rices de miembros inferiores con √∫lcera e inflamaci√≥n</strong></label>
        </div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="I839" name="patologia[]" value="I83.9" data-points="1">
          <label for="I839"><strong>I83.9 ‚Äî V√°rices de miembros inferiores, no especificadas</strong></label>
        </div>

        <!-- L97 ‚Äî √ölcera de miembros inferiores -->
        <div class="subcategoria-header banner-sangre">L97 ‚Äî √ölcera de miembros inferiores</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="L97" name="patologia[]" value="L97" data-points="1">
          <label for="L97"><strong>L97 ‚Äî √ölcera de miembros inferiores, no clasificada en otra parte</strong></label>
        </div>

        <!-- L98.4 ‚Äî √ölcera cr√≥nica de la piel, no clasificada en otra parte -->
        <div class="subcategoria-header banner-sangre">L98.4 ‚Äî √ölcera cr√≥nica de la piel</div>
        <div class="patologia-item">
          <input type="checkbox" class="patologia-checkbox" id="L984" name="patologia[]" value="L98.4" data-points="1">
          <label for="L984"><strong>L98.4 ‚Äî √ölcera cr√≥nica de la piel, no clasificada en otra parte</strong></label>
        </div>

      </div>
    </div>

  </div> <!-- /categoria-content -->
</div> <!-- /categoria-seccion -->

</div> <!-- /patologias-ecicep-container -->
</div> <!-- /patologias-main-container (contenedor colapsable) -->
<!-- === CSS m√≠nimo para colapsar/expandir === -->
<style>
    /* === ESTILOS PARA CONTENEDOR COLAPSABLE DE PATOLOG√çAS === */
    #patologias-main-container {
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }
    
    #patologias-main-container[style*="display: block"] {
        opacity: 1;
        transform: translateY(0);
    }
    
    #btn-toggle-patologias {
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #btn-toggle-patologias:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* --- Moderno para cuadro de patolog√≠as resumen --- */
    .patologias-resumen {
      background: #f4f8fb;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(13,110,253,0.07);
      border: 1.5px solid #e0e7ef;
      padding: 18px 20px 12px 20px;
      margin-bottom: 18px;
    }
    .patologias-titulo {
      font-size: 1.08em;
      font-weight: 700;
      color: #0d6efd;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .pat-badges {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .resumen-categoria {
      margin-bottom: 10px;
      padding-bottom: 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .resumen-familia {
      margin: 6px 0 6px 12px;
    }
    .resumen-familia > span {
      font-size: 1em;
      font-weight: 600;
      color: #0d6efd;
      display: inline-block;
      margin-bottom: 2px;
    }
    .resumen-patologia {
      margin-left: 18px;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .resumen-patologia input[type="checkbox"] {
      accent-color: #0d6efd;
      width: 16px;
      height: 16px;
    }
    .pat-empty {
      color: #6c757d;
      font-style: italic;
    }

    /* --- Botones de expansi√≥n de categor√≠as modernos --- */
    .categoria-toggle {
      background: #e7f0fa;
      color: #0d6efd;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.3em;
      font-weight: bold;
      box-shadow: 0 1px 4px rgba(13,110,253,0.08);
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      cursor: pointer;
      margin-left: 10px;
    }
    .categoria-toggle:hover {
      background: #0d6efd;
      color: #fff;
      box-shadow: 0 2px 8px rgba(13,110,253,0.13);
    }
    .categoria-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      cursor: pointer;
      padding: 12px 16px;
      margin: 4px 0;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      border: 1px solid #dee2e6;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      user-select: none;
    }
    .categoria-header:hover {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-color: #0d6efd;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(13,110,253,0.15);
    }
    .categoria-header h4 {
      margin: 0;
    }
  .collapsed { display: none; }
  .categoria-content:not(.collapsed),
  .familia-content:not(.collapsed) { display:block; }
</style>

<!-- === JS de toggles y utilidades === -->
<script>
  function toggleCategoria(contentId) {
    const content = document.getElementById(contentId);
    if (!content) return;
    content.classList.toggle('collapsed');

    // Cambiar el signo del bot√≥n
    const wrap = content.closest('.categoria-seccion');
    const btn = wrap?.querySelector('.categoria-toggle');
    if (btn) btn.textContent = content.classList.contains('collapsed') ? '+' : '‚àí';
  }

  function toggleFamilia(blockId, familia_header) {
    const block = document.getElementById(blockId);
    if (!block) return;
    block.classList.toggle('collapsed');
    
    // Cambiar el signo del bot√≥n
    const btn = familia_header.querySelector('.familia-toggle');
    if (btn) btn.textContent = block.classList.contains('collapsed') ? '+' : '‚àí';
  }

  function toggleCollapse(blockId, btn) {
    const block = document.getElementById(blockId);
    if (!block) return;
    block.classList.toggle('collapsed');
    if (btn) btn.textContent = block.classList.contains('collapsed') ? '+' : '‚àí';
  }

  // === FUNCI√ìN PARA COLAPSAR/EXPANDIR TODO EL CONTENEDOR DE PATOLOG√çAS ===
  function togglePatologiasContainer() {
    const container = document.getElementById('patologias-main-container');
    const button = document.getElementById('btn-toggle-patologias');
    
    if (!container || !button) return;
    
    const isHidden = container.style.display === 'none';
    
    if (isHidden) {
      // Mostrar patolog√≠as
      container.style.display = 'block';
      button.innerHTML = 'üôà Ocultar Patolog√≠as';
      button.style.background = '#ef4444';
      // A√±adir efecto de deslizamiento
      setTimeout(() => {
        container.style.opacity = '1';
        container.style.transform = 'translateY(0)';
      }, 10);
    } else {
      // Ocultar patolog√≠as
      container.style.opacity = '0';
      container.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        container.style.display = 'none';
      }, 200);
      button.innerHTML = 'üëÅÔ∏è Mostrar Patolog√≠as';
      button.style.background = '#6366f1';
    }
  }

  // Botones globales (versi√≥n UI familias/categor√≠as)
  function expandirTodasFamilias() {
    document.querySelectorAll('.categoria-content.collapsed').forEach(el => el.classList.remove('collapsed'));
    document.querySelectorAll('.familia-content.collapsed').forEach(el => el.classList.remove('collapsed'));
    document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '‚àí');
    document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '‚àí');
  }

  function contraerTodasFamilias() {
    document.querySelectorAll('.categoria-content:not(.collapsed)').forEach(el => el.classList.add('collapsed'));
    document.querySelectorAll('.familia-content:not(.collapsed)').forEach(el => el.classList.add('collapsed'));
    document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '+');
    document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '+');
  }

  function expandirSoloSeleccionadasFamilias() {
    // Colapsa todo
    contraerTodasFamilias();
    // Abre familias con selecci√≥n y sus categor√≠as padre
    const seleccionadas = document.querySelectorAll('.familia input[type="checkbox"]:checked');
    const vistas = new Set();
    seleccionadas.forEach(chk => {
      const familia = chk.closest('.familia');
      const famContent = familia?.querySelector('.familia-content');
      if (famContent && famContent.classList.contains('collapsed')) {
        famContent.classList.remove('collapsed');
        const btn = familia.querySelector('.familia-toggle');
        if (btn) btn.textContent = '‚àí';
      }
      const catContent = chk.closest('.categoria-content');
      if (catContent && catContent.classList.contains('collapsed')) {
        catContent.classList.remove('collapsed');
        const catBtn = catContent.closest('.categoria-seccion')?.querySelector('.categoria-toggle');
        if (catBtn) catBtn.textContent = '‚àí';
      }
      vistas.add(catContent?.id);
    });
  }

  // Badges por categor√≠a (cuenta checkboxes dentro)
  function actualizarBadgesCategorias() {
    document.querySelectorAll('.categoria-seccion').forEach(sec => {
      const badge = sec.querySelector('.categoria-badge');
      const content = sec.querySelector('.categoria-content');
      if (!badge || !content) return;
      const count = content.querySelectorAll('input[type="checkbox"].patologia-checkbox:checked').length;
      badge.textContent = String(count);
    });
  }

  // Listeners
  document.addEventListener('change', e => {
    if (e.target && e.target.matches('input[type="checkbox"].patologia-checkbox')) {
      actualizarBadgesCategorias();
            // Nuevo: solo registrar cambio local (sin guardar inmediato)
            registrarCambioPatologia(e.target);
    }
  });

  // Al cargar, inicializa los badges (todas las categor√≠as colapsadas por defecto)
  // document.addEventListener('DOMContentLoaded', () => {
  //   actualizarBadgesCategorias();
  // });
</script>

<!-- Trigger autocompletado si el RUN viene precargado (por ?run=...) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Buscar el campo RUN y su valor
    const runInput = document.getElementById('run');
    if (runInput && runInput.value && runInput.value.length >= 8) {
        // Evitar doble carga si ya se dispar√≥ por otro flujo
        if (!runInput.dataset.autoloaded) {
            runInput.dataset.autoloaded = '1';
            if (typeof buscarUsuario === 'function') {
                buscarUsuario(runInput.value.trim());
            }
        }
    }
});
</script>

<!-- ================== EVALUACI√ìN PIE DM (AUTO-GUARDADO) ================== -->
<style>
    .piedm-wrapper {
        margin:40px 0 0 0; 
        border:1px solid #e5e7eb; 
        border-radius:14px; 
        background:linear-gradient(135deg,#ffffff,#f5f7fa); 
        box-shadow:0 4px 12px -2px rgba(0,0,0,.06);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    } 
    
    .piedm-wrapper:hover {
        transform: scale(1.03);
        box-shadow: 0 12px 30px -4px rgba(0,0,0,.15);
        z-index: 5;
        position: relative;
    }
    
    .piedm-subsection {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    
    .piedm-subsection:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        z-index: 3;
        position: relative;
    } 
    .piedm-header {display:flex; align-items:center; justify-content:space-between; padding:14px 16px; cursor:pointer; user-select:none;}
    .piedm-header h3 {margin:0; font-size:18px; display:flex; align-items:center; gap:10px; font-weight:600;}
    .piedm-toggle-panel {padding:18px 22px; border-top:1px solid #e5e7eb; animation:fadeIn .25s ease;}
    .piedm-grid {display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:18px;}
    .piedm-field {background:#fff; border:1px solid #e2e8f0; padding:14px 16px 18px; border-radius:10px; position:relative; box-shadow:0 1px 2px rgba(0,0,0,.04);} 
    .piedm-field:hover {border-color:#cbd5e1;} 
    .piedm-label {display:block; font-weight:600; font-size:13px; letter-spacing:.3px; color:#1e293b; margin-bottom:10px; text-transform:uppercase;}
    /* Toggle switch */
    .switch {position:relative; display:inline-block; width:60px; height:30px;}
    .switch input {opacity:0; width:0; height:0;}
    .slider {position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#d1d5db; transition:.35s; border-radius:30px; box-shadow:inset 0 0 0 2px #cbd5e1;}
    .slider:before {position:absolute; content:""; height:24px; width:24px; left:3px; top:3px; background:white; transition:.35s; border-radius:50%; box-shadow:0 1px 3px rgba(0,0,0,.25);} 
    .switch input:checked + .slider {background:#2563eb; box-shadow:inset 0 0 0 2px #1d4ed8;} 
    .switch input:checked + .slider:before {transform:translateX(30px);} 
    .slider::after {content:attr(data-off); position:absolute; right:8px; top:50%; transform:translateY(-50%); color:#1e293b; font-size:11px; font-weight:600; letter-spacing:.5px; transition:.3s;}
    .switch input:checked + .slider::after {content:attr(data-on); left:10px; right:auto; color:#fff;}
    .piedm-actions {margin-top:22px; display:flex; gap:14px; flex-wrap:wrap;}
    .btn-base {border:none; padding:11px 20px; border-radius:8px; font-weight:600; font-size:13px; letter-spacing:.4px; cursor:pointer; display:inline-flex; align-items:center; gap:6px;}
    .btn-calc {background:#047857; color:#fff;}
    .btn-calc:hover {background:#036349;}
    .btn-reset {background:#6b7280; color:#fff;}
    .btn-reset:hover {background:#525962;}
    .btn-save {background:#2563eb; color:#fff;}
    .btn-save:disabled {background:#93c5fd; cursor:not-allowed;}
    .piedm-result-box {margin-top:22px; padding:16px 18px; border-radius:12px; font-weight:600; font-size:15px; line-height:1.25; position:relative; box-shadow:0 2px 6px -2px rgba(0,0,0,.12);} 
    .piedm-badge {position:absolute; top:-10px; right:-10px; background:#334155; color:#fff; font-size:11px; padding:4px 8px; border-radius:999px; letter-spacing:.5px; box-shadow:0 2px 4px rgba(0,0,0,.25);} 
    .nivel-bajo {background:#ecfdf5; color:#065f46; border:1px solid #10b981;} 
    .nivel-moderado {background:#fff7ed; color:#9a3412; border:1px solid #fb923c;} 
    .nivel-alto {background:#fef3c7; color:#92400e; border:1px solid #fbbf24;} 
    .nivel-maximo {background:#fef2f2; color:#991b1b; border:1px solid #f87171;} 
    .piedm-dates {margin-top:10px; font-size:12px; color:#374151; letter-spacing:.3px;}
    .piedm-status {margin-top:10px; font-size:12px; min-height:18px; font-weight:500;}
    .ultima-box {font-size:12px; color:#475569; background:#f1f5f9; padding:12px 14px; border-radius:10px; border:1px dashed #cbd5e1;}
    .piedm-header button {background:#2563eb; color:#fff; border:none; padding:7px 16px; border-radius:7px; font-size:13px; font-weight:500; box-shadow:0 2px 4px -1px rgba(0,0,0,.15);}
    .piedm-header button:hover {background:#1d4ed8;}
    .rotate-90 {transform:rotate(90deg);} 
    .btn-nuevo {background:#10b981; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer; transition:all 0.2s ease;}
    .btn-nuevo:hover {background:#059669; transform:translateY(-1px);}
    @keyframes fadeIn {from {opacity:0; transform:translateY(-4px);} to {opacity:1; transform:translateY(0);} }
</style>
<div class="piedm-wrapper" id="pieDmSection" style="display:none;">
    <div class="piedm-header" onclick="togglePieDmPanel(event)">
        <h3>ü©∫ Evaluaci√≥n diab√©tica <small style="font-weight:500; color:#64748b; margin-left:6px;">(incluye Pie DM)</small> <span id="pieDmChevron" style="transition:.3s; font-size:16px; color:#64748b;">‚ñ∂</span> <span id="pieDmSummary" class="piedm-summary" style="display:none;"></span></h3>
    </div>
    <div id="panel-pie-dm" class="piedm-toggle-panel hidden">
    <!-- IMPORTANTE: no anidar formularios dentro del principal. Cambiado a <div>. -->
    <div id="evaluacionPieDmForm">
            <!-- Header con fecha y bot√≥n nuevo -->
            <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px; padding:8px 12px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="flex:1; max-width:200px;">
                    <label class="piedm-label" for="pieDmFechaReal" style="font-size:11px; margin-bottom:2px;">Fecha evaluaci√≥n</label>
                    <input type="text" id="pieDmFechaReal" placeholder="dd/mm/aaaa" style="width:100%; padding:4px 6px; font-size:11px; border:1px solid #cbd5e1; border-radius:4px;">
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button type="button" id="pieDmGuardarBtn" class="btn-guardar" style="background:#2563eb; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer;" onclick="guardarEvaluacionPieDM(false)">üíæ Guardar</button>
                    <button type="button" id="pieDmNuevoBtn" class="btn-nuevo" style="background:#10b981; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer;">‚≠ï Nuevo</button>
                    <span id="pieDmStatus" style="font-size:10px; color:#64748b;"></span>
                </div>
                <small style="color:#64748b; font-size:10px;">Ingrese fecha manualmente</small>
            </div>

            <!-- √öltimo registro guardado -->
            <div id="pieDmUltimo" style="margin:8px 0; padding:6px 8px; background:#f0f9ff; border-radius:4px; font-size:11px; color:#0369a1; display:none;">
                √öltimo registro guardado
            </div>

            <!-- Grid compacto en una sola fila -->
            <div style="display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-bottom:12px;">
                <!-- √ölcera/Amputaci√≥n -->
                <div style="background:#fff; border:1px solid #e2e8f0; padding:8px 10px; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:10px; font-weight:600; color:#0f172a; margin-bottom:6px;">√öLCERA PREVIA</span>
                    <div style="display:flex; gap:15px; justify-content:center; align-items:center;">
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="ulceraPieOAmputacion" id="ulceraPieOAmputacion_si" value="si" style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">S√≠</span>
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="ulceraPieOAmputacion" id="ulceraPieOAmputacion_no" value="no" checked style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">No</span>
                        </label>
                    </div>
                </div>

                <!-- Amputaci√≥n -->
                <div style="background:#fff; border:1px solid #e2e8f0; padding:8px 10px; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:10px; font-weight:600; color:#0f172a; margin-bottom:6px;">AMPUTACI√ìN</span>
                    <div style="display:flex; gap:15px; justify-content:center; align-items:center; margin-bottom:6px;">
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="amputacion" id="amputacion_si" value="si" style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">S√≠</span>
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="amputacion" id="amputacion_no" value="no" checked style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">No</span>
                        </label>
                    </div>
                    <!-- Fecha de amputaci√≥n (solo visible si amputacion = s√≠) -->
                    <div id="fechaAmputacionContainer" style="display:none; margin-top:6px;">
                        <label style="display:block; font-size:9px; color:#64748b; margin-bottom:2px;">Fecha:</label>
                        <input type="text" id="fechaAmputacion" name="fechaAmputacion" placeholder="dd/mm/aaaa" maxlength="10"
                               style="font-size:9px; padding:2px 4px; border:1px solid #cbd5e1; border-radius:3px; background:#f8fafc; width:80px;">
                    </div>
                </div>
                
                <!-- P√©rdida Sensibilidad -->
                <div style="background:#fff; border:1px solid #e2e8f0; padding:8px 10px; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:10px; font-weight:600; color:#0f172a; margin-bottom:6px;">P√âRDIDA SENSIBILIDAD (MONOFIL.)</span>
                    <div style="display:flex; gap:15px; justify-content:center; align-items:center;">
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="sensibilidadProtectora" id="sensibilidadProtectora_si" value="si" style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">S√≠</span>
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="sensibilidadProtectora" id="sensibilidadProtectora_no" value="no" checked style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">No</span>
                        </label>
                    </div>
                </div>
                
                <!-- EAP -->
                <div style="background:#fff; border:1px solid #e2e8f0; padding:8px 10px; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:10px; font-weight:600; color:#0f172a; margin-bottom:6px;">EAP</span>
                    <div style="display:flex; gap:15px; justify-content:center; align-items:center;">
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="EAP" id="EAP_si" value="si" style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">S√≠</span>
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="EAP" id="EAP_no" value="no" checked style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">No</span>
                        </label>
                    </div>
                </div>
                
                <!-- Deformidad -->
                <div style="background:#fff; border:1px solid #e2e8f0; padding:8px 10px; border-radius:6px; text-align:center;">
                    <span style="display:block; font-size:10px; font-weight:600; color:#0f172a; margin-bottom:6px;">DEFORMIDAD (DEF)</span>
                    <div style="display:flex; gap:15px; justify-content:center; align-items:center;">
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="DEF" id="DEF_si" value="si" style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">S√≠</span>
                        </label>
                        <label style="display:inline-flex; align-items:center; gap:2px; font-size:9px; cursor:pointer; white-space:nowrap;">
                            <input type="radio" name="DEF" id="DEF_no" value="no" checked style="margin:0; vertical-align:middle; transform:scale(0.8);"> 
                            <span style="vertical-align:middle;">No</span>
                        </label>
                    </div>
                </div>

                <!-- Acciones -->
                <div style="background:#f8fafc; border:1px solid #e2e8f0; padding:8px 10px; border-radius:6px; display:flex; flex-direction:column; gap:4px; justify-content:center;">
                    <button type="button" class="btn-base btn-calc" onclick="evaluarRiesgoPieDM()" style="padding:4px 6px; font-size:9px;">‚öôÔ∏è Calcular</button>
                    <button type="button" class="btn-base btn-reset" onclick="limpiarFormularioPieDM()" style="padding:4px 6px; font-size:9px;">üßπ Limpiar</button>
                </div>
            </div>

            <!-- Secci√≥n: Fondo de ojos -->
            <div class="piedm-subsection" style="margin-top:12px; padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
                <h4 style="margin:0 0 8px 0; font-size:14px; color:#0f172a;">Fondo de ojos (vigente 1 a√±o)</h4>
                
                <!-- Estado y bot√≥n Nuevo -->
                <div id="fondoOjosUltimo" style="margin:8px 0; padding:6px; background:#f0f9ff; border-radius:4px; font-size:11px; color:#0369a1; display:none;">
                    √öltimo registro fondo de ojos
                </div>
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <button type="button" id="fondoOjosNuevoBtn" class="btn-nuevo" style="display:none; background:#10b981; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer;">‚≠ï Nuevo</button>
                    <span id="fondoOjosStatus" style="font-size:11px; color:#64748b;"></span>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end;">
                    <label style="display:block; font-size:12px; color:#334155;">
                        Fecha
                        <input type="date" id="fondoOjosFecha" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                    </label>
                    <label style="display:block; font-size:12px; color:#334155;">
                        Estado
                        <select id="fondoOjosEstado" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                            <option value="">-- Seleccione --</option>
                            <option value="normal">Normal</option>
                            <option value="retinopatia_np">Retinopat√≠a no proliferativa</option>
                            <option value="retinopatia_p">Retinopat√≠a proliferativa</option>
                            <option value="maculopatia">Maculopat√≠a</option>
                            <option value="desconocido">Desconocido</option>
                        </select>
                    </label>
                </div>
                
                <!-- Bot√≥n guardar Fondo de ojos -->
                <button type="button" id="fondoOjosGuardarBtn" class="btn btn-primary" style="margin-top:8px; font-size:11px; padding:4px 8px;">üíæ Guardar</button>
                
                <!-- Historial Fondo de ojos -->
                <div id="fondoOjosHist" style="margin-top:12px; display:none;">
                    <h5 style="font-size:11px; margin:0 0 4px 0; color:#374151;">üìã Historial Fondo de ojos</h5>
                    <div style="max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px;">
                        <table style="width:100%; font-size:10px; border-collapse:collapse;">
                            <thead style="background:#f9fafb;">
                                <tr><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Fecha</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Estado</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Registro</th></tr>
                            </thead>
                            <tbody id="fondoOjosHistBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Historial Pie Diab√©tico -->
            <div id="pieDmHist" style="margin-top:12px; display:none;">
                <h5 style="font-size:11px; margin:0 0 6px 0; color:#374151;">üìã Historial Evaluaciones Pie Diab√©tico</h5>
                <div style="max-height:150px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px; background:#fff;">
                    <table style="width:100%; font-size:10px; border-collapse:collapse;">
                        <thead style="background:#f9fafb; position:sticky; top:0;">
                            <tr>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">Fecha</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">√ölcera</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">Amput.</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">Sens.</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">EAP</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">DEF</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">Insulina</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">Riesgo</th>
                                <th style="padding:4px; border-bottom:1px solid #e5e7eb;">Registro</th>
                            </tr>
                        </thead>
                        <tbody id="pieDmHistBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Historial de Evaluaciones Anteriores -->
            <div id="pieDmHistorial" style="margin-top:12px; padding:12px; border:1px solid #e2e8f0; border-radius:8px; background:#f9fafb; display:none;">
                <h4 style="margin:0 0 8px 0; font-size:12px; color:#374151; font-weight:600;">üìã Historial de Evaluaciones</h4>
                <div id="pieDmHistorialContent" style="max-height:200px; overflow-y:auto;">
                    <div style="text-align:center; color:#64748b; font-size:11px; padding:20px;">
                        No hay evaluaciones previas
                    </div>
                </div>
            </div>

            <!-- Historial Tratamiento Insulina -->
            <div id="insulinaHistorial" style="display:none; margin-top:12px;">
                <div style="background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px;">
                    <h4 style="margin:0 0 8px 0; font-size:12px; font-weight:600; color:#374151;">üìã Historial Tratamiento Insulina</h4>
                    <div id="insulinaHistorialEntries" style="max-height:150px; overflow-y:auto; background:#fff; border:1px solid #e2e8f0; border-radius:4px; padding:6px;">
                        <em style="color:#64748b; font-size:10px;">Sin evaluaciones previas</em>
                    </div>
                </div>
            </div>

            <!-- Resultados y acciones -->
            <div style="display:flex; gap:12px; margin-top:12px; align-items:start;">
                <div style="flex:1;">
                    <div id="resultadoPieDM" class="piedm-result-box" style="display:none;"></div>
                    <div id="fechasPieDM" class="piedm-dates"></div>
                </div>
                <div id="statusGuardarPieDM" class="piedm-status" style="min-width:200px;"></div>
            </div>
    </div>
        <hr style="margin:26px 0 20px;">
            <div id="diabetesExtrasEstado" class="ultima-box" style="margin-bottom:12px;">
                <em>Tratamiento insulina y fondo de ojos: sin datos</em>
            </div>

            <!-- Contenedor para Atenci√≥n Podol√≥gica e Hipoglicemias lado a lado -->
            <div style="display:flex !important; flex-direction:row !important; gap:12px !important; margin-top:12px; width:100%;">
                
                <!-- Sub-secci√≥n: Atenci√≥n Podol√≥gica -->
                <div class="piedm-subsection" style="padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc; width:50% !important; flex:1 !important; box-sizing:border-box; transform:none !important; cursor:default !important;">
                    <h4 style="margin:0 0 8px 0; font-size:14px; color:#0f172a;">Atenci√≥n podol√≥gica (vigente 1 a√±o)</h4>
                    
                    <!-- √öltimo registro -->
                    <div id="podologiaUltimo" style="margin:8px 0; padding:6px 8px; background:#f0f9ff; border-radius:4px; font-size:11px; color:#0369a1; display:none;">
                        √öltimo registro guardado
                    </div>
                    
                    <!-- Header con bot√≥n nuevo -->
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                        <button type="button" id="podologiaNuevoBtn" class="btn-nuevo" style="display:none; background:#10b981; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer;">‚≠ï Nuevo</button>
                        <span id="podologiaStatus" style="font-size:11px; color:#64748b;"></span>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 0.8fr; gap:8px; align-items:end;">
                        <label style="display:block; font-size:12px; color:#334155;">
                            Fecha
                            <input type="date" id="podologiaFecha" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                        </label>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <span style="font-size:12px; color:#334155; font-weight:500;">¬øAtenci√≥n vigente?</span>
                            <div style="display:flex; gap:10px; align-items:center; justify-content:flex-start;">
                                <label style="display:inline-flex; align-items:center; gap:2px; font-size:11px; cursor:pointer; white-space:nowrap;">
                                    <input type="radio" name="podologiaVigente" id="podologiaVigente_si" value="si" style="margin:0; vertical-align:middle; transform:scale(0.85);"> 
                                    <span style="vertical-align:middle;">S√≠</span>
                                </label>
                                <label style="display:inline-flex; align-items:center; gap:2px; font-size:11px; cursor:pointer; white-space:nowrap;">
                                    <input type="radio" name="podologiaVigente" id="podologiaVigente_no" value="no" checked style="margin:0; vertical-align:middle; transform:scale(0.85);"> 
                                    <span style="vertical-align:middle;">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="mini-actions" style="align-self:end;">
                            <button type="button" id="podologiaGuardarBtn" class="btn" onclick="guardarPodologia()" style="padding:6px 10px; font-size:11px;">üíæ Guardar</button>
                        </div>
                    </div>
                    
                    <div id="podologiaHist" style="margin-top:10px; display:none;">
                        <h5 style="font-size:11px; margin:0 0 4px 0; color:#374151;">üìã Historial Atenci√≥n Podol√≥gica</h5>
                        <div style="max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px;">
                            <table style="width:100%; font-size:10px; border-collapse:collapse;">
                                <thead style="background:#f9fafb;">
                                    <tr><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Fecha</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Vigente</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Registro</th></tr>
                                </thead>
                                <tbody id="podologiaHistBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sub-secci√≥n: Hipoglicemias recurrentes -->
                <div class="piedm-subsection" style="padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc; width:50% !important; flex:1 !important; box-sizing:border-box; transform:none !important; cursor:default !important;">
                    <h4 style="margin:0 0 8px 0; font-size:14px; color:#0f172a;">Hipoglicemias recurrentes</h4>
                    
                    <!-- √öltimo registro -->
                    <div id="hipoUltimo" style="margin:8px 0; padding:6px 8px; background:#f0f9ff; border-radius:4px; font-size:11px; color:#0369a1; display:none;">
                        √öltimo registro guardado
                    </div>
                    
                    <!-- Header con bot√≥n nuevo -->
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                        <button type="button" id="hipoNuevoBtn" class="btn-nuevo" style="display:none; background:#10b981; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer;">‚≠ï Nuevo</button>
                        <span id="hipoStatus" style="font-size:11px; color:#64748b;"></span>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr 0.8fr; gap:8px; align-items:end;">
                        <label style="display:block; font-size:12px; color:#334155;">
                            Fecha evaluaci√≥n
                            <input type="text" id="hipoFecha" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatearFecha(this);" onkeypress="return soloNumeros(event)" onblur="validarFechaCompleta(this);" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                            <small style="color:#64748b; font-size:10px;">Ingrese fecha manualmente</small>
                        </label>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <span style="font-size:12px; color:#334155; font-weight:500;">¬øRecurrente?</span>
                            <div style="display:flex; gap:10px; align-items:center; justify-content:flex-start;">
                                <label style="display:inline-flex; align-items:center; gap:2px; font-size:11px; cursor:pointer; white-space:nowrap;">
                                    <input type="radio" name="hipoRecurrente" id="hipoRecurrente_si" value="si" style="margin:0; vertical-align:middle; transform:scale(0.85);"> 
                                    <span style="vertical-align:middle;">S√≠</span>
                                </label>
                                <label style="display:inline-flex; align-items:center; gap:2px; font-size:11px; cursor:pointer; white-space:nowrap;">
                                    <input type="radio" name="hipoRecurrente" id="hipoRecurrente_no" value="no" checked style="margin:0; vertical-align:middle; transform:scale(0.85);"> 
                                    <span style="vertical-align:middle;">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="mini-actions" style="align-self:end;">
                            <button type="button" id="hipoGuardarBtn" class="btn" onclick="guardarHipoglicemias()" style="padding:6px 10px; font-size:11px;">üíæ Guardar</button>
                        </div>
                    </div>
                    
                    <div id="hipoHist" style="margin-top:10px; display:none;">
                        <h5 style="font-size:11px; margin:0 0 4px 0; color:#374151;">üìã Historial Hipoglicemias</h5>
                        <div style="max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px;">
                            <table style="width:100%; font-size:10px; border-collapse:collapse;">
                                <thead style="background:#f9fafb;">
                                    <tr><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Fecha</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Recurrente</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Registro</th></tr>
                                </thead>
                                <tbody id="hipoHistBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Sub-secci√≥n: Curaciones Pie DM (solo visible si diagn√≥stico diabetes) -->
            <div id="curacionPieSection" class="piedm-subsection" style="display:none; margin-top:12px; padding:12px 14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
                <h4 style="margin:0 0 8px 0; font-size:14px; color:#0f172a;">Curaciones Pie DM</h4>
                
                <!-- √öltimo registro -->
                <div id="curacionPieUltimo" style="margin:8px 0; padding:6px 8px; background:#f0f9ff; border-radius:4px; font-size:11px; color:#0369a1; display:none;">
                    √öltimo registro guardado
                </div>
                
                <!-- Header con bot√≥n nuevo -->
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <button type="button" id="curacionPieNuevoBtn" class="btn-nuevo" style="display:none; background:#10b981; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer;" onclick="iniciarNuevoCuracionesPieDm()">‚≠ï Nuevo</button>
                    <span id="curacionPieStatus" style="font-size:11px; color:#64748b;"></span>
                </div>
                
                <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; align-items:end;">
                    <label style="display:block; font-size:12px; color:#334155;">
                        Fecha
                        <input type="text" id="curacionPieFecha" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatearFecha(this);" onkeypress="return soloNumeros(event)" onblur="validarFechaCompleta(this);" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                        <small style="color:#64748b; font-size:10px;">Ingrese fecha manualmente</small>
                    </label>
                    <label style="display:block; font-size:12px; color:#334155;">
                        ¬øEn curaci√≥n?
                        <select id="curacionPieEnCurso" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                            <option value="">-- Seleccione --</option>
                            <option value="no">No</option>
                            <option value="si">S√≠</option>
                        </select>
                    </label>
                    <label id="curacionPieTipoBox" style="display:none; font-size:12px; color:#334155;">
                        Tipo de curaci√≥n
                        <select id="curacionPieTipo" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                            <option value="">-- Seleccione --</option>
                            <option>Curaci√≥n Convencional</option>
                            <option>Curaci√≥n Avanzada</option>
                            <option>Con ayuda t√©cnica de descarga</option>
                        </select>
                    </label>
                </div>
                <div class="mini-actions" style="margin-top:10px;">
                    <button type="button" id="curacionPieGuardarBtn" class="btn" onclick="guardarCuracionesPieDm()">üíæ Guardar curaci√≥n</button>
                </div>
                
                <div id="curacionPieHist" style="margin-top:10px; display:none;">
                    <h5 style="font-size:11px; margin:0 0 4px 0; color:#374151;">üìã Historial Curaciones Pie DM</h5>
                    <div style="max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px;">
                        <table style="width:100%; font-size:10px; border-collapse:collapse;">
                            <thead style="background:#f9fafb;">
                                <tr><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Fecha</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">En curaci√≥n</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Tipo</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Registro</th></tr>
                            </thead>
                            <tbody id="curacionPieHistBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        <div id="ultimaEvaluacionPieDM" class="ultima-box">
            <em>Ingrese un RUN v√°lido para cargar √∫ltima evaluaci√≥n...</em>
        </div>
    </div>
</div>

<!-- ==================== SEGUIMIENTO CARDIOVASCULAR LATERAL ==================== -->
<div id="seguimientoDiabeticoLateral" class="seguimiento-lateral" style="display:none;">
    <!-- Leng√ºeta desplegable -->
    <div class="seguimiento-tab" onclick="toggleSeguimientoDiabetico()">
        <span class="seguimiento-icon">üìã</span>
        <span class="seguimiento-text" id="seguimientoTabText">Seguimiento<br>Cardiovascular</span>
        <span class="seguimiento-indicator" id="seguimientoIndicador">‚ö†Ô∏è</span>
    </div>
    
    <!-- Panel desplegable -->
    <div class="seguimiento-panel" id="seguimientoPanel">
        <div class="seguimiento-header">
            <h4 id="seguimientoTitulo">üìã Seguimiento Integral Cardiovascular</h4>
            <button class="seguimiento-close" onclick="toggleSeguimientoDiabetico()">√ó</button>
        </div>
        
        <div class="seguimiento-content">
            <!-- Secci√≥n com√∫n para ambas condiciones -->
            <div class="seguimiento-section" id="seccionComun">
                <div class="seguimiento-item" data-criterio="rac">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Raz√≥n Alb√∫mina/Creatinina (RAC)</strong>
                        <small>Examenes RAC + Creatininemia vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="vfg">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Velocidad Filtraci√≥n Glomerular (VFG)</strong>
                        <small>VFG vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="vfg_rac">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>VFG + RAC + Creatininemia</strong>
                        <small>Evaluaci√≥n renal completa vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="erc_medicacion">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>ERC + IECA/ARA II</strong>
                        <small>ERC en diagn√≥stico + tratamiento</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="actividad_fisica">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Actividad F√≠sica Salud Cardiovascular</strong>
                        <small>Evaluaci√≥n vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="fumador_actual">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Fumador Actual</strong>
                        <small>Evaluaci√≥n vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
            </div>

            <!-- Secci√≥n espec√≠fica para diabetes -->
            <div class="seguimiento-section" id="seccionDiabetes" style="display:none;">
                <div class="seguimiento-separator">
                    <span>ü©∏ Criterios Espec√≠ficos Diabetes</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="fondo_ojo">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Fondo de Ojo</strong>
                        <small>Evaluaci√≥n oftalmol√≥gica vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="podologia">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Atenci√≥n Podol√≥gica</strong>
                        <small>Evaluaci√≥n podol√≥gica vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="insulina">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Tratamiento con Insulina</strong>
                        <small>Registro vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="hba1c">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>HbA1c seg√∫n edad</strong>
                        <small>&lt;7% (&lt;80 a√±os), &lt;8% (‚â•80 a√±os)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
            </div>

            <!-- Secci√≥n espec√≠fica para hipertensi√≥n -->
            <div class="seguimiento-section" id="seccionHipertension" style="display:none;">
                <div class="seguimiento-separator">
                    <span>üî¥ Criterios Espec√≠ficos Hipertensi√≥n PSCV</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="presion_arterial">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Presi√≥n Arterial ‚â•160/100 mmHg</strong>
                        <small>Control de presi√≥n arterial vigente</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="enfermedad_renal_cronica">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Diagn√≥stico Enfermedad Renal Cr√≥nica</strong>
                        <small>ERC diagnosticada vigente</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="protocolo_hearts">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Protocolo Hearts</strong>
                        <small>Implementaci√≥n protocolo vigente</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
            </div>

            <!-- Secci√≥n com√∫n continuaci√≥n -->
            <div class="seguimiento-section" id="seccionComunContinuacion">
                <div class="seguimiento-separator">
                    <span>üî¨ Ex√°menes Generales</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="ecg">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Electrocardiograma (ECG)</strong>
                        <small>ECG vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="tabaquismo">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Fumador Actual</strong>
                        <small>Evaluaci√≥n vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
                
                <div class="seguimiento-item" data-criterio="colesterol_ldl">
                    <span class="criterio-icon">‚ö†Ô∏è</span>
                    <div class="criterio-text">
                        <strong>Colesterol LDL</strong>
                        <small>Examen vigente (1 a√±o)</small>
                    </div>
                    <span class="criterio-status">Sin datos</span>
                </div>
            </div>
        </div>
        
        <div class="seguimiento-footer">
            <div class="seguimiento-summary">
                <span id="seguimientoCompleto">0</span> completados de 
                <span id="seguimientoTotal">11</span> criterios
            </div>
            <button class="seguimiento-refresh" onclick="evaluarSeguimientoDiabetico()">üîÑ Actualizar</button>
        </div>
    </div>
</div>

<!-- ===== TRATAMIENTO CON INSULINA ===== -->
<div class="mini-wrapper" id="tratamientoInsulinaSection" style="display:none;">
    <div class="mini-header">
        <h3>üíâ Tratamiento con insulina</h3>
    </div>
    <div class="mini-panel">
        <!-- Controles principales -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding:8px 12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px;">
            <span style="font-size:12px; font-weight:600; color:#0f172a;">EVALUACI√ìN TRATAMIENTO INSULINA</span>
            <div style="display:flex; gap:8px; align-items:center;">
                <button type="button" id="insulinaGuardarBtn" class="btn-guardar" style="background:#2563eb; color:white; border:none; padding:6px 12px; font-size:11px; border-radius:4px; cursor:pointer;">üíæ Guardar</button>
                <button type="button" id="insulinaNuevoBtn" class="btn-nuevo" style="background:#10b981; color:white; border:none; padding:6px 12px; font-size:11px; border-radius:4px; cursor:pointer; display:none;">‚≠ï Nuevo</button>
                <span id="insulinaStatus" style="font-size:11px; color:#64748b;"></span>
            </div>
        </div>

        <!-- Fecha de evaluaci√≥n manual -->
        <div style="margin-bottom:12px; padding:10px; background:#fff; border:1px solid #e2e8f0; border-radius:6px;">
            <div style="margin-bottom:8px;">
                <label for="insulinaFechaReal" style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:4px;">üìÖ Fecha de evaluaci√≥n</label>
                <input type="text" id="insulinaFechaReal" placeholder="dd/mm/aaaa" maxlength="10" 
                       oninput="(function(inp){const d=inp.value.replace(/\D/g,'').slice(0,8);const p1=d.slice(0,2),p2=d.slice(2,4),p3=d.slice(4,8);inp.value=d.length<=2?p1:d.length<=4?p1+'/'+p2:p1+'/'+p2+'/'+p3;})(this);" 
                       onkeypress="if(event.key.length>1)return true;if(/[0-9\/]/.test(event.key))return true;event.preventDefault();return false;" 
                       inputmode="numeric" 
                       style="width:200px; padding:8px 10px; font-size:12px; border:1px solid #cbd5e1; border-radius:4px;">
                <small style="display:block; color:#64748b; font-size:10px; margin-top:4px;">‚ö†Ô∏è Ingrese fecha manualmente (dd/mm/aaaa)</small>
            </div>
        </div>

        <!-- Opciones de tratamiento -->
        <div style="margin-bottom:12px; padding:10px; background:#fff; border:1px solid #e2e8f0; border-radius:6px;">
            <label style="display:block; font-size:12px; font-weight:600; color:#374151; margin-bottom:8px;">¬øPaciente en tratamiento con insulina?</label>
            <div style="display:flex; gap:20px; justify-content:center; align-items:center;">
                <label style="display:inline-flex; align-items:center; gap:6px; font-size:12px; cursor:pointer;">
                    <input type="radio" name="tratamientoInsulina" id="tratamientoInsulina_si" value="si" style="margin:0; transform:scale(1.1);"> 
                    <span>S√≠</span>
                </label>
                <label style="display:inline-flex; align-items:center; gap:6px; font-size:12px; cursor:pointer;">
                    <input type="radio" name="tratamientoInsulina" id="tratamientoInsulina_no" value="no" style="margin:0; transform:scale(1.1);"> 
                    <span>No</span>
                </label>
            </div>
            <div style="display:flex; align-items:center; gap:10px; margin-top:8px; justify-content:center;">
                <button type="button" id="insulinaGuardarBtn" class="btn" onclick="guardarInsulina()" style="background:#3b82f6; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üíæ Guardar</button>
                <button type="button" id="insulinaNuevoBtn" class="btn" style="display:none; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold;" onclick="iniciarNuevoInsulina()">üÜï Nuevo Registro</button>
                <small id="insulinaVigencia" style="color:#64748b; font-size:11px; display:none;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
            </div>
        </div>

        <!-- Estado del registro -->
        <div id="insulinaStatus" style="text-align:center; margin-bottom:12px; font-size:11px; color:#666;"></div>

        <!-- √öltimo registro guardado -->
        <div id="insulinaUltimoRegistro" style="display:none; background:#f0f9ff; border:1px solid #0ea5e9; padding:8px 12px; border-radius:6px; font-size:11px; color:#0c4a6e; margin-bottom:12px;">
            <strong>üìã √öltimo registro:</strong> <span id="insulinaUltimoTexto"></span>
        </div>

        <!-- Hist√≥rico -->
        <div id="insulinaHist" style="display:none; margin-top:12px;">
            <h4 style="font-size:12px; margin-bottom:8px; color:#374151;">üìÑ Hist√≥rico de evaluaciones</h4>
            <table style="width:100%; font-size:10px; border-collapse:collapse;">
                <thead>
                    <tr style="background:#f8fafc;">
                        <th style="border:1px solid #e2e8f0; padding:4px;">Fecha Evaluaci√≥n</th>
                        <th style="border:1px solid #e2e8f0; padding:4px;">Tratamiento</th>
                        <th style="border:1px solid #e2e8f0; padding:4px;">Registrado</th>
                    </tr>
                </thead>
                <tbody id="insulinaHistBody"></tbody>
            </table>
        </div>

    </div>
</div>

<!-- ===== RIESGO CV Y ESTILOS DE VIDA ===== -->
<div class="mini-wrapper" id="cvLifestyleSection">
    <div class="mini-header">
        <h3>ü´Ä Riesgo cardiovascular y estilos de vida</h3>
    </div>
    <div class="mini-panel">
        <div class="mini-grid">
            <!-- Riesgo CV -->
            <div class="mini-field">
                <label class="mini-label">Riesgo cardiovascular</label>
                <div class="campos-linea" style="align-items:end; gap:10px;">
                    <label style="flex:1;">
                        Fecha
                        <input type="text" id="cvRiesgoFecha" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                    </label>
                    <label style="flex:1;">
                        Nivel
                        <select id="cvRiesgoNivel">
                            <option value="">-- Seleccione --</option>
                            <option value="bajo">Bajo</option>
                            <option value="moderado">Moderado</option>
                            <option value="alto">Alto</option>
                            <option value="maximo">M√°ximo</option>
                        </select>
                    </label>
                    <button type="button" id="cvRiesgoGuardarBtn" class="btn" onclick="guardarCvRiesgo()">üíæ Guardar</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                    <button type="button" id="cvRiesgoNuevoBtn" class="btn" style="display:inline-block; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoCvRiesgo()">üÜï Nuevo Registro</button>
                    <small id="cvRiesgoVigencia" style="color:#64748b; font-size:11px; display:none;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                </div>
                <div id="cvRiesgoStatus" class="mini-status"></div>
                <div id="cvRiesgoUltimo" class="ultima-box" style="display:none; margin-top:6px;"></div>
                <div id="cvRiesgoHist" style="display:none; margin-top:8px;">
                    <table class="mini-table"><thead><tr><th>Fecha</th><th>Nivel</th><th>Creado</th></tr></thead><tbody id="cvRiesgoHistBody"></tbody></table>
                </div>
            </div>
            <!-- Actividad f√≠sica -->
            <div class="mini-field">
                <label class="mini-label">Actividad f√≠sica (actual)</label>
                <div class="campos-linea" style="align-items:end; gap:10px;">
                    <label style="flex:1;">
                        Fecha
                        <input type="text" id="cvActFecha" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                    </label>
                    <label style="flex:1;">
                        ¬øActivo?
                        <select id="cvActActivo">
                            <option value="">-- Seleccione --</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                        </select>
                    </label>
                    <button type="button" id="cvActGuardarBtn" class="btn" onclick="guardarActividadFisica()">üíæ Guardar</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                    <button type="button" id="cvActNuevoBtn" class="btn" style="display:inline-block; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoActividadFisica()">üÜï Nuevo Registro</button>
                    <small id="cvActVigencia" style="color:#64748b; font-size:11px; display:none;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                </div>
                <div id="cvActStatus" class="mini-status"></div>
                <div id="cvActUltimo" class="ultima-box" style="display:none; margin-top:6px;"></div>
                <div id="cvActHist" style="display:none; margin-top:8px;">
                    <table class="mini-table"><thead><tr><th>Fecha</th><th>Activo</th><th>Creado</th></tr></thead><tbody id="cvActHistBody"></tbody></table>
                </div>
            </div>
            <!-- Tabaquismo -->
            <div class="mini-field">
                <label class="mini-label">Tabaquismo actual</label>
                <div class="campos-linea" style="align-items:end; gap:10px;">
                    <label style="flex:1;">
                        Fecha
                        <input type="text" id="cvTabFecha" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                    </label>
                    <label style="flex:1;">
                        ¬øFumador?
                        <select id="cvTabFumador">
                            <option value="">-- Seleccione --</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                        </select>
                    </label>
                    <button type="button" id="cvTabGuardarBtn" class="btn" onclick="guardarTabaquismo()">üíæ Guardar</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                    <button type="button" id="cvTabNuevoBtn" class="btn" style="display:inline-block; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoTabaquismo()">üÜï Nuevo Registro</button>
                    <small id="cvTabVigencia" style="color:#64748b; font-size:11px; display:none;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                </div>
                <div id="cvTabStatus" class="mini-status"></div>
                <div id="cvTabUltimo" class="ultima-box" style="display:none; margin-top:6px;"></div>
                <div id="cvTabHist" style="display:none; margin-top:8px;">
                    <table class="mini-table"><thead><tr><th>Fecha</th><th>Fumador</th><th>Creado</th></tr></thead><tbody id="cvTabHistBody"></tbody></table>
                </div>
            </div>
            <!-- Protocolo HEARTS -->
            <div class="mini-field">
                <label class="mini-label">Protocolo HEARTS</label>
                <div class="campos-linea" style="align-items:end; gap:10px;">
                    <label style="flex:1;">
                        Fecha
                        <input type="text" id="cvHeartsFecha" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" style="width:100%; padding:6px 8px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px;">
                    </label>
                    <label style="flex:1;">
                        ¬øEn protocolo?
                        <select id="cvHeartsEn">
                            <option value="">-- Seleccione --</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                        </select>
                    </label>
                    <button type="button" id="cvHeartsGuardarBtn" class="btn" onclick="guardarHearts()">üíæ Guardar</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                    <button type="button" id="cvHeartsNuevoBtn" class="btn" style="display:inline-block; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoHearts()">üÜï Nuevo Registro</button>
                    <small id="cvHeartsVigencia" style="color:#64748b; font-size:11px; display:none;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                </div>
                <div id="cvHeartsStatus" class="mini-status"></div>
                <div id="cvHeartsUltimo" class="ultima-box" style="display:none; margin-top:6px;"></div>
                <div id="cvHeartsHist" style="display:none; margin-top:8px;">
                    <table class="mini-table"><thead><tr><th>Fecha</th><th>En protocolo</th><th>Creado</th></tr></thead><tbody id="cvHeartsHistBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== MEDICACI√ìN (IECA/ARA II, Antiagregantes, Estatinas) ===== -->
<div class="mini-wrapper" id="medicacionSection" style="display:none;">
    <div class="mini-header">
        <h3>üíä Medicaci√≥n</h3>
    </div>
    <div class="mini-panel">
        <div class="mini-grid">
            <!-- IECA / ARA II -->
            <div class="mini-field">
                <label class="mini-label">IECA / ARA II <span id="medIecaHelp" style="cursor:pointer;" title="Mostrar uso IECA o ARA">‚ìò</span></label>
                <div class="campos-linea" style="align-items:end; gap:10px;">
                    <label style="flex:1;">
                        Fecha
                        <input type="date" id="medIecaFecha">
                    </label>
                    <label style="flex:1;">
                        Tipo
                        <select id="medIecaTipo">
                            <option value="">-- Seleccione --</option>
                            <option value="NO">No</option>
                            <option value="IECA">IECA</option>
                            <option value="ARA II">ARA II</option>
                        </select>
                    </label>
                    <button type="button" id="medIecaGuardarBtn" class="btn" onclick="guardarIecaAra()">üíæ Guardar</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                    <button type="button" id="medIecaNuevoBtn" class="btn" style="display:inline-block; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoIecaAra()">üÜï Nuevo Registro</button>
                    <small id="medIecaVigencia" style="color:#22c55e; font-size:11px; display:none; font-weight:600;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                </div>
                <div id="medIecaStatus" class="mini-status"></div>
                <div id="medIecaUltimo" class="ultima-box" style="display:none; margin-top:6px;"></div>
                <div id="medIecaHist" style="display:none; margin-top:8px;">
                    <table class="mini-table"><thead><tr><th>Fecha</th><th>Tipo</th><th>Creado</th></tr></thead><tbody id="medIecaHistBody"></tbody></table>
                </div>
            </div>
            <!-- Antiagregantes -->
            <div class="mini-field">
                <label class="mini-label">Antiagregantes <span id="medAntiHelp" style="cursor:help;" title="Antiagregante plaquetario: acetil salic√≠lico (AAS) u 'rivo', acenocumarol, clopidogrel, etc.">‚ìò</span></label>
                <div class="campos-linea" style="align-items:end; gap:10px;">
                    <label style="flex:1;">
                        Fecha
                        <input type="date" id="medAntiFecha">
                    </label>
                    <label style="flex:1;">
                        ¬øEn tratamiento?
                        <select id="medAntiEn">
                            <option value="">-- Seleccione --</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                        </select>
                    </label>
                    <button type="button" id="medAntiGuardarBtn" class="btn" onclick="guardarAntiagregantes()">üíæ Guardar</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                    <button type="button" id="medAntiNuevoBtn" class="btn" style="display:inline-block; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoAntiagregantes()">üÜï Nuevo Registro</button>
                    <small id="medAntiVigencia" style="color:#22c55e; font-size:11px; display:none; font-weight:600;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                </div>
                <div id="medAntiStatus" class="mini-status"></div>
                <div id="medAntiUltimo" class="ultima-box" style="display:none; margin-top:6px;"></div>
                <div id="medAntiHist" style="display:none; margin-top:8px;">
                    <table class="mini-table"><thead><tr><th>Fecha</th><th>En tratamiento</th><th>Creado</th></tr></thead><tbody id="medAntiHistBody"></tbody></table>
                </div>
            </div>
            <!-- Estatinas -->
            <div class="mini-field">
                <label class="mini-label">Estatinas <span id="medEstatHelp" style="cursor:help;" title="Estatinas: simvastatina, pravastatina, atorvastatina u otra.">‚ìò</span></label>
                <div class="campos-linea" style="align-items:end; gap:10px;">
                    <label style="flex:1;">
                        Fecha
                        <input type="date" id="medEstatFecha">
                    </label>
                    <label style="flex:1;">
                        ¬øEn tratamiento?
                        <select id="medEstatEn">
                            <option value="">-- Seleccione --</option>
                            <option value="si">S√≠</option>
                            <option value="no">No</option>
                        </select>
                    </label>
                    <button type="button" id="medEstatGuardarBtn" class="btn" onclick="guardarEstatinas()">üíæ Guardar</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                    <button type="button" id="medEstatNuevoBtn" class="btn" style="display:inline-block; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoEstatinas()">üÜï Nuevo Registro</button>
                    <small id="medEstatVigencia" style="color:#22c55e; font-size:11px; display:none; font-weight:600;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                </div>
                <div id="medEstatStatus" class="mini-status"></div>
                <div id="medEstatUltimo" class="ultima-box" style="display:none; margin-top:6px;"></div>
                <div id="medEstatHist" style="display:none; margin-top:8px;">
                    <table class="mini-table"><thead><tr><th>Fecha</th><th>En tratamiento</th><th>Creado</th></tr></thead><tbody id="medEstatHistBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>
    <div class="mini-note" style="margin-top:10px; color:#64748b; font-size:12px;">Visible si el usuario tiene: HTA y/o Diabetes y/o Enfermedad Renal.</div>
  </div>

<script>
// === PIE DM: l√≥gica de c√°lculo, auto-guardado y recuperaci√≥n ===

// A√±adir tooltip criterios riesgo (si no existe)
(function(){
  const id='piedm-criterios-info';
  if(document.getElementById(id)) return;
  const summary = document.getElementById('pieDmSummary');
  if(!summary) return;
  const info = document.createElement('span');
  info.id=id;
  info.textContent='‚ìò';
  info.style.cssText='margin-left:6px; cursor:help; font-size:12px; color:#475569;';
  info.title='Criterios:\nBajo: Sin p√©rdida de sensibilidad, sin EAP\nModerado: P√©rdida de sensibilidad aislada\nAlto: EAP o combinaci√≥n p√©rdida + deformidad\nM√°ximo: √ölcera activa o amputaci√≥n previa';
  summary.parentNode.insertBefore(info, summary.nextSibling);
})();

// ======= Medicaci√≥n: helpers y funciones =======
// Modal simple para textos de ayuda
function showSimpleModal(title, htmlContent){
    try{ const old=document.getElementById('simple-modal-overlay'); if(old) old.remove(); }catch(e){}
    const overlay=document.createElement('div');
    overlay.id='simple-modal-overlay';
    overlay.style.cssText='position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:9999; display:flex; align-items:center; justify-content:center;';
    const box=document.createElement('div');
    box.style.cssText='background:#fff; border-radius:10px; width:min(720px,92vw); max-height:85vh; overflow:auto; box-shadow:0 12px 30px rgba(0,0,0,.25);';
    box.innerHTML=`
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #eee; background:#f8fafc;">
            <h3 style="margin:0; font-size:18px;">${title}</h3>
            <button id="simple-modal-close" style="border:none; background:transparent; font-size:18px; cursor:pointer;">‚úñ</button>
        </div>
        <div style="padding:16px; line-height:1.45; font-size:14px; color:#1f2937;">${htmlContent}</div>
    `;
    overlay.appendChild(box);
    document.body.appendChild(overlay);
    const close=()=>overlay.remove();
    document.getElementById('simple-modal-close').addEventListener('click', close);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) close(); });
    document.addEventListener('keydown', function onEsc(ev){ if(ev.key==='Escape'){ close(); document.removeEventListener('keydown', onEsc); } });
}

// Contenido de ayuda: IECA / ARA II
const IECA_ARA_HELP_HTML = `
    <div>
        <p><strong>Mostrar uso IECA o ARA:</strong></p>
        <ol style="padding-left: 18px;">
            <li><strong>IECA</strong> (Inhibidores de la Enzima Convertidora de Angiotensina)<br>
                <em>Ejemplos:</em> enalapril, lisinopril, captopril.<br>
                <ul style="margin-top:6px;">
                    <li><strong>Mecanismo:</strong> bloquean la enzima que convierte angiotensina I en angiotensina II.</li>
                    <li><strong>Efectos:</strong> bajan la presi√≥n arterial, reducen la poscarga y la precarga, disminuyen la progresi√≥n de da√±o renal y card√≠aco.</li>
                    <li><strong>Efectos adversos t√≠picos:</strong> tos seca persistente (por acumulaci√≥n de bradiquininas), angioedema (menos frecuente pero serio), hipotensi√≥n, hiperpotasemia.</li>
                </ul>
            </li>
            <li style="margin-top:10px;"><strong>ARA II</strong> (Antagonistas de los Receptores de Angiotensina II, tambi√©n llamados sartanes)<br>
                <em>Ejemplos:</em> losart√°n, valsart√°n, candesart√°n.<br>
                <ul style="margin-top:6px;">
                    <li><strong>Mecanismo:</strong> bloquean directamente el receptor AT1 de la angiotensina II.</li>
                    <li><strong>Efectos:</strong> similares a los IECA en bajar presi√≥n y proteger ri√±√≥n/coraz√≥n.</li>
                    <li><strong>Efectos adversos:</strong> no generan tos (porque no afectan bradiquininas), pero comparten riesgo de hiperpotasemia, hipotensi√≥n, y angioedema (menos frecuente a√∫n que en IECA).</li>
                </ul>
            </li>
        </ol>
    </div>
`;

// Click en icono de informaci√≥n IECA/ARA II
document.addEventListener('DOMContentLoaded', ()=>{
    const helpEl=document.getElementById('medIecaHelp');
    if(helpEl){
        helpEl.addEventListener('click', (e)=>{
            e.preventDefault(); e.stopPropagation();
            showSimpleModal('IECA / ARA II ‚Äì Informaci√≥n', IECA_ARA_HELP_HTML);
        });

        // Tooltip ligero al hover
        let tip;
        const showTip=(evt)=>{
            try{ if(tip) tip.remove(); }catch(_e){}
            tip=document.createElement('div');
            tip.textContent='Mostrar uso IECA o ARA';
            tip.style.cssText='position:fixed; background:#111827; color:#fff; font-size:12px; padding:6px 8px; border-radius:6px; pointer-events:none; z-index:10000; box-shadow:0 2px 8px rgba(0,0,0,.25);';
            document.body.appendChild(tip);
            positionTip(evt);
        };
        const positionTip=(evt)=>{
            if(!tip) return;
            const pad=10; const x=(evt.clientX||0)+pad; const y=(evt.clientY||0)+pad;
            tip.style.left=x+'px'; tip.style.top=y+'px';
        };
        const hideTip=()=>{ try{ if(tip) tip.remove(); tip=null; }catch(_e){} };
        helpEl.addEventListener('mouseenter', showTip);
        helpEl.addEventListener('mousemove', positionTip);
        helpEl.addEventListener('mouseleave', hideTip);
    }
    
    // Tooltip hover Antiagregantes
    const antiHelp=document.getElementById('medAntiHelp');
    if(antiHelp){
        let tipA;
        const showA=(evt)=>{ try{ if(tipA) tipA.remove(); }catch(_e){}; tipA=document.createElement('div'); tipA.textContent='Ejemplos: AAS (aspirina), "rivo", acenocumarol, clopidogrel, etc.'; tipA.style.cssText='position:fixed; background:#111827; color:#fff; font-size:12px; padding:6px 8px; border-radius:6px; pointer-events:none; z-index:10000; box-shadow:0 2px 8px rgba(0,0,0,.25);'; document.body.appendChild(tipA); posA(evt); };
        const posA=(evt)=>{ if(!tipA) return; const pad=10; tipA.style.left=((evt.clientX||0)+pad)+'px'; tipA.style.top=((evt.clientY||0)+pad)+'px'; };
        const hideA=()=>{ try{ if(tipA) tipA.remove(); tipA=null; }catch(_e){} };
        antiHelp.addEventListener('mouseenter', showA);
        antiHelp.addEventListener('mousemove', posA);
        antiHelp.addEventListener('mouseleave', hideA);
    }

    // Tooltip hover Estatinas
    const estatHelp=document.getElementById('medEstatHelp');
    if(estatHelp){
        let tipE;
        const showE=(evt)=>{ try{ if(tipE) tipE.remove(); }catch(_e){}; tipE=document.createElement('div'); tipE.textContent='Ejemplos: simvastatina, pravastatina, atorvastatina u otra.'; tipE.style.cssText='position:fixed; background:#111827; color:#fff; font-size:12px; padding:6px 8px; border-radius:6px; pointer-events:none; z-index:10000; box-shadow:0 2px 8px rgba(0,0,0,.25);'; document.body.appendChild(tipE); posE(evt); };
        const posE=(evt)=>{ if(!tipE) return; const pad=10; tipE.style.left=((evt.clientX||0)+pad)+'px'; tipE.style.top=((evt.clientY||0)+pad)+'px'; };
        const hideE=()=>{ try{ if(tipE) tipE.remove(); tipE=null; }catch(_e){} };
        estatHelp.addEventListener('mouseenter', showE);
        estatHelp.addEventListener('mousemove', posE);
        estatHelp.addEventListener('mouseleave', hideE);
    }
});
function hasHtaOrRenalOrDiabetes() {
    // Reutiliza checkboxes de patolog√≠as marcadas
    const codes = ['I10','I11','I12','I13','E10','E11','E12','E13','E14','N18','N19'];
    const items = document.querySelectorAll('.patologia-checkbox');
    for(const cb of items) {
        if(!cb.checked) continue;
        const val=(cb.value||'').toUpperCase();
        const base=val.split('.')[0];
        if(codes.some(c=>base===c || val.startsWith(c))) return true;
    }
    return false;
}

function updateMedicacionVisibility() {
    const sec=document.getElementById('medicacionSection'); 
    if(!sec) return;
    const show=hasHtaOrRenalOrDiabetes();
    sec.style.display = show? '' : 'none';
}

async function guardarIecaAra(){
    const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; }
    const fecha=(document.getElementById('medIecaFecha')?.value)||'';
    const tipo=(document.getElementById('medIecaTipo')?.value)||'';
    const st=document.getElementById('medIecaStatus');
    if(!fecha){ st.textContent='Ingrese fecha'; return; }
    if(!tipo || tipo==='NO'){ st.textContent='Seleccione IECA o ARA II'; return; }
    st.textContent='Guardando...';
    try{
        const resp=await fetch('/api/medicacion/ieca_ara',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha, tipo})});
        const j=await resp.json();
        if(j.success){ st.textContent='Guardado'; await cargarIecaAraUltimo(); await cargarIecaAraHistorial(); }
        else { st.textContent='Error: '+(j.error||''); }
                // Si venimos de guardar examen con ok=1 y ancla de la tabla, mostrar mini-baner local
                const params = new URLSearchParams(window.location.search);
                if (params.get('ok') === '1') {
                    const okDiv = document.getElementById('examen-guardado-ok');
                    if (okDiv) {
                        okDiv.style.display = 'block';
                        // Ocultar autom√°ticamente tras 4 segundos
                        setTimeout(() => { okDiv.style.display = 'none'; }, 4000);
                    }
                }
    }catch(_e){ st.textContent='Error red'; }
}
async function cargarIecaAraUltimo(){
    const run=runRaw(); const box=document.getElementById('medIecaUltimo'); if(!run){ box.style.display='none'; return; }
    try{ const r=await fetch('/api/medicacion/ieca_ara/'+run); const j=await r.json();
        const fechaEl=document.getElementById('medIecaFecha'); const tipoEl=document.getElementById('medIecaTipo'); const btnGuardar=document.getElementById('medIecaGuardarBtn'); const btnNuevo=document.getElementById('medIecaNuevoBtn'); const st=document.getElementById('medIecaStatus'); const vigencia=document.getElementById('medIecaVigencia');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(vigencia) vigencia.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(tipoEl) tipoEl.disabled=false; return; }
    const d=j.data; 
        // Normalizar input oculto a ISO por si API devuelve otra representaci√≥n
        if(fechaEl){
            let iso = '';
            try { const dt = new Date(d.fecha); if(!isNaN(dt.getTime())) iso = dt.toISOString().slice(0,10); } catch(_e){}
            setFechaConOverlay('medIecaFecha', iso || (d.fecha||''), { dispatch: false });
        }
        if(tipoEl) tipoEl.value=d.tipo||'';
        // Mostrar fechas en formato espa√±ol en el resumen
        const fechaEsp = formatearFechaEspanol(d.fecha);
        const creadoEsp = formatearFechaEspanol(d.creado_en);
        box.style.display='block'; box.textContent=`√öltimo: ${fechaEsp} ‚Ä¢ ${d.tipo} ‚Ä¢ ${creadoEsp}`;
        const y=(new Date()).getFullYear();
        let dDate = new Date(d.fecha);
        if(isNaN(dDate.getTime()) && /^\d{4}-\d{2}-\d{2}$/.test(String(d.fecha||''))) {
            dDate = new Date(String(d.fecha||'')+"T00:00:00");
        }
        const dy = dDate.getFullYear();
        const lock = (y===dy);
        if(lock){ 
            if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Vigencia hasta 31/12/${y}.`; 
            if(fechaEl) fechaEl.disabled=true; if(tipoEl) tipoEl.disabled=true; if(btnGuardar) btnGuardar.disabled=true; 
            if(btnNuevo) { btnNuevo.style.display='inline-block'; btnNuevo.style.visibility='visible'; btnNuevo.style.opacity='1'; btnNuevo.style.pointerEvents='auto'; btnNuevo.title='Crear nuevo registro y mover el actual al hist√≥rico'; }
            if(vigencia) { 
                vigencia.style.display='inline'; 
                vigencia.style.color = '#22c55e';
                vigencia.style.fontWeight = '600';
                vigencia.textContent=`‚è∞ Registro v√°lido hasta 31/12/${y} - Pr√≥ximo registro en ${y+1}`; 
            }
        }
        else{ 
            if(st && st.textContent.startsWith('üîí')) st.textContent=''; 
            if(fechaEl) fechaEl.disabled=false; if(tipoEl) tipoEl.disabled=false; if(btnGuardar) btnGuardar.disabled=false; 
            if(btnNuevo) { 
                btnNuevo.style.display='none';
                console.log('‚ùå Ocultando bot√≥n Nuevo IECA/ARA II - registro no del a√±o actual');
            }
            if(vigencia) vigencia.style.display='none';
        }
    }catch(_e){ box.style.display='none'; }
}
function iniciarNuevoIecaAra(){ 
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de IECA/ARA II? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('medIecaFecha'); const tipoEl=document.getElementById('medIecaTipo'); const btnGuardar=document.getElementById('medIecaGuardarBtn'); const btnNuevo=document.getElementById('medIecaNuevoBtn'); const vigencia=document.getElementById('medIecaVigencia');
    if(fechaEl){
        fechaEl.disabled=false;
        try{ setFechaConOverlay('medIecaFecha', '', { dispatch: true }); }catch(_){ fechaEl.value=''; }
    } 
    if(tipoEl){ tipoEl.disabled=false; tipoEl.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    if(vigencia) vigencia.style.display='none';
    const st=document.getElementById('medIecaStatus'); 
    if(st) st.textContent='üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}
async function cargarIecaAraHistorial(){
    // No cargar historiales si estamos limpiando el formulario
    if (window.LIMPIANDO_FORMULARIO) {
        console.log('üö´ No cargando historial IECA/ARA - formulario en limpieza');
        return;
    }
    
    const run=runRaw(); const cont=document.getElementById('medIecaHist'); const tbody=document.getElementById('medIecaHistBody'); if(!run){ cont.style.display='none'; return; }
    try{ const r=await fetch('/api/medicacion/ieca_ara/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; }
    cont.style.display='block'; tbody.innerHTML=j.data.map(d=>`<tr><td>${formatearFechaEspanol(d.fecha)}</td><td>${d.tipo}</td><td>${formatearFechaEspanol(d.creado_en)}</td></tr>`).join('');
    }catch(_e){ cont.style.display='none'; }
}

async function guardarAntiagregantes(){
    const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; }
    const fecha=(document.getElementById('medAntiFecha')?.value)||'';
    const en=(document.getElementById('medAntiEn')?.value)||'';
    const st=document.getElementById('medAntiStatus'); if(!en){ st.textContent='Seleccione opci√≥n'; return; }
    if(!fecha){ st.textContent='Ingrese fecha'; return; }
    st.textContent='Guardando...';
    try{ const resp=await fetch('/api/medicacion/antiagregantes',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha, en_tratamiento: en==='si'})});
        const j=await resp.json(); if(j.success){ st.textContent='Guardado'; await cargarAntiagregantesUltimo(); await cargarAntiagregantesHistorial(); } else { st.textContent='Error: '+(j.error||''); }
    }catch(_e){ st.textContent='Error red'; }
}
async function cargarAntiagregantesUltimo(){
    const run=runRaw(); const box=document.getElementById('medAntiUltimo'); if(!run){ box.style.display='none'; return; }
    try{ const r=await fetch('/api/medicacion/antiagregantes/'+run); const j=await r.json();
        const fechaEl=document.getElementById('medAntiFecha'); const selEl=document.getElementById('medAntiEn'); const btnGuardar=document.getElementById('medAntiGuardarBtn'); const btnNuevo=document.getElementById('medAntiNuevoBtn'); const st=document.getElementById('medAntiStatus'); const vigencia=document.getElementById('medAntiVigencia');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(vigencia) vigencia.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(selEl) selEl.disabled=false; return; }
    const d=j.data; 
    if(fechaEl){ let iso=''; try{ const dt=new Date(d.fecha); if(!isNaN(dt.getTime())) iso=dt.toISOString().slice(0,10);}catch(_e){} setFechaConOverlay('medAntiFecha', iso || (d.fecha||''), { dispatch: false }); }
        if(selEl) selEl.value=d.en_tratamiento?'si':'no';
        const fechaEsp=formatearFechaEspanol(d.fecha); const creadoEsp=formatearFechaEspanol(d.creado_en);
        box.style.display='block'; box.textContent=`√öltimo: ${fechaEsp} ‚Ä¢ ${d.en_tratamiento? 'S√≠':'No'} ‚Ä¢ ${creadoEsp}`;
        const y=(new Date()).getFullYear();
        let dDateA = new Date(d.fecha);
        if(isNaN(dDateA.getTime()) && /^\d{4}-\d{2}-\d{2}$/.test(String(d.fecha||''))) {
            dDateA = new Date(String(d.fecha||'')+"T00:00:00");
        }
        const dy = dDateA.getFullYear();
        const lock = (y===dy);
        if(lock){ 
            if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Vigencia hasta 31/12/${y}.`; 
            if(fechaEl) fechaEl.disabled=true; if(selEl) selEl.disabled=true; if(btnGuardar) btnGuardar.disabled=true; 
            if(btnNuevo) { btnNuevo.style.display='inline-block'; btnNuevo.style.visibility='visible'; btnNuevo.style.opacity='1'; btnNuevo.style.pointerEvents='auto'; btnNuevo.title='Crear nuevo registro y mover el actual al hist√≥rico'; }
            if(vigencia) { 
                vigencia.style.display='inline'; 
                vigencia.style.color = '#22c55e';
                vigencia.style.fontWeight = '600';
                vigencia.textContent=`‚è∞ Registro v√°lido hasta 31/12/${y} - Pr√≥ximo registro en ${y+1}`; 
            }
        }
        else{ 
            if(st && st.textContent.startsWith('üîí')) st.textContent=''; 
            if(fechaEl) fechaEl.disabled=false; if(selEl) selEl.disabled=false; if(btnGuardar) btnGuardar.disabled=false; 
            if(btnNuevo) btnNuevo.style.display='none'; 
            if(vigencia) vigencia.style.display='none';
        }
    }catch(_e){ box.style.display='none'; }
}
function iniciarNuevoAntiagregantes(){ 
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de Antiagregantes? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('medAntiFecha'); const selEl=document.getElementById('medAntiEn'); const btnGuardar=document.getElementById('medAntiGuardarBtn'); const btnNuevo=document.getElementById('medAntiNuevoBtn'); const vigencia=document.getElementById('medAntiVigencia');
    if(fechaEl){ fechaEl.disabled=false; try{ setFechaConOverlay('medAntiFecha','',{dispatch:true}); }catch(_){ fechaEl.value=''; } } 
    if(selEl){ selEl.disabled=false; selEl.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    if(vigencia) vigencia.style.display='none';
    const st=document.getElementById('medAntiStatus'); 
    if(st) st.textContent='üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}
async function cargarAntiagregantesHistorial(){
    // No cargar historiales si estamos limpiando el formulario
    if (window.LIMPIANDO_FORMULARIO) {
        console.log('üö´ No cargando historial Antiagregantes - formulario en limpieza');
        return;
    }
    
    const run=runRaw(); const cont=document.getElementById('medAntiHist'); const tbody=document.getElementById('medAntiHistBody'); if(!run){ cont.style.display='none'; return; }
    try{ const r=await fetch('/api/medicacion/antiagregantes/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; }
    cont.style.display='block'; tbody.innerHTML=j.data.map(d=>`<tr><td>${formatearFechaEspanol(d.fecha)}</td><td>${d.en_tratamiento? 'S√≠':'No'}</td><td>${formatearFechaEspanol(d.creado_en)}</td></tr>`).join('');
    }catch(_e){ cont.style.display='none'; }
}

async function guardarEstatinas(){
    const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; }
    const fecha=(document.getElementById('medEstatFecha')?.value)||'';
    const en=(document.getElementById('medEstatEn')?.value)||'';
    const st=document.getElementById('medEstatStatus'); if(!en){ st.textContent='Seleccione opci√≥n'; return; }
    if(!fecha){ st.textContent='Ingrese fecha'; return; }
    st.textContent='Guardando...';
    try{ const resp=await fetch('/api/medicacion/estatinas',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha, en_tratamiento: en==='si'})});
        const j=await resp.json(); if(j.success){ st.textContent='Guardado'; await cargarEstatinasUltimo(); await cargarEstatinasHistorial(); } else { st.textContent='Error: '+(j.error||''); }
    }catch(_e){ st.textContent='Error red'; }
}
async function cargarEstatinasUltimo(){
    const run=runRaw(); const box=document.getElementById('medEstatUltimo'); if(!run){ box.style.display='none'; return; }
    try{ const r=await fetch('/api/medicacion/estatinas/'+run); const j=await r.json();
        const fechaEl=document.getElementById('medEstatFecha'); const selEl=document.getElementById('medEstatEn'); const btnGuardar=document.getElementById('medEstatGuardarBtn'); const btnNuevo=document.getElementById('medEstatNuevoBtn'); const st=document.getElementById('medEstatStatus'); const vigencia=document.getElementById('medEstatVigencia');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(vigencia) vigencia.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(selEl) selEl.disabled=false; return; }
    const d=j.data; 
    if(fechaEl){ let iso=''; try{ const dt=new Date(d.fecha); if(!isNaN(dt.getTime())) iso=dt.toISOString().slice(0,10);}catch(_e){} setFechaConOverlay('medEstatFecha', iso || (d.fecha||''), { dispatch: false }); }
        if(selEl) selEl.value=d.en_tratamiento?'si':'no';
        const fechaEsp=formatearFechaEspanol(d.fecha); const creadoEsp=formatearFechaEspanol(d.creado_en);
        box.style.display='block'; box.textContent=`√öltimo: ${fechaEsp} ‚Ä¢ ${d.en_tratamiento? 'S√≠':'No'} ‚Ä¢ ${creadoEsp}`;
        const y=(new Date()).getFullYear();
        let dDateE = new Date(d.fecha);
        if(isNaN(dDateE.getTime()) && /^\d{4}-\d{2}-\d{2}$/.test(String(d.fecha||''))) {
            dDateE = new Date(String(d.fecha||'')+"T00:00:00");
        }
        const dy = dDateE.getFullYear();
        const lock = (y===dy);
        if(lock){ 
            if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Vigencia hasta 31/12/${y}.`; 
            if(fechaEl) fechaEl.disabled=true; if(selEl) selEl.disabled=true; if(btnGuardar) btnGuardar.disabled=true; 
            if(btnNuevo) { btnNuevo.style.display='inline-block'; btnNuevo.style.visibility='visible'; btnNuevo.style.opacity='1'; btnNuevo.style.pointerEvents='auto'; btnNuevo.title='Crear nuevo registro y mover el actual al hist√≥rico'; }
            if(vigencia) { 
                vigencia.style.display='inline'; 
                vigencia.style.color = '#22c55e';
                vigencia.style.fontWeight = '600';
                vigencia.textContent=`‚è∞ Registro v√°lido hasta 31/12/${y} - Pr√≥ximo registro en ${y+1}`; 
            }
        }
        else{ 
            if(st && st.textContent.startsWith('üîí')) st.textContent=''; 
            if(fechaEl) fechaEl.disabled=false; if(selEl) selEl.disabled=false; if(btnGuardar) btnGuardar.disabled=false; 
            if(btnNuevo) btnNuevo.style.display='none'; 
            if(vigencia) vigencia.style.display='none';
        }
    }catch(_e){ box.style.display='none'; }
}
function iniciarNuevoEstatinas(){ 
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de Estatinas? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('medEstatFecha'); const selEl=document.getElementById('medEstatEn'); const btnGuardar=document.getElementById('medEstatGuardarBtn'); const btnNuevo=document.getElementById('medEstatNuevoBtn'); const vigencia=document.getElementById('medEstatVigencia');
    if(fechaEl){ fechaEl.disabled=false; try{ setFechaConOverlay('medEstatFecha','',{dispatch:true}); }catch(_){ fechaEl.value=''; } } 
    if(selEl){ selEl.disabled=false; selEl.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    if(vigencia) vigencia.style.display='none';
    const st=document.getElementById('medEstatStatus'); 
    if(st) st.textContent='üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}
async function cargarEstatinasHistorial(){
    // No cargar historiales si estamos limpiando el formulario
    if (window.LIMPIANDO_FORMULARIO) {
        console.log('üö´ No cargando historial Estatinas - formulario en limpieza');
        return;
    }
    
    const run=runRaw(); const cont=document.getElementById('medEstatHist'); const tbody=document.getElementById('medEstatHistBody'); if(!run){ cont.style.display='none'; return; }
    try{ const r=await fetch('/api/medicacion/estatinas/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; }
    cont.style.display='block'; tbody.innerHTML=j.data.map(d=>`<tr><td>${formatearFechaEspanol(d.fecha)}</td><td>${d.en_tratamiento? 'S√≠':'No'}</td><td>${formatearFechaEspanol(d.creado_en)}</td></tr>`).join('');
    }catch(_e){ cont.style.display='none'; }
}

async function evaluarRiesgoPieDM() {
    const ulceraPieOAmputacion = (document.getElementById('ulceraPieOAmputacion_si')?.checked) === true; // true = S√≠
    const amputacion = (document.getElementById('amputacion_si')?.checked) === true; // true = S√≠
    const sensibilidadProtectora = (document.getElementById('sensibilidadProtectora_si')?.checked) === true; // true = p√©rdida
    const EAP = (document.getElementById('EAP_si')?.checked) === true;
    const DEF = (document.getElementById('DEF_si')?.checked) === true;

    let resultado = "";
    let nivel = ""; // bajo|moderado|alto|maximo
    let proximaEvaluacion = new Date();

    // Riesgo m√°ximo: √∫lcera previa O amputaci√≥n
    if (ulceraPieOAmputacion || amputacion) {
            resultado = 'Riesgo M√°ximo: Educaci√≥n: ü•æ especial, üö® derivar a especialista.';
            nivel = 'maximo';
            proximaEvaluacion.setMonth(proximaEvaluacion.getMonth() + 1);
    } else if (!sensibilidadProtectora && !EAP && !DEF) {
            resultado = 'Riesgo Bajo: Educaci√≥n sobre ü•æ';
            nivel = 'bajo';
            proximaEvaluacion.setFullYear(proximaEvaluacion.getFullYear() + 1);
    } else if (!sensibilidadProtectora && !EAP && DEF) {
            resultado = 'Riesgo Bajo: Educaci√≥n sobre ü•æ';
            nivel = 'bajo';
            proximaEvaluacion.setFullYear(proximaEvaluacion.getFullYear() + 1);
    } else if (sensibilidadProtectora && !EAP && !DEF) {
            resultado = 'Riesgo Moderado: Educaci√≥n Autocuidado y ü•æ';
            nivel = 'moderado';
            proximaEvaluacion.setMonth(proximaEvaluacion.getMonth() + 6);
    } else if (EAP || (sensibilidadProtectora && (EAP || DEF))) {
            resultado = 'Riesgo Alto: Educaci√≥n Uso ü•æ especial. üëÄ Evaluar derivaci√≥n a especialista';
            nivel = 'alto';
            proximaEvaluacion.setMonth(proximaEvaluacion.getMonth() + 3);
    }

    const hoyRef = new Date();
    const msDiff = proximaEvaluacion.getTime() - hoyRef.setHours(0,0,0,0);
    const diasRestantes = Math.round(msDiff / 86400000);
    const etiquetaDias = diasRestantes < 0 ? ` (Vencido hace ${Math.abs(diasRestantes)}d)` : diasRestantes === 0 ? ' (Hoy)' : ` (en ${diasRestantes}d)`;

    resultado += ' Fecha de pr√≥xima evaluaci√≥n: ' + formatearFechaEspanol(proximaEvaluacion) + etiquetaDias;
    const resultadoDiv = document.getElementById('resultadoPieDM');
    resultadoDiv.className = 'piedm-result-box nivel-' + nivel; // reset + nivel
    // A√±adir title al badge de nivel
    let badgeTitle = '';
    if (nivel === 'bajo') badgeTitle = 'Riesgo Bajo: Sin p√©rdida de sensibilidad, sin EAP';
    else if (nivel === 'moderado') badgeTitle = 'Riesgo Moderado: P√©rdida de sensibilidad aislada';
    else if (nivel === 'alto') badgeTitle = 'Riesgo Alto: EAP o combinaci√≥n p√©rdida + deformidad';
    else if (nivel === 'maximo') badgeTitle = 'Riesgo M√°ximo: √ölcera activa, amputaci√≥n previa o amputaci√≥n';
    resultadoDiv.innerHTML = `<span class="piedm-badge" title="${badgeTitle}">${nivel.toUpperCase()}</span>` + resultado;
    resultadoDiv.dataset.nivel = nivel;
    resultadoDiv.style.display = 'block';
    // Actualizar resumen con nivel y pr√≥xima evaluaci√≥n + d√≠as
    const proxISO = proximaEvaluacion.toISOString().slice(0,10);
    updatePieDmHeaderSummary(nivel, proxISO, diasRestantes);

    const fechasDiv = document.getElementById('fechasPieDM');
    const hoy = new Date();
    fechasDiv.textContent = 'Realizaci√≥n: ' + formatearFechaEspanol(hoy) + ' | Pr√≥xima: ' + formatearFechaEspanol(proximaEvaluacion) + etiquetaDias;
    fechasDiv.dataset.proxima = proxISO;
    fechasDiv.dataset.realizacion = hoy.toISOString().slice(0,10);

    // Auto-guardar desactivado - ahora se requiere bot√≥n manual
    // await guardarEvaluacionPieDM(true);
}

function limpiarFormularioPieDM() {
    // reset radios a "No"
    const idsNo = ['ulceraPieOAmputacion_no','amputacion_no','sensibilidadProtectora_no','EAP_no','DEF_no'];
    idsNo.forEach(id=>{ const el=document.getElementById(id); if(el) el.checked=true; });
    const res = document.getElementById('resultadoPieDM');
    res.textContent=''; res.style.display='none'; res.dataset.nivel=''; res.className='piedm-result-box';
    document.getElementById('fechasPieDM').textContent='';
    // bot√≥n manual eliminado
    document.getElementById('statusGuardarPieDM').textContent='';
}

async function guardarEvaluacionPieDM(auto=false) {
    const runInput = document.querySelector('input[name="run"]');
    if (!runInput || !runInput.value.trim()) { 
        if(!auto) alert('Ingrese RUN antes de guardar.'); 
        return; 
    }
    
    // Validar que se haya ingresado una fecha manualmente
    const fechaRealInput = document.getElementById('pieDmFechaReal');
    const fechaReal = fechaRealInput?.value;
    
    if (!fechaReal) {
        alert('‚ö†Ô∏è Debe ingresar una fecha de evaluaci√≥n manualmente antes de guardar.');
        fechaRealInput?.focus();
        return;
    }
    
    // Validar formato de fecha dd/mm/aaaa
    const formatoFecha = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!formatoFecha.test(fechaReal)) {
        alert('‚ö†Ô∏è La fecha debe tener el formato dd/mm/aaaa (ejemplo: 18/09/2025)');
        fechaRealInput?.focus();
        return;
    }
    
    // Validar que la fecha sea v√°lida
    const [dia, mes, a√±o] = fechaReal.split('/').map(num => parseInt(num));
    const fechaObj = new Date(a√±o, mes - 1, dia);
    if (fechaObj.getDate() !== dia || fechaObj.getMonth() !== mes - 1 || fechaObj.getFullYear() !== a√±o) {
        alert('‚ö†Ô∏è La fecha ingresada no es v√°lida. Verifique d√≠a, mes y a√±o.');
        fechaRealInput?.focus();
        return;
    }
    
    const nivel = document.getElementById('resultadoPieDM').dataset.nivel;
    if (!nivel) {
        alert('‚ö†Ô∏è Debe calcular el riesgo antes de guardar.');
        return;
    }
    
    const fechasDiv = document.getElementById('fechasPieDM');
    const prox = fechasDiv.dataset.proxima;
    const recomendacion = document.getElementById('resultadoPieDM').textContent;
    
    // Preparar payload
    const payload = {
        run: runInput.value.trim(),
        ulcera_o_amputacion: (document.getElementById('ulceraPieOAmputacion_si')?.checked) === true,
        amputacion: (document.getElementById('amputacion_si')?.checked) === true,
        fecha_amputacion: (() => {
            if (!(document.getElementById('amputacion_si')?.checked)) return null;
            const fecha = document.getElementById('fechaAmputacion')?.value || '';
            if (!fecha) return null;
            // Convertir de dd/mm/aaaa a yyyy-mm-dd
            if (fecha.includes('/')) {
                const partes = fecha.split('/');
                if (partes.length === 3) {
                    return `${partes[2]}-${partes[1].padStart(2,'0')}-${partes[0].padStart(2,'0')}`;
                }
            }
            return fecha;
        })(),
        sensibilidad_protectora: (document.getElementById('sensibilidadProtectora_si')?.checked) === true,
        eap: (document.getElementById('EAP_si')?.checked) === true,
        deformidad: (document.getElementById('DEF_si')?.checked) === true,
        fecha_realizacion: fechaReal
    };
    
    if (nivel) payload.riesgo_nivel = nivel;
    if (recomendacion) payload.recomendacion = recomendacion;
    if (prox) payload.proxima_evaluacion = prox;
    
    const statusDiv = document.getElementById('statusGuardarPieDM');
    statusDiv.textContent = 'Guardando evaluaci√≥n...';
    
    try {
        const resp = await fetch('/api/examenes/pie_dm', {
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify(payload)
        });
        const data = await resp.json();
        
        if (data.success) {
            statusDiv.textContent = '‚úÖ Evaluaci√≥n guardada correctamente (ID ' + data.id + ')';
            
            // **NUEVO COMPORTAMIENTO**: Si amputaci√≥n es "S√≠", hacer campos permanentes
            const amputacionSi = document.getElementById('amputacion_si');
            if (amputacionSi && amputacionSi.checked) {
                aplicarPermanenciaAmputacion();
            }
            
            // **NUEVO COMPORTAMIENTO**: Mover evaluaci√≥n actual al historial
            moverEvaluacionActualAHistorial();
            
            // **NUEVO COMPORTAMIENTO**: Bloquear fecha despu√©s de guardar
            bloquearFechaEvaluacion(fechaReal);
            
            // Recargar datos (manteniendo compatibilidad)
            cargarUltimaEvaluacionPieDM(runInput.value.trim());
            cargarTratamientoInsulinaDebounced(runInput.value.trim(), 500);
            cargarHipoglicemiasUltimo();
            cargarHistorialPieDM(runInput.value.trim());
            cargarPieDmUltimo();
            
            console.log('‚úÖ Evaluaci√≥n guardada y procesada correctamente');
        } else {
            statusDiv.textContent = '‚ùå Error: ' + (data.error || 'desconocido');
        }
    } catch(err) {
        statusDiv.textContent = '‚ùå Error de red: ' + err;
        console.error('Error guardando evaluaci√≥n:', err);
    }
}

async function cargarUltimaEvaluacionPieDM(run) {
    if (!run) { return; }
    const div = document.getElementById('ultimaEvaluacionPieDM');
    if (!div) return;
    div.innerHTML = '<em>Cargando √∫ltima evaluaci√≥n...</em>';
    try {
        const resp = await fetch('/api/examenes/pie_dm/' + encodeURIComponent(run));
        const data = await resp.json();
        if (data.success && data.found) {
            const d = data.data;
            div.innerHTML = '<strong>√öltima:</strong> ' + d.fecha_realizacion + ' | Riesgo: ' + d.riesgo_nivel.toUpperCase() + ' | Pr√≥xima: ' + d.proxima_evaluacion + '<br>' +
                '<small>' + d.recomendacion + '</small>';
            // Renderizar resultado y fechas en el panel con la info cargada
            try {
                const nivel = (d.riesgo_nivel || '').toLowerCase();
                const resultadoDiv = document.getElementById('resultadoPieDM');
                const fechasDiv = document.getElementById('fechasPieDM');
                const fechaInput = document.getElementById('pieDmFechaReal');
                if (resultadoDiv && fechasDiv && nivel) {
                    // Preparar badge y clases
                    resultadoDiv.className = 'piedm-result-box nivel-' + nivel;
                    let badgeTitle = '';
                    if (nivel === 'bajo') badgeTitle = 'Riesgo Bajo: Sin p√©rdida de sensibilidad, sin EAP';
                    else if (nivel === 'moderado') badgeTitle = 'Riesgo Moderado: P√©rdida de sensibilidad aislada';
                    else if (nivel === 'alto') badgeTitle = 'Riesgo Alto: EAP o combinaci√≥n p√©rdida + deformidad';
                    else if (nivel === 'maximo') badgeTitle = 'Riesgo M√°ximo: √ölcera activa o amputaci√≥n previa';

                    // Usar recomendaci√≥n guardada (ya incluye texto) y a√±adir el badge
                    const rec = d.recomendacion || '';
                    resultadoDiv.innerHTML = `<span class="piedm-badge" title="${badgeTitle}">${nivel.toUpperCase()}</span>` + rec;
                    resultadoDiv.dataset.nivel = nivel;
                    resultadoDiv.style.display = 'block';

                    // Calcular d√≠as restantes respecto a hoy para el header
                    let diasRestantes;
                    try {
                        if (d.proxima_evaluacion) {
                            const today = new Date(); today.setHours(0,0,0,0);
                            const prox = new Date(d.proxima_evaluacion + 'T00:00:00');
                            diasRestantes = Math.round((prox.getTime() - today.getTime()) / 86400000);
                        }
                    } catch(_){}
                    updatePieDmHeaderSummary(nivel, d.proxima_evaluacion, diasRestantes);

                    // Mostrar fechas y setear datasets para permitir re-guardar
                    const etiquetaDias = typeof diasRestantes === 'number' ? (diasRestantes < 0 ? ` (Vencido hace ${Math.abs(diasRestantes)}d)` : diasRestantes === 0 ? ' (Hoy)' : ` (en ${diasRestantes}d)`) : '';
                    fechasDiv.textContent = 'Realizaci√≥n: ' + (d.fecha_realizacion || '') + ' | Pr√≥xima: ' + (d.proxima_evaluacion || '') + etiquetaDias;
                    fechasDiv.dataset.proxima = d.proxima_evaluacion || '';
                    fechasDiv.dataset.realizacion = d.fecha_realizacion || '';
                    if (fechaInput) fechaInput.value = d.fecha_realizacion || '';
                } else {
                    updatePieDmHeaderSummary(d.riesgo_nivel, d.proxima_evaluacion);
                }
            } catch(_) {
                updatePieDmHeaderSummary(d.riesgo_nivel, d.proxima_evaluacion);
            }
            // Pre-cargar toggles
            setTimeout(()=>{
                try {
                    // Mapeo directo para campos boolean
                    const boolFields = [
                        ['ulceraPieOAmputacion', 'ulcera_o_amputacion'],
                        ['amputacion', 'amputacion'],
                        ['sensibilidadProtectora', 'sensibilidad_protectora'],
                        ['EAP', 'eap'],
                        ['DEF', 'deformidad'],
                        ['tratamientoInsulina', 'tratamiento_insulina']
                    ];
                    
                    boolFields.forEach(([prefix, dbField]) => {
                        const valor = d[dbField];
                        const siRadio = document.getElementById(prefix + '_si');
                        const noRadio = document.getElementById(prefix + '_no');
                        
                        if (valor === true && siRadio) {
                            siRadio.checked = true;
                        } else if (valor === false && noRadio) {
                            noRadio.checked = true;
                        }
                    });
                    
                    // Cargar fecha de amputaci√≥n si existe y aplicar permanencia
                    if (d.fecha_amputacion) {
                        const fechaAmputacionInput = document.getElementById('fechaAmputacion');
                        if (fechaAmputacionInput) {
                            fechaAmputacionInput.value = formatearFechaDMY(d.fecha_amputacion);
                        }
                    }
                    
                    // Si amputaci√≥n es "S√≠", hacer los campos permanentes (no editables)
                    if (d.amputacion === true) {
                        const amputacionSiRadio = document.getElementById('amputacion_si');
                        const amputacionNoRadio = document.getElementById('amputacion_no');
                        const fechaAmputacionInput = document.getElementById('fechaAmputacion');
                        const fechaAmputacionContainer = document.getElementById('fechaAmputacionContainer');
                        
                        if (amputacionSiRadio) {
                            amputacionSiRadio.disabled = true;
                            amputacionSiRadio.title = 'Campo permanente - no se puede modificar';
                        }
                        if (amputacionNoRadio) {
                            amputacionNoRadio.disabled = true;
                            amputacionNoRadio.title = 'Campo permanente - no se puede modificar';
                        }
                        if (fechaAmputacionInput) {
                            fechaAmputacionInput.disabled = true;
                            fechaAmputacionInput.title = 'Campo permanente - no se puede modificar';
                            fechaAmputacionInput.style.backgroundColor = '#f5f5f5';
                        }
                        if (fechaAmputacionContainer) {
                            fechaAmputacionContainer.style.opacity = '0.7';
                        }
                    }
                } catch(_e){
                    console.log('Error cargando campos:', _e);
                }
            }, 120);
        } else if (data.success) {
            div.innerHTML = '<em>Sin registros previos.</em>';
        } else {
            div.innerHTML = 'Error: ' + (data.error || 'desconocido');
        }
        if(data.success) cargarHistorialPieDM(run);
    } catch(err) {
        div.textContent = 'Error cargando: ' + err;
    }
}

// Cargar √∫ltima evaluaci√≥n cuando se detecta RUN v√°lido ya cargado
document.addEventListener('DOMContentLoaded', () => {
    const runInput = document.querySelector('input[name="run"]');
    
    // Configurar campo de fecha manual para evaluaci√≥n Pie DM
    try { 
        const f = document.getElementById('pieDmFechaReal'); 
        if(f) { 
            f.placeholder = 'dd/mm/aaaa'; 
            // Agregar validaci√≥n de formato en tiempo real
            f.addEventListener('input', function(e) {
                let valor = e.target.value;
                // Remover caracteres no num√©ricos excepto /
                valor = valor.replace(/[^0-9\/]/g, '');
                // Formatear autom√°ticamente
                if (valor.length >= 2 && valor.charAt(2) !== '/') {
                    valor = valor.substring(0, 2) + '/' + valor.substring(2);
                }
                if (valor.length >= 5 && valor.charAt(5) !== '/') {
                    valor = valor.substring(0, 5) + '/' + valor.substring(5);
                }
                // Limitar a 10 caracteres (dd/mm/aaaa)
                if (valor.length > 10) {
                    valor = valor.substring(0, 10);
                }
                e.target.value = valor;
            });
        } 
    } catch(_) { }
    // Inicializar persistencia de radios (escucha de cambios)
    try { initRadioPersistence(); } catch(_) {}
    if (runInput && runInput.value.trim()) {
        const rvInit = runInput.value.trim().replace(/[^0-9kK]/g,'');
        // Hidratar radios persistidos primero y luego cargar √∫ltimo registro
        setTimeout(() => applyPersistedRadios(rvInit), 600);
        setTimeout(() => cargarUltimaEvaluacionPieDM(runInput.value.trim()), 800);
        setTimeout(() => cargarTratamientoInsulinaDebounced(runInput.value.trim(), 50), 850);
        setTimeout(() => cargarHipoglicemiasUltimo(), 875);
        setTimeout(() => cargarPieDmUltimo(), 900);
    }
    // Evaluar visibilidad inicial seg√∫n patolog√≠as ya cargadas
    setTimeout(updatePieDmVisibility, 600);
    // Visibilidad inicial de Medicaci√≥n (seg√∫n HTA/DM/Renal)
    setTimeout(()=>{ try { updateMedicacionVisibility(); } catch(e){} }, 700);
    // Precargar campos de diabetes (insulina / fondo de ojos)
    setTimeout(()=>{
        const rv = runInput && runInput.value && runInput.value.trim();
        if(rv) {
            const runLimpio = rv.replace(/[^0-9kK]/gi, '');
            if (runLimpio.length >= 8 && dvValido(normalizarRun(rv))) {
                preloadDiabetesExamFields(rv);
            } else {
                console.log('‚è≥ RUN incompleto, omitiendo preload diabetes inicial');
            }
        }
    }, 900);
});

// Historial Pie DM
async function cargarHistorialPieDM(run){
    const cont = document.getElementById('historialPieDM');
    const tbody = document.getElementById('historialPieDMTbody');
    if(!cont || !tbody) return;
    if(!run){ cont.style.display='none'; return; }
    try {
        const resp = await fetch('/api/examenes/pie_dm/historial/' + encodeURIComponent(run));
        const data = await resp.json();
        if(!data.success){ cont.style.display='none'; return; }
        const rows = data.data || [];
        if(rows.length===0){
            tbody.innerHTML = '<tr><td colspan="5" style="padding:6px 8px; border:1px solid #e2e8f0; text-align:center; color:#64748b;">Sin datos</td></tr>';
            cont.style.display='none';
            return;
        }
        cont.style.display='block';
        tbody.innerHTML = rows.map(r=>{
            const nivel = (r.riesgo_nivel||'').toUpperCase();
            return `<tr>
                <td style="padding:4px 6px; border:1px solid #e2e8f0;">${r.fecha_realizacion||''}</td>
                <td style="padding:4px 6px; border:1px solid #e2e8f0; font-weight:600;">${nivel}</td>
                <td style="padding:4px 6px; border:1px solid #e2e8f0;">${r.proxima_evaluacion||''}</td>
                <td style="padding:4px 6px; border:1px solid #e2e8f0;">${(r.creado_en||'').replace('T',' ').slice(0,10)}</td>
                <td style="padding:4px 6px; border:1px solid #e2e8f0;">${r.id}</td>
            </tr>`;}).join('');
    } catch(err){
        cont.style.display='none';
    }
}

// ===== NUEVAS FUNCIONES PARA BOT√ìN NUEVO Y HISTORIAL PIE DM =====

// Cargar √∫ltimo registro de Pie DM y mostrar bot√≥n "Nuevo"
async function cargarPieDmUltimo() {
    const runInput = document.querySelector('input[name="run"]');
    if (!runInput || !runInput.value.trim()) return;
    
    const run = runInput.value.trim();
    const ultimoDiv = document.getElementById('pieDmUltimo');
    const btnNuevo = document.getElementById('pieDmNuevoBtn');
    const status = document.getElementById('pieDmStatus');
    
    try {
        const resp = await fetch('/api/examenes/pie_dm/' + encodeURIComponent(run));
        const data = await resp.json();
        
        if (data.success && data.found) {
            const d = data.data;
            if (ultimoDiv) {
                // Convertir fechas a formato espa√±ol
                const fechaRealizacion = formatearFechaEspanol(new Date(d.fecha_realizacion));
                const fechaProxima = new Date(d.proxima_evaluacion);
                const fechaProximaEsp = formatearFechaEspanol(fechaProxima);
                
                // Calcular d√≠as hasta pr√≥xima evaluaci√≥n
                const hoy = new Date();
                hoy.setHours(0,0,0,0);
                const msDiff = fechaProxima.getTime() - hoy.getTime();
                const diasRestantes = Math.round(msDiff / 86400000);
                
                let etiquetaDias = '';
                if (diasRestantes < 0) {
                    etiquetaDias = ` (Vencido hace ${Math.abs(diasRestantes)} d√≠as)`;
                } else if (diasRestantes === 0) {
                    etiquetaDias = ' (Hoy)';
                } else {
                    etiquetaDias = ` (en ${diasRestantes} d√≠as)`;
                }
                
                ultimoDiv.innerHTML = `<strong>√öltimo registro:</strong> ${fechaRealizacion} | Riesgo: ${d.riesgo_nivel.toUpperCase()} | Pr√≥xima: ${fechaProximaEsp}${etiquetaDias}`;
                ultimoDiv.style.display = 'block';
            }
            if (btnNuevo) btnNuevo.style.display = 'inline-block';
            if (status) status.textContent = 'Datos cargados';
            
            // Fijar fecha del √∫ltimo registro
            const fechaInput = document.getElementById('pieDmFechaReal');
            if (fechaInput) {
                fechaInput.value = d.fecha_realizacion || '';
                fechaInput.setAttribute('readonly', true);
                fechaInput.style.background = '#f1f5f9';
            }
        } else {
            if (ultimoDiv) ultimoDiv.style.display = 'none';
            if (btnNuevo) btnNuevo.style.display = 'none';
            if (status) status.textContent = 'Sin registros previos';
        }
        
        // Cargar historial
        await cargarPieDmHistorial();
        
    } catch (err) {
        if (status) status.textContent = 'Error cargando datos';
        console.error('Error cargando pie dm √∫ltimo:', err);
    }
}

// Cargar historial de evaluaciones de Pie DM
async function cargarPieDmHistorial() {
    const runInput = document.querySelector('input[name="run"]');
    if (!runInput || !runInput.value.trim()) return;
    
    const run = runInput.value.trim();
    const histDiv = document.getElementById('pieDmHist');
    const tbody = document.getElementById('pieDmHistBody');
    
    if (!histDiv || !tbody) return;
    
    try {
        const resp = await fetch('/api/examenes/pie_dm/historial/' + encodeURIComponent(run));
        const data = await resp.json();
        
        if (!data.success || !data.data || data.data.length === 0) {
            histDiv.style.display = 'none';
            return;
        }
        
        const rows = data.data;
        tbody.innerHTML = rows.map(r => {
            const ulcera = r.ulcera_o_amputacion ? 'S√≠' : 'No';
            const amputacion = r.amputacion ? 'S√≠' : 'No';
            const sens = r.sensibilidad_protectora ? 'S√≠' : 'No';
            const eap = r.eap ? 'S√≠' : 'No';
            const def = r.deformidad ? 'S√≠' : 'No';
            const ins = r.tratamiento_insulina ? 'S√≠' : 'No';
            const riesgo = (r.riesgo_nivel || '').toUpperCase();
            const registro = (r.creado_en || '').slice(0, 10);
            
            return `<tr>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${r.fecha_realizacion || ''}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center;">${ulcera}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center; color:${r.amputacion ? '#dc2626' : '#059669'}; font-weight:${r.amputacion ? '600' : 'normal'};">${amputacion}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center;">${sens}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center;">${eap}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center;">${def}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center;">${ins}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; font-weight:600; color:#${riesgo === 'BAJO' ? '059669' : riesgo === 'MODERADO' ? 'f59e0b' : riesgo === 'ALTO' ? 'ea580c' : 'dc2626'};">${riesgo}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${registro}</td>
            </tr>`;
        }).join('');
        
        histDiv.style.display = 'block';
        
    } catch (err) {
        console.error('Error cargando historial pie dm:', err);
        histDiv.style.display = 'none';
    }
}

// Funci√≥n para iniciar nuevo registro de Pie DM
function iniciarNuevoPieDM() {
    console.log('üÜï Iniciando nueva evaluaci√≥n Pie DM');
    
    // Guardar evaluaci√≥n actual antes de limpiar (si existe)
    const fechaActual = document.getElementById('pieDmFechaReal')?.value;
    const nivelActual = document.getElementById('resultadoPieDM')?.dataset?.nivel;
    
    if (fechaActual && nivelActual) {
        console.log('üíæ Guardando evaluaci√≥n actual antes de crear nueva');
        // Mover evaluaci√≥n actual al historial
        moverEvaluacionActualAHistorial();
    }
    
    // Limpiar formulario completamente
    limpiarFormularioPieDM();
    
    // Desbloquear fecha para entrada manual
    const fechaInput = document.getElementById('pieDmFechaReal');
    if (fechaInput) {
        fechaInput.value = '';
        fechaInput.removeAttribute('readonly');
        fechaInput.style.background = '#ffffff';
        fechaInput.style.borderColor = '#cbd5e1';
        fechaInput.focus(); // Enfocar para que el usuario ingrese la fecha
    }
    
    // Actualizar estados de UI
    const ultimoDiv = document.getElementById('pieDmUltimo');
    const btnNuevo = document.getElementById('pieDmNuevoBtn');
    const status = document.getElementById('pieDmStatus');
    
    if (ultimoDiv) ultimoDiv.style.display = 'none';
    if (btnNuevo) {
        btnNuevo.style.display = 'none'; // Se ocultar√° hasta guardar
    }
    if (status) status.textContent = 'Nueva evaluaci√≥n - ingrese fecha manualmente';
    
    // Limpiar resultado
    const resultadoDiv = document.getElementById('resultadoPieDM');
    if (resultadoDiv) {
        resultadoDiv.textContent = '';
        resultadoDiv.style.display = 'none';
        delete resultadoDiv.dataset.nivel;
    }
}

// Funci√≥n para mover evaluaci√≥n actual al historial
function moverEvaluacionActualAHistorial() {
    const fecha = document.getElementById('pieDmFechaReal')?.value;
    const nivel = document.getElementById('resultadoPieDM')?.dataset?.nivel;
    const recomendacion = document.getElementById('resultadoPieDM')?.textContent;
    
    if (!fecha || !nivel) return;
    
    console.log('üìù Moviendo evaluaci√≥n al historial:', {fecha, nivel, recomendacion});
    
    // Capturar valores del formulario
    const evaluacion = {
        fecha: fecha,
        nivel: nivel,
        recomendacion: recomendacion,
        ulcera: document.getElementById('ulceraPieOAmputacion_si')?.checked ? 'S√≠' : 'No',
        amputacion: document.getElementById('amputacion_si')?.checked ? 'S√≠' : 'No',
        sensibilidad: document.getElementById('sensibilidadProtectora_si')?.checked ? 'S√≠' : 'No',
        eap: document.getElementById('EAP_si')?.checked ? 'S√≠' : 'No',
        deformidad: document.getElementById('DEF_si')?.checked ? 'S√≠' : 'No',
        insulina: document.getElementById('tratamientoInsulina_si')?.checked ? 'S√≠' : 'No'
    };
    
    // Agregar al historial visual
    agregarAHistorialPieDM(evaluacion);
}

// Funci√≥n para agregar evaluaci√≥n al historial visual
function agregarAHistorialPieDM(evaluacion) {
    const historialDiv = document.getElementById('pieDmHistorial');
    const historialContent = document.getElementById('pieDmHistorialContent');
    
    if (!historialDiv || !historialContent) return;
    
    // Mostrar el historial si estaba oculto
    historialDiv.style.display = 'block';
    
    // Limpiar mensaje de "no hay evaluaciones"
    if (historialContent.innerHTML.includes('No hay evaluaciones previas')) {
        historialContent.innerHTML = '';
    }
    
    // Crear elemento de historial
    const fechaFormateada = new Date(evaluacion.fecha + 'T00:00:00').toLocaleDateString('es-CL');
    const item = document.createElement('div');
    item.style.cssText = 'border:1px solid #e5e7eb; border-radius:6px; padding:8px; margin-bottom:6px; background:#ffffff; font-size:11px;';
    
    // Definir color seg√∫n nivel de riesgo
    let colorNivel = '#64748b';
    if (evaluacion.nivel === 'ALTO') colorNivel = '#dc2626';
    else if (evaluacion.nivel === 'MEDIO') colorNivel = '#ea580c';
    else if (evaluacion.nivel === 'BAJO') colorNivel = '#16a34a';
    
    item.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <strong style="color:#1f2937;">${fechaFormateada}</strong>
            <span style="background:${colorNivel}; color:white; padding:2px 6px; border-radius:4px; font-size:10px; font-weight:bold;">
                RIESGO ${evaluacion.nivel}
            </span>
        </div>
        <div style="color:#4b5563; margin-bottom:4px;">
            <strong>Recomendaci√≥n:</strong> ${evaluacion.recomendacion || 'No especificada'}
        </div>
        <div style="display:grid; grid-template-columns:repeat(5,1fr); gap:4px; font-size:10px; color:#6b7280;">
            <span><strong>√ölcera:</strong> ${evaluacion.ulcera}</span>
            <span><strong>Sensib:</strong> ${evaluacion.sensibilidad}</span>
            <span><strong>EAP:</strong> ${evaluacion.eap}</span>
            <span><strong>Deform:</strong> ${evaluacion.deformidad}</span>
            <span><strong>Insulina:</strong> ${evaluacion.insulina}</span>
        </div>
    `;
    
    // Insertar al principio del historial (m√°s reciente arriba)
    historialContent.insertBefore(item, historialContent.firstChild);
    
    console.log('‚úÖ Evaluaci√≥n agregada al historial');
}

// Funci√≥n para bloquear fecha despu√©s de guardar
function bloquearFechaEvaluacion(fecha) {
    const fechaInput = document.getElementById('pieDmFechaReal');
    const btnNuevo = document.getElementById('pieDmNuevoBtn');
    const status = document.getElementById('pieDmStatus');
    
    if (fechaInput) {
        fechaInput.setAttribute('readonly', 'readonly');
        fechaInput.style.background = '#f1f5f9';
        fechaInput.style.borderColor = '#94a3b8';
        fechaInput.value = fecha;
    }
    
    if (btnNuevo) {
        btnNuevo.style.display = 'inline-block'; // Mostrar bot√≥n "Nuevo"
    }
    
    if (status) {
        const fechaFormateada = new Date(fecha + 'T00:00:00').toLocaleDateString('es-CL');
        status.textContent = `Evaluaci√≥n fija del ${fechaFormateada}`;
    }
    
    console.log('üîí Fecha bloqueada:', fecha);
}

// Funci√≥n para aplicar permanencia a campos de amputaci√≥n
function aplicarPermanenciaAmputacion() {
    console.log('üîí Aplicando permanencia a campos de amputaci√≥n');
    
    const amputacionSiRadio = document.getElementById('amputacion_si');
    const amputacionNoRadio = document.getElementById('amputacion_no');
    const fechaAmputacionInput = document.getElementById('fecha_amputacion');
    const fechaAmputacionContainer = document.getElementById('fechaAmputacionContainer');
    
    if (amputacionSiRadio) {
        amputacionSiRadio.disabled = true;
        amputacionSiRadio.title = 'Campo permanente - no se puede modificar una vez guardado';
        amputacionSiRadio.style.cursor = 'not-allowed';
    }
    
    if (amputacionNoRadio) {
        amputacionNoRadio.disabled = true;
        amputacionNoRadio.title = 'Campo permanente - no se puede modificar una vez guardado';
        amputacionNoRadio.style.cursor = 'not-allowed';
    }
    
    if (fechaAmputacionInput) {
        fechaAmputacionInput.disabled = true;
        fechaAmputacionInput.title = 'Campo permanente - no se puede modificar una vez guardado';
        fechaAmputacionInput.style.backgroundColor = '#f5f5f5';
        fechaAmputacionInput.style.borderColor = '#d1d5db';
        fechaAmputacionInput.style.cursor = 'not-allowed';
    }
    
    if (fechaAmputacionContainer) {
        fechaAmputacionContainer.style.opacity = '0.7';
        // Agregar indicador visual de permanencia
        const existingLabel = fechaAmputacionContainer.querySelector('.permanent-label');
        if (!existingLabel) {
            const label = document.createElement('small');
            label.className = 'permanent-label';
            label.style.color = '#dc2626';
            label.style.fontWeight = 'bold';
            label.style.display = 'block';
            label.style.marginTop = '4px';
            label.textContent = 'üîí Campos permanentes - no editables';
            fechaAmputacionContainer.appendChild(label);
        }
    }
    
    console.log('‚úÖ Permanencia aplicada correctamente a campos de amputaci√≥n');
}

// ===== FIN NUEVAS FUNCIONES PIE DM =====

// ===== NUEVAS FUNCIONES TRATAMIENTO INSULINA =====

async function guardarTratamientoInsulina(auto=false) {
    const runInput = document.querySelector('input[name="run"]');
    if (!runInput || !runInput.value.trim()) { 
        if(!auto) alert('Ingrese RUN antes de guardar.'); 
        return; 
    }
    
    // Validar que se haya ingresado una fecha manualmente
    const fechaRealInput = document.getElementById('insulinaFechaReal');
    const fechaReal = fechaRealInput?.value;
    
    if (!fechaReal) {
        alert('‚ö†Ô∏è Debe ingresar una fecha de evaluaci√≥n manualmente antes de guardar.');
        fechaRealInput?.focus();
        return;
    }
    
    // Validar formato de fecha dd/mm/aaaa
    const formatoFecha = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!formatoFecha.test(fechaReal)) {
        alert('‚ö†Ô∏è La fecha debe tener el formato dd/mm/aaaa (ejemplo: 18/09/2025)');
        fechaRealInput?.focus();
        return;
    }
    
    // Validar que la fecha sea v√°lida
    const [dia, mes, a√±o] = fechaReal.split('/').map(num => parseInt(num));
    const fechaObj = new Date(a√±o, mes - 1, dia);
    if (fechaObj.getDate() !== dia || fechaObj.getMonth() !== mes - 1 || fechaObj.getFullYear() !== a√±o) {
        alert('‚ö†Ô∏è La fecha ingresada no es v√°lida. Verifique d√≠a, mes y a√±o.');
        fechaRealInput?.focus();
        return;
    }
    
    const enTratamiento = document.getElementById('tratamientoInsulina_si')?.checked === true;
    
    try {
        // Mover evaluaci√≥n actual al historial
        await moverEvaluacionInsulinaAHistorial();
        
        // Preparar payload con fecha en formato ISO
        const fechaISO = `${a√±o}-${mes.toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
        const payload = {
            run: runInput.value.trim(),
            fecha_evaluacion: fechaISO,
            en_tratamiento: enTratamiento,
            fecha_realizacion: fechaISO
        };
        
        const response = await fetch('/api/examenes/tratamiento_insulina', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Bloquear fecha despu√©s de guardar exitoso
            bloquearFechaInsulinaTratamiento(fechaReal);
            
            // Agregar al historial visual
            const tratamientoTexto = enTratamiento ? 'S√≠' : 'No';
            agregarAHistorialInsulina({
                fecha: fechaReal,
                tratamiento: tratamientoTexto,
                creado_en: new Date().toLocaleString('es-CL')
            });
            
            if(!auto) alert('‚úÖ Tratamiento con insulina guardado correctamente');
            
            // Actualizar estado
            const status = document.getElementById('insulinaStatus');
            if (status) status.textContent = 'Datos guardados';
            
        } else {
            throw new Error(result.message || 'Error al guardar');
        }
        
    } catch (error) {
        console.error('Error guardando tratamiento insulina:', error);
        if(!auto) alert('‚ùå Error guardando datos de tratamiento con insulina: ' + error.message);
    }
}

function iniciarNuevoTratamientoInsulina() {
    // Desbloquear campo de fecha
    const fechaInput = document.getElementById('insulinaFechaReal');
    const btnNuevo = document.getElementById('insulinaNuevoBtn');
    const status = document.getElementById('insulinaStatus');
    
    if (fechaInput) {
        fechaInput.removeAttribute('readonly');
        fechaInput.style.background = '';
        fechaInput.style.borderColor = '';
        fechaInput.value = '';
        fechaInput.focus();
    }
    
    // Limpiar selecciones
    const radioNo = document.getElementById('tratamientoInsulina_no');
    if (radioNo) radioNo.checked = true;
    
    if (btnNuevo) {
        btnNuevo.style.display = 'none';
    }
    
    if (status) {
        status.textContent = 'Nueva evaluaci√≥n';
    }
    
    console.log('üÜï Iniciando nueva evaluaci√≥n de tratamiento con insulina');
}

async function moverEvaluacionInsulinaAHistorial() {
    // Buscar evaluaci√≥n actual
    const fechaInput = document.getElementById('insulinaFechaReal');
    const siRadio = document.getElementById('tratamientoInsulina_si');
    
    if (fechaInput?.value && (siRadio?.checked || document.getElementById('tratamientoInsulina_no')?.checked)) {
        const tratamiento = siRadio?.checked ? 'S√≠' : 'No';
        
        // Agregar al historial
        agregarAHistorialInsulina({
            fecha: fechaInput.value,
            tratamiento: tratamiento,
            creado_en: new Date().toLocaleString('es-CL')
        });
    }
}

function agregarAHistorialInsulina(evaluacion) {
    const historialDiv = document.getElementById('insulinaHistorial');
    const entriesDiv = document.getElementById('insulinaHistorialEntries');
    
    if (historialDiv && entriesDiv) {
        historialDiv.style.display = 'block';
        
        const entryHTML = `
            <div style="background:white; border:1px solid #e5e7eb; border-radius:4px; padding:6px; margin-bottom:4px; font-size:9px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:600; color:#1f2937;">üìÖ ${evaluacion.fecha}</span>
                    <span style="color:#6b7280;">Tratamiento: ${evaluacion.tratamiento}</span>
                </div>
                <div style="color:#9ca3af; font-size:8px; margin-top:2px;">
                    Registrado: ${evaluacion.creado_en}
                </div>
            </div>
        `;
        
        entriesDiv.insertAdjacentHTML('afterbegin', entryHTML);
        console.log('üìã Agregado al historial de insulina:', evaluacion);
    }
}

function bloquearFechaInsulinaTratamiento(fecha) {
    const fechaInput = document.getElementById('insulinaFechaReal');
    const btnNuevo = document.getElementById('insulinaNuevoBtn');
    const status = document.getElementById('insulinaStatus');
    
    if (fechaInput) {
        fechaInput.setAttribute('readonly', 'readonly');
        fechaInput.style.background = '#f1f5f9';
        fechaInput.style.borderColor = '#94a3b8';
        fechaInput.value = fecha;
    }
    
    if (btnNuevo) {
        btnNuevo.style.display = 'inline-block'; // Mostrar bot√≥n "Nuevo"
    }
    
    if (status) {
        status.textContent = `Tratamiento fijo del ${fecha}`;
    }
    
    console.log('üîí Fecha de tratamiento con insulina bloqueada:', fecha);
}

/**
 * Cargar √∫ltimo registro de Tratamiento Insulina y mostrar bot√≥n "Nuevo"
 * @param {string} run - RUN del usuario
 */
async function cargarUltimoTratamientoInsulina(run) {
    debugLog('[INSULINA] Cargando √∫ltimo tratamiento para RUN:', run);
    
    const ultimoDiv = document.getElementById('insulinaUltimoRegistro');
    const btnNuevo = document.getElementById('insulinaNuevoBtn');
    const status = document.getElementById('insulinaStatus');
    
    if (!run || !ultimoDiv) {
        debugLog('[INSULINA] Faltan elementos DOM o RUN');
        return;
    }
    
    try {
        const response = await fetch(`/api/examenes/tratamiento_insulina/${encodeURIComponent(run)}`);
        const data = await response.json();
        
        debugLog('[INSULINA] Respuesta del servidor:', data);
        
        if (data.success && data.data) {
            const d = data.data;
            
            if (d.activo && d.fecha) {
                // Hay tratamiento activo
                const fechaFormateada = formatearFechaEspanol(new Date(d.fecha));
                const updatedAt = d.updated_at ? formatearFechaEspanol(new Date(d.updated_at)) : 'N/A';
                
                ultimoDiv.innerHTML = `
                    <div class="alert alert-info">
                        <strong>üíä Tratamiento Activo</strong><br>
                        <small>Fecha de inicio: ${fechaFormateada}</small><br>
                        <small>√öltima actualizaci√≥n: ${updatedAt}</small>
                    </div>
                `;
                
                if (status) {
                    status.innerHTML = '<span class="badge badge-success">Activo</span>';
                }
                
                debugLog('[INSULINA] Tratamiento activo cargado');
            } else if (!d.activo && d.fecha) {
                // Hay registro pero no est√° activo
                const fechaFormateada = formatearFechaEspanol(new Date(d.fecha));
                const updatedAt = d.updated_at ? formatearFechaEspanol(new Date(d.updated_at)) : 'N/A';
                
                ultimoDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>üíä Tratamiento Suspendido</strong><br>
                        <small>√öltima fecha: ${fechaFormateada}</small><br>
                        <small>√öltima actualizaci√≥n: ${updatedAt}</small>
                    </div>
                `;
                
                if (status) {
                    status.innerHTML = '<span class="badge badge-warning">Suspendido</span>';
                }
                
                debugLog('[INSULINA] Tratamiento suspendido cargado');
            } else {
                // No hay registro de tratamiento
                ultimoDiv.innerHTML = `
                    <div class="alert alert-secondary">
                        <small>üìã No hay registro de tratamiento con insulina</small>
                    </div>
                `;
                
                if (status) {
                    status.innerHTML = '<span class="badge badge-secondary">Sin registro</span>';
                }
                
                debugLog('[INSULINA] Sin registro de tratamiento');
            }
            
            // Mostrar bot√≥n "Nuevo" si existe
            if (btnNuevo) {
                btnNuevo.style.display = 'inline-block';
            }
        } else {
            throw new Error(data.error || 'Error desconocido al obtener tratamiento de insulina');
        }
    } catch (error) {
        console.error('[INSULINA] Error cargando tratamiento:', error);
        
        ultimoDiv.innerHTML = `
            <div class="alert alert-danger">
                <small>‚ùå Error cargando estado del tratamiento: ${error.message}</small>
            </div>
        `;
        
        if (status) {
            status.innerHTML = '<span class="badge badge-danger">Error</span>';
        }
    }
}

// ===== FIN NUEVAS FUNCIONES TRATAMIENTO INSULINA =====

// ===== CONTROL DE VISIBILIDAD SECCIONES M√âDICAS =====

/**
 * Lista de IDs de secciones m√©dicas que deben ocultarse cuando no hay usuario v√°lido
 */
const SECCIONES_MEDICAS = [
    'cat-piel', // ALTERACIONES DE LA CONTINUIDAD DE LA PIEL (categor√≠a 17)
    'pieDmSection', // Evaluaci√≥n diab√©tica (Pie DM)
    'curacionPieSection', // Curaciones de pie
    // 'tratamientoInsulinaSection' se controla por separado seg√∫n diabetes
    'cvLifestyleSection', // Lifestyle cardiovascular
    'medicacionSection', // Medicaci√≥n
    'adultoMayorSection', // Adulto mayor
    'amMaltratoSection', // Maltrato adulto mayor
    'imcHistSection', // Historial IMC
    'content-piel', // Contenido de alteraciones de piel
    'categoria-17-container', // Contenedor categor√≠a 17
    'pie-dm-container', // Contenedor pie diab√©tico
    'curacion-container', // Contenedor curaciones
    'insulina-container', // Contenedor insulina
    'cv-container', // Contenedor cardiovascular
    'medicacion-container', // Contenedor medicaci√≥n
    'adulto-mayor-container', // Contenedor adulto mayor
    'maltrato-container', // Contenedor maltrato
    'imc-container' // Contenedor IMC
];

/**
 * Estado global del usuario actual
 */
let usuarioExiste = false;

/**
 * Detecta si el usuario tiene alg√∫n diagn√≥stico de diabetes
 * @returns {boolean} true si tiene diabetes, false en caso contrario
 */
function usuarioTieneDiabetes() {
    // Buscar patolog√≠as marcadas que sean c√≥digos de diabetes (E10-E14)
    const checkboxesDiabetes = document.querySelectorAll('input[name="patologia[]"]:checked');
    
    for (let checkbox of checkboxesDiabetes) {
        const codigo = checkbox.value;
        if (codigo && (codigo.startsWith('E10') || codigo.startsWith('E11') || 
                      codigo.startsWith('E12') || codigo.startsWith('E13') || 
                      codigo.startsWith('E14'))) {
            console.log('[DIABETES] ‚úÖ Diabetes detectada:', codigo);
            return true;
        }
    }
    
    // Tambi√©n verificar en patolog√≠as guardadas en BD
    const patologiasGuardadas = document.querySelectorAll('#patologias-guardadas .pat-badge');
    for (let badge of patologiasGuardadas) {
        const texto = badge.textContent || '';
        if (texto.includes('E10') || texto.includes('E11') || 
            texto.includes('E12') || texto.includes('E13') || 
            texto.includes('E14')) {
            console.log('[DIABETES] ‚úÖ Diabetes detectada en BD:', texto);
            return true;
        }
    }
    
    console.log('[DIABETES] ‚ùå No se detect√≥ diabetes');
    return false;
}

/**
 * Actualiza la visibilidad de la secci√≥n de tratamiento con insulina
 * Solo se muestra si el usuario tiene diabetes
 */
function actualizarVisibilidadInsulinaSegunDiabetes() {
    const insulinaSection = document.getElementById('tratamientoInsulinaSection');
    if (!insulinaSection) return;
    
    if (usuarioTieneDiabetes()) {
        insulinaSection.style.display = 'block';
        console.log('[INSULINA] ‚úÖ Secci√≥n de insulina mostrada (paciente diab√©tico)');
    } else {
        insulinaSection.style.display = 'none';
        console.log('[INSULINA] ‚ùå Secci√≥n de insulina oculta (paciente no diab√©tico)');
    }
}

/**
 * Ocultar todas las secciones m√©dicas que requieren usuario v√°lido
 */
function ocultarSeccionesMedicas() {
    console.log('[CONTROL-USUARIO] üîí Ocultando secciones m√©dicas (usuario no v√°lido)');
    
    // Ocultar elementos por ID espec√≠fico
    SECCIONES_MEDICAS.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'none';
            console.log(`[CONTROL-USUARIO] ‚úì Secci√≥n ${sectionId} ocultada`);
        }
    });
    
    // Ocultar tambi√©n todos los elementos de la clase piedm-wrapper (secciones m√©dicas)
    const piedmWrappers = document.querySelectorAll('.piedm-wrapper');
    piedmWrappers.forEach(wrapper => {
        wrapper.style.display = 'none';
        console.log(`[CONTROL-USUARIO] ‚úì Wrapper m√©dico ocultado: ${wrapper.id || 'sin-id'}`);
    });
    
    // Ocultar categor√≠as m√©dicas desde categor√≠a 17 en adelante
    const categoriasMedicas = document.querySelectorAll('.categoria-seccion');
    categoriasMedicas.forEach(categoria => {
        if (categoria.id && categoria.id !== 'cat-vacunas' && categoria.id !== 'cat-demograficos') {
            categoria.style.display = 'none';
            console.log(`[CONTROL-USUARIO] ‚úì Categor√≠a m√©dica ocultada: ${categoria.id}`);
        }
    });
    
    usuarioExiste = false;
    
    // Ocultar mensaje de usuario encontrado si est√° visible
    const encontrado = document.getElementById('usuario-encontrado');
    if (encontrado) encontrado.style.display = 'none';
}

/**
 * Mostrar todas las secciones m√©dicas cuando el usuario es v√°lido
 */
function mostrarSeccionesMedicas() {
    console.log('[CONTROL-USUARIO] üîì Mostrando secciones m√©dicas (usuario v√°lido)');
    
    SECCIONES_MEDICAS.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            // Usar las funciones de visibilidad espec√≠ficas si existen
            if (sectionId === 'pieDmSection' && typeof updatePieDmVisibility === 'function') {
                updatePieDmVisibility();
            } else if (sectionId === 'medicacionSection' && typeof updateMedicacionVisibility === 'function') {
                updateMedicacionVisibility();
            } else if (sectionId === 'adultoMayorSection' && typeof updateAdultoMayorVisibility === 'function') {
                updateAdultoMayorVisibility();
            } else {
                // Para secciones simples, mostrar directamente
                if (sectionId === 'cat-piel' || sectionId === 'cvLifestyleSection') {
                    section.style.display = 'block';
                } else if (sectionId === 'tratamientoInsulinaSection') {
                    // La secci√≥n de insulina se controla por separado seg√∫n diabetes
                    actualizarVisibilidadInsulinaSegunDiabetes();
                }
            }
            console.log(`[CONTROL-USUARIO] ‚úì Secci√≥n ${sectionId} procesada para mostrar`);
        }
    });
    
    // Mostrar tambi√©n todos los elementos de la clase piedm-wrapper que deber√≠an estar visibles
    const piedmWrappers = document.querySelectorAll('.piedm-wrapper');
    piedmWrappers.forEach(wrapper => {
        wrapper.style.display = 'block';
        console.log(`[CONTROL-USUARIO] ‚úì Wrapper m√©dico mostrado: ${wrapper.id || 'sin-id'}`);
    });
    
    // Mostrar categor√≠as m√©dicas desde categor√≠a 17 en adelante
    const categoriasMedicas = document.querySelectorAll('.categoria-seccion');
    categoriasMedicas.forEach(categoria => {
        if (categoria.id && categoria.id !== 'cat-vacunas' && categoria.id !== 'cat-demograficos') {
            categoria.style.display = 'block';
            console.log(`[CONTROL-USUARIO] ‚úì Categor√≠a m√©dica mostrada: ${categoria.id}`);
        }
    });
    
    usuarioExiste = true;
    
    // Ocultar mensaje de usuario nuevo
    const mensajeNuevo = document.getElementById('usuario-nuevo');
    if (mensajeNuevo) mensajeNuevo.style.display = 'none';
}

/**
 * Verificar si el usuario actual es v√°lido (existe en BD)
 * @returns {boolean} true si el usuario existe, false en caso contrario
 */
function verificarUsuarioValido() {
    const encontrado = document.getElementById('usuario-encontrado');
    const esVisible = encontrado && encontrado.style.display !== 'none';
    
    console.log('[CONTROL-USUARIO] üîç Verificando usuario v√°lido:', esVisible);
    return esVisible;
}

/**
 * Actualizar visibilidad de secciones m√©dicas seg√∫n estado del usuario
 */
function actualizarVisibilidadSeccionesMedicas() {
    if (verificarUsuarioValido()) {
        mostrarSeccionesMedicas();
    } else {
        ocultarSeccionesMedicas();
    }
}

// ===== FIN CONTROL DE VISIBILIDAD SECCIONES M√âDICAS =====

// Inicializaci√≥n del formulario Pie DM
document.addEventListener('DOMContentLoaded', function() {
    // CONTROL INICIAL: Verificar estado del usuario al cargar la p√°gina
    console.log('[INIT] üöÄ Inicializando control de visibilidad de secciones m√©dicas');
    
    // POR DEFECTO: Ocultar todas las secciones m√©dicas hasta que se confirme un usuario v√°lido
    console.log('[INIT] üîí Ocultando secciones m√©dicas por defecto');
    ocultarSeccionesMedicas();
    
    // Verificar si hay usuario actual o si estamos en modo nuevo usuario
    const runInput = document.getElementById('run');
    const nombreInput = document.getElementById('nombre');
    const usuarioEncontradoDiv = document.getElementById('usuario-encontrado');
    
    // Solo mostrar secciones si hay datos v√°lidos del usuario
    if (runInput && runInput.value && 
        nombreInput && nombreInput.value &&
        usuarioEncontradoDiv && usuarioEncontradoDiv.style.display !== 'none') {
        console.log('[INIT] ‚úÖ Usuario v√°lido detectado - mostrando secciones m√©dicas');
        mostrarSeccionesMedicas();
    } else {
        console.log('[INIT] ‚ùå Usuario no v√°lido - manteniendo secciones ocultas');
        // Las secciones ya est√°n ocultas por la llamada anterior
    }
    
    // LISTENER: Detectar cambios en patolog√≠as para controlar secci√≥n de insulina
    document.addEventListener('change', function(e) {
        if (e.target && e.target.matches('input[name="patologia[]"]')) {
            console.log('[DIABETES] üîÑ Cambio en patolog√≠a detectado, actualizando visibilidad de insulina');
            // Usar setTimeout para permitir que se complete el cambio
            setTimeout(actualizarVisibilidadInsulinaSegunDiabetes, 100);
        }
    });
    
    // Configurar estado inicial del formulario de evaluaci√≥n diab√©tica
    const fechaInput = document.getElementById('pieDmFechaReal');
    const status = document.getElementById('pieDmStatus');
    const btnNuevo = document.getElementById('pieDmNuevoBtn');
    
    if (fechaInput) {
        // Estado inicial: fecha desbloqueada para entrada manual
        fechaInput.removeAttribute('readonly');
        fechaInput.style.background = '#ffffff';
        fechaInput.style.borderColor = '#cbd5e1';
        fechaInput.placeholder = 'dd/mm/aaaa';
    }
    
    // Configurar formato autom√°tico para fecha de amputaci√≥n
    const fechaAmputacionInput = document.getElementById('fechaAmputacion');
    if (fechaAmputacionInput) {
        fechaAmputacionInput.addEventListener('input', function(e) {
            let valor = e.target.value;
            // Remover caracteres no num√©ricos excepto /
            valor = valor.replace(/[^0-9\/]/g, '');
            // Formatear autom√°ticamente
            if (valor.length >= 2 && valor.charAt(2) !== '/') {
                valor = valor.substring(0, 2) + '/' + valor.substring(2);
            }
            if (valor.length >= 5 && valor.charAt(5) !== '/') {
                valor = valor.substring(0, 5) + '/' + valor.substring(5);
            }
            // Limitar a 10 caracteres (dd/mm/aaaa)
            if (valor.length > 10) {
                valor = valor.substring(0, 10);
            }
            e.target.value = valor;
        });
    }
    
    if (status) {
        status.textContent = 'Ingrese fecha de evaluaci√≥n manualmente';
    }
    
    if (btnNuevo) {
        btnNuevo.style.display = 'none'; // Oculto inicialmente
    }
    
    console.log('‚úÖ Formulario Pie DM inicializado con fecha manual');
});

// Auto-c√°lculo al cambiar radios (debounce)
let pieDmDebounce;
['ulceraPieOAmputacion_si','ulceraPieOAmputacion_no','sensibilidadProtectora_si','sensibilidadProtectora_no','EAP_si','EAP_no','DEF_si','DEF_no','amputacion_si','amputacion_no'].forEach(id=>{
    document.addEventListener('change', e=>{
        if(e.target && e.target.id === id){
            // Control espec√≠fico para mostrar/ocultar fecha de amputaci√≥n
            if(id === 'amputacion_si' || id === 'amputacion_no') {
                const fechaContainer = document.getElementById('fechaAmputacionContainer');
                if(fechaContainer) {
                    fechaContainer.style.display = (id === 'amputacion_si') ? 'block' : 'none';
                }
                
                // Si se selecciona "S√≠" en amputaci√≥n y ya hay una fecha guardada previamente,
                // hacer los campos permanentes
                if(id === 'amputacion_si' && e.target.checked) {
                    const fechaAmputacionInput = document.getElementById('fechaAmputacion');
                    if(fechaAmputacionInput && fechaAmputacionInput.value) {
                        // Si ya hay una fecha, confirmar antes de hacer permanente
                        setTimeout(() => {
                            const confirmar = confirm('Al confirmar amputaci√≥n con fecha previa, estos campos se volver√°n permanentes. ¬øContinuar?');
                            if(!confirmar) {
                                // Revertir selecci√≥n
                                e.target.checked = false;
                                const amputacionNoRadio = document.getElementById('amputacion_no');
                                if(amputacionNoRadio) amputacionNoRadio.checked = true;
                                fechaContainer.style.display = 'none';
                            }
                        }, 100);
                    }
                }
            }
            
            clearTimeout(pieDmDebounce);
            pieDmDebounce = setTimeout(()=>{
                    const runInput = document.querySelector('input[name="run"]');
                    if(runInput && runInput.value.trim()) evaluarRiesgoPieDM();
            }, 500);
        }
    });
});

// Panel helpers + resumen cabecera
function openPieDmPanel(){
    const panel=document.getElementById('panel-pie-dm');
    const chevron=document.getElementById('pieDmChevron');
    const btn=document.getElementById('btnPieDmToggle');
    if(panel && panel.classList.contains('hidden')) panel.classList.remove('hidden');
    if(chevron) chevron.textContent='‚ñº';
    if(btn){ btn.textContent='Ocultar'; btn.setAttribute('aria-expanded','true'); }
    localStorage.setItem('pieDmPanelOpen','1');
}
function closePieDmPanel(){
    const panel=document.getElementById('panel-pie-dm');
    const chevron=document.getElementById('pieDmChevron');
    const btn=document.getElementById('btnPieDmToggle');
    if(panel && !panel.classList.contains('hidden')) panel.classList.add('hidden');
    if(chevron) chevron.textContent='‚ñ∂';
    if(btn){ btn.textContent='Mostrar'; btn.setAttribute('aria-expanded','false'); }
    localStorage.setItem('pieDmPanelOpen','0');
}
function togglePieDmPanel(e){ if(e) e.stopPropagation(); const panel=document.getElementById('panel-pie-dm'); if(!panel) return; if(panel.classList.contains('hidden')) openPieDmPanel(); else closePieDmPanel(); }

function updatePieDmHeaderSummary(nivel, fecha, diasRestantes){
    const span = document.getElementById('pieDmSummary');
    if(!span) return;
    const sem = document.getElementById('pieDmSemaforo');
    if(!nivel){ span.style.display='none'; span.textContent=''; span.className='piedm-summary'; if(sem){sem.style.display='none'; sem.className='piedm-semaforo';} return; }
    span.className='piedm-summary nivel-' + nivel;
    let diasTxt = '';
    if(typeof diasRestantes === 'number'){
        if(diasRestantes < 0) diasTxt = ` ‚Ä¢ Vencido hace ${Math.abs(diasRestantes)}d`;
        else if(diasRestantes === 0) diasTxt = ' ‚Ä¢ Hoy';
        else diasTxt = ` ‚Ä¢ en ${diasRestantes}d`;
    }
    span.textContent = 'Riesgo ' + nivel.toUpperCase() + (fecha? ' ‚Ä¢ '+fecha : '') + diasTxt;
    span.style.display='inline-flex';
    if(sem){
        sem.className = 'piedm-semaforo sem-' + nivel;
        if(typeof diasRestantes === 'number'){
           if(diasRestantes < 0){ sem.classList.add('piedm-overdue'); span.classList.add('piedm-overdue'); }
           else if(diasRestantes === 0){ sem.classList.add('piedm-due-today'); span.classList.add('piedm-due-today'); }
           else { sem.classList.remove('piedm-overdue','piedm-due-today'); span.classList.remove('piedm-overdue','piedm-due-today'); }
        }
        sem.title = 'Riesgo ' + nivel.toUpperCase(); sem.style.display='inline-block';
    }
}

// Helper: habilitar/deshabilitar controles del panel Pie DM
function setPieDmControlsDisabled(disabled){
    const ids = [
        'ulceraPieOAmputacion_si','ulceraPieOAmputacion_no',
        'amputacion_si','amputacion_no','fechaAmputacion',
        'sensibilidadProtectora_si','sensibilidadProtectora_no',
        'EAP_si','EAP_no',
        'DEF_si','DEF_no',
        'tratamientoInsulina_si','tratamientoInsulina_no',
        'fondoOjosFecha','fondoOjosEstado',
        // Podolog√≠a / Hipoglicemias
        'podologiaFecha','podologiaToggle','podologiaGuardarBtn','podologiaNuevoBtn',
        'hipoFecha','hipoRecurrenteToggle','hipoGuardarBtn',
        // Controles Curaciones Pie DM
        'curacionPieFecha','curacionPieEnCurso','curacionPieTipo','curacionPieGuardarBtn','curacionPieNuevoBtn'
    ];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.disabled = !!disabled; }});
    const btnCalc = document.querySelector('#evaluacionPieDmForm .btn-calc');
    const btnReset = document.querySelector('#evaluacionPieDmForm .btn-reset');
    if(btnCalc) btnCalc.disabled = !!disabled;
    if(btnReset) btnReset.disabled = !!disabled;
}

// Mostrar la secci√≥n SOLO si hay diabetes (seleccionada o guardada)
function hasDiabetesDiagnosed(){
    const checkboxes = document.querySelectorAll('.patologia-checkbox');
    return Array.from(checkboxes).some(cb => {
        if(!cb.checked) return false;
        const raw = (cb.value || '').toUpperCase();
        const base = raw.split('.')[0];
        return ['E10','E11','E12','E13','E14','O24','R73','R7303','R73.03'].some(code => base === code || raw.startsWith(code));
    });
}

function hasHipertensionDiagnosed(){
    const checkboxes = document.querySelectorAll('.patologia-checkbox');
    return Array.from(checkboxes).some(cb => {
        if(!cb.checked) return false;
        const raw = (cb.value || '').toUpperCase();
        const base = raw.split('.')[0];
        // C√≥digos de hipertensi√≥n arterial I10-I15
        return ['I10','I11','I12','I13','I14','I15'].some(code => base === code || raw.startsWith(code));
    });
}

function hasCardiovascularCondition(){
    // Retorna true si tiene diabetes O hipertensi√≥n
    return hasDiabetesDiagnosed() || hasHipertensionDiagnosed();
}

function updatePieDmVisibility() {
    const section = document.getElementById('pieDmSection');
    if(!section) return;
    // Por defecto, oculta hasta confirmar diabetes
    // Nota: el div viene con display:none en el HTML inicial
    const hasDiabetes = hasDiabetesDiagnosed();

    if(hasDiabetes) {
        // Forzamos a block para sobreescribir cualquier regla CSS que a√∫n lo oculte
        section.style.display = 'block';
        setPieDmControlsDisabled(false);
        if(!section.dataset.loadedOnce) {
            openPieDmPanel();
            const runInput = document.querySelector('input[name="run"]');
            if(runInput && runInput.value.trim()) {
                cargarUltimaEvaluacionPieDM(runInput.value.trim());
                cargarTratamientoInsulinaDebounced(runInput.value.trim(), 200);
                cargarHipoglicemiasUltimo();
            }
            section.dataset.loadedOnce = '1';
        } else {
            const saved = localStorage.getItem('pieDmPanelOpen');
            if(saved === '1') openPieDmPanel(); else closePieDmPanel();
        }
    } else {
        // Si no hay diabetes, cerrar panel, limpiar resumen y deshabilitar controles
        section.style.display = 'none';
        closePieDmPanel();
        updatePieDmHeaderSummary(null,null);
        setPieDmControlsDisabled(true);
    }
}

// ===== Persistencia 1 a√±o de radios (por RUN) =====
const PERSIST_RADIO_FIELDS = ['ulceraPieOAmputacion','sensibilidadProtectora','EAP','DEF','tratamientoInsulina','amputacion'];
function radioPersistKey(runRaw, name){ return `persist1y:radio:${name}:${runRaw}`; }
function saveRadioPersist(name, value, runRawVal){
    try{
        if(!runRawVal) return;
        const key = radioPersistKey(runRawVal, name);
        const oneYearMs = 365 * 24 * 60 * 60 * 1000;
        const payload = { v: value, exp: Date.now() + oneYearMs };
        localStorage.setItem(key, JSON.stringify(payload));
    }catch(_){ }
}
function loadRadioPersist(name, runRawVal){
    try{
        if(!runRawVal) return null;
        const key = radioPersistKey(runRawVal, name);
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || typeof obj !== 'object') { localStorage.removeItem(key); return null; }
        if(typeof obj.exp !== 'number' || obj.exp < Date.now()) { localStorage.removeItem(key); return null; }
        const val = obj.v;
        if(val !== 'si' && val !== 'no') return null;
        return val;
    }catch(_){ return null; }
}
function applyPersistedRadios(runRawVal){
    try{
        if(!runRawVal) return;
        PERSIST_RADIO_FIELDS.forEach(name=>{
            const val = loadRadioPersist(name, runRawVal);
            if(!val) return;
            const sel = document.querySelector(`input[name="${name}"][value="${val}"]`);
            if(sel) sel.checked = true;
        });
    }catch(_){ }
}
function initRadioPersistence(){
    try{
        PERSIST_RADIO_FIELDS.forEach(name=>{
            document.querySelectorAll(`input[name="${name}"]`).forEach(radio=>{
                radio.addEventListener('change', ()=>{
                    try{
                        const rr = (document.querySelector('input[name="run"]')?.value || '').replace(/[^0-9kK]/g,'');
                        if(!rr) return; // Requiere RUN para persistir por paciente
                        const current = document.querySelector(`input[name="${name}"]:checked`);
                        const v = current && current.value;
                        if(v === 'si' || v === 'no') saveRadioPersist(name, v, rr);
                    }catch(_){ }
                });
            });
        });
    }catch(_){ }
}

// Escuchar cambios de patolog√≠as para re-evaluar visibilidad
document.addEventListener('change', (e)=>{
    if(e.target && e.target.classList && e.target.classList.contains('patologia-checkbox')) {
        updatePieDmVisibility();
        try { updateMedicacionVisibility(); } catch(e){}
    }
});

// Refuerzo: algunos navegadores/comportamientos cambian 'checked' en 'input' o 'click'
['input','click'].forEach(evt => {
    document.addEventListener(evt, (e) => {
        if(e.target && e.target.classList && e.target.classList.contains('patologia-checkbox')){
            // Debounce corto para asegurar que el estado 'checked' ya se aplic√≥
            clearTimeout(window._pieDmVisDeb);
            window._pieDmVisDeb = setTimeout(()=>{
                updatePieDmVisibility();
                try { updateMedicacionVisibility(); } catch(_){}
            }, 30);
        }
    }, true);
});

// ====== Helpers comunes secci√≥n CV ======
function runRaw(){ const r=(document.querySelector('input[name="run"]')?.value||''); return r.replace(/[^0-9kK]/g,''); }
// Helper global: obtener el valor actual del RUN (tal como est√° en el input)
function getRun(){
    const el = document.getElementById('run');
    return (el && typeof el.value === 'string') ? el.value.trim() : '';
}
function setToday(id, force){
    // Pol√≠tica nueva: no autocompletar con la fecha de hoy.
    // Si force=true, solo limpiamos el campo y disparamos eventos.
    const el = document.getElementById(id);
    if(!el) return;
    if(force){
        try{
            if (typeof setFechaConOverlay === 'function') {
                setFechaConOverlay(id, '', { dispatch: true });
            } else {
                el.value = '';
                try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch(_){ }
                try { el.dispatchEvent(new Event('change', { bubbles: true })); } catch(_){ }
            }
        } catch(_){ el.value = ''; }
    }
}

// ====== Curaciones Pie DM (dentro de secci√≥n diab√©tica) ======
function updateCuracionPieTipoVisibility(){ const sel=document.getElementById('curacionPieEnCurso'); const box=document.getElementById('curacionPieTipoBox'); if(!sel||!box) return; box.style.display = (sel.value==='si')? 'block':'none'; }
async function guardarCuracionesPieDm(){
    const run = runRaw(); if(!run){ alert('Ingrese RUN'); return; }
    if(!hasDiabetesDiagnosed()){ alert('Solo corresponde registrar curaciones en personas con diagn√≥stico de diabetes.'); return; }
    const fecha = (document.getElementById('curacionPieFecha')?.value)||'';
    if(!fecha){ const st=document.getElementById('curacionPieStatus'); if(st) st.textContent='Ingrese fecha'; else alert('Ingrese fecha'); return; }
    const en = (document.getElementById('curacionPieEnCurso')?.value)||'';
    const tipo = (document.getElementById('curacionPieTipo')?.value)||'';
    const st = document.getElementById('curacionPieStatus'); st.textContent='Guardando...';
    try{
        const payload = { run, fecha, en_curacion: en==='si' };
        if(en==='si') payload.tipo = tipo;
        const resp = await fetch('/api/examenes/curaciones_piedm', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const data = await resp.json();
        if(data.success){ st.textContent='Guardado'; await cargarCuracionesPieDmUltimo(); await cargarCuracionesPieDmHistorial(); }
        else { st.textContent='Error: '+(data.error||''); }
    }catch(e){ st.textContent='Error red'; }
}
async function cargarCuracionesPieDmUltimo(){
    const run=runRaw(); if(!run) return; const box=document.getElementById('curacionPieUltimo');
    try{
        const r=await fetch('/api/examenes/curaciones_piedm/'+run); const j=await r.json();
        const fechaEl=document.getElementById('curacionPieFecha'); const enSel=document.getElementById('curacionPieEnCurso'); const tipoSel=document.getElementById('curacionPieTipo'); const btnGuardar=document.getElementById('curacionPieGuardarBtn'); const btnNuevo=document.getElementById('curacionPieNuevoBtn'); const st=document.getElementById('curacionPieStatus');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(enSel) enSel.disabled=false; if(tipoSel) tipoSel.disabled=false; return; }
        const d=j.data; fechaEl.value = d.fecha || ''; if(enSel){ enSel.value = d.en_curacion? 'si':'no'; } updateCuracionPieTipoVisibility(); if(tipoSel){ tipoSel.value = d.tipo || ''; }
    box.style.display='block'; box.textContent = `√öltimo: ${d.fecha} ‚Ä¢ ${d.en_curacion? 'En curaci√≥n ('+(d.tipo||'-')+')':'Sin curaciones'} ‚Ä¢ ${(d.creado_en||'').replace('T',' ').slice(0,10)}`;
        const y=(new Date()).getFullYear(); const dy=new Date(String(d.fecha||'')+"T00:00:00").getFullYear(); const lock=(y===dy);
        if(lock){ if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Bloqueado hasta el pr√≥ximo a√±o.`; if(fechaEl) fechaEl.disabled=true; if(enSel) enSel.disabled=true; if(tipoSel) tipoSel.disabled=true; if(btnGuardar) btnGuardar.disabled=true; if(btnNuevo) btnNuevo.style.display='inline-flex'; }
        else{ if(st && st.textContent.startsWith('üîí')) st.textContent=''; if(fechaEl) fechaEl.disabled=false; if(enSel) enSel.disabled=false; if(tipoSel) tipoSel.disabled=false; if(btnGuardar) btnGuardar.disabled=false; if(btnNuevo) btnNuevo.style.display='none'; }
    }catch(_e){ box.style.display='none'; }
}
function iniciarNuevoCuracionesPieDm(){ const fechaEl=document.getElementById('curacionPieFecha'); const enSel=document.getElementById('curacionPieEnCurso'); const tipoSel=document.getElementById('curacionPieTipo'); const btnGuardar=document.getElementById('curacionPieGuardarBtn'); const btnNuevo=document.getElementById('curacionPieNuevoBtn'); if(fechaEl){ fechaEl.disabled=false; fechaEl.value=''; } if(enSel){ enSel.disabled=false; enSel.value=''; } if(tipoSel){ tipoSel.disabled=false; tipoSel.value=''; } if(btnGuardar) btnGuardar.disabled=false; if(btnNuevo) btnNuevo.style.display='none'; const st=document.getElementById('curacionPieStatus'); if(st && st.textContent.startsWith('üîí')) st.textContent=''; updateCuracionPieTipoVisibility(); }
async function cargarCuracionesPieDmHistorial(){ const run=runRaw(); const cont=document.getElementById('curacionPieHist'); const tbody=document.getElementById('curacionPieHistBody'); if(!run){ cont.style.display='none'; return; } try{ const r=await fetch('/api/examenes/curaciones_piedm/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; } cont.style.display='block'; tbody.innerHTML = j.data.map(d=>`<tr><td>${d.fecha}</td><td>${d.en_curacion? 'S√≠':'No'}</td><td>${d.tipo||''}</td><td>${(d.creado_en||'').replace('T',' ').slice(0,10)}</td></tr>`).join(''); }catch(_e){ cont.style.display='none'; } }

// ====== Podolog√≠a (hist√≥rico, vigente 1 a√±o) ======
async function guardarPodologia(){
    const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; }
    if(!hasDiabetesDiagnosed()){ alert('Solo corresponde registrar podolog√≠a en personas con diagn√≥stico de diabetes.'); return; }
    const fecha=(document.getElementById('podologiaFecha')?.value)||'';
    if(!fecha){ const st=document.getElementById('podologiaStatus'); if(st) st.textContent='Ingrese fecha'; else alert('Ingrese fecha'); return; }
    const vigente=!!(document.getElementById('podologiaVigente_si')?.checked);
    const st=document.getElementById('podologiaStatus'); st.textContent='Guardando...';
    try{
        const resp=await fetch('/api/diabetes/podologia',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha, atencion_vigente: vigente})});
        const j=await resp.json(); 
        if(j.success){ 
            st.textContent='Guardado ‚úÖ'; 
            await cargarPodologiaUltimo(); 
            await cargarPodologiaHistorial(); 
        } else { 
            st.textContent='Error: '+(j.error||''); 
        }
    }catch(_e){ st.textContent='Error red'; }
}

async function cargarPodologiaUltimo(){
    const run=runRaw(); 
    const box=document.getElementById('podologiaUltimo'); 
    const btnNuevo=document.getElementById('podologiaNuevoBtn');
    const st=document.getElementById('podologiaStatus');
    
    if(!run){ 
        box.style.display='none'; 
        if(btnNuevo) btnNuevo.style.display='none';
        return; 
    }
    
    try{
        const r=await fetch('/api/diabetes/podologia/'+run); 
        const j=await r.json();
        const fechaEl=document.getElementById('podologiaFecha'); 
        const radioSi=document.getElementById('podologiaVigente_si');
        const radioNo=document.getElementById('podologiaVigente_no');
        const btnGuardar=document.getElementById('podologiaGuardarBtn'); 
        
        if(!j.success||!j.found){ 
            box.style.display='none'; 
            if(btnNuevo) btnNuevo.style.display='none'; 
            if(st) st.textContent='Sin registros previos';
            return; 
        }
        
        const d=j.data; 
        if(fechaEl) {
            try{ setFechaConOverlay('podologiaFecha', d.fecha||'', { dispatch: false }); } catch(_){ fechaEl.value=d.fecha||''; }
            fechaEl.setAttribute('readonly', true);
            fechaEl.style.background = '#f1f5f9';
        }
        if(d.atencion_vigente) {
            if(radioSi) radioSi.checked = true;
        } else {
            if(radioNo) radioNo.checked = true;
        }
        
    box.style.display='block'; 
    const fechaEspPod = formatearFechaEspanol(d.fecha);
    const creadoEspPod = formatearFechaEspanol(d.creado_en);
    box.innerHTML=`<strong>√öltimo registro:</strong> ${fechaEspPod} ‚Ä¢ ${d.atencion_vigente? 'Vigente':'No vigente'} ‚Ä¢ ${creadoEspPod}`;
        
        if(btnNuevo) btnNuevo.style.display='inline-block';
        if(st) st.textContent='Datos cargados';
        
    }catch(_e){ 
        box.style.display='none'; 
        if(st) st.textContent='Error cargando datos';
    }
}

function iniciarNuevoPodologia(){ 
    const fechaEl=document.getElementById('podologiaFecha'); 
    const radioSi=document.getElementById('podologiaVigente_si');
    const radioNo=document.getElementById('podologiaVigente_no');
    const btnGuardar=document.getElementById('podologiaGuardarBtn'); 
    const btnNuevo=document.getElementById('podologiaNuevoBtn');
    const box=document.getElementById('podologiaUltimo');
    const st=document.getElementById('podologiaStatus');
    
    if(fechaEl){ 
        fechaEl.removeAttribute('readonly');
        fechaEl.style.background = '#ffffff';
        fechaEl.value='';
    } 
    if(radioNo) radioNo.checked = true; // Resetear a "No"
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none';
    if(box) box.style.display='none';
    if(st) st.textContent='Registro nuevo - complete los datos';
}

async function cargarPodologiaHistorial(){
    const run=runRaw(); 
    const cont=document.getElementById('podologiaHist'); 
    const tbody=document.getElementById('podologiaHistBody'); 
    
    if(!run){ cont.style.display='none'; return; }
    
    try{ 
        const r=await fetch('/api/diabetes/podologia/historial/'+run); 
        const j=await r.json(); 
        
        if(!j.success||!j.count){ 
            cont.style.display='none'; 
            return; 
        }
        
        cont.style.display='block'; 
        tbody.innerHTML=j.data.map(d=>`<tr>
            <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${formatearFechaEspanol(d.fecha)}</td>
            <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center;">${d.atencion_vigente? 'S√≠':'No'}</td>
            <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${formatearFechaEspanol(d.creado_en)}</td>
        </tr>`).join('');
        
    }catch(_e){ 
        cont.style.display='none'; 
    }
}

// ====== Hipoglicemias recurrentes (a√±o calendario) ======
async function guardarHipoglicemias(){
    const runInput = document.querySelector('input[name="run"]');
    if (!runInput || !runInput.value.trim()) { 
        alert('Ingrese RUN antes de guardar.'); 
        return; 
    }
    
    if(!hasDiabetesDiagnosed()){ 
        alert('Solo corresponde registrar hipoglicemias en personas con diagn√≥stico de diabetes.'); 
        return; 
    }
    
    // Validar que se haya ingresado una fecha manualmente
    const fechaRealInput = document.getElementById('hipoFecha');
    const fechaReal = fechaRealInput?.value;
    
    if (!fechaReal) {
        alert('‚ö†Ô∏è Debe ingresar una fecha de evaluaci√≥n manualmente antes de guardar.');
        fechaRealInput?.focus();
        return;
    }
    
    // Validar formato de fecha dd/mm/aaaa
    const formatoFecha = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!formatoFecha.test(fechaReal)) {
        alert('‚ö†Ô∏è La fecha debe tener el formato dd/mm/aaaa (ejemplo: 18/09/2025)');
        fechaRealInput?.focus();
        return;
    }
    
    // Validar que la fecha sea v√°lida
    const [dia, mes, a√±o] = fechaReal.split('/').map(num => parseInt(num));
    const fechaObj = new Date(a√±o, mes - 1, dia);
    if (fechaObj.getDate() !== dia || fechaObj.getMonth() !== mes - 1 || fechaObj.getFullYear() !== a√±o) {
        alert('‚ö†Ô∏è La fecha ingresada no es v√°lida. Verifique d√≠a, mes y a√±o.');
        fechaRealInput?.focus();
        return;
    }
    
    const recurrente = document.getElementById('hipoRecurrente_si')?.checked === true;
    
    try {
        // Mover evaluaci√≥n actual al historial
        await moverEvaluacionHipoglicemiasAHistorial();
        
        // Preparar payload con fecha en formato ISO
        const fechaISO = `${a√±o}-${mes.toString().padStart(2, '0')}-${dia.toString().padStart(2, '0')}`;
        const payload = {
            run: runInput.value.trim(),
            fecha: fechaISO,
            recurrente: recurrente
        };
        
        const response = await fetch('/api/diabetes/hipoglicemias', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Bloquear fecha despu√©s de guardar exitoso
            bloquearFechaHipoglicemias(fechaReal);
            
            // Agregar al historial visual
            const recurrenteTexto = recurrente ? 'S√≠' : 'No';
            agregarAHistorialHipoglicemias({
                fecha: fechaReal,
                recurrente: recurrenteTexto,
                creado_en: new Date().toLocaleString('es-CL')
            });
            
            alert('‚úÖ Hipoglicemias guardadas correctamente');
            
            // Actualizar estado
            const status = document.getElementById('hipoStatus');
            if (status) status.textContent = 'Datos guardados';
            
        } else {
            throw new Error(result.message || 'Error al guardar');
        }
        
    } catch (error) {
        console.error('Error guardando hipoglicemias:', error);
        alert('‚ùå Error guardando datos de hipoglicemias: ' + error.message);
    }
}

async function cargarHipoglicemiasUltimo(){
    const runInput = document.querySelector('input[name="run"]');
    const ultimoDiv = document.getElementById('hipoUltimo');
    const btnNuevo = document.getElementById('hipoNuevoBtn');
    const status = document.getElementById('hipoStatus');
    
    if (!runInput?.value.trim() || !ultimoDiv) return;
    
    try {
        const response = await fetch(`/api/diabetes/hipoglicemias/${encodeURIComponent(runInput.value.trim())}`);
        const data = await response.json();
        
        if (data.success && data.found) {
            const d = data.data;
            if (ultimoDiv) {
                // Convertir fechas a formato espa√±ol
                const fechaRealizacion = formatearFechaEspanol(new Date(d.fecha));
                const fechaProxima = new Date(d.fecha);
                fechaProxima.setFullYear(fechaProxima.getFullYear() + 1); // Vigencia 1 a√±o
                const fechaProximaEsp = formatearFechaEspanol(fechaProxima);
                
                // Calcular d√≠as hasta pr√≥xima evaluaci√≥n
                const hoy = new Date();
                hoy.setHours(0,0,0,0);
                const msDiff = fechaProxima.getTime() - hoy.getTime();
                const diasRestantes = Math.round(msDiff / 86400000);
                
                let etiquetaDias = '';
                if (diasRestantes < 0) {
                    etiquetaDias = ` (Vencido hace ${Math.abs(diasRestantes)} d√≠as)`;
                } else if (diasRestantes === 0) {
                    etiquetaDias = ' (Hoy)';
                } else {
                    etiquetaDias = ` (en ${diasRestantes} d√≠as)`;
                }
                
                const recurrenteTexto = d.recurrente ? 'S√≠' : 'No';
                ultimoDiv.innerHTML = `<strong>√öltimo registro:</strong> ${fechaRealizacion} | Recurrente: ${recurrenteTexto} | Pr√≥xima: ${fechaProximaEsp}${etiquetaDias}`;
                ultimoDiv.style.display = 'block';
            }
            if (btnNuevo) btnNuevo.style.display = 'inline-block';
            if (status) status.textContent = 'Datos cargados';
            
            // Fijar fecha del √∫ltimo registro
            const fechaInput = document.getElementById('hipoFecha');
            if (fechaInput && d.fecha) {
                const fechaFormateada = formatearFechaEspanol(new Date(d.fecha));
                bloquearFechaHipoglicemias(fechaFormateada);
                
                // Seleccionar radio button seg√∫n el estado
                const siRadio = document.getElementById('hipoRecurrente_si');
                const noRadio = document.getElementById('hipoRecurrente_no');
                if (d.recurrente && siRadio) {
                    siRadio.checked = true;
                } else if (!d.recurrente && noRadio) {
                    noRadio.checked = true;
                }
            }
        } else {
            if (ultimoDiv) ultimoDiv.style.display = 'none';
            if (btnNuevo) btnNuevo.style.display = 'none';
            if (status) status.textContent = '';
        }
    } catch (error) {
        console.error('Error cargando √∫ltimo registro de hipoglicemias:', error);
        if (ultimoDiv) ultimoDiv.style.display = 'none';
        if (btnNuevo) btnNuevo.style.display = 'none';
    }
}

function iniciarNuevoHipoglicemias() {
    // Desbloquear campo de fecha
    const fechaInput = document.getElementById('hipoFecha');
    const btnNuevo = document.getElementById('hipoNuevoBtn');
    const status = document.getElementById('hipoStatus');
    
    if (fechaInput) {
        fechaInput.removeAttribute('readonly');
        fechaInput.style.background = '';
        fechaInput.style.borderColor = '';
        fechaInput.value = '';
        fechaInput.focus();
    }
    
    // Limpiar selecciones
    const radioNo = document.getElementById('hipoRecurrente_no');
    if (radioNo) radioNo.checked = true;
    
    if (btnNuevo) {
        btnNuevo.style.display = 'none';
    }
    
    if (status) {
        status.textContent = 'Nueva evaluaci√≥n';
    }
    
    console.log('üÜï Iniciando nueva evaluaci√≥n de hipoglicemias');
}

async function moverEvaluacionHipoglicemiasAHistorial() {
    // Buscar evaluaci√≥n actual
    const fechaInput = document.getElementById('hipoFecha');
    const siRadio = document.getElementById('hipoRecurrente_si');
    
    if (fechaInput?.value && (siRadio?.checked || document.getElementById('hipoRecurrente_no')?.checked)) {
        const recurrente = siRadio?.checked ? 'S√≠' : 'No';
        
        // Agregar al historial
        agregarAHistorialHipoglicemias({
            fecha: fechaInput.value,
            recurrente: recurrente,
            creado_en: new Date().toLocaleString('es-CL')
        });
    }
}

function agregarAHistorialHipoglicemias(evaluacion) {
    const historialDiv = document.getElementById('hipoHist');
    const entriesDiv = document.getElementById('hipoHistBody');
    
    if (historialDiv && entriesDiv) {
        historialDiv.style.display = 'block';
        
        const entryHTML = `
            <tr>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${evaluacion.fecha}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${evaluacion.recurrente}</td>
                <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${evaluacion.creado_en}</td>
            </tr>
        `;
        
        entriesDiv.insertAdjacentHTML('afterbegin', entryHTML);
        console.log('üìã Agregado al historial de hipoglicemias:', evaluacion);
    }
}

function bloquearFechaHipoglicemias(fecha) {
    const fechaInput = document.getElementById('hipoFecha');
    const btnNuevo = document.getElementById('hipoNuevoBtn');
    const status = document.getElementById('hipoStatus');
    
    if (fechaInput) {
        fechaInput.setAttribute('readonly', 'readonly');
        fechaInput.style.background = '#f1f5f9';
        fechaInput.style.borderColor = '#94a3b8';
        fechaInput.value = fecha;
    }
    
    if (btnNuevo) {
        btnNuevo.style.display = 'inline-block'; // Mostrar bot√≥n "Nuevo"
    }
    
    if (status) {
        status.textContent = `Hipoglicemias fijas del ${fecha}`;
    }
    
    console.log('üîí Fecha de hipoglicemias bloqueada:', fecha);
}

async function cargarHipoglicemiasHistorial(){
    const run=runRaw(); 
    const cont=document.getElementById('hipoHist'); 
    const tbody=document.getElementById('hipoHistBody'); 
    
    if(!run){ cont.style.display='none'; return; }
    
    try{ 
        const r=await fetch('/api/diabetes/hipoglicemias/historial/'+run); 
        const j=await r.json(); 
        
        if(!j.success||!j.count){ 
            cont.style.display='none'; 
            return; 
        }
        
        cont.style.display='block'; 
        tbody.innerHTML=j.data.map(d=>`<tr>
            <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${formatearFechaEspanol(d.fecha)}</td>
            <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px; text-align:center;">${d.recurrente? 'S√≠':'No'}</td>
            <td style="padding:3px 4px; border-bottom:1px solid #e5e7eb; font-size:9px;">${formatearFechaEspanol(d.creado_en)}</td>
        </tr>`).join('');
        
    }catch(_e){ 
        cont.style.display='none'; 
    }
}

// ====== Riesgo CV ======
async function guardarCvRiesgo(){ const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; } const fecha=(document.getElementById('cvRiesgoFecha')?.value)||''; const nivel=(document.getElementById('cvRiesgoNivel')?.value)||''; const st=document.getElementById('cvRiesgoStatus'); if(!fecha){ st.textContent='Ingrese fecha'; return; } if(!nivel){ st.textContent='Seleccione un nivel'; return; } st.textContent='Guardando...'; const fechaDB = convertirFechaParaDB(fecha); try{ const resp=await fetch('/api/cardiovascular/riesgo',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha: fechaDB, riesgo_nivel:nivel})}); const j=await resp.json(); if(j.success){ st.textContent='Guardado'; await cargarCvRiesgoUltimo(); await cargarCvRiesgoHistorial(); } else { st.textContent='Error: '+(j.error||''); } }catch(e){ st.textContent='Error red'; } }
async function cargarCvRiesgoUltimo(){ 
    const run=runRaw(); const box=document.getElementById('cvRiesgoUltimo'); if(!run){ box.style.display='none'; return; } 
    try{ 
        const r=await fetch('/api/cardiovascular/riesgo/'+run); const j=await r.json(); 
        const fechaEl=document.getElementById('cvRiesgoFecha'); const nivelEl=document.getElementById('cvRiesgoNivel'); const btnGuardar=document.getElementById('cvRiesgoGuardarBtn'); const btnNuevo=document.getElementById('cvRiesgoNuevoBtn'); const st=document.getElementById('cvRiesgoStatus'); const vigencia=document.getElementById('cvRiesgoVigencia');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(vigencia) vigencia.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(nivelEl) nivelEl.disabled=false; return; } 
    const d=j.data; 
    // NO cargar autom√°ticamente la fecha - permitir ingreso manual
    // if(fechaEl) { try{ setFechaConOverlay('cvRiesgoFecha', d.fecha||'', { dispatch: false }); } catch(_){ fechaEl.value=d.fecha||''; } } 
    if(nivelEl) nivelEl.value=d.riesgo_nivel||''; 
    const fechaEspCvR = formatearFechaEspanol(d.fecha);
    const creadoEspCvR = formatearFechaEspanol(d.creado_en);
    box.style.display='block'; box.textContent=`√öltimo: ${fechaEspCvR} ‚Ä¢ ${String(d.riesgo_nivel||'').toUpperCase()} ‚Ä¢ ${creadoEspCvR}`;
        // Desactivar bloqueo por a√±o - permitir editar fechas siempre
        const lock = false; // const y=(new Date()).getFullYear(); const dy=new Date(String(d.fecha||'')+"T00:00:00").getFullYear(); const lock=(y===dy);
        if(lock){ 
            if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Vigencia hasta 31/12/${y}.`; 
            if(fechaEl) fechaEl.disabled=true; if(nivelEl) nivelEl.disabled=true; if(btnGuardar) btnGuardar.disabled=true; 
            if(btnNuevo) { btnNuevo.style.display='inline-flex'; btnNuevo.title='Crear nuevo registro y mover el actual al hist√≥rico'; }
            if(vigencia) { vigencia.style.display='inline'; vigencia.textContent=`‚è∞ Registro v√°lido hasta 31/12/${y} - Pr√≥ximo registro en ${y+1}`; }
        }
        else{ 
            if(st && st.textContent.startsWith('üîí')) st.textContent=''; 
            if(fechaEl) fechaEl.disabled=false; if(nivelEl) nivelEl.disabled=false; if(btnGuardar) btnGuardar.disabled=false; 
            if(btnNuevo) btnNuevo.style.display='none'; 
            if(vigencia) vigencia.style.display='none';
        }
    }catch(_e){ box.style.display='none'; } 
}
async function cargarCvRiesgoHistorial(){ const run=runRaw(); const cont=document.getElementById('cvRiesgoHist'); const tbody=document.getElementById('cvRiesgoHistBody'); if(!run){ cont.style.display='none'; return; } try{ const r=await fetch('/api/cardiovascular/riesgo/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; } cont.style.display='block'; tbody.innerHTML=j.data.map(d=>`<tr><td>${formatearFechaEspanol(d.fecha)}</td><td>${d.riesgo_nivel}</td><td>${formatearFechaEspanol(d.creado_en)}</td></tr>`).join(''); }catch(_e){ cont.style.display='none'; } }

function iniciarNuevoCvRiesgo(){ 
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de Riesgo Cardiovascular? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('cvRiesgoFecha'); const nivelEl=document.getElementById('cvRiesgoNivel'); const btnGuardar=document.getElementById('cvRiesgoGuardarBtn'); const btnNuevo=document.getElementById('cvRiesgoNuevoBtn'); const vigencia=document.getElementById('cvRiesgoVigencia');
    if(fechaEl){ fechaEl.disabled=false; try{ setFechaConOverlay('cvRiesgoFecha','', { dispatch:true }); } catch(_){ fechaEl.value=''; } } 
    if(nivelEl){ nivelEl.disabled=false; nivelEl.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    if(vigencia) vigencia.style.display='none';
    const st=document.getElementById('cvRiesgoStatus'); 
    if(st) st.textContent='üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}

// ====== Insulina ======
async function guardarInsulina() {
    const run = runRaw(); 
    if (!run) { 
        alert('Ingrese RUN'); 
        return; 
    }
    
    const fecha = (document.getElementById('insulinaFechaReal')?.value) || '';
    const tratamientoSi = document.getElementById('tratamientoInsulina_si')?.checked;
    const tratamientoNo = document.getElementById('tratamientoInsulina_no')?.checked;
    const st = document.getElementById('insulinaStatus');
    
    if (!fecha) { 
        st.textContent = 'Ingrese fecha de evaluaci√≥n'; 
        return; 
    }
    
    if (!tratamientoSi && !tratamientoNo) { 
        st.textContent = 'Seleccione una opci√≥n de tratamiento'; 
        return; 
    }
    
    st.textContent = 'Guardando...';
    const fechaDB = convertirFechaParaDB(fecha);
    const enTratamiento = tratamientoSi === true;
    
    try {
        const resp = await fetch('/api/insulina', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({
                run, 
                fecha_evaluacion: fechaDB, 
                en_tratamiento: enTratamiento
            })
        });
        
        const j = await resp.json();
        
        if (j.success) { 
            st.textContent = 'Guardado exitosamente';
            await cargarInsulinaUltimo(); 
            await cargarInsulinaHistorial(); 
        } else { 
            st.textContent = 'Error: ' + (j.error || 'Error desconocido'); 
        }
    } catch (e) { 
        st.textContent = 'Error de conexi√≥n'; 
    }
}

async function cargarInsulinaUltimo() {
    const run = runRaw(); 
    const box = document.getElementById('insulinaUltimoRegistro'); 
    
    if (!run) { 
        box.style.display = 'none'; 
        return; 
    }
    
    try {
        const r = await fetch('/api/insulina/' + run); 
        const j = await r.json();
        
        const fechaEl = document.getElementById('insulinaFechaReal');
        const siEl = document.getElementById('tratamientoInsulina_si');
        const noEl = document.getElementById('tratamientoInsulina_no');
        const btnGuardar = document.getElementById('insulinaGuardarBtn');
        const btnNuevo = document.getElementById('insulinaNuevoBtn');
        const vigencia = document.getElementById('insulinaVigencia');
        const st = document.getElementById('insulinaStatus');
        
        if (!j.success || !j.found) { 
            box.style.display = 'none'; 
            if (btnNuevo) btnNuevo.style.display = 'none'; 
            if (vigencia) vigencia.style.display = 'none';
            if (btnGuardar) btnGuardar.disabled = false;
            if (fechaEl) fechaEl.disabled = false;
            if (siEl) siEl.disabled = false;
            if (noEl) noEl.disabled = false;
            return; 
        }
        
        const d = j.data;
        
        // Verificar vigencia de 1 a√±o
        const fechaRegistro = new Date(d.fecha_evaluacion + 'T00:00:00');
        const hoy = new Date();
        const diasTranscurridos = Math.floor((hoy - fechaRegistro) / (1000 * 60 * 60 * 24));
        const vigente = diasTranscurridos < 365;
        
        if (vigente) {
            // Bloquear campos - registro vigente
            if (fechaEl) {
                fechaEl.disabled = true;
                fechaEl.placeholder = `Bloqueado hasta ${formatearFechaEspanol(new Date(fechaRegistro.getTime() + 365 * 24 * 60 * 60 * 1000))}`;
                fechaEl.value = formatearFechaEspanol(d.fecha_evaluacion);
            }
            if (siEl) siEl.disabled = true;
            if (noEl) noEl.disabled = true;
            if (btnGuardar) btnGuardar.disabled = true;
            if (btnNuevo) btnNuevo.style.display = 'inline-block';
            if (vigencia) vigencia.style.display = 'block';
            
            // Marcar el radio button correspondiente
            if (d.en_tratamiento) {
                if (siEl) siEl.checked = true;
            } else {
                if (noEl) noEl.checked = true;
            }
        } else {
            // Registro expirado - desbloquear
            if (fechaEl) fechaEl.disabled = false;
            if (siEl) siEl.disabled = false;
            if (noEl) noEl.disabled = false;
            if (btnGuardar) btnGuardar.disabled = false;
            if (btnNuevo) btnNuevo.style.display = 'none';
            if (vigencia) vigencia.style.display = 'none';
        }
        
        const fechaEsp = formatearFechaEspanol(d.fecha_evaluacion);
        const creadoEsp = formatearFechaEspanol(d.created_at);
        const tratamientoTexto = d.en_tratamiento ? 'S√ç' : 'NO';
        
        box.style.display = 'block';
        document.getElementById('insulinaUltimoTexto').textContent = 
            `${fechaEsp} ‚Ä¢ Tratamiento: ${tratamientoTexto} ‚Ä¢ Registrado: ${creadoEsp}`;
            
    } catch (e) { 
        box.style.display = 'none'; 
    }
}

async function cargarInsulinaHistorial() {
    const run = runRaw(); 
    const cont = document.getElementById('insulinaHist'); 
    const tbody = document.getElementById('insulinaHistBody'); 
    
    if (!run) { 
        cont.style.display = 'none'; 
        return; 
    }
    
    try {
        const r = await fetch('/api/insulina/historial/' + run); 
        const j = await r.json();
        
        if (!j.success || !j.count) { 
            cont.style.display = 'none'; 
            return; 
        }
        
        cont.style.display = 'block';
        tbody.innerHTML = j.data.map(d => 
            `<tr>
                <td style="border:1px solid #e2e8f0; padding:4px;">${formatearFechaEspanol(d.fecha_evaluacion)}</td>
                <td style="border:1px solid #e2e8f0; padding:4px;">${d.en_tratamiento ? 'S√ç' : 'NO'}</td>
                <td style="border:1px solid #e2e8f0; padding:4px;">${formatearFechaEspanol(d.created_at)}</td>
            </tr>`
        ).join('');
    } catch (e) { 
        cont.style.display = 'none'; 
    }
}

function iniciarNuevoInsulina() {
    if (!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de Insulina? El registro actual se mover√° al hist√≥rico.')) return;
    
    const fechaEl = document.getElementById('insulinaFechaReal');
    const siEl = document.getElementById('tratamientoInsulina_si');
    const noEl = document.getElementById('tratamientoInsulina_no');
    const btnGuardar = document.getElementById('insulinaGuardarBtn');
    const btnNuevo = document.getElementById('insulinaNuevoBtn');
    const vigencia = document.getElementById('insulinaVigencia');
    const st = document.getElementById('insulinaStatus');
    
    // Desbloquear todos los campos
    if (fechaEl) { 
        fechaEl.disabled = false; 
        fechaEl.placeholder = 'dd/mm/aaaa';
        fechaEl.value = ''; 
    }
    if (siEl) { 
        siEl.disabled = false; 
        siEl.checked = false; 
    }
    if (noEl) { 
        noEl.disabled = false; 
        noEl.checked = false; 
    }
    if (btnGuardar) btnGuardar.disabled = false;
    if (btnNuevo) btnNuevo.style.display = 'none';
    if (vigencia) vigencia.style.display = 'none';
    
    if (st) st.textContent = 'üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}

// ====== Actividad f√≠sica ======
async function guardarActividadFisica(){ const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; } const fecha=(document.getElementById('cvActFecha')?.value)||''; const activo=(document.getElementById('cvActActivo')?.value)||''; const st=document.getElementById('cvActStatus'); if(!fecha){ st.textContent='Ingrese fecha'; return; } if(!activo){ st.textContent='Seleccione opci√≥n'; return; } st.textContent='Guardando...'; const fechaDB = convertirFechaParaDB(fecha); try{ const resp=await fetch('/api/cardiovascular/actividad',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha: fechaDB, activo: activo==='si'})}); const j=await resp.json(); if(j.success){ st.textContent='Guardado'; await cargarActividadUltimo(); await cargarActividadHistorial(); } else { st.textContent='Error: '+(j.error||''); } }catch(_e){ st.textContent='Error red'; } }
async function cargarActividadUltimo(){
    const run=runRaw(); const box=document.getElementById('cvActUltimo'); if(!run){ box.style.display='none'; return; }
    try{
        const r=await fetch('/api/cardiovascular/actividad/'+run); const j=await r.json();
        const fechaEl=document.getElementById('cvActFecha'); const actEl=document.getElementById('cvActActivo'); const btnGuardar=document.getElementById('cvActGuardarBtn'); const btnNuevo=document.getElementById('cvActNuevoBtn'); const st=document.getElementById('cvActStatus'); const vigencia=document.getElementById('cvActVigencia');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(vigencia) vigencia.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(actEl) actEl.disabled=false; return; }
    const d=j.data; 
    // NO cargar autom√°ticamente la fecha - permitir ingreso manual
    // try{ setFechaConOverlay('cvActFecha', d.fecha||'', { dispatch: false }); } catch(_){ fechaEl.value=d.fecha||''; } 
    actEl.value = d.activo? 'si':'no'; 
    const fechaEspAct = formatearFechaEspanol(d.fecha); 
    const creadoEspAct = formatearFechaEspanol(d.creado_en); 
    box.style.display='block'; box.textContent=`√öltimo: ${fechaEspAct} ‚Ä¢ ${d.activo? 'Activo':'No activo'} ‚Ä¢ ${creadoEspAct}`;
        // Desactivar bloqueo por a√±o - permitir editar fechas siempre
        const lock = false; // const y=(new Date()).getFullYear(); const dy=new Date(String(d.fecha||'')+"T00:00:00").getFullYear(); const lock=(y===dy);
        if(lock){ 
            if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Vigencia hasta 31/12/${y}.`; 
            if(fechaEl) fechaEl.disabled=true; if(actEl) actEl.disabled=true; if(btnGuardar) btnGuardar.disabled=true; 
            if(btnNuevo) { btnNuevo.style.display='inline-flex'; btnNuevo.title='Crear nuevo registro y mover el actual al hist√≥rico'; }
            if(vigencia) { vigencia.style.display='inline'; vigencia.textContent=`‚è∞ Registro v√°lido hasta 31/12/${y} - Pr√≥ximo registro en ${y+1}`; }
        }
        else{ 
            if(st && st.textContent.startsWith('üîí')) st.textContent=''; 
            if(fechaEl) fechaEl.disabled=false; if(actEl) actEl.disabled=false; if(btnGuardar) btnGuardar.disabled=false; 
            if(btnNuevo) btnNuevo.style.display='none'; 
            if(vigencia) vigencia.style.display='none';
        }
    }catch(_e){ box.style.display='none'; }
}
function iniciarNuevoActividadFisica(){ 
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de Actividad F√≠sica? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('cvActFecha'); const actEl=document.getElementById('cvActActivo'); const btnGuardar=document.getElementById('cvActGuardarBtn'); const btnNuevo=document.getElementById('cvActNuevoBtn'); const vigencia=document.getElementById('cvActVigencia');
    if(fechaEl){ fechaEl.disabled=false; try{ setFechaConOverlay('cvActFecha','', { dispatch:true }); } catch(_){ fechaEl.value=''; } } 
    if(actEl){ actEl.disabled=false; actEl.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    if(vigencia) vigencia.style.display='none';
    const st=document.getElementById('cvActStatus'); 
    if(st) st.textContent='üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}
async function cargarActividadHistorial(){ const run=runRaw(); const cont=document.getElementById('cvActHist'); const tbody=document.getElementById('cvActHistBody'); if(!run){ cont.style.display='none'; return; } try{ const r=await fetch('/api/cardiovascular/actividad/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; } cont.style.display='block'; tbody.innerHTML=j.data.map(d=>`<tr><td>${formatearFechaEspanol(d.fecha)}</td><td>${d.activo? 'S√≠':'No'}</td><td>${formatearFechaEspanol(d.creado_en)}</td></tr>`).join(''); }catch(_e){ cont.style.display='none'; } }

// ====== Tabaquismo ======
async function guardarTabaquismo(){ const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; } const fecha=(document.getElementById('cvTabFecha')?.value)||''; const fumador=(document.getElementById('cvTabFumador')?.value)||''; const st=document.getElementById('cvTabStatus'); if(!fecha){ st.textContent='Ingrese fecha'; return; } if(!fumador){ st.textContent='Seleccione opci√≥n'; return; } st.textContent='Guardando...'; const fechaDB = convertirFechaParaDB(fecha); try{ const resp=await fetch('/api/cardiovascular/tabaquismo',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha: fechaDB, fumador: fumador==='si'})}); const j=await resp.json(); if(j.success){ st.textContent='Guardado'; await cargarTabaquismoUltimo(); await cargarTabaquismoHistorial(); } else { st.textContent='Error: '+(j.error||''); } }catch(_e){ st.textContent='Error red'; } }
async function cargarTabaquismoUltimo(){
    const run=runRaw(); const box=document.getElementById('cvTabUltimo'); if(!run){ box.style.display='none'; return; }
    try{
        const r=await fetch('/api/cardiovascular/tabaquismo/'+run); const j=await r.json();
        const fechaEl=document.getElementById('cvTabFecha'); const sel=document.getElementById('cvTabFumador'); const btnGuardar=document.getElementById('cvTabGuardarBtn'); const btnNuevo=document.getElementById('cvTabNuevoBtn'); const st=document.getElementById('cvTabStatus'); const vigencia=document.getElementById('cvTabVigencia');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(vigencia) vigencia.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(sel) sel.disabled=false; return; }
    const d=j.data; 
    // NO cargar autom√°ticamente la fecha - permitir ingreso manual
    // try{ setFechaConOverlay('cvTabFecha', d.fecha||'', { dispatch: false }); } catch(_){ fechaEl.value=d.fecha||''; } 
    sel.value=d.fumador? 'si':'no'; 
    const fechaEspTab = formatearFechaEspanol(d.fecha); 
    const creadoEspTab = formatearFechaEspanol(d.creado_en); 
    box.style.display='block'; box.textContent=`√öltimo: ${fechaEspTab} ‚Ä¢ ${d.fumador? 'Fumador':'No fumador'} ‚Ä¢ ${creadoEspTab}`;
        // Desactivar bloqueo por a√±o - permitir editar fechas siempre
        const lock = false; // const y=(new Date()).getFullYear(); const dy=new Date(String(d.fecha||'')+"T00:00:00").getFullYear(); const lock=(y===dy);
        if(lock){ 
            if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Vigencia hasta 31/12/${y}.`; 
            if(fechaEl) fechaEl.disabled=true; if(sel) sel.disabled=true; if(btnGuardar) btnGuardar.disabled=true; 
            if(btnNuevo) { btnNuevo.style.display='inline-flex'; btnNuevo.title='Crear nuevo registro y mover el actual al hist√≥rico'; }
            if(vigencia) { vigencia.style.display='inline'; vigencia.textContent=`‚è∞ Registro v√°lido hasta 31/12/${y} - Pr√≥ximo registro en ${y+1}`; }
        }
        else{ 
            if(st && st.textContent.startsWith('üîí')) st.textContent=''; 
            if(fechaEl) fechaEl.disabled=false; if(sel) sel.disabled=false; if(btnGuardar) btnGuardar.disabled=false; 
            if(btnNuevo) btnNuevo.style.display='none'; 
            if(vigencia) vigencia.style.display='none';
        }
    }catch(_e){ box.style.display='none'; }
}
function iniciarNuevoTabaquismo(){ 
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de Tabaquismo? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('cvTabFecha'); const sel=document.getElementById('cvTabFumador'); const btnGuardar=document.getElementById('cvTabGuardarBtn'); const btnNuevo=document.getElementById('cvTabNuevoBtn'); const vigencia=document.getElementById('cvTabVigencia');
    if(fechaEl){ fechaEl.disabled=false; try{ setFechaConOverlay('cvTabFecha','', { dispatch:true }); } catch(_){ fechaEl.value=''; } } 
    if(sel){ sel.disabled=false; sel.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    if(vigencia) vigencia.style.display='none';
    const st=document.getElementById('cvTabStatus'); 
    if(st) st.textContent='üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}
async function cargarTabaquismoHistorial(){ const run=runRaw(); const cont=document.getElementById('cvTabHist'); const tbody=document.getElementById('cvTabHistBody'); if(!run){ cont.style.display='none'; return; } try{ const r=await fetch('/api/cardiovascular/tabaquismo/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; } cont.style.display='block'; tbody.innerHTML=j.data.map(d=>`<tr><td>${formatearFechaEspanol(d.fecha)}</td><td>${d.fumador? 'S√≠':'No'}</td><td>${formatearFechaEspanol(d.creado_en)}</td></tr>`).join(''); }catch(_e){ cont.style.display='none'; } }

// ====== Protocolo HEARTS ======
async function guardarHearts(){ const run=runRaw(); if(!run){ alert('Ingrese RUN'); return; } const fecha=(document.getElementById('cvHeartsFecha')?.value)||''; const en=(document.getElementById('cvHeartsEn')?.value)||''; const st=document.getElementById('cvHeartsStatus'); if(!fecha){ st.textContent='Ingrese fecha'; return; } if(!en){ st.textContent='Seleccione opci√≥n'; return; } st.textContent='Guardando...'; const fechaDB = convertirFechaParaDB(fecha); try{ const resp=await fetch('/api/cardiovascular/hearts',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({run, fecha: fechaDB, en_protocolo: en==='si'})}); const j=await resp.json(); if(j.success){ st.textContent='Guardado'; await cargarHeartsUltimo(); await cargarHeartsHistorial(); } else { st.textContent='Error: '+(j.error||''); } }catch(_e){ st.textContent='Error red'; } }
async function cargarHeartsUltimo(){ 
    const run=runRaw(); const box=document.getElementById('cvHeartsUltimo'); if(!run){ box.style.display='none'; return; } 
    try{ 
        const r=await fetch('/api/cardiovascular/hearts/'+run); const j=await r.json(); 
        const fechaEl=document.getElementById('cvHeartsFecha'); const enEl=document.getElementById('cvHeartsEn'); const btnGuardar=document.getElementById('cvHeartsGuardarBtn'); const btnNuevo=document.getElementById('cvHeartsNuevoBtn'); const st=document.getElementById('cvHeartsStatus'); const vigencia=document.getElementById('cvHeartsVigencia');
        if(!j.success||!j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(vigencia) vigencia.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(enEl) enEl.disabled=false; return; } 
    const d=j.data; 
    // NO cargar autom√°ticamente la fecha - permitir ingreso manual
    // if(fechaEl) { try{ setFechaConOverlay('cvHeartsFecha', d.fecha||'', { dispatch: false }); } catch(_){ fechaEl.value=d.fecha||''; } } 
    if(enEl) enEl.value=d.en_protocolo? 'si':'no'; 
        const fechaEspHea = formatearFechaEspanol(d.fecha);
        const creadoEspHea = formatearFechaEspanol(d.creado_en);
        box.style.display='block'; box.textContent=`√öltimo: ${fechaEspHea} ‚Ä¢ ${d.en_protocolo? 'En protocolo':'No en protocolo'} ‚Ä¢ ${creadoEspHea}`;
        // Desactivar bloqueo por a√±o - permitir editar fechas siempre
        const lock = false; // const y=(new Date()).getFullYear(); const dy=new Date(String(d.fecha||'')+"T00:00:00").getFullYear(); const lock=(y===dy);
        if(lock){ 
            if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Vigencia hasta 31/12/${y}.`; 
            if(fechaEl) fechaEl.disabled=true; if(enEl) enEl.disabled=true; if(btnGuardar) btnGuardar.disabled=true; 
            if(btnNuevo) { btnNuevo.style.display='inline-flex'; btnNuevo.title='Crear nuevo registro y mover el actual al hist√≥rico'; }
            if(vigencia) { vigencia.style.display='inline'; vigencia.textContent=`‚è∞ Registro v√°lido hasta 31/12/${y} - Pr√≥ximo registro en ${y+1}`; }
        }
        else{ 
            if(st && st.textContent.startsWith('üîí')) st.textContent=''; 
            if(fechaEl) fechaEl.disabled=false; if(enEl) enEl.disabled=false; if(btnGuardar) btnGuardar.disabled=false; 
            if(btnNuevo) btnNuevo.style.display='none'; 
            if(vigencia) vigencia.style.display='none';
        }
    }catch(_e){ box.style.display='none'; } 
}
async function cargarHeartsHistorial(){ const run=runRaw(); const cont=document.getElementById('cvHeartsHist'); const tbody=document.getElementById('cvHeartsHistBody'); if(!run){ cont.style.display='none'; return; } try{ const r=await fetch('/api/cardiovascular/hearts/historial/'+run); const j=await r.json(); if(!j.success||!j.count){ cont.style.display='none'; return; } cont.style.display='block'; tbody.innerHTML=j.data.map(d=>`<tr><td>${formatearFechaEspanol(d.fecha)}</td><td>${d.en_protocolo? 'S√≠':'No'}</td><td>${formatearFechaEspanol(d.creado_en)}</td></tr>`).join(''); }catch(_e){ cont.style.display='none'; } }

function iniciarNuevoHearts(){ 
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de Protocolo HEARTS? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('cvHeartsFecha'); const enEl=document.getElementById('cvHeartsEn'); const btnGuardar=document.getElementById('cvHeartsGuardarBtn'); const btnNuevo=document.getElementById('cvHeartsNuevoBtn'); const vigencia=document.getElementById('cvHeartsVigencia');
    if(fechaEl){ fechaEl.disabled=false; try{ setFechaConOverlay('cvHeartsFecha','', { dispatch:true }); } catch(_){ fechaEl.value=''; } } 
    if(enEl){ enEl.disabled=false; enEl.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    if(vigencia) vigencia.style.display='none';
    const st=document.getElementById('cvHeartsStatus'); 
    if(st) st.textContent='üìù Listo para nuevo registro. El anterior se guardar√° en el hist√≥rico al guardar.';
}

// ====== Cargas autom√°ticas al cambiar RUN ======
document.addEventListener('DOMContentLoaded', ()=>{
    
    // defaults: no autocompletar fechas; usuarios deben ingresar manualmente
    const runEl=document.querySelector('input[name="run"]');
    const reloadAll=()=>{
        cargarCvRiesgoUltimo(); cargarCvRiesgoHistorial();
        cargarActividadUltimo(); cargarActividadHistorial();
        cargarTabaquismoUltimo(); cargarTabaquismoHistorial();
        cargarHeartsUltimo(); cargarHeartsHistorial();
        cargarInsulinaUltimo(); cargarInsulinaHistorial();
        // Medicaci√≥n
        try { updateMedicacionVisibility(); } catch(e){}
        cargarIecaAraUltimo(); cargarIecaAraHistorial();
        cargarAntiagregantesUltimo(); cargarAntiagregantesHistorial();
        cargarEstatinasUltimo(); cargarEstatinasHistorial();
        cargarHipoglicemiasUltimo();
        
        // Debug completo despu√©s de 3 segundos
        setTimeout(() => {
            console.log('üîç === DEBUG MEDICACI√ìN COMPLETO ===');
            const run = runRaw();
            console.log('üîç RUN actual:', run);
            
            // Verificar visibilidad de secci√≥n
            const medSection = document.getElementById('medicacionSection');
            console.log('üîç Secci√≥n medicaci√≥n:', medSection ? 'VISIBLE' : 'NO ENCONTRADA', medSection?.style.display);
            
            // Verificar patolog√≠as
            const hasPatologies = hasHtaOrRenalOrDiabetes();
            console.log('üîç Tiene patolog√≠as requeridas:', hasPatologies);
            
            // Verificar botones
            const btnIeca = document.getElementById('medIecaNuevoBtn');
            const btnAnti = document.getElementById('medAntiNuevoBtn');
            const btnEstat = document.getElementById('medEstatNuevoBtn');
            console.log('üîç Botones encontrados:', {
                'IECA': btnIeca ? 'S√ç' : 'NO',
                'Anti': btnAnti ? 'S√ç' : 'NO', 
                'Estat': btnEstat ? 'S√ç' : 'NO'
            });
            
            if(btnIeca) {
                console.log('üîç Bot√≥n IECA styles:', {
                    display: btnIeca.style.display,
                    visibility: btnIeca.style.visibility,
                    opacity: btnIeca.style.opacity
                });
            }
            
            if(btnAnti) {
                console.log('üîç Bot√≥n Anti styles:', {
                    display: btnAnti.style.display,
                    visibility: btnAnti.style.visibility,
                    opacity: btnAnti.style.opacity
                });
            }
            
            // Verificar registros actuales
            fetch('/api/medicacion/ieca_ara/'+run).then(r => r.json()).then(j => {
                console.log('üîç Respuesta API IECA:', j);
                if(j.success && j.found) {
                    console.log('üîç Fecha IECA:', j.data.fecha);
                    const year = new Date(j.data.fecha + 'T00:00:00').getFullYear();
                    console.log('üîç A√±o registro IECA:', year, 'vs a√±o actual:', new Date().getFullYear());
                }
            });
            
            fetch('/api/medicacion/antiagregantes/'+run).then(r => r.json()).then(j => {
                console.log('üîç Respuesta API Anti:', j);
                if(j.success && j.found) {
                    console.log('üîç Fecha Anti:', j.data.fecha);
                    const year = new Date(j.data.fecha + 'T00:00:00').getFullYear();
                    console.log('üîç A√±o registro Anti:', year, 'vs a√±o actual:', new Date().getFullYear());
                }
            });
            
            console.log('üîç Debug botones Nuevo (no forzamos visibilidad):', {btnIeca, btnAnti, btnEstat});
            console.log('üîç === FIN DEBUG MEDICACI√ìN ===');
        }, 3000);
        // Actualizar visibilidad Pie DM
        try { updatePieDmVisibility(); } catch(e){}
        (function(){
            const esDiabetico = hasDiabetesDiagnosed();
            const secCur = document.getElementById('curacionPieSection');
            const secInsulina = document.getElementById('tratamientoInsulinaSection');
            if(esDiabetico){
                if(secCur) secCur.style.display='block';
                if(secInsulina) secInsulina.style.display='block';
                // Podolog√≠a / Hipoglicemias / Curaciones
                cargarPodologiaUltimo(); cargarPodologiaHistorial();
                cargarHipoglicemiasUltimo(); cargarHipoglicemiasHistorial();
                cargarCuracionesPieDmUltimo();
                cargarCuracionesPieDmHistorial();
                cargarInsulinaUltimo(); cargarInsulinaHistorial();
            } else {
                if(secCur) secCur.style.display='none';
                if(secInsulina) secInsulina.style.display='none';
                ['podologiaUltimo','podologiaHist','hipoUltimo','hipoHist','curacionPieUltimo','curacionPieHist'].forEach(id=>{
                    const el=document.getElementById(id); if(el) el.style.display='none';
                });
            }
        })();
    };
    if(runEl){ 
        // Solo cargar autom√°ticamente si ya hay un RUN v√°lido al cargar la p√°gina
        if(runEl.value.trim() && runEl.value.length >= 8) {
            setTimeout(reloadAll, 800); 
        }
    }
    const sel=document.getElementById('curacionPieEnCurso'); if(sel){ sel.addEventListener('change', updateCuracionPieTipoVisibility); updateCuracionPieTipoVisibility(); }

        // Observador: si las patolog√≠as se marcan/desmarcan por script, actualizar visibilidad Pie DM
        try{
            const patCont=document.getElementById('patologias-ecicep-container') || document.body;
            const obs=new MutationObserver((mutList)=>{
                for(const m of mutList){
                    if(m.type==='attributes' && m.target && m.target.classList && m.target.classList.contains('patologia-checkbox') && m.attributeName==='checked'){
                        updatePieDmVisibility();
                        try { updateMedicacionVisibility(); } catch(_){}
                        break;
                    }
                }
            });
            obs.observe(patCont, { subtree:true, attributes:true, attributeFilter:['checked'] });
        }catch(_e){ /* noop */ }
});
</script>

<script>
// ==== Ex√°menes Diabetes (Tratamiento Insulina / Fondo de Ojos) ====
async function postExamenesDiabetes(payload){
    try{
        const resp = await fetch('/api/examenes/diabetes', {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(!data.success) throw new Error(data.error || 'Error no especificado');
        const st = document.getElementById('statusGuardarPieDM');
        if(st){ st.textContent = 'Guardado diab√©ticos ‚úì'; setTimeout(()=>{ if(st.textContent==='Guardado diab√©ticos ‚úì') st.textContent=''; }, 2000); }
        return data;
    }catch(e){ console.error('‚ùå Error guardando ex√°menes diabetes', e); alert('Error guardando datos de diabetes: ' + e.message); }
}

function getRunActual(){ return (document.querySelector('input[name="run"]')?.value || '').trim(); }

// Flags de control para autoguardado en secciones espec√≠ficas
// Solicitud: desactivar autoguardado en Atenci√≥n Podol√≥gica e Hipoglicemias recurrentes
const AUTOGUARDADO_PODOLOGIA = false;
const AUTOGUARDADO_HIPO = false;

// Listeners de UI
document.addEventListener('change', (e)=>{
    if(e.target && (e.target.id === 'tratamientoInsulina_si' || e.target.id === 'tratamientoInsulina_no')){
        const run = getRunActual(); 
        if(!run) return;
        // Validar que el RUN est√© completo antes de proceder
        const runLimpio = run.replace(/[^0-9kK]/g, '');
        if (runLimpio.length < 8 || !dvValido(normalizarRun(run))) {
            console.log('‚è≥ RUN incompleto o inv√°lido, omitiendo guardado de tratamiento insulina');
            return;
        }
        const activo = document.getElementById('tratamientoInsulina_si')?.checked === true;
        postExamenesDiabetes({ run, tratamiento_insulina: activo }).then(()=>updateDiabetesExtrasEstado());
    }
    if(e.target && (e.target.id === 'fondoOjosFecha' || e.target.id === 'fondoOjosEstado')){
        const run = getRunActual(); 
        if(!run) return;
        // Validar que el RUN est√© completo antes de proceder
        const runLimpio = run.replace(/[^0-9kK]/g, '');
        if (runLimpio.length < 8 || !dvValido(normalizarRun(run))) {
            console.log('‚è≥ RUN incompleto o inv√°lido, omitiendo guardado de fondo de ojos');
            return;
        }
        clearTimeout(window._debounceFondoOjos);
        window._debounceFondoOjos = setTimeout(()=>{
            const runLimpio = run.replace(/[^0-9kK]/gi, '');
            if (runLimpio.length < 8 || !dvValido(normalizarRun(run))) {
                console.log('‚è≥ RUN incompleto o inv√°lido, omitiendo guardado de fondo ojos');
                return;
            }
            const fecha = document.getElementById('fondoOjosFecha')?.value || '';
            const estado = document.getElementById('fondoOjosEstado')?.value || '';
                postExamenesDiabetes({ run, fondo_ojos: { fecha, estado } }).then(async ()=>{ updateDiabetesExtrasEstado(); await cargarHistorialFondoOjos(run); });
        }, 500);
    }
    // Auto-guardar: Podolog√≠a (desactivado por defecto)
    if(AUTOGUARDADO_PODOLOGIA && e.target && (e.target.id === 'podologiaToggle' || e.target.id === 'podologiaFecha')){
        const run=runRaw(); if(!run || !hasDiabetesDiagnosed()) return;
        clearTimeout(window._debouncePodologia);
        window._debouncePodologia = setTimeout(()=>{ guardarPodologia(); }, 400);
    }
    // Auto-guardar: Hipoglicemias recurrentes (desactivado por defecto)
    if(AUTOGUARDADO_HIPO && e.target && (e.target.id === 'hipoRecurrenteToggle' || e.target.id === 'hipoFecha')){
        const run=runRaw(); if(!run || !hasDiabetesDiagnosed()) return;
        clearTimeout(window._debounceHipo);
        window._debounceHipo = setTimeout(()=>{ guardarHipoglicemias(); }, 400);
    }
});

// Precarga desde servidor para popular UI
async function preloadDiabetesExamFields(run){
    try{
        // Tratamiento insulina
        const [tiResp, foResp] = await Promise.all([
            fetch(`/api/exmenes/${encodeURIComponent(run)}?codigo=tratamiento_insulina`).then(r=>r.json()).catch(()=>null),
            fetch(`/api/exmenes/${encodeURIComponent(run)}?codigo=fondo_ojos`).then(r=>r.json()).catch(()=>null)
        ]);
        if(tiResp && tiResp.success && Array.isArray(tiResp.examenes) && tiResp.examenes.length){
            const row = tiResp.examenes[0];
            const activo = (row.estado||'').toLowerCase() === 'activo';
            const si = document.getElementById('tratamientoInsulina_si');
            const no = document.getElementById('tratamientoInsulina_no');
            if(activo){ if(si) si.checked = true; } else { if(no) no.checked = true; }
        }
        if(foResp && foResp.success && Array.isArray(foResp.examenes) && foResp.examenes.length){
            const row = foResp.examenes[0];
            const fecha = row.examen_fecha || '';
            const notas = row.notas || '';
            const f = document.getElementById('fondoOjosFecha'); if(f && fecha) f.value = fecha;
            const s = document.getElementById('fondoOjosEstado'); if(s && notas) s.value = notas;
        }
            updateDiabetesExtrasEstado();
            await cargarHistorialFondoOjos(run);
    }catch(e){ console.warn('No se pudo precargar ex√°menes diabetes', e); }
}

    function updateDiabetesExtrasEstado(){
        const cont = document.getElementById('diabetesExtrasEstado'); if(!cont) return;
        const ins = document.getElementById('tratamientoInsulina_si');
        const f = document.getElementById('fondoOjosFecha');
        const s = document.getElementById('fondoOjosEstado');
        const insTxt = (ins && ins.checked) ? 'Activo' : 'No activo';
        const fecha = f && f.value ? f.value : '‚Äî';
        const estado = s && s.value ? s.options[s.selectedIndex].text : '‚Äî';
        cont.innerHTML = `<strong>Tratamiento con insulina:</strong> ${insTxt} ¬∑ <strong>Fondo de ojos:</strong> ${estado} (${fecha})`;
    }
    async function cargarHistorialFondoOjos(run){
        const cont = document.getElementById('historialFondoOjos');
        const body = document.getElementById('historialFondoOjosBody');
        if(!cont || !body) return;
        try{
            const resp = await fetch(`/api/exmenes/${encodeURIComponent(run)}?codigo=fondo_ojos&solo=realizados`);
            const data = await resp.json();
            if(!data.success){ cont.style.display='none'; return; }
            const rows = (data.examenes||[]).filter(r=>String(r.estado||'').toLowerCase()==='realizado');
            if(rows.length===0){
                body.innerHTML = '<tr><td colspan="4" style="padding:6px 8px; border:1px solid #e2e8f0; text-align:center; color:#64748b;">Sin datos</td></tr>';
                cont.style.display='none';
                return;
            }
            cont.style.display='block';
            body.innerHTML = rows.map(r=>{
                const creado = (r.created_at||'').replace('T',' ').slice(0,10);
                const estado = (r.notas||'').trim() || '‚Äî';
                return `<tr>
                    <td style=\"padding:4px 6px; border:1px solid #e2e8f0;\">${r.examen_fecha||''}</td>
                    <td style=\"padding:4px 6px; border:1px solid #e2e8f0; font-weight:600;\">${estado}</td>
                    <td style=\"padding:4px 6px; border:1px solid #e2e8f0;\">${creado}</td>
                    <td style=\"padding:4px 6px; border:1px solid #e2e8f0;\">${r.id}</td>
                </tr>`;
            }).join('');
        }catch(e){ cont.style.display='none'; }
    }
</script>
                <small>Selecciona las patolog√≠as que correspondan.</small>
                <hr>

                <!-- ====== ADULTO MAYOR UI ====== -->
                <div class="piedm-wrapper" id="adultoMayorSection" style="display:none; margin-bottom:24px;">
                  <div class="piedm-header" style="background:#f1f5f9;">
                                        <h3>üë¥ Evaluaci√≥n Adulto Mayor <span id="adultoMayorSummary" class="am-summary" style="display:none;"></span> <span id="adultoMayorEdadInfo" style="font-size:12px; color:#64748b; margin-left:10px;"></span></h3>
                  </div>
                  <div class="piedm-toggle-panel" style="padding:18px 22px;">
                    <!-- IMPORTANTE: evitar <form> anidado. Cambiado a <div>. -->
                    <div id="evaluacionAdultoMayorForm">
                      <div class="piedm-grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; align-items:start;">
                        <div class="piedm-field">
                          <label class="piedm-label" for="amFechaAplicacion">Fecha aplicaci√≥n</label>
                          <input type="text" id="amFechaAplicacion" name="amFechaAplicacion" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" style="width:100%;" autocomplete="off">
                        </div>
                                                <div class="piedm-field">
                                                    <label class="piedm-label" for="amMasamaFecha">Fecha checklist MASAMA</label>
                                                    <input type="text" id="amMasamaFecha" name="amMasamaFecha" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" style="width:100%;" autocomplete="off">
                                                </div>
                        <div class="piedm-field">
                                                    <label class="piedm-label" for="amResultado">Condici√≥n de funcionalidad (EFAM)</label>
                                                    <select id="amResultado" name="amResultado" style="min-width:240px;">
                                                                                                                <option value="">-- Seleccionar --</option>
                                                                                                                <option>Autovalente</option>
                                                                                                                <option>Autovalente con Riesgo</option>
                                                                                                                <option>Riesgo de Dependencia</option>
                                                    </select>
                        </div>
                                                                        <div class="piedm-field">
                                                                            <label class="piedm-label" for="amTugSeg">TUG (segundos)</label>
                                                                            <div style="display:flex; align-items:center; gap:8px;">
                                                                                <input type="number" step="0.1" id="amTugSeg" name="amTugSeg" placeholder="Ej: 12.5" style="max-width:120px;">
                                                                                <span id="amTugClasChip" class="imc-chip" style="display:none;"></span>
                                                                            </div>
                                                                            <div id="amTugResBox" style="display:none; margin-top:6px; font-size:12.5px; color:#334155;">
                                                                                <div><strong>Resultado TUG:</strong> <span id="amTugResTexto"></span></div>
                                                                                <div style="color:#64748b; margin-top:3px;">Normal ‚â§ 10 &nbsp;‚Ä¢&nbsp; Leve 11‚Äì19 &nbsp;‚Ä¢&nbsp; Alto ‚â• 20</div>
                                                                            </div>
                                                                        </div>
                                                                                                <div class="piedm-field">
                                                                                                    <label class="piedm-label" for="amUnipDer">Unipodal Der (seg)</label>
                                                                                                    <input type="number" step="0.1" id="amUnipDer" name="amUnipDer" placeholder="Ej: 7">
                                                                                                </div>
                                                                                                <div class="piedm-field">
                                                                                                    <label class="piedm-label" for="amUnipIzq">Unipodal Izq (seg)</label>
                                                                                                    <input type="number" step="0.1" id="amUnipIzq" name="amUnipIzq" placeholder="Ej: 6">
                                                                                                </div>
                                                                                                                                                <div class="piedm-field" style="grid-column:1 / -1; margin-top:6px;">
                                                                                                                                                    <div style="display:inline-flex; align-items:center; gap:8px; width:fit-content;">
                                                                                                                                                        <input type="checkbox" id="amPruebasNc" name="amPruebasNc" style="margin:0;">
                                                                                                                                                        <label for="amPruebasNc" style="margin:0; white-space:nowrap; font-weight:600;">No corresponde (TUG / UNIPODAL)</label>
                                                                                                                                                    </div>
                                                                                                                                                </div>
                      </div>
                                            <div class="piedm-field" style="grid-column:1/-1;">
                                                <label class="piedm-label" for="amObservaciones">Observaciones (opcional)</label>
                                                <textarea id="amObservaciones" name="amObservaciones" rows="2" placeholder="Notas libres de la evaluaci√≥n" style="width:100%;"></textarea>
                                            </div>
                      <div class="piedm-actions" style="margin-top:18px;">
                        <button type="button" class="btn-base btn-calc" onclick="evaluarAdultoMayor()">‚öôÔ∏è Calcular/Guardar</button>
                        <button type="button" class="btn-base btn-reset" onclick="resetEvaluacionAdultoMayor()">üßπ Limpiar</button>
                      </div>
                      <div id="adultoMayorResultado" class="piedm-result-box" style="display:none; margin-top:10px;"></div>
                      <div id="adultoMayorStatus" class="piedm-status"></div>
                    </div>
                                        <!-- Sub-secci√≥n: Sospecha de maltrato (Adulto Mayor) -->
                                        <hr style="margin:22px 0 14px;">
                                        <div id="amMaltratoSection">
                                            <strong>üõ°Ô∏è Sospecha de maltrato (Adulto Mayor)</strong>
                                            <div class="piedm-grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; align-items:start; margin-top:8px;">
                                                <div class="piedm-field">
                                                    <label class="piedm-label" for="amMaltratoFecha">Fecha</label>
                                                    <input type="text" id="amMaltratoFecha" name="amMaltratoFecha" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" style="width:100%;" autocomplete="off">
                                                </div>
                                                <div class="piedm-field">
                                                    <label class="piedm-label" for="amMaltratoEn">Sospecha</label>
                                                    <select id="amMaltratoEn" name="amMaltratoEn">
                                                        <option value="">-- Seleccionar --</option>
                                                        <option value="si">S√≠</option>
                                                        <option value="no">No</option>
                                                    </select>
                                                </div>
                                                <div class="piedm-actions" style="align-self:end;">
                                                    <button type="button" id="amMaltratoGuardarBtn" class="btn-base btn-calc" onclick="guardarAmMaltrato()">üíæ Guardar</button>
                                                </div>
                                            </div>
                                            <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
                                                <button type="button" id="amMaltratoNuevoBtn" class="btn-base" style="display:none; background:#f59e0b; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold; margin-left:10px;" onclick="iniciarNuevoAmMaltrato()">üÜï Nuevo Registro</button>
                                                <small id="amMaltratoVigencia" style="color:#64748b; font-size:11px; display:none;">‚è∞ Vigencia: 1 a√±o desde la fecha del registro</small>
                                            </div>
                                            <div id="amMaltratoUltimo" class="piedm-result-box" style="display:none; margin-top:10px;"></div>
                                            <div id="amMaltratoStatus" class="piedm-status"></div>
                                            <div id="amMaltratoHist" style="display:none; margin-top:10px;">
                                                <strong>Historial Sospecha de maltrato:</strong>
                                                <table style="width:100%; font-size:12px; border-collapse:collapse; margin-top:6px;">
                                                    <thead>
                                                        <tr><th>Fecha</th><th>Sospecha</th><th>Creado</th><th>ID</th></tr>
                                                    </thead>
                                                    <tbody id="amMaltratoHistBody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                    <hr style="margin:22px 0 14px;">
                    <div id="adultoMayorHistorial" style="display:none;">
                      <strong>Historial:</strong>
                      <table style="width:100%; font-size:12px; border-collapse:collapse; margin-top:6px;">
                        <thead>
                          <tr>
                            <th>Fecha</th><th>Resultado</th><th>TUG</th><th>Unipodal</th><th>Vigencia hasta</th><th>Creado</th><th>ID</th>
                          </tr>
                        </thead>
                        <tbody id="adultoMayorHistorialBody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <!-- ====== FIN ADULTO MAYOR UI ====== -->

                <label for="fecha_acuerdo">Fecha del acuerdo:</label>
                <input type="text" name="fecha_acuerdo" id="fecha_acuerdo" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatearFecha(this);" onkeypress="return soloNumeros(event)" onpaste="setTimeout(() => formatearFecha(this), 0);" onblur="validarFechaCompleta(this);" inputmode="numeric" style="margin-bottom:8px;width:200px;"
                    value="{% if acuerdos and acuerdos|length > 0 and acuerdos[0]["fecha_creacion"] %}{{ acuerdos[0]["fecha_creacion"].strftime('%d/%m/%Y') }}{% else %}{{ '' }}{% endif %}">
                {% if acuerdos and acuerdos|length > 0 and acuerdos[0]["fecha_creacion"] %}
                <div style="margin-bottom: 4px;">
                    <span style="color:#0d6efd;font-weight:bold;">Fecha de creaci√≥n del acuerdo actual:</span>
                    <span style="color:#222;">{{ acuerdos[0]["fecha_creacion"].strftime('%Y-%m-%d %H:%M') }}</span>
                </div>
                {% endif %}
                <label for="acuerdos">Acuerdos (puedes modificar o agregar):</label>
                <textarea name="nuevo_acuerdo" id="nuevo_acuerdo" rows="3" style="width:100%" placeholder="Escribe un nuevo acuerdo y presiona 'Agregar Acuerdo' o 'Guardar Usuario y Control' para guardar."></textarea>
                <div style="display: flex; gap: 8px; margin: 6px 0 12px 0; flex-wrap: wrap;">
                    <button type="submit" name="agregar_acuerdo" value="1" style="font-size:13px; background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                        ‚ûï Agregar Acuerdo
                    </button>
                    <button type="button" onclick="guardarAcuerdosIndependiente()" style="font-size:13px; background: #198754; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;" title="Guardar solo los acuerdos y cumplimiento">
                        üíæ Guardar Acuerdos
                    </button>
                </div>
                <label for="cumplimiento">Cumplimiento (opcional): <span id="cumplimiento-suggested" style="color: #6c757d; display: none;">üí°</span></label>
                <select name="cumplimiento" id="cumplimiento" style="width:100%">
                    <option value="" selected disabled>Seleccionar opci√≥n de cumplimiento</option>
                    <option value="cumple">Cumple</option>
                    <option value="cumple parcialmente">Cumple parcialmente</option>
                    <option value="no cumple">No cumple</option>
                    <option value="inicio de acuerdos consensuados">Inicio de acuerdos consensuados</option>
                </select>
                <small id="cumplimiento-help" style="color: #666; display: none; margin-top: 4px;">Se recomienda seleccionar el cumplimiento cuando hay acuerdos definidos (opcional).</small>
                
                <script>
                // Cambia el color del select seg√∫n la opci√≥n elegida
                function setCumplimientoColor() {
                    var sel = document.getElementById('cumplimiento');
                    var color = '';
                    switch(sel.value) {
                        case 'cumple': color = '#4caf50'; break; // verde
                        case 'cumple parcialmente': color = '#ffc107'; break; // amarillo
                        case 'no cumple': color = '#f44336'; break; // rojo
                        default: color = '';
                    }
                    sel.style.backgroundColor = color;
                    sel.style.color = (sel.value === 'cumple parcialmente') ? '#222' : '#fff';
                }

                // Validaci√≥n condicional de cumplimiento basado en acuerdos (ahora opcional)
                function validarCumplimientoRequerido() {
                    // PROTECCI√ìN PRIORITARIA: No ejecutar si hay errores del servidor
                    if (window.HAS_ERROR) {
                        console.log('üõ°Ô∏è Validaci√≥n de cumplimiento omitida debido a error del servidor');
                        return;
                    }
                    
                    var acuerdosTextarea = document.getElementById('acuerdos');
                    var cumplimientoSelect = document.getElementById('cumplimiento');
                    var suggestedIndicator = document.getElementById('cumplimiento-suggested');
                    var helpText = document.getElementById('cumplimiento-help');
                    
                    // PROTECCI√ìN: Verificar que los elementos existen
                    if (!acuerdosTextarea || !cumplimientoSelect) {
                        console.log('‚ö†Ô∏è Elementos de cumplimiento no encontrados, omitiendo validaci√≥n');
                        return;
                    }
                    
                    var tieneAcuerdos = acuerdosTextarea.value.trim().length > 0;
                    
                    if (tieneAcuerdos) {
                        // Ya no es obligatorio, pero se sugiere
                        cumplimientoSelect.removeAttribute('required');
                        suggestedIndicator.style.display = 'inline';
                        helpText.style.display = 'block';
                        helpText.textContent = 'Se recomienda seleccionar el cumplimiento cuando hay acuerdos definidos.';
                        cumplimientoSelect.style.borderColor = '#6c757d';
                    } else {
                        cumplimientoSelect.removeAttribute('required');
                        suggestedIndicator.style.display = 'none';
                        helpText.style.display = 'none';
                        cumplimientoSelect.style.borderColor = '';
                        // Limpiar selecci√≥n si no hay acuerdos (SOLO SI NO HAY ERRORES)
                        if (!window.HAS_ERROR) {
                            cumplimientoSelect.value = '';
                        }
                        setCumplimientoColor();
                    }
                }

                document.addEventListener('DOMContentLoaded', function() {
                    var sel = document.getElementById('cumplimiento');
                    var acuerdosTextarea = document.getElementById('acuerdos');
                    
                    // Solo ejecutar si los elementos existen
                    if (sel && acuerdosTextarea) {
                        setCumplimientoColor();
                        validarCumplimientoRequerido();
                        
                        sel.addEventListener('change', setCumplimientoColor);
                        acuerdosTextarea.addEventListener('input', validarCumplimientoRequerido);
                        acuerdosTextarea.addEventListener('blur', validarCumplimientoRequerido);
                        
                        // Validaci√≥n adicional en el env√≠o del formulario
                        var form = document.getElementById('usuarioForm');
                        if (form) {
                            form.addEventListener('submit', function(e) {
                                // Sanitizar: si la secci√≥n Adulto Mayor est√° oculta, deshabilitar sus inputs para evitar validaci√≥n nativa en campos no visibles
                                try {
                                    const amSec = document.getElementById('adultoMayorSection');
                                    if (amSec && (amSec.style.display === 'none' || getComputedStyle(amSec).display === 'none')) {
                                        const amInputs = amSec.querySelectorAll('input, select, textarea');
                                        amInputs.forEach(el => { el.disabled = true; });
                                    }
                                } catch(_e){ /* noop */ }
                                try { console.log('‚û°Ô∏è [SUBMIT] Form principal disparado', { submit_action: (document.getElementById('submit_action')||{}).value, active: (document.activeElement||{}).name }); } catch(_){ }
                                // Verificar si es un submit de examen de forma robusta
                                var actionHidden = document.getElementById('submit_action');
                                var esGuardarExamen = actionHidden && actionHidden.value === 'guardar_examen';
                                if (!esGuardarExamen) {
                                    // Fallback: en algunos navegadores document.activeElement no es fiable
                                    var submitButton = document.activeElement;
                                    esGuardarExamen = submitButton && submitButton.name === 'guardar_examen';
                                }
                                try { console.log('üß™ [SUBMIT] esGuardarExamen =', esGuardarExamen); } catch(_){ }
                                
                                // Si es guardar examen, solo validar que hay un RUN
                                if (esGuardarExamen) {
                                    // Si HbA1c_examen viene vac√≠o pero HbA1c de control tiene valor, copiarlo
                                    try {
                                        var hba1cExamenInput = document.querySelector('input[name="hba1c_examen"]');
                                        var hba1cControlInput = document.querySelector('input[name="hba1c"]');
                                        if (hba1cExamenInput && (!hba1cExamenInput.value || hba1cExamenInput.value.trim() === '')) {
                                            if (hba1cControlInput && hba1cControlInput.value && hba1cControlInput.value.trim() !== '') {
                                                hba1cExamenInput.value = hba1cControlInput.value.trim();
                                            }
                                        }
                                    } catch (_) {}
                                    var runInput = document.getElementById('run');
                                    if (!runInput || !runInput.value.trim()) {
                                        e.preventDefault();
                                        try { console.warn('‚õî Bloqueado submit examen: falta RUN'); } catch(_){ }
                                        mostrarErrorAmigable('requerido', 'run', 
                                            'Debe ingresar un RUN v√°lido antes de guardar un examen.');
                                        return false;
                                    }
                                    // Validar fecha del examen requerida por backend
                                    var fechaExInput = document.querySelector('input[name="examen_fecha"]');
                                    if (!fechaExInput || !fechaExInput.value) {
                                        e.preventDefault();
                                        try { console.warn('‚õî Bloqueado submit examen: falta examen_fecha'); } catch(_){ }
                                        mostrarErrorAmigable('fecha', null, 'Debe ingresar la Fecha del Examen.');
                                        return false;
                                    }
                                    
                                    // Validar RUN para ex√°menes
                                    var runValue = runInput.value.trim();
                                    var runLimpio = runValue.replace(/[^0-9kK]/gi, '');
                                    
                                    if (runLimpio.length >= 8) {
                                        var runFormateado = runLimpio.slice(0, -1) + '-' + runLimpio.slice(-1);
                                        if (!dvValido(runFormateado)) {
                                            e.preventDefault();
                                            try { console.warn('‚õî Bloqueado submit examen: RUN con DV inv√°lido'); } catch(_){ }
                                            mostrarErrorAmigable('run', 'run', 
                                                'El RUN ingresado no es v√°lido seg√∫n el algoritmo chileno. Por favor, verifique el n√∫mero y el d√≠gito verificador.');
                                            return false;
                                        }
                                    }
                                    
                                    // Para ex√°menes, no validar otros campos obligatorios
                                    try { console.log('‚úÖ [SUBMIT] Validaciones examen OK, enviando...'); } catch(_){ }
                                    return true;
                                }
                                
                                // Para otros submit (guardar usuario), validar campos requeridos b√°sicos
                                var camposRequeridos = [
                                    {id: 'run', nombre: 'RUN'},
                                    {id: 'nombre', nombre: 'Nombre'},
                                    {id: 'fecha_nacimiento', nombre: 'Fecha de nacimiento'},
                                    {id: 'sexo', nombre: 'Sexo'}
                                ];
                                
                                for (var i = 0; i < camposRequeridos.length; i++) {
                                    var campo = document.getElementById(camposRequeridos[i].id);
                                    if (!campo || !campo.value.trim()) {
                                        e.preventDefault();
                                        mostrarErrorAmigable('requerido', camposRequeridos[i].id, 
                                            'El campo "' + camposRequeridos[i].nombre + '" es obligatorio.');
                                        return false;
                                    }
                                }
                                
                                // 2. Validar RUN antes de enviar
                                var runInput = document.getElementById('run');
                                if (runInput && runInput.value.trim()) {
                                    var runValue = runInput.value.trim();
                                    var runLimpio = runValue.replace(/[^0-9kK]/gi, '');
                                    
                                    if (runLimpio.length >= 8) {
                                        var runFormateado = runLimpio.slice(0, -1) + '-' + runLimpio.slice(-1);
                                        if (!dvValido(runFormateado)) {
                                            e.preventDefault();
                                            mostrarErrorAmigable('run', 'run', 
                                                'El RUN ingresado no es v√°lido seg√∫n el algoritmo chileno. Por favor, verifique el n√∫mero y el d√≠gito verificador.');
                                            return false;
                                        }
                                    }
                                }
                                
                                // 3. Validar edad antes de enviar
                                var fechaNacimiento = document.getElementById('fecha_nacimiento');
                                if (fechaNacimiento && fechaNacimiento.value.trim()) {
                                    var edad = calcularEdadDesde(fechaNacimiento.value);
                                    var edadNum = parseInt(edad, 10);
                                    if (!isNaN(edadNum)) {
                                        if (edadNum < 15) {
                                            e.preventDefault();
                                            mostrarErrorAmigable('fecha', 'fecha_nacimiento', 
                                                'ECICEP requiere usuarios de 15 a√±os o m√°s. Edad actual: ' + edadNum + ' a√±os. Por favor, verifica la fecha de nacimiento.');
                                            return false;
                                        } else if (edadNum > 112) {
                                            e.preventDefault();
                                            mostrarErrorAmigable('fecha', 'fecha_nacimiento', 
                                                'La edad calculada es muy alta (' + edadNum + ' a√±os). Por favor, verifica que la fecha de nacimiento sea correcta.');
                                            return false;
                                        }
                                    }
                                }
                                
                                var acuerdos = document.getElementById('acuerdos');
                                var cumplimiento = document.getElementById('cumplimiento');
                                
                                if (acuerdos && cumplimiento) {
                                    // Ya no hay validaci√≥n obligatoria - se permite enviar sin cumplimiento
                                    // Comentario: La validaci√≥n del cumplimiento ahora es opcional
                                }

                                // Convertir fechas de DD/MM/YYYY a YYYY-MM-DD antes del env√≠o
                                try {
                                    console.log('üîÑ Ejecutando conversi√≥n de fechas antes del submit...');
                                    const camposFecha = [
                                        'fecha_nacimiento',
                                        'fecha_ingreso', 
                                        'vac_influenza_fecha',
                                        'vac_covid_fecha',
                                        'ekg_fecha',
                                        'fecha_acuerdo'
                                    ];
                                    
                                    let fechasConvertidas = 0;
                                    camposFecha.forEach(function(nombreCampo) {
                                        const campo = document.getElementById(nombreCampo);
                                        if (campo && campo.value) {
                                            const fechaOriginal = campo.value.trim();
                                            console.log('üîç Revisando ' + nombreCampo + ': "' + fechaOriginal + '"');
                                            
                                            // Verificar si est√° en formato dd/mm/yyyy
                                            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(fechaOriginal)) {
                                                const partes = fechaOriginal.split('/');
                                                const dia = partes[0];
                                                const mes = partes[1];
                                                const a√±o = partes[2];
                                                const fechaPostgres = a√±o + '-' + mes.padStart(2, '0') + '-' + dia.padStart(2, '0');
                                                campo.value = fechaPostgres;
                                                fechasConvertidas++;
                                                console.log('‚úÖ Convertido ' + nombreCampo + ': ' + fechaOriginal + ' ‚Üí ' + fechaPostgres);
                                            } else {
                                                console.log('‚ö†Ô∏è ' + nombreCampo + ' no est√° en formato dd/mm/yyyy: "' + fechaOriginal + '"');
                                            }
                                        }
                                    });
                                    console.log('üéØ Total fechas convertidas antes del submit: ' + fechasConvertidas);
                                } catch (err) {
                                    console.warn('Error convirtiendo fechas:', err);
                                }

                                // Asegurar que TODAS las patolog√≠as seleccionadas se env√≠en como patologia[]
                                try {
                                    const seleccionadas = document.querySelectorAll('input.patologia-checkbox:checked');
                                    seleccionadas.forEach(cb => {
                                        if (cb.name !== 'patologia[]') {
                                            const hidden = document.createElement('input');
                                            hidden.type = 'hidden';
                                            hidden.name = 'patologia[]';
                                            hidden.value = cb.value;
                                            form.appendChild(hidden);
                                        }
                                    });
                                } catch (err) {
                                    console.warn('No se pudieron preparar todas las patolog√≠as para el env√≠o:', err);
                                }
                            });
                        }
                    } else {
                        console.log('‚ö†Ô∏è Elementos cumplimiento/acuerdos no encontrados - omitiendo inicializaci√≥n');
                    }
                });
                </script>
                <label for="observaciones">Observaciones:</label>
                <textarea name="observaciones" id="observaciones" rows="2" style="width:100%"></textarea>
                <small>Historial de acuerdos previos:</small>
                                <div style="max-height:120px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:6px; background:#f8f9fa; padding:8px; margin-bottom:8px;">
                                    <table id="tabla-acuerdos" style="width:100%; font-size:12px;">
                                        <thead>
                                            <tr style="background:#e9ecef;">
                                                <th style="padding:2px 6px;">Fecha</th>
                                                <th style="padding:2px 6px;">Acuerdo</th>
                                                <th style="padding:2px 6px;">Cumplimiento</th>
                                                <th style="padding:2px 6px;">Obs.</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ac in acuerdos %}
                                                <tr>
                                                    <td style="padding:2px 6px;">{{ ac.fecha_creacion.strftime('%Y-%m-%d %H:%M') if ac.fecha_creacion else '' }}</td>
                                                    <td style="padding:2px 6px;">{{ ac.acuerdos|e }}</td>
                                                    <td style="padding:2px 6px;">{{ ac.cumplimiento }}</td>
                                                    <td style="padding:2px 6px;">{{ ac.observaciones }}</td>
                                                </tr>
                                            {% else %}
                                                <tr><td colspan="4" style="text-align:center; color:#888;">No hay acuerdos previos.</td></tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
            </fieldset>

            <!-- Tabla de ex√°menes guardados (secci√≥n separada debajo del card de Ex√°menes) -->
            <div id="seccion-examenes-guardados" style="margin: 10px 0 18px 0;">
                <h5 style="margin-top:10px; color:#0d6efd;">Ex√°menes guardados</h5>
                <div style="overflow-x:auto;">
                    <table id="tabla-examenes" class="table table-bordered" style="width:100%; font-size:13px; border: 2px solid #333;">
                        <thead style="background-color: #f8f9fa;">
                            <tr>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center; white-space: nowrap;">Fecha del Examen</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">SO2 %</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Flujometr√≠a</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Tos</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Baciloscopia</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Creatininemia</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">EKG</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Fecha EKG</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Col</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">HDL</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">LDL</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">TAG</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Glicemia</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Microalb.</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">Microalb. valor</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">VFG</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">RAC</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">RPR</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">TSH</th>
                                <th style="border: 1px solid #333; padding: 8px; text-align: center;">HbA1c</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ex in examenes %}
                            <tr>
                                <td style="border: 1px solid #333; padding: 8px; white-space: nowrap;">{{ ex.examen_fecha }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.so2_percent }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.flujometria }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.tos %}S√≠{% else %}No{% endif %}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.baciloscopia %}S√≠{% else %}No{% endif %}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.creatinemia %}{{ "%.2f"|format(ex.creatinemia|float) }}{% endif %}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.ekg %}S√≠{% else %}No{% endif %}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.ekg_fecha }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.col }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;" class="{% if ex.hdl and usuario.sexo %}{% set sexo_norm = usuario.sexo|lower|trim %}{% if ( (sexo_norm in ['femenino','f','mujer'] and ex.hdl|float <= 50) or (sexo_norm in ['masculino','m','hombre','var√≥n','varon'] and ex.hdl|float <= 40) ) %}abnormal-hdl{% endif %}{% endif %}">{{ ex.hdl }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.ldl }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.tag }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.glicemia }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.microalbuminuria %}S√≠{% else %}No{% endif %}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.microalbuminuria_val }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.vfg }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;" class="{% if ex.rac and ex.rac|float >= 300 %}abnormal{% endif %}">{% if ex.rac %}{{ "%.2f"|format(ex.rac|float) }}{% endif %}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{% if ex.rpr %}S√≠{% else %}No{% endif %}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;">{{ ex.tsh }}</td>
                                <td style="border: 1px solid #333; padding: 8px; text-align: center;" class="hba1c-valor" data-hba1c="{{ ex.hba1c }}" data-usuario-nacimiento="{% if usuario %}{{ usuario.fecha_nacimiento }}{% endif %}">{{ ex.hba1c }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="19" style="text-align:center; color:#888; border: 1px solid #333; padding: 15px;">No hay ex√°menes registrados para este usuario.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <fieldset>
                                <legend>Control inicial</legend>
                                <label>Fecha control: <input type="date" name="fecha" style="min-width:280px;max-width:350px;"></label>
                                <label>Profesional:
                                        <select name="profesional" id="profesional" style="min-width:220px;">
                                                <option value="">-- Seleccione profesional --</option>
                                                <option value="dupla">Dupla</option>
                                                <option value="enfermero">Enfermero</option>
                                                <option value="medico">M√©dico</option>
                                                <option value="nutricionista">Nutricionista</option>
                                                <option value="tens">TENS</option>
                                                <option value="matrona">Matrona</option>
                                                <option value="psicologo">Psic√≥logo</option>
                                                <option value="asistente social">Asistente Social</option>
                                                <option value="sala era">Sala Era</option>
                                                <option value="urgencias">Urgencias</option>
                                                <option value="dentista">Dentista</option>
                                                <option value="oftalmologo">Oftalm√≥logo</option>
                                                <option value="uapo">UAPO</option>
                                                <option value="medicina interna">Medicina Interna</option>
                                                <option value="nefrologo">Nefr√≥logo</option>
                                                <option value="telediabetes">Telediabetes</option>
                                                <option value="ginecologo">Ginec√≥logo</option>
                                                <option value="politaco">POLITACO</option>
                                                <option value="receta">Receta</option>
                                                <option value="cirujano">Cirujano</option>
                                                <option value="hosp chue">Hosp CHUE</option>
                                                <option value="h lebu">H Lebu</option>
                                                <option value="h arauco">H Arauco</option>
                                        </select>
                                </label>
                                <div class="campos-linea" style="display:flex; flex-wrap:wrap; align-items:center; gap:12px;">
                                        <label>Peso: <input type="number" step="0.01" name="peso" style="width: 90px;"></label>
                                        <label>Talla (m): <input type="number" step="0.01" name="talla" placeholder="1.70" min="0.50" max="2.30" style="width: 90px;"></label>
                                        <label id="imcLiveBox" style="display:inline-flex; align-items:center; gap:6px; min-width: 180px; font-size:13px;">
                                            <strong>IMC:</strong>
                                            <span id="imcLiveValor" style="min-width:36px; display:inline-block; text-align:right;">-</span>
                                            <span id="imcLiveClas" class="imc-chip" style="display:none;"></span>
                                        </label>
                                        <label>P. Sist√≥lica: <input type="number" name="presion_sistolica" style="width: 90px;"></label>
                                        <label>P. Diast√≥lica: <input type="number" name="presion_diastolica" style="width: 95px;"></label>
                                        <label>HGT: <input type="number" step="0.01" name="hgt" style="width: 90px;"></label>
                                        <label>CC: <input type="number" step="0.01" name="cc" style="width: 90px;"></label>
                                        <label>HbA1c: <input type="number" step="0.01" name="hba1c" style="width: 90px;"></label>
                                </div>
                                                                <div id="imcHistSection" class="mini-wrapper" style="margin-top:10px; display:none;">
                                                                    <div class="mini-header">
                                                                        <div><strong>Historial IMC</strong></div>
                                                                        <div style="font-size:12px;color:#64748b;">√öltimos 10</div>
                                                                    </div>
                                                                    <div class="mini-content" style="padding:8px 12px;">
                                                                        <table style="width:100%; font-size:12px; border-collapse:collapse;">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th style="text-align:left; padding:4px 6px; border:1px solid #e2e8f0;">Fecha</th>
                                                                                    <th style="text-align:left; padding:4px 6px; border:1px solid #e2e8f0;">IMC</th>
                                                                                    <th style="text-align:left; padding:4px 6px; border:1px solid #e2e8f0;">Clasificaci√≥n</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody id="imcHistBody"></tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>

                                <!-- Bot√≥n para guardar solo Control (reubicado al card de Control) -->
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ddd; display:flex; gap:8px; align-items:center;">
                                    <button type="button" onclick="guardarControlIndependiente()" style="background: #198754; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 600;" title="Guardar solo los datos de control">
                                        üíæ Guardar Control √önicamente
                                    </button>
                                    <small style="color:#6c757d;">Guarda la ficha de control sin tocar los ex√°menes.</small>
                                </div>

                                <!-- Formulario de ingreso de ex√°menes -->
                                <hr>
                                <h4 style="margin-top:24px; color:#0d6efd;">Ingreso de Ex√°menes</h4>
                                <div id="form-examenes-container" style="background:#f8f9fa; border:1px solid #ddd; border-radius:8px; padding:12px; margin-bottom:16px;">
                                                        <!-- Fila 1: Datos principales -->
                                                        <div style="display: grid; grid-template-columns: 160px 120px 170px 80px 120px 120px 160px; gap: 12px; align-items: end; font-size:10px; margin-bottom:12px;">
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Fecha:</label>
                                                                <input type="date" name="examen_fecha" required style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">SO2%:</label>
                                                                <input type="number" step="0.01" name="so2_percent" min="0" max="100" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Flujom.:</label>
                                                                <input type="text" name="flujometria" maxlength="64" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Tos:</label>
                                                                <input type="checkbox" name="tos" style="margin-top:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Bacilo:</label>
                                                                <input type="checkbox" name="baciloscopia" style="margin-top:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">EKG:</label>
                                                                <input type="checkbox" name="ekg" style="margin-top:2px;" onchange="(function(chk){ const f=document.getElementById('ekgFecha'); if(f){ f.disabled = !chk.checked; if(!chk.checked){ try{ setFechaConOverlay('ekgFecha','',{dispatch:true}); }catch(_){ f.value=''; } } } })(this)">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Fecha EKG:</label>
                                                                <input type="text" id="ekgFecha" name="ekg_fecha" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatearFecha(this);" onkeypress="return soloNumeros(event)" onpaste="setTimeout(() => formatearFecha(this), 0);" onblur="validarFechaCompleta(this);" inputmode="numeric" style="width:100%; font-size:10px; padding:2px;" disabled>
                                                            </div>
                                                            <div>
                                                                <button type="button" id="ekgNuevoBtn" class="btn-nuevo" style="background:#10b981; color:white; border:none; padding:4px 8px; font-size:9px; border-radius:4px; cursor:pointer; display:none;" title="Nuevo registro EKG">‚≠ï Nuevo</button>
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Creat.:</label>
                                                                <input type="number" step="0.0001" name="creatinemia" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Fila 2: Perfil lip√≠dico -->
                                                        <div style="display: grid; grid-template-columns: 170px 130px 130px 130px 130px 120px 220px; gap: 12px; align-items: end; font-size:10px; margin-bottom:12px;">
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Col Total:</label>
                                                                <input type="number" step="0.01" name="col" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">HDL:</label>
                                                                <input type="number" step="0.01" name="hdl" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">LDL:</label>
                                                                <input type="number" step="0.01" name="ldl" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">TAG:</label>
                                                                <input type="number" step="0.01" name="tag" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Glicemia:</label>
                                                                <input type="number" step="0.01" name="glicemia" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Microalb:</label>
                                                                <input type="checkbox" name="microalbuminuria" style="margin-top:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Val.Microalb:</label>
                                                                <input type="number" step="0.0001" name="microalbuminuria_val" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Fila 3: Funci√≥n renal, hormonas y notas -->
                                                        <div style="display: grid; grid-template-columns: 140px 150px 90px 140px 140px 300px 170px; gap: 12px; align-items: end; font-size:10px;">
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">VFG:</label>
                                                                <input type="number" step="0.01" name="vfg" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">RAC:</label>
                                                                <input type="number" step="0.0001" name="rac" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div style="text-align:center;">
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">RPR:</label>
                                                                <input type="checkbox" name="rpr" style="margin-top:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">TSH:</label>
                                                                <input type="number" step="0.0001" name="tsh" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">HbA1c:</label>
                                                                <input type="number" step="0.01" name="hba1c_examen" style="width:100%; font-size:10px; padding:2px;">
                                                            </div>
                                                            <div>
                                                                <label style="font-size:10px; font-weight:bold; display:block; margin-bottom:2px;">Notas:</label>
                                                                <textarea name="notas" rows="2" style="width:100%; font-size:10px; padding:2px; resize:vertical;"></textarea>
                                                            </div>
                                                            <div>
                                                                <button type="submit" name="guardar_examen" value="1" formnovalidate onclick="window.__setSubmitAction('guardar_examen')" style="width:100%; font-size:11px; padding:6px 2px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">Guardar</button>
                                                                <div id="examen-guardado-ok" style="display:none; margin-top:6px; font-size:12px; color:#0f5132; background:#d1e7dd; border:1px solid #badbcc; padding:6px 8px; border-radius:6px; text-align:center;">‚úÖ Examen guardado correctamente.</div>
                                                            </div>
                                                            <div>
                                </div>

                                <!-- Nota: tabla de ex√°menes y bot√≥n de guardar control movidos fuera de esta tarjeta -->
            </fieldset>

            <!-- Screening Preventivo -->
            <fieldset id="screening_fieldset">
                <legend>Screening Preventivo</legend>
                <div style="font-size:12px; margin-bottom:8px; color:#444;">Se muestran solo los ex√°menes aplicables seg√∫n sexo y edad (al cargar RUN).</div>
                <div id="screening_contenedor" class="screening-grid">
                    <div id="card_mamografia" class="screening-card hidden">
                        <h4>Mamograf√≠a</h4>
                        <span class="badge-noelig" id="badge_mamografia">No elegible</span>
                        <small class="helper">Femenino ‚â• 50 a√±os</small>
                        <label style="font-size:11px; font-weight:600;">Fecha</label>
                        <input type="date" name="mamografia_fecha" style="font-size:12px;">
                        <label style="font-size:11px; font-weight:600; margin-top:6px;">Estado</label>
                        <select name="mamografia_estado" style="font-size:12px;">
                            <option value="">-- Seleccione --</option>
                            <option value="realizada">Realizada</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="derivada">Derivada</option>
                        </select>
                    </div>
                    <div id="card_pap" class="screening-card hidden">
                        <h4>PAP</h4>
                        <span class="badge-noelig" id="badge_pap">No elegible</span>
                        <small class="helper">Femenino 25-64 a√±os</small>
                        <label style="font-size:11px; font-weight:600;">Fecha</label>
                        <input type="date" name="pap_fecha" style="font-size:12px;">
                        <label style="font-size:11px; font-weight:600; margin-top:6px;">Estado</label>
                        <select name="pap_estado" style="font-size:12px;">
                            <option value="">-- Seleccione --</option>
                            <option value="al_dia">Al d√≠a</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="no_corresponde">No corresponde</option>
                            <option value="derivada">Derivada</option>
                        </select>
                    </div>
                    <div id="card_psa" class="screening-card hidden">
                        <h4>PSA</h4>
                        <span class="badge-noelig" id="badge_psa">No elegible</span>
                        <small class="helper">Masculino ‚â• 45 a√±os</small>
                        
                        <!-- Estado y bot√≥n Nuevo -->
                        <div id="psaUltimo" style="margin:8px 0; padding:6px; background:#f0f9ff; border-radius:4px; font-size:11px; color:#0369a1; display:none;">
                            √öltimo registro PSA
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                            <button type="button" id="psaNuevoBtn" class="btn-nuevo" style="display:none; background:#10b981; color:white; border:none; padding:4px 8px; font-size:10px; border-radius:4px; cursor:pointer;">‚≠ï Nuevo</button>
                            <span id="psaStatus" style="font-size:11px; color:#64748b;"></span>
                        </div>
                        
                        <label style="font-size:11px; font-weight:600;">Fecha</label>
                        <input type="text" name="psa_fecha" id="psaFecha" placeholder="dd/mm/aaaa" style="font-size:12px;" maxlength="10">
                        <label style="font-size:11px; font-weight:600; margin-top:6px;">Valor (ng/mL)</label>
                        <input type="number" step="0.01" min="0" name="psa_valor" id="psaValor" style="font-size:12px;">
                        <small style="display:block; font-size:10px; color:#555; margin-top:4px;">Se marcar√° como realizado cuando tenga valor.</small>
                        
                        <!-- Bot√≥n guardar PSA -->
                        <button type="button" id="psaGuardarBtn" class="btn btn-primary" style="margin-top:8px; font-size:11px; padding:4px 8px;">üíæ Guardar</button>
                        
                        <!-- Historial PSA -->
                        <div id="psaHist" style="margin-top:12px; display:none;">
                            <h5 style="font-size:11px; margin:0 0 4px 0; color:#374151;">üìã Historial PSA</h5>
                            <div style="max-height:120px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:4px;">
                                <table style="width:100%; font-size:10px; border-collapse:collapse;">
                                    <thead style="background:#f9fafb;">
                                        <tr><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Fecha</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Valor</th><th style="padding:4px; border-bottom:1px solid #e5e7eb;">Registro</th></tr>
                                    </thead>
                                    <tbody id="psaHistBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- Vacunas: Influenza -->
                    <div id="card_vac_influenza" class="screening-card">
                        <span class="badge-elig" id="badge_vac_influenza">Anual</span>
                        <div style="display:flex; justify-content: space-between; align-items:center; gap:8px;">
                            <h4 style="margin:0;">üíâ Vacuna Influenza</h4>
                            <div id="vac_influenza_info" style="font-size:12px; color:#334155; margin-top:0; text-align:right; min-width:220px;">
                                <span id="vac_influenza_icon" aria-hidden="true">‚Ä¢</span>
                                <span id="vac_influenza_texto">A√±o registrado: - (-)</span>
                            </div>
                        </div>
                        <small class="helper">Una vez por a√±o. Al guardar SI+fecha del a√±o en curso, se bloquea hasta el pr√≥ximo a√±o.</small>
                        <div class="campos-linea">
                            <label style="min-width:120px;">¬øRecibida?
                                <select id="vac_influenza_si" style="min-width:120px;">
                                    <option value="">-- Seleccione --</option>
                                    <option value="si">S√≠</option>
                                    <option value="no">No</option>
                                    <option value="rechaza">RECHAZA ‚ö†Ô∏è</option>
                                </select>
                            </label>
                            <label>Fecha
                                <input type="text" id="vac_influenza_fecha" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatearFecha(this);" onkeypress="return soloNumeros(event)" onpaste="setTimeout(() => formatearFecha(this), 0);" onblur="validarFechaCompleta(this);" inputmode="numeric" style="min-width:160px;">
                            </label>
                            <button type="button" id="vac_influenza_nuevo" class="btn-nuevo" style="display:none; align-self:flex-end;" title="Nuevo registro Influenza (limpia y desbloquea)">‚≠ï Nuevo</button>
                        </div>
                        <div style="margin-top:8px;">
                            <table class="tabla-mini" style="width:100%; font-size:12px; border-collapse:collapse;">
                                <thead>
                                    <tr><th style="text-align:left;">A√±o</th><th style="text-align:left;">Estado</th><th style="text-align:left;">Fecha</th></tr>
                                </thead>
                                <tbody id="vac_influenza_historial"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Vacunas: COVID -->
                    <div id="card_vac_covid" class="screening-card">
                        <span class="badge-elig" id="badge_vac_covid">Anual</span>
                        <div style="display:flex; justify-content: space-between; align-items:center; gap:8px;">
                            <h4 style="margin:0;">üíâ Vacuna COVID</h4>
                            <div id="vac_covid_info" style="font-size:12px; color:#334155; margin-top:0; text-align:right; min-width:220px;">
                                <span id="vac_covid_icon" aria-hidden="true">‚Ä¢</span>
                                <span id="vac_covid_texto">A√±o registrado: - (-)</span>
                            </div>
                        </div>
                        <small class="helper">Una vez por a√±o. Al guardar SI+fecha del a√±o en curso, se bloquea hasta el pr√≥ximo a√±o.</small>
                        <div class="campos-linea">
                            <label style="min-width:120px;">¬øRecibida?
                                <select id="vac_covid_si" style="min-width:120px;">
                                    <option value="">-- Seleccione --</option>
                                    <option value="si">S√≠</option>
                                    <option value="no">No</option>
                                    <option value="rechaza">RECHAZA ‚ö†Ô∏è</option>
                                </select>
                            </label>
                            <label>Fecha
                                <input type="text" id="vac_covid_fecha" placeholder="dd/mm/aaaa" maxlength="10" oninput="formatearFecha(this);" onkeypress="return soloNumeros(event)" onpaste="setTimeout(() => formatearFecha(this), 0);" onblur="validarFechaCompleta(this);" inputmode="numeric" style="min-width:160px;">
                            </label>
                            <button type="button" id="vac_covid_nuevo" class="btn-nuevo" style="display:none; align-self:flex-end;" title="Nuevo registro COVID (limpia y desbloquea)">‚≠ï Nuevo</button>
                        </div>
                        <div style="margin-top:8px;">
                            <table class="tabla-mini" style="width:100%; font-size:12px; border-collapse:collapse;">
                                <thead>
                                    <tr><th style="text-align:left;">A√±o</th><th style="text-align:left;">Estado</th><th style="text-align:left;">Fecha</th></tr>
                                </thead>
                                <tbody id="vac_covid_historial"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div style="margin-top:10px;">
                    <button type="button" class="btn btn-primary" id="btn_guardar_screening" style="font-size:12px;">Guardar Screening</button>
                    <span id="screening_status_msg" style="font-size:12px; margin-left:8px; color:#0d47a1;"></span>
                </div>
            </fieldset>

            <!-- L√≥gica de screening se carga desde static/js/screening_utils.js -->

            <div class="buttons-container">
                <button type="submit" formnovalidate onclick="window.__setSubmitAction('guardar_full'); setTimeout(function(){ if(window.__debugFormValues) window.__debugFormValues(); }, 10);">Guardar Usuario y Control</button>
                <button type="button" class="btn-secondary" onclick="limpiarFormulario(true)">Limpiar Formulario</button>
                <button type="button" class="btn-secondary" onclick="window.location.href='/'">Cancelar</button>
            </div>
        </form>
    </div>

    <script>
        console.log('üéØ INICIO: Script del formulario cargando...');
        
        // ========= DEFINIR WINDOW.COMMON CON FUNCIONES DE FORMATEO =========
        window.Common = window.Common || {};
        window.Common.formatearRUN = function(valor) {
            console.log('üé® Formateando RUN (versi√≥n index.html):', valor);
            if (!valor) return '';
            
            // Obtener solo n√∫meros y K, en may√∫scula (igual que index.html)
            let v = valor.replace(/[^0-9kK]/g, '').toUpperCase();
            console.log('üßπ Valor limpio:', v);
            
            // Formatear autom√°ticamente con puntos y gui√≥n (l√≥gica de index.html)
            if (v.length >= 2) {
                // Separar cuerpo y d√≠gito verificador
                const cuerpo = v.slice(0, -1);
                const dv = v.slice(-1);
                console.log('üìã Cuerpo:', cuerpo, 'DV:', dv);
                
                // Agregar puntos cada 3 d√≠gitos desde la derecha (IGUAL que index.html)
                const cuerpoFormateado = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                // Combinar con gui√≥n
                const resultado = cuerpoFormateado + '-' + dv;
                console.log('‚ú® RUN formateado:', valor, '=>', resultado);
                
                // Test espec√≠fico para el caso reportado
                if (valor === '152004990' || valor.includes('152004990')) {
                    console.log('üéØ Caso espec√≠fico detectado: 152004990');
                    console.log('üéØ Resultado esperado: 15.200.499-0');
                    console.log('üéØ Resultado actual:', resultado);
                }
                
                return resultado;
            } else {
                // Si solo hay 1 car√°cter o menos, mostrar sin formato (igual que index.html)
                console.log('üìù Valor muy corto, devolviendo sin formato:', v);
                return v;
            }
        };
        
        // Funci√≥n de test para verificar formateo
        window.testFormateoRUN = function(valor) {
            console.log('üß™ Test formateo:', valor);
            const resultado = window.Common.formatearRUN(valor);
            console.log('üß™ Resultado:', resultado);
            return resultado;
        };
        
        window.Common.validarRUN = function(run) {
            // Usar funciones que se definen m√°s abajo
            if (typeof normalizarRun === 'function' && typeof dvValido === 'function') {
                const normalizado = normalizarRun(run);
                return dvValido(normalizado);
            }
            return false;
        };
        
        console.log('‚úÖ window.Common.formatearRUN definido en el inicio');
        
        // Screening modularizado: ver static/js/screening_utils.js
        ;(function(){
            const Q = (s)=>document.querySelector(s);
            const year = new Date().getFullYear();
            function parseBool(v){ if(typeof v==='boolean') return v; const s=String(v||'').toLowerCase(); return ['si','s√≠','true','1','yes','y'].includes(s); }
            // Exponer helpers de 'Nuevo' para vacunas
            window.iniciarNuevoVacunaInfluenza = function(){
                const s = Q('#vac_influenza_si'); const f = Q('#vac_influenza_fecha');
                if(s) { s.disabled = false; s.value = ''; }
                if(f) { f.disabled = false; try{ setFechaConOverlay('vac_influenza_fecha','',{dispatch:true}); }catch(_){ f.value=''; } }
                const info = Q('#vac_influenza_info'); if(info){ info.dataset.bloqueado='0'; }
            };
            window.iniciarNuevoVacunaCovid = function(){
                const s = Q('#vac_covid_si'); const f = Q('#vac_covid_fecha');
                if(s) { s.disabled = false; s.value = ''; }
                if(f) { f.disabled = false; try{ setFechaConOverlay('vac_covid_fecha','',{dispatch:true}); }catch(_){ f.value=''; } }
                const info = Q('#vac_covid_info'); if(info){ info.dataset.bloqueado='0'; }
            };
            async function loadVacunas(run){
                if(!run) return;
                try{
                    const r = await fetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`);
                    const data = await r.json();
                    if(!data.success) return;
                    const v = data.vacunas||{};
                    const hist = data.historial||{influenza:[], covid:[]};
                    // Influenza: priorizar estado del a√±o en curso
                    if(v.influenza_rechaza === true && Number(v.influenza_rechaza_anio)===year){
                        if(Q('#vac_influenza_si')) Q('#vac_influenza_si').value = 'rechaza';
                        if(Q('#vac_influenza_fecha')) Q('#vac_influenza_fecha').value = v.influenza_rechaza_fecha||'';
                    } else if (typeof v.influenza_si === 'boolean' && Number(v.influenza_anio)===year){
                        if(Q('#vac_influenza_si')) Q('#vac_influenza_si').value = v.influenza_si ? 'si' : 'no';
                        if(Q('#vac_influenza_fecha')) Q('#vac_influenza_fecha').value = v.influenza_fecha||'';
                    }
                    const inf_bloqueado = (v.influenza_anio && Number(v.influenza_anio)===year && typeof v.influenza_si==='boolean') || (v.influenza_rechaza_anio && Number(v.influenza_rechaza_anio)===year && v.influenza_rechaza===true);
                    if(inf_bloqueado){
                        bloquear('#vac_influenza_si','#vac_influenza_fecha','#vac_influenza_info');
                        const btnN = Q('#vac_influenza_nuevo'); if(btnN) btnN.style.display = 'inline-flex';
                    } else {
                        const s = Q('#vac_influenza_si'), f = Q('#vac_influenza_fecha'); if(s) s.disabled=false; if(f) f.disabled=false; const i=Q('#vac_influenza_info'); if(i){ i.dataset.bloqueado='0'; }
                        const btnN = Q('#vac_influenza_nuevo'); if(btnN) btnN.style.display = 'none';
                    }
                    // Resumen: mostrar el del a√±o en curso si existe, si no el m√°s reciente disponible
                    (function(){
                        let estado = null, fechaR = null, anioR = null;
                        if(v.influenza_rechaza===true && Number(v.influenza_rechaza_anio)===year){ estado='RECHAZA'; fechaR=v.influenza_rechaza_fecha; anioR=v.influenza_rechaza_anio; }
                        else if(typeof v.influenza_si==='boolean' && Number(v.influenza_anio)===year){ estado = v.influenza_si ? true : false; fechaR = v.influenza_fecha; anioR=v.influenza_anio; }
                        else {
                            // fallback: preferir el de mayor a√±o disponible
                            const cand = [
                                {anio: v.influenza_rechaza_anio, estado:'RECHAZA', fecha:v.influenza_rechaza_fecha, present: v.influenza_rechaza===true},
                                {anio: v.influenza_anio, estado: (typeof v.influenza_si==='boolean') ? (v.influenza_si?true:false) : null, fecha: v.influenza_fecha, present: typeof v.influenza_si==='boolean'}
                            ].filter(x=>x.present && x.anio);
                            if(cand.length){ cand.sort((a,b)=>Number(b.anio)-Number(a.anio)); const c=cand[0]; estado=c.estado; fechaR=c.fecha; anioR=c.anio; }
                        }
                        setResumen('#vac_influenza_info', estado, fechaR, anioR);
                    })();
                    renderHistorial('#vac_influenza_historial', hist.influenza);
                    // COVID: priorizar estado del a√±o en curso
                    if(v.covid_rechaza === true && Number(v.covid_rechaza_anio)===year){
                        if(Q('#vac_covid_si')) Q('#vac_covid_si').value = 'rechaza';
                        if(Q('#vac_covid_fecha')) Q('#vac_covid_fecha').value = v.covid_rechaza_fecha||'';
                    } else if (typeof v.covid_si === 'boolean' && Number(v.covid_anio)===year){
                        if(Q('#vac_covid_si')) Q('#vac_covid_si').value = v.covid_si ? 'si' : 'no';
                        if(Q('#vac_covid_fecha')) Q('#vac_covid_fecha').value = v.covid_fecha||'';
                    }
                    const cov_bloqueado = (v.covid_anio && Number(v.covid_anio)===year && typeof v.covid_si==='boolean') || (v.covid_rechaza_anio && Number(v.covid_rechaza_anio)===year && v.covid_rechaza===true);
                    if(cov_bloqueado){
                        bloquear('#vac_covid_si','#vac_covid_fecha','#vac_covid_info');
                        const btnN = Q('#vac_covid_nuevo'); if(btnN) btnN.style.display = 'inline-flex';
                    } else {
                        const s = Q('#vac_covid_si'), f = Q('#vac_covid_fecha'); if(s) s.disabled=false; if(f) f.disabled=false; const i=Q('#vac_covid_info'); if(i){ i.dataset.bloqueado='0'; }
                        const btnN = Q('#vac_covid_nuevo'); if(btnN) btnN.style.display = 'none';
                    }
                    (function(){
                        let estado = null, fechaR = null, anioR = null;
                        if(v.covid_rechaza===true && Number(v.covid_rechaza_anio)===year){ estado='RECHAZA'; fechaR=v.covid_rechaza_fecha; anioR=v.covid_rechaza_anio; }
                        else if(typeof v.covid_si==='boolean' && Number(v.covid_anio)===year){ estado = v.covid_si ? true : false; fechaR = v.covid_fecha; anioR=v.covid_anio; }
                        else {
                            const cand = [
                                {anio: v.covid_rechaza_anio, estado:'RECHAZA', fecha:v.covid_rechaza_fecha, present: v.covid_rechaza===true},
                                {anio: v.covid_anio, estado: (typeof v.covid_si==='boolean') ? (v.covid_si?true:false) : null, fecha: v.covid_fecha, present: typeof v.covid_si==='boolean'}
                            ].filter(x=>x.present && x.anio);
                            if(cand.length){ cand.sort((a,b)=>Number(b.anio)-Number(a.anio)); const c=cand[0]; estado=c.estado; fechaR=c.fecha; anioR=c.anio; }
                        }
                        setResumen('#vac_covid_info', estado, fechaR, anioR);
                    })();
                    renderHistorial('#vac_covid_historial', hist.covid);
                }catch(e){ console.warn('vacunas load error', e); }
            }
            function bloquear(selSi, selFecha, info){
                const s = Q(selSi), f = Q(selFecha), i = Q(info);
                if(s) s.disabled = true; if(f) f.disabled = true; if(i){ i.dataset.bloqueado='1'; }
            }
            function setResumen(infoSel, si, fecha, anio){
                const info = Q(infoSel);
                if(!info) return;
                const iconEl = info.querySelector('span[id$="_icon"]');
                const textEl = info.querySelector('span[id$="_texto"]');
                const estado = (typeof si==='boolean') ? (si ? 'S√≠' : 'No') : '-';
                const fechaTxt = fecha || '-';
                const anioTxt = anio ? String(anio) : '-';
                const bloqueado = (Number(anio)===year) && (typeof si==='boolean');
                const texto = `A√±o registrado: ${anioTxt} (${estado}${estado==='S√≠' && fechaTxt!=='-' ? ", "+fechaTxt : ''})${bloqueado ? ' ¬∑ bloqueado' : ''}`;
                if(textEl) textEl.textContent = texto; else info.textContent = texto;
                // Icono: ‚úÖ para vacuna vigente (a√±o actual + s√≠), ‚ö†Ô∏è para no vigente o rechazada
                if(iconEl){
                    const esAnioActual = (Number(anio) === year);
                    const tieneVacuna = (typeof si === 'boolean' && si === true);
                    const rechazaVacuna = (si === 'RECHAZA');
                    const esVigente = esAnioActual && tieneVacuna;
                    
                    if(esVigente){
                        iconEl.textContent = '‚úÖ'; 
                        iconEl.style.color = '#16a34a';
                        iconEl.title = 'Vacuna vigente - a√±o actual';
                    } else {
                        iconEl.textContent = '‚ö†Ô∏è'; 
                        iconEl.style.color = '#ea580c';
                        if(rechazaVacuna && esAnioActual) {
                            iconEl.title = 'Vacuna rechazada este a√±o';
                        } else if(typeof si === 'boolean' && si === false && esAnioActual) {
                            iconEl.title = 'No recibi√≥ vacuna este a√±o';
                        } else if(Number(anio) < year && typeof si === 'boolean' && si === true) {
                            iconEl.title = 'Vacuna no vigente - a√±o anterior';
                        } else {
                            iconEl.title = 'Sin registro de vacuna este a√±o';
                        }
                    }
                }
                info.style.color = bloqueado ? '#0f766e' : '#334155';
            }
            async function guardar(run, tipo){
                if(!run) return;
                const payload={};
                if(tipo==='influenza'){
                    const si = Q('#vac_influenza_si')?.value||'';
                    const fecha = Q('#vac_influenza_fecha')?.value||'';
                    if(si==='rechaza'){
                        payload.influenza_rechaza = true;
                        if(!fecha){ mostrarInfo('#vac_influenza_info','Seleccione fecha de rechazo.'); return; }
                        payload.influenza_rechaza_fecha = fecha;
                    } else if(si==='si'){
                        payload.influenza_si = true;
                        if(!fecha){ mostrarInfo('#vac_influenza_info','Seleccione fecha de vacunaci√≥n.'); return; }
                        payload.influenza_fecha = fecha;
                    } else if(si==='no'){
                        payload.influenza_si = false;
                    }
                } else if(tipo==='covid'){
                    const si = Q('#vac_covid_si')?.value||'';
                    const fecha = Q('#vac_covid_fecha')?.value||'';
                    if(si==='rechaza'){
                        payload.covid_rechaza = true;
                        if(!fecha){ mostrarInfo('#vac_covid_info','Seleccione fecha de rechazo.'); return; }
                        payload.covid_rechaza_fecha = fecha;
                    } else if(si==='si'){
                        payload.covid_si = true;
                        if(!fecha){ mostrarInfo('#vac_covid_info','Seleccione fecha de vacunaci√≥n.'); return; }
                        payload.covid_fecha = fecha;
                    } else if(si==='no'){
                        payload.covid_si = false;
                    }
                }
                try{
                    const resp = await fetch(`/api/demograficos/${encodeURIComponent(run)}/vacunas`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
                    const data = await resp.json();
                    if(data.success){
                        mostrarInfo(`#vac_${tipo}_info`, 'Guardado correctamente');
                        setTimeout(()=>loadVacunas(run), 200);
                    } else {
                        mostrarInfo(`#vac_${tipo}_info`, 'Error: '+(data.error||''));
                    }
                }catch(e){
                    mostrarInfo(`#vac_${tipo}_info`, 'Error de conexi√≥n');
                }
            }
            setTimeout(()=>{ 
                const run = getRun(); 
                if(run) {
                    const runLimpio = run.replace(/[^0-9kK]/g, '');
                    if (runLimpio.length >= 8 && dvValido(normalizarRun(run))) {
                        loadVacunas(run);
                    }
                }
            }, 700);
            // Tambi√©n responder a cambios de RUN en el input
            const runInput = document.getElementById('run');
            if(runInput){
                // Solo cargar vacunas cuando RUN est√© completo y v√°lido, no durante escritura
            }
            // Botones Nuevo en tarjetas de vacunas
            try{
                const btnInf = document.getElementById('vac_influenza_nuevo');
                if(btnInf){ btnInf.addEventListener('click', ()=>{ if(typeof window.iniciarNuevoVacunaInfluenza==='function') window.iniciarNuevoVacunaInfluenza(); }); }
                const btnCov = document.getElementById('vac_covid_nuevo');
                if(btnCov){ btnCov.addEventListener('click', ()=>{ if(typeof window.iniciarNuevoVacunaCovid==='function') window.iniciarNuevoVacunaCovid(); }); }
            }catch(_){ }
            // Hook opcional si en el futuro se emite este evento
            document.addEventListener('ecicep:run-cargado', ()=>{ const run=getRun(); if(run) loadVacunas(run); });
        })();
        // ======== FIN Screening (migrado a screening_utils.js) =========
        
        // ========= (2) Normalizar para API (12345678-9) =========
        function normalizarRun(s) {
            s = (s || "").toUpperCase().replace(/[^0-9K]/g, '');
            if (s.length < 2) return s;
            return s.slice(0, -1) + '-' + s.slice(-1);
        }

        // ========= (3) Validador DV =========
        function dvValido(runNorm) {
            // Normalizar entrada: may√∫sculas y patr√≥n con gui√≥n
            runNorm = (runNorm || '').toUpperCase();
            const m = /^(\d{7,8})-([\dK])$/.exec(runNorm);
            if (!m) return false;

            const cuerpo = m[1];
            const dv = m[2];

            // C√°lculo est√°ndar del DV chileno
            const factores = [2,3,4,5,6,7];
            let s = 0;
            for (let i = 0; i < cuerpo.length; i++) {
                const dig = parseInt(cuerpo[cuerpo.length - 1 - i], 10);
                s += dig * factores[i % factores.length];
            }
            const resto = 11 - (s % 11);
            const dvCalc = (resto === 11) ? '0' : (resto === 10) ? 'K' : String(resto);
            return dv === dvCalc;
        }

        console.log('üîß [DEBUG] Funci√≥n dvValido definida correctamente');

        // ========= (4) Funci√≥n para actualizar resumen de patolog√≠as =========
        // Funci√≥n actualizarResumenPatologias() definida m√°s abajo en l√≠nea 15955

        function actualizarTablaExamenes(examenes) {
            console.log('üîÑ actualizarTablaExamenes llamada con:', examenes);
            console.log('üìä N√∫mero de ex√°menes:', examenes ? examenes.length : 'examenes es null/undefined');
            console.log('üìä Tipo de examenes:', typeof examenes);
            console.log('üìä Es array:', Array.isArray(examenes));
            
            const tablaBody = document.querySelector('#tabla-examenes tbody');
            if (!tablaBody) {
                console.error('‚ùå No se encontr√≥ el tbody de la tabla ex√°menes');
                return;
            }
            
            console.log('üßπ Limpiando contenido actual del tbody');
            // Limpiar contenido actual completamente
            tablaBody.innerHTML = '';
            
            if (examenes && Array.isArray(examenes) && examenes.length > 0) {
                console.log('‚úÖ Agregando', examenes.length, 'ex√°menes a la tabla');
                
                // Funci√≥n auxiliar para formatear fecha en formato DD/MM/AAAA
                function formatearFechaCompleta(fecha) {
                    if (!fecha) return '';
                    const fechaObj = new Date(fecha + 'T00:00:00');
                    const dia = String(fechaObj.getDate()).padStart(2, '0');
                    const mes = String(fechaObj.getMonth() + 1).padStart(2, '0');
                    const a√±o = fechaObj.getFullYear();
                    return `${dia}/${mes}/${a√±o}`;
                }
                
                // Funci√≥n auxiliar para evaluar valores cr√≠ticos
                function evaluarValor(valor, campo, sexo = null, edad = null) {
                    if (!valor || valor === '') return { color: '', fondo: '' };
                    
                    const num = parseFloat(valor);
                    if (isNaN(num)) return { color: '', fondo: '' };
                    
                    let critico = false;
                    let esVerde = false; // Nueva variable para manejar el color verde
                    
                    switch(campo) {
                        case 'hba1c':
                            // Obtener edad si no se proporciona
                            if (edad === null) {
                                const edadInput = document.getElementById('edad');
                                if (edadInput && edadInput.value) {
                                    edad = parseInt(edadInput.value, 10);
                                }
                            }
                            
                            // L√≥gica espec√≠fica para HbA1c
                            if (edad !== null && edad >= 80) {
                                // Si edad >= 80 a√±os: rojo si HbA1c >= 8, verde si < 8
                                critico = num >= 8.0;
                                esVerde = num < 8.0;
                            } else {
                                // Si edad < 80 a√±os: rojo si HbA1c >= 7, verde si < 7
                                critico = num >= 7.0;
                                esVerde = num < 7.0;
                            }
                            break;
                        case 'col':
                            critico = num >= 200;
                            break;
                        case 'tag':
                            critico = num >= 150;
                            break;
                        case 'vfg':
                            critico = num < 60;
                            break;
                        case 'creatinemia':
                            critico = num >= 1.2;
                            break;
                        case 'rac':
                            critico = num >= 300;
                            break;
                        case 'hdl':
                            if (sexo) {
                                const sexoNorm = sexo.toLowerCase().trim();
                                if (sexoNorm.includes('femenino') || sexoNorm.includes('f') || sexoNorm.includes('mujer')) {
                                    critico = num <= 50;
                                } else if (sexoNorm.includes('masculino') || sexoNorm.includes('m') || sexoNorm.includes('hombre') || sexoNorm.includes('var√≥n') || sexoNorm.includes('varon')) {
                                    critico = num <= 40;
                                }
                            }
                            break;
                    }
                    
                    // Determinar el estilo de retorno
                    if (critico) {
                        return { color: 'color: #dc3545; font-weight: bold;', fondo: 'background-color: #f8d7da;' };
                    } else if (esVerde) {
                        return { color: 'color: #28a745; font-weight: bold;', fondo: 'background-color: #d4edda;' };
                    } else {
                        return { color: '', fondo: '' };
                    }
                }
                
                // Agregar filas con datos de ex√°menes
                examenes.forEach((ex, index) => {
                    console.log(`üè• Procesando examen ${index + 1}:`, ex);
                    
                    // Formatear fecha completa
                    const fechaCompleta = formatearFechaCompleta(ex.examen_fecha);
                    
                    // Obtener sexo del usuario para evaluaci√≥n de HDL
                    const sexoUsuario = document.getElementById('sexo') ? document.getElementById('sexo').value : '';
                    
                    // Obtener edad del usuario para evaluaci√≥n de HbA1c
                    let edadUsuario = null;
                    const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
                    if (fechaNacimientoInput && fechaNacimientoInput.value) {
                        edadUsuario = calcularEdadDesde(fechaNacimientoInput.value);
                    }
                    
                    // Evaluar valores cr√≠ticos
                    const estiloHba1c = evaluarValor(ex.hba1c, 'hba1c', sexoUsuario, edadUsuario);
                    const estiloCol = evaluarValor(ex.col, 'col');
                    const estiloTag = evaluarValor(ex.tag, 'tag');
                    const estiloVfg = evaluarValor(ex.vfg, 'vfg');
                    const estiloCreatinemia = evaluarValor(ex.creatinemia, 'creatinemia');
                    const estiloRac = evaluarValor(ex.rac, 'rac');
                    const estiloHdl = evaluarValor(ex.hdl, 'hdl', sexoUsuario);
                    
            const row = document.createElement('tr');
        row.innerHTML = `
                        <td style="border: 1px solid black; padding: 8px; white-space: nowrap; font-size: 12px;">${fechaCompleta}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.so2_percent || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.flujometria || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.tos === true ? 'S√≠' : (ex.tos === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.baciloscopia === true ? 'S√≠' : (ex.baciloscopia === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloCreatinemia.color} ${estiloCreatinemia.fondo}">${ex.creatinemia ? parseFloat(ex.creatinemia).toFixed(2) : ''}</td>
                <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.ekg === true ? 'S√≠' : (ex.ekg === false ? 'No' : '')}</td>
                <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.ekg_fecha || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloCol.color} ${estiloCol.fondo}">${ex.col || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloHdl.color} ${estiloHdl.fondo}">${ex.hdl || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.ldl || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloTag.color} ${estiloTag.fondo}">${ex.tag || ''}</td>
            <!-- Glicemia (faltante causaba corrimiento) -->
            <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.glicemia || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.microalbuminuria === true ? 'S√≠' : (ex.microalbuminuria === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.microalbuminuria_val || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloVfg.color} ${estiloVfg.fondo}">${ex.vfg || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloRac.color} ${estiloRac.fondo}">${ex.rac ? parseFloat(ex.rac).toFixed(2) : ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.rpr === true ? 'S√≠' : (ex.rpr === false ? 'No' : '')}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center;">${ex.tsh || ''}</td>
                        <td style="border: 1px solid black; padding: 8px; text-align: center; ${estiloHba1c.color} ${estiloHba1c.fondo}">${ex.hba1c || ''}</td>
                    `;
                    tablaBody.appendChild(row);
                });
                console.log('‚úÖ Tabla actualizada con', examenes.length, 'filas');
            } else {
                console.log('‚ö†Ô∏è No hay ex√°menes v√°lidos, mostrando mensaje de no hay datos');
                // Mostrar mensaje cuando no hay ex√°menes
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="19" style="text-align:center; color:#888; padding:20px; border: 1px solid black;">No hay ex√°menes registrados para este usuario.</td>';
                tablaBody.appendChild(row);
            }
        }

        // Funci√≥n para actualizar la tabla de acuerdos previos
        function actualizarTablaAcuerdos(acuerdos) {
            console.log('üîÑ actualizarTablaAcuerdos llamada con:', acuerdos);
            console.log('üìä N√∫mero de acuerdos:', acuerdos ? acuerdos.length : 'acuerdos es null/undefined');
            
            const tablaBody = document.querySelector('#tabla-acuerdos tbody');
            if (!tablaBody) {
                console.error('‚ùå No se encontr√≥ el tbody de la tabla acuerdos');
                return;
            }
            
            console.log('üßπ Limpiando contenido actual del tbody de acuerdos');
            // Limpiar contenido actual completamente
            tablaBody.innerHTML = '';
            
            if (acuerdos && Array.isArray(acuerdos) && acuerdos.length > 0) {
                console.log('‚úÖ Agregando', acuerdos.length, 'acuerdos a la tabla');
                
                // Funci√≥n auxiliar para formatear fecha y hora
                function formatearFechaHora(fechaStr) {
                    if (!fechaStr) return '';
                    try {
                        let s = fechaStr;
                        // Aceptar 'YYYY-MM-DD HH:MM:SS' convirtiendo a ISO b√°sico
                        if (typeof s === 'string' && s.indexOf('T') === -1 && s.indexOf(' ') !== -1) {
                            s = s.replace(' ', 'T');
                        }
                        const fecha = new Date(s);
                        if (isNaN(fecha.getTime())) {
                            // Fallback: parsear manualmente 'YYYY-MM-DD HH:MM[:SS]'
                            const m = String(fechaStr).match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})/);
                            if (m) {
                                return `${m[3]}/${m[2]}/${m[1]} ${m[4]}:${m[5]}`;
                            }
                            return fechaStr;
                        }
                        const dia = String(fecha.getDate()).padStart(2, '0');
                        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                        const a√±o = fecha.getFullYear();
                        const horas = String(fecha.getHours()).padStart(2, '0');
                        const minutos = String(fecha.getMinutes()).padStart(2, '0');
                        return `${dia}/${mes}/${a√±o} ${horas}:${minutos}`;
                    } catch (e) {
                        return fechaStr; // Devolver fecha original si no se puede formatear
                    }
                }
                
                // Agregar filas con datos de acuerdos
                acuerdos.forEach((acuerdo, index) => {
                    console.log(`üìù Procesando acuerdo ${index + 1}:`, acuerdo);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding:2px 6px;">${formatearFechaHora(acuerdo.fecha_creacion)}</td>
                        <td style="padding:2px 6px;">${acuerdo.acuerdos || ''}</td>
                        <td style="padding:2px 6px;">${acuerdo.cumplimiento || ''}</td>
                        <td style="padding:2px 6px;">${acuerdo.observaciones || ''}</td>
                    `;
                    tablaBody.appendChild(row);
                });
                
                console.log('‚úÖ Tabla de acuerdos actualizada con', acuerdos.length, 'filas');
            } else {
                console.log('‚ö†Ô∏è No hay acuerdos v√°lidos, mostrando mensaje de no hay datos');
                // Mostrar mensaje cuando no hay acuerdos
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4" style="text-align:center; color:#888; padding:8px;">No hay acuerdos previos.</td>';
                tablaBody.appendChild(row);
            }
        }

        // Funci√≥n para crear el mensaje de nuevo usuario si no existe
        function crearMensajeNuevoUsuario() {
            const existingMsg = document.getElementById('usuario-nuevo');
            if (existingMsg) return existingMsg;
            
            const mensajeDiv = document.createElement('div');
            mensajeDiv.id = 'usuario-nuevo';
            mensajeDiv.className = 'nuevo-usuario';
            mensajeDiv.style.cssText = 'display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 16px; margin: 12px 0; color: #856404;';
            mensajeDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <strong style="font-size: 16px;">üÜï Usuario nuevo</strong>
                </div>
                <p style="margin: 8px 0; font-size: 14px; line-height: 1.4;">
                    El RUN no fue encontrado en la base de datos. Complete los datos b√°sicos del usuario y presione "Guardar nuevo usuario" para continuar con el registro m√©dico.
                </p>
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 12px; margin: 12px 0;">
                    <p style="margin: 0; font-size: 13px; color: #6c757d; font-weight: 500;">
                        üìã <strong>Para proseguir con el registro presione guardar</strong>
                    </p>
                    <small style="color: #6c757d;">Las secciones m√©dicas se habilitar√°n despu√©s de guardar el usuario.</small>
                </div>
                <div style="text-align: center; margin-top: 16px;">
                    <button type="button" id="btnGuardarNuevoUsuario" onclick="guardarNuevoUsuario()" 
                            style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">
                        üíæ Guardar nuevo usuario
                    </button>
                </div>
            `;
            
            // Insertar despu√©s de la secci√≥n de patolog√≠as
            const patologiasResumen = document.querySelector('.patologias-resumen');
            if (patologiasResumen && patologiasResumen.parentNode) {
                patologiasResumen.parentNode.insertBefore(mensajeDiv, patologiasResumen.nextSibling);
            } else {
                // Fallback: insertar despu√©s del elemento usuario-encontrado
                const encontradoDiv = document.getElementById('usuario-encontrado');
                if (encontradoDiv && encontradoDiv.parentNode) {
                    encontradoDiv.parentNode.insertBefore(mensajeDiv, encontradoDiv.nextSibling);
                }
            }
            
            // Agregar estilos hover al bot√≥n
            const btn = mensajeDiv.querySelector('#btnGuardarNuevoUsuario');
            if (btn) {
                btn.addEventListener('mouseenter', () => {
                    btn.style.background = '#218838';
                    btn.style.transform = 'translateY(-1px)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.background = '#28a745';
                    btn.style.transform = 'translateY(0)';
                });
            }
            
            return mensajeDiv;
        }

        /**
         * Funci√≥n para guardar un nuevo usuario y habilitar las secciones m√©dicas
         */
        function guardarNuevoUsuario() {
            console.log('[NUEVO-USUARIO] üíæ Iniciando guardado de nuevo usuario');
            
            const btn = document.getElementById('btnGuardarNuevoUsuario');
            if (btn) {
                btn.disabled = true;
                btn.style.background = '#6c757d';
                btn.innerHTML = '‚è≥ Guardando...';
            }
            
            try {
                // Encontrar el formulario principal
                const form = document.getElementById('usuarioForm');
                if (!form) {
                    throw new Error('Formulario principal no encontrado');
                }
                
                console.log('[NUEVO-USUARIO] üì§ Enviando formulario principal');
                
                // Marcar la acci√≥n del submit
                if (typeof window.__setSubmitAction === 'function') {
                    window.__setSubmitAction('guardar_full');
                }
                
                // Interceptar el submit para manejar la respuesta
                const handleSubmitSuccess = function() {
                    console.log('[NUEVO-USUARIO] ‚úÖ Usuario guardado exitosamente');
                    
                    // Simular que el usuario fue encontrado
                    const encontrado = document.getElementById('usuario-encontrado');
                    const mensajeNuevo = document.getElementById('usuario-nuevo');
                    
                    if (encontrado) encontrado.style.display = 'block';
                    if (mensajeNuevo) mensajeNuevo.style.display = 'none';
                    
                    // Mostrar secciones m√©dicas
                    mostrarSeccionesMedicas();
                    
                    // Mostrar mensaje de √©xito
                    mostrarNotificacion('‚úÖ Usuario guardado exitosamente. Ahora puede continuar con el registro m√©dico.', 'success');
                };
                
                // Crear un listener temporal para el submit
                const submitHandler = function(e) {
                    e.preventDefault();
                    
                    // Crear FormData para enviar
                    const formData = new FormData(form);
                    
                    // Enviar por fetch
                    fetch(form.action || window.location.pathname, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.text();
                        }
                        throw new Error(`Error HTTP: ${response.status}`);
                    })
                    .then(data => {
                        // Si llegamos aqu√≠, el guardado fue exitoso
                        handleSubmitSuccess();
                        
                        // Remover el listener temporal
                        form.removeEventListener('submit', submitHandler);
                    })
                    .catch(error => {
                        console.error('[NUEVO-USUARIO] ‚ùå Error en el guardado:', error);
                        
                        // Restaurar bot√≥n
                        if (btn) {
                            btn.disabled = false;
                            btn.style.background = '#28a745';
                            btn.innerHTML = 'üíæ Guardar nuevo usuario';
                        }
                        
                        mostrarNotificacion('‚ùå Error al guardar el usuario. Verifique los datos e intente nuevamente.', 'error');
                        
                        // Remover el listener temporal
                        form.removeEventListener('submit', submitHandler);
                    });
                };
                
                // Agregar listener temporal
                form.addEventListener('submit', submitHandler);
                
                // Disparar el submit
                form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                
            } catch (error) {
                console.error('[NUEVO-USUARIO] ‚ùå Error preparando guardado:', error);
                
                // Restaurar bot√≥n
                if (btn) {
                    btn.disabled = false;
                    btn.style.background = '#28a745';
                    btn.innerHTML = 'üíæ Guardar nuevo usuario';
                }
                
                mostrarNotificacion('‚ùå Error al preparar el guardado. Intente nuevamente.', 'error');
            }
        }

        /**
         * Mostrar notificaci√≥n temporal
         */
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 9999;
                padding: 12px 20px; border-radius: 6px; color: white; font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); max-width: 400px;
                background: ${tipo === 'success' ? '#28a745' : tipo === 'error' ? '#dc3545' : '#17a2b8'};
                animation: slideIn 0.3s ease-out;
            `;
            notif.innerHTML = mensaje;
            
            // Agregar animaci√≥n CSS
            if (!document.querySelector('#notifStyles')) {
                const styles = document.createElement('style');
                styles.id = 'notifStyles';
                styles.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(styles);
            }
            
            document.body.appendChild(notif);
            
            // Remover despu√©s de 5 segundos
            setTimeout(() => {
                notif.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => document.body.removeChild(notif), 300);
            }, 5000);
        }

        // *** FUNCI√ìN DE TEST PARA AUTOCOMPLETADO ***
        function testAutocompletado() {
            console.log('üß™ Test de Autocompletado iniciado');
            
            // Obtener el valor del campo RUN
            const runField = document.getElementById('run');
            const runValue = runField ? runField.value.trim() : '';
            
            console.log('üìã Valor del campo RUN:', runValue);
            
            if (!runValue) {
                // Si no hay RUN ingresado, usar uno de prueba
                const testRun = '15.200.499-0';
                console.log(`‚ö° No hay RUN ingresado, usando RUN de prueba: ${testRun}`);
                runField.value = testRun;
                
                // Disparar evento input manualmente
                const event = new Event('input', { bubbles: true });
                runField.dispatchEvent(event);
                
                // Tambi√©n disparar buscarUsuario directamente
                setTimeout(() => {
                    console.log('üîÑ Ejecutando buscarUsuario despu√©s de 500ms...');
                    buscarUsuario();
                }, 500);
            } else {
                // Si hay RUN, ejecutar autocompletado
                console.log(`üîç Ejecutando buscarUsuario con RUN: ${runValue}`);
                buscarUsuario();
            }
            
            // Tambi√©n ejecutar la funci√≥n de debug
            setTimeout(() => {
                debugAutocompletado(runValue || '15.200.499-0');
            }, 1000);
        }

        // *** FUNCI√ìN DE DEBUGGING PARA AUTOCOMPLETADO ***
        function debugAutocompletado(run) {
            console.log('üêõ === DEBUG AUTOCOMPLETADO ===');
            console.log('üêõ RUN recibido:', run);
            
            if (!run || run.length < 8) {
                console.log('üêõ ‚ùå RUN muy corto o vac√≠o');
                return;
            }
            
            console.log('üêõ Probando endpoint /usuario/buscar...');
            
            fetch('/usuario/buscar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ run: run })
            })
            .then(response => {
                console.log('üêõ Respuesta recibida. Status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üêõ Datos recibidos:', data);
                
                if (data.encontrado) {
                    console.log('üêõ ‚úÖ Usuario encontrado:', data.nombre);
                    console.log('üêõ üìã Datos completos:', {
                        nombre: data.nombre,
                        fecha_nacimiento: data.fecha_nacimiento,
                        sexo: data.sexo,
                        direccion: data.direccion,
                        telefono: data.telefono,
                        categoria_id: data.categoria_id,
                        sector_id: data.sector_id
                    });
                    
                    // Verificar que los campos existen
                    const campos = ['nombre', 'fecha_nacimiento', 'direccion', 'telefono', 'sexo', 'categoria_id', 'sector_id'];
                    campos.forEach(campo => {
                        const elemento = document.getElementById(campo);
                        if (elemento) {
                            console.log(`üêõ ‚úÖ Campo ${campo} existe en DOM`);
                        } else {
                            console.log(`üêõ ‚ùå Campo ${campo} NO existe en DOM`);
                        }
                    });
                    
                } else {
                    console.log('üêõ ‚ùå Usuario no encontrado');
                }
            })
            .catch(error => {
                console.log('üêõ ‚ùå Error en petici√≥n:', error);
            });
        }
        
        // Exponer funci√≥n de debug globalmente
        window.debugAutocompletado = debugAutocompletado;

        // Funciones auxiliares para manejo de pesta√±as y alertas
        function mostrarLoadingEnTabs() {
            console.log('‚ö° Mostrando loading en tabs');
            const html = '<div style="padding:8px;text-align:center;color:#2563eb;font-size:11px">‚ö° Cargando alertas...</div>';
            ['alert-examenes', 'alert-screening', 'alert-procedimientos', 'alert-tratamientos', 'alert-cardiovascular'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            });
        }

        function mostrarErrorEnTabs(mensaje) {
            console.log('‚ùå Mostrando error en tabs:', mensaje);
            const html = `<div style="padding:8px;text-align:center;color:#dc2626;font-size:11px">‚ùå ${mensaje}</div>`;
            ['alert-examenes', 'alert-screening', 'alert-procedimientos', 'alert-tratamientos', 'alert-cardiovascular'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            });
        }

        function mostrarMensajeEnTabs(mensaje) {
            console.log('üìã Mostrando mensaje en tabs:', mensaje);
            const html = `<div style="padding:8px;text-align:center;color:#6b7280;font-size:11px">${mensaje}</div>`;
            ['alert-examenes', 'alert-screening', 'alert-procedimientos', 'alert-tratamientos', 'alert-cardiovascular'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            });
        }

        function buscarUsuario(run) {
            if (!run || run.length < 8) return;
            
            // GUARDAR EL RUN ORIGINAL PARA PRESERVARLO
            const runOriginal = run;
            const runInput = document.getElementById('run');
            
            console.log('üîç buscarUsuario iniciado con RUN:', runOriginal);
            
            const loading = document.getElementById('loading');
            const encontrado = document.getElementById('usuario-encontrado');
            
            loading.style.display = 'block';
            encontrado.style.display = 'none';
            
            fetch('/usuario/buscar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ run: runOriginal })
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                // ASEGURAR QUE EL RUN NO SE PIERDA NUNCA
                if (runInput.value !== runOriginal) {
                    console.log('‚ö†Ô∏è RUN cambi√≥ durante b√∫squeda, restaurando:', runOriginal);
                    runInput.value = runOriginal;
                }
                
                if (data.encontrado) {
                    // Llenar los campos con los datos encontrados
                    document.getElementById('nombre').value = data.nombre || '';
                    // Sincronizar fecha de nacimiento con display y eventos
                    try {
                        const iso = data.fecha_nacimiento || '';
                        const hid = document.getElementById('fecha_nacimiento');
                        const disp = document.getElementById('fecha_nacimiento_display');
                        if (hid) hid.value = iso;
                        if (disp) disp.value = iso ? formatearFechaEspanol(iso) : '';
                        // Disparar eventos para recalcular edad/validaciones
                        ['input','change'].forEach(evt => {
                            if (hid) hid.dispatchEvent(new Event(evt, { bubbles: true }));
                            if (disp) disp.dispatchEvent(new Event(evt, { bubbles: true }));
                        });
                    } catch (e) { console.warn('No se pudo sincronizar fecha_nacimiento:', e); }
                    document.getElementById('direccion').value = data.direccion || '';
                    document.getElementById('telefono').value = data.telefono || '';
                    // Fecha de ingreso es ahora manual, no requiere overlay
                    document.getElementById('fecha_ingreso').value = data.fecha_ingreso || '';
                    document.getElementById('sexo').value = data.sexo || '';
                    document.getElementById('categoria_id').value = data.categoria_id || '';
                    document.getElementById('sector_id').value = data.sector_id || '';
                    // Programa ECICEP/Cardio
                    try {
                        // Nueva prioridad: si viene categoria_ecicep_effectiva del backend √∫sala
                        const pref = String(data.categoria_ecicep_effectiva || '').toLowerCase();
                        const hid = document.getElementById('categoria_ecicep_effectiva');
                        if (hid) hid.value = data.categoria_ecicep_effectiva || '';
                        let modo = null;
                        if (pref === 'cardio') modo = 'cardio';
                        else if (pref === 'ecicep') modo = 'ecicep';
                        else {
                            // Compatibilidad: si ingreso_ecicep True => ecicep, si select es Cardio => cardio
                            const ingreso = !!data.ingreso_ecicep;
                            if (ingreso) modo = 'ecicep';
                            else {
                                const categoria = document.getElementById('categoria_id');
                                const esCardio = categoria && (String(categoria.value) === String(window.CARDIO_CAT_ID));
                                modo = esCardio ? 'cardio' : 'ecicep';
                            }
                        }
                        if (typeof setPrograma === 'function' && modo) setPrograma(modo);
                    } catch(e) { console.warn('No se pudo aplicar modo de programa (buscarUsuario):', e); }
                    // Demogr√°ficos
                    if (document.getElementById('nivel_educacional')) {
                        document.getElementById('nivel_educacional').value = data.nivel_educacional || '';
                    }
                    if (document.getElementById('origen_etnico')) {
                        document.getElementById('origen_etnico').value = data.origen_etnico || '';
                    }
                    if (document.getElementById('estado_civil')) {
                        document.getElementById('estado_civil').value = data.estado_civil || '';
                    }
                    
                    // Recalcular elegibilidad de screening tras setear sexo/fecha
                    if (window.ScreeningModule && typeof window.ScreeningModule.update === 'function') {
                        window.ScreeningModule.update();
                        
                        // Cargar datos de screening existentes y mostrar vigencia
                        if (typeof window.ScreeningModule.cargarDatosScreening === 'function') {
                            setTimeout(() => {
                                window.ScreeningModule.cargarDatosScreening(data.run);
                            }, 100);
                        }
                    }
                    // Recalcular visibilidad de Adulto Mayor (edad >= 60) tras completar fecha de nacimiento
                    if (typeof updateAdultoMayorVisibility === 'function') {
                        setTimeout(() => updateAdultoMayorVisibility(), 0);
                    }
                    
                    // Marcar patolog√≠as
                    const checkboxes = document.querySelectorAll('input[name="patologia[]"]');
                    checkboxes.forEach(cb => {
                        cb.checked = data.patologias.includes(parseInt(cb.value));
                    });
                    
                    // Actualizar resumen de patolog√≠as
                    actualizarResumenPatologias();
                    // Recalcular visibilidad de secciones dependientes
                    try { updatePieDmVisibility(); } catch(_e){}
                    try { updateMedicacionVisibility(); } catch(_e){}
                    
                    // Actualizar tabla de ex√°menes
                    console.log('üì¶ Datos del usuario encontrado:', data);
                    console.log('üè• Ex√°menes recibidos en buscarUsuario:', data.examenes);
                    console.log('üè• Tipo de data.examenes:', typeof data.examenes);
                    console.log('üè• Es array data.examenes:', Array.isArray(data.examenes));
                    console.log('üè• Longitud de data.examenes:', data.examenes ? data.examenes.length : 'undefined/null');
                    
                    if (data.examenes) {
                        console.log('‚úÖ Llamando a actualizarTablaExamenes con', data.examenes.length, 'ex√°menes');
                    } else {
                        console.log('‚ö†Ô∏è Llamando a actualizarTablaExamenes con examenes undefined/null');
                    }
                    
                    actualizarTablaExamenes(data.examenes);
                    try { 
                        const runValue = document.getElementById('run')?.value || '';
                        const runLimpio = runValue.replace(/[^0-9kK]/gi, '');
                        if (runLimpio.length >= 8 && dvValido(normalizarRun(runValue))) {
                            preloadDiabetesExamFields(runValue);
                        } else {
                            console.log('‚è≥ RUN incompleto, omitiendo preload diabetes en buscarUsuario');
                        }
                    } catch(_e){}
                    
                    // Actualizar tabla de acuerdos
                    console.log('üìù Acuerdos recibidos en buscarUsuario:', data.acuerdos);
                    console.log('üìù Tipo de data.acuerdos:', typeof data.acuerdos);
                    console.log('üìù Es array data.acuerdos:', Array.isArray(data.acuerdos));
                    console.log('üìù Longitud de data.acuerdos:', data.acuerdos ? data.acuerdos.length : 'undefined/null');
                    
                    if (data.acuerdos) {
                        console.log('‚úÖ Llamando a actualizarTablaAcuerdos con', data.acuerdos.length, 'acuerdos');
                    } else {
                        console.log('‚ö†Ô∏è Llamando a actualizarTablaAcuerdos con acuerdos undefined/null');
                    }
                    
                    actualizarTablaAcuerdos(data.acuerdos);
                    
                    encontrado.style.display = 'block';
                    
                    // Ocultar mensaje de nuevo usuario si est√° visible
                    const mensajeNuevo = document.getElementById('usuario-nuevo');
                    if (mensajeNuevo) mensajeNuevo.style.display = 'none';
                    
                    // Mostrar secciones m√©dicas (usuario existe)
                    mostrarSeccionesMedicas();
                    
                    // Mostrar autom√°ticamente las alertas de vigencia
                    try {
                        setTimeout(() => {
                            console.log('üîî Iniciando activaci√≥n autom√°tica de alertas...');
                            
                            // Asegurar que el contenedor del bot√≥n est√© visible
                            const alertsBtnContainer = document.getElementById('alertas-btn-container');
                            if (alertsBtnContainer) {
                                alertsBtnContainer.style.display = 'block';
                                console.log('‚úÖ Contenedor del bot√≥n de alertas mostrado');
                            }
                            
                            // Buscar el bot√≥n de alertas
                            const alertsBtn = document.getElementById('ver-alertas-btn');
                            if (alertsBtn) {
                                alertsBtn.style.display = 'inline-block';
                                console.log('‚úÖ Bot√≥n de alertas encontrado y mostrado');
                                
                                // Activar alertas autom√°ticamente si no est√°n visibles
                                if (typeof toggleHealthAlerts === 'function') {
                                    if (!alertasVisibles) {
                                        console.log('üîî Ejecutando toggleHealthAlerts autom√°ticamente...');
                                        toggleHealthAlerts();
                                    } else {
                                        console.log('‚ÑπÔ∏è Alertas ya est√°n visibles');
                                    }
                                } else {
                                    console.warn('‚ö†Ô∏è Funci√≥n toggleHealthAlerts no disponible');
                                }
                            } else {
                                console.error('‚ùå Bot√≥n de alertas no encontrado en DOM');
                            }
                            
                            // Verificar si las alertas se pueden cargar directamente
                            setTimeout(() => {
                                if (typeof cargarAlertasVigencia === 'function') {
                                    console.log('üîÑ Intentando cargar alertas directamente...');
                                    cargarAlertasVigencia();
                                }
                            }, 500);
                            
                        }, 2000); // Delay m√°s largo para asegurar que todo est√© cargado
                    } catch(e) { 
                        console.error('Error al mostrar alertas autom√°ticamente:', e); 
                    }
                    
                    // Cargar patolog√≠as guardadas en BD
                    cargarPatologiasGuardadas(run);
                    
                    // Habilitar botones de guardado independiente
                    habilitarBotonesGuardadoIndependiente();

                    // Cargar autom√°ticamente historiales de Medicaci√≥n para el RUN encontrado
                    try {
                        if (typeof updateMedicacionVisibility === 'function') updateMedicacionVisibility();
                        if (typeof cargarIecaAraUltimo === 'function') cargarIecaAraUltimo();
                        if (typeof cargarIecaAraHistorial === 'function') cargarIecaAraHistorial();
                        if (typeof cargarAntiagregantesUltimo === 'function') cargarAntiagregantesUltimo();
                        if (typeof cargarAntiagregantesHistorial === 'function') cargarAntiagregantesHistorial();
                        if (typeof cargarEstatinasUltimo === 'function') cargarEstatinasUltimo();
                        if (typeof cargarEstatinasHistorial === 'function') cargarEstatinasHistorial();
                        if (typeof cargarHipoglicemiasUltimo === 'function') cargarHipoglicemiasUltimo();
                    } catch(_e) { /* noop */ }
                } else {
                    // Usuario no encontrado - NO limpiar campos autom√°ticamente
                    console.log('üÜï Usuario no encontrado con RUN:', runOriginal);
                    
                    // ASEGURAR QUE EL RUN PERMANEZCA EN EL CAMPO
                    if (runInput.value !== runOriginal) {
                        console.log('üîß Restaurando RUN que se perdi√≥:', runOriginal);
                        runInput.value = runOriginal;
                    }
                    
                    // Ocultar mensaje de usuario encontrado
                    encontrado.style.display = 'none';
                    
                    // Mostrar mensaje informativo que permite continuar con nuevo usuario
                    const mensajeNuevo = document.getElementById('usuario-nuevo') || crearMensajeNuevoUsuario();
                    mensajeNuevo.style.display = 'block';
                    
                    // Ocultar secciones m√©dicas (usuario no existe)
                    ocultarSeccionesMedicas();
                    
                    // Limpiar solo la tabla de ex√°menes y acuerdos (ya que es un usuario nuevo)
                    actualizarTablaExamenes([]);
                    actualizarTablaAcuerdos([]);
                    
                    // Cargar patolog√≠as guardadas si las hay (pueden existir diagn√≥sticos sin estar en tabla usuarios)
                    cargarPatologiasGuardadas(runOriginal);
                    
                    // Habilitar botones de guardado independiente tambi√©n para usuarios nuevos
                    habilitarBotonesGuardadoIndependiente();
                    
                    // Permitir que el usuario contin√∫e llenando el formulario para crear un nuevo usuario
                    console.log('‚úÖ RUN preservado para nuevo usuario:', runInput.value);
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                console.error('Error buscando usuario:', error);
            });
        }

        // Variable para evitar m√∫ltiples inicializaciones
        let runEventListenersInitialized = false;
        
        console.log('üîß Definiendo funci√≥n initializarEventosRun...');
        
        // FUNCI√ìN PRINCIPAL DE INICIALIZACI√ìN - SOLO SE EJECUTA UNA VEZ
        function initializarEventosRun() {
            // PROTECCI√ìN: Evitar m√∫ltiples inicializaciones
            if (runEventListenersInitialized) {
                console.log('‚ö†Ô∏è Event listeners de RUN ya inicializados, omitiendo...');
                return;
            }
            
            console.log('üöÄ Inicializando eventos de RUN - √öNICA VEZ');
            
            const runInput = document.getElementById('run');
            console.log('üìç Elemento RUN encontrado:', runInput);
            
            if (!runInput) {
                console.error('‚ùå ERROR: No se encontr√≥ el elemento con ID "run"');
                return;
            }
            
            let timeoutId;
            
            // Utilidad para marcar estado visual del RUN
            function setRunEstado(estado) { 
                const el = document.getElementById('run');
                if (!el) return;
                
                el.classList.remove('run-valid', 'run-invalid');
                
                if (estado === true) { 
                    el.classList.add('run-valid'); 
                    el.title = 'RUN v√°lido';
                    console.log('‚úÖ RUN v√°lido detectado, habilitando botones de guardado independiente');
                    // Habilitar botones de guardado independiente cuando el RUN es v√°lido
                    if (typeof window.habilitarBotonesGuardadoIndependiente === 'function') {
                        window.habilitarBotonesGuardadoIndependiente();
                    }
                } else if (estado === false) { 
                    el.classList.add('run-invalid'); 
                    el.title = 'RUN inv√°lido';
                    console.log('‚ùå RUN inv√°lido, ocultando botones');
                    // Ocultar botones cuando el RUN es inv√°lido
                    if (typeof window.ocultarBotonesGestion === 'function') {
                        window.ocultarBotonesGestion();
                    }
                } else { 
                    el.title = '';
                    // NO hacer nada cuando RUN est√° incompleto para evitar interferencia
                    console.log('‚è≥ RUN incompleto, no se modifica UI');
                }
            }
            // Exponer para uso fuera del alcance de initializarEventosRun
            window.setRunEstado = setRunEstado;

            // Funci√≥n para habilitar botones de guardado independiente
            function habilitarBotonesGuardadoIndependiente() {
                console.log('üîì Habilitando botones de guardado independiente...');
                
                const container = document.getElementById('botones-gestion-patologias');
                const btnGuardarPatologias = document.getElementById('btn-guardar-patologias');
                const btnModificarPatologias = document.getElementById('btn-modificar-patologias');
                
                console.log('üîç Container encontrado:', !!container);
                console.log('üîç Bot√≥n guardar encontrado:', !!btnGuardarPatologias);
                console.log('üîç Bot√≥n modificar encontrado:', !!btnModificarPatologias);
                
                if (container) {
                    container.style.opacity = '1';
                    container.style.pointerEvents = 'auto';
                    container.style.borderColor = 'green';
                    container.style.backgroundColor = '#e8f5e8';
                    container.style.display = 'block';
                    
                    // Ocultar el mensaje de ayuda
                    const helpText = container.querySelector('small');
                    if (helpText) {
                        helpText.style.display = 'none';
                        console.log('üëª Mensaje de ayuda ocultado');
                    }
                    
                    console.log('‚úÖ Container habilitado con estilo verde');
                }
                
                if (btnGuardarPatologias) {
                    btnGuardarPatologias.disabled = false;
                    btnGuardarPatologias.style.cursor = 'pointer';
                    btnGuardarPatologias.style.opacity = '1';
                    btnGuardarPatologias.style.display = 'inline-block';
                    btnGuardarPatologias.title = 'Guardar solo las patolog√≠as seleccionadas';
                    console.log('‚úÖ Bot√≥n "Guardar Patolog√≠as" habilitado');
                } else {
                    console.log('‚ùå No se encontr√≥ el bot√≥n btn-guardar-patologias');
                }
                
                if (btnModificarPatologias) {
                    btnModificarPatologias.disabled = false;
                    btnModificarPatologias.style.cursor = 'pointer';
                    btnModificarPatologias.style.opacity = '1';
                    btnModificarPatologias.style.display = 'inline-block';
                    btnModificarPatologias.removeAttribute('aria-disabled');
                    btnModificarPatologias.title = 'Modificar patolog√≠as guardadas';
                    console.log('‚úÖ Bot√≥n "Modificar Patolog√≠as" habilitado');
                }
                
                console.log('‚úÖ Botones de guardado independiente habilitados completamente');
            }

            // Funci√≥n ocultarBotonesGestion() definida m√°s abajo en l√≠nea 14586

            // Funci√≥n para guardar patolog√≠as independientemente
            function guardarPatologiasIndependiente() {
                console.log('üíæ Guardando patolog√≠as independientemente...');
                
                const run = document.getElementById('run')?.value;
                if (!run || run.length < 8) {
                    const st = document.getElementById('patologiasStatus');
                    if (st) { st.textContent = '‚ö†Ô∏è Ingrese un RUN v√°lido antes de guardar patolog√≠as'; st.style.color = '#b91c1c'; }
                    return;
                }
                
                // Obtener checkboxes marcados
                const checkboxes = document.querySelectorAll('.patologia-checkbox:checked');
                const cie10Codes = Array.from(checkboxes).map(cb => cb.value);
                
                if (cie10Codes.length === 0) {
                    const st = document.getElementById('patologiasStatus');
                    if (st) { st.textContent = '‚ö†Ô∏è No hay patolog√≠as seleccionadas para guardar'; st.style.color = '#b45309'; }
                    return;
                }
                
                const confirmacion = confirm(`¬øDesea guardar ${cie10Codes.length} patolog√≠a(s) seleccionada(s) para el RUN ${run}?`);
                if (!confirmacion) return;
                
                // Crear FormData para enviar al endpoint principal del formulario
                const formData = new FormData();
                formData.append('run', run);
                formData.append('guardar_solo_patologias', '1'); // Flag para guardado independiente de patolog√≠as
                
                // Agregar todas las patolog√≠as seleccionadas
                cie10Codes.forEach(codigo => {
                    formData.append('patologia[]', codigo);
                });
                
                const st = document.getElementById('patologiasStatus');
                if (st) { st.textContent = 'Guardando patolog√≠as...'; st.style.color = '#0d47a1'; }

                fetch('/usuario/nuevo', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(data => {
                    const hasError = /Error|error|violates|constraint|null value/i.test(data||'');
                    if (hasError) {
                        const errorMatch = data.match(/Error[^<]*/i);
                        const msg = (errorMatch ? errorMatch[0] : 'Error desconocido');
                        if (st) { st.textContent = '‚ùå ' + msg; st.style.color = '#b91c1c'; }
                        return;
                    }
                    if (st) { st.textContent = '‚úÖ Patolog√≠as guardadas'; st.style.color = '#0f766e'; }
                    // Recargar patolog√≠as guardadas
                    if (typeof cargarPatologiasGuardadas === 'function') {
                        cargarPatologiasGuardadas(run);
                    }
                    // Limpiar mensaje despu√©s de unos segundos
                    setTimeout(() => { if (st && st.textContent.startsWith('‚úÖ')) st.textContent = ''; }, 3500);
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (st) { st.textContent = '‚ùå Error de conexi√≥n al guardar las patolog√≠as'; st.style.color = '#b91c1c'; }
                });
            }

            // Asignar funciones al objeto window para acceso global
            window.habilitarBotonesGuardadoIndependiente = habilitarBotonesGuardadoIndependiente;
            window.ocultarBotonesGestion = ocultarBotonesGestion;
            window.guardarPatologiasIndependiente = guardarPatologiasIndependiente;
            
            console.log('üåê Funciones asignadas globalmente:', {
                habilitarBotonesGuardadoIndependiente: typeof window.habilitarBotonesGuardadoIndependiente,
                ocultarBotonesGestion: typeof window.ocultarBotonesGestion,
                guardarPatologiasIndependiente: typeof window.guardarPatologiasIndependiente
            });
            
            // Funci√≥n de test para debugging
            window.testBotones = function() {
                console.log('üß™ Probando funciones de botones...');
                console.log('- guardarPatologiasIndependiente:', typeof window.guardarPatologiasIndependiente);
                console.log('- habilitarBotonesGuardadoIndependiente:', typeof window.habilitarBotonesGuardadoIndependiente);
                console.log('- ocultarBotonesGestion:', typeof window.ocultarBotonesGestion);
                
                const btnGuardar = document.getElementById('btn-guardar-patologias');
                const btnModificar = document.getElementById('btn-modificar-patologias');
                console.log('- Bot√≥n guardar encontrado:', !!btnGuardar);
                console.log('- Bot√≥n modificar encontrado:', !!btnModificar);
                
                if (btnGuardar) {
                    console.log('- Bot√≥n guardar onclick:', btnGuardar.onclick);
                    console.log('- Bot√≥n guardar disabled:', btnGuardar.disabled);
                }
                
                return 'Test completado - revisa la consola para detalles';
            };
            
            console.log('üîß Funci√≥n de test disponible: window.testBotones()');

            // Funci√≥n para manejar entrada del RUN (basada en index.html)
            function manejarBusquedaRun(e) {
                console.log('‚å®Ô∏è Input detectado en RUN:', e.target.value);
                
                // Aplicar el mismo formateo que index.html
                let v = e.target.value.replace(/[^0-9kK]/g, '').toUpperCase();
                
                // Formatear autom√°ticamente con puntos y gui√≥n (l√≥gica de index.html)
                if (v.length >= 2) {
                    // Separar cuerpo y d√≠gito verificador
                    const cuerpo = v.slice(0, -1);
                    const dv = v.slice(-1);
                    
                    // Agregar puntos cada 3 d√≠gitos desde la derecha (IGUAL que index.html)
                    const cuerpoFormateado = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    
                    // Combinar con gui√≥n
                    e.target.value = cuerpoFormateado + '-' + dv;
                } else {
                    // Si solo hay 1 car√°cter o menos, mostrar sin formato
                    e.target.value = v;
                }
                
                console.log('‚ú® Valor formateado (m√©todo index.html):', e.target.value);

                // Validar RUN solo si est√° completo (8+ caracteres)
                const runNormalizado = normalizarRun(e.target.value);
                const runLimpio = e.target.value.replace(/[^0-9kK]/g, '');
                
                console.log('üîç RUN normalizado:', runNormalizado, 'Limpio:', runLimpio, 'Longitud:', runLimpio.length);
                
                // Solo cambiar estado cuando RUN est√© completo (8+ caracteres)
                if (runLimpio.length >= 8) {
                    if (dvValido(runNormalizado)) {
                        console.log('‚úÖ RUN v√°lido, programando b√∫squeda...');
                        setRunEstado(true);
                        
                        // Limpiar timeout anterior
                        clearTimeout(timeoutId);
                        
                        // Buscar despu√©s de 500ms de inactividad
                        timeoutId = setTimeout(() => {
                            const runActual = document.getElementById('run').value;
                            if (runActual && runActual.length >= 8) {
                                console.log('üîç Ejecutando b√∫squeda para RUN:', runActual);
                                buscarUsuario(runActual);
                                
                                // *** FUNCIONALIDAD CONSOLIDADA DE LOS LISTENERS ELIMINADOS ***
                                
                                // 1. Cargar datos de pie diab√©tico y diabetes
                                try {
                                    applyPersistedRadios(runLimpio);
                                    setTimeout(() => cargarUltimaEvaluacionPieDM(runActual), 200);
                                    setTimeout(() => cargarTratamientoInsulinaDebounced(runActual, 50), 250);
                                    setTimeout(() => cargarPieDmUltimo(), 300);
                                    setTimeout(() => cargarHipoglicemiasUltimo(), 350);
                                    setTimeout(() => {
                                        if (runLimpio.length >= 8 && dvValido(normalizarRun(runActual))) {
                                            preloadDiabetesExamFields(runActual);
                                        }
                                    }, 400);
                                } catch (e) { console.warn('Error cargando datos de diabetes:', e); }
                                
                                // 2. Cargar funciones de diferentes m√≥dulos
                                try {
                                    if (typeof reloadAll === 'function') reloadAll();
                                } catch (e) { console.warn('Error en reloadAll:', e); }
                                
                                // 3. Cargar vacunas
                                try {
                                    if (typeof loadVacunas === 'function') loadVacunas(runActual);
                                } catch (e) { console.warn('Error cargando vacunas:', e); }
                                
                                // 4. Cargar checklist de adulto mayor
                                try {
                                    if (typeof cargarChecklist === 'function') cargarChecklist();
                                } catch (e) { console.warn('Error cargando checklist:', e); }
                                
                                // 5. Cargar datos de adulto mayor
                                try {
                                    const sec = document.getElementById('adultoMayorSection');
                                    if (sec && sec.style.display !== 'none') {
                                        if (typeof cargarUltimaAdultoMayor === 'function') cargarUltimaAdultoMayor();
                                        if (typeof cargarAmMaltratoUltimo === 'function') cargarAmMaltratoUltimo();
                                        if (typeof cargarAmMaltratoHistorial === 'function') cargarAmMaltratoHistorial();
                                    }
                                } catch (e) { console.warn('Error cargando datos adulto mayor:', e); }
                                
                                // 6. Cargar alertas de vigencia si est√°n visibles
                                try {
                                    if (alertsFloatVisible && typeof cargarAlertasVigenciaFlotante === 'function') {
                                        console.log('üîî Actualizando alertas para nuevo RUN:', runActual);
                                        setTimeout(() => cargarAlertasVigenciaFlotante(), 100);
                                    }
                                } catch (e) { console.warn('Error cargando alertas de vigencia:', e); }
                            }
                        }, 500);
                    } else {
                        console.log('‚ùå RUN inv√°lido');
                        setRunEstado(false);
                    }
                } else {
                    // NO hacer nada mientras el RUN est√° incompleto para evitar interferencia visual
                    console.log('‚è≥ RUN incompleto, longitud:', runLimpio.length, '- No se cambia estado');
                    // Quitar indicadores visuales sin llamar funciones que modifiquen la UI
                    const el = document.getElementById('run');
                    if (el) {
                        el.classList.remove('run-valid', 'run-invalid');
                        el.title = '';
                    }
                }
            }
            
            // ASIGNAR EVENTOS UNA SOLA VEZ
            console.log('üîó Asignando eventos al input RUN...');
            // Formateo y b√∫squeda con debounce al escribir
            runInput.addEventListener('input', manejarBusquedaRun);
            runInput.addEventListener('blur', manejarBusquedaRun);
            runInput.addEventListener('paste', function() {
                console.log('üìã Evento paste detectado');
                setTimeout(() => {
                    manejarBusquedaRun({ target: runInput });
                }, 100);
            });
            runInput.addEventListener('keyup', function(e) {
                console.log('‚å®Ô∏è Keyup detectado:', e.key);
                if (e.key === 'Enter') {
                    const runNormalizado = normalizarRun(runInput.value);
                    const runLimpio = runInput.value.replace(/[^0-9kK]/g, '');
                    if (runLimpio.length >= 8 && dvValido(runNormalizado)) {
                        console.log('üöÄ Enter presionado, buscando inmediatamente');
                        buscarUsuario(runInput.value);
                    }
                }
            });
            
            console.log('‚úÖ Eventos de RUN configurados correctamente');
            runEventListenersInitialized = true; // Marcar como inicializado
        }
        
        console.log('üîß [DEBUG] Funci√≥n initializarEventosRun definida correctamente');
        
        // INICIALIZACI√ìN √öNICA Y CONSOLIDADA
        console.log('üîß [DEBUG] Definiendo DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ÔøΩ DOMContentLoaded principal ejecut√°ndose...');
            console.log('üîß [DEBUG] Dentro de DOMContentLoaded - paso 1');
            // Refuerzo de carga de lista CIE10 eliminables (si la llamada temprana fall√≥ o tard√≥)
            if (typeof cargarCIE10Eliminables === 'function') {
                cargarCIE10Eliminables();
            }
            initializarEventosRun();
            console.log('üîß [DEBUG] Dentro de DOMContentLoaded - paso 2');

            // Si el RUN viene precargado (por query o POST), disparar b√∫squeda autom√°tica
            try {
                const runInput = document.getElementById('run');
                if (runInput) {
                    const valorInicial = (runInput.value || '').trim();
                    const runLimpio = valorInicial.replace(/[^0-9kK]/g, '');
                    const runNorm = normalizarRun(valorInicial);
                    if (runLimpio.length >= 8 && dvValido(runNorm)) {
                        // Asegurar formato consistente antes de disparar eventos
                        runInput.value = Common.formatearRUN(valorInicial);
                        setRunEstado(true);
                        setTimeout(() => {
                            try {
                                runInput.dispatchEvent(new Event('input', { bubbles: true }));
                                runInput.dispatchEvent(new Event('blur', { bubbles: true }));
                                
                                // Agregar un delay adicional para asegurar que despu√©s de cargar 
                                // los datos del usuario, se calcule la edad autom√°ticamente
                                setTimeout(() => {
                                    console.log('üéÇ Verificando c√°lculo de edad despu√©s de carga autom√°tica...');
                                    const fechaNacimiento = document.getElementById('fecha_nacimiento');
                                    if (fechaNacimiento && fechaNacimiento.value && typeof actualizarEdad === 'function') {
                                        console.log('üéÇ Ejecutando actualizarEdad() despu√©s de carga autom√°tica');
                                        actualizarEdad();
                                    }
                                }, 500);
                            } catch (_) {}
                        }, 120);
                    }
                }
            } catch (e) {
                console.warn('No se pudo inicializar b√∫squeda autom√°tica de RUN:', e);
            }

            // Inicializar otros eventos necesarios
            console.log('üîß [DEBUG] Dentro de DOMContentLoaded - paso 3');
            try {
                var sel = document.getElementById('cumplimiento');
                var acuerdosTextarea = document.getElementById('acuerdos');
                
                if (sel && acuerdosTextarea) {
                    setCumplimientoColor();
                    // Solo validar si no hay errores del servidor
                    if (!window.HAS_ERROR) {
                        validarCumplimientoRequerido();
                    } else {
                        console.log('üõ°Ô∏è Validaci√≥n inicial de cumplimiento omitida debido a error del servidor');
                    }
                    
                    sel.addEventListener('change', setCumplimientoColor);
                    acuerdosTextarea.addEventListener('input', validarCumplimientoRequerido);
                    acuerdosTextarea.addEventListener('blur', validarCumplimientoRequerido);
                }
            } catch (e) {
                console.warn('Elementos de cumplimiento no encontrados, omitiendo validaci√≥n');
            }
            
            // 3. Inicializar categor√≠as y familias colapsadas
            try {
                // Debug: contar cu√°ntas categor√≠as hay
                const categorias = document.querySelectorAll('.categoria-seccion');
                console.log('üîç Total de categor√≠as encontradas:', categorias.length);
                categorias.forEach((cat, index) => {
                    console.log(`üìÅ Categor√≠a ${index + 1}:`, cat.id, cat.style.display);
                });
                
                document.querySelectorAll('.categoria-content').forEach(cat => cat.classList.add('collapsed'));
                document.querySelectorAll('.familia-content').forEach(fam => fam.classList.add('collapsed'));
                document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '+');
                document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '+');
                
                // Agregar listeners para actualizar resumen de patolog√≠as
                document.querySelectorAll('.familia input[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', () => {
                        calcularRiesgo();
                        actualizarResumenPatologias();
                    });
                });
                
                calcularRiesgo();
                actualizarResumenPatologias();
                
                // Inicializar estado del bot√≥n de colapsar patolog√≠as
                actualizarContadoresCategorias();
                
                // Activar notificaciones de categor√≠a despu√©s de la carga inicial
                setTimeout(() => {
                    window.mostrarNotificacionesCategoria = true;
                    console.log('‚úÖ [CATEGORIA AUTO] Notificaciones de categor√≠a activadas');
                }, 1000); // Dar tiempo para que se complete la carga inicial
            } catch (e) {
                console.warn('Error en inicializaci√≥n de patolog√≠as:', e);
            }

            // Inicializar validaciones de rangos m√©dicos (PA, HbA1c, col, LDL, TAG, talla, etc.)
            try {
                validarRangosMedicos();
            } catch (e) {
                console.warn('No se pudo inicializar validarRangosMedicos:', e);
            }

            // Forzar colapso del cuadro de riesgo al cargar (siempre colapsado por defecto)
            try {
                const contenido = document.getElementById('contenido-cuadro-riesgo');
                const vistaColapsada = document.getElementById('vista-colapsada-cuadro');
                const encabezadoExpandido = document.getElementById('encabezado-expandido');
                const cuadro = document.getElementById('cuadro-riesgo-flotante');
                const shouldCollapse = true; // ignorar preferencia previa, siempre colapsado al iniciar
                if (contenido && vistaColapsada && encabezadoExpandido && cuadro) {
                    if (shouldCollapse) {
                        contenido.style.display = 'none';
                        encabezadoExpandido.style.display = 'none';
                        vistaColapsada.style.display = 'flex';
                        cuadro.style.minWidth = 'auto';
                        cuadro.style.maxWidth = '140px';
                        cuadro.style.padding = '8px 12px';
                        try { localStorage.setItem('cuadro_riesgo_colapsado','1'); } catch(e1) { /* ignore */ }
                    } else {
                        contenido.style.display = 'block';
                        encabezadoExpandido.style.display = 'flex';
                        vistaColapsada.style.display = 'none';
                        cuadro.style.minWidth = '380px';
                        cuadro.style.maxWidth = '450px';
                        cuadro.style.padding = '20px 24px';
                        try { localStorage.setItem('cuadro_riesgo_colapsado','0'); } catch(e2) { /* ignore */ }
                    }
                }
            } catch (e) { console.warn('No se pudo aplicar preferencia de cuadro de riesgo', e); }
        });

        console.log('üîß [DEBUG] DOMContentLoaded definido correctamente');

        // Funci√≥n para limpiar el formulario
        console.log('üîß [DEBUG] Definiendo funci√≥n limpiarFormulario...');
        function limpiarFormulario(forzar = false) {
            // PROTECCI√ìN CONTRA ERRORES: NO limpiar si hay errores del servidor (EXCEPTO si se fuerza)
            if (window.HAS_ERROR && !forzar) {
                console.log('üö® NO limpiando formulario porque hay errores del servidor (HAS_ERROR=true). Use forzar=true para saltarse esta protecci√≥n.');
                return false;
            }
            
            // PROTECCI√ìN: NO limpiar si se est√° cargando un usuario
            if (window.CARGANDO_USUARIO) {
                console.log('üö® NO limpiando formulario porque se est√° cargando un usuario');
                return false;
            }
            
            // Marcar que estamos limpiando para evitar recargas autom√°ticas
            window.LIMPIANDO_FORMULARIO = true;
            
            // PROTECCI√ìN: NO limpiar el campo RUN nunca
            const runInput = document.getElementById('run');
            const runValue = runInput ? runInput.value : '';
            
            console.log('üßπ [LIMPIAR] Iniciando limpieza de formulario');
            
            try {
                // Limpiar todos los inputs de texto, number, date EXCEPTO el RUN y campos protegidos
                const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="tel"], input[type="time"]');
                inputs.forEach(input => {
                    if (input.id === 'run' || input.dataset.protegido) return; // NO limpiar el RUN ni campos protegidos
                    if (input.type === 'date') {
                        try { 
                            input.value = ''; 
                            const overlay = document.getElementById(input.id + '_espanol'); 
                            if (overlay) overlay.value = ''; 
                            input.disabled = false;
                        } catch(_) {}
                    } else {
                        input.value = '';
                    }
                });
                
                // Limpiar textareas
                const textareas = document.querySelectorAll('textarea');
                textareas.forEach(t => { t.value = ''; });
                
                // Limpiar hidden relevantes (submit_action)
                const submitAction = document.getElementById('submit_action');
                if (submitAction) submitAction.value = '';
                
                // Limpiar selects
                const selects = document.querySelectorAll('select');
                selects.forEach(select => select.selectedIndex = 0);
                
                // Desmarcar checkboxes (incluyendo patolog√≠as ECICEP)
                const checkboxes = document.querySelectorAll('input[type="checkbox"], .patologia-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = false);

                // Radios: mantener programa; si hubiera otros radios, limpiarlos
                const radios = document.querySelectorAll('input[type="radio"]');
                radios.forEach(r => {
                    if (r.name !== 'programa') {
                        r.checked = false;
                    }
                });

                // Reset espec√≠fico EKG
                try {
                    const ekgChk = document.querySelector('input[name="ekg"]');
                    const ekgFecha = document.getElementById('ekgFecha');
                    if (ekgChk) ekgChk.checked = false;
                    if (ekgFecha) { 
                        ekgFecha.value = ''; 
                        const ekgOverlay = document.getElementById('ekgFecha_espanol');
                        if (ekgOverlay) ekgOverlay.value = '';
                        ekgFecha.disabled = true; 
                        ekgFecha.classList.remove('input-error-ekg'); 
                    }
                } catch(_) {}
                
                // Ocultar mensajes
                const loading = document.getElementById('loading');
                const encontrado = document.getElementById('usuario-encontrado');
                const mensajeNuevo = document.getElementById('usuario-nuevo');
                if (loading) loading.style.display = 'none';
                if (encontrado) encontrado.style.display = 'none';
                if (mensajeNuevo) mensajeNuevo.style.display = 'none';
                
                // Ocultar banners globales y mini-banners locales
                try { document.querySelectorAll('.mensaje.exito, .mensaje.error').forEach(el => el.style.display = 'none'); } catch(_) {}
                const miniOkExamen = document.getElementById('examen-guardado-ok');
                if (miniOkExamen) miniOkExamen.style.display = 'none';
                
                // Limpiar resumen de patolog√≠as guardadas SOLO visualmente
                try {
                    const container = document.getElementById('patologias-guardadas');
                    if (container) {
                        container.innerHTML = '<span class="pat-empty" style="color: #6b7280;">Sin patolog√≠as guardadas en base de datos</span>';
                    }
                } catch(_) {}
                
                // Reset visual de IMC live
                try {
                    const imcVal = document.getElementById('imcLiveValor');
                    const imcChip = document.getElementById('imcLiveClas');
                    if (imcVal) imcVal.textContent = '-';
                    if (imcChip) { imcChip.textContent = ''; imcChip.style.display = 'none'; }
                } catch(_) {}

                // üßπ LIMPIAR TODOS LOS HISTORIALES (espec√≠ficos por usuario)
                try {
                    const historialIds = [
                        'fondoOjosHist', 'pieDmHist', 'podologiaHist', 'hipoHist', 'curacionPieHist',
                        'cvRiesgoHist', 'cvActHist', 'cvTabHist', 'cvHeartsHist',
                        'medIecaHist', 'medAntiHist', 'medEstatHist',
                        'amMaltratoHist', 'imcHist', 'psaHist',
                        'pieDmHistorial', 'insulinaHistorial'
                    ];
                    
                    const historialBodyIds = [
                        'fondoOjosHistBody', 'pieDmHistBody', 'podologiaHistBody', 'hipoHistBody', 'curacionPieHistBody',
                        'cvRiesgoHistBody', 'cvActHistBody', 'cvTabHistBody', 'cvHeartsHistBody',
                        'medIecaHistBody', 'medAntiHistBody', 'medEstatHistBody',
                        'amMaltratoHistBody', 'imcHistBody', 'psaHistBody',
                        'pieDmHistorialContent', 'insulinaHistorialEntries'
                    ];
                    
                    const ultimoRegistroIds = [
                        'pieDmUltimo', 'fondoOjosUltimo', 'podologiaUltimo', 'hipoUltimo', 'curacionPieUltimo',
                        'cvRiesgoUltimo', 'cvActUltimo', 'cvTabUltimo', 'cvHeartsUltimo',
                        'medIecaUltimo', 'medAntiUltimo', 'medEstatUltimo',
                        'insulinaUltimoRegistro', 'ultimaEvaluacionPieDM'
                    ];
                    
                    // Ocultar contenedores de historiales
                    console.log('üßπ [DEBUG] Limpiando historiales...');
                    historialIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`‚úÖ Historial ${id} ocultado`);
                        } else {
                            console.log(`‚ùå Historial ${id} NO encontrado`);
                        }
                    });
                    
                    // Limpiar contenido de las tablas/contenedores de historiales
                    historialBodyIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            if (element.tagName === 'TBODY') {
                                element.innerHTML = '<tr><td colspan="10" style="text-align:center; color:#6b7280; padding:8px;">Sin datos</td></tr>';
                            } else {
                                element.innerHTML = '<div style="text-align:center; color:#6b7280; padding:8px;">Sin datos disponibles</div>';
                            }
                            console.log(`‚úÖ Contenido de ${id} limpiado`);
                        } else {
                            console.log(`‚ùå Contenido ${id} NO encontrado`);
                        }
                    });
                    
                    // Ocultar y limpiar cajas de "√∫ltimo registro"
                    ultimoRegistroIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            element.innerHTML = '<em>Ingrese un RUN v√°lido para cargar √∫ltima evaluaci√≥n...</em>';
                        }
                    });
                    
                    console.log('üßπ [LIMPIAR] Historiales y √∫ltimos registros limpiados completamente');
                } catch(error) {
                    console.error('‚ùå Error limpiando historiales:', error);
                }

                // üßπ LIMPIEZA ADICIONAL ESPEC√çFICA PARA MEDICACI√ìN
                try {
                    console.log('üßπ [DEBUG] Limpieza adicional de medicaci√≥n...');
                    
                    // Forzar limpieza espec√≠fica de los historiales visibles en la imagen
                    const medicacionHistoriales = [
                        'medIecaHist', 'medAntiHist', 'medEstatHist'
                    ];
                    
                    medicacionHistoriales.forEach(id => {
                        const elemento = document.getElementById(id);
                        if (elemento) {
                            elemento.style.display = 'none';
                            elemento.style.visibility = 'hidden';
                            const tabla = elemento.querySelector('table');
                            const tbody = elemento.querySelector('tbody');
                            if (tabla) tabla.style.display = 'none';
                            if (tbody) tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Sin datos</td></tr>';
                            console.log(`üßπ Historial medicaci√≥n ${id} limpiado a fondo`);
                        }
                    });
                    
                    // Limpiar tambi√©n las cajas de "Nuevo Registro"
                    const botonesNuevo = ['medIecaNuevoBtn', 'medAntiNuevoBtn', 'medEstatNuevoBtn'];
                    botonesNuevo.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) btn.style.display = 'none';
                    });
                    
                    // Limpiar elementos de vigencia activa de medicaci√≥n
                    const vigenciaIds = ['medIecaVigencia', 'medAntiVigencia', 'medEstatVigencia'];
                    vigenciaIds.forEach(id => {
                        const elemento = document.getElementById(id);
                        if (elemento) {
                            elemento.style.display = 'none';
                            elemento.textContent = '';
                        }
                    });
                    
                    // Limpiar estados de medicaci√≥n
                    const statusIds = ['medIecaStatus', 'medAntiStatus', 'medEstatStatus'];
                    statusIds.forEach(id => {
                        const status = document.getElementById(id);
                        if (status) {
                            status.textContent = '';
                            status.style.display = 'none';
                        }
                    });
                    
                } catch(error) {
                    console.error('‚ùå Error en limpieza adicional:', error);
                }

                // Asegurar que fecha de ingreso quede editable y vac√≠a (ya se limpia como campo texto)
                // Verificar espec√≠ficamente el campo fecha_ingreso para asegurar que est√© funcional
                try {
                    const fechaIngresoInput = document.getElementById('fecha_ingreso');
                    if (fechaIngresoInput) {
                        fechaIngresoInput.disabled = false;
                        fechaIngresoInput.readOnly = false;
                        fechaIngresoInput.value = '';
                        fechaIngresoInput.style.backgroundColor = '';
                        fechaIngresoInput.style.borderColor = '';
                        console.log('‚úÖ Campo fecha_ingreso habilitado y limpio');
                    }
                } catch(_) {}
                
                // RESTAURAR el RUN si se perdi√≥ accidentalmente
                if (runInput && runInput.value !== runValue) {
                    console.log('üîß RUN restaurado en limpiarFormulario:', runValue);
                    runInput.value = runValue;
                }

                // Limpiar hash del URL si apunta a alguna ancla (opcional)
                try { if (window.location.hash) history.replaceState({}, '', window.location.pathname + window.location.search); } catch(_) {}

                // Limpiar snapshot persistido (si existe)
                try {
                    const formEl = document.getElementById('usuarioForm');
                    const run = (formEl?.querySelector('#run')?.value || '').trim();
                    const keys = ['usuarioFormSnapshot'];
                    if (run) keys.push(`usuarioFormSnapshot:${run}`);
                    keys.forEach(k => { try { sessionStorage.removeItem(k); } catch(_){} });
                } catch(_) {}
                
                console.log('‚úÖ [LIMPIAR] Formulario limpiado correctamente');
                
                // Limpiar bandera de limpieza
                setTimeout(() => {
                    window.LIMPIANDO_FORMULARIO = false;
                    console.log('üèÅ Limpieza completada, bandera removida');
                }, 2000);
                
            } catch(error) {
                console.warn('‚ö†Ô∏è Error durante limpieza de formulario:', error);
                window.LIMPIANDO_FORMULARIO = false;
            }
        }

        console.log('üîß [DEBUG] Funci√≥n limpiarFormulario definida correctamente');

        // Bot√≥n: Nuevo usuario (limpia todo y deja RUN en blanco, modo Cardio por defecto)
        function nuevoUsuario() {
            try {
                // Reset de formulario completo
                const form = document.getElementById('usuarioForm');
                if (form) form.reset();
                
                // Llamar a limpiarFormulario para limpiar historiales y √∫ltimo registros (FORZAR limpieza)
                try {
                    if (typeof limpiarFormulario === 'function') {
                        limpiarFormulario(true); // forzar=true para saltarse protecci√≥n HAS_ERROR
                    }
                } catch(_) {}
                
                // Limpiar snapshot
                try {
                    const run = (form?.querySelector('#run')?.value || '').trim();
                    const keys = ['usuarioFormSnapshot'];
                    if (run) keys.push(`usuarioFormSnapshot:${run}`);
                    keys.forEach(k => { try { sessionStorage.removeItem(k); } catch(_){} });
                } catch(_) {}
                // Limpiar radios persistidos 1 a√±o para el RUN actual
                try {
                    const rr = (document.querySelector('input[name="run"]')?.value || '').replace(/[^0-9kK]/g,'');
                    if (rr) {
                        (PERSIST_RADIO_FIELDS || []).forEach(name => {
                            const key = `persist1y:radio:${name}:${rr}`;
                            try { localStorage.removeItem(key); } catch(_){}
                        });
                    }
                } catch(_) {}
                
                // üßπ LIMPIEZA ESPEC√çFICA DE MEDICACI√ìN ACTIVA (Nuevo Usuario)
                try {
                    console.log('üßπ [NUEVO USUARIO] Limpiando medicaci√≥n activa...');
                    
                    // Limpiar elementos de vigencia de medicaci√≥n
                    const vigenciaIds = ['medIecaVigencia', 'medAntiVigencia', 'medEstatVigencia'];
                    vigenciaIds.forEach(id => {
                        const elemento = document.getElementById(id);
                        if (elemento) {
                            elemento.style.display = 'none';
                            elemento.textContent = '';
                            console.log(`‚úÖ ${id} limpiado`);
                        }
                    });
                    
                    // Limpiar botones "Nuevo Registro" de medicaci√≥n
                    const botonesNuevo = ['medIecaNuevoBtn', 'medAntiNuevoBtn', 'medEstatNuevoBtn'];
                    botonesNuevo.forEach(id => {
                        const btn = document.getElementById(id);
                        if (btn) {
                            btn.style.display = 'none';
                            console.log(`‚úÖ Bot√≥n ${id} ocultado`);
                        }
                    });
                    
                    // Limpiar estados de medicaci√≥n
                    const statusIds = ['medIecaStatus', 'medAntiStatus', 'medEstatStatus'];
                    statusIds.forEach(id => {
                        const status = document.getElementById(id);
                        if (status) {
                            status.textContent = '';
                            status.style.display = 'none';
                            console.log(`‚úÖ Status ${id} limpiado`);
                        }
                    });
                    
                    console.log('‚úÖ [NUEVO USUARIO] Medicaci√≥n activa limpiada');
                } catch(error) {
                    console.error('‚ùå Error limpiando medicaci√≥n activa:', error);
                }
                
                // Limpiar checklist de patolog√≠as y tablas
                try { limpiarPatologiasGuardadas(); } catch(_e){}
                try { actualizarTablaExamenes([]); } catch(_e){}
                try { actualizarTablaAcuerdos([]); } catch(_e){}
                // Ocultar banners de encontrado/nuevo
                const encontrado = document.getElementById('usuario-encontrado');
                const mensajeNuevo = document.getElementById('usuario-nuevo');
                if (encontrado) encontrado.style.display = 'none';
                if (mensajeNuevo) mensajeNuevo.style.display = 'none';
                // Vaciar RUN y enfocar
                const runInput = document.getElementById('run');
                if (runInput) { runInput.value=''; runInput.focus(); }
                // Poner Cardio por defecto
                try { setPrograma('cardio'); } catch(_e){}
                // Notificar
                const badge = document.getElementById('programa-badge');
                if (badge) badge.textContent = 'Cardio';
            } catch (e) {
                console.warn('No se pudo inicializar "Nuevo usuario"', e);
            }
        }

        // Funci√≥n para limpiar el resumen de patolog√≠as guardadas
        console.log('üîß [DEBUG] Definiendo funci√≥n limpiarPatologiasGuardadas...');
        function limpiarPatologiasGuardadas() {
            const container = document.getElementById('patologias-guardadas');
            if (container) {
                container.innerHTML = '<span class="pat-empty" style="color: #6b7280;">Sin patolog√≠as guardadas en base de datos</span>';
            }
            // Asegura ocultar y deshabilitar los botones de gesti√≥n
            ocultarBotonesGestion();
        }

        // Funci√≥n para obtener el color de fondo seg√∫n el c√≥digo CIE10
        console.log('üîß [DEBUG] Definiendo funci√≥n obtenerColorPatologia...');
        function obtenerColorPatologia(cie10) {
            switch(cie10) {
                case 'I10': // Hipertensi√≥n esencial
                    return '#ef4444'; // Rojo
                case 'E10': // Diabetes mellitus insulinodependiente
                case 'E11': // Diabetes mellitus no insulinodependiente
                    return '#22c55e'; // Verde
                case 'E78': // Dislipidemia
                    return '#eab308'; // Amarillo
                default:
                    return '#059669'; // Verde por defecto para otras patolog√≠as
            }
        }

        // Funci√≥n para actualizar el resumen de patolog√≠as guardadas desde la BD
        console.log('üîß [DEBUG] Definiendo funci√≥n actualizarPatologiasGuardadas...');
        function actualizarPatologiasGuardadas(patologias) {
            const container = document.getElementById('patologias-guardadas');
            if (!container) return;
            
            if (!patologias || patologias.length === 0) {
                limpiarPatologiasGuardadas();
                ocultarBotonEliminar();
                return;
            }
            
            // Crear badges para cada patolog√≠a guardada con colores espec√≠ficos
            const badges = patologias.map(patologia => {
                const nombre = patologia.nombre || '';
                const cie10 = patologia.cie10 || '';
                const nombreTruncado = nombre.length > 40 ? nombre.substring(0, 37) + '...' : nombre;
                
                // Usar el color que viene del endpoint o calcular uno
                let colorFondo;
                if (patologia.color) {
                    // Convertir el color del endpoint a hex
                    switch(patologia.color) {
                        case 'red':
                            colorFondo = '#dc3545';
                            break;
                        case 'green':
                            colorFondo = '#28a745';
                            break;
                        case 'yellow':
                            colorFondo = '#ffc107';
                            break;
                        default:
                            colorFondo = '#6c757d';
                    }
                } else {
                    colorFondo = obtenerColorPatologia(cie10);
                }
                
                return `
                    <span class="pat-badge guardada" 
                          style="background: ${colorFondo}; color: white; margin: 2px; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: inline-block;"
                          title="${nombre} (${cie10})">
                        ${nombreTruncado} (${cie10})
                    </span>
                `;
            }).join('');
            
            container.innerHTML = `
                <div style="margin-bottom: 4px;">
                    <small style="color: #059669; font-weight: 600;">${patologias.length} patolog√≠a(s) guardada(s):</small>
                </div>
                ${badges}
            `;
            
            // Mostrar botones de gesti√≥n cuando hay patolog√≠as
            mostrarBotonEliminar();
            
            // Marcar checkboxes y expandir categor√≠as seg√∫n patolog√≠as guardadas
            marcarPatologiasGuardadas(patologias);
        }

        console.log('üöß [DEBUG] Llegando a definir funci√≥n cargarPatologiasGuardadas...');
        
        // Funci√≥n para cargar patolog√≠as guardadas desde la API
        function cargarPatologiasGuardadas(run) {
            console.log('üîç [NUEVO] Cargando patolog√≠as para RUN:', run);
            console.log('üèóÔ∏è [DEBUG] Funci√≥n cargarPatologiasGuardadas definida correctamente');
            
            // Validaci√≥n m√°s estricta: verificar que el RUN est√© completo y sea v√°lido
            if (!run || run.length < 8) {
                console.log('üîç [NUEVO] RUN muy corto o vac√≠o:', run, 'longitud:', run ? run.length : 0);
                limpiarPatologiasGuardadas();
                return;
            }
            
            // Limpiar RUN para validaci√≥n
            const runLimpioValidacion = run.replace(/[\.\-\s]/g, '');
            if (runLimpioValidacion.length < 8) {
                console.log('üîç [NUEVO] RUN limpio muy corto:', runLimpioValidacion, 'longitud:', runLimpioValidacion.length);
                limpiarPatologiasGuardadas();
                return;
            }
            
            // Validar formato b√°sico (solo n√∫meros y K al final)
            if (!/^\d{7,8}[0-9K]$/i.test(runLimpioValidacion)) {
                console.log('üîç [NUEVO] RUN con formato inv√°lido:', runLimpioValidacion);
                limpiarPatologiasGuardadas();
                return;
            }

            const container = document.getElementById('patologias-guardadas');
            if (!container) {
                console.error('‚ùå [NUEVO] No se encontr√≥ container patologias-guardadas');
                return;
            }
            
            // Mostrar estado de carga
            container.innerHTML = '<span style="color:#6b7280;">üîÑ Cargando patolog√≠as...</span>';
            
            // Limpiar RUN para la API (solo n√∫meros y K)
            const runLimpio = run.replace(/[\.\-\s]/g, '');
            console.log('üîç [NUEVO] RUN limpio para API:', runLimpio);
            
            const url = `/api/patologias/${runLimpio}`;
            console.log('üîç [NUEVO] URL:', url);
            
            fetch(url)
                .then(response => {
                    console.log('üì° [NUEVO] Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ÔøΩ [NUEVO] Data received:', data);
                    
                    if (data.patologias && Array.isArray(data.patologias) && data.patologias.length > 0) {
                        console.log('‚úÖ [NUEVO] Mostrando', data.patologias.length, 'patolog√≠as');
                        mostrarPatologiasEnContainer(data.patologias);
                        
                        // ¬°AQU√ç EST√Å LA CORRECCI√ìN! Marcar checkboxes autom√°ticamente
                        console.log('üéØ [NUEVO] Marcando checkboxes para patolog√≠as guardadas');
                        marcarCheckboxesPatologias(data.patologias);
                        try { updateMedicacionVisibility(); } catch(_e){}
                        try { updatePieDmVisibility(); } catch(_e){}
                        
                        // Calcular riesgo autom√°ticamente despu√©s de marcar checkboxes
                        setTimeout(() => {
                            console.log('üìä [NUEVO] Calculando riesgo autom√°ticamente');
                            calcularRiesgo();
                            actualizarCategoriaAutomatica();
                        }, 100);
                    } else {
                        console.log('‚ö™ [NUEVO] Sin patolog√≠as');
                        container.innerHTML = '<span style="color:#6b7280;">Sin patolog√≠as guardadas</span>';
                    }
                })
                .catch(error => {
                    console.error('‚ùå [NUEVO] Error:', error);
                    container.innerHTML = '<span style="color:#dc3545;">Error cargando patolog√≠as</span>';
                });
        }
        
        // Funci√≥n para mostrar patolog√≠as en el container
        function mostrarPatologiasEnContainer(patologias) {
            console.log('üé® [NUEVO] Mostrando patolog√≠as en container:', patologias);
            
            const container = document.getElementById('patologias-guardadas');
            if (!container) {
                console.error('‚ùå [NUEVO] Container no encontrado');
                return;
            }
            
            // Crear badges para cada patolog√≠a
            const badges = patologias.map(pat => {
                console.log('üè∑Ô∏è [NUEVO] Procesando patolog√≠a:', pat);
                
                const nombre = pat.nombre || 'Sin nombre';
                const cie10 = pat.cie10 || 'Sin c√≥digo';
                const color = pat.color || 'default';
                
                // Mapear colores a CSS
                let bgColor;
                let textColor = 'white';
                
                switch(color) {
                    case 'red':
                        bgColor = '#dc3545';
                        break;
                    case 'green':
                        bgColor = '#28a745';
                        break;
                    case 'yellow':
                        bgColor = '#ffc107';
                        textColor = 'black';
                        break;
                    default:
                        bgColor = '#6c757d';
                }
                
                return `
                    <span style="
                        background: ${bgColor}; 
                        color: ${textColor}; 
                        padding: 4px 8px; 
                        margin: 2px; 
                        border-radius: 4px; 
                        display: inline-block; 
                        font-size: 11px;
                    " title="${nombre} - ${cie10}">
                        ${nombre} (${cie10})
                    </span>
                `;
            }).join('');
            
            container.innerHTML = `
                <div style="margin-bottom: 4px;">
                    <small style="color: #059669; font-weight: 600;">
                        ‚úÖ ${patologias.length} patolog√≠a(s) guardada(s):
                    </small>
                </div>
                ${badges}
            `;
            
            // Marcar checkboxes correspondientes a las patolog√≠as guardadas
            marcarCheckboxesPatologias(patologias);
            try { updateMedicacionVisibility(); } catch(_e){}
            try { updatePieDmVisibility(); } catch(_e){}
            
            console.log('‚úÖ [NUEVO] Patolog√≠as mostradas exitosamente');
        }

        // Funci√≥n para marcar checkboxes correspondientes a patolog√≠as guardadas
        function marcarCheckboxesPatologias(patologias) {
            console.log('üéØ [CHECKBOX] Marcando checkboxes para patolog√≠as:', patologias);
            
            // IMPORTANTE: Antes se desmarcaban TODOS los checkboxes cada vez que
            // se recargaban las patolog√≠as guardadas, lo que hac√≠a que al marcar
            // nuevas patolog√≠as (a√∫n no guardadas) fueran "perdidas" (desmarcadas)
            // en la siguiente recarga autom√°tica.
            // Nuevo comportamiento: solo en la PRIMERA carga (cuando a√∫n no se ha
            // establecido el set inicial) se limpia para reflejar exactamente lo
            // que est√° en BD. Luego, cualquier selecci√≥n nueva del usuario (pendiente
            // de guardar) se mantiene persistente en el estado visual hasta que √©l
            // decida guardar o desmarcar manualmente.
            if (!window._patologiasGuardadasInicialCargadas) {
                const todosCheckboxes = document.querySelectorAll('.patologia-checkbox');
                console.log('üßπ [CHECKBOX] Primera carga: limpiando selecci√≥n previa. Total:', todosCheckboxes.length);
                todosCheckboxes.forEach(cb => cb.checked = false);
                window._patologiasGuardadasInicialCargadas = true;
            } else {
                console.log('üîÑ [CHECKBOX] Carga subsecuente: se preservan selecciones locales nuevas (no se limpian todas)');
            }
            
            // Marcar solo los que est√°n guardados (con matching robusto)
            patologias.forEach(patologia => {
                let cie10 = (patologia.cie10||'').trim();
                if (!cie10 || cie10 === 'Sin c√≥digo') {
                    console.log('‚ö†Ô∏è [CHECKBOX] Patolog√≠a sin c√≥digo CIE-10:', patologia.nombre);
                    return;
                }
                const cie10Norm = cie10.replace(/[\.\s]/g,'').toUpperCase();
                let checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
                if(!checkbox){
                    const all = document.querySelectorAll('.patologia-checkbox');
                    for(const cb of all){
                        const valNorm = String(cb.value||'').replace(/[\.\s]/g,'').toUpperCase();
                        if(valNorm === cie10Norm){ checkbox = cb; break; }
                    }
                }
                if (checkbox) {
                    checkbox.checked = true;
                    console.log('‚úÖ [CHECKBOX] Marcado:', cie10, '-', patologia.nombre);
                    expandirSeccionContenedora(checkbox);
                } else {
                    console.log('üîé [CHECKBOX] No se encontr√≥ checkbox para', cie10, '(norm:', cie10Norm, ')');
                }
            });
            
            console.log('üéØ [CHECKBOX] Proceso de marcado completado');
            try { updatePieDmVisibility(); } catch(_e){}
            try { updateMedicacionVisibility(); } catch(_e){}
        }

        // Funci√≥n para expandir autom√°ticamente la secci√≥n que contiene un checkbox marcado
        function expandirSeccionContenedora(checkbox) {
            // Buscar la familia contenedora
            const familiaContent = checkbox.closest('.familia-content');
            if (familiaContent) {
                // Expandir la familia
                familiaContent.classList.remove('collapsed');
                
                // Buscar y actualizar el bot√≥n toggle de la familia
                const familia = familiaContent.closest('.familia');
                if (familia) {
                    const familiaToggle = familia.querySelector('.familia-toggle');
                    if (familiaToggle) {
                        familiaToggle.textContent = '-';
                    }
                }
                
                // Buscar la categor√≠a contenedora
                const categoriaContent = familiaContent.closest('.categoria-content');
                if (categoriaContent) {
                    // Expandir la categor√≠a
                    categoriaContent.classList.remove('collapsed');
                    
                    // Buscar y actualizar el bot√≥n toggle de la categor√≠a
                    const categoria = categoriaContent.closest('.categoria-seccion');
                    if (categoria) {
                        const categoriaToggle = categoria.querySelector('.categoria-toggle');
                        if (categoriaToggle) {
                            categoriaToggle.textContent = '-';
                        }
                    }
                }
            }
        }

        // Funci√≥n para manejar la selecci√≥n de patolog√≠as (sistema aditivo)
        // ================== NUEVA L√ìGICA: CAMBIOS LOCALES SIN GUARDADO AUTOM√ÅTICO ==================
        // Conjunto base (patolog√≠as guardadas al cargar) y cambios pendientes
        window._patologiasBase = window._patologiasBase || new Set();
        window._patologiasAgregadas = window._patologiasAgregadas || new Set();
        window._patologiasRemovidas = window._patologiasRemovidas || new Set();

        function inicializarBaselinePatologias() {
            // Construir baseline a partir de checkboxes actualmente marcados (solo primera vez tras carga inicial)
            window._patologiasBase = new Set(
                Array.from(document.querySelectorAll('.patologia-checkbox:checked')).map(cb => cb.value)
            );
            window._patologiasAgregadas.clear();
            window._patologiasRemovidas.clear();
            actualizarIndicadorCambiosPatologias();
            console.log('üü¢ [BASE] Baseline patolog√≠as inicializada:', window._patologiasBase);
        }

        function registrarCambioPatologia(checkbox) {
            const code = checkbox.value;
            const checked = checkbox.checked;
            if (!window._patologiasBase) inicializarBaselinePatologias();

            if (checked) {
                // Si estaba marcada originalmente y la hab√≠amos puesto en removidas, revertir
                if (window._patologiasRemovidas.has(code)) window._patologiasRemovidas.delete(code);
                // Si NO estaba en baseline, es agregada nueva
                if (!window._patologiasBase.has(code)) window._patologiasAgregadas.add(code);
            } else {
                // Si estaba en baseline y se desmarca => removida
                if (window._patologiasBase.has(code)) window._patologiasRemovidas.add(code);
                // Si era nueva agregada y se desmarca antes de guardar, quitar de agregadas
                if (window._patologiasAgregadas.has(code)) window._patologiasAgregadas.delete(code);
            }
            actualizarIndicadorCambiosPatologias();
            // Recalcular riesgo solo visual
            if (typeof calcularRiesgo === 'function') calcularRiesgo();
        }

        function actualizarIndicadorCambiosPatologias() {
            const ind = document.getElementById('indicador-cambios-patologias');
            if (!ind) return;
            const addCount = window._patologiasAgregadas.size;
            const remCount = window._patologiasRemovidas.size;
            if (addCount === 0 && remCount === 0) {
                ind.style.display = 'none';
            } else {
                ind.style.display = 'block';
                ind.textContent = `Cambios pendientes: +${addCount} / -${remCount}. Recuerde presionar "Guardar Patolog√≠as".`;
            }
        }

        // Sobrescribir guardarPatologiasIndependiente para integrar baseline y limpiar cambios
        const _guardarOriginal = window.guardarPatologiasIndependiente;
        window.guardarPatologiasIndependiente = function() {
            // Recolectar todas las patolog√≠as actualmente marcadas
            const actuales = Array.from(document.querySelectorAll('.patologia-checkbox:checked')).map(cb => cb.value);
            // Reutilizar flujo original (env√≠a todas las patolog√≠as marcadas)
            _guardarOriginal?.();
            // Al finalizar (√©xito detectado v√≠a alert), reconstruir baseline despu√©s de un peque√±o delay
            setTimeout(() => {
                inicializarBaselinePatologias();
            }, 500);
        };

        // Exclusividad subopciones I64 (H/I/N)
        function configurarExclusividadI64() {
            const ids = ['I64H','I64I','I64N'];
            const elementos = ids.map(id => document.getElementById(id)).filter(Boolean);
            elementos.forEach(el => {
                el.addEventListener('change', () => {
                    if (el.checked) {
                        elementos.forEach(o => { if (o !== el) o.checked = false; });
                        // Registrar cambios para los otros desmarcados
                        elementos.forEach(o => { if (o !== el) registrarCambioPatologia(o); });
                        registrarCambioPatologia(el);
                        guardarVarianteI64Local(el.id);
                    } else {
                        registrarCambioPatologia(el);
                    }
                });
            });
        }

        function guardarVarianteI64Local(id) {
            try {
                const run = document.getElementById('run')?.value || '';
                const runKey = run.replace(/[^0-9Kk]/g,'');
                if (!runKey) return;
                let code;
                if (id === 'I64H') code = 'I64-H'; else if (id === 'I64I') code = 'I64-I'; else code = 'I64';
                localStorage.setItem('i64_variant_' + runKey, code);
                console.log('[I64] Variante almacenada localmente:', code);
            } catch(e) { console.warn('[I64] No se pudo guardar variante local:', e); }
        }

        function aplicarVarianteI64LocalSiCorresponde() {
            try {
                const run = document.getElementById('run')?.value || '';
                const runKey = run.replace(/[^0-9Kk]/g,'');
                if (!runKey) return;
                const stored = localStorage.getItem('i64_variant_' + runKey);
                if (!stored) return;
                if (stored === 'I64-H' && document.getElementById('I64H')) {
                    document.getElementById('I64H').checked = true;
                } else if (stored === 'I64-I' && document.getElementById('I64I')) {
                    document.getElementById('I64I').checked = true;
                } else if (stored === 'I64' && document.getElementById('I64N')) {
                    document.getElementById('I64N').checked = true;
                }
                console.log('[I64] Variante restaurada desde localStorage:', stored);
            } catch(e) { console.warn('[I64] No se pudo aplicar variante local:', e); }
        }

        // Hook: despu√©s de marcar patolog√≠as guardadas (llamado en cargarPatologiasGuardadas)
        const _marcarOriginal = window.marcarCheckboxesPatologias;
        window.marcarCheckboxesPatologias = function(pats) {
            _marcarOriginal(pats);
            // Inicializar baseline tras primera carga de patolog√≠as desde servidor
            if (!window._baselineInicializada) {
                window._baselineInicializada = true;
                setTimeout(() => {
                    inicializarBaselinePatologias();
                    configurarExclusividadI64();
                    aplicarVarianteI64LocalSiCorresponde();
                    restaurarCambiosLocalesPendientes();
                }, 50);
            }
            // Re-evaluar visibilidad de Evaluaci√≥n diab√©tica en base a patolog√≠as guardadas
            try { updatePieDmVisibility(); } catch(e) { /* noop */ }
            // Re-evaluar visibilidad de secci√≥n de insulina seg√∫n diabetes
            try { actualizarVisibilidadInsulinaSegunDiabetes(); } catch(e) { /* noop */ }
        };

        console.log('üß™ Nueva l√≥gica de persistencia local de patolog√≠as cargada.');

        // ================== Persistencia de cambios NO guardados (localStorage) ==================
        function keyCambiosLocales() {
            const run = document.getElementById('run')?.value || '';
            const runKey = run.replace(/[^0-9Kk]/g,'');
            return runKey ? 'pending_patologias_' + runKey : null;
        }

        function guardarCambiosLocalesPendientes() {
            const k = keyCambiosLocales();
            if (!k) return;
            const payload = {
                agregadas: Array.from(window._patologiasAgregadas || []),
                removidas: Array.from(window._patologiasRemovidas || []),
                ts: Date.now()
            };
            try {
                localStorage.setItem(k, JSON.stringify(payload));
                console.log('[LOCAL] Cambios pendientes guardados en localStorage', payload);
            } catch(e) { console.warn('[LOCAL] No se pudo guardar cambios locales:', e); }
        }

        function restaurarCambiosLocalesPendientes() {
            const k = keyCambiosLocales();
            if (!k) return;
            try {
                const raw = localStorage.getItem(k);
                if (!raw) return;
                const payload = JSON.parse(raw);
                if (!payload || !payload.agregadas) return;
                console.log('[LOCAL] Restaurando cambios pendientes:', payload);
                // Aplicar agregadas (marcar visualmente si no est√°n)
                (payload.agregadas || []).forEach(code => {
                    const cb = document.querySelector(`.patologia-checkbox[value="${code}"]`);
                    if (cb && !cb.checked) { cb.checked = true; }
                });

            // ===== IMC en vivo (control inicial) =====
            function clasificarIMCPorEdad(imc, edad){
                if (imc == null || isNaN(imc)) return {label:'', clase:''};
                if (edad != null && edad >= 65){
                    if (imc < 23) return {label:'Bajo peso', clase:'imc-morado'};
                    if (imc < 28) return {label:'Normal', clase:'imc-verde'};
                    if (imc < 32) return {label:'Sobrepeso', clase:'imc-amarillo'};
                    return {label:'Obesidad', clase:'imc-rojo'};
                } else {
                    if (imc <= 18.5) return {label:'Bajo peso', clase:'imc-morado'};
                    if (imc < 25) return {label:'Normal', clase:'imc-verde'};
                    if (imc < 30) return {label:'Sobrepeso', clase:'imc-amarillo'};
                    return {label:'Obesidad', clase:'imc-rojo'};
                }
            }

            function edadDesdeInput(){
                const fn = document.getElementById('fecha_nacimiento')?.value || '';
                if(!fn) return null; const d=new Date(fn); if(isNaN(d)) return null; const h=new Date(); let e=h.getFullYear()-d.getFullYear(); const m=h.getMonth()-d.getMonth(); if(m<0||(m===0&&h.getDate()<d.getDate())) e--; return e;
            }

            function actualizarIMCLive(){
                const peso = parseFloat(document.querySelector('input[name="peso"]')?.value || '');
                const talla = parseFloat(document.querySelector('input[name="talla"]')?.value || '');
                const box = document.getElementById('imcLiveBox');
                const valEl = document.getElementById('imcLiveValor');
                const clasEl = document.getElementById('imcLiveClas');
                if(!box || !valEl || !clasEl) return;
                if(!peso || !talla || peso<=0 || talla<=0){ valEl.textContent='-'; clasEl.style.display='none'; clasEl.className='imc-chip'; clasEl.textContent=''; return; }
                // Talla en metros (el input ya est√° en m). Calcular IMC y redondear a 1 decimal
                const imc = peso / (talla * talla);
                const imcR = Math.round(imc*10)/10;
                valEl.textContent = imcR.toFixed(1);
                const edad = edadDesdeInput();
                const {label, clase} = clasificarIMCPorEdad(imcR, edad);
                if(label){ clasEl.textContent=label; clasEl.className='imc-chip '+clase; clasEl.style.display='inline-flex'; } else { clasEl.style.display='none'; }
            }

            function wireIMCLive(){
                const p = document.querySelector('input[name="peso"]');
                const t = document.querySelector('input[name="talla"]');
                const f = document.getElementById('fecha_nacimiento');
                if(p){ p.addEventListener('input', actualizarIMCLive); }
                if(t){ t.addEventListener('input', actualizarIMCLive); }
                if(f){ f.addEventListener('change', actualizarIMCLive); }
                actualizarIMCLive();
            }

            // Historial IMC (√∫ltimos 10)
            async function cargarHistorialIMC(){
                const cont = document.getElementById('imcHistSection');
                const tbody = document.getElementById('imcHistBody');
                if(!cont || !tbody) return;
                const run = document.getElementById('run')?.value?.replace(/[^0-9kK]/g,'');
                if(!run){ cont.style.display='none'; return; }
                try{
                    const r = await fetch(`/api/usuario/${run}/imc`);
                    const j = await r.json();
                    // Endpoint actual entrega solo el √∫ltimo; mostramos ese como historial m√≠nimo por ahora
                    if(!j.success || !j.imc_data){ cont.style.display='none'; return; }
                    cont.style.display='block';
                    const d = j.imc_data;
                    const edad = edadDesdeInput();
                    const {label, clase} = clasificarIMCPorEdad(d.imc, edad);
                    tbody.innerHTML = `<tr>`+
                      `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.fecha_medicion||'-'}</td>`+
                      `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${(d.imc!=null? Number(d.imc).toFixed(1):'-')}</td>`+
                      `<td style='padding:4px 6px; border:1px solid #e2e8f0;'><span class='imc-chip ${clase}'>${label||''}</span></td>`+
                    `</tr>`;
                }catch(e){ cont.style.display='none'; }
            }
                // Aplicar removidas (desmarcar visualmente si estaban)
                (payload.removidas || []).forEach(code => {
                    const cb = document.querySelector(`.patologia-checkbox[value="${code}"]`);
                    if (cb && cb.checked && window._patologiasBase.has(code)) { cb.checked = false; }
                });
                // Reconstruir los sets en memoria
                window._patologiasAgregadas = new Set(payload.agregadas || []);
                window._patologiasRemovidas = new Set(payload.removidas || []);
                actualizarIndicadorCambiosPatologias();
                if (typeof calcularRiesgo === 'function') calcularRiesgo();
            } catch(e) { console.warn('[LOCAL] No se pudo restaurar cambios locales:', e); }
        }

        // Exponer globalmente funciones de IMC si quedaron encapsuladas por error
        (function(){
            if (typeof window.clasificarIMCPorEdad !== 'function') {
                window.clasificarIMCPorEdad = function(imc, edad){
                    if (imc == null || isNaN(imc)) return {label:'', clase:''};
                    if (edad != null && edad >= 65){
                        if (imc < 23) return {label:'Bajo peso', clase:'imc-morado'};
                        if (imc < 28) return {label:'Normal', clase:'imc-verde'};
                        if (imc < 32) return {label:'Sobrepeso', clase:'imc-amarillo'};
                        return {label:'Obesidad', clase:'imc-rojo'};
                    } else {
                        if (imc <= 18.5) return {label:'Bajo peso', clase:'imc-morado'};
                        if (imc < 25) return {label:'Normal', clase:'imc-verde'};
                        if (imc < 30) return {label:'Sobrepeso', clase:'imc-amarillo'};
                        return {label:'Obesidad', clase:'imc-rojo'};
                    }
                };
            }
            if (typeof window.edadDesdeInput !== 'function') {
                window.edadDesdeInput = function(){
                    const fn = document.getElementById('fecha_nacimiento')?.value || '';
                    if(!fn) return null; const d=new Date(fn); if(isNaN(d)) return null; const h=new Date(); let e=h.getFullYear()-d.getFullYear(); const m=h.getMonth()-d.getMonth(); if(m<0||(m===0&&h.getDate()<d.getDate())) e--; return e;
                };
            }
            if (typeof window.actualizarIMCLive !== 'function') {
                window.actualizarIMCLive = function(){
                    const peso = parseFloat(document.querySelector('input[name="peso"]')?.value || '');
                    const talla = parseFloat(document.querySelector('input[name="talla"]')?.value || '');
                    const box = document.getElementById('imcLiveBox');
                    const valEl = document.getElementById('imcLiveValor');
                    const clasEl = document.getElementById('imcLiveClas');
                    if(!box || !valEl || !clasEl) return;
                    if(!peso || !talla || peso<=0 || talla<=0){ valEl.textContent='-'; clasEl.style.display='none'; clasEl.className='imc-chip'; clasEl.textContent=''; return; }
                    const imc = peso / (talla * talla);
                    const imcR = Math.round(imc*10)/10;
                    valEl.textContent = imcR.toFixed(1);
                    const edad = window.edadDesdeInput();
                    const res = window.clasificarIMCPorEdad(imcR, edad) || {label:'', clase:''};
                    if(res.label){ clasEl.textContent=res.label; clasEl.className='imc-chip '+res.clase; clasEl.style.display='inline-flex'; } else { clasEl.style.display='none'; }
                };
            }
            if (typeof window.wireIMCLive !== 'function') {
                window.wireIMCLive = function(){
                    const p = document.querySelector('input[name="peso"]');
                    const t = document.querySelector('input[name="talla"]');
                    const f = document.getElementById('fecha_nacimiento');
                    if(p){ p.addEventListener('input', window.actualizarIMCLive); }
                    if(t){ t.addEventListener('input', window.actualizarIMCLive); }
                    if(f){ f.addEventListener('change', window.actualizarIMCLive); }
                    window.actualizarIMCLive();
                };
            }
            if (typeof window.cargarHistorialIMC !== 'function') {
                window.cargarHistorialIMC = async function(){
                    const cont = document.getElementById('imcHistSection');
                    const tbody = document.getElementById('imcHistBody');
                    if(!cont || !tbody) return;
                    const run = document.getElementById('run')?.value?.replace(/[^0-9kK]/g,'');
                    if(!run){ cont.style.display='none'; return; }
                    try{
                        const r = await fetch(`/api/usuario/${run}/imc`);
                        const j = await r.json();
                        if(!j.success || !j.imc_data){ cont.style.display='none'; return; }
                        cont.style.display='block';
                        const d = j.imc_data;
                        const edad = window.edadDesdeInput();
                        const res = window.clasificarIMCPorEdad(d.imc, edad) || {label:'', clase:''};
                        tbody.innerHTML = `<tr>`+
                          `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.fecha_medicion||'-'}</td>`+
                          `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${(d.imc!=null? Number(d.imc).toFixed(1):'-')}</td>`+
                          `<td style='padding:4px 6px; border:1px solid #e2e8f0;'><span class='imc-chip ${res.clase}'>${res.label||''}</span></td>`+
                        `</tr>`;
                    }catch(e){ cont.style.display='none'; }
                };
            }
        })();

        // Hookear actualizador de indicador para persistir autom√°ticamente
        const _actualizarInd = actualizarIndicadorCambiosPatologias;
        actualizarIndicadorCambiosPatologias = function() {
            _actualizarInd();
            guardarCambiosLocalesPendientes();
        };

        // Limpiar cambios locales tras guardado exitoso
        const _guardarWrap = window.guardarPatologiasIndependiente;
        window.guardarPatologiasIndependiente = function() {
            _guardarWrap();
            setTimeout(() => {
                const k = keyCambiosLocales();
                if (k) localStorage.removeItem(k);
            }, 800);
        };

        // Funci√≥n para agregar una patolog√≠a (modo aditivo)
        function agregarPatologiaUsuario(run, cie10) {
            console.log('‚ûï [AGREGAR] Agregando patolog√≠a:', cie10, 'para RUN:', run);
            
            const runLimpio = run.replace(/[\.\-\s]/g, '');
            
            fetch(`/api/agregar_patologias/${runLimpio}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cie10_codes: [cie10]
                })
            })
            .then(response => {
                console.log('üì° [AGREGAR] Respuesta HTTP:', response.status, response.statusText);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('‚úÖ [AGREGAR] Patolog√≠a agregada exitosamente:', cie10);
                    // Recargar las patolog√≠as guardadas para actualizar la vista
                    cargarPatologiasGuardadas(run);
                } else {
                    console.error('‚ùå [AGREGAR] Error:', data.error);
                    alert(`‚ùå Error guardando patolog√≠a ${cie10}: ${data.error}`);
                    // Desmarcar el checkbox si fall√≥
                    const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
                    if (checkbox) checkbox.checked = false;
                }
            })
            .catch(error => {
                console.error('‚ùå [AGREGAR] Error de red:', error);
                alert(`üí• Error de conexi√≥n guardando patolog√≠a ${cie10}. Verifique la consola para m√°s detalles.`);
                // Desmarcar el checkbox si fall√≥
                const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
                if (checkbox) checkbox.checked = false;
            });

            // Agregar listeners UNA sola vez para detectar cambios posteriores del usuario
            if (!window._listenersCambiosPatologiasAgregados) {
                const indicador = document.getElementById('indicador-cambios-patologias');
                document.querySelectorAll('.patologia-checkbox').forEach(cb => {
                    cb.addEventListener('change', () => {
                        // Si el checkbox modificado corresponde a una patolog√≠a que ya estaba guardada y se desmarca, tambi√©n mostrar indicador
                        if (window._patologiasGuardadasInicialCargadas) {
                            if (indicador && !indicador._visible) {
                                indicador.style.display = 'block';
                                indicador._visible = true;
                            }
                        }
                    });
                });
                window._listenersCambiosPatologiasAgregados = true;
                console.log('üü° [CHECKBOX] Listeners de cambios de patolog√≠as instalados');
            }
        }

        // Lista din√°mica de c√≥digos CIE-10 eliminables (se carga desde backend)
        let CIE10_ELIMINABLES = [];
        let _estadoEliminables = { cargando:false, error:false, total:0, intentos:0 };
        const CIE10_CACHE_KEY = 'cie10_eliminables_cache_v1';
        const CIE10_CACHE_TTL_MS = 6 * 60 * 60 * 1000; // 6 horas

        function cargarDesdeCacheEliminables() {
            try {
                const raw = localStorage.getItem(CIE10_CACHE_KEY);
                if (!raw) return false;
                const obj = JSON.parse(raw);
                if (!obj || !Array.isArray(obj.data) || !obj.ts) return false;
                if (Date.now() - obj.ts > CIE10_CACHE_TTL_MS) {
                    return false; // expirado
                }
                CIE10_ELIMINABLES = obj.data;
                _estadoEliminables.total = CIE10_ELIMINABLES.length;
                console.log('üíæ [CIE10] Cargado desde cache localStorage:', _estadoEliminables.total);
                return true;
            } catch(e) { console.warn('Cache eliminables inv√°lido', e); return false; }
        }

        function guardarCacheEliminables() {
            try {
                localStorage.setItem(CIE10_CACHE_KEY, JSON.stringify({ ts: Date.now(), data: CIE10_ELIMINABLES }));
            } catch(e) { /* ignore */ }
        }
        function renderEstadoEliminables() {
            let badge = document.getElementById('badge-eliminables');
            if (!badge) {
                // Insertar un peque√±o contenedor badge en toolbar (gesti√≥n patolog√≠as) o body fallback
                const target = document.getElementById('botones-gestion-patologias') || document.body;
                badge = document.createElement('span');
                badge.id = 'badge-eliminables';
                badge.style.cssText = 'margin-left:8px; font-size:11px; font-family:system-ui,Arial; padding:2px 6px; border-radius:10px; background:#e5e7eb; color:#374151; vertical-align:middle; display:inline-flex; align-items:center; gap:4px;';
                // Estructura interna: texto + botones (retry / clear cache)
                const txt = document.createElement('span');
                txt.id = 'badge-eliminables-text';
                badge.appendChild(txt);
                const btnRetry = document.createElement('button');
                btnRetry.type = 'button';
                btnRetry.textContent = '‚ü≥';
                btnRetry.title = 'Reintentar carga';
                btnRetry.setAttribute('aria-label','Reintentar carga de lista eliminables');
                btnRetry.style.cssText = 'border:none; background:transparent; cursor:pointer; padding:0 2px; font-size:12px; line-height:1; display:none;';
                btnRetry.addEventListener('click', (e)=>{ e.stopPropagation(); console.log('üîÑ [CIE10] Reintento manual (bot√≥n)'); cargarCIE10Eliminables(true); });
                badge.appendChild(btnRetry);
                const btnClear = document.createElement('button');
                btnClear.type = 'button';
                btnClear.textContent = '‚úñ';
                btnClear.title = 'Invalidar cache eliminables';
                btnClear.setAttribute('aria-label','Invalidar cache de c√≥digos eliminables');
                btnClear.style.cssText = 'border:none; background:transparent; cursor:pointer; padding:0 2px; font-size:11px; line-height:1; display:none;';
                btnClear.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    console.log('üßπ [CIE10] Cache invalidada manualmente');
                    try { localStorage.removeItem(CIE10_CACHE_KEY); } catch(_e){}
                    cargarCIE10Eliminables(true);
                });
                badge.appendChild(btnClear);
                target.appendChild(badge);
            }
            const txt = badge.querySelector('#badge-eliminables-text');
            const btnRetry = badge.querySelector('button:nth-child(2)');
            const btnClear = badge.querySelector('button:nth-child(3)');
            if (_estadoEliminables.cargando) {
                txt.textContent = '‚è≥ CIE10 eliminables...';
                badge.style.background = '#f3f4f6';
                badge.style.color = '#374151';
                badge.title = 'Cargando lista de c√≥digos CIE10 eliminables...';
                badge.setAttribute('aria-label','Cargando lista de c√≥digos CIE10 eliminables');
                btnRetry.style.display = 'none';
                btnClear.style.display = 'none';
            } else if (_estadoEliminables.error) {
                txt.textContent = '‚ö†Ô∏è Error CIE10';
                badge.style.background = '#fee2e2';
                badge.style.color = '#b91c1c';
                badge.title = 'Error al cargar lista eliminables. Use ‚ü≥ para reintentar.';
                badge.setAttribute('aria-label','Error al cargar lista eliminables. Pulse el bot√≥n de reintento');
                btnRetry.style.display = 'inline';
                btnClear.style.display = 'none';
            } else {
                txt.textContent = 'üóëÔ∏è Eliminables: ' + _estadoEliminables.total;
                badge.style.background = '#d1fae5';
                badge.style.color = '#065f46';
                badge.title = 'C√≥digos CIE10 eliminables cargados: ' + _estadoEliminables.total + '. Use ‚úñ para invalidar cache.';
                badge.setAttribute('aria-label','C√≥digos CIE10 eliminables cargados: ' + _estadoEliminables.total);
                btnRetry.style.display = 'none';
                btnClear.style.display = 'inline';
            }
        }
        async function cargarCIE10Eliminables(force=false) {
            if (_estadoEliminables.cargando && !force) return; // evitar solicitudes paralelas
            _estadoEliminables.cargando = true; _estadoEliminables.error = false; renderEstadoEliminables();
            // Si no es force y cache v√°lido, usarlo y terminar
            if (!force && cargarDesdeCacheEliminables()) {
                _estadoEliminables.cargando = false;
                renderEstadoEliminables();
                return;
            }
            try {
                const ctrl = new AbortController();
                const t = setTimeout(()=>ctrl.abort(), 8000);
                const resp = await fetch('/api/patologias/cie10/eliminables', { signal: ctrl.signal });
                clearTimeout(t);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                if (data && data.success && Array.isArray(data.eliminables)) {
                    CIE10_ELIMINABLES = data.eliminables.map(c => String(c).toUpperCase());
                    _estadoEliminables.total = CIE10_ELIMINABLES.length;
                    console.log('‚úÖ [CIE10] Eliminables cargados:', _estadoEliminables.total);
                    guardarCacheEliminables();
                    _estadoEliminables.intentos = 0; // reset intentos
                } else {
                    console.warn('‚ö†Ô∏è [CIE10] Respuesta inesperada al cargar eliminables', data);
                    _estadoEliminables.error = true;
                }
            } catch (e) {
                console.error('‚ùå [CIE10] Error cargando eliminables, usando lista vac√≠a', e);
                _estadoEliminables.error = true;
                _estadoEliminables.intentos = (_estadoEliminables.intentos || 0) + 1;
                // Telemetr√≠a simple de fallos consecutivos (persistente)
                try {
                    const kFail = 'cie10_eliminables_fail_streak';
                    let streak = parseInt(localStorage.getItem(kFail) || '0',10) || 0;
                    streak += 1;
                    localStorage.setItem(kFail, String(streak));
                    if (streak >= 3) {
                        console.warn('üìä [CIE10][TELEMETRIA] Fallos consecutivos >=3. streak=', streak);
                    }
                } catch(_eTel) { /* ignore */ }
                // Backoff exponencial limitado (max 4 intentos autom√°ticos)
                if (_estadoEliminables.intentos <= 4) {
                    const delay = Math.min(15000, 500 * Math.pow(2, _estadoEliminables.intentos-1));
                    console.log(`‚è±Ô∏è [CIE10] Reintento autom√°tico en ${delay}ms (intento ${_estadoEliminables.intentos})`);
                    setTimeout(()=>cargarCIE10Eliminables(true), delay);
                }
            } finally {
                _estadoEliminables.cargando = false;
                // Reset de telemetr√≠a si √©xito
                if (!_estadoEliminables.error) {
                    try { localStorage.removeItem('cie10_eliminables_fail_streak'); } catch(_eR){}
                }
                renderEstadoEliminables();
            }
        }
        // NOTA PARA FUTUROS TESTS FRONT-END:
        //  - Extraer esta secci√≥n a un m√≥dulo JS independiente (p.ej. static/js/cie10_eliminables.js)
        //  - Exportar funciones: cargarDesdeCacheEliminables, guardarCacheEliminables, cargarCIE10Eliminables
        //  - Mockear fetch y localStorage para casos:
        //      * Cache v√°lido -> no fetch
        //      * Cache expirado -> hace fetch
        //      * Reintentos con backoff (verificar n√∫mero m√°ximo y tiempos aproximados con jest.useFakeTimers)
        //      * Telemetr√≠a: simular 3 fallos consecutivos y validar incremento de streak
        //  - Afirmar normalizaci√≥n uppercase de c√≥digos recibidos.
        // Carga temprana (no bloqueante)
        cargarCIE10Eliminables();

        // Funci√≥n para eliminar una patolog√≠a (con restricciones)
        async function eliminarPatologiaUsuario(run, cie10) {
            console.log('‚ûñ [ELIMINAR] Intentando eliminar patolog√≠a:', cie10);
            const checkbox = document.querySelector(`.patologia-checkbox[value="${cie10}"]`);
            const code = String(cie10 || '').toUpperCase();
            if (!code) return;
            if (!esPatologiaEliminable(code)) {
                console.log('üö´ [ELIMINAR] C√≥digo CIE-10 no eliminable (lista din√°mica):', code);
                alert(`No se puede eliminar la patolog√≠a ${code}. Solo ciertos c√≥digos pueden ser eliminados una vez guardados.`);
                if (checkbox) checkbox.checked = true; // revertir
                return;
            }
            try {
                const password = prompt('Ingrese contrase√±a de eliminaci√≥n selectiva (leave blank para cancelar)');
                if (password === null) { // cancelado
                    if (checkbox) checkbox.checked = true;
                    return;
                }
                const body = { codes: [code], password: password };
                const resp = await fetch(`/api/patologias/eliminar_selectivas/${encodeURIComponent(run)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok || !data.success) {
                    console.error('‚ùå [ELIMINAR] Error backend:', resp.status, data);
                    alert(`Error eliminando ${code}: ${(data && data.error) || resp.status}`);
                    if (checkbox) checkbox.checked = true; // revertir
                    return;
                }
                console.log('‚úÖ [ELIMINAR] Eliminaci√≥n exitosa:', data);
                alert(`Patolog√≠a ${code} eliminada (si exist√≠a asociada).`);
                // Refrescar listado de patolog√≠as guardadas para el RUN
                try {
                    if (typeof cargarPatologiasGuardadas === 'function') {
                        cargarPatologiasGuardadas(run);
                        // Reinicializar baseline tras breve delay
                        setTimeout(() => {
                            if (typeof inicializarBaselinePatologias === 'function') inicializarBaselinePatologias();
                            // Actualizar sets de cambios locales si existen
                            try {
                                if (window._patologiasBase instanceof Set) {
                                    window._patologiasBase.delete(code);
                                }
                                if (window._patologiasAgregadas instanceof Set) {
                                    window._patologiasAgregadas.delete(code);
                                }
                                if (window._patologiasRemovidas instanceof Set) {
                                    window._patologiasRemovidas.add(code); // reflejar que ahora est√° removida respecto a estado previo
                                }
                                if (typeof actualizarIndicadorCambiosPatologias === 'function') actualizarIndicadorCambiosPatologias();
                            } catch(eSets) { console.warn('‚ö†Ô∏è No se pudo actualizar sets tras eliminaci√≥n individual', eSets); }
                        }, 600);
                    }
                } catch (e2) { console.warn('‚ö†Ô∏è No se pudo refrescar patolog√≠as tras eliminaci√≥n:', e2); }
                if (checkbox) checkbox.checked = false;
            } catch (e) {
                console.error('‚ùå [ELIMINAR] Excepci√≥n eliminando patolog√≠a', e);
                alert('Error inesperado eliminando patolog√≠a');
                if (checkbox) checkbox.checked = true;
            }
        }

        // Funci√≥n para validar rangos de valores m√©dicos
        function validarRangosMedicos() {
            // Presi√≥n sist√≥lica: rojo si >=140; si edad >=80, rojo si >=150
            const presionSistolica = document.querySelector('input[name="presion_sistolica"]');
            if (presionSistolica) {
                presionSistolica.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    const edadStr = (document.getElementById('edad') || {}).value || '';
                    const edadNum = parseInt(edadStr, 10);
                    const umbral = (!isNaN(edadNum) && edadNum >= 80) ? 150 : 140;
                    if (!isNaN(valor) && valor >= umbral) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // Presi√≥n diast√≥lica >= 90 (rojo)
            const presionDiastolica = document.querySelector('input[name="presion_diastolica"]');
            if (presionDiastolica) {
                presionDiastolica.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (valor >= 90) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // Colesterol total: rojo si >= 200
            const col = document.querySelector('input[name="col"]');
            if (col) {
                col.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (!isNaN(valor) && valor >= 200) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // LDL: verde si < 70; rojo si >= 130 (rojo tiene prioridad)
            const ldl = document.querySelector('input[name="ldl"]');
            if (ldl) {
                ldl.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (!isNaN(valor) && valor >= 130) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else if (!isNaN(valor) && valor < 70) {
                        this.style.color = '#16a34a';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // TAG (triglic√©ridos): rojo si >= 150
            const tag = document.querySelector('input[name="tag"]');
            if (tag) {
                tag.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (!isNaN(valor) && valor >= 150) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // HbA1c: rojo si >=7; si edad >=80, rojo si >=8; verde en caso contrario
            const hba1c = document.querySelector('input[name="hba1c"]');
            if (hba1c) {
                hba1c.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (isNaN(valor) || valor === '') {
                        // Sin valor, sin color
                        this.style.color = '';
                        this.style.fontWeight = '';
                        this.style.backgroundColor = '';
                        return;
                    }
                    
                    const edadStr = (document.getElementById('edad') || {}).value || '';
                    const edadNum = parseInt(edadStr, 10);
                    
                    if (!isNaN(edadNum) && edadNum >= 80) {
                        // Si edad >= 80 a√±os: rojo si HbA1c >= 8, verde si < 8
                        if (valor >= 8) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    } else {
                        // Si edad < 80 a√±os: rojo si HbA1c >= 7, verde si < 7
                        if (valor >= 7) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    }
                });
            }

            // HGT >= 130 (rojo)
            const hgt = document.querySelector('input[name="hgt"]');
            if (hgt) {
                hgt.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (valor >= 130) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });
            }

            // HbA1c para ex√°menes: misma l√≥gica que HbA1c principal
            const hba1cExamen = document.querySelector('input[name="hba1c_examen"]');
            if (hba1cExamen) {
                hba1cExamen.addEventListener('input', function() {
                    const valor = parseFloat(this.value);
                    if (isNaN(valor) || valor === '') {
                        // Sin valor, sin color
                        this.style.color = '';
                        this.style.fontWeight = '';
                        this.style.backgroundColor = '';
                        return;
                    }
                    
                    const edadStr = (document.getElementById('edad') || {}).value || '';
                    const edadNum = parseInt(edadStr, 10);
                    
                    if (!isNaN(edadNum) && edadNum >= 80) {
                        // Si edad >= 80 a√±os: rojo si HbA1c >= 8, verde si < 8
                        if (valor >= 8) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    } else {
                        // Si edad < 80 a√±os: rojo si HbA1c >= 7, verde si < 7
                        if (valor >= 7) {
                            this.style.color = '#e53535';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#ffebee';
                        } else {
                            this.style.color = '#28a745';
                            this.style.fontWeight = 'bold';
                            this.style.backgroundColor = '#d4edda';
                        }
                    }
                });
            }

            // Talla (m): autoformateo y validaci√≥n
            const talla = document.querySelector('input[name="talla"]');
            if (talla) {
                function normalizarTalla() {
                    let raw = (talla.value || '').toString().trim();
                    if (!raw) return;
                    raw = raw.replace(',', '.');
                    let n = parseFloat(raw);
                    if (isNaN(n)) { talla.value = ''; return; }
                    // Si parece estar en cent√≠metros (n > 10), convertir a metros
                    if (n > 10) {
                        n = n / 100;
                    }
                    // Limitar rango permitido [0.50, 2.30]
                    if (n > 2.30) n = 2.30;
                    if (n < 0.50) n = 0.50;
                    talla.value = n.toFixed(2);
                    // Estilo rojo si alcanza el m√°ximo
                    if (n >= 2.30) {
                        talla.style.color = '#e53935';
                        talla.style.fontWeight = 'bold';
                    } else {
                        talla.style.color = '';
                        talla.style.fontWeight = '';
                    }
                }

                // Reemplazar coma por punto y prevenir > 2.30 en tiempo real
                talla.addEventListener('input', function() {
                    // Reemplazar coma por punto
                    if (this.value && this.value.includes(',')) {
                        this.value = this.value.replace(',', '.');
                    }

                    if (!this.value) { this.style.color = ''; this.style.fontWeight = ''; return; }

                    let v = parseFloat(this.value);
                    if (isNaN(v)) { return; }

                    let changed = false;
                    // Si ingresan cent√≠metros (ej: 170), convertir a metros al vuelo
                    if (v > 10) { v = v / 100; changed = true; }
                    // No permitir mayores a 2.30
                    if (v > 2.30) { v = 2.30; changed = true; }
                    // Limitar a 2 decimales mientras escribe si excede
                    const dot = this.value.indexOf('.');
                    if (dot !== -1 && this.value.length - dot - 1 > 2) {
                        changed = true;
                    }
                    if (changed) {
                        this.value = v.toFixed(2);
                    }

                    // Estilo en vivo
                    if (v >= 2.30) {
                        this.style.color = '#e53935';
                        this.style.fontWeight = 'bold';
                    } else {
                        this.style.color = '';
                        this.style.fontWeight = '';
                    }
                });

                // Autoformatear al terminar de ingresar
                ['change', 'blur'].forEach(ev => talla.addEventListener(ev, normalizarTalla));

                // Normalizar si ya viene con valor al cargar
                if (talla.value) { normalizarTalla(); }
            }

            // Disparar validaciones iniciales si ya hay valores cargados
            [
                'presion_sistolica', 'presion_diastolica', 'hba1c', 'hgt', 'talla', 'col', 'ldl', 'tag'
            ].forEach(name => {
                const el = document.querySelector(`input[name="${name}"]`);
                if (el && el.value) {
                    try { el.dispatchEvent(new Event('input')); } catch (e) {}
                }
            });
        }

        // (Compat) La versi√≥n por slug se elimin√≥; los encabezados usan toggleCategoria(contentId).

        // Funci√≥n para expandir todas las categor√≠as (proxy a nuevas utilidades)
        function expandirTodasCategorias() {
            if (typeof expandirTodasFamilias === 'function') {
                expandirTodasFamilias();
            }
        }

        // Funci√≥n para contraer todas las categor√≠as (proxy a nuevas utilidades)
        function contraerTodasCategorias() {
            if (typeof contraerTodasFamilias === 'function') {
                contraerTodasFamilias();
            }
        }

        // Funci√≥n para expandir solo categor√≠as con patolog√≠as seleccionadas (proxy)
        function expandirSoloSeleccionadas() {
            if (typeof expandirSoloSeleccionadasFamilias === 'function') {
                expandirSoloSeleccionadasFamilias();
            } else {
                // Fallback: al menos contraer todo usando el proxy anterior
                contraerTodasCategorias();
            }
        }

        // Funci√≥n para actualizar contadores de categor√≠as
        function actualizarContadoresCategorias() {
            console.log('üî¢ [CONTADOR] Actualizando contadores de categor√≠as...');
            const categorias = [
                'salud-mental',
                'metabolicas-endocrinas',
                'cardiovasculares',
                'respiratorias',
                'renales-urologicas',
                'digestivas',
                'musculo-esqueleticas',
                'neurologicas',
                'inmunologicas-hematologicas',
                'oftalmologicas',
                'otorrinolaringologicas',
                'socioeconomicas-psicosociales',
                'funcionalidad-discapacidad',
                'oncologicas',
                'dermatologicas'
            ];

            let totalSeleccionadas = 0;

            categorias.forEach(categoriaId => {
                const content = document.getElementById('content-' + categoriaId);
                const badge = document.getElementById('badge-' + categoriaId);
                
                if (content && badge) {
                    const checkboxes = content.querySelectorAll('.patologia-checkbox:checked');
                    const count = checkboxes.length;
                    badge.textContent = count;
                    badge.style.display = 'inline'; // Mostrar siempre el contador, incluso cuando es 0
                    totalSeleccionadas += count;
                    
                    // Log espec√≠fico para las categor√≠as solicitadas
                    if (categoriaId === 'salud-mental' || categoriaId === 'neurologicas') {
                        console.log(`üî¢ [CONTADOR] ${categoriaId}: ${count} patolog√≠as, badge visible: ${badge.style.display}`);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è [CONTADOR] No se encontr√≥ content o badge para: ${categoriaId}`);
                }
            });

            // Actualizar el bot√≥n principal con el conteo total
            const btnToggle = document.getElementById('btn-toggle-patologias');
            if (btnToggle) {
                const container = document.getElementById('patologias-main-container');
                const isHidden = container && container.style.display === 'none';
                
                if (isHidden) {
                    if (totalSeleccionadas > 0) {
                        btnToggle.innerHTML = `üëÅÔ∏è Mostrar Patolog√≠as (${totalSeleccionadas} seleccionadas)`;
                    } else {
                        btnToggle.innerHTML = 'üëÅÔ∏è Mostrar Patolog√≠as';
                    }
                } else {
                    if (totalSeleccionadas > 0) {
                        btnToggle.innerHTML = `üôà Ocultar Patolog√≠as (${totalSeleccionadas} seleccionadas)`;
                    } else {
                        btnToggle.innerHTML = 'üôà Ocultar Patolog√≠as';
                    }
                }
            }
        }

        // Funci√≥n para cargar datos del usuario por RUN
        function cargarDatosUsuario(run) {
            if (!run || run.length < 3) return;
            
            const loading = document.getElementById('loading');
            const encontrado = document.getElementById('usuario-encontrado');
            
            loading.style.display = 'block';
            encontrado.style.display = 'none';
            
            fetch(`/api/usuario/${run}`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (data.error) {
                        // Usuario no encontrado - limpiar formulario (solo si no hay error global)
                        if (!window.HAS_ERROR) {
                            limpiarFormulario();
                            limpiarPatologiasGuardadas();
                        }
                        return;
                    }
                    
                    // Usuario encontrado - llenar formulario
                    const usuario = data;  // Los datos vienen directamente en data
                    const patologias = data.patologias || [];
                    
                    console.log('üéØ [CARGA USUARIO] Datos recibidos:', data);
                    console.log('üéØ [CARGA USUARIO] Patolog√≠as recibidas:', patologias);
                    
                    // Marcar que estamos cargando un usuario (protege contra limpiezas accidentales)
                    window.CARGANDO_USUARIO = true;
                    
                    // Llenar datos b√°sicos
                    document.getElementById('nombre').value = usuario.nombre || '';
                    
                    // Manejo unificado para fecha de nacimiento con overlay
                    (function(){
                        const fechaNacimientoField = document.getElementById('fecha_nacimiento');
                        if (!fechaNacimientoField) return;
                        // Asegurar formato correcto ISO (YYYY-MM-DD)
                        let iso = '';
                        if (usuario.fecha_nacimiento) {
                            if (/^\d{4}-\d{2}-\d{2}$/.test(usuario.fecha_nacimiento)) {
                                iso = usuario.fecha_nacimiento;
                            } else {
                                const d = new Date(usuario.fecha_nacimiento);
                                if (!isNaN(d.getTime())) iso = d.toISOString().split('T')[0];
                            }
                        }
                        // Habilitar campo y sincronizar overlay + eventos
                        fechaNacimientoField.disabled = false;
                        fechaNacimientoField.readOnly = false;
                        fechaNacimientoField.removeAttribute('disabled');
                        fechaNacimientoField.removeAttribute('readonly');
                        try {
                            setFechaConOverlay('fecha_nacimiento', iso, { dispatch: true });
                        } catch (_) {
                            // Fallback m√≠nimo
                            fechaNacimientoField.value = iso;
                            try { fechaNacimientoField.dispatchEvent(new Event('change', { bubbles:true })); } catch(__){}
                            try { fechaNacimientoField.dispatchEvent(new Event('input', { bubbles:true })); } catch(__){}
                        }
                        // Marcar protecci√≥n y logs
                        fechaNacimientoField.dataset.protegido = 'true';
                        console.log('üéÇ [DEBUG] Fecha asignada (unificada):', iso);
                        console.log('üéÇ [DEBUG] Campo habilitado:', !fechaNacimientoField.disabled);
                    })();
                    
                    // Calcular edad directamente si hay fecha de nacimiento
                    if (usuario.fecha_nacimiento) {
                        console.log('üéÇ [DEBUG] Calculando edad directamente para fecha:', usuario.fecha_nacimiento);
                        const fechaNac = new Date(usuario.fecha_nacimiento);
                        const hoy = new Date();
                        let edad = hoy.getFullYear() - fechaNac.getFullYear();
                        const mes = hoy.getMonth() - fechaNac.getMonth();
                        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                            edad--;
                        }
                        console.log('üéÇ [DEBUG] Edad calculada directamente:', edad);
                        
                        const edadField = document.getElementById('edad');
                        if (edadField) {
                            edadField.value = edad;
                            console.log('üéÇ [DEBUG] Edad establecida en campo:', edadField.value);
                        }
                    }
                    
                    // Eventos adicionales ya se disparan en setFechaConOverlay; mantener refuerzo ligero
                    (function(){
                        const fechaNacimientoField = document.getElementById('fecha_nacimiento');
                        if (fechaNacimientoField && usuario.fecha_nacimiento) {
                            console.log('üéÇ [DEBUG] Refuerzo de eventos en fecha_nacimiento');
                            setTimeout(() => {
                                try { fechaNacimientoField.dispatchEvent(new Event('change', { bubbles: true })); } catch(_e){}
                                try { fechaNacimientoField.dispatchEvent(new Event('input', { bubbles: true })); } catch(_e){}
                            }, 50);
                        }
                    })();
                    
                    if (typeof actualizarRangoFechaNacimiento === 'function') { actualizarRangoFechaNacimiento(); }
                    // Actualizar edad con un peque√±o delay para asegurar que el DOM se haya actualizado
                    if (typeof actualizarEdad === 'function') { 
                        console.log('üéÇ [DEBUG] Programando c√°lculo de edad con fecha:', usuario.fecha_nacimiento);
                        setTimeout(() => {
                            console.log('üéÇ [DEBUG] Ejecutando actualizarEdad()...');
                            actualizarEdad();
                            console.log('üéÇ [DEBUG] actualizarEdad() ejecutado');
                        }, 100); 
                    } else {
                        console.warn('üéÇ [ERROR] Funci√≥n actualizarEdad no disponible');
                    }
                    document.getElementById('direccion').value = usuario.direccion || '';
                    document.getElementById('telefono').value = usuario.telefono || '';
                    document.getElementById('sexo').value = usuario.sexo || '';
                    document.getElementById('categoria_id').value = usuario.categoria_id || '';
                    document.getElementById('sector_id').value = usuario.sector_id || '';
                    // Sincronizar fecha de ingreso con overlay espa√±ol si existe
                    (function(){
                        const el = document.getElementById('fecha_ingreso');
                        const iso = usuario.fecha_ingreso || '';
                        if (el) {
                            el.value = iso; 
                            try { el.dispatchEvent(new Event('change', { bubbles:true })); } catch(_2){}
                        }
                    })();
                    // Programa ECICEP/Cardio
                    try {
                        const ingreso = !!usuario.ingreso_ecicep;
                        setPrograma(ingreso ? 'ecicep' : 'cardio');
                    } catch(e) { console.warn('No se pudo aplicar modo de programa:', e); }
                    // Demogr√°ficos
                    if (document.getElementById('nivel_educacional')) {
                        document.getElementById('nivel_educacional').value = usuario.nivel_educacional || '';
                    }
                    if (document.getElementById('origen_etnico')) {
                        document.getElementById('origen_etnico').value = usuario.origen_etnico || '';
                    }
                    if (document.getElementById('estado_civil')) {
                        document.getElementById('estado_civil').value = usuario.estado_civil || '';
                    }
                    
                    // Marcar patolog√≠as guardadas del usuario autom√°ticamente
                    console.log('üéØ [CARGA USUARIO] Marcando patolog√≠as guardadas:', patologias);
                    marcarCheckboxesPatologias(patologias);
                    
                    // Actualizar interfaz y c√°lculo de riesgo (se respeta modo de programa)
                    calcularRiesgo();
                    actualizarResumenPatologias();
                    actualizarContadoresCategorias();
                    actualizarPatologiasGuardadas(patologias);
                    
                    // Forzar c√°lculo de edad como √∫ltimo paso
                    if (typeof actualizarEdad === 'function') {
                        console.log('üéÇ [DEBUG] Forzando c√°lculo final de edad...');
                        setTimeout(() => actualizarEdad(), 200);
                    }
                    
                    // Trigger adicional: si hay fecha de nacimiento, calcular edad inmediatamente
                    const fechaNacField = document.getElementById('fecha_nacimiento');
                    if (fechaNacField && fechaNacField.value) {
                        console.log('üéÇ [DEBUG] Trigger adicional para fecha:', fechaNacField.value);
                        setTimeout(() => {
                            const edadField = document.getElementById('edad');
                            if (edadField && (!edadField.value || edadField.value === '--')) {
                                console.log('üéÇ [DEBUG] Campo edad vac√≠o, forzando c√°lculo...');
                                actualizarEdad();
                            }
                        }, 300);
                    }
                    
                    // Actualizar categor√≠a autom√°ticamente basada en el c√°lculo de riesgo
                    actualizarCategoriaAutomatica();
                    
                    // Verificar IMC y autoseleccionar obesidad si corresponde
                    verificarIMCYAutoseleccionarObesidad(run);
                    wireIMCLive();
                    cargarHistorialIMC();
                    
                    encontrado.style.display = 'block';

                    // Cargar alertas de vigencia autom√°ticamente
                    setTimeout(() => {
                        const toggleBtn = document.getElementById('ver-alertas-btn');
                        if (toggleBtn) {
                            toggleBtn.style.display = 'block';
                        }
                    }, 500);

                    // FORZAR C√ÅLCULO DE EDAD - SOLUCI√ìN FINAL
                    setTimeout(() => {
                        console.log('üéÇ [FORZAR] Iniciando c√°lculo forzado de edad...');
                        const fechaNacField = document.getElementById('fecha_nacimiento');
                        const edadField = document.getElementById('edad');
                        
                        if (fechaNacField && edadField && fechaNacField.value) {
                            console.log('üéÇ [FORZAR] Fecha encontrada:', fechaNacField.value);
                            
                            // C√°lculo directo de edad
                            const fechaNac = new Date(fechaNacField.value);
                            const hoy = new Date();
                            let edad = hoy.getFullYear() - fechaNac.getFullYear();
                            const mes = hoy.getMonth() - fechaNac.getMonth();
                            if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNac.getDate())) {
                                edad--;
                            }
                            
                            edadField.value = edad;
                            console.log('üéÇ [FORZAR] Edad establecida:', edad);
                        } else {
                            console.log('üéÇ [FORZAR] No se encontraron campos necesarios');
                        }
                    }, 500);

                    // Recalcular elegibilidad de screening tras setear sexo/fecha
                    if (window.ScreeningModule && typeof window.ScreeningModule.update === 'function') {
                        window.ScreeningModule.update();
                    }
                    // Recalcular visibilidad de Adulto Mayor (edad >= 65) tras completar fecha de nacimiento
                    if (typeof updateAdultoMayorVisibility === 'function') {
                        setTimeout(() => updateAdultoMayorVisibility(), 0);
                    }
                    
                    // Limpiar protecciones despu√©s de que todo est√© cargado
                    setTimeout(() => {
                        window.CARGANDO_USUARIO = false;
                        const fechaNacField = document.getElementById('fecha_nacimiento');
                        if (fechaNacField) {
                            delete fechaNacField.dataset.protegido;
                        }
                        console.log('üéØ [CARGA USUARIO] Protecciones limpiadas, carga completa');
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    loading.style.display = 'none';
                });
        }

        // Identificar ID de categor√≠a 'Cardio' desde datos serializados por el servidor (evita Jinja en JS)
        window.CARDIO_CAT_ID = (function(){
            try {
                const el = document.getElementById('categorias-data');
                let list = [];
                if (el) { try { list = JSON.parse(el.textContent || '[]'); } catch(_){} }
                const cardio = Array.isArray(list) ? list.find(c => {
                    const name = (c && (c.nombre != null ? c.nombre : c.NOMBRE));
                    return name && String(name).toUpperCase() === 'CARDIO';
                }) : null;
                const id = cardio ? (cardio.id != null ? cardio.id : cardio.ID) : null;
                return (id !== null && id !== undefined) ? String(id) : '7';
            } catch(_) { return '7'; }
        })();

        // Programa: Cardio/ECICEP con bypass de c√°lculo
        window.__BYPASS_RIESGO__ = false; // true => omite calcularRiesgo y fija 'Cardio'

        function setProgramaCardio() {
            window.__BYPASS_RIESGO__ = true;
            try {
                // 1) Flags reales hacia backend
                const enCV = document.getElementById('en_programa_cv');
                if (enCV) enCV.value = 'true';
                const inEcicep = document.getElementById('ingreso_ecicep');
                if (inEcicep) inEcicep.value = 'false';

                // 2) Preferencia UI (no usada por backend)
                const hid = document.getElementById('categoria_ecicep_effectiva');
                if (hid) hid.value = 'Cardio';

                // 3) Visual: mostrar riesgo pero fijar etiqueta 'Cardio'
                const riesgo = document.getElementById('cuadro-riesgo-flotante');
                if (riesgo) riesgo.style.display = '';
                const elMini = document.getElementById('categoria-riesgo-mini');
                if (elMini) elMini.textContent = 'Cardio';
                const el = document.getElementById('categoria-riesgo');
                if (el) el.textContent = 'Cardio';

                // 4) Select de categor√≠a: forzar Cardio si existe
                const categoria = document.getElementById('categoria_id');
                if (categoria) {
                    categoria.disabled = false; categoria.title = '';
                    try { categoria.value = window.CARDIO_CAT_ID || categoria.value; } catch(_){ }
                }
                try { colorearSelectCategoria(); } catch(_){ }
            } catch(_e) {}
        }

        function setProgramaEcicep() {
            window.__BYPASS_RIESGO__ = false;
            try {
                // 1) Flags reales hacia backend
                const enCV = document.getElementById('en_programa_cv');
                if (enCV) enCV.value = 'false';
                const inEcicep = document.getElementById('ingreso_ecicep');
                if (inEcicep) inEcicep.value = 'true';

                // 2) Preferencia UI
                const hid = document.getElementById('categoria_ecicep_effectiva');
                if (hid) hid.value = '';

                // 3) Volver a c√°lculo normal de riesgo
                const riesgo = document.getElementById('cuadro-riesgo-flotante');
                if (riesgo) riesgo.style.display = '';
                const categoria = document.getElementById('categoria_id');
                if (categoria) { categoria.disabled = false; categoria.title = ''; }
                if (typeof calcularRiesgo === 'function') calcularRiesgo();
                try { colorearSelectCategoria(); } catch(_){ }
            } catch(_e) {}
        }

        // Unificador + UI: fija modo y resalta bot√≥n activo
        function setPrograma(modo){
            const bCardio = document.getElementById('btn-programa-cardio');
            const bEcicep = document.getElementById('btn-programa-ecicep');
            if (modo === 'cardio') {
                setProgramaCardio();
                if (bCardio) bCardio.setAttribute('data-active','true');
                if (bEcicep) bEcicep.removeAttribute('data-active');
            } else {
                setProgramaEcicep();
                if (bEcicep) bEcicep.setAttribute('data-active','true');
                if (bCardio) bCardio.removeAttribute('data-active');
            }
        }

        document.addEventListener('DOMContentLoaded', function(){
            // Interceptar calcularRiesgo para aplicar bypass (hacerlo una vez que est√© definida)
            (function wrapCalculo(){
                const original = (typeof calcularRiesgo === 'function') ? calcularRiesgo : null;
                window.__calcularRiesgoOriginal__ = original;
                window.calcularRiesgo = function() {
                    if (window.__BYPASS_RIESGO__ === true) {
                        // No recalcular; mantener 'Cardio' visible
                        const elMini = document.getElementById('categoria-riesgo-mini');
                        if (elMini) elMini.textContent = 'Cardio';
                        const el = document.getElementById('categoria-riesgo');
                        if (el) el.textContent = 'Cardio';
                        return;
                    }
                    if (original) return original.apply(this, arguments);
                }
            })();

            // Activar modo inicial seg√∫n select si ya est√° en Cardio, si no ECICEP
            try {
                // Si viene de servidor una preferencia guardada, resp√©tala
                const pref = (document.getElementById('categoria_ecicep_effectiva')?.value || '').toLowerCase();
                if (pref === 'cardio') {
                    setPrograma('cardio');
                } else {
                    // Si no hay preferencia, inferir por select actual
                    const categoria = document.getElementById('categoria_id');
                    const esCardio = categoria && (String(categoria.value) === String(window.CARDIO_CAT_ID));
                    setPrograma(esCardio ? 'cardio' : 'ecicep');
                }
            } catch(_) { setPrograma('ecicep'); }
            // Wire botones (quedan como toggle fijo visualmente)
            const bCardio = document.getElementById('btn-programa-cardio');
            const bEcicep = document.getElementById('btn-programa-ecicep');
            if (bCardio) bCardio.addEventListener('click', ()=>setPrograma('cardio'));
            if (bEcicep) bEcicep.addEventListener('click', ()=>setPrograma('ecicep'));
        });
        
        // Funci√≥n auxiliar para encontrar checkbox por c√≥digo CIE10
        function encontrarCheckboxPorCIE10(codigoCIE10) {
            // Mapeo de c√≥digos CIE10 a valores de checkbox
            const mapaCIE10 = {
                'F11': 'abuso_dependencia_opiaceos',
                'F12': 'abuso_dependencia_cannabinoides',
                'F13': 'abuso_dependencia_sedantes_hipnoticos',
                'F14': 'abuso_dependencia_cocaina',
                'F15': 'abuso_dependencia_estimulantes',
                'F16': 'abuso_dependencia_alucinogenos',
                'F18': 'abuso_dependencia_inhalantes',
                'F19': 'abuso_dependencia_multiples_drogas',
                'F10': 'alcoholismo',
                'F17': 'tabaquismo',
                'F31': 'trastorno_bipolar',
                'F32': 'episodio_depresivo_mayor',
                'F33': 'trastorno_depresivo_recurrente',
                'F43.2': 'trastorno_adaptacion_depresion',
                'F41.1': 'trastorno_ansiedad_generalizada',
                'F41.0': 'trastorno_panico',
                'F43.1': 'trastorno_estres_postraumatico',
                'F60.2': 'trastorno_personalidad_antisocial',
                'F60.3': 'trastorno_personalidad_limite',
                'F20': 'esquizofrenia',
                'F23': 'trastorno_psicotico_breve',
                'F22': 'trastorno_delirante',
                'F03': 'demencia_alzheimer',
                'F01': 'demencia_vascular',
                'F06.7': 'deterioro_cognitivo_leve',
                'F90': 'trastorno_deficit_atencion',
                'F84': 'trastorno_espectro_autista',
                'F70-F79': 'discapacidad_intelectual',
                'F50': 'trastorno_alimentario',
                'F45': 'trastorno_somatico',
                'F44': 'trastorno_conversion',
                'F51': 'trastorno_sueno',
                'R45.851': 'ideacion_suicida',
                'T14.91': 'intento_suicidio',
                'E10': 'diabetes_mellitus_tipo1',
                'E11': 'diabetes_mellitus_tipo2',
                'O24': 'diabetes_gestacional',
                'R73.03': 'prediabetes',
                'E66.01': 'obesidad_grado1',
                'E66.3': 'sobrepeso',
                'R63.6': 'bajo_peso',
                'E03': 'hipotiroidismo',
                'E05': 'hipertiroidismo',
                'E04': 'bocio',
                'E04.1': 'nodulo_tiroideo',
                'E88.81': 'sindrome_metabolico',
                'E78': 'dislipidemia',
                'E78.0': 'hipercolesterolemia',
                'E78.1': 'hipertrigliceridemia',
                'E79.0': 'hiperuricemia',
                'M10': 'gota',
                'M81': 'osteoporosis',
                'M85.8': 'osteopenia',
                'E55': 'deficiencia_vitamina_d',
                'E53.8': 'deficiencia_vitamina_b12',
                'D50': 'anemia_ferropenica',
                'E27': 'insuficiencia_suprarrenal',
                'E28.2': 'sindrome_ovario_poliquistico',
                'N95.1': 'menopausia',
                'E89.5': 'andropausia',
                'E01': 'trastornos_tiroideos_deficiencia_yodo',
                'E02': 'hipotiroidismo_subclinico_deficiencia_yodo',
                'I10': 'hipertension_arterial',
                'I15': 'hipertension_secundaria',
                'I16': 'crisis_hipertensiva',
                'I25': 'cardiopatia_isquemica',
                'I21': 'infarto_agudo_miocardio',
                'I20': 'angina_pecho',
                'I50': 'insuficiencia_cardiaca',
                'I49': 'arritmia_cardiaca',
                'I48': 'fibrilacion_auricular',
                'I48.3': 'flutter_auricular',
                'I47.1': 'taquicardia_supraventricular',
                'I47.2': 'taquicardia_ventricular',
                'R00.1': 'bradicardia',
                'I44': 'bloqueo_cardiaco',
                'I35-I39': 'valvulopatia',
                'I33': 'endocarditis',
                'I42': 'miocardiopatia',
                'I30': 'pericarditis',
                'I73': 'enfermedad_vascular_periferica',
                'I80': 'trombosis_venosa_profunda',
                'I26': 'embolia_pulmonar',
                'I71': 'aneurisma_aorta',
                'I71.0': 'diseccion_aorta',
                'I70': 'aterosclerosis',
                'I64': 'accidente_cerebrovascular',
                'G93.1': 'ataque_isquemico_transitorio',
                'I61': 'hemorragia_intracerebral',
                'I60': 'hemorragia_subaracnoidea',
                'Q20-Q28': 'cardiopatia_congenita',
                'I05-I09': 'cardiopatia_reumatica',
                'I27': 'cor_pulmonale',
                'R57.0': 'shock_cardiogenico',
                'I46': 'parada_cardiaca'
                // Agregar m√°s mapeos seg√∫n sea necesario...
            };
            
            const valorCheckbox = mapaCIE10[codigoCIE10];
            if (valorCheckbox) {
                return document.getElementById(`pat_${valorCheckbox}`);
            }
            return null;
        }

        // Funci√≥n para verificar IMC del √∫ltimo control y autoseleccionar E66.9 si es obesidad (rojo)
        function verificarIMCYAutoseleccionarObesidad(run) {
            if (!run) return;
            
            console.log('üîç [IMC AUTO] Verificando IMC para autoselecci√≥n de obesidad, RUN:', run);
            
            fetch(`/api/usuario/${run}/imc`)
                .then(response => response.json())
                .then(data => {
                    console.log('üìä [IMC AUTO] Datos de IMC recibidos:', data);
                    
                    if (!data.success || !data.imc_data || !data.imc_data.imc) {
                        console.log('‚ÑπÔ∏è [IMC AUTO] No se encontr√≥ IMC, manteniendo comportamiento manual');
                        return;
                    }
                    
                    const imcData = data.imc_data;
                    const imc = imcData.imc;
                    const grupoEtareo = (imcData.grupo_etareo || '').trim().toLowerCase();
                    
                    console.log(`üìä [IMC AUTO] IMC: ${imc}, Grupo et√°reo: "${grupoEtareo}"`);
                    
                    // Determinar si el IMC es clasificado como "rojo" (obesidad)
                    let esObesidad = false;
                    
                    if (grupoEtareo === 'adulto') {
                        // Adulto: IMC ‚â• 30 es rojo (obesidad)
                        esObesidad = imc >= 30;
                    } else if (grupoEtareo === 'adulto mayor') {
                        // Adulto mayor: IMC ‚â• 32 es rojo (obesidad)
                        esObesidad = imc >= 32;
                    } else {
                        // Fallback: usar criterio de adulto
                        esObesidad = imc >= 30;
                        console.log('‚ö†Ô∏è [IMC AUTO] Grupo et√°reo no reconocido, usando criterio de adulto');
                    }
                    
                    console.log(`üéØ [IMC AUTO] ¬øEs obesidad (rojo)? ${esObesidad}`);
                    
                    const checkboxE669 = document.getElementById('E669');
                    if (!checkboxE669) {
                        console.error('‚ùå [IMC AUTO] No se encontr√≥ el checkbox E669');
                        return;
                    }
                    
                    if (esObesidad) {
                        // IMC ES OBESIDAD (rojo) ‚Üí Autoseleccionar E66.9
                        if (!checkboxE669.checked) {
                            console.log('‚úÖ [IMC AUTO] Autoseleccionando E66.9 - Obesidad, no especificada');
                            checkboxE669.checked = true;
                            
                            // Disparar el evento change para actualizar c√°lculos
                            checkboxE669.dispatchEvent(new Event('change', { bubbles: true }));
                            
                            console.log('üì¢ [IMC AUTO] E66.9 autoseleccionado por IMC de obesidad:', imc);
                        } else {
                            console.log('‚ÑπÔ∏è [IMC AUTO] E66.9 ya estaba seleccionado');
                        }
                    } else {
                        // IMC NO ES OBESIDAD (verde/amarillo/morado) ‚Üí Deseleccionar E66.9 si estaba autoseleccionado
                        if (checkboxE669.checked) {
                            console.log('üîÑ [IMC AUTO] Deseleccionando E66.9 - IMC ya no es obesidad:', imc);
                            checkboxE669.checked = false;
                            
                            // Disparar el evento change para actualizar c√°lculos
                            checkboxE669.dispatchEvent(new Event('change', { bubbles: true }));
                            
                            console.log('üì¢ [IMC AUTO] E66.9 deseleccionado porque IMC ya no es obesidad');
                            
                            // Registrar egreso autom√°tico en egresos_patologias con funcionario "TargetOn"
                            registrarEgresoAutomaticoObesidad(run, 'E66.9', imc);
                        } else {
                            console.log('‚ÑπÔ∏è [IMC AUTO] IMC no clasifica como obesidad, E66.9 no estaba seleccionado');
                        }
                    }
                })
                .catch(error => {
                    console.error('‚ùå [IMC AUTO] Error obteniendo datos de IMC:', error);
                });
        }

        // Funci√≥n para registrar egreso autom√°tico de obesidad cuando IMC baja
        function registrarEgresoAutomaticoObesidad(run, cie10, imcActual) {
            console.log('üìù [EGRESO AUTO] Registrando egreso autom√°tico de obesidad:', { run, cie10, imcActual });
            
            const today = new Date().toISOString().split('T')[0];
            
            const datosEgreso = {
                run: run,
                cie10: cie10,
                motivo_egreso: 'mejoria_clinica',
                fecha_egreso: today,
                funcionario: 'TargetOn',
                observaciones: `Deselecci√≥n autom√°tica por reducci√≥n de IMC. IMC actual: ${imcActual}. Sistema autom√°tico detect√≥ que el paciente ya no cumple criterios de obesidad.`
            };
            
            fetch('/api/egreso_automatico', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(datosEgreso)
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    console.log('‚úÖ [EGRESO AUTO] Egreso autom√°tico de obesidad registrado exitosamente');
                } else {
                    console.warn('‚ö†Ô∏è [EGRESO AUTO] Advertencia al registrar egreso autom√°tico:', data.error || 'Error desconocido');
                }
            })
            .catch(error => {
                console.error('‚ùå [EGRESO AUTO] Error registrando egreso autom√°tico:', error);
                // No mostrar alert al usuario ya que es un proceso autom√°tico en segundo plano
            });
        }

        // COMENTADO: Ya se maneja en DOMContentLoaded principal
        /*
        // Inicializar validaciones cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', function() {
            validarRangosMedicos();
            
            // REMOVIDO: Event listener problem√°tico que limpiaba el RUN
            // El manejo de b√∫squeda se hace solo con manejarBusquedaRun()
            
            // Agregar event listeners a checkboxes de patolog√≠as ECICEP
            const checkboxesPatologias = document.querySelectorAll('.patologia-checkbox');
            checkboxesPatologias.forEach(cb => {
                cb.addEventListener('change', function() {
                    calcularRiesgo();
                    actualizarResumenPatologias();
                    actualizarContadoresCategorias();

                    // Guardar autom√°ticamente la categor√≠a en la BD (debounce)
                    if (typeof scheduleGuardarCategoria === 'function') {
                        scheduleGuardarCategoria();
                    }
                });
            });
            
            // Inicializar c√°lculo de riesgo y contadores
            calcularRiesgo();
            actualizarContadoresCategorias();

            // Inicializar color del select de categor√≠a
            colorearSelectCategoria();
            
            // Funci√≥n para limpiar formulario tambi√©n debe actualizar resumen y c√°lculo
            const originalLimpiar = window.limpiarFormulario;
            window.limpiarFormulario = function() {
                if (originalLimpiar) originalLimpiar();
                
                // Limpiar checkboxes de patolog√≠as ECICEP
                document.querySelectorAll('.patologia-checkbox').forEach(cb => cb.checked = false);
                
                // Limpiar patolog√≠as guardadas
                limpiarPatologiasGuardadas();
                
                calcularRiesgo();
                actualizarResumenPatologias();
                actualizarContadoresCategorias();
            };
        });
        */

        // ===== Guardado autom√°tico de categoria =====
        let _guardarCategoriaTimeout = null;
        function scheduleGuardarCategoria() {
            // En modo Cardio no se debe guardar categor√≠a
            if (window.__BYPASS_RIESGO__ === true) return;
            clearTimeout(_guardarCategoriaTimeout);
            _guardarCategoriaTimeout = setTimeout(() => {
                guardarCategoriaActual();
            }, 800);
        }

    function guardarCategoriaActual() {
            try {
                const run = document.getElementById('run').value.trim();
                const categoriaSelect = document.getElementById('categoria_id');
        if (!run || !categoriaSelect) return;
    if (window.__BYPASS_RIESGO__ === true) return; // bloquea guardado en Cardio

                const payload = { categoria_id: categoriaSelect.value || null };

                fetch(`/api/usuario/${encodeURIComponent(run)}/categoria`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data && data.success) {
                        // aplicar color al select seg√∫n la categor√≠a guardada
                        colorearSelectCategoria();
                    } else {
                        console.error('Error guardando categoria:', data && data.error);
                    }
                }).catch(err => console.error('Error guardando categoria (fetch):', err));
            } catch (e) {
                console.error('Error en guardarCategoriaActual:', e);
            }
        }

        function colorearSelectCategoria() {
            try {
                const categoriaSelect = document.getElementById('categoria_id');
                if (!categoriaSelect) return;
                const val = categoriaSelect.value;
                if (val === '1') {
                    categoriaSelect.style.background = '#198754';
                    categoriaSelect.style.color = '#fff';
                } else if (val === '2') {
                    categoriaSelect.style.background = '#ffc107';
                    categoriaSelect.style.color = '#000';
                } else if (val === '3') {
                    categoriaSelect.style.background = '#dc3545';
                    categoriaSelect.style.color = '#fff';
                } else {
                    categoriaSelect.style.background = '';
                    categoriaSelect.style.color = '';
                }
            } catch (e) {
                // ignore
            }
        }
        // ===== fin guardado autom√°tico de categoria =====

        // Funci√≥n para mostrar los botones de gesti√≥n cuando hay patolog√≠as
        function mostrarBotonesGestion() {
            const botones = document.getElementById('botones-gestion-patologias');
            if (botones) {
                botones.style.display = 'block';
                const btn = document.getElementById('btn-modificar-patologias');
                if (btn) {
                    btn.disabled = false;
                    btn.setAttribute('aria-disabled', 'false');
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        }

        // Funci√≥n para ocultar los botones de gesti√≥n
        function ocultarBotonesGestion() {
            console.log('üîí Deshabilitando botones de gesti√≥n de patolog√≠as...');
            
            const container = document.getElementById('botones-gestion-patologias');
            const btnGuardarPatologias = document.getElementById('btn-guardar-patologias');
            const btnModificarPatologias = document.getElementById('btn-modificar-patologias');
            
            if (container) {
                container.style.opacity = '0.5';
                container.style.pointerEvents = 'none';
                
                // Mostrar el mensaje de ayuda
                const helpText = container.querySelector('small');
                if (helpText) {
                    helpText.style.display = 'block';
                    console.log('üí° Mensaje de ayuda mostrado');
                }
            }
            
            if (btnGuardarPatologias) {
                btnGuardarPatologias.disabled = true;
                btnGuardarPatologias.style.cursor = 'not-allowed';
                btnGuardarPatologias.style.opacity = '0.5';
                btnGuardarPatologias.title = 'Ingrese un RUN v√°lido para habilitar';
                console.log('üîí Bot√≥n "Guardar Patolog√≠as" deshabilitado');
            }
            
            if (btnModificarPatologias) {
                btnModificarPatologias.disabled = true;
                btnModificarPatologias.setAttribute('aria-disabled', 'true');
                btnModificarPatologias.style.opacity = '0.5';
                btnModificarPatologias.style.cursor = 'not-allowed';
                btnModificarPatologias.title = 'Ingrese un RUN v√°lido para habilitar';
                console.log('üîí Bot√≥n "Modificar Patolog√≠as" deshabilitado');
            }
            
            console.log('‚úÖ Botones de gesti√≥n deshabilitados');
        }

        // Funci√≥n para modificar patolog√≠as (eliminar 1 o m√°s patolog√≠as seleccionadas)
        function modificarPatologias(event) {
          // Solo abrir si viene de una interacci√≥n del usuario
          // Evita ejecuciones program√°ticas o en carga inicial
          if (!event || event.isTrusted !== true) return;
          const runActual = document.getElementById('run').value;
          if (!runActual) {
            alert('‚ö†Ô∏è No hay usuario seleccionado');
            return;
          }
          // Obtener las patolog√≠as guardadas
          fetch(`/api/usuario/${encodeURIComponent(runActual)}/patologias`)
            .then(response => response.json())
            .then(data => {
              if (data.patologias && data.patologias.length > 0) {
                mostrarModalSeleccionPatologias(data.patologias, runActual);
              } else {
                alert('‚ùå No hay patolog√≠as guardadas para modificar');
              }
            })
            .catch(error => {
              console.error('Error obteniendo patolog√≠as:', error);
              alert('‚ùå Error obteniendo patolog√≠as guardadas');
            });
        }

        // Funci√≥n para mostrar modal con patolog√≠as para seleccionar cu√°les eliminar
        function esPatologiaEliminable(cie10) {
            if (!cie10) return false;
            const code = String(cie10).trim().toUpperCase();
            if (!code) return false;
            return CIE10_ELIMINABLES.includes(code);
        }

        function mostrarModalSeleccionPatologias(patologias, run) {
            // Contenedor overlay
            const overlay = document.createElement('div');
            overlay.id = 'modal-seleccion-patologias';
            overlay.setAttribute('style', 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;');

            // Caja modal - Mejorada para mejor visualizaci√≥n
            const box = document.createElement('div');
            box.setAttribute('style', 'background: white; padding: 25px; border-radius: 12px; max-width: 800px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); font-family: Arial, sans-serif;');
            overlay.appendChild(box);

            // T√≠tulo y descripci√≥n
            const h3 = document.createElement('h3');
            h3.textContent = 'üóëÔ∏è Selecciona las patolog√≠as a eliminar';
            h3.setAttribute('style', 'margin-top: 0; margin-bottom: 15px; color: #dc2626; font-size: 20px; text-align: center;');
            box.appendChild(h3);

            const p = document.createElement('p');
            p.innerHTML = 'Marca las patolog√≠as que deseas eliminar.<br><small style="color:#b45309; font-weight: 500;">Solo algunas patolog√≠as son eliminables seg√∫n reglas del sistema; las no permitidas aparecer√°n en gris.</small>';
            p.setAttribute('style', 'margin-bottom: 10px; color: #6b7280; text-align: center; line-height: 1.5;');
            box.appendChild(p);

            // Panel resumen eliminables
            const panelResumen = document.createElement('div');
            panelResumen.setAttribute('style','display:flex; justify-content:center; gap:16px; flex-wrap:wrap; margin-bottom:18px; font-size:12px; font-family:system-ui,Arial;');
            const totalSpan = document.createElement('span');
            const eliminablesSpan = document.createElement('span');
            const noEliminablesSpan = document.createElement('span');
            totalSpan.style.cssText = 'background:#f3f4f6; padding:4px 8px; border-radius:14px;';
            eliminablesSpan.style.cssText = 'background:#d1fae5; padding:4px 8px; border-radius:14px;';
            noEliminablesSpan.style.cssText = 'background:#fee2e2; padding:4px 8px; border-radius:14px;';
            panelResumen.appendChild(totalSpan);
            panelResumen.appendChild(eliminablesSpan);
            panelResumen.appendChild(noEliminablesSpan);
            box.appendChild(panelResumen);

            // Lista - Mejorada con mejor espaciado
            const listaDiv = document.createElement('div');
            listaDiv.id = 'lista-patologias-eliminar';
            listaDiv.setAttribute('style', 'max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; background: #fafafa;');
            box.appendChild(listaDiv);

            // Renderizar elementos
            if (Array.isArray(patologias) && patologias.length > 0) {
                let eliminablesCount = 0;
                patologias.forEach(p => {
                    const item = document.createElement('div');
                    item.setAttribute('style', 'margin-bottom: 12px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; transition: all 0.2s ease;');

                    const label = document.createElement('label');
                    label.setAttribute('style', 'display: flex; align-items: flex-start; cursor: pointer; width: 100%;');
                    item.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'patologia-eliminar';
                    input.value = p.cie10;
                    input.setAttribute('style', 'margin-right: 12px; margin-top: 3px; width: 16px; height: 16px;');
                    const eliminable = esPatologiaEliminable(p.cie10);
                    if (eliminable) eliminablesCount++;
                    if (!eliminable) {
                        input.disabled = true;
                    }
                    label.appendChild(input);

                    const info = document.createElement('div');
                    info.setAttribute('style', 'flex: 1; min-width: 0;');
                    
                    const title = document.createElement('div');
                    title.textContent = (p.nombre_patologia_cie10 || p.nombre || p.cie10);
                    title.setAttribute('style', 'font-weight: 600; color: #374151; font-size: 14px; line-height: 1.4; margin-bottom: 4px; word-wrap: break-word;');
                    
                    const sub = document.createElement('div');
                    sub.textContent = 'CIE10: ' + p.cie10 + (eliminable ? '' : ' ‚Ä¢ No eliminable');
                    sub.setAttribute('style', 'font-size: 12px; line-height: 1.3; ' + (eliminable ? 'color:#6b7280;' : 'color:#9ca3af; font-weight: 500;'));
                    
                    // Hover effect
                    item.addEventListener('mouseenter', function() {
                        if (eliminable) {
                            this.style.borderColor = '#3b82f6';
                            this.style.backgroundColor = '#f0f9ff';
                        }
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.borderColor = '#e5e7eb';
                        this.style.backgroundColor = 'white';
                    });
                    
                    if (!eliminable) {
                        item.style.opacity = '0.6';
                        item.style.backgroundColor = '#f5f5f5';
                    }
                    
                    info.appendChild(title);
                    info.appendChild(sub);
                    label.appendChild(info);

                    listaDiv.appendChild(item);
                });
                // Actualizar resumen panel
                try {
                    totalSpan.textContent = `Total: ${patologias.length}`;
                    eliminablesSpan.textContent = `Eliminables: ${eliminablesCount}`;
                    noEliminablesSpan.textContent = `No eliminables: ${patologias.length - eliminablesCount}`;
                } catch(ePanel){ console.warn('No se pudo actualizar panel resumen modal', ePanel); }
            } else {
                const empty = document.createElement('div');
                empty.textContent = 'No hay patolog√≠as guardadas';
                empty.setAttribute('style', 'text-align:center; color:#666; padding: 40px; font-style: italic;');
                listaDiv.appendChild(empty);
            }

            // Nota - Mejorada
            const nota = document.createElement('div');
            nota.setAttribute('style', 'margin-top: 15px; padding: 12px; background: linear-gradient(145deg, #fef3c7, #fde68a); border-radius: 8px; font-size: 13px; border-left: 4px solid #f59e0b;');
            nota.innerHTML = '<strong>‚ö†Ô∏è Nota:</strong> Las patolog√≠as marcadas ser√°n eliminadas permanentemente. Esta acci√≥n no se puede deshacer.';
            box.appendChild(nota);

            // Botonera selecci√≥n - Mejorada
            const selRow = document.createElement('div');
            selRow.setAttribute('style', 'text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;');
            
            const btnSel = document.createElement('button');
            btnSel.textContent = '‚úì Seleccionar Todas';
            btnSel.setAttribute('style', 'background: linear-gradient(145deg, #10b981, #059669); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnSel.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)'; });
            btnSel.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnSel.addEventListener('click', seleccionarTodasPatologias);
            
            const btnDes = document.createElement('button');
            btnDes.textContent = '‚úó Deseleccionar Todas';
            btnDes.setAttribute('style', 'background: linear-gradient(145deg, #6b7280, #4b5563); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnDes.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)'; });
            btnDes.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnDes.addEventListener('click', deseleccionarTodasPatologias);
            
            selRow.appendChild(btnSel);
            selRow.appendChild(btnDes);
            box.appendChild(selRow);

            // Separador + acciones - Mejoradas
            const acciones = document.createElement('div');
            acciones.setAttribute('style', 'text-align: center; margin-top: 25px; border-top: 2px solid #e5e7eb; padding-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;');
            
            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = '‚Üê Cancelar';
            btnCancelar.setAttribute('style', 'background: linear-gradient(145deg, #6b7280, #4b5563); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnCancelar.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)'; });
            btnCancelar.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnCancelar.addEventListener('click', cerrarModalSeleccion);
            
            const btnEliminar = document.createElement('button');
            btnEliminar.textContent = 'üóëÔ∏è Eliminar Seleccionadas';
            btnEliminar.setAttribute('style', 'background: linear-gradient(145deg, #dc2626, #b91c1c); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);');
            btnEliminar.addEventListener('mouseenter', function() { this.style.transform = 'translateY(-1px)'; this.style.boxShadow = '0 4px 8px rgba(220,38,38,0.3)'; });
            btnEliminar.addEventListener('mouseleave', function() { this.style.transform = 'translateY(0)'; this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)'; });
            btnEliminar.addEventListener('click', () => confirmarEliminacionSelectiva(run));
            
            acciones.appendChild(btnCancelar);
            acciones.appendChild(btnEliminar);
            box.appendChild(acciones);

            // Agregar al DOM con efecto de cierre mejorado
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    cerrarModalSeleccion();
                }
            });
            
            // Cerrar con tecla Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('modal-seleccion-patologias')) {
                    cerrarModalSeleccion();
                }
            });
            
            document.body.appendChild(overlay);
        }

        // Funciones auxiliares para el modal de selecci√≥n
        function seleccionarTodasPatologias() {
            const checkboxes = document.querySelectorAll('input[name="patologia-eliminar"]');
            checkboxes.forEach(cb => { if (!cb.disabled) cb.checked = true; });
        }

        function deseleccionarTodasPatologias() {
            const checkboxes = document.querySelectorAll('input[name="patologia-eliminar"]');
            checkboxes.forEach(cb => cb.checked = false);
        }

        function cerrarModalSeleccion() {
            const modal = document.getElementById('modal-seleccion-patologias');
            if (modal) {
                modal.remove();
            }
        }

        function confirmarEliminacionSelectiva(run) {
            const checkboxes = document.querySelectorAll('input[name="patologia-eliminar"]:checked');
            
            if (checkboxes.length === 0) {
                alert('‚ö†Ô∏è Selecciona al menos una patolog√≠a para eliminar');
                return;
            }

            const patologiasSeleccionadas = Array.from(checkboxes).map(cb => cb.value);
            
            if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de eliminar ${patologiasSeleccionadas.length} patolog√≠a(s)?\n\nEsta acci√≥n NO se puede deshacer.`)) {
                return;
            }

            // Solicitar contrase√±a del usuario
            const password = prompt('üîê Ingresa tu contrase√±a para confirmar la eliminaci√≥n:');
            
            if (!password) {
                alert('‚ùå Operaci√≥n cancelada - Se requiere contrase√±a');
                return;
            }

            // Eliminar las patolog√≠as seleccionadas
            eliminarPatologiasSeleccionadas(run, patologiasSeleccionadas, password);
        }

        function eliminarPatologiasSeleccionadas(run, patologiasCIE10, password) {
            console.log('üóëÔ∏è Eliminando patolog√≠as seleccionadas (nuevo endpoint):', patologiasCIE10);
            const runLimpio = run.replace(/[^0-9kK]/g,'');
            fetch(`/api/patologias/eliminar_selectivas/${runLimpio}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codes: patologiasCIE10, password })
            })
            .then(r => r.json())
            .then(data => {
                try {
                    if (!data) { alert('‚ùå Respuesta vac√≠a del servidor'); return; }
                    console.log('üóëÔ∏è Respuesta eliminaci√≥n:', data);
                    if (data.success) {
                        const res = data.resumen || {};
                        const partes = [];
                        partes.push(`Eliminados: ${res.total_eliminados ?? (data.eliminados?.length || 0)}`);
                        if (res.total_no_encontrados) partes.push(`No encontrados: ${res.total_no_encontrados}`);
                        if (res.total_protegidas) partes.push(`Protegidas: ${res.total_protegidas}`);
                        if (res.total_invalidos) partes.push(`Inv√°lidos: ${res.total_invalidos}`);
                        alert('‚úÖ Eliminaci√≥n completada\n' + partes.join('\n'));
                        cerrarModalSeleccion();
                        cargarPatologiasGuardadas(run);
                        // Reinicializar baseline tras breve delay para reflejar estado post-eliminaci√≥n
                        setTimeout(() => {
                            if (typeof inicializarBaselinePatologias === 'function') inicializarBaselinePatologias();
                            // Actualizar sets de cambios locales: remover cada c√≥digo de base y agregados, a√±adir a removidos
                            try {
                                patologiasCIE10.forEach(code => {
                                    if (window._patologiasBase instanceof Set) window._patologiasBase.delete(code);
                                    if (window._patologiasAgregadas instanceof Set) window._patologiasAgregadas.delete(code);
                                    if (window._patologiasRemovidas instanceof Set) window._patologiasRemovidas.add(code);
                                });
                                if (typeof actualizarIndicadorCambiosPatologias === 'function') actualizarIndicadorCambiosPatologias();
                            } catch(eSetsM) { console.warn('‚ö†Ô∏è No se pudo actualizar sets tras eliminaci√≥n m√∫ltiple', eSetsM); }
                        }, 600);
                    } else {
                        const partes = [];
                        if (data.error) partes.push('Error: ' + data.error);
                        if (data.protegidas?.length) partes.push('Protegidas: ' + data.protegidas.join(', '));
                        if (data.no_encontrados?.length) partes.push('No encontradas: ' + data.no_encontrados.join(', '));
                        if (data.invalidos?.length) partes.push('Inv√°lidos: ' + data.invalidos.join(', '));
                        alert('‚ùå No se complet√≥ la eliminaci√≥n\n' + partes.join('\n'));
                    }
                } catch(e) {
                    console.error('Error procesando respuesta de eliminaci√≥n:', e, data);
                    alert('‚ùå Error procesando respuesta');
                }
            })
            .catch(err => {
                console.error('‚ùå Error eliminando patolog√≠as:', err);
                alert('‚ùå Error de conexi√≥n al eliminar patolog√≠as');
            });
        }

    // IMC display removed ‚Äî funciones eliminadas por request

        // Funci√≥n para modificar patolog√≠as (eliminar solo algunas)
        function modificarPatologias_old() {
            const run = document.getElementById('run').value.trim();
            if (!run) {
                alert('Ingrese un RUN v√°lido');
                return;
            }

            // Mostrar modal de modificaci√≥n
            mostrarModalModificacion(run);
        }

        // Funci√≥n para mostrar modal de modificaci√≥n de patolog√≠as (versi√≥n program√°tica)
        function mostrarModalModificacion(run) {
            const overlay = document.createElement('div');
            overlay.id = 'modal-modificacion';
            overlay.setAttribute('style', 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;');

            const box = document.createElement('div');
            box.setAttribute('style', 'background: white; border-radius: 8px; padding: 20px; max-width: 600px; max-height: 80%; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);');
            overlay.appendChild(box);

            const h3 = document.createElement('h3');
            h3.textContent = '‚úèÔ∏è Modificar Patolog√≠as';
            h3.setAttribute('style', 'margin-top: 0; color: #f59e0b;');
            box.appendChild(h3);

            const prun = document.createElement('p');
            prun.innerHTML = 'RUN: <strong></strong>';
            prun.querySelector('strong').textContent = run;
            box.appendChild(prun);

            const lista = document.createElement('div');
            lista.id = 'lista-patologias-modificar';
            lista.setAttribute('style', 'max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px; margin: 10px 0;');
            const loading = document.createElement('div');
            loading.setAttribute('style', 'text-align: center; color: #666;');
            loading.textContent = 'Cargando patolog√≠as...';
            lista.appendChild(loading);
            box.appendChild(lista);

            const actions = document.createElement('div');
            actions.setAttribute('style', 'margin-top: 15px; text-align: right;');
            const btnCancel = document.createElement('button');
            btnCancel.textContent = 'Cancelar';
            btnCancel.setAttribute('style', 'background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 8px; cursor: pointer;');
            btnCancel.addEventListener('click', cerrarModalModificacion);
            const btnApply = document.createElement('button');
            btnApply.textContent = 'Aplicar Cambios';
            btnApply.setAttribute('style', 'background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;');
            btnApply.addEventListener('click', aplicarModificaciones);
            actions.appendChild(btnCancel);
            actions.appendChild(btnApply);
            box.appendChild(actions);

            document.body.appendChild(overlay);

            // Cargar patolog√≠as del usuario
            cargarPatologiasParaModificar(run);
        }

        // Funci√≥n para cargar patolog√≠as en el modal de modificaci√≥n (program√°tica)
        function cargarPatologiasParaModificar(run) {
            const container = document.getElementById('lista-patologias-modificar');
            if (!container) return;

            fetch(`/api/usuario/${run}/patologias`)
                .then(response => response.json())
                .then(data => {
                    container.innerHTML = '';
                    if (data && data.success && Array.isArray(data.patologias) && data.patologias.length > 0) {
                        const titulo = document.createElement('div');
                        titulo.setAttribute('style', 'margin-bottom: 10px;');
                        titulo.innerHTML = '<strong>Seleccione las patolog√≠as a ELIMINAR:</strong>';
                        container.appendChild(titulo);

                        data.patologias.forEach(patologia => {
                            const item = document.createElement('div');
                            item.setAttribute('style', 'margin-bottom: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;');
                            const label = document.createElement('label');
                            label.setAttribute('style', 'display: flex; align-items: flex-start; cursor: pointer;');
                            const input = document.createElement('input');
                            input.type = 'checkbox';
                            input.className = 'patologia-eliminar';
                            input.value = patologia.cie10;
                            input.setAttribute('style', 'margin-right: 8px; margin-top: 2px;');
                            const info = document.createElement('div');
                            const nombre = document.createElement('div');
                            nombre.textContent = patologia.nombre_patologia_cie10;
                            nombre.setAttribute('style', 'font-weight: 500; color: #374151;');
                            const cie = document.createElement('div');
                            cie.textContent = 'CIE10: ' + patologia.cie10;
                            cie.setAttribute('style', 'font-size: 12px; color: #6b7280;');
                            info.appendChild(nombre);
                            info.appendChild(cie);
                            label.appendChild(input);
                            label.appendChild(info);
                            item.appendChild(label);
                            container.appendChild(item);
                        });

                        const nota = document.createElement('div');
                        nota.setAttribute('style', 'margin-top: 10px; padding: 8px; background: #fef3c7; border-radius: 4px; font-size: 12px;');
                        nota.innerHTML = '<strong>‚ö†Ô∏è Nota:</strong> Las patolog√≠as marcadas ser√°n eliminadas permanentemente.';
                        container.appendChild(nota);
                    } else {
                        const empty = document.createElement('div');
                        empty.setAttribute('style', 'text-align: center; color: #666;');
                        empty.textContent = 'No hay patolog√≠as para modificar';
                        container.appendChild(empty);
                    }
                })
                .catch(error => {
                    console.error('Error cargando patolog√≠as:', error);
                    container.innerHTML = '<div style="text-align: center; color: #ef4444;">Error cargando patolog√≠as</div>';
                });
        }

        // Funci√≥n para cerrar el modal de modificaci√≥n
        function cerrarModalModificacion() {
            const modal = document.getElementById('modal-modificacion');
            if (modal) {
                modal.remove();
            }
        }

        // Funci√≥n para aplicar las modificaciones
        function aplicarModificaciones() {
            const checkboxes = document.querySelectorAll('.patologia-eliminar:checked');
            
            if (checkboxes.length === 0) {
                alert('Seleccione al menos una patolog√≠a para eliminar');
                return;
            }

            const cie10sEliminar = Array.from(checkboxes).map(cb => cb.value);
            const count = cie10sEliminar.length;

            if (!confirm(`¬øEst√° seguro de eliminar ${count} patolog√≠a(s) seleccionada(s)?`)) {
                return;
            }

            // Solicitar contrase√±a
            const password = prompt('Ingrese su contrase√±a para confirmar la eliminaci√≥n:');
            if (!password) {
                return;
            }

            const run = document.getElementById('run').value.trim();

            // Enviar solicitud de eliminaci√≥n selectiva
            fetch('/api/eliminar_patologias_selectivas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    run: run,
                    password: password,
                    cie10s_eliminar: cie10sEliminar
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ ${count} patolog√≠a(s) eliminada(s) exitosamente`);
                    cerrarModalModificacion();
                    // Actualizar la vista de patolog√≠as guardadas
                    actualizarPatologiasGuardadas();
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error eliminando patolog√≠as');
            });
        }

        // Funci√≥n para marcar checkboxes de patolog√≠as guardadas y expandir categor√≠as
        function marcarPatologiasGuardadas(patologias) {
            try {
                if (!Array.isArray(patologias)) return;
                const categoriasConPatologias = new Set();
                patologias.forEach(p => {
                    const c10 = (p.cie10 || '').toUpperCase();
                    if (!c10) return;
                    const cb = document.querySelector(`input.patologia-checkbox[value="${c10}"]`)
                           || document.querySelector(`input[name="patologia[]"][value="${c10}"]`);
                    if (!cb) return;
                    cb.checked = true;
                    const fam = cb.closest('.familia-content');
                    if (fam && fam.classList.contains('collapsed')) {
                        fam.classList.remove('collapsed');
                        const famToggle = fam.closest('.familia')?.querySelector('.familia-toggle');
                        if (famToggle) famToggle.textContent = '‚àí';
                    }
                    const cat = cb.closest('.categoria-seccion');
                    if (cat && cat.id) categoriasConPatologias.add(cat.id);
                });
                categoriasConPatologias.forEach(id => expandirCategoria(id));
                try {
                    if (typeof calcularRiesgo === 'function') calcularRiesgo();
                    if (typeof actualizarResumenPatologias === 'function') actualizarResumenPatologias();
                    if (typeof actualizarContadoresCategorias === 'function') actualizarContadoresCategorias();
                } catch (e) {}
            } catch (e) {
                console.warn('No se pudieron marcar patolog√≠as guardadas:', e);
            }
        }

        // Funci√≥n para crear mapeo CIE10 -> valor de formulario
        async function crearMapeoPatologias() {
            try {
                const response = await fetch('/api/mapeo_cie10_formulario');
                if (response.ok) {
                    const data = await response.json();
                    return data.mapeo || {};
                }
            } catch (error) {
                console.error('Error obteniendo mapeo CIE10:', error);
            }
            return {};
        }

        // Funci√≥n para expandir una categor√≠a espec√≠fica
        function expandirCategoria(categoriaId) {
            const categoria = document.getElementById(categoriaId);
            if (!categoria) return;
            const toggle = categoria.querySelector('.categoria-toggle');
            const contenido = categoria.querySelector('.categoria-content');
            if (contenido && contenido.classList.contains('collapsed')) {
                contenido.classList.remove('collapsed');
            }
            if (toggle) toggle.textContent = '‚àí';
        }

        // Funciones heredadas (mantener compatibilidad)
        function mostrarBotonEliminar() {
            mostrarBotonesGestion();
        }

        function ocultarBotonEliminar() {
            ocultarBotonesGestion();
        }
    </script>
    <!-- Coloca el siguiente bloque al final, antes de </body> -->
    <!-- Carga de m√≥dulo Screening externo -->
    <script src="{{ url_for('static', filename='js/screening_utils.js') }}"></script>
    
    <!-- Script de correcci√≥n para alertas -->
    <script>
// Script para corregir las alertas de vigencia
// Solo define las funciones necesarias sin c√≥digo problem√°tico

// Funci√≥n para mostrar alertas
window.mostrarAlertas = function() {
    console.log('üîî MOSTRANDO ALERTAS');
    
    const sidebar = document.getElementById('health-alerts-floating');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.style.display = 'block';
        sidebar.classList.add('show');
        overlay.style.display = 'block';
        overlay.classList.add('show');
        
        // Cargar alertas din√°micas
        setTimeout(() => {
            console.log('üîç Verificando disponibilidad de cargarAlertasVigenciaFlotante...');
            if (typeof cargarAlertasVigenciaFlotante === 'function') {
                console.log('‚úÖ Funci√≥n encontrada, ejecutando...');
                cargarAlertasVigenciaFlotante();
            } else if (typeof window.cargarAlertasVigenciaFlotante === 'function') {
                console.log('‚úÖ Funci√≥n encontrada en window, ejecutando...');
                window.cargarAlertasVigenciaFlotante();
            } else {
                console.error('‚ùå Funci√≥n cargarAlertasVigenciaFlotante no encontrada');
                console.log('üîß Intentando cargar alertas con m√©todo alternativo...');
                // M√©todo alternativo: cargar alertas b√°sicas
                mostrarMensajeEnTabs('‚ö†Ô∏è Sistema de alertas en modo b√°sico. Ingrese un RUN v√°lido.');
            }
        }, 200);
        
        // Cambiar texto del bot√≥n
        const btn = document.getElementById('ver-alertas-btn');
        if (btn) {
            btn.innerHTML = '‚úÖ Alertas';
        }
    } else {
        console.error('‚ùå No se encontraron elementos sidebar/overlay');
    }
};

// Funci√≥n para cargar alertas de vigencia
cargarAlertasVigenciaFlotante = async function() {
    console.log('üîî Iniciando carga r√°pida de alertas');
    
    // Obtener RUN del formulario din√°micamente
    let run = null;
    
    try {
        const runElement = document.getElementById('run');
        if (runElement && runElement.value && runElement.value.trim().length >= 5) {
            run = runElement.value.trim();
        }
    } catch (e) {
        console.log('‚ö†Ô∏è No se pudo obtener RUN del formulario');
    }
    
    // Si no hay RUN v√°lido, no cargar alertas
    if (!run || run.length < 5) {
        console.log('‚ùå No hay RUN v√°lido para cargar alertas');
        mostrarMensajeEnTabs('‚ö†Ô∏è Ingrese un RUN v√°lido para ver las alertas personalizadas');
        return;
    }
    
    console.log('‚ö° Usando RUN:', run);
    
    // Mostrar loading inmediatamente
    mostrarLoadingEnTabs();

    try {
        // Usar el endpoint real de alertas
        const url = `/api/vigencia/alertas/${encodeURIComponent(run)}`;
        console.log('üì° Llamada a:', url);
        
        const response = await fetch(url, { 
            method: 'GET',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        console.log('üìä Response status:', response.status);
        console.log('üìä Response ok:', response.ok);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('‚ö° Datos recibidos del servidor:', data);

        // Verificar si hay alertas (estructura real del endpoint)
        if (data && data.success && data.alertas) {
            console.log('‚úÖ Procesando alertas v√°lidas del servidor');
            console.log('üìã RUN:', data.run || 'N/A');
            console.log('üìä Estructura de alertas:', Object.keys(data.alertas));
            
            // Contar alertas por categor√≠a
            let totalAlertas = 0;
            const examenes = data.alertas.examenes || {};
            const screening = data.alertas.screening || {};
            const podologia = data.alertas.podologia;
            
            totalAlertas += Object.keys(examenes).length;
            totalAlertas += Object.keys(screening).length;
            if (podologia) totalAlertas += 1;
            
            console.log('üìä Total de alertas:', totalAlertas);
            console.log('üìä Ex√°menes:', Object.keys(examenes).length);
            console.log('üìä Screening:', Object.keys(screening).length);
            console.log('üìä Podolog√≠a:', podologia ? 'S√≠' : 'No');
            
            // Pasar la estructura directamente (ya est√° organizada por categor√≠a)
            mostrarAlertasSimplificadas(data.alertas);
        } else if (data && data.success === false) {
            // Error del servidor
            console.error('‚ùå Error del servidor:', data.error || 'Error desconocido');
            throw new Error(data.error || 'Error del servidor');
        } else {
            console.error('‚ùå Respuesta del servidor no v√°lida:', data);
            throw new Error(data.error || 'No se encontraron datos de alertas');
        }
        
    } catch (error) {
        console.error('‚ùå Error completo:', error);
        console.error('‚ùå Error message:', error.message);
        console.error('‚ùå Error stack:', error.stack);
        mostrarErrorEnTabs('Error cargando alertas: ' + error.message);
    }
}

// Asignar la funci√≥n al objeto window para acceso global
window.cargarAlertasVigenciaFlotante = cargarAlertasVigenciaFlotante;

// Funci√≥n simplificada para mostrar alertas de nuestra API
function mostrarAlertasSimplificadas(alertasData) {
    console.log('‚ö° Mostrando alertas simplificadas:', alertasData);
    
    if (!alertasData || typeof alertasData !== 'object') {
        console.error('‚ùå No hay datos de alertas v√°lidos:', alertasData);
        mostrarErrorEnTabs('No hay datos disponibles');
        return;
    }

    const examenes = alertasData.examenes || {};
    const screening = alertasData.screening || {};
    const podologia = alertasData.podologia;

    // Helper para calcular d√≠as desde una fecha
    const diasDesde = (fecha) => {
        if (!fecha) return Number.POSITIVE_INFINITY;
        const d = new Date(String(fecha));
        if (isNaN(d)) return Number.POSITIVE_INFINITY;
        return Math.floor((new Date() - d) / 86400000);
    };

    // Helper para icono de vigencia
    const iconoVigencia = (vigente) => (vigente ? '‚úÖ' : '‚ö†Ô∏è');

    // Mostrar ex√°menes
    const examenesElement = document.getElementById('alert-examenes');
    if (examenesElement) {
        let htmlExamenes = '<div style="padding:8px;font-size:12px;line-height:1.4">';
        
        if (Object.keys(examenes).length > 0) {
            for (const [nombre, datos] of Object.entries(examenes)) {
                const dias = diasDesde(datos.fecha_examen);
                const vigente = dias <= 365; // Vigencia de 1 a√±o
                const valor = datos.valor || '';
                const unidad = datos.unidad || '';
                
                htmlExamenes += `<div style="margin:3px 0;padding:3px;border-left:3px solid ${vigente ? '#22c55e' : '#f59e0b'};padding-left:8px;">`;
                htmlExamenes += `${iconoVigencia(vigente)} <strong>${datos.tipo_examen || nombre}</strong>`;
                if (valor) htmlExamenes += `: ${valor}${unidad ? ' ' + unidad : ''}`;
                if (datos.fecha_examen) htmlExamenes += `<br><small>üìÖ <span class="fecha-examen" data-fecha="${datos.fecha_examen}">${datos.fecha_examen}</span> (${dias} d√≠as)</small>`;
                htmlExamenes += '</div>';
            }
        } else {
            htmlExamenes += '<div style="color:#666;text-align:center;padding:20px;">üìã Sin ex√°menes registrados</div>';
        }
        
        htmlExamenes += '</div>';
        examenesElement.innerHTML = htmlExamenes;
    }

    // Mostrar screening
    const screeningElement = document.getElementById('alert-screening');
    if (screeningElement) {
        let htmlScreening = '<div style="padding:8px;font-size:12px;line-height:1.4">';
        
        if (Object.keys(screening).length > 0) {
            for (const [tipo, datos] of Object.entries(screening)) {
                const dias = diasDesde(datos.fecha);
                let vigente = false;
                
                // Diferentes vigencias seg√∫n tipo de screening
                if (tipo === 'PAP') vigente = dias <= 1095; // 3 a√±os
                else if (tipo === 'mamografia') vigente = dias <= 730; // 2 a√±os
                else if (tipo === 'PSA') vigente = dias <= 365; // 1 a√±o
                else vigente = dias <= 365; // Por defecto 1 a√±o
                
                htmlScreening += `<div style="margin:3px 0;padding:3px;border-left:3px solid ${vigente ? '#22c55e' : '#f59e0b'};padding-left:8px;">`;
                htmlScreening += `${iconoVigencia(vigente)} <strong>${tipo}</strong>`;
                if (datos.fecha) htmlScreening += `<br><small style="color:#666;">üìÖ ${datos.fecha} (${dias} d√≠as)</small>`;
                htmlScreening += '</div>';
            }
        } else {
            htmlScreening += '<div style="color:#666;text-align:center;padding:20px;">üî¨ Sin screening registrado</div>';
        }
        
        htmlScreening += '</div>';
        screeningElement.innerHTML = htmlScreening;
    }

    // Mostrar podolog√≠a
    const procedimientosElement = document.getElementById('alert-procedimientos');
    if (procedimientosElement) {
        let htmlPodologia = '<div style="padding:8px;font-size:12px;line-height:1.4">';
        
        if (podologia) {
            const dias = diasDesde(podologia.fecha);
            const vigente = podologia.atencion_vigente || dias <= 365;
            
            htmlPodologia += `<div style="margin:3px 0;padding:3px;border-left:3px solid ${vigente ? '#22c55e' : '#f59e0b'};padding-left:8px;">`;
            htmlPodologia += `${iconoVigencia(vigente)} <strong>Atenci√≥n Podol√≥gica</strong>`;
            if (podologia.fecha) htmlPodologia += `<br><small style="color:#666;">üìÖ ${podologia.fecha} (${dias} d√≠as)</small>`;
            if (podologia.atencion_vigente !== undefined) {
                htmlPodologia += `<br><small style="color:#666;">Estado: ${podologia.atencion_vigente ? 'Vigente' : 'No vigente'}</small>`;
            }
            htmlPodologia += '</div>';
        } else {
            htmlPodologia += '<div style="color:#666;text-align:center;padding:20px;">ü¶∂ Sin atenci√≥n podol√≥gica registrada</div>';
        }
        
        htmlPodologia += '</div>';
        procedimientosElement.innerHTML = htmlPodologia;
    }

    // Limpiar tabs no utilizados
    const tabsLimpiar = ['tratamientos', 'cardiovascular'];
    tabsLimpiar.forEach(tabId => {
        const element = document.getElementById(`alert-${tabId}`);
        if (element) {
            element.innerHTML = '<div style="padding:20px;text-align:center;color:#666;font-size:12px;">üìä Datos no disponibles en esta vista</div>';
        }
    });

    console.log('‚úÖ Alertas mostradas correctamente');
}

// Funci√≥n para mostrar datos directos
async function mostrarDatosDirectos(alertas) {
    console.log('‚ö° Mostrando datos directos:', alertas);
    if (!alertas || typeof alertas !== 'object') {
        console.error('‚ùå No hay datos de alertas v√°lidos:', alertas);
        mostrarErrorEnTabs('No hay datos disponibles');
        return;
    }

    // Helpers locales
    const hoy = new Date();
    const diasDesde = (fecha) => {
        if (!fecha) return Number.POSITIVE_INFINITY;
        const d = new Date(String(fecha));
        if (isNaN(d)) return Number.POSITIVE_INFINITY;
        return Math.floor((hoy - d) / 86400000);
    };
    const iconoVigencia = (vigente) => (vigente ? '‚úÖ' : '‚ö†Ô∏è');
    const getRunClean = () => {
        try { return (document.getElementById('run')?.value || '').replace(/[^0-9kK]/g,''); } catch(_) { return ''; }
    };
    const getSexoEdad = () => {
        const sexoVal = (document.getElementById('sexo')?.value || '').toLowerCase();
        const fnac = document.getElementById('fecha_nacimiento')?.value || '';
        let edad = null;
        try {
            const d = new Date(fnac);
            if (!isNaN(d)) {
                const h = new Date();
                edad = h.getFullYear() - d.getFullYear();
                const m = h.getMonth() - d.getMonth();
                if (m < 0 || (m === 0 && h.getDate() < d.getDate())) edad--;
            }
        } catch(_) {}
        return { sexo: sexoVal, edad };
    };

    // Enriquecer con datos adicionales en paralelo
    const runLimpio = getRunClean();
    let vacunasData = null, amData = null, heartsData = null, diabetesData = null;
    try {
        const peticiones = [];
        if (runLimpio) {
            peticiones.push(fetch(`/api/demograficos/${encodeURIComponent(runLimpio)}/vacunas`).then(r=>r.ok?r.json():null).catch(()=>null));
            peticiones.push(fetch(`/api/examenes/adulto_mayor/${encodeURIComponent(runLimpio)}`).then(r=>r.ok?r.json():null).catch(()=>null));
            peticiones.push(fetch(`/api/cardiovascular/hearts/${encodeURIComponent(runLimpio)}`).then(r=>r.ok?r.json():null).catch(()=>null));
            peticiones.push(fetch(`/api/examenes/diabetes_consolidado/${encodeURIComponent(runLimpio)}`).then(r=>r.ok?r.json():null).catch(()=>null));
        }
        const [vac, am, hearts, diabetes] = await Promise.all(peticiones);
        vacunasData = (vac && vac.success) ? vac : null;
        amData = (am && am.success && am.found) ? am.data : null;
        heartsData = (hearts && hearts.success && hearts.found) ? hearts.data : null;
        diabetesData = (diabetes && diabetes.success && diabetes.found) ? diabetes.data : null;
    } catch(e) {
        console.warn('‚ö†Ô∏è Error obteniendo datos adicionales:', e);
    }

    console.log('üìã Estructura de alertas recibidas:', Object.keys(alertas));
    const tabs = ['examenes', 'screening', 'procedimientos', 'tratamientos', 'cardiovascular'];

    tabs.forEach(tabId => {
        const element = document.getElementById(`alert-${tabId}`);
        if (!element) { console.warn(`‚ö†Ô∏è Elemento alert-${tabId} no encontrado`); return; }
        let html = '<div style="padding:8px;color:#666;font-size:12px">';

        try {
            if (tabId === 'examenes') {
                const exs = alertas.examenes || {};
                html = '<div style="padding:5px;font-size:11px;line-height:1.3">';
                const ya = new Set();
                
                // Primero mostrar ex√°menes de diabetes consolidados si est√°n disponibles
                if (diabetesData) {
                    // HbA1c (vigencia 1 a√±o)
                    if (diabetesData.hba1c) {
                        const d = diasDesde(diabetesData.hba1c.fecha);
                        const vigente = d <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} HbA1c: ${diabetesData.hba1c.valor}% ‚Äî ${diabetesData.hba1c.fecha}</div>`;
                        ya.add('hba1c');
                    }
                    
                    // VFG (vigencia 1 a√±o)
                    if (diabetesData.vfg) {
                        const d = diasDesde(diabetesData.vfg.fecha);
                        const vigente = d <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} VFG: ${diabetesData.vfg.valor} mL/min ‚Äî ${diabetesData.vfg.fecha}</div>`;
                        ya.add('vfg');
                    }
                    
                    // RAC (vigencia 1 a√±o)
                    if (diabetesData.rac) {
                        const d = diasDesde(diabetesData.rac.fecha);
                        const vigente = d <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} RAC: ${diabetesData.rac.valor} mg/g ‚Äî ${diabetesData.rac.fecha}</div>`;
                        ya.add('rac');
                    }
                    
                    // LDL (vigencia 1 a√±o)
                    if (diabetesData.ldl) {
                        const d = diasDesde(diabetesData.ldl.fecha);
                        const vigente = d <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} LDL: ${diabetesData.ldl.valor} mg/dL ‚Äî ${diabetesData.ldl.fecha}</div>`;
                        ya.add('ldl');
                    }
                    
                    // Creatinina (vigencia 1 a√±o)
                    if (diabetesData.creatinina) {
                        const d = diasDesde(diabetesData.creatinina.fecha);
                        const vigente = d <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} Creatinina: ${diabetesData.creatinina.valor} mg/dL ‚Äî ${diabetesData.creatinina.fecha}</div>`;
                        ya.add('creatinina');
                    }
                    
                    // EKG (vigencia 1 a√±o)
                    if (diabetesData.ekg) {
                        const d = diasDesde(diabetesData.ekg.fecha);
                        const vigente = d <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} EKG: ${diabetesData.ekg.resultado} ‚Äî ${diabetesData.ekg.fecha}</div>`;
                        ya.add('ekg');
                    }
                    
                    // Pie Diab√©tico (vigencia 1 a√±o)
                    if (diabetesData.pie_diabetico) {
                        const d = diasDesde(diabetesData.pie_diabetico.fecha);
                        const vigente = d <= 365;
                        let riesgo = 'Sin riesgo';
                        if (diabetesData.pie_diabetico.riesgo_maximo) riesgo = 'Riesgo m√°ximo';
                        else if (diabetesData.pie_diabetico.riesgo_alto) riesgo = 'Riesgo alto';
                        else if (diabetesData.pie_diabetico.riesgo_moderado) riesgo = 'Riesgo moderado';
                        else if (diabetesData.pie_diabetico.riesgo_bajo) riesgo = 'Riesgo bajo';
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} Pie DM: ${riesgo} ‚Äî ${diabetesData.pie_diabetico.fecha}</div>`;
                        
                        // Mostrar informaci√≥n de amputaci√≥n/√∫lcera si aplica
                        if (diabetesData.pie_diabetico.ulcera_o_amputacion) {
                            html += `<div style="margin:1px 0;padding:2px">‚ö†Ô∏è Amputaci√≥n/√ölcera previa ‚Äî ${diabetesData.pie_diabetico.fecha}</div>`;
                        }
                        
                        ya.add('pie diabetico');
                        ya.add('pie dm');
                        ya.add('amputacion');
                    }
                    
                    // Fondo de Ojos (vigencia 1 a√±o)
                    if (diabetesData.fondo_ojos) {
                        const d = diasDesde(diabetesData.fondo_ojos.fecha);
                        const vigente = d <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} Fondo de Ojos: ${diabetesData.fondo_ojos.resultado} ‚Äî ${diabetesData.fondo_ojos.fecha}</div>`;
                        ya.add('fondo de ojos');
                    }
                    
                    // Hipoglicemias (vigencia 6 meses)
                    if (diabetesData.hipoglicemias) {
                        const d = diasDesde(diabetesData.hipoglicemias.fecha);
                        const vigente = d <= 180; // 6 meses
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} Hipoglicemias: ${diabetesData.hipoglicemias.tipo} (${diabetesData.hipoglicemias.severidad}) ‚Äî ${diabetesData.hipoglicemias.fecha}</div>`;
                        ya.add('hipoglicemias');
                    }
                }
                
                // Luego mostrar otros ex√°menes del sistema original
                for (const [nombre, datos] of Object.entries(exs)) {
                    const k = (nombre||'').toLowerCase();
                    if (ya.has(k)) continue; ya.add(k);
                    const d = diasDesde(datos.fecha_examen);
                    const vigente = d <= 365;
                    const valor = (datos.valor || datos.resultado || '').toString();
                    html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} ${nombre}${valor?': '+valor:''}</div>`;
                }
                
                if (html.endsWith('line-height:1.3">')) {
                    html += `<div style="margin:1px 0;padding:2px">‚ö†Ô∏è Ex√°menes: Sin datos disponibles</div>`;
                }
                html += '</div>';

            } else if (tabId === 'screening') {
                const original = alertas && typeof alertas === 'object' ? (alertas.screening || {}) : {};
                const { sexo, edad } = getSexoEdad();
                const isF = ['f','femenino','mujer'].includes((sexo||'').toLowerCase());
                const isM = ['m','masculino','hombre','var√≥n','varon'].includes((sexo||'').toLowerCase());
                const elegible = {
                    PAP: isF && typeof edad === 'number' && edad >= 25 && edad <= 64,
                    mamografia: isF && typeof edad === 'number' && edad >= 50,
                    PSA: isM && typeof edad === 'number' && edad >= 45,
                };

                const ya = new Set();
                const rows = [];
                const addRow = (key, label, vigente, extra = '') => {
                    const k = (key||label||'').toLowerCase();
                    if (ya.has(k)) return; ya.add(k);
                    rows.push(`${iconoVigencia(!!vigente)} ${label}${extra}`);
                };

                // PAP
                const pap = original['PAP'];
                if (elegible.PAP) {
                    const d = diasDesde(pap?.fecha);
                    const vigente = d <= 1095; // 3 a√±os
                    addRow('pap', 'PAP', vigente, pap?.fecha ? ` ‚Äî √öltimo: ${pap.fecha}` : '');
                }
                // Mamograf√≠a
                const mamo = original['mamografia'] || original['mamograf√≠a'];
                if (elegible.mamografia) {
                    const d = diasDesde(mamo?.fecha);
                    const vigente = d <= 730; // 2 a√±os
                    addRow('mamografia', 'Mamograf√≠a', vigente, mamo?.fecha ? ` ‚Äî √öltimo: ${mamo.fecha}` : '');
                }
                // PSA
                const psa = original['PSA'];
                if (elegible.PSA) {
                    const d = diasDesde(psa?.fecha);
                    const vigente = d <= 365; // 1 a√±o
                    addRow('psa', 'PSA', vigente, psa?.fecha ? ` ‚Äî √öltimo: ${psa.fecha}` : '');
                }

                // Vacunas: Influenza/COVID (vigencia anual)
                try {
                    const v = vacunasData?.vacunas || null;
                    const anio = new Date().getFullYear();
                    if (v) {
                        const infSi = !!v.influenza_si, infFecha = v.influenza_fecha, infAnio = v.influenza_anio;
                        const infVig = infSi && (infAnio === anio || diasDesde(infFecha) <= 365);
                        addRow('vacuna_influenza', 'Vacuna Influenza', infVig, infFecha ? ` ‚Äî ${infFecha}` : '');
                        const cvSi = !!v.covid_si, cvFecha = v.covid_fecha, cvAnio = v.covid_anio;
                        const cvVig = cvSi && (cvAnio === anio || diasDesde(cvFecha) <= 365);
                        addRow('vacuna_covid', 'Vacuna COVID', cvVig, cvFecha ? ` ‚Äî ${cvFecha}` : '');
                    }
                } catch(_) {}

                html = '<div style="padding:5px;font-size:11px;line-height:1.3">';
                if (rows.length === 0) html += `<div style="margin:1px 0;padding:2px">‚ö†Ô∏è Screening: Sin datos o no elegible</div>`;
                else html += rows.map(r => `<div style="margin:1px 0;padding:2px">${r}</div>`).join('');
                html += '</div>';

            } else if (tabId === 'procedimientos') {
                html = '<div style="padding:5px;font-size:11px;line-height:1.3">';
                const ya = new Set();
                const proc = alertas.procedimientos || {};
                
                // Procedimientos del sistema original
                for (const [tipo, datos] of Object.entries(proc)) {
                    const k = (tipo||'').toLowerCase();
                    if (ya.has(k)) continue; ya.add(k);
                    const vigente = typeof datos.vigente === 'boolean' ? datos.vigente : (diasDesde(datos.fecha) <= 365);
                    html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} ${tipo}</div>`;
                }
                
                // Podolog√≠a desde datos consolidados de diabetes (vigencia 1 a√±o)
                try {
                    if (diabetesData?.podologia) {
                        const k = 'podologia';
                        if (!ya.has(k)) {
                            const d = diasDesde(diabetesData.podologia.fecha);
                            const vigente = d <= 365;
                            html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} Atenci√≥n Podol√≥gica ‚Äî ${diabetesData.podologia.fecha}</div>`;
                            ya.add(k);
                        }
                    }
                } catch(_) {}
                
                // Fallback: Podolog√≠a desde backend consolidado original, si no vino en datos de diabetes
                try {
                    if (alertas.podologia && !ya.has('podologia')) {
                        const vigente = diasDesde(alertas.podologia.fecha) <= 365;
                        html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} Atenci√≥n Podol√≥gica${alertas.podologia.fecha? ' ‚Äî '+alertas.podologia.fecha: ''}</div>`;
                        ya.add('podologia');
                    }
                } catch(_) {}
                
                // Adulto Mayor (‚â•65) funcionalidad/TUG (6 meses)
                try {
                    const { edad } = getSexoEdad();
                    if (amData && typeof edad === 'number' && edad >= 65) {
                        const f = amData.fecha_aplicacion;
                        const d = diasDesde(f);
                        const vig6m = d <= 180;
                        const tieneFunc = !!(amData.resultado);
                        const tieneTug = amData.tug_seg != null && amData.tug_seg !== '';
                        if (!ya.has('evaluaci√≥n funcionalidad') && tieneFunc) html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vig6m)} Evaluaci√≥n Funcionalidad${f? ' ‚Äî '+f: ''}</div>`;
                        if (!ya.has('test tug') && tieneTug) html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vig6m)} Test TUG${f? ' ‚Äî '+f: ''}</div>`;
                    }
                } catch(_) {}
                
                if (html.endsWith('line-height:1.3">')) html += `<div style="margin:1px 0;padding:2px">‚ö†Ô∏è Procedimientos: Sin datos</div>`;
                html += '</div>';

            } else if (tabId === 'tratamientos') {
                html = '<div style="padding:5px;font-size:11px;line-height:1.3">';
                const ya = new Set();
                const trats = alertas.tratamientos || {};
                for (const [tipo, datos] of Object.entries(trats)) {
                    const k = (tipo||'').toLowerCase(); if (ya.has(k)) continue; ya.add(k);
                    const vigente = typeof datos.vigente === 'boolean' ? datos.vigente : (diasDesde(datos.fecha) <= 365);
                    html += `<div style="margin:1px 0;padding:2px">${iconoVigencia(vigente)} ${tipo}</div>`;
                }
                if (ya.size === 0) html += `<div style="margin:1px 0;padding:2px">‚ö†Ô∏è Tratamientos: Sin datos</div>`;
                html += '</div>';

            } else if (tabId === 'cardiovascular') {
                html = '<div style="padding:5px;font-size:11px;line-height:1.3">';
                const rows = [];
                const ya = new Set();
                
                try {
                    // Protocolo HEARTS (vigencia 1 a√±o)
                    if (heartsData) {
                        const d = diasDesde(heartsData.fecha);
                        const vigente = d <= 365;
                        rows.push(`${iconoVigencia(vigente)} Protocolo HEARTS${heartsData.fecha? ' ‚Äî '+heartsData.fecha: ''}`);
                        ya.add('hearts');
                    }
                    
                    // RAC para HTA (vigencia 1 a√±o) - tambi√©n usado en diabetes pero se muestra en ex√°menes
                    if (diabetesData?.rac && !ya.has('rac')) {
                        const d = diasDesde(diabetesData.rac.fecha);
                        const vigente = d <= 365;
                        rows.push(`${iconoVigencia(vigente)} RAC (HTA): ${diabetesData.rac.valor} mg/g ‚Äî ${diabetesData.rac.fecha}`);
                        ya.add('rac');
                    }
                    
                } catch(_) {}
                
                if (rows.length === 0) html += `<div style="margin:1px 0;padding:2px">‚ö†Ô∏è Cardiovascular: Sin datos</div>`;
                else html += rows.map(r => `<div style="margin:1px 0;padding:2px">${r}</div>`).join('');
                html += '</div>';

            } else {
                html += `üìä ${tabId}: Sin datos disponibles`;
            }
        } catch (error) {
            console.error(`‚ùå Error procesando tab ${tabId}:`, error);
        }

        element.innerHTML = html + '</div>';
        console.log(`‚úÖ Tab ${tabId} actualizada`);
    });

    console.log('‚ö° Alertas mostradas correctamente');
}

// Funci√≥n mostrarLoadingEnTabs() definida m√°s abajo en l√≠nea 18334 (versi√≥n optimizada)

// Funci√≥n mostrarMensajeEnTabs() definida m√°s abajo en l√≠nea 18351 (versi√≥n optimizada)

// Funci√≥n mostrarErrorEnTabs() definida m√°s abajo en l√≠nea 18330 (versi√≥n optimizada)

console.log('‚úÖ Script de alertas corregido cargado');
    </script>
    
    <script src="/static/js/common.js"></script>
        <script>
        </script>
    <script>
    // ====== ADULTO MAYOR JS ======
    // Estilos m√≠nimos para feedback de validaci√≥n Adulto Mayor
    ;(function(){
    const styleId='am-validacion-styles';
    if(!document.getElementById(styleId)){
        const st=document.createElement('style');
        st.id=styleId;
        st.textContent=`#amResultado.am-error{border:2px solid #dc2626 !important; box-shadow:0 0 0 2px rgba(220,38,38,0.15);} .badge-am.vigente{background:#C6EFCE;color:#065f46;padding:2px 6px;border-radius:4px;font-size:11px;} .badge-am.expira-pronto{background:#FFEB9C;color:#92400e;padding:2px 6px;border-radius:4px;font-size:11px;} .badge-am.vencido{background:#FFC7CE;color:#7f1d1d;padding:2px 6px;border-radius:4px;font-size:11px;}`;
        document.head.appendChild(st);
    }
})();
// Eliminar inyecci√≥n previa de estilos espec√≠ficos AM
(function(){
  const STYLE_ID='adulto-mayor-styles';
  const existing=document.getElementById(STYLE_ID);
  if(existing) existing.remove();
})();

function edadDesdeFecha(fecha){
  if(!fecha) return null; const d=new Date(fecha); if(isNaN(d)) return null; const hoy=new Date(); let e=hoy.getFullYear()-d.getFullYear(); const m=hoy.getMonth()-d.getMonth(); if(m<0 || (m===0 && hoy.getDate()<d.getDate())) e--; return e; }

async function updateAdultoMayorVisibility(){
  const section=document.getElementById('adultoMayorSection'); if(!section) return;
  const fechaNacInput=document.getElementById('fecha_nacimiento');
  let edad=null; if(fechaNacInput && fechaNacInput.value){ edad=edadDesdeFecha(fechaNacInput.value); }
        if(edad!==null && edad>=60){
        section.style.display='';
        document.getElementById('adultoMayorEdadInfo').textContent='Edad: '+edad+' a√±os';
        // Restringir opciones de funcionalidad seg√∫n edad: 60‚Äì64 solo "Autovalente"; >=65 todas
        try{
            const sel=document.getElementById('amResultado');
            if(sel){
                const opts=[...sel.options];
                const allowAll = !(edad>=60 && edad<=64);
                opts.forEach(o=>{
                    if(!o.value) return; // placeholder
                    const val=o.textContent.trim().toLowerCase();
                    const esAutovalente=(val==='autovalente');
                    const permitido = allowAll ? ['autovalente','autovalente con riesgo','riesgo de dependencia'].includes(val) : esAutovalente;
                    o.disabled = !permitido;
                });
                // Si el valor actual deja de ser permitido, forzamos a vac√≠o o "Autovalente"
                const curVal=(sel.value||'').trim().toLowerCase();
                const curPermitido = (allowAll ? ['autovalente','autovalente con riesgo','riesgo de dependencia'].includes(curVal) : curVal==='autovalente');
                if(!curPermitido){ sel.value = allowAll ? '' : 'Autovalente'; }
            }
        }catch(e){ console.warn('Restricci√≥n AM resultado por edad fall√≥', e); }
        // Cargar √∫ltimos datos
        cargarUltimaAdultoMayor();
        cargarAmMaltratoUltimo();
        cargarAmMaltratoHistorial();
    } else {
        section.style.display='none';
    }
}

function clasificarTug(seg){
    if (seg == null || seg === '') return '';
    const v = parseFloat(seg);
    if (isNaN(v)) return '';
    if (v <= 10) return 'Normal';
    if (v < 20) return 'Leve';
    return 'Alto';
}
// === Clasificaci√≥n TUG en vivo ===
function actualizarTugLive(){
  const inp=document.getElementById('amTugSeg');
  const chip=document.getElementById('amTugClasChip');
  const box=document.getElementById('amTugResBox');
  const txt=document.getElementById('amTugResTexto');
  if(!inp||!chip) return;
  const v=inp.value;
  const c=clasificarTug(v);
  if(!c){
    chip.style.display='none'; chip.className='imc-chip'; chip.textContent='';
    if(box&&txt){ box.style.display='none'; txt.textContent=''; }
    return;
  }
  const color = c==='Normal'? 'imc-verde' : c==='Leve'? 'imc-amarillo' : 'imc-rojo';
  chip.className='imc-chip '+color;
  chip.textContent=c;
  chip.style.display='inline-flex';
  if(box&&txt){
    txt.textContent = `${Number(v)} seg (${c})`;
    box.style.display='block';
  }
}
function wireTugLive(){
  const i=document.getElementById('amTugSeg');
  if(i){ i.addEventListener('input', actualizarTugLive); i.addEventListener('change', actualizarTugLive); }
  actualizarTugLive();
}
function clasificarUnipodal(d,i){ if(d==null||i==null||d===''||i==='') return ''; const vd=parseFloat(d), vi=parseFloat(i); if(isNaN(vd)||isNaN(vi)) return ''; if(vd>=5 && vi>=5) return 'Normal'; return 'Alterado'; }

function derivacionSugerida(tugClas, unipClas){
    if (!tugClas || !unipClas) return '';
    if (tugClas !== 'Normal' && unipClas === 'Alterado') return 'Derivar a m√©dico y a MASAMA';
    return '';
}

// (El resto del c√≥digo Adulto Mayor contin√∫a...)
</script>
<script>
// ===== Encapsulado: funciones Adulto Mayor (reubicadas) =====
async function evaluarAdultoMayor(){
  const runInput=document.querySelector('input[name="run"]'); if(!runInput||!runInput.value.trim()){ alert('Ingrese RUN antes de evaluar'); return; }
    const fechaAp=(document.getElementById('amFechaAplicacion')?.value||'').trim();
    if(!fechaAp){ alert('Ingrese fecha de aplicaci√≥n'); const el=document.getElementById('amFechaAplicacion'); if(el){ el.focus(); } return; }
  const resultado=document.getElementById('amResultado').value;
    const masamaFecha = (document.getElementById('amMasamaFecha')?.value || '').trim();
    // Validaci√≥n obligatoria de resultado
    const resultadoSelect=document.getElementById('amResultado');
    // Eliminar estados previos
    resultadoSelect.classList.remove('am-error');
    const msgId='amResultadoMsgReq';
    const prevMsg=document.getElementById(msgId); if(prevMsg) prevMsg.remove();
    if(!resultado){
        // Marcar visualmente y mostrar mensaje
        resultadoSelect.classList.add('am-error');
        const m=document.createElement('div');
        m.id=msgId; m.style.color='#dc2626'; m.style.fontSize='12px'; m.style.marginTop='4px';
        m.textContent='Seleccione un resultado antes de guardar';
        resultadoSelect.parentElement.appendChild(m);
        resultadoSelect.focus();
        return; // Bloquear flujo hasta que seleccione
    }
        const pruebasNc = !!document.getElementById('amPruebasNc')?.checked;
        let tugSeg=document.getElementById('amTugSeg').value;
    let unipDer=document.getElementById('amUnipDer').value;
    let unipIzq=document.getElementById('amUnipIzq').value;
  const observ=document.getElementById('amObservaciones').value;
        // Aplicar "No corresponde"
        let tugClas = pruebasNc ? 'No corresponde' : clasificarTug(tugSeg);
        if (pruebasNc) { tugSeg=''; }
        let unipClas = pruebasNc ? 'No corresponde' : clasificarUnipodal(unipDer, unipIzq);
        if (pruebasNc) { unipDer=''; unipIzq=''; }
  const deriv=derivacionSugerida(tugClas, unipClas);
  const vigenciaHasta = (()=>{ const d=new Date(fechaAp+'T00:00:00'); d.setFullYear(d.getFullYear()+1); return d.toISOString().slice(0,10); })();
  const hoy=new Date(); hoy.setHours(0,0,0,0);
  const vigDate=new Date(vigenciaHasta+'T00:00:00');
  const diffDays=Math.round((vigDate.getTime()-hoy.getTime())/86400000);
  const resumen=document.getElementById('adultoMayorResultado');
  // Refrescar bloque TUG en vivo por si no hubo evento input
  if (typeof actualizarTugLive === 'function') { try { actualizarTugLive(); } catch(e){} }
    let estadoVig='vigente'; if(diffDays<0) estadoVig='vencido'; else if(diffDays<=30) estadoVig='expira-pronto';
    let badge=`<span class="badge-am ${estadoVig}">${estadoVig.replace('-', ' ')}</span>`;
    const tugResumen = tugClas==='No corresponde' ? 'No corresponde' : `${tugSeg||'-'} (${tugClas||''})`;
    const unipResumen = unipClas==='No corresponde' ? 'No corresponde' : `${unipDer||'-'}/${unipIzq||'-'} (${unipClas||''})`;
        resumen.innerHTML = `<strong>Resultado:</strong> ${resultado||'-'} | <strong>TUG:</strong> ${tugResumen} | <strong>Unipodal:</strong> ${unipResumen} | <strong>Vigencia hasta:</strong> ${vigenciaHasta} (${diffDays<0? 'Vencido hace '+Math.abs(diffDays)+'d': diffDays===0? 'Hoy': 'en '+diffDays+'d'}) ${deriv? ' | <strong>Derivaci√≥n:</strong> '+deriv: ''} ${masamaFecha? ' | <strong>MASAMA:</strong> '+masamaFecha: ''} ${observ? '<br><em>'+observ.replace(/</g,'&lt;')+'</em>':''} <br>${badge}`;
  resumen.style.display='block';
  updateAdultoMayorSummary(estadoVig, vigenciaHasta, diffDays, resultado);
  await guardarAdultoMayor({
    run: runInput.value.trim(),
    fecha_aplicacion: fechaAp,
    resultado: resultado,
        masama_checklist_fecha: masamaFecha || null,
    tug_seg: tugSeg||null,
    tug_clasificacion: tugClas||null,
    unipodal_seg_pie_der: unipDer||null,
    unipodal_seg_pie_izq: unipIzq||null,
    unipodal_clasificacion: unipClas||null,
    derivacion: deriv||null,
    observaciones: observ||null
  });
}

let _amUltimoPayload=null; // snapshot √∫ltimo guardado para evitar POST redundante
async function guardarAdultoMayor(payload){
  const status=document.getElementById('adultoMayorStatus');
  // Comparar con snapshot (ignoramos creado_en / id que no est√°n en payload)
  if(_amUltimoPayload){
    let igual=true; const keys=Object.keys(payload);
    for(const k of keys){ if(String(payload[k]||'')!==String(_amUltimoPayload[k]||'')){ igual=false; break; } }
    if(igual){ status.textContent='Sin cambios'; return; }
  }
  status.textContent='Guardando...';
  try{
    const resp = await fetch('/api/examenes/adulto_mayor',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    const data = await resp.json();
            // Inicializar estado flotante (colapsado / expandido)
            try {
                const _prefColapIni = localStorage.getItem('flotante_patologias_colapsado');
                const colapsado = (_prefColapIni === null) ? true : (_prefColapIni === '1');
                const toggle = document.getElementById('toggle-flotante');
                const btn = document.getElementById('btn-guardar-patologias-flotante');
                if (toggle && btn) {
                    if (colapsado) { btn.style.display='none'; toggle.textContent='+'; toggle.title='Expandir'; toggle.setAttribute('aria-label','Expandir panel flotante'); }
                    toggle.addEventListener('click', ()=>{
                        const currentlyHidden = btn.style.display==='none';
                        if (currentlyHidden) {
                            btn.style.display='flex';
                            toggle.textContent='‚àí';
                            toggle.title='Contraer';
                            toggle.setAttribute('aria-label','Contraer panel flotante');
                            localStorage.setItem('flotante_patologias_colapsado','0');
                        } else {
                            btn.style.display='none';
                            toggle.textContent='+';
                            toggle.title='Expandir';
                            toggle.setAttribute('aria-label','Expandir panel flotante');
                            localStorage.setItem('flotante_patologias_colapsado','1');
                        }
                    });
                }
            } catch(eToggle) { console.warn('No se pudo inicializar toggle flotante', eToggle); }
    if(data.success){ status.textContent='Guardado (ID '+data.id+')'; _amUltimoPayload={...payload}; cargarUltimaAdultoMayor(); } else { status.textContent='Error: '+(data.error||''); }
  }catch(e){ status.textContent='Error red: '+e; }
}
async function cargarUltimaAdultoMayor(){
  const runInput=document.querySelector('input[name="run"]'); if(!runInput||!runInput.value.trim()) return;
  try{
    const runRaw=runInput.value.replace(/[^0-9kK]/g,'');
    const resp=await fetch('/api/examenes/adulto_mayor/'+runRaw);
    const data=await resp.json();
    if(!data.success || !data.found){ return; }
    const d=data.data;
    // Prellenar
    document.getElementById('amFechaAplicacion').value = d.fecha_aplicacion || '';
    document.getElementById('amResultado').value = d.resultado || '';
        const amMasama=document.getElementById('amMasamaFecha'); if(amMasama){ amMasama.value = (d.masama_checklist_fecha||'').slice(0,10); }
    const tugNc = (d.tug_clasificacion === 'No corresponde');
    const unipNc = (d.unipodal_clasificacion === 'No corresponde');
    document.getElementById('amTugSeg').value = tugNc ? '' : (d.tug_seg || '');
    document.getElementById('amUnipDer').value = unipNc ? '' : (d.unipodal_seg_pie_der || '');
    document.getElementById('amUnipIzq').value = unipNc ? '' : (d.unipodal_seg_pie_izq || '');
    const pruebasNcEl=document.getElementById('amPruebasNc'); if(pruebasNcEl){ pruebasNcEl.checked = (d.tug_clasificacion==='No corresponde' && d.unipodal_clasificacion==='No corresponde'); }
    const disabled = !!pruebasNcEl?.checked;
    document.getElementById('amTugSeg').disabled = disabled;
    document.getElementById('amUnipDer').disabled = disabled;
    document.getElementById('amUnipIzq').disabled = disabled;
    document.getElementById('amObservaciones').value = d.observaciones || '';
    // Render resumen existente
    const hoy=new Date(); hoy.setHours(0,0,0,0);
    const vigDate=new Date(d.vigencia_hasta+'T00:00:00');
    const diffDays=Math.round((vigDate.getTime()-hoy.getTime())/86400000);
    let estadoVig='vigente'; if(diffDays<0) estadoVig='vencido'; else if(diffDays<=30) estadoVig='expira-pronto';
    const resBox=document.getElementById('adultoMayorResultado');
    resBox.style.display='block';
    const tugResumen = d.tug_clasificacion==='No corresponde' ? 'No corresponde' : `${(d.tug_seg||'-')} (${d.tug_clasificacion||''})`;
        const unipResumen = d.unipodal_clasificacion==='No corresponde' ? 'No corresponde' : `${(d.unipodal_seg_pie_der||'-')+'/'+(d.unipodal_seg_pie_izq||'-')} (${d.unipodal_clasificacion||''})`;
    resBox.innerHTML = `<strong>Resultado:</strong> ${d.resultado} | <strong>TUG:</strong> ${tugResumen} | <strong>Unipodal:</strong> ${unipResumen} | <strong>Vigencia hasta:</strong> ${d.vigencia_hasta} (${diffDays<0? 'Vencido hace '+Math.abs(diffDays)+'d': diffDays===0? 'Hoy': 'en '+diffDays+'d'}) ${(d.derivacion? ' | <strong>Derivaci√≥n:</strong> '+d.derivacion:'')} ${(d.masama_checklist_fecha? ' | <strong>MASAMA:</strong> '+String(d.masama_checklist_fecha).slice(0,10):'')} ${(d.observaciones? '<br><em>'+d.observaciones.replace(/</g,'&lt;')+'</em>':'')} <br><span class="badge-am ${estadoVig}">${estadoVig}</span>`;
        // Bloqueo anual en UI: si hay registro del a√±o actual, deshabilitar formulario
        try{
            const apYear = new Date((d.fecha_aplicacion||'')+"T00:00:00").getFullYear();
            const nowYear = new Date().getFullYear();
            const form = document.getElementById('evaluacionAdultoMayorForm');
            if(form){
                const lock = (apYear===nowYear);
                const inputs = form.querySelectorAll('input, select, button');
                inputs.forEach(el=>{ if(el.id!=='amFechaAplicacion' && el.type!=='button') el.disabled = lock; });
                const status=document.getElementById('adultoMayorStatus');
                if(lock){ status.textContent = `üîí Registro anual ${nowYear} ya realizado. Bloqueado hasta el pr√≥ximo a√±o.`; }
                else { if(status.textContent.startsWith('üîí')) status.textContent=''; }
            }
        }catch(_e){}
    updateAdultoMayorSummary(estadoVig, d.vigencia_hasta, diffDays, d.resultado);
  }catch(e){ /* noop */ }
  cargarHistorialAdultoMayor();
}

async function cargarHistorialAdultoMayor(){
  const body=document.getElementById('adultoMayorHistorialBody'); const cont=document.getElementById('adultoMayorHistorial');
  const runInput=document.querySelector('input[name="run"]'); if(!runInput||!runInput.value.trim()){ cont.style.display='none'; return; }
  try{
    const runRaw=runInput.value.replace(/[^0-9kK]/g,'');
    // Nuevo endpoint historial m√∫ltiple
    const resp=await fetch('/api/examenes/adulto_mayor/historial/'+runRaw);
    const data=await resp.json();
    if(!data.success || !data.count){ cont.style.display='none'; return; }
    cont.style.display='block';
    body.innerHTML = data.data.map(d=>{
            return `<tr>`+
        `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.fecha_aplicacion}</td>`+
        `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.resultado}</td>`+
                `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.tug_clasificacion==='No corresponde' ? 'No corresponde' : ((d.tug_seg||'') + (d.tug_clasificacion? ' ('+d.tug_clasificacion+')':''))}</td>`+
                `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.unipodal_clasificacion==='No corresponde' ? 'No corresponde' : ((d.unipodal_seg_pie_der||'-')+'/'+(d.unipodal_seg_pie_izq||'-') + (d.unipodal_clasificacion? ' ('+d.unipodal_clasificacion+')':''))}</td>`+
        `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.vigencia_hasta}</td>`+
    `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${(d.creado_en||'').replace('T',' ').slice(0,10)}</td>`+
        `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${d.id}</td>`+
      `</tr>`;
    }).join('');
  }catch(e){ cont.style.display='none'; }
}

function updateAdultoMayorSummary(estado, vigenciaHasta, diffDays, resultado){
  const span=document.getElementById('adultoMayorSummary'); if(!span) return;
  span.className='badge-am '+(estado||'');
  span.textContent = (resultado? resultado+' ‚Ä¢ ':'') + (vigenciaHasta||'') + (diffDays!=null? (diffDays<0? ' ‚Ä¢ vencido': diffDays===0? ' ‚Ä¢ hoy': ' ‚Ä¢ '+diffDays+'d'):'');
  span.style.display='inline-flex';
  if(estado==='vencido') span.classList.add('am-overdue'); else if(diffDays===0) span.classList.add('am-due-today');
}

// ====== AM: Sospecha de maltrato (endpoints nuevos) ======
async function guardarAmMaltrato(){
    const runInput=document.querySelector('input[name="run"]');
    if(!runInput||!runInput.value.trim()){ alert('Ingrese RUN'); return; }
    const fecha=(document.getElementById('amMaltratoFecha')?.value)||'';
    const enSel=(document.getElementById('amMaltratoEn')?.value)||'';
    const st=document.getElementById('amMaltratoStatus');
    if(!fecha || !enSel){ st.textContent='Seleccione fecha y opci√≥n'; return; }
    const payload={ run: runInput.value.trim(), fecha, en_sospecha: (enSel==='si') };
    st.textContent='Guardando...';
    try{
        const resp=await fetch('/api/adulto_mayor/maltrato',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        const j=await resp.json();
        if(j.success){ st.textContent='Guardado (ID '+j.id+')'; cargarAmMaltratoUltimo(); cargarAmMaltratoHistorial(); }
        else{ st.textContent='Error: '+(j.error||''); }
    }catch(e){ st.textContent='Error red: '+e; }
}

async function cargarAmMaltratoUltimo(){
    const runInput=document.querySelector('input[name="run"]'); if(!runInput||!runInput.value.trim()) return;
    const box=document.getElementById('amMaltratoUltimo'); if(!box) return;
    try{
        const runRaw=runInput.value.replace(/[^0-9kK]/g,'');
        const resp=await fetch('/api/adulto_mayor/maltrato/'+runRaw);
        const j=await resp.json();
        const fechaEl=document.getElementById('amMaltratoFecha'); const selEl=document.getElementById('amMaltratoEn'); const btnGuardar=document.getElementById('amMaltratoGuardarBtn'); const btnNuevo=document.getElementById('amMaltratoNuevoBtn'); const st=document.getElementById('amMaltratoStatus');
        if(!j.success || !j.found){ box.style.display='none'; if(btnNuevo) btnNuevo.style.display='none'; if(btnGuardar) btnGuardar.disabled=false; if(fechaEl) fechaEl.disabled=false; if(selEl) selEl.disabled=false; return; }
        const d=j.data; const v=d.en_sospecha? 'S√≠':'No';
    box.innerHTML=`<strong>√öltimo:</strong> ${d.fecha||''} ‚Ä¢ Sospecha: <strong>${v}</strong> ‚Ä¢ ${(d.creado_en||'').replace('T',' ').slice(0,10)} ‚Ä¢ ID ${d.id}`;
        box.style.display='block';
        const y=(new Date()).getFullYear(); const dy=new Date(String(d.fecha||'')+"T00:00:00").getFullYear(); const lock=(y===dy);
        if(lock){ if(st) st.textContent=`üîí Registro anual ${y} ya realizado. Bloqueado hasta el pr√≥ximo a√±o.`; if(fechaEl) fechaEl.disabled=true; if(selEl) selEl.disabled=true; if(btnGuardar) btnGuardar.disabled=true; if(btnNuevo) btnNuevo.style.display='inline-flex'; }
        else { if(st && st.textContent.startsWith('üîí')) st.textContent=''; if(fechaEl) fechaEl.disabled=false; if(selEl) selEl.disabled=false; if(btnGuardar) btnGuardar.disabled=false; if(btnNuevo) btnNuevo.style.display='none'; }
    }catch(e){ box.style.display='none'; }
}
function iniciarNuevoAmMaltrato(){
    if(!confirm('‚ö†Ô∏è ¬øConfirma crear una nueva evaluaci√≥n de maltrato? El registro actual se mover√° al hist√≥rico.')) return;
    const fechaEl=document.getElementById('amMaltratoFecha'); const selEl=document.getElementById('amMaltratoEn'); const btnGuardar=document.getElementById('amMaltratoGuardarBtn'); const btnNuevo=document.getElementById('amMaltratoNuevoBtn'); 
    if(fechaEl){ fechaEl.disabled=false; fechaEl.value=''; } 
    if(selEl){ selEl.disabled=false; selEl.value=''; } 
    if(btnGuardar) btnGuardar.disabled=false; 
    if(btnNuevo) btnNuevo.style.display='none'; 
    const st=document.getElementById('amMaltratoStatus'); 
    if(st) st.textContent='üìù Listo para nueva evaluaci√≥n. El registro anterior se guardar√° en el hist√≥rico al guardar.';
}

async function cargarAmMaltratoHistorial(){
    const body=document.getElementById('amMaltratoHistBody'); const cont=document.getElementById('amMaltratoHist');
    const runInput=document.querySelector('input[name="run"]'); if(!runInput||!runInput.value.trim()){ if(cont) cont.style.display='none'; return; }
    try{
        const runRaw=runInput.value.replace(/[^0-9kK]/g,'');
        const resp=await fetch('/api/adulto_mayor/maltrato/historial/'+runRaw);
        const j=await resp.json();
        if(!j.success || !j.count){ if(cont) cont.style.display='none'; return; }
        if(cont) cont.style.display='block';
        if(body){ body.innerHTML = j.data.map(r=>{
            return `<tr>`+
                `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${r.fecha||''}</td>`+
                `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${r.en_sospecha? 'S√≠':'No'}</td>`+
                `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${(r.creado_en||'').replace('T',' ').slice(0,10)}</td>`+
                `<td style='padding:4px 6px; border:1px solid #e2e8f0;'>${r.id}</td>`+
            `</tr>`;
        }).join(''); }
    }catch(e){ if(cont) cont.style.display='none'; }
}

document.addEventListener('DOMContentLoaded', ()=>{
    // Adulto Mayor: no autocompletar fechas por defecto; el usuario debe ingresarlas
    updateAdultoMayorVisibility();
    // Inicializar c√°lculo IMC en vivo por si ya hay valores cargados manualmente
    if (typeof wireIMCLive === 'function') { wireIMCLive(); }
  const fechaNacInput=document.getElementById('fecha_nacimiento'); if(fechaNacInput){ fechaNacInput.addEventListener('change', updateAdultoMayorVisibility); }
    // Event listener de RUN consolidado - se elimina duplicado
    // Listeners: No corresponde toggles
    const pruebasNcToggle=document.getElementById('amPruebasNc');
    if(pruebasNcToggle){
        pruebasNcToggle.addEventListener('change',()=>{
            const dis=pruebasNcToggle.checked;
            const t=document.getElementById('amTugSeg'); const d=document.getElementById('amUnipDer'); const i=document.getElementById('amUnipIzq');
            if(t){ t.disabled=dis; if(dis){ t.value=''; }}
            if(d){ d.disabled=dis; if(dis){ d.value=''; }}
            if(i){ i.disabled=dis; if(dis){ i.value=''; }}
            const obs=document.getElementById('amObservaciones');
            const marca='Motivo: Pruebas funcionales no corresponden (postrado/silla de ruedas).';
            if(obs){
                if(dis){ if(!obs.value || obs.value.trim()===''){ obs.value = marca; } }
                else{ if(obs.value.trim()===marca){ obs.value=''; } }
            }
        });
    }
});

// ========= C√ÅLCULO DE RIESGO ECICEP (por FAMILIA, solo 1 y 2 pts) =========
function calcularRiesgo() {
    // En modo Cardio no se calcula riesgo ni se actualiza la UI del cuadro
    if (window.__BYPASS_RIESGO__ === true) {
        try {
            const mini = document.getElementById('categoria-riesgo-mini');
            const full = document.getElementById('categoria-riesgo');
            const puntos = document.getElementById('total-puntos');
            if (mini) mini.textContent = '‚Äî';
            if (full) full.textContent = '‚Äî';
            if (puntos) puntos.textContent = '0';
        } catch(_){ }
        return;
    }
  let total = 0;
  document.querySelectorAll('.familia').forEach(fam => {
    const pts = parseInt(fam.getAttribute('data-points'), 10);
    if (pts === 1 || pts === 2) {
      const tieneSeleccion = !!fam.querySelector('.familia-content input[type="checkbox"]:checked');
      if (tieneSeleccion) total += pts;
    }
  });
  const totalEl = document.getElementById('total-puntos');
  if (totalEl) totalEl.textContent = String(total);
  let categoria = 'G0';
  let bg = '#e9ecef';
  let fg = '#000';
  if (total === 1) { categoria = 'G1'; bg = '#198754'; fg = '#fff'; }
  else if (total >= 2 && total <= 4) { categoria = 'G2'; bg = '#ffc107'; fg = '#000'; }
  else if (total >= 5) { categoria = 'G3'; bg = '#dc3545'; fg = '#fff'; }
  const catEl = document.getElementById('categoria-riesgo');
  if (catEl) {
    catEl.textContent = categoria;
    catEl.style.backgroundColor = bg;
    catEl.style.color = fg;
  }
  
  // Actualizar tambi√©n la vista colapsada si est√° visible
  const categoriaMini = document.getElementById('categoria-riesgo-mini');
  if (categoriaMini) {
    categoriaMini.textContent = categoria;
    categoriaMini.style.backgroundColor = bg;
    categoriaMini.style.color = fg;
  }
  
  // Actualizar autom√°ticamente la categor√≠a del select cuando se calcule el riesgo
  // Pero solo si el usuario no est√° editando manualmente
  if (!window.usuarioEditandoCategoria) {
    actualizarCategoriaAutomatica();
  }
}

// Funci√≥n para colapsar/expandir el cuadro de riesgo flotante
function toggleCuadroRiesgo() {
    // Marcar que hubo interacci√≥n expl√≠cita del usuario
    try { window._riesgoUserInteracted = true; } catch(_) {}
  const contenido = document.getElementById('contenido-cuadro-riesgo');
  const vistaColapsada = document.getElementById('vista-colapsada-cuadro');
  const encabezadoExpandido = document.getElementById('encabezado-expandido');
  const cuadro = document.getElementById('cuadro-riesgo-flotante');
  
  if (!contenido || !vistaColapsada || !encabezadoExpandido) return;
  
  const estaColapsado = contenido.style.display === 'none';
  
  if (estaColapsado) {
    // Expandir - mostrar vista completa
    contenido.style.display = 'block';
    encabezadoExpandido.style.display = 'flex';
    vistaColapsada.style.display = 'none';
    
    if (cuadro) {
      cuadro.style.minWidth = '380px';
      cuadro.style.maxWidth = '450px';
      cuadro.style.padding = '20px 24px';
    }
  } else {
    // Colapsar - mostrar solo categor√≠a + bot√≥n
    contenido.style.display = 'none';
    encabezadoExpandido.style.display = 'none';
    vistaColapsada.style.display = 'flex';
    
    if (cuadro) {
      cuadro.style.minWidth = 'auto';
      cuadro.style.maxWidth = '140px';
      cuadro.style.padding = '8px 12px';
    }
    
    // Sincronizar la categor√≠a en la vista colapsada
    const categoriaRiesgo = document.getElementById('categoria-riesgo');
    const categoriaMini = document.getElementById('categoria-riesgo-mini');
    if (categoriaRiesgo && categoriaMini) {
      const categoria = categoriaRiesgo.textContent;
      const bgColor = categoriaRiesgo.style.backgroundColor;
      const color = categoriaRiesgo.style.color;
      
      categoriaMini.textContent = categoria;
      categoriaMini.style.backgroundColor = bgColor;
      categoriaMini.style.color = color;
    }
  }

    // Guardar preferencia del usuario (0=expandido, 1=colapsado)
    try {
        localStorage.setItem('cuadro_riesgo_colapsado', estaColapsado ? '0' : '1');
    } catch(e) { /* ignore */ }
}

// Funci√≥n para actualizar autom√°ticamente la categor√≠a basada en el c√°lculo de riesgo
// Variable global para controlar si mostrar notificaciones de categor√≠a
window.mostrarNotificacionesCategoria = false;

function actualizarCategoriaAutomatica() {
  console.log('üéØ [CATEGORIA AUTO] Actualizando categor√≠a autom√°ticamente');
  
  // VERIFICAR MODO: Solo actualizar categor√≠a en modo ECICEP, no en modo Cardio
  if (window.__BYPASS_RIESGO__ === true) {
    console.log('üéØ [CATEGORIA AUTO] Modo Cardio detectado - saltando actualizaci√≥n autom√°tica de categor√≠a');
    return;
  }
  
  // Obtener el total de puntos calculado
  const totalPuntos = parseInt(document.getElementById('total-puntos')?.textContent || '0', 10);
  
  // Determinar la categor√≠a seg√∫n los puntos
  // G0: 0 puntos, G1: 1 punto, G2: 2-4 puntos, G3: 5+ puntos
  let categoriaCalculada = '';
  if (totalPuntos === 0) {
    categoriaCalculada = '0';  // G0 (0 puntos)
  } else if (totalPuntos === 1) {
    categoriaCalculada = '1';  // G1 (1 punto)
  } else if (totalPuntos >= 2 && totalPuntos <= 4) {
    categoriaCalculada = '2';  // G2 (2-4 puntos)
  } else if (totalPuntos >= 5) {
    categoriaCalculada = '3';  // G3 (5+ puntos)
  }
  
  // Actualizar el select de categor√≠a solo en modo ECICEP
  const categoriaSelect = document.getElementById('categoria_id');
  if (categoriaSelect && categoriaCalculada) {
    const valorAnterior = categoriaSelect.value;
    categoriaSelect.value = categoriaCalculada;
    
    console.log(`üéØ [CATEGORIA AUTO] Puntos: ${totalPuntos}, Categor√≠a: G${categoriaCalculada}`);
    
    // Solo mostrar notificaci√≥n si:
    // 1. La categor√≠a cambi√≥
    // 2. Se permite mostrar notificaciones (no es carga inicial)
    // 3. No es transici√≥n a G0 (que significa sin patolog√≠as)
    if (valorAnterior !== categoriaCalculada && window.mostrarNotificacionesCategoria && categoriaCalculada !== '0') {
      console.log(`üìä [CATEGORIA AUTO] Categor√≠a actualizada de G${valorAnterior || '0'} a G${categoriaCalculada}`);
      
      // Mostrar notificaci√≥n visual sutil
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 180px;
        right: 24px;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        z-index: 10000;
        transform: translateX(400px);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      notification.innerHTML = `üìä Categor√≠a actualizada autom√°ticamente: <strong>G${categoriaCalculada}</strong>`;
      document.body.appendChild(notification);
      
      // Animar entrada
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      // Animar salida
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  } else if (categoriaSelect && totalPuntos === 0) {
    // Si no hay puntos, mantener la categor√≠a existente o vac√≠a
    console.log('üéØ [CATEGORIA AUTO] Sin puntos - manteniendo categor√≠a actual');
  }
}

function actualizarResumenPatologias() {
  const container = document.getElementById('patologias-badges');
  if (!container) return;
  const checkboxes = document.querySelectorAll('input[name="patologia[]"]:checked, input.patologia-checkbox:checked');
  container.innerHTML = '';
  if (checkboxes.length === 0) {
    container.innerHTML = '<span class="pat-empty">Sin patolog√≠as seleccionadas</span>';
    return;
  }

  // Agrupar por familia y categor√≠a
  const familias = {};
  checkboxes.forEach(cb => {
    // Buscar el contenedor .familia m√°s cercano
    const familiaDiv = cb.closest('.familia');
    if (!familiaDiv) return;
    const familiaId = familiaDiv.getAttribute('data-familia-id') || 'sin-familia';
    // Personalizaci√≥n para insuficiencia card√≠aca
    let familiaNombre = familiaDiv.querySelector('.familia-header')?.childNodes[1]?.textContent?.trim() || 'Sin familia';
    let familiaIcono = '';
    if (familiaId === 'fam-ic') {
      familiaNombre = '‚ù§Ô∏è‚Äçü©π INSUFICIENCIA CARDIACA';
      familiaIcono = '‚ù§Ô∏è‚Äçü©π';
    }
    // Buscar la categor√≠a (padre de familia)
    const categoriaDiv = familiaDiv.closest('.categoria-seccion');
    const categoriaNombre = categoriaDiv ? categoriaDiv.querySelector('h4')?.textContent?.trim() : 'Sin categor√≠a';
    const categoriaIcono = categoriaDiv ? categoriaDiv.querySelector('h4')?.innerHTML?.split(' ')[0] : '';
    if (!familias[familiaId]) {
      familias[familiaId] = {
        nombre: familiaNombre,
        icono: familiaIcono,
        categoria: categoriaNombre,
        categoriaIcono: categoriaIcono,
        patologias: []
      };
    }
    const label = cb.parentElement.textContent.trim();
    familias[familiaId].patologias.push({
      label: label,
      checked: cb.checked,
      id: cb.id
    });
  });

  // Agrupar familias por categor√≠a
  const categorias = {};
  Object.values(familias).forEach(fam => {
    if (!categorias[fam.categoria]) {
      categorias[fam.categoria] = {
        icono: fam.icono,
        familias: []
      };
    }
    categorias[fam.categoria].familias.push(fam);
  });

  // Renderizar agrupado
  Object.entries(categorias).forEach(([catNombre, catData]) => {
    const catDiv = document.createElement('div');
    catDiv.className = 'resumen-categoria';
    catDiv.innerHTML = `<strong>${catData.icono ? catData.icono + ' ' : ''}${catNombre}</strong>`;
    catData.familias.forEach(fam => {
      const famDiv = document.createElement('div');
      famDiv.className = 'resumen-familia';
      // Si es insuficiencia cardiaca, mostrar icono especial
      if (fam.icono) {
        famDiv.innerHTML = `<span style=\"font-weight:600; color:#0d6efd;\">${fam.icono} ${fam.nombre}</span>`;
      } else {
        famDiv.innerHTML = `<span style=\"font-weight:600; color:#0d6efd;\">${fam.nombre}</span>`;
      }
      fam.patologias.forEach(pat => {
        const patDiv = document.createElement('div');
        patDiv.className = 'resumen-patologia';
        patDiv.innerHTML = `<input type=\"checkbox\" checked disabled> <span>${pat.label}</span>`;
        famDiv.appendChild(patDiv);
      });
      catDiv.appendChild(famDiv);
    });
    container.appendChild(catDiv);
  });

  // Habilitar solo si hay alguna patolog√≠a relacionada con diabetes
  try {
    const hbaInput = document.querySelector('input[name="hba1c"]');
    if (hbaInput) {
      const hasDiabetes = Array.from(checkboxes).some(cb => cb.parentElement.textContent.toLowerCase().includes('diabet'));
      hbaInput.disabled = !hasDiabetes;
    }
  } catch (e) {}
}


// COMENTADO: Ya se maneja en DOMContentLoaded principal
/*
// Mostrar todas las familias contra√≠das por defecto al cargar

// Mostrar todas las familias y categor√≠as contra√≠das por defecto al cargar
document.addEventListener('DOMContentLoaded', () => {
  // Debug: contar cu√°ntas categor√≠as hay
  const categorias = document.querySelectorAll('.categoria-seccion');
  console.log('üîç Total de categor√≠as encontradas:', categorias.length);
  categorias.forEach((cat, index) => {
    console.log(`üìÅ Categor√≠a ${index + 1}:`, cat.id, cat.style.display);
  });
  
  document.querySelectorAll('.categoria-content').forEach(cat => cat.classList.add('collapsed'));
  document.querySelectorAll('.familia-content').forEach(fam => fam.classList.add('collapsed'));
  document.querySelectorAll('.categoria-toggle').forEach(b => b.textContent = '+');
  document.querySelectorAll('.familia-toggle').forEach(b => b.textContent = '+');
  
  // Agregar listeners para actualizar resumen de patolog√≠as
  document.querySelectorAll('.familia input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', () => {
      calcularRiesgo();
      actualizarResumenPatologias();
    });
  });
  
  calcularRiesgo();
  actualizarResumenPatologias();
});
*/
</script>

<!-- SCRIPT SIMPLIFICADO PARA RUN - TIENE PRIORIDAD -->
<script>
console.log('üîß Script simplificado cargando...');

// TEST: Verificar que JavaScript funciona
console.log('‚úÖ JavaScript est√° funcionando correctamente');

// Funci√≥n que se ejecuta inmediatamente cuando el DOM est√° listo
document.addEventListener('DOMContentLoaded', function() {
    // === Prechequeo de patolog√≠as existentes al cargar un RUN ===
    async function prechequearPatologias(runNormalizado){
        try {
            if(!runNormalizado) return;
            const resp = await fetch(`/api/usuario/${encodeURIComponent(runNormalizado)}/patologias`);
            if(!resp.ok) return;
            const data = await resp.json();
            if(!data || !data.success || !Array.isArray(data.patologias)) return;
            const patologiasExistentes = data.patologias.map(p=> (p.cie10 || '').toUpperCase()).filter(Boolean);
            if(patologiasExistentes.length===0) return;
            // Marcar checkboxes cuyo value coincida (value tiene c√≥digos CIE10 en esta versi√≥n)
            const allCheckboxes = document.querySelectorAll('input.patologia-checkbox[name="patologia[]"], input.patologia-checkbox[name="patologias"]');
            let marcadas = 0;
            allCheckboxes.forEach(cb => {
                const val = (cb.value || '').toUpperCase();
                if(patologiasExistentes.includes(val)){
                    cb.checked = true;
                    marcadas++;
                }
            });
            // Recalcular riesgo y resumen si funciones disponibles
            try { if(typeof calcularRiesgo==='function') calcularRiesgo(); } catch(_){ }
            try { if(typeof actualizarResumenPatologias==='function') actualizarResumenPatologias(); } catch(_){ }
            console.log(`‚úÖ Prechequeo: marcadas ${marcadas} patolog√≠as existentes de ${patologiasExistentes.length}`);
        } catch(e){
            console.warn('No se pudo prechequear patolog√≠as:', e);
        }
    }

    // Hook a la acci√≥n de b√∫squeda de usuario si existe el bot√≥n
    const btnBuscar = document.getElementById('btn-buscar');
    if(btnBuscar){
        btnBuscar.addEventListener('click', () => {
            const runInput = document.getElementById('run');
            if(!runInput) return;
            const runVal = runInput.value.trim();
            if(runVal){
                // Normalizaci√≥n ligera para coincidencia (remover puntos, may√∫sculas)
                const runLite = runVal.toUpperCase();
                setTimeout(()=> prechequearPatologias(runLite), 600); // leve delay tras carga de info
            }
        });
    }

    // Si el RUN ya viene precargado (edici√≥n), intentar prechequear autom√°ticamente
    const runInicial = document.getElementById('run')?.value?.trim();
    if(runInicial){
        setTimeout(()=> prechequearPatologias(runInicial.toUpperCase()), 800);
    }
    // === Mutual exclusi√≥n para subtipos I64 (ACV) ===
    (function configurarSubtiposI64(){
        const ids = ['I64H','I64I','I64N'];
        const elementos = ids.map(id => document.getElementById(id)).filter(Boolean);
        if (elementos.length === 0) return; // No existe el bloque
        function onChange(e){
            if (!e.target.checked) return;
            elementos.forEach(cb => { if (cb !== e.target) cb.checked = false; });
            // Forzar actualizaci√≥n de riesgo y resumen si existen funciones
            try { if (typeof calcularRiesgo === 'function') calcularRiesgo(); } catch(_){}
            try { if (typeof actualizarResumenPatologias === 'function') actualizarResumenPatologias(); } catch(_){}
        }
        elementos.forEach(cb => cb.addEventListener('change', onChange));
    })();
    console.log('üöÄ DOM listo, configurando RUN...');
    
    const runInput = document.getElementById('run');
    console.log('üìç Buscando campo RUN...', runInput);
    
    if (!runInput) {
        console.error('‚ùå Campo RUN no encontrado');
        return;
    }
    
    console.log('‚úÖ Campo RUN encontrado, ID:', runInput.id);
    
    let timeoutBusqueda;
    // Estado para auto-limpiar cuando se ingresa un nuevo RUN
    let prevRunClean = '';
    let loadedRunClean = '';
    let formClearedForTyping = false;
    
    // Funciones delegadas a Common para unificar l√≥gica
    function formatearRUN(input) {
        if (!input) return;
        const val = input.value || '';
        if (window.Common && typeof window.Common.formatearRUN === 'function') {
            input.value = window.Common.formatearRUN(val);
        } else {
            // Fallback m√≠nimo si no carg√≥ el m√≥dulo
            input.value = val.replace(/\./g, '').toUpperCase();
        }
    }

    function validarRUN(run) {
        try {
            return !!(window.Common && typeof window.Common.validarRUN === 'function' ? window.Common.validarRUN(run) : false);
        } catch (_) { return false; }
    }
    
    console.log('‚úÖ CONFIGURACI√ìN COMPLETA - RUN listo para usar');
});

// TEST: Verificar que el script lleg√≥ al final
console.log('üèÅ Script completamente cargado');

// Funci√≥n para guardar acuerdos independientemente
function guardarAcuerdosIndependiente() {
    console.log('üíæ Guardando acuerdos independientemente...');
    
    const run = document.getElementById('run')?.value;
    if (!run || run.length < 8) {
        alert('‚ö†Ô∏è Por favor ingrese un RUN v√°lido antes de guardar acuerdos');
        return;
    }
    
    const nuevoAcuerdo = document.getElementById('nuevo_acuerdo')?.value?.trim();
    const cumplimiento = document.getElementById('cumplimiento')?.value;
    const fechaAcuerdo = document.getElementById('fecha_acuerdo')?.value;
    const observaciones = document.getElementById('observaciones')?.value?.trim();
    
    if (!nuevoAcuerdo && !cumplimiento) {
        alert('‚ö†Ô∏è Por favor ingrese un acuerdo o seleccione un cumplimiento antes de guardar');
        return;
    }
    
    const confirmacion = confirm(`¬øDesea guardar los acuerdos para el RUN ${run}?`);
    if (!confirmacion) return;
    
    // Crear FormData para enviar al backend
    const formData = new FormData();
    formData.append('run', run);
    formData.append('guardar_solo_acuerdos', '1');
    if (nuevoAcuerdo) formData.append('nuevo_acuerdo', nuevoAcuerdo);
    if (cumplimiento) formData.append('cumplimiento', cumplimiento);
    if (fechaAcuerdo) formData.append('fecha_acuerdo', fechaAcuerdo);
    if (observaciones) formData.append('observaciones', observaciones);
    
    console.log('üì§ Enviando acuerdo:', {nuevoAcuerdo, cumplimiento, observaciones});
    
    // Enviar al endpoint principal del formulario para que el backend procese guardar_solo_acuerdos
    fetch('/usuario/nuevo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(data => {
        console.log('‚úÖ Respuesta del servidor:', data);
        alert('‚úÖ Acuerdo guardado exitosamente');
        
        // Limpiar campos despu√©s del guardado
        document.getElementById('nuevo_acuerdo').value = '';
        document.getElementById('cumplimiento').value = '';
        document.getElementById('observaciones').value = '';
        
        // Buscar el usuario de nuevo para actualizar la tabla de acuerdos
        buscarUsuario(run);
    })
    .catch(error => {
        console.error('‚ùå Error:', error);
        alert('‚ùå Error de conexi√≥n al guardar acuerdos');
    });
}

// Funci√≥n para guardar control independientemente
function guardarControlIndependiente() {
    console.log('üíæ Guardando control independientemente...');
    
    const run = document.getElementById('run')?.value;
    if (!run || run.length < 8) {
        alert('‚ö†Ô∏è Por favor ingrese un RUN v√°lido antes de guardar el control');
        return;
    }
    
    // Verificar que al menos algunos campos de control est√©n completados
    const camposControl = [
        'fecha', 'profesional', 'peso', 'talla', 'presion_sistolica', 'presion_diastolica',
        'cc', 'hgt', 'hba1c', 'col', 'hdl', 'ldl', 'tag', 
        'microalbuminuria_val', 'vfg', 'rac', 'tsh', 'creatinemia'
    ];
    
    const algunCampoCompleto = camposControl.some(campo => {
        const elemento = document.querySelector(`[name="${campo}"]`);
        return elemento && elemento.value && elemento.value.trim() !== '';
    });
    
    if (!algunCampoCompleto) {
        alert('‚ö†Ô∏è Por favor complete al menos algunos campos del control antes de guardar');
        return;
    }
    
    const confirmacion = confirm(`¬øDesea guardar los datos de control para el RUN ${run}?`);
    if (!confirmacion) return;
    
    // Crear FormData con todos los campos del formulario pero solo guardar control
    const formData = new FormData();
    formData.append('run', run);
    formData.append('guardar_solo_control', '1');
    
    // Agregar campos de control directamente del DOM
    const fecha = document.querySelector('[name="fecha"]');
    const profesional = document.querySelector('[name="profesional"]');
    const peso = document.querySelector('[name="peso"]');
    const talla = document.querySelector('[name="talla"]');
    const presion_sistolica = document.querySelector('[name="presion_sistolica"]');
    const presion_diastolica = document.querySelector('[name="presion_diastolica"]');
    const cc = document.querySelector('[name="cc"]');
    const hgt = document.querySelector('[name="hgt"]');
    const hba1c = document.querySelector('[name="hba1c"]');
    
    // Log de debug
    console.log('üíæ Datos del control a guardar:');
    console.log('Fecha:', fecha?.value);
    console.log('Profesional:', profesional?.value);
    console.log('Peso:', peso?.value);
    console.log('Talla:', talla?.value);
    
    if (fecha?.value) formData.append('fecha', fecha.value);
    if (profesional?.value) formData.append('profesional', profesional.value);
    if (peso?.value) formData.append('peso', peso.value);
    if (talla?.value) formData.append('talla', talla.value);
    if (presion_sistolica?.value) formData.append('presion_sistolica', presion_sistolica.value);
    if (presion_diastolica?.value) formData.append('presion_diastolica', presion_diastolica.value);
    if (cc?.value) formData.append('cc', cc.value);
    if (hgt?.value) formData.append('hgt', hgt.value);
    if (hba1c?.value) formData.append('hba1c', hba1c.value);
    
    // Agregar checkboxes especiales
    const microalbuminuria = document.querySelector('[name="microalbuminuria"]');
    if (microalbuminuria && microalbuminuria.checked) {
        formData.append('microalbuminuria', 'on');
    }
    
    const rpr = document.querySelector('[name="rpr"]');
    if (rpr && rpr.checked) {
        formData.append('rpr', 'on');
    }
    
    fetch('/usuario/nuevo', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('‚úÖ Respuesta del servidor:', response.status);
        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }
        return response.text();
    })
    .then(data => {
        console.log('‚úÖ Datos recibidos del servidor:', data);
        // Redirigir al mismo formulario con banner de √©xito (ok=1)
        const runParam = encodeURIComponent(run);
        alert('‚úÖ Control guardado exitosamente');
        window.location.href = `/usuario/nuevo?run=${runParam}&ok=1`;
    })
    .catch(error => {
        console.error('‚ùå Error completo:', error);
        alert(`‚ùå Error al guardar el control: ${error.message}`);
    });
}

// Funci√≥n para marcar visualmente campos con errores
function marcarCampoError(campoId) {
    var campo = document.getElementById(campoId);
    if (campo) {
        campo.style.border = '2px solid #dc3545';
        campo.style.backgroundColor = '#fff5f5';
        
        // Remover el estilo de error despu√©s de que el usuario interact√∫e con el campo
        campo.addEventListener('input', function() {
            campo.style.border = '';
            campo.style.backgroundColor = '';
        }, {once: true});
        
        campo.addEventListener('change', function() {
            campo.style.border = '';
            campo.style.backgroundColor = '';
        }, {once: true});
    }
}

// Funci√≥n para mostrar errores m√°s amigables
function mostrarErrorAmigable(tipoError, campo, mensaje) {
    var iconos = {
        'requerido': 'üìù',
        'run': 'üÜî',
        'fecha': 'üìÖ',
        'numero': 'üî¢',
        'email': 'üìß'
    };
    
    var icon = iconos[tipoError] || '‚ö†Ô∏è';
    var mensajeCompleto = icon + ' ' + mensaje + '\n\nüí° Tip: Los datos del formulario se preservar√°n para que puedas corregir el error.';
    
    alert(mensajeCompleto);
    
    if (campo) {
        marcarCampoError(campo);
        var elemento = document.getElementById(campo);
        if (elemento) {
            elemento.focus();
            elemento.scrollIntoView({behavior: 'smooth', block: 'center'});
        }
    }
}

// Aplicar colores a HbA1c en tabla est√°tica al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    const celdasHbA1c = document.querySelectorAll('.hba1c-valor');
    
    celdasHbA1c.forEach(celda => {
        const valorHbA1c = parseFloat(celda.getAttribute('data-hba1c'));
        const fechaNacimiento = celda.getAttribute('data-usuario-nacimiento');
        
        if (valorHbA1c && fechaNacimiento) {
            const edad = calcularEdadDesde(fechaNacimiento);
            let aplicarRojo = false;
            
            if (edad >= 80) {
                // Si edad >= 80 a√±os: rojo si HbA1c >= 8
                aplicarRojo = valorHbA1c >= 8;
            } else {
                // Si edad < 80 a√±os: rojo si HbA1c >= 7
                aplicarRojo = valorHbA1c >= 7;
            }
            
            if (aplicarRojo) {
                celda.style.backgroundColor = '#ffcccc';
                celda.style.color = '#cc0000';
                celda.style.fontWeight = 'bold';
            } else if (valorHbA1c > 0) { // Solo aplicar verde si hay un valor v√°lido
                celda.style.backgroundColor = '#ccffcc';
                celda.style.color = '#006600';
                celda.style.fontWeight = 'bold';
            }
        }
    });
    
    // Formatear fechas de "Fecha EKG" a formato corto dd/MM/yy
    try {
        function toShortDate(raw){
            if(!raw) return '';
            let d = new Date(raw);
            if(isNaN(d.getTime())){
                // Intentar YYYY-MM-DD
                const m = String(raw).match(/^(\d{4})-(\d{2})-(\d{2})/);
                if(m){ d = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3])); }
            }
            if(isNaN(d.getTime())) return String(raw);
            const dd = String(d.getDate()).padStart(2,'0');
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const yy = String(d.getFullYear()).slice(-2);
            return `${dd}/${mm}/${yy}`;
        }
        const ekgCells = document.querySelectorAll('#tabla-examenes tbody tr td:nth-child(8)');
        ekgCells.forEach(td => { const t = (td.textContent||'').trim(); if(t){ td.textContent = toShortDate(t); } });
    } catch(_e) { /* noop */ }

    // Agregar event listener para detectar edici√≥n manual de categor√≠a
    const categoriaSelect = document.getElementById('categoria_id');
    if (categoriaSelect) {
        categoriaSelect.addEventListener('change', function() {
            // Marcar que el usuario est√° editando manualmente la categor√≠a
            window.usuarioEditandoCategoria = true;
            console.log('üë§ [CATEGORIA MANUAL] Usuario seleccion√≥ categor√≠a manualmente:', this.value);
            
            // Resetear el flag despu√©s de unos segundos para permitir actualizaciones autom√°ticas futuras
            setTimeout(() => {
                window.usuarioEditandoCategoria = false;
                console.log('üîÑ [CATEGORIA MANUAL] Flag de edici√≥n manual reseteado');
            }, 10000); // 10 segundos
        });
        
        // Tambi√©n detectar si el usuario hace focus en el select
        categoriaSelect.addEventListener('focus', function() {
            window.usuarioEditandoCategoria = true;
            console.log('üë§ [CATEGORIA MANUAL] Usuario enfoc√≥ el select de categor√≠a');
        });
    }
});

// Test autom√°tico removido - las patolog√≠as solo deben cargarse cuando se ingrese un RUN v√°lido
// -------------------------------
// Validaci√≥n espec√≠fica EKG (frontend)
// -------------------------------
document.addEventListener('DOMContentLoaded', () => {
    const ekgChk = document.querySelector('input[name="ekg"]');
    const ekgFecha = document.getElementById('ekgFecha');
    if(ekgChk && ekgFecha){
        // Asegurar estado inicial
        ekgFecha.disabled = !ekgChk.checked;
        ekgChk.addEventListener('change', () => {
            ekgFecha.disabled = !ekgChk.checked;
            if(!ekgChk.checked){
                try{ setFechaConOverlay('ekgFecha','',{dispatch:true}); }catch(_){ ekgFecha.value=''; }
                ekgFecha.classList.remove('input-error-ekg');
            }
        });
    }
    // Hook formulario principal
    const form = document.getElementById('usuarioForm');
    if(form && ekgChk && ekgFecha){
        form.addEventListener('submit', (ev) => {
            if(ekgChk.checked && !ekgFecha.value){
                ev.preventDefault();
                ekgFecha.classList.add('input-error-ekg');
                ekgFecha.focus();
                alert('Debe ingresar fecha de EKG cuando el EKG est√° marcado.');
            }
        });
        ekgFecha.addEventListener('input', () => ekgFecha.classList.remove('input-error-ekg'));
    }
});
// ===== Fin bloque Adulto Mayor =====
</script>
<style>
.input-error-ekg { border:2px solid #d9534f !important; box-shadow:0 0 3px #d9534f; }
</style>
<!-- Eliminado script vac√≠o -->

<script>
// Utilidad para limpiar la evaluaci√≥n de Adulto Mayor ahora que no es un <form>
function resetEvaluacionAdultoMayor(){
    try{
        const root = document.getElementById('evaluacionAdultoMayorForm');
        if(!root) return;
        root.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]').forEach(el=>el.value='');
        root.querySelectorAll('select').forEach(sel=>sel.selectedIndex=0);
        const res = document.getElementById('adultoMayorResultado');
        if(res) res.style.display='none';
        const status = document.getElementById('adultoMayorStatus');
        if(status) status.textContent='';
    }catch(e){ console.warn('No se pudo limpiar Adulto Mayor', e); }
}

// Funci√≥n para mostrar alertas transparentes personalizadas
function showTransparentAlert(message, type = 'warning', duration = 4000) {
    const alert = document.createElement('div');
    alert.className = 'alert-transparent';
    
    const icons = {
        warning: '‚ö†Ô∏è',
        error: '‚ùå', 
        success: '‚úÖ',
        info: '‚ÑπÔ∏è'
    };
    
    const colors = {
        warning: {
            bg: 'rgba(255, 243, 224, 0.95)',
            border: 'rgba(245, 158, 11, 0.3)',
            borderLeft: '#f59e0b',
            color: '#92400e',
            shadow: 'rgba(245, 158, 11, 0.2)'
        },
        error: {
            bg: 'rgba(254, 242, 242, 0.95)',
            border: 'rgba(239, 68, 68, 0.3)',
            borderLeft: '#ef4444',
            color: '#991b1b',
            shadow: 'rgba(239, 68, 68, 0.2)'
        },
        success: {
            bg: 'rgba(240, 253, 244, 0.95)',
            border: 'rgba(34, 197, 94, 0.3)',
            borderLeft: '#22c55e',
            color: '#166534',
            shadow: 'rgba(34, 197, 94, 0.2)'
        },
        info: {
            bg: 'rgba(239, 246, 255, 0.95)',
            border: 'rgba(59, 130, 246, 0.3)',
            borderLeft: '#3b82f6',
            color: '#1e40af',
            shadow: 'rgba(59, 130, 246, 0.2)'
        }
    };
    
    const style = colors[type] || colors.warning;
    
    alert.style.cssText = `
        position: fixed;
        top: 120px;
        right: 24px;
        background: ${style.bg};
        border: 1px solid ${style.border};
        border-left: 4px solid ${style.borderLeft};
        color: ${style.color};
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px ${style.shadow};
        z-index: 10000;
        max-width: 280px;
        backdrop-filter: blur(10px);
        transform: translateX(300px);
        transition: all 0.3s ease;
    `;
    
    alert.innerHTML = `<span class="alert-icon">${icons[type] || icons.warning}</span>${message}`;
    document.body.appendChild(alert);
    
    // Animar entrada
    setTimeout(() => {
        alert.style.transform = 'translateX(0)';
    }, 100);
    
    // Animar salida
    setTimeout(() => {
        alert.style.transform = 'translateX(300px)';
        setTimeout(() => alert.remove(), 300);
    }, duration);
}

// Reemplazar alert() nativo para casos espec√≠ficos (opcional)
window.showAlert = showTransparentAlert;

// Mejorar las funciones alert existentes para usar √≠conos consistentes
(function() {
    const originalAlert = window.alert;
    window.alert = function(message) {
        // Detectar tipo de mensaje basado en contenido
        const messageStr = String(message);
        let type = 'info';
        
        if (messageStr.includes('Error') || messageStr.includes('error') || messageStr.includes('‚ùå') || messageStr.includes('üí•')) {
            type = 'error';
        } else if (messageStr.includes('‚ö†Ô∏è') || messageStr.includes('Advertencia') || messageStr.includes('Restricci√≥n')) {
            type = 'warning';
        } else if (messageStr.includes('‚úÖ') || messageStr.includes('correctamente') || messageStr.includes('guardado')) {
            type = 'success';
        }

        // Usar alert transparente si est√° disponible, sino usar alert nativo
        if (typeof showTransparentAlert === 'function') {
            showTransparentAlert(messageStr, type, 4000);
        } else {
            originalAlert(messageStr);
        }
    };
})();

// Funci√≥n para mostrar errores espec√≠ficos de campos con √≠conos
window.showFieldError = function(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (field) {
        const label = field.closest('label');
        if (label) {
            // Crear √≠cono temporal de error si no existe
            let errorIcon = label.querySelector('.field-error-temp');
            if (!errorIcon) {
                errorIcon = document.createElement('span');
                errorIcon.className = 'field-error-temp';
                errorIcon.textContent = 'üö®';
                errorIcon.style.cssText = `
                    position: absolute;
                    right: 8px;
                    top: 50%;
                    transform: translateY(-50%);
                    font-size: 16px;
                    z-index: 10;
                    animation: pulse 1s infinite;
                `;
                label.style.position = 'relative';
                label.appendChild(errorIcon);
            }
            
            // Remover el √≠cono despu√©s de unos segundos
            setTimeout(() => {
                if (errorIcon && errorIcon.parentNode) {
                    errorIcon.remove();
                }
            }, 3000);
        }
        
        // Hacer foco en el campo
        field.focus();
        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Mostrar mensaje
    showTransparentAlert(`üö® ${message}`, 'error', 3000);
};

// CSS para animaci√≥n de pulso
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% { opacity: 1; transform: translateY(-50%) scale(1); }
        50% { opacity: 0.7; transform: translateY(-50%) scale(1.1); }
        100% { opacity: 1; transform: translateY(-50%) scale(1); }
    }
`;
document.head.appendChild(style);
</script>

<!-- Script para espa√±olizar fechas -->
<script>
// ========== FUNCIONES PARA ESPA√ëOLIZAR FECHAS ==========

// Funci√≥n para formatear fecha en espa√±ol (dd/mm/aaaa) sin d√≠as de semana
function formatearFechaEspanol(fecha) {
    if (!fecha) return '';
    
    let d;
    if (typeof fecha === 'string') {
        // Si es string tipo ISO (YYYY-MM-DD)
        if (/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
            d = new Date(fecha + 'T00:00:00');
        } else {
            d = new Date(fecha);
        }
    } else if (fecha instanceof Date) {
        d = fecha;
    } else {
        return '';
    }
    
    if (isNaN(d.getTime())) return '';
    
    const dia = String(d.getDate()).padStart(2, '0');
    const mes = String(d.getMonth() + 1).padStart(2, '0');
    const anio = d.getFullYear();
    
    return `${dia}/${mes}/${anio}`;
}

// Funci√≥n para convertir de dd/mm/aaaa a YYYY-MM-DD
function convertirFechaISO(fechaEspanol) {
    if (!fechaEspanol) return '';
    
    const partes = fechaEspanol.split('/');
    if (partes.length !== 3) return '';
    
    const dia = partes[0];
    const mes = partes[1];
    const anio = partes[2];
    
    return `${anio}-${mes}-${dia}`;
}

// Funci√≥n para configurar un input de fecha en formato espa√±ol
function configurarInputFechaEspanol(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    // Crear un input de texto que mostrar√° el formato espa√±ol
    const inputEspanol = document.createElement('input');
    inputEspanol.type = 'text';
    inputEspanol.placeholder = 'dd/mm/aaaa';
    inputEspanol.style.cssText = input.style.cssText;
    inputEspanol.id = inputId + '_espanol';
    
    // Ocultar el input original
    input.style.display = 'none';
    
    // Insertar el input espa√±ol despu√©s del original
    input.parentNode.insertBefore(inputEspanol, input.nextSibling);
    
    // Sincronizar valores
    function sincronizarHaciaISO() {
        const valorEspanol = inputEspanol.value.trim();
        if (valorEspanol) {
            const valorISO = convertirFechaISO(valorEspanol);
            input.value = valorISO;
        } else {
            input.value = '';
        }
        
        // Disparar evento change en el input original
        input.dispatchEvent(new Event('change', { bubbles: true }));
        input.dispatchEvent(new Event('input', { bubbles: true }));
    }
    
    function sincronizarHaciaEspanol() {
        const valorISO = input.value;
        if (valorISO) {
            const valorEspanol = formatearFechaEspanol(valorISO);
            inputEspanol.value = valorEspanol;
        } else {
            inputEspanol.value = '';
        }
    }
    
    // Mantener sincronizado estado disabled/readonly del overlay con el input ISO
    function syncDisabledReadonly() {
        try {
            inputEspanol.disabled = !!input.disabled;
            inputEspanol.readOnly = !!input.readOnly;
            inputEspanol.style.opacity = input.disabled ? '0.6' : '';
            inputEspanol.style.pointerEvents = input.disabled ? 'none' : '';
        } catch(_) {}
    }
    syncDisabledReadonly();
    const mo = new MutationObserver(syncDisabledReadonly);
    mo.observe(input, { attributes: true, attributeFilter: ['disabled','readonly'] });

    // Eventos del input espa√±ol
    inputEspanol.addEventListener('input', function(e) {
        let valor = e.target.value;
        
        // Permitir solo n√∫meros y barras
        valor = valor.replace(/[^\d\/]/g, '');
        
        // Auto-agregar barras
        if (valor.length === 2 && !valor.includes('/')) {
            valor += '/';
        } else if (valor.length === 5 && valor.split('/').length === 2) {
            valor += '/';
        }
        
        // Limitar longitud
        if (valor.length > 10) {
            valor = valor.substring(0, 10);
        }
        
        e.target.value = valor;
        sincronizarHaciaISO();
    });
    
    inputEspanol.addEventListener('blur', function(e) {
        const valor = e.target.value.trim();
        if (valor && !/^\d{2}\/\d{2}\/\d{4}$/.test(valor)) {
            // Formato inv√°lido
            e.target.style.borderColor = '#dc3545';
            setTimeout(() => {
                e.target.style.borderColor = '';
            }, 2000);
        } else {
            sincronizarHaciaISO();
        }
    });
    
    // Sincronizar cuando el input original cambie
    input.addEventListener('change', sincronizarHaciaEspanol);
    input.addEventListener('input', sincronizarHaciaEspanol);

    // Exponer peque√±o helper para sincronizaci√≥n manual si otro c√≥digo cambia disabled directamente
    input._syncOverlayState = syncDisabledReadonly;
    
    // Sincronizaci√≥n inicial
    sincronizarHaciaEspanol();
    
    return inputEspanol;
}

// Funci√≥n para aplicar formato espa√±ol a todos los inputs de fecha
function aplicarFormatoEspanolATodosLosCamposDeFecha() {
    const inputsFecha = document.querySelectorAll('input[type="date"]');
    inputsFecha.forEach(input => {
        if (input.id && !document.getElementById(input.id + '_espanol')) {
            configurarInputFechaEspanol(input.id);
        }
    });
}

// Reemplazar toLocaleDateString para que use formato espa√±ol sin d√≠as de semana
Date.prototype.toLocaleDateStringEspanol = function() {
    return formatearFechaEspanol(this);
};

// Aplicar formato espa√±ol cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        aplicarFormatoEspanolATodosLosCamposDeFecha();
    }, 1000);
    // Intentar sincronizar estados disabled/readonly despu√©s de crear overlays
    setTimeout(() => {
        document.querySelectorAll('input[type="date"]').forEach(inp => {
            if (typeof inp._syncOverlayState === 'function') { try{ inp._syncOverlayState(); }catch(_){}}
        });
    }, 1300);
});

// Tambi√©n aplicar cuando se agreguen nuevos campos din√°micamente
const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    const inputsFecha = node.querySelectorAll ? node.querySelectorAll('input[type="date"]') : [];
                    inputsFecha.forEach(input => {
                        if (input.id && !document.getElementById(input.id + '_espanol')) {
                            setTimeout(() => configurarInputFechaEspanol(input.id), 100);
                        }
                    });
                }
            });
        }
    });
});

observer.observe(document.body, {
    childList: true,
    subtree: true
});

// Funci√≥n para obtener fecha actual en formato espa√±ol
function obtenerFechaHoyEspanol() {
    return formatearFechaEspanol(new Date());
}

// Funci√≥n para validar formato de fecha espa√±ol
function validarFechaEspanol(fechaStr) {
    if (!fechaStr) return false;
    
    const regex = /^\d{2}\/\d{2}\/\d{4}$/;
    if (!regex.test(fechaStr)) return false;
    
    const partes = fechaStr.split('/');
    const dia = parseInt(partes[0], 10);
    const mes = parseInt(partes[1], 10);
    const anio = parseInt(partes[2], 10);
    
    if (mes < 1 || mes > 12) return false;
    if (dia < 1 || dia > 31) return false;
    if (anio < 1900 || anio > 2100) return false;
    
    // Verificar fecha v√°lida
    const fecha = new Date(anio, mes - 1, dia);
    return fecha.getFullYear() === anio && fecha.getMonth() === (mes - 1) && fecha.getDate() === dia;
}

console.log('‚úÖ Sistema de fechas en espa√±ol configurado correctamente');
</script>

<!-- Script para funciones del sistema de vigencia anual PSA -->
<script>
// ========== SINCRONIZACI√ìN GLOBAL ISO <-> OVERLAY ESPA√ëOL ==========
// Registro global de overlays creados por configurarInputFechaEspanol
window.OverlayFechas = window.OverlayFechas || {
    // Devuelve el input de texto espa√±ol asociado a un id ISO
    get: function(id){
        const el = document.getElementById(id + '_espanol');
        return el || null;
    }
};

// Helper para fijar una fecha ISO en el input original y su overlay espa√±ol, con eventos
function setFechaConOverlay(idISO, valorISO, opts){
    const el = document.getElementById(idISO);
    if(!el) return;
    const opciones = Object.assign({ dispatch: true }, opts||{});
    // Setear ISO en el input original
    el.value = valorISO || '';
    // Si existe overlay, actualizarlo en formato espa√±ol
    const overlay = window.OverlayFechas.get(idISO);
    if(overlay){
        try{ overlay.value = valorISO ? formatearFechaEspanol(valorISO) : ''; } catch(_){ }
    }
    // Disparar eventos para que otros listeners reaccionen (edad, validaciones, etc.)
    if(opciones.dispatch){
        try { el.dispatchEvent(new Event('input', { bubbles: true })); } catch(_){ }
        try { el.dispatchEvent(new Event('change', { bubbles: true })); } catch(_){ }
    }
}

// ========== FUNCIONES PARA PSA CON VIGENCIA ANUAL ==========

async function guardarPSA() {
    const run = runRaw();
    if (!run) {
        alert('Ingrese RUN');
        return;
    }
    
    const fecha = document.getElementById('psaFecha')?.value || '';
    const valor = parseFloat(document.getElementById('psaValor')?.value || '0');
    
    if (!fecha || !valor || valor <= 0) {
        alert('Complete fecha y valor de PSA');
        return;
    }
    
    // Convertir fecha de dd/mm/aaaa a yyyy-mm-dd para el servidor
    let fechaISO = fecha;
    if (fecha.includes('/')) {
        const partes = fecha.split('/');
        if (partes.length === 3) {
            fechaISO = `${partes[2]}-${partes[1].padStart(2,'0')}-${partes[0].padStart(2,'0')}`;
        }
    }
    
    const st = document.getElementById('psaStatus');
    st.textContent = 'Guardando...';
    
    try {
        const payload = {
            run: run,
            psa: {
                fecha: fechaISO,
                valor: valor
            }
        };
        
        const resp = await fetch('/api/screening', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const j = await resp.json();
        
        if (j.success) {
            st.textContent = 'Guardado ‚úÖ';
            await cargarPSAUltimo();
            await cargarPSAHistorial();
        } else {
            st.textContent = 'Error: ' + (j.error || '');
        }
    } catch (e) {
        st.textContent = 'Error de red';
        console.error('Error guardando PSA:', e);
    }
}

async function cargarPSAUltimo() {
    const run = runRaw();
    const box = document.getElementById('psaUltimo');
    if (!run) {
        box.style.display = 'none';
        return;
    }
    
    try {
        const resp = await fetch(`/api/screening/${encodeURIComponent(run)}`);
        const j = await resp.json();
        
        if (j.success && j.screening && j.screening.psa) {
            const d = j.screening.psa;
            const fechaEl = document.getElementById('psaFecha');
            const valorEl = document.getElementById('psaValor');
            const btnGuardar = document.getElementById('psaGuardarBtn');
            const btnNuevo = document.getElementById('psaNuevoBtn');
            const st = document.getElementById('psaStatus');
            
            if (fechaEl && d.fecha) { 
                // Convertir fecha ISO (yyyy-mm-dd) a formato dd/mm/aaaa
                const fechaFormatted = d.fecha.split('-').reverse().join('/');
                fechaEl.value = fechaFormatted;
            }
            if (valorEl && d.psa_valor) valorEl.value = d.psa_valor;
            
            box.style.display = 'block';
            box.textContent = `√öltimo: ${formatearFechaEspanol(d.fecha)} ‚Ä¢ Valor: ${d.psa_valor} ng/mL`;
            
            // Verificar vigencia anual
            const today = new Date();
            const fechaRegistro = new Date(d.fecha + 'T00:00:00');
            const anioActual = today.getFullYear();
            const anioRegistro = fechaRegistro.getFullYear();
            
            if (anioActual === anioRegistro) {
                // Bloqueado hasta el pr√≥ximo a√±o
                if (st) st.textContent = `üîí PSA ${anioActual} ya registrado. Bloqueado hasta ${anioActual + 1}.`;
                if (fechaEl) fechaEl.disabled = true;
                if (valorEl) valorEl.disabled = true;
                if (btnGuardar) btnGuardar.disabled = true;
                if (btnNuevo) btnNuevo.style.display = 'inline-flex';
            } else {
                // Desbloqueado
                if (st && st.textContent.startsWith('üîí')) st.textContent = '';
                if (fechaEl) fechaEl.disabled = false;
                if (valorEl) valorEl.disabled = false;
                if (btnGuardar) btnGuardar.disabled = false;
                if (btnNuevo) btnNuevo.style.display = 'none';
            }
        } else {
            box.style.display = 'none';
        }
    } catch (e) {
        box.style.display = 'none';
        console.error('Error cargando PSA √∫ltimo:', e);
    }
}

async function cargarPSAHistorial() {
    const run = runRaw();
    const cont = document.getElementById('psaHist');
    const tbody = document.getElementById('psaHistBody');
    
    if (!run) {
        cont.style.display = 'none';
        return;
    }
    
    try {
        const resp = await fetch(`/api/screening/${encodeURIComponent(run)}`);
        const j = await resp.json();
        
        if (j.success && j.screening && j.screening.psa) {
            // Simular historial (en implementaci√≥n real vendr√≠a del backend)
            const historial = [j.screening.psa]; // Aqu√≠ deber√≠as hacer una llamada espec√≠fica al historial
            
            if (historial.length > 0) {
                cont.style.display = 'block';
                tbody.innerHTML = historial.map(d => 
                    `<tr>
                        <td style="padding:4px;">${formatearFechaEspanol(d.fecha)}</td>
                        <td style="padding:4px;">${d.psa_valor || '--'} ng/mL</td>
                        <td style="padding:4px;">${formatearFechaEspanol(new Date())}</td>
                    </tr>`
                ).join('');
            } else {
                cont.style.display = 'none';
            }
        } else {
            cont.style.display = 'none';
        }
    } catch (e) {
        cont.style.display = 'none';
        console.error('Error cargando historial PSA:', e);
    }
}

function iniciarNuevoPSA() {
    if (!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de PSA? El registro actual se mover√° al hist√≥rico.')) return;
    
    const fechaEl = document.getElementById('psaFecha');
    const valorEl = document.getElementById('psaValor');
    const btnGuardar = document.getElementById('psaGuardarBtn');
    const btnNuevo = document.getElementById('psaNuevoBtn');
    const st = document.getElementById('psaStatus');
    
    if (fechaEl) {
        fechaEl.disabled = false;
        fechaEl.value = '';
    }
    if (valorEl) {
        valorEl.disabled = false;
        valorEl.value = '';
    }
    if (btnGuardar) btnGuardar.disabled = false;
    if (btnNuevo) btnNuevo.style.display = 'none';
    if (st && st.textContent.startsWith('üîí')) st.textContent = '';
}

// Event listeners para PSA
document.addEventListener('DOMContentLoaded', function() {
    const psaGuardarBtn = document.getElementById('psaGuardarBtn');
    const psaNuevoBtn = document.getElementById('psaNuevoBtn');
    
    if (psaGuardarBtn) {
        psaGuardarBtn.addEventListener('click', guardarPSA);
    }
    
    if (psaNuevoBtn) {
        psaNuevoBtn.addEventListener('click', iniciarNuevoPSA);
    }
});

console.log('‚úÖ Sistema PSA con vigencia anual configurado correctamente');
</script>

<!-- Script para funciones del sistema de vigencia anual Fondo de Ojos -->
<script>
// ========== FUNCIONES PARA FONDO DE OJOS CON VIGENCIA ANUAL ==========

async function guardarFondoOjos() {
    const run = runRaw();
    if (!run) {
        alert('Ingrese RUN');
        return;
    }
    
    if (!hasDiabetesDiagnosed()) {
        alert('Solo corresponde registrar fondo de ojos en personas con diagn√≥stico de diabetes.');
        return;
    }
    
    const fecha = document.getElementById('fondoOjosFecha')?.value || '';
    const estado = document.getElementById('fondoOjosEstado')?.value || '';
    
    if (!fecha || !estado) {
        alert('Complete fecha y estado del fondo de ojos');
        return;
    }
    
    const st = document.getElementById('fondoOjosStatus');
    st.textContent = 'Guardando...';
    
    try {
        const payload = {
            run: run,
            fondo_ojos: {
                fecha: fecha,
                estado: estado
            }
        };
        
        const resp = await fetch('/api/examenes/diabetes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const j = await resp.json();
        
        if (j.success) {
            st.textContent = 'Guardado ‚úÖ';
            await cargarFondoOjosUltimo();
            await cargarFondoOjosHistorial();
            updateDiabetesExtrasEstado();
        } else {
            st.textContent = 'Error: ' + (j.error || '');
        }
    } catch (e) {
        st.textContent = 'Error de red';
        console.error('Error guardando fondo de ojos:', e);
    }
}

async function cargarFondoOjosUltimo() {
    const run = runRaw();
    const box = document.getElementById('fondoOjosUltimo');
    if (!run) {
        box.style.display = 'none';
        return;
    }
    
    try {
        const resp = await fetch(`/api/exmenes/${encodeURIComponent(run)}?codigo=fondo_ojos&solo=realizados`);
        const j = await resp.json();
        
        if (j.success && j.examenes && j.examenes.length > 0) {
            const d = j.examenes[0]; // √öltimo registro
            const fechaEl = document.getElementById('fondoOjosFecha');
            const estadoEl = document.getElementById('fondoOjosEstado');
            const btnGuardar = document.getElementById('fondoOjosGuardarBtn');
            const btnNuevo = document.getElementById('fondoOjosNuevoBtn');
            const st = document.getElementById('fondoOjosStatus');
            
            if (fechaEl && d.examen_fecha) fechaEl.value = d.examen_fecha;
            if (estadoEl && d.notas) estadoEl.value = d.notas;
            
            box.style.display = 'block';
            box.textContent = `√öltimo: ${formatearFechaEspanol(d.examen_fecha)} ‚Ä¢ Estado: ${d.notas || 'Sin estado'}`;
            
            // Verificar vigencia anual
            const today = new Date();
            const fechaRegistro = new Date(d.examen_fecha + 'T00:00:00');
            const anioActual = today.getFullYear();
            const anioRegistro = fechaRegistro.getFullYear();
            
            if (anioActual === anioRegistro) {
                // Bloqueado hasta el pr√≥ximo a√±o
                if (st) st.textContent = `üîí Fondo de ojos ${anioActual} ya registrado. Bloqueado hasta ${anioActual + 1}.`;
                if (fechaEl) fechaEl.disabled = true;
                if (estadoEl) estadoEl.disabled = true;
                if (btnGuardar) btnGuardar.disabled = true;
                if (btnNuevo) btnNuevo.style.display = 'inline-flex';
            } else {
                // Desbloqueado
                if (st && st.textContent.startsWith('üîí')) st.textContent = '';
                if (fechaEl) fechaEl.disabled = false;
                if (estadoEl) estadoEl.disabled = false;
                if (btnGuardar) btnGuardar.disabled = false;
                if (btnNuevo) btnNuevo.style.display = 'none';
            }
        } else {
            box.style.display = 'none';
        }
    } catch (e) {
        box.style.display = 'none';
        console.error('Error cargando fondo de ojos √∫ltimo:', e);
    }
}

async function cargarFondoOjosHistorial() {
    const run = runRaw();
    const cont = document.getElementById('fondoOjosHist');
    const tbody = document.getElementById('fondoOjosHistBody');
    
    if (!run) {
        cont.style.display = 'none';
        return;
    }
    
    try {
        const resp = await fetch(`/api/exmenes/${encodeURIComponent(run)}?codigo=fondo_ojos&solo=realizados`);
        const j = await resp.json();
        
        if (j.success && j.examenes && j.examenes.length > 0) {
            cont.style.display = 'block';
            tbody.innerHTML = j.examenes.map(d => 
                `<tr>
                    <td style="padding:4px;">${formatearFechaEspanol(d.examen_fecha)}</td>
                    <td style="padding:4px;">${d.notas || '--'}</td>
                    <td style="padding:4px;">${formatearFechaEspanol(d.created_at || d.examen_fecha)}</td>
                </tr>`
            ).join('');
        } else {
            cont.style.display = 'none';
        }
    } catch (e) {
        cont.style.display = 'none';
        console.error('Error cargando historial fondo de ojos:', e);
    }
}

function iniciarNuevoFondoOjos() {
    if (!confirm('‚ö†Ô∏è ¬øConfirma crear un nuevo registro de fondo de ojos? El registro actual se mover√° al hist√≥rico.')) return;
    
    const fechaEl = document.getElementById('fondoOjosFecha');
    const estadoEl = document.getElementById('fondoOjosEstado');
    const btnGuardar = document.getElementById('fondoOjosGuardarBtn');
    const btnNuevo = document.getElementById('fondoOjosNuevoBtn');
    const st = document.getElementById('fondoOjosStatus');
    
    if (fechaEl) {
        fechaEl.disabled = false;
        try{ setFechaConOverlay('fondoOjosFecha','', { dispatch:true }); } catch(_){ fechaEl.value=''; }
    }
    if (estadoEl) {
        estadoEl.disabled = false;
        estadoEl.value = '';
    }
    if (btnGuardar) btnGuardar.disabled = false;
    if (btnNuevo) btnNuevo.style.display = 'none';
    if (st && st.textContent.startsWith('üîí')) st.textContent = '';
}

// Event listeners para Fondo de Ojos
document.addEventListener('DOMContentLoaded', function() {
    const fondoOjosGuardarBtn = document.getElementById('fondoOjosGuardarBtn');
    const fondoOjosNuevoBtn = document.getElementById('fondoOjosNuevoBtn');
    
    if (fondoOjosGuardarBtn) {
        fondoOjosGuardarBtn.addEventListener('click', guardarFondoOjos);
    }
    
    if (fondoOjosNuevoBtn) {
        fondoOjosNuevoBtn.addEventListener('click', iniciarNuevoFondoOjos);
    }
    
    // Event listener para Pie Diab√©tico "Nuevo"
    const pieDmNuevoBtn = document.getElementById('pieDmNuevoBtn');
    if (pieDmNuevoBtn) {
        pieDmNuevoBtn.addEventListener('click', iniciarNuevoPieDM);
    }
    
    // Event listener para Atenci√≥n Podol√≥gica "Nuevo"
    const podologiaNuevoBtn = document.getElementById('podologiaNuevoBtn');
    if (podologiaNuevoBtn) {
        podologiaNuevoBtn.addEventListener('click', iniciarNuevoPodologia);
    }
    
    // Event listener para Hipoglicemias "Nuevo"
    const hipoNuevoBtn = document.getElementById('hipoNuevoBtn');
    if (hipoNuevoBtn) {
        hipoNuevoBtn.addEventListener('click', iniciarNuevoHipoglicemias);
    }
    
    // Event listeners para Tratamiento con Insulina
    const insulinaGuardarBtn = document.getElementById('insulinaGuardarBtn');
    if (insulinaGuardarBtn) {
        insulinaGuardarBtn.addEventListener('click', () => guardarTratamientoInsulina(false));
    }
    
    const insulinaNuevoBtn = document.getElementById('insulinaNuevoBtn');
    if (insulinaNuevoBtn) {
        insulinaNuevoBtn.addEventListener('click', iniciarNuevoTratamientoInsulina);
    }
    
    // Mostrar todos los botones "Nuevo" por defecto
    const botonesNuevo = [
        'cvRiesgoNuevoBtn', 'cvActNuevoBtn', 'cvTabNuevoBtn', 'cvHeartsNuevoBtn',
        'medIecaNuevoBtn', 'medAntiNuevoBtn', 'medEstatNuevoBtn', 'amMaltratoNuevoBtn',
        'podologiaNuevoBtn', 'hipoNuevoBtn'
    ];
    botonesNuevo.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.style.display = 'inline-block';
        }
    });
});

// ==================== FUNCIONES SEGUIMIENTO DIAB√âTICO ====================

// Variable global para control del panel
let seguimientoPanelAbierto = false;

// Funci√≥n para mostrar/ocultar el seguimiento diab√©tico
function toggleSeguimientoDiabetico() {
    const panel = document.getElementById('seguimientoPanel');
    if (!panel) return;
    
    seguimientoPanelAbierto = !seguimientoPanelAbierto;
    
    if (seguimientoPanelAbierto) {
        panel.classList.add('active');
        evaluarSeguimientoDiabetico();
    } else {
        panel.classList.remove('active');
    }
}

// Funci√≥n principal para evaluar todos los criterios
async function evaluarSeguimientoDiabetico() {
    const runInput = document.querySelector('input[name="run"]');
    if (!runInput || !runInput.value.trim()) {
        mostrarMensajeSeguimiento('Ingrese un RUN v√°lido para evaluar');
        return;
    }
    
    const run = runInput.value.trim();
    
    // Verificar qu√© condiciones tiene el usuario
    const tieneDiabetes = hasDiabetesDiagnosed();
    const tieneHipertension = hasHipertensionDiagnosed();
    
    if (!tieneDiabetes && !tieneHipertension) {
        ocultarSeguimientoDiabetico();
        return;
    }
    
    // Configurar interfaz seg√∫n las condiciones
    configurarInterfazSegunCondiciones(tieneDiabetes, tieneHipertension);
    
    console.log('ü©∏ Evaluando seguimiento cardiovascular para RUN:', run, 
                'Diabetes:', tieneDiabetes, 'Hipertensi√≥n:', tieneHipertension);
    
    // Evaluar criterios comunes
    const criterios = {
        // Criterios comunes para ambas condiciones
        rac: await evaluarRAC(run),
        vfg: await evaluarVFG(run),
        vfg_rac: await evaluarVFGRAC(run),
        erc_medicacion: await evaluarERCMedicacion(run),
        actividad_fisica: await evaluarActividadFisica(run),
        fumador_actual: await evaluarFumadorActual(run),
        ecg: await evaluarECG(run),
        tabaquismo: await evaluarTabaquismo(run),
        colesterol_ldl: await evaluarColesterolLDL(run)
    };
    
    // Evaluar criterios espec√≠ficos de diabetes
    if (tieneDiabetes) {
        criterios.fondo_ojo = await evaluarFondoOjo(run);
        criterios.podologia = await evaluarPodologia(run);
        criterios.insulina = await evaluarTratamientoInsulina(run);
        criterios.hba1c = await evaluarHbA1c(run);
    }
    
    // Evaluar criterios espec√≠ficos de hipertensi√≥n
    if (tieneHipertension) {
        criterios.presion_arterial = await evaluarPresionArterial(run);
        criterios.enfermedad_renal_cronica = await evaluarEnfermedadRenalCronica(run);
        criterios.protocolo_hearts = await evaluarProtocoloHearts(run);
    }
    
    // Actualizar la interfaz
    actualizarInterfazSeguimiento(criterios);
}

// Funci√≥n para configurar la interfaz seg√∫n las condiciones del paciente
function configurarInterfazSegunCondiciones(tieneDiabetes, tieneHipertension) {
    const titulo = document.getElementById('seguimientoTitulo');
    const tabText = document.getElementById('seguimientoTabText');
    const seccionDiabetes = document.getElementById('seccionDiabetes');
    const seccionHipertension = document.getElementById('seccionHipertension');
    
    if (tieneDiabetes && tieneHipertension) {
        titulo.textContent = 'üìã Seguimiento Integral Diabetes + Hipertensi√≥n';
        tabText.innerHTML = 'Seguimiento<br>Cardiovascular';
        seccionDiabetes.style.display = 'block';
        seccionHipertension.style.display = 'block';
    } else if (tieneDiabetes) {
        titulo.textContent = 'üìã Seguimiento Integral Diab√©tico';
        tabText.innerHTML = 'Seguimiento<br>Diab√©tico';
        seccionDiabetes.style.display = 'block';
        seccionHipertension.style.display = 'none';
    } else if (tieneHipertension) {
        titulo.textContent = 'üìã Seguimiento Integral Hipertensi√≥n PSCV';
        tabText.innerHTML = 'Seguimiento<br>Hipertensi√≥n';
        seccionDiabetes.style.display = 'none';
        seccionHipertension.style.display = 'block';
    }
}

// Funci√≥n generalizada para evaluaciones m√©dicas con vigencia
async function evaluarExamenGenerico(run, endpoint, fechaField, nombreExamen, mensajePendiente = null) {
    try {
        const resp = await fetch(`/api/examenes/${endpoint}/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const fechaExamen = new Date(data.data[fechaField]);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaExamen) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                return {
                    estado: 'completo',
                    mensaje: `${nombreExamen} vigente (${data.data[fechaField]})`,
                    fecha: data.data[fechaField]
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: mensajePendiente || `${nombreExamen} pendiente`,
            fecha: null
        };
    } catch (error) {
        debugWarn(`Error en evaluarExamenGenerico (${endpoint}):`, error);
        return {
            estado: 'pendiente',
            mensaje: `Error al evaluar ${nombreExamen.toLowerCase()}`,
            fecha: null
        };
    }
}

// Funci√≥n para evaluar RAC (Raz√≥n Alb√∫mina/Creatinina)
async function evaluarRAC(run) {
    try {
        // Buscar ex√°menes RAC y creatininemia en el √∫ltimo a√±o
        const resp = await fetch(`/api/examenes/buscar?run=${encodeURIComponent(run)}&tipo=rac&vigencia=365`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            return {
                estado: 'completo',
                mensaje: `RAC vigente desde ${data.fecha}`,
                fecha: data.fecha
            };
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'RAC + Creatininemia pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar RAC',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar VFG (Velocidad de Filtraci√≥n Glomerular)
async function evaluarVFG(run) {
    try {
        const resp = await fetch(`/api/examenes/buscar?run=${encodeURIComponent(run)}&tipo=vfg&vigencia=365`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            return {
                estado: 'completo',
                mensaje: `VFG vigente desde ${data.fecha}`,
                fecha: data.fecha
            };
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'VFG pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar VFG',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar VFG + RAC + Creatininemia
async function evaluarVFGRAC(run) {
    try {
        const vfg = await evaluarVFG(run);
        const rac = await evaluarRAC(run);
        
        if (vfg.estado === 'completo' && rac.estado === 'completo') {
            return {
                estado: 'completo',
                mensaje: 'Evaluaci√≥n renal completa',
                fecha: new Date(Math.max(new Date(vfg.fecha), new Date(rac.fecha))).toLocaleDateString()
            };
        } else if (vfg.estado === 'completo' || rac.estado === 'completo') {
            return {
                estado: 'parcial',
                mensaje: 'Evaluaci√≥n renal incompleta',
                fecha: null
            };
        } else {
            return {
                estado: 'pendiente',
                mensaje: 'Evaluaci√≥n renal pendiente',
                fecha: null
            };
        }
    } catch (error) {
        debugWarn('Error en evaluarVFGRAC:', error);
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar funci√≥n renal',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar Fondo de Ojo - usando funci√≥n generalizada
async function evaluarFondoOjo(run) {
    return await evaluarExamenGenerico(run, 'fondo_ojo', 'fecha_realizacion', 'Fondo ojo', 'Fondo de ojo pendiente');
}

// Funci√≥n para evaluar Podolog√≠a - usando funci√≥n generalizada
async function evaluarPodologia(run) {
    return await evaluarExamenGenerico(run, 'podologia', 'fecha', 'Podolog√≠a', 'Atenci√≥n podol√≥gica pendiente');
}

// Funci√≥n para evaluar ECG - usando funci√≥n generalizada
async function evaluarECG(run) {
    return await evaluarExamenGenerico(run, 'ekg', 'fecha_ekg', 'ECG', 'ECG pendiente');
}

// Funci√≥n para evaluar Tratamiento con Insulina
async function evaluarTratamientoInsulina(run) {
    try {
        const resp = await fetch(`/api/examenes/tratamiento_insulina/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const fechaExamen = new Date(data.data.fecha_evaluacion);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaExamen) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                return {
                    estado: 'completo',
                    mensaje: `Tratamiento insulina registrado (${data.data.fecha_evaluacion})`,
                    fecha: data.data.fecha_evaluacion
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'Evaluaci√≥n insulina pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar insulina',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar HbA1c seg√∫n edad
async function evaluarHbA1c(run) {
    try {
        // Obtener edad del usuario
        const edadInput = document.querySelector('input[name="edad"]');
        if (!edadInput || !edadInput.value) {
            return {
                estado: 'pendiente',
                mensaje: 'Edad no registrada',
                fecha: null
            };
        }
        
        const edad = parseInt(edadInput.value);
        const metaHbA1c = edad >= 80 ? 8 : 7;
        
        const resp = await fetch(`/api/examenes/hba1c/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const valorHbA1c = parseFloat(data.data.valor);
            const cumpleMeta = valorHbA1c < metaHbA1c;
            
            return {
                estado: cumpleMeta ? 'completo' : 'parcial',
                mensaje: cumpleMeta ? 
                    `HbA1c: ${valorHbA1c}% (Meta <${metaHbA1c}%)` : 
                    `HbA1c: ${valorHbA1c}% (Meta <${metaHbA1c}% no alcanzada)`,
                fecha: data.data.fecha
            };
        }
        
        return {
            estado: 'pendiente',
            mensaje: `HbA1c pendiente (Meta <${metaHbA1c}%)`,
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar HbA1c',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar Tabaquismo
async function evaluarTabaquismo(run) {
    try {
        const resp = await fetch(`/api/examenes/tabaquismo/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const fechaExamen = new Date(data.data.fecha_evaluacion);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaExamen) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                const esFumador = data.data.fumador_actual;
                return {
                    estado: 'completo',
                    mensaje: esFumador ? 
                        `Fumador activo (${data.data.fecha_evaluacion})` : 
                        `No fumador (${data.data.fecha_evaluacion})`,
                    fecha: data.data.fecha_evaluacion
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'Evaluaci√≥n tabaquismo pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar tabaquismo',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar ERC + Medicaci√≥n IECA/ARA II
async function evaluarERCMedicacion(run) {
    try {
        // Verificar diagn√≥stico de ERC en patolog√≠as seleccionadas
        const tieneERC = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
            .some(cb => {
                const label = cb.nextElementSibling?.textContent || '';
                return label.toLowerCase().includes('enfermedad renal') || 
                       label.toLowerCase().includes('erc') ||
                       label.toLowerCase().includes('renal cr√≥nica');
            });
        
        if (!tieneERC) {
            return {
                estado: 'completo',
                mensaje: 'Sin ERC diagnosticada',
                fecha: null
            };
        }
        
        // Verificar medicaci√≥n IECA/ARA II
        const resp = await fetch(`/api/examenes/medicacion/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const tieneIECA = data.data.some(med => 
                med.nombre.toLowerCase().includes('ieca') || 
                med.nombre.toLowerCase().includes('ara ii') ||
                med.nombre.toLowerCase().includes('enalapril') ||
                med.nombre.toLowerCase().includes('losartan')
            );
            
            if (tieneIECA) {
                return {
                    estado: 'completo',
                    mensaje: 'ERC con IECA/ARA II',
                    fecha: data.data[0].fecha
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'ERC sin IECA/ARA II',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar ERC/medicaci√≥n',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar Actividad F√≠sica Salud Cardiovascular
async function evaluarActividadFisica(run) {
    try {
        const resp = await fetch(`/api/examenes/actividad_fisica/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const fechaEvaluacion = new Date(data.data.fecha);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaEvaluacion) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                const tieneActividadFisica = data.data.actividad_fisica || data.data.ejercicio_regular;
                return {
                    estado: tieneActividadFisica ? 'completo' : 'parcial',
                    mensaje: tieneActividadFisica ? 'Actividad f√≠sica regular' : 'Sin actividad f√≠sica',
                    fecha: data.data.fecha
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'Evaluaci√≥n AF pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar AF',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar Fumador Actual
async function evaluarFumadorActual(run) {
    try {
        const resp = await fetch(`/api/examenes/tabaquismo/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const fechaEvaluacion = new Date(data.data.fecha);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaEvaluacion) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                const esFumador = data.data.fumador || data.data.tabaquismo_activo;
                return {
                    estado: esFumador ? 'parcial' : 'completo',
                    mensaje: esFumador ? 'Fumador activo ‚ö†Ô∏è' : 'No fumador ‚úÖ',
                    fecha: data.data.fecha
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'Evaluaci√≥n tabaquismo pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar tabaquismo',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar Colesterol LDL
async function evaluarColesterolLDL(run) {
    try {
        const resp = await fetch(`/api/examenes/colesterol_ldl/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const fechaExamen = new Date(data.data.fecha);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaExamen) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                return {
                    estado: 'completo',
                    mensaje: `Colesterol LDL vigente (${data.data.fecha})`,
                    fecha: data.data.fecha
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'Colesterol LDL pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar colesterol LDL',
            fecha: null
        };
    }
}

// ========== FUNCIONES ESPEC√çFICAS PARA HIPERTENSI√ìN ==========

// Funci√≥n para evaluar Presi√≥n Arterial ‚â•160/100
async function evaluarPresionArterial(run) {
    try {
        const resp = await fetch(`/api/examenes/presion_arterial/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const sistolica = parseInt(data.data.sistolica);
            const diastolica = parseInt(data.data.diastolica);
            const tieneHipertensionSevera = sistolica >= 160 || diastolica >= 100;
            
            const fechaExamen = new Date(data.data.fecha);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaExamen) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                return {
                    estado: tieneHipertensionSevera ? 'parcial' : 'completo',
                    mensaje: tieneHipertensionSevera ? 
                        `PA ${sistolica}/${diastolica} ‚ö†Ô∏è ‚â•160/100` : 
                        `PA ${sistolica}/${diastolica} <160/100`,
                    fecha: data.data.fecha
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'Control PA pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar PA',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar Protocolo Hearts
async function evaluarProtocoloHearts(run) {
    try {
        const resp = await fetch(`/api/examenes/protocolo_hearts/${encodeURIComponent(run)}`);
        const data = await resp.json();
        
        if (data.success && data.found) {
            const fechaEvaluacion = new Date(data.data.fecha_evaluacion);
            const hoy = new Date();
            const diasTranscurridos = Math.floor((hoy - fechaEvaluacion) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos <= 365) {
                return {
                    estado: 'completo',
                    mensaje: `Protocolo Hearts implementado (${data.data.fecha_evaluacion})`,
                    fecha: data.data.fecha_evaluacion
                };
            }
        }
        
        return {
            estado: 'pendiente',
            mensaje: 'Protocolo Hearts pendiente',
            fecha: null
        };
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar Hearts',
            fecha: null
        };
    }
}

// Funci√≥n para evaluar Enfermedad Renal Cr√≥nica
async function evaluarEnfermedadRenalCronica(run) {
    try {
        // Buscar diagn√≥sticos de ERC (c√≥digos N18-N19)
        const patologiasSeleccionadas = document.querySelectorAll('input.patologia-checkbox:checked');
        
        const codigosERC = new Set([
            'N18', 'N18.0', 'N18.1', 'N18.2', 'N18.3', 'N18.4', 'N18.5', 'N18.6', 'N18.9',
            'N19'  // Enfermedad renal cr√≥nica no especificada
        ]);
        
        // Verificar si tiene diagn√≥stico de ERC
        let tieneERC = false;
        for (const checkbox of patologiasSeleccionadas) {
            if (checkbox.value && codigosERC.has(checkbox.value)) {
                tieneERC = true;
                break;
            }
        }
        
        if (tieneERC) {
            return {
                estado: 'completo',
                mensaje: 'Diagn√≥stico ERC confirmado',
                fecha: new Date().toISOString().split('T')[0]
            };
        } else {
            return {
                estado: 'pendiente',
                mensaje: 'Sin diagn√≥stico ERC',
                fecha: null
            };
        }
        
    } catch (error) {
        return {
            estado: 'pendiente',
            mensaje: 'Error al evaluar ERC',
            fecha: null
        };
    }
}

// Funci√≥n para actualizar la interfaz con los resultados
function actualizarInterfazSeguimiento(criterios) {
    let completados = 0;
    const total = Object.keys(criterios).length;
    
    Object.entries(criterios).forEach(([key, resultado]) => {
        const item = document.querySelector(`[data-criterio="${key}"]`);
        if (!item) return;
        
        const icon = item.querySelector('.criterio-icon');
        const status = item.querySelector('.criterio-status');
        
        // Actualizar iconos y estados
        if (resultado.estado === 'completo') {
            icon.textContent = '‚úÖ';
            status.textContent = resultado.mensaje;
            item.setAttribute('data-estado', 'completo');
            completados++;
        } else if (resultado.estado === 'parcial') {
            icon.textContent = '‚ö†Ô∏è';
            status.textContent = resultado.mensaje;
            item.setAttribute('data-estado', 'parcial');
            completados += 0.5;
        } else {
            icon.textContent = '‚ö†Ô∏è';
            status.textContent = resultado.mensaje;
            item.setAttribute('data-estado', 'pendiente');
        }
    });
    
    // Actualizar resumen
    document.getElementById('seguimientoCompleto').textContent = Math.floor(completados);
    document.getElementById('seguimientoTotal').textContent = total;
    
    // Actualizar indicador principal
    const indicador = document.getElementById('seguimientoIndicador');
    if (completados === total) {
        indicador.textContent = '‚úÖ';
    } else if (completados > total / 2) {
        indicador.textContent = 'üü°';
    } else {
        indicador.textContent = '‚ö†Ô∏è';
    }
}

// Funci√≥n para mostrar/ocultar el seguimiento seg√∫n diabetes
// Funci√≥n para mostrar/ocultar el seguimiento seg√∫n condiciones cardiovasculares
function mostrarSeguimientoDiabetico() {
    const seguimiento = document.getElementById('seguimientoDiabeticoLateral');
    if (seguimiento) {
        seguimiento.style.display = 'block';
        evaluarSeguimientoDiabetico();
    }
}

function ocultarSeguimientoDiabetico() {
    const seguimiento = document.getElementById('seguimientoDiabeticoLateral');
    if (seguimiento) {
        seguimiento.style.display = 'none';
        seguimientoPanelAbierto = false;
        const panel = document.getElementById('seguimientoPanel');
        if (panel) panel.classList.remove('active');
    }
}

function mostrarMensajeSeguimiento(mensaje) {
    const summary = document.querySelector('.seguimiento-summary');
    if (summary) {
        summary.textContent = mensaje;
    }
}

// Escuchar cambios en patolog√≠as para mostrar/ocultar seguimiento
document.addEventListener('change', (e) => {
    if (e.target && e.target.classList && e.target.classList.contains('patologia-checkbox')) {
        setTimeout(() => {
            // Mostrar si tiene diabetes O hipertensi√≥n
            if (hasCardiovascularCondition()) {
                mostrarSeguimientoDiabetico();
            } else {
                ocultarSeguimientoDiabetico();
            }
        }, 100);
    }
});

// Inicializar seguimiento al cargar la p√°gina
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        // Mostrar si tiene alguna condici√≥n cardiovascular
        if (hasCardiovascularCondition()) {
            mostrarSeguimientoDiabetico();
        }
    }, 1000);
});

console.log('‚úÖ Sistema Seguimiento Diab√©tico configurado correctamente');
console.log('‚úÖ Sistema Fondo de Ojos con vigencia anual configurado correctamente');
console.log('‚úÖ Sistema Pie Diab√©tico con bot√≥n Nuevo configurado correctamente');
console.log('‚úÖ Sistema Atenci√≥n Podol√≥gica con bot√≥n Nuevo configurado correctamente');
console.log('‚úÖ Sistema Hipoglicemias con bot√≥n Nuevo configurado correctamente');
</script>

<!-- Script para conversi√≥n de fechas DD/MM/YYYY a YYYY-MM-DD para PostgreSQL -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Funci√≥n para convertir fechas de dd/mm/yyyy a yyyy-mm-dd antes del submit
    function convertirFechasParaPostgres() {
        console.log('üîÑ Iniciando conversi√≥n de fechas para PostgreSQL...');
        const camposFecha = [
            'fecha_nacimiento',
            'fecha_ingreso', 
            'vac_influenza_fecha',
            'vac_covid_fecha',
            'ekg_fecha',
            'fecha_acuerdo'
        ];
        
        let fechasConvertidas = 0;
        camposFecha.forEach(nombreCampo => {
            const campo = document.getElementById(nombreCampo);
            if (campo && campo.value) {
                const fechaOriginal = campo.value.trim();
                console.log('üîç Revisando ' + nombreCampo + ': "' + fechaOriginal + '"');
                
                // Verificar si est√° en formato dd/mm/yyyy
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(fechaOriginal)) {
                    const partes = fechaOriginal.split('/');
                    const dia = partes[0];
                    const mes = partes[1];
                    const a√±o = partes[2];
                    const fechaPostgres = a√±o + '-' + mes.padStart(2, '0') + '-' + dia.padStart(2, '0');
                    campo.value = fechaPostgres;
                    fechasConvertidas++;
                    console.log('‚úÖ Convertido ' + nombreCampo + ': ' + fechaOriginal + ' ‚Üí ' + fechaPostgres);
                } else {
                    console.log('‚ö†Ô∏è ' + nombreCampo + ' no est√° en formato dd/mm/yyyy: "' + fechaOriginal + '"');
                }
            }
        });
        console.log('üéØ Total fechas convertidas: ' + fechasConvertidas);
    }
    
    // Agregar conversi√≥n de fechas al formulario principal
    const form = document.getElementById('usuarioForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üìù Formulario envi√°ndose, convirtiendo fechas...');
            
            // Validar campo sexo antes de enviar
            const sexoField = document.getElementById('sexo');
            if (sexoField && (!sexoField.value || sexoField.value === '')) {
                e.preventDefault();
                alert('‚ö†Ô∏è Debe seleccionar el sexo antes de guardar.');
                sexoField.focus();
                sexoField.style.border = '2px solid #dc3545';
                return false;
            }
            
            convertirFechasParaPostgres();
        });
        console.log('‚úÖ Conversi√≥n de fechas configurada para el formulario');
    } else {
        console.error('‚ùå No se encontr√≥ el formulario usuarioForm');
    }
});

/**
 * Detecta si un usuario tiene diabetes basado en las patolog√≠as seleccionadas
 * @param {string} run - RUN del usuario (opcional para logging)
 * @returns {boolean} true si es diab√©tico, false si no
 */
function esUsuarioDiabetico(run) {
    console.log('üîç [DIABETES] Verificando si usuario es diab√©tico:', run || 'sin RUN');
    
    // C√≥digos CIE-10 completos para diabetes (E10-E14 con subc√≥digos)
    const codigosDiabetes = new Set([
        // E10 - Diabetes mellitus tipo 1 (insulinodependiente)
        'E10', 'E10.0', 'E10.1', 'E10.2', 'E10.3', 'E10.4', 'E10.5', 'E10.6', 'E10.7', 'E10.8', 'E10.9',
        // E11 - Diabetes mellitus tipo 2 (no insulinodependiente)
        'E11', 'E11.0', 'E11.1', 'E11.2', 'E11.3', 'E11.4', 'E11.5', 'E11.6', 'E11.7', 'E11.8', 'E11.9',
        // E12 - Diabetes mellitus relacionada con malnutrici√≥n
        'E12', 'E12.0', 'E12.1', 'E12.2', 'E12.3', 'E12.4', 'E12.5', 'E12.6', 'E12.7', 'E12.8', 'E12.9',
        // E13 - Otras formas de diabetes mellitus especificadas
        'E13', 'E13.0', 'E13.1', 'E13.2', 'E13.3', 'E13.4', 'E13.5', 'E13.6', 'E13.7', 'E13.8', 'E13.9',
        // E14 - Diabetes mellitus no especificada
        'E14', 'E14.0', 'E14.1', 'E14.2', 'E14.3', 'E14.4', 'E14.5', 'E14.6', 'E14.7', 'E14.8', 'E14.9'
    ]);
    
    try {
        // Verificar checkboxes de patolog√≠as seleccionadas
        const patologiasSeleccionadas = document.querySelectorAll('input.patologia-checkbox:checked');
        
        if (!patologiasSeleccionadas || patologiasSeleccionadas.length === 0) {
            console.log('‚ÑπÔ∏è [DIABETES] No hay patolog√≠as seleccionadas o cargadas a√∫n');
            return false;
        }
        
        // Buscar c√≥digos de diabetes en las patolog√≠as seleccionadas
        for (const checkbox of patologiasSeleccionadas) {
            try {
                const codigo = checkbox.value;
                if (codigo && codigosDiabetes.has(codigo)) {
                    console.log('‚úÖ [DIABETES] C√≥digo detectado:', codigo);
                    return true;
                }
            } catch(e) {
                console.warn('‚ö†Ô∏è [DIABETES] Error procesando checkbox:', e);
                continue;
            }
        }
        
        console.log('‚ÑπÔ∏è [DIABETES] Usuario sin patolog√≠as diab√©ticas detectadas');
        return false;
        
    } catch(e) {
        console.error('‚ùå [DIABETES] Error en esUsuarioDiabetico:', e);
        return false;
    }
}

// Cache y debounce para evitar llamadas excesivas a cargarTratamientoInsulina
let cargarInsulinaTimeout = null;
let lastInsulinaRun = null;

/**
 * Helper con debounce para cargar tratamiento de insulina
 * @param {string} run - RUN del usuario
 * @param {number} delay - Retraso en milisegundos (default: 300)
 */
cargarTratamientoInsulinaDebounced = function(run, delay = 300) {
    if (!run || !run.trim()) {
        console.log('‚ö†Ô∏è [INSULINA-DEBOUNCE] RUN vac√≠o, cancelando carga');
        return;
    }
    
    const runLimpio = run.trim();
    
    // Si es el mismo RUN que antes, no hacer nada
    if (lastInsulinaRun === runLimpio) {
        console.log('üîÑ [INSULINA-DEBOUNCE] Mismo RUN, omitiendo carga:', runLimpio);
        return;
    }
    
    // Cancelar timeout previo si existe
    if (cargarInsulinaTimeout) {
        clearTimeout(cargarInsulinaTimeout);
        cargarInsulinaTimeout = null;
    }
    
    // Programar nueva carga con debounce
    cargarInsulinaTimeout = setTimeout(async function() {
        try {
            lastInsulinaRun = runLimpio;
            console.log('üéØ [INSULINA-DEBOUNCE] Ejecutando carga para RUN:', runLimpio);
            await cargarTratamientoInsulina(runLimpio);
        } catch (e) {
            console.error('‚ùå [INSULINA-DEBOUNCE] Error en carga:', e);
        } finally {
            cargarInsulinaTimeout = null;
        }
    }, delay);
    
    console.log('‚è∞ [INSULINA-DEBOUNCE] Programada carga en', delay, 'ms para RUN:', runLimpio);
}

// Asignar la funci√≥n al objeto window para acceso global
window.cargarTratamientoInsulinaDebounced = cargarTratamientoInsulinaDebounced;

/**
 * Carga tratamiento de insulina solo si el usuario es diab√©tico
 * @param {string} run - RUN del usuario
 * @returns {Promise<void>}
 */
async function cargarTratamientoInsulina(run) {
    if (!run || typeof run !== 'string') {
        console.log('‚ö†Ô∏è [INSULINA] RUN no v√°lido proporcionado:', run);
        return;
    }
    
    const runLimpio = run.trim();
    if (!runLimpio) {
        console.log('‚ö†Ô∏è [INSULINA] RUN vac√≠o despu√©s de limpieza');
        return;
    }
    
    try {
        // Verificar si el usuario es diab√©tico antes de cargar datos de insulina
        if (esUsuarioDiabetico(runLimpio)) {
            console.log('ü©∫ [INSULINA] Usuario diab√©tico detectado, cargando tratamiento...');
            
            // Verificar que la funci√≥n existe antes de llamarla
            if (typeof cargarUltimoTratamientoInsulina === 'function') {
                await cargarUltimoTratamientoInsulina(runLimpio);
                console.log('‚úÖ [INSULINA] Tratamiento cargado exitosamente');
            } else {
                console.warn('‚ö†Ô∏è [INSULINA] Funci√≥n cargarUltimoTratamientoInsulina no disponible');
            }
        } else {
            console.log('‚ÑπÔ∏è [INSULINA] Usuario no diab√©tico, limpiando datos de insulina...');
            
            // Limpiar y ocultar elementos relacionados con insulina
            const elementosInsulina = [
                'insulinaUltimoRegistro',
                'insulinaNuevoBtn',
                'insulinaFormContainer',
                'insulinaStatus'
            ];
            
            elementosInsulina.forEach(function(id) {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.style.display = 'none';
                    // Limpiar contenido si es un contenedor
                    if (id.includes('Status') || id.includes('Container')) {
                        elemento.textContent = '';
                    }
                }
            });
        }
    } catch(e) {
        console.error('‚ùå [INSULINA] Error en cargarTratamientoInsulina:', e);
    }
}

// ===== INICIALIZACI√ìN DEL CONTROL DE SECCIONES M√âDICAS =====
document.addEventListener('DOMContentLoaded', function() {
    debugLog('[CONTROL-USUARIO] üöÄ Inicializando control de secciones m√©dicas');
    
    // Al cargar la p√°gina, verificar si hay un usuario v√°lido
    // Si no hay usuario v√°lido, ocultar secciones m√©dicas
    setTimeout(() => {
        actualizarVisibilidadSeccionesMedicas();
        debugLog('[CONTROL-USUARIO] ‚úÖ Control inicial completado');
    }, 100);
});

// ===== FUNCIONES PARA ALERTAS DE VIGENCIA =====

// ========================= FUNCIONES CUADRO FLOTANTE DE ALERTAS =========================

// Variables globales para el estado del cuadro flotante
let alertsFloatVisible = false;
let alertsFloatCollapsed = false;
let currentAlertTab = 'examenes';

// Funci√≥n de prueba para debug
function testShowAlerts() {
    console.log('üîî TEST: Iniciando testShowAlerts()');
    const container = document.getElementById('health-alerts-floating');
    if (container) {
        container.style.display = 'block';
        container.style.zIndex = '9999';
        alertsFloatVisible = true;
        console.log('‚úÖ Panel mostrado manualmente');
        
        // Intentar cargar alertas tambi√©n
        const runElement = document.getElementById('run');
        if (runElement && runElement.value) {
            console.log('üîî Cargando alertas para:', runElement.value);
            cargarAlertasVigenciaFlotante();
        } else {
            console.log('üìù Mostrando mensaje de prueba sin RUN');
            // Mostrar contenido de prueba si no hay RUN
            mostrarErrorEnTabs('Modo de prueba - carga un usuario primero');
        }
    } else {
        console.error('‚ùå No se encontr√≥ el contenedor');
    }
}

// Funciones auxiliares para manejo de pesta√±as y estado de carga - ULTRA OPTIMIZADAS Y CORREGIDAS
function mostrarLoadingEnTabs() {
    console.log('‚ö° Loading ultra r√°pido con IDs corregidos');
    
    // Mensaje ultra ligero
    const html = '<div style="padding:8px;text-align:center;color:#2563eb;font-size:11px">‚ö° Cargando r√°pido...</div>';
    
    // IDs correctos que EXISTEN en HTML
    ['alert-examenes', 'alert-screening', 'alert-procedimientos', 'alert-tratamientos', 'alert-cardiovascular'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
    });
}

function mostrarErrorEnTabs(mensaje) {
    console.log('‚ùå Error ultra r√°pido con IDs corregidos:', mensaje);
    
    // Error ultra ligero
    const html = `<div style="padding:8px;text-align:center;color:#dc2626;font-size:11px">‚ùå ${mensaje}</div>`;
    
    // IDs correctos que EXISTEN en HTML
    ['alert-examenes', 'alert-screening', 'alert-procedimientos', 'alert-tratamientos', 'alert-cardiovascular'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
    });
}

function mostrarMensajeEnTabs(mensaje) {
    console.log('üí¨ Mensaje en tabs:', mensaje);
    
    // Mensaje informativo
    const html = `<div style="padding:8px;text-align:center;color:#f59e0b;font-size:11px">${mensaje}</div>`;
    
    // IDs correctos que EXISTEN en HTML
    ['alert-examenes', 'alert-screening', 'alert-procedimientos', 'alert-tratamientos', 'alert-cardiovascular'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
    });
}

// Mostrar/ocultar barra lateral de alertas
function toggleSidebarAlerts() {
    console.log('üîî === INICIANDO toggleSidebarAlerts ===');
    
    try {
        const sidebarContainer = document.getElementById('health-alerts-floating');
        const overlay = document.getElementById('sidebar-overlay');
        const btn = document.getElementById('ver-alertas-btn');
        
        console.log('üîî Elementos encontrados:');
        console.log('  - sidebarContainer:', sidebarContainer ? '‚úÖ' : '‚ùå');
        console.log('  - overlay:', overlay ? '‚úÖ' : '‚ùå');
        console.log('  - btn:', btn ? '‚úÖ' : '‚ùå');
        
        if (!sidebarContainer) {
            console.error('‚ùå No se encontr√≥ health-alerts-floating');
            alert('Error: No se encontr√≥ el contenedor de alertas');
            return;
        }
        
        if (!overlay) {
            console.error('‚ùå No se encontr√≥ sidebar-overlay');
            alert('Error: No se encontr√≥ el overlay');
            return;
        }
        
        const isVisible = sidebarContainer.classList.contains('show');
        console.log('üîî Estado actual - isVisible:', isVisible);
        
        if (isVisible) {
            console.log('üîî Cerrando barra lateral...');
            cerrarAlertas();
        } else {
            console.log('üîî Abriendo barra lateral...');
            
            // Abrir barra lateral
            sidebarContainer.style.display = 'block';
            sidebarContainer.classList.add('show');
            overlay.style.display = 'block';
            overlay.classList.add('show');
            
            // Variables globales
            if (typeof alertsFloatVisible !== 'undefined') {
                alertsFloatVisible = true;
            }
            
            // Cambiar texto del bot√≥n
            if (btn) {
                btn.innerHTML = '‚ùå Cerrar';
                console.log('üîî Texto del bot√≥n cambiado');
            }
            
            console.log('üîî Barra lateral mostrada, cargando alertas...');
            
            // Cargar alertas del servidor
            try {
                cargarAlertasVigenciaFlotante();
            } catch (alertError) {
                console.error('‚ùå Error cargando alertas:', alertError);
                // Mostrar mensaje de error en lugar de datos de prueba
                mostrarErrorEnTabs('Error al cargar alertas. Verifique la conexi√≥n.');
            }
        }
        
        console.log('üîî === toggleSidebarAlerts COMPLETADO ===');
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico en toggleSidebarAlerts:', error);
        alert('Error: ' + error.message);
    }
}

// Funciones de compatibilidad simples
function showAlertsFloat() {
    if (typeof mostrarAlertas === 'function') {
        mostrarAlertas();
    }
}

function closeAlertsFloat() {
    if (typeof cerrarAlertas === 'function') {
        cerrarAlertas();
    }
}

// FUNCI√ìN PARA CAMBIAR PESTA√ëAS DE ALERTAS - SOLO VISUAL, SIN INTERFERIR CON FORMULARIO
function switchAlertTabSolo(tabName, event) {
    console.log('üîÑ Cambiando pesta√±a de alertas a:', tabName);
    
    try {
        // Prevenir cualquier comportamiento por defecto
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        // Actualizar pesta√±as - solo las de alertas
        const alertTabs = document.querySelectorAll('.alert-tab');
        alertTabs.forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activar la pesta√±a seleccionada
        const activeTab = document.querySelector(`[onclick="switchAlertTabSolo('${tabName}')"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // Actualizar contenido - solo las categor√≠as de alertas
        const alertCategories = document.querySelectorAll('.alert-category');
        alertCategories.forEach(category => {
            category.classList.remove('active');
        });
        
        // Mostrar la categor√≠a seleccionada
        const targetCategory = document.getElementById(`alert-${tabName}`);
        if (targetCategory) {
            targetCategory.classList.add('active');
        }
        
        console.log('‚úÖ Pesta√±a de alertas cambiada correctamente');
        
    } catch (error) {
        console.error('‚ùå Error cambiando pesta√±a de alertas:', error);
    }
    
    // Asegurar que no se navegue o interfiera con el formulario
    return false;
}

// Cambiar pesta√±a activa - FUNCI√ìN ORIGINAL (mantener para compatibilidad)
function switchAlertTab(tabName) {
    // Actualizar pesta√±as
    document.querySelectorAll('.alert-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[onclick="switchAlertTab('${tabName}')"]`).classList.add('active');
    
    // Actualizar contenido
    document.querySelectorAll('.alert-category').forEach(category => {
        category.classList.remove('active');
    });
    const targetCategory = document.getElementById(`alert-${tabName}`);
    if (targetCategory) {
        targetCategory.classList.add('active');
    }
    
    currentAlertTab = tabName;
}

// Funci√≥n auxiliar para verificar vigencia
function esVigente(fechaExamen, diasVigencia) {
    if (!fechaExamen) return false;
    
    const fecha = new Date(fechaExamen);
    const hoy = new Date();
    const diasTranscurridos = Math.floor((hoy - fecha) / (1000 * 60 * 60 * 24));
    
    return diasTranscurridos <= diasVigencia;
}

// Funci√≥n auxiliar para crear una alerta
function crearAlertaSegunDiagnostico(nombre, tieneExamen, esVigenteExamen, icono, categoria = 'examenes') {
    let estado, mensaje;
    
    if (!tieneExamen) {
        estado = 'sin-datos';
        mensaje = 'Sin registro';
    } else if (esVigenteExamen) {
        estado = 'vigente';
        mensaje = 'Vigente ‚úÖ';
    } else {
        estado = 'vencido';
        mensaje = 'Vencido ‚ö†Ô∏è';
    }
    
    return {
        nombre,
        icono,
        estado,
        mensaje,
        categoria
    };
}

// ===== ALERTAS GENERALES (TODOS LOS USUARIOS) =====
function procesarAlertasGenerales(datos) {
    const alertas = [];
    const vacunas = datos.vacunas || {};
    
    // Vacuna Influenza - vigencia 1 a√±o
    const tieneInfluenza = !!vacunas.influenza;
    const influenzaVigente = tieneInfluenza ? esVigente(vacunas.influenza.fecha, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Vacuna Influenza',
        tieneInfluenza,
        influenzaVigente,
        'üíâ',
        'screening'
    ));
    
    // Vacuna COVID - vigencia 1 a√±o
    const tieneCovid = !!vacunas.covid;
    const covidVigente = tieneCovid ? esVigente(vacunas.covid.fecha, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Vacuna COVID',
        tieneCovid,
        covidVigente,
        'üíâ',
        'screening'
    ));
    
    return alertas;
}

// ===== ALERTAS ESPEC√çFICAS PARA DIABETES =====
function procesarAlertasDiabetes(datos) {
    const alertas = [];
    const examenes = datos.examenes || {};
    
    // HbA1c - vigencia 1 a√±o
    const tieneHbA1c = !!examenes.HbA1c;
    const hbA1cVigente = tieneHbA1c ? esVigente(examenes.HbA1c.fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'HbA1c (Diabetes)',
        tieneHbA1c,
        hbA1cVigente,
        'ü©∏',
        'examenes'
    ));
    
    // Evaluaci√≥n pie diab√©tico - vigencia 1 a√±o
    const tienePieDM = !!datos.examenes_piedm;
    const pieDMVigente = tienePieDM ? esVigente(datos.examenes_piedm.fecha, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Evaluaci√≥n Pie Diab√©tico',
        tienePieDM,
        pieDMVigente,
        'ü¶∂',
        'procedimientos'
    ));
    
    // VFG - vigencia 1 a√±o
    const tieneVFG = !!examenes.VFG;
    const vfgVigente = tieneVFG ? esVigente(examenes.VFG.fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'VFG (Funci√≥n Renal)',
        tieneVFG,
        vfgVigente,
        'ü´ò',
        'examenes'
    ));
    
    // LDL - vigencia 1 a√±o
    const tieneLDL = !!examenes.LDL;
    const ldlVigente = tieneLDL ? esVigente(examenes.LDL.fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'LDL Colesterol',
        tieneLDL,
        ldlVigente,
        'üíô',
        'examenes'
    ));
    
    // RAC - vigencia 1 a√±o
    const tieneRAC = !!examenes.RAC;
    const racVigente = tieneRAC ? esVigente(examenes.RAC.fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'RAC (Relaci√≥n Albumina/Creatinina)',
        tieneRAC,
        racVigente,
        'üî¨',
        'examenes'
    ));
    
    // Creatininemia - vigencia 1 a√±o
    const tieneCreatininemia = !!examenes.Creatininemia;
    const creatininemiaVigente = tieneCreatininemia ? esVigente(examenes.Creatininemia.fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Creatininemia',
        tieneCreatininemia,
        creatininemiaVigente,
        'üß™',
        'examenes'
    ));
    
    // EKG - vigencia 1 a√±o
    const tieneEKG = !!examenes.EKG;
    const ekgVigente = tieneEKG ? esVigente(examenes.EKG.fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'EKG (Electrocardiograma)',
        tieneEKG,
        ekgVigente,
        '‚ù§Ô∏è',
        'examenes'
    ));
    
    // Atenci√≥n podol√≥gica - vigencia 1 a√±o
    const tienePodologia = !!datos.podologia;
    const podologiaVigente = tienePodologia ? esVigente(datos.podologia.fecha, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Atenci√≥n Podol√≥gica',
        tienePodologia,
        podologiaVigente,
        'üë£',
        'procedimientos'
    ));
    
    // Fondo de ojos - vigencia 1 a√±o
    const tieneFondoOjos = !!examenes['Fondo de Ojos'];
    const fondoOjosVigente = tieneFondoOjos ? esVigente(examenes['Fondo de Ojos'].fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Fondo de Ojos',
        tieneFondoOjos,
        fondoOjosVigente,
        'üëÅÔ∏è',
        'examenes'
    ));
    
    // Registros espec√≠ficos de diabetes
    const diabetesControles = datos.diabetes_controles || {};
    
    // Uso de insulina
    const tieneInsulinaRegistro = diabetesControles.ultima_insulina !== undefined;
    const insulinaVigente = tieneInsulinaRegistro ? esVigente(diabetesControles.ultima_insulina, 90) : false; // 3 meses
    alertas.push(crearAlertaSegunDiagnostico(
        'Registro Uso Insulina',
        tieneInsulinaRegistro,
        insulinaVigente,
        'üíâ',
        'tratamientos'
    ));
    
    // Hipoglicemias
    const tieneHipoglicemias = diabetesControles.ultima_hipoglicemia !== undefined;
    const hipoglicemiasVigente = tieneHipoglicemias ? esVigente(diabetesControles.ultima_hipoglicemia, 30) : false; // 1 mes
    alertas.push(crearAlertaSegunDiagnostico(
        'Registro Hipoglicemias',
        tieneHipoglicemias,
        hipoglicemiasVigente,
        '‚ö†Ô∏è',
        'tratamientos'
    ));
    
    // Tabaquismo
    const tieneTabaquismo = diabetesControles.ultimo_tabaquismo !== undefined;
    const tabaquismoVigente = tieneTabaquismo ? esVigente(diabetesControles.ultimo_tabaquismo, 180) : false; // 6 meses
    alertas.push(crearAlertaSegunDiagnostico(
        'Registro Fumador Actual',
        tieneTabaquismo,
        tabaquismoVigente,
        'üö≠',
        'tratamientos'
    ));
    
    // Curaciones
    const tieneCuraciones = !!datos.curaciones_piedm;
    const curacionesVigente = tieneCuraciones ? esVigente(datos.curaciones_piedm.fecha, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Registro Curaciones',
        tieneCuraciones,
        curacionesVigente,
        'ü©π',
        'procedimientos'
    ));
    
    // Amputaci√≥n por pie diab√©tico
    const tieneAmputacion = !!datos.amputacion_piedm;
    const amputacionVigente = tieneAmputacion ? esVigente(datos.amputacion_piedm.fecha, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Registro Amputaci√≥n Pie Diab√©tico',
        tieneAmputacion,
        amputacionVigente,
        'ü¶ø',
        'procedimientos'
    ));
    
    return alertas;
}

// ===== ALERTAS ESPEC√çFICAS PARA ADULTO MAYOR (‚â•65 a√±os) =====
function procesarAlertasAdultoMayor(datos) {
    const alertas = [];
    const adultoMayor = datos.adulto_mayor || {};
    
    // Evaluaci√≥n de funcionalidad - vigencia 6 meses
    const tieneFuncionalidad = adultoMayor.funcionalidad !== null && adultoMayor.funcionalidad !== undefined;
    const funcionalidadVigente = tieneFuncionalidad ? esVigente(adultoMayor.fecha_aplicacion, 180) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Evaluaci√≥n Funcionalidad',
        tieneFuncionalidad,
        funcionalidadVigente,
        'üèÉ',
        'procedimientos'
    ));
    
    // TUG (Timed Up and Go) - vigencia 6 meses
    const tieneTUG = adultoMayor.tug_seg !== null && adultoMayor.tug_seg !== undefined;
    const tugVigente = tieneTUG ? esVigente(adultoMayor.fecha_aplicacion, 180) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Test TUG',
        tieneTUG,
        tugVigente,
        '‚è±Ô∏è',
        'procedimientos'
    ));
    
    // EU (Evaluaci√≥n Integral) - vigencia 1 a√±o
    const tieneEU = !!adultoMayor.eu_fecha;
    const euVigente = tieneEU ? esVigente(adultoMayor.eu_fecha, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Evaluaci√≥n Integral (EU)',
        tieneEU,
        euVigente,
        'üìã',
        'procedimientos'
    ));
    
    return alertas;
}

// ===== ALERTAS ESPEC√çFICAS PARA HIPERTENSI√ìN =====
function procesarAlertasHipertension(datos) {
    const alertas = [];
    const examenes = datos.examenes || {};
    const cardiovascularControles = datos.cardiovascular_controles || {};
    
    // RAC (especial √©nfasis para hipertensi√≥n) - vigencia 1 a√±o
    const tieneRAC = !!examenes.RAC;
    const racVigente = tieneRAC ? esVigente(examenes.RAC.fecha_examen, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'RAC (HIPERTENSI√ìN)',
        tieneRAC,
        racVigente,
        'üî¨',
        'examenes'
    ));
    
    // Protocolo Hearts - vigencia 1 a√±o
    const tieneHearts = !!cardiovascularControles.ultimo_hearts;
    const heartsVigente = tieneHearts ? esVigente(cardiovascularControles.ultimo_hearts, 365) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Protocolo HEARTS',
        tieneHearts,
        heartsVigente,
        'üíù',
        'cardiovascular'
    ));
    
    return alertas;
}

// ===== ALERTAS ACTIVIDAD F√çSICA CARDIOVASCULAR =====
function procesarAlertasActividadFisica(datos) {
    const alertas = [];
    const cardiovascularControles = datos.cardiovascular_controles || {};
    
    // Actividad f√≠sica salud cardiovascular - vigencia 6 meses
    const tieneActividadFisica = !!cardiovascularControles.ultima_actividad_fisica;
    const actividadFisicaVigente = tieneActividadFisica ? esVigente(cardiovascularControles.ultima_actividad_fisica, 180) : false;
    alertas.push(crearAlertaSegunDiagnostico(
        'Actividad F√≠sica Cardiovascular',
        tieneActividadFisica,
        actividadFisicaVigente,
        'üèÉ‚Äç‚ôÇÔ∏è',
        'cardiovascular'
    ));
    
    return alertas;
}

// ===== DISTRIBUCI√ìN EN PESTA√ëAS =====
function distribuirAlertasEnTabs(alertasCategorizadas) {
    // Combinar todas las alertas por categor√≠a
    const todasLasAlertas = [
        ...alertasCategorizadas.generales,
        ...alertasCategorizadas.screening,
        ...alertasCategorizadas.especificas
    ];
    
    // Agrupar por categor√≠a de pesta√±a
    const alertasPorTab = {
        examenes: [],
        screening: [],
        procedimientos: [],
        tratamientos: [],
        cardiovascular: []
    };
    
    todasLasAlertas.forEach(alerta => {
        if (alertasPorTab[alerta.categoria]) {
            alertasPorTab[alerta.categoria].push(alerta);
        }
    });
    
    // Renderizar cada pesta√±a
    renderizarTab('examenes', alertasPorTab.examenes);
    renderizarTab('screening', alertasPorTab.screening);
    renderizarTab('procedimientos', alertasPorTab.procedimientos);
    renderizarTab('tratamientos', alertasPorTab.tratamientos);
    renderizarTab('cardiovascular', alertasPorTab.cardiovascular);
}

// Renderizar una pesta√±a espec√≠fica
function renderizarTab(tabName, alertas) {
    const container = document.getElementById(`alert-${tabName}`);
    if (!container) return;
    
    if (alertas.length === 0) {
        container.innerHTML = '<div class="no-alerts">No hay alertas para esta categor√≠a</div>';
        return;
    }
    
    const html = alertas.map(alerta => {
        const claseEstado = alerta.estado === 'vigente' ? 'vigente' : 
                           alerta.estado === 'vencido' ? 'vencido' : 'sin-datos';
        
        return `
            <div class="alert-item ${claseEstado}">
                <div class="alert-info">
                    <span class="alert-icon">${alerta.icono}</span>
                    <span class="alert-name">${alerta.nombre}</span>
                </div>
                <div class="alert-status">
                    ${alerta.mensaje}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

// Auto-cargar alertas cuando se carga un usuario
function cargarAlertasVigencia() {
    if (alertsFloatVisible) {
        cargarAlertasVigenciaFlotante();
    }
}

// FUNCI√ìN DE PRUEBA SIMPLE PARA ALERTAS
function testAlertas() {
    console.log('üß™ INICIANDO PRUEBA DE ALERTAS');
    
    // Datos de prueba simples
    const datosTest = {
        examenes: {
            'Glicemia': { valor: '95 mg/dL', fecha_examen: '2024-01-15' },
            'Colesterol': { valor: '180 mg/dL', fecha_examen: '2024-02-20' }
        },
        screening: [
            { nombre: 'Mamograf√≠a', vigente: true, fecha: '2024-03-10' }
        ],
        procedimientos: [
            { nombre: 'Control presi√≥n', fecha: '2024-04-05' }
        ]
    };
    
    console.log('üß™ Mostrando datos de prueba:', datosTest);
    mostrarDatosDirectos(datosTest);
}

// FUNCI√ìN DE PRUEBA PARA VERIFICAR ELEMENTOS DOM
function testDOM() {
    console.log('üîç VERIFICANDO ELEMENTOS DOM');
    
    const btn = document.getElementById('ver-alertas-btn');
    console.log('Bot√≥n alertas:', btn);
    
    const sidebarContainer = document.getElementById('health-alerts-floating');
    console.log('Sidebar container:', sidebarContainer);
    
    const overlay = document.getElementById('sidebar-overlay');
    console.log('Overlay:', overlay);
    
    // Verificar pesta√±as
    const tabs = ['examenes', 'screening', 'procedimientos', 'tratamientos', 'cardiovascular'];
    tabs.forEach(tab => {
        const element = document.getElementById(`alert-${tab}`);
        console.log(`Tab alert-${tab}:`, element);
    });
}

// FUNCI√ìN DE PRUEBA DIRECTA DEL BOT√ìN
function testBotonAlertas() {
    console.log('üß™ PROBANDO BOT√ìN DE ALERTAS DIRECTAMENTE');
    try {
        toggleSidebarAlerts();
    } catch (error) {
        console.error('‚ùå Error al ejecutar toggleSidebarAlerts:', error);
    }
}

// INICIALIZACI√ìN AL CARGAR LA P√ÅGINA
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ P√°gina cargada, inicializando bot√≥n de alertas...');
    
    const btn = document.getElementById('ver-alertas-btn');
    if (btn) {
        console.log('‚úÖ Bot√≥n de alertas encontrado');
        
        // Agregar event listener
        btn.addEventListener('click', function(e) {
            console.log('üîò Click detectado en bot√≥n de alertas');
            e.preventDefault();
            e.stopPropagation();
            
            // Verificar que la funci√≥n existe
            if (typeof toggleSidebarAlerts === 'function') {
                toggleSidebarAlerts();
            } else {
                console.error('‚ùå Funci√≥n toggleSidebarAlerts no encontrada');
                alert('Error: Funci√≥n no encontrada. Intente refrescar la p√°gina.');
            }
        });
        
        console.log('‚úÖ Event listener agregado al bot√≥n');
    } else {
        console.error('‚ùå Bot√≥n de alertas NO encontrado');
        setTimeout(() => {
            // Reintentar despu√©s de un momento
            const btnRetry = document.getElementById('ver-alertas-btn');
            if (btnRetry) {
                console.log('‚úÖ Bot√≥n encontrado en segundo intento');
                btnRetry.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (typeof toggleSidebarAlerts === 'function') {
                        toggleSidebarAlerts();
                    }
                });
            }
        }, 1000);
    }
    
    // Verificar otros elementos cr√≠ticos
    const sidebar = document.getElementById('health-alerts-floating');
    const overlay = document.getElementById('sidebar-overlay');
    
    console.log('Elementos cr√≠ticos:');
    console.log('  - Sidebar:', sidebar ? '‚úÖ' : '‚ùå');
    console.log('  - Overlay:', overlay ? '‚úÖ' : '‚ùå');
    
    // Hacer funciones disponibles globalmente para debug
    window.testDOM = testDOM;
    window.testBotonAlertas = testBotonAlertas;
    window.testAlertas = testAlertas;
    window.toggleSidebarAlerts = toggleSidebarAlerts;
});

// SCRIPT ALTERNATIVO - EJECUTAR INMEDIATAMENTE
setTimeout(function() {
    console.log('üîÑ Script alternativo ejecut√°ndose...');
    
    const btn = document.getElementById('ver-alertas-btn');
    console.log('üîç Bot√≥n encontrado:', btn);
    
    if (btn) {
        // Remover cualquier listener previo
        btn.onclick = null;
        
        // Agregar nuevo listener
        btn.onclick = function(e) {
            console.log('üîò CLICK DETECTADO - Script alternativo');
            e.preventDefault();
            e.stopPropagation();
            
            try {
                // Llamar funci√≥n directamente
                if (typeof window.toggleSidebarAlerts === 'function') {
                    window.toggleSidebarAlerts();
                } else {
                    console.log('‚ö†Ô∏è Funci√≥n no disponible, ejecutando versi√≥n local');
                    ejecutarAlertas();
                }
            } catch (error) {
                console.error('‚ùå Error en onclick:', error);
                ejecutarAlertas();
            }
        };
        
        console.log('‚úÖ Onclick asignado correctamente');
    } else {
        console.error('‚ùå Bot√≥n a√∫n no encontrado');
    }
}, 500);

// FUNCI√ìN LOCAL DE EMERGENCIA
function ejecutarAlertas() {
    console.log('üö® EJECUTANDO FUNCI√ìN DE EMERGENCIA');
    
    const sidebar = document.getElementById('health-alerts-floating');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.style.display = 'block';
        sidebar.classList.add('show');
        overlay.style.display = 'block';
        overlay.classList.add('show');
        
        console.log('‚úÖ Alertas mostradas con funci√≥n de emergencia');
        
        // Mostrar datos de prueba
        const testData = {
            examenes: {
                'EKG': { valor: 'Realizado', fecha_examen: '2025-09-15' },
                'HbA1c': { valor: '6.50', unidad: '%', fecha_examen: '2025-09-15' },
                'LDL': { valor: '110.00', unidad: 'mg/dl', fecha_examen: '2025-09-15' }
            },
            podologia: {
                atencion_vigente: false,
                fecha: '2025-09-18'
            },
            screening: {}
        };
        
        // NO mostrar datos hardcodeados - usar solo datos din√°micos
        // Cargar las alertas reales usando la funci√≥n principal
        setTimeout(() => {
            cargarAlertasVigenciaFlotante();
        }, 100);
        
    } else {
        alert('Error: No se encontraron los elementos de la barra lateral');
}

</script>

<!-- SCRIPT SEPARADO PARA ALERTAS - EJECUTAR AL FINAL -->
<script>
console.log('üöÄ SCRIPT DE ALERTAS INICIANDO...');

// Funci√≥n switchAlertTabSolo() definida m√°s arriba en l√≠nea 18434 (versi√≥n completa)

// FUNCI√ìN PRINCIPAL DE ALERTAS - MUY SIMPLE - GLOBAL
window.mostrarAlertas = function() {
    console.log('üîî MOSTRANDO ALERTAS');
    
    const sidebar = document.getElementById('health-alerts-floating');
    const overlay = document.getElementById('sidebar-overlay');
    
    if (sidebar && overlay) {
        sidebar.style.display = 'block';
        sidebar.classList.add('show');
        overlay.style.display = 'block';
        overlay.classList.add('show');
        
        // Cargar alertas din√°micas en lugar de datos hardcodeados
        setTimeout(() => {
            cargarAlertasVigenciaFlotante();
        }, 100);
        
        // Cambiar texto del bot√≥n
        const btn = document.getElementById('ver-alertas-btn');
        if (btn) {
            btn.innerHTML = '‚úÖ Alertas';
        }
    }
}

// CONFIGURAR BOT√ìN CUANDO LA P√ÅGINA EST√â LISTA
function configurarBotonAlertas() {
    console.log('üîß Configurando bot√≥n de alertas...');
    
    const btn = document.getElementById('ver-alertas-btn');
    if (btn) {
        console.log('‚úÖ Bot√≥n encontrado, configurando...');
        
        // Limpiar cualquier evento previo
        btn.onclick = null;
        btn.removeEventListener('click', mostrarAlertas);
        
        // Agregar nuevo evento
        btn.addEventListener('click', function(e) {
            console.log('üîò CLICK EN BOT√ìN DE ALERTAS');
            e.preventDefault();
            e.stopPropagation();
            mostrarAlertas();
        });
        
        console.log('‚úÖ Bot√≥n configurado correctamente');
        
        // CONFIGURAR PESTA√ëAS DE ALERTAS
        configurarPestanasAlertas();
        
        return true;
    } else {
        console.warn('‚ö†Ô∏è Bot√≥n no encontrado a√∫n');
        return false;
    }
}

// CONFIGURAR PESTA√ëAS DE ALERTAS PARA QUE NO INTERFIERAN CON EL FORMULARIO
function configurarPestanasAlertas() {
    console.log('üîß Configurando pesta√±as de alertas...');
    
    const alertTabs = document.querySelectorAll('.alert-tab[data-tab]');
    console.log('üìã Pesta√±as encontradas:', alertTabs.length);
    
    alertTabs.forEach((tab, index) => {
        console.log(`üîß Configurando pesta√±a ${index + 1}:`, tab.getAttribute('data-tab'));
        
        // Remover cualquier event listener previo completamente
        const newTab = tab.cloneNode(true);
        tab.parentNode.replaceChild(newTab, tab);
        
        // Agregar event listener que SOLO maneje las alertas
        newTab.addEventListener('click', function(e) {
            console.log('üîò Click en pesta√±a de alertas:', this.getAttribute('data-tab'));
            
            // BLOQUEAR COMPLETAMENTE CUALQUIER PROPAGACI√ìN
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            const tabName = this.getAttribute('data-tab');
            if (tabName) {
                cambiarPestanaAlerta(tabName);
            }
            
            // BLOQUEAR COMPLETAMENTE EL EVENTO
            return false;
        }, true); // Use capture to intercept early
        
        // BLOQUEAR OTROS EVENTOS QUE PUEDAN INTERFERIR
        newTab.addEventListener('mousedown', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
        }, true);
        
        newTab.addEventListener('mouseup', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
        }, true);
        
        // AGREGAR SOPORTE PARA TECLADO (ACCESIBILIDAD)
        newTab.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                console.log('‚å®Ô∏è Tecla presionada en pesta√±a:', this.getAttribute('data-tab'));
                
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const tabName = this.getAttribute('data-tab');
                if (tabName) {
                    cambiarPestanaAlerta(tabName);
                }
                
                return false;
            }
        }, true);
        
        // BLOQUEAR EVENTOS DE FOCUS QUE PUEDAN ACTIVAR VALIDACI√ìN
        ['focus', 'blur', 'focusin', 'focusout'].forEach(eventType => {
            newTab.addEventListener(eventType, function(e) {
                e.stopPropagation();
                e.stopImmediatePropagation();
            }, true);
        });
    });
    
    console.log('‚úÖ Pesta√±as de alertas configuradas sin interferencia');
}

// FUNCI√ìN SIMPLIFICADA PARA CAMBIAR PESTA√ëAS SIN INTERFERIR
function cambiarPestanaAlerta(tabName) {
    console.log('üîÑ Cambiando a pesta√±a:', tabName);
    
    try {
        // Actualizar pesta√±as visuales
        const alertTabs = document.querySelectorAll('.alert-tab[data-tab]');
        alertTabs.forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activar la pesta√±a seleccionada
        const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeTab) {
            activeTab.classList.add('active');
        }
        
        // Actualizar contenido
        const alertCategories = document.querySelectorAll('.alert-category');
        alertCategories.forEach(category => {
            category.classList.remove('active');
        });
        
        const targetCategory = document.getElementById(`alert-${tabName}`);
        if (targetCategory) {
            targetCategory.classList.add('active');
        }
        
        console.log('‚úÖ Pesta√±a cambiada sin interferencia:', tabName);
        
    } catch (error) {
        console.error('‚ùå Error cambiando pesta√±a:', error);
    }
}

// INTENTAR CONFIGURAR INMEDIATAMENTE
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', configurarBotonAlertas);
} else {
    configurarBotonAlertas();
}

// REINTENTAR CADA 500ms HASTA QUE FUNCIONE
let intentos = 0;
const intervalo = setInterval(function() {
    intentos++;
    console.log(`üîÑ Intento ${intentos} de configurar bot√≥n...`);
    
    if (configurarBotonAlertas() || intentos > 10) {
        clearInterval(intervalo);
        if (intentos > 10) {
            console.error('‚ùå No se pudo configurar el bot√≥n despu√©s de 10 intentos');
        }
    }
}, 500);

// AGREGAR EVENT LISTENER PARA CERRAR CON ESCAPE
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const sidebar = document.getElementById('health-alerts-floating');
        if (sidebar && sidebar.classList.contains('show')) {
            console.log('‚å®Ô∏è Cerrando alertas con tecla Escape');
            cerrarAlertas();
        }
    }
});

// ============================== CARGAR USUARIO ACTUAL ==============================
async function cargarUsuarioActual() {
    try {
        const response = await fetch('/api/usuario/actual');
        const data = await response.json();
        
        if (data.success) {
            const funcionarioSpan = document.getElementById('funcionario-nombre');
            if (funcionarioSpan) {
                funcionarioSpan.textContent = data.usuario;
                funcionarioSpan.title = `Usuario: ${data.usuario}${data.is_admin ? ' (Admin)' : ''}`;
            }
            
            // Guardar informaci√≥n del usuario para uso posterior
            window.FUNCIONARIO_ACTUAL = {
                username: data.usuario,
                id: data.id,
                is_admin: data.is_admin
            };
            
            console.log('üë§ Usuario conectado:', data.usuario);
        } else {
            console.error('‚ùå Error cargando usuario actual:', data.error);
            const funcionarioSpan = document.getElementById('funcionario-nombre');
            if (funcionarioSpan) {
                funcionarioSpan.textContent = 'Error';
            }
        }
    } catch (error) {
        console.error('‚ùå Error de red cargando usuario:', error);
        const funcionarioSpan = document.getElementById('funcionario-nombre');
        if (funcionarioSpan) {
            funcionarioSpan.textContent = 'Error';
        }
    }
}

// Cargar usuario al cargar la p√°gina
document.addEventListener('DOMContentLoaded', cargarUsuarioActual);

console.log('üöÄ Script de alertas configurado - Funciones globales definidas');

</script>

</body>
</html>
